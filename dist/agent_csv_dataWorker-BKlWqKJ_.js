const C=r=>{if(r==null)return null;let e=String(r).trim();if(e==="")return null;let n=!1;e.startsWith("(")&&e.endsWith(")")&&(e=e.substring(1,e.length-1),n=!0),e=e.replace(/[$\s€£¥%]/g,"");const s=e.lastIndexOf(","),o=e.lastIndexOf(".");s>o?e=e.replace(/\./g,"").replace(",","."):e=e.replace(/,/g,"");const t=parseFloat(e);return isNaN(t)?null:n?-t:t},F=r=>{if(!r||r.length===0)return[];const e=Object.keys(r[0]),n=[];for(const s of e){let o=!0;const t=r.map(i=>i[s]);let c=0;for(const i of t){const w=C(i);if(i!==null&&String(i).trim()!==""){if(w===null){o=!1;break}c++}}if(o&&c>0){const i=t.map(C).filter(w=>w!==null);n.push({name:s,type:"numerical",valueRange:[Math.min(...i),Math.max(...i)],missingPercentage:(1-i.length/r.length)*100})}else{const i=new Set(t.map(String));n.push({name:s,type:"categorical",uniqueValues:i.size,missingPercentage:t.filter(w=>w===null||String(w).trim()==="").length/r.length*100})}}return n};const k=r=>{let e=0;for(let n=0;n<r.length;n++)e=(e<<5)-e+r.charCodeAt(n),e|=0;return Math.abs(e).toString(36)},E=r=>r==null?"":typeof r=="string"?r.trim():String(r),y=(r,e,n=3)=>{const s=[];for(const o of r){const t=o[e];if(t==null||t==="")continue;const c=E(t);if(c&&(s.includes(c)||s.push(c),s.length>=n))break}return s},D=async(r,e)=>{const{datasetId:n,sampleSize:s=2e3}=e;if(!n)throw new Error("datasetId is required for profiling.");const[o,t]=await Promise.all([r.readColumnStoreRecord(n),r.readSampledRows(n,s)]);if(!o)throw new Error("No cached metadata for this dataset. Try re-uploading the CSV.");if(t.length===0)throw new Error("No rows available to profile.");const i=F(t).map(d=>({name:d.name,type:d.type,distinct:d.uniqueValues??new Set(t.map(S=>S[d.name])).size,emptyPercentage:d.missingPercentage??0,examples:y(t,d.name)})),w=[];return o.rowCount>t.length&&w.push(`Profiled ${t.length.toLocaleString()} rows (sample) out of ${o.rowCount.toLocaleString()}.`),{rowCount:o.rowCount,sampledRows:t.length,columns:i,warnings:w}},M=(r,e)=>!e||e.length===0?!0:e.every(n=>{const s=r[n.column],o=E(s),t=E(n.value??"");switch(n.op){case"eq":return n.caseInsensitive?o.toLowerCase()===t.toLowerCase():o===t;case"neq":return n.caseInsensitive?o.toLowerCase()!==t.toLowerCase():o!==t;case"gt":return Number(o)>Number(t);case"gte":return Number(o)>=Number(t);case"lt":return Number(o)<Number(t);case"lte":return Number(o)<=Number(t);case"contains":return o.toLowerCase().includes(t.toLowerCase());case"in":return Array.isArray(n.values)?n.values.some(c=>E(c)===o):!1;default:return!0}}),T=r=>{if(r==null)return null;if(typeof r=="number"&&Number.isFinite(r))return r;const e=E(r).replace(/[$,%\s]/g,"").replace(/,/g,"");if(!e)return null;const n=Number(e);return Number.isFinite(n)?n:null},R=(r,e,n)=>{var A;const s=e.mode??"sample";if(!Array.isArray(e.metrics)||e.metrics.length===0)throw new Error("metrics[] is required for aggregation.");if(s==="full"&&!e.allowFullScan)throw new Error("FULL_SCAN_BLOCKED");const o=e.by??[],t=new Map,c=((A=e.filter)==null?void 0:A.length)??0,i=(typeof performance<"u"?performance.now():Date.now())+3e3;for(const u of r){if(!M(u,e.filter))continue;if((typeof performance<"u"?performance.now():Date.now())>i){if(s==="full")throw new Error("AGG_TIMEOUT");break}const f=o.map(a=>E(u[a])),g=f.length>0?f.join("||"):"__total__";if(!t.has(g)){const a={};o.forEach((m,h)=>{a[m]=f[h]});const p={};e.metrics.forEach(m=>{const h=m.as??`${m.fn}_${m.column??"rows"}`;p[h]={sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}}),t.set(g,{keys:a,accumulators:p})}const l=t.get(g);e.metrics.forEach(a=>{const p=a.as??`${a.fn}_${a.column??"rows"}`,m=l.accumulators[p];if(a.fn==="count"){m.count+=1,m.sum+=1;return}if(!a.column)throw new Error(`Metric ${a.fn} requires a column.`);const h=T(u[a.column]);h!==null&&(m.count+=1,m.sum+=h,m.min=Math.min(m.min,h),m.max=Math.max(m.max,h))})}const w=[...o.map(u=>({name:u,type:"string"})),...e.metrics.map(u=>({name:u.as??`${u.fn}_${u.column??"rows"}`,type:"number"}))],d=[];for(const u of t.values()){const b={...u.keys};e.metrics.forEach(f=>{const g=f.as??`${f.fn}_${f.column??"rows"}`,l=u.accumulators[g];let a=null;switch(f.fn){case"sum":a=l.sum;break;case"avg":a=l.count>0?l.sum/l.count:null;break;case"count":a=l.count;break;case"min":a=l.min===Number.POSITIVE_INFINITY?null:l.min;break;case"max":a=l.max===Number.NEGATIVE_INFINITY?null:l.max;break}b[g]=a??0}),d.push(b)}e.orderBy&&e.orderBy.length>0&&d.sort((u,b)=>{for(const f of e.orderBy){const g=(f.direction??"desc").toLowerCase()==="asc"?1:-1,l=u[f.column],a=b[f.column];if(l===a)continue;if(l==null)return 1;if(a==null)return-1;if(typeof l=="number"&&typeof a=="number")return l>a?g:-g;const p=String(l).localeCompare(String(a));if(p!==0)return p*g}return 0});const S=typeof e.limit=="number"?d.slice(0,e.limit):d,N=r.length,L=s!=="full"&&N<n,_=[];return L&&_.push("Aggregated on sampled rows. Retry with allowFullScan for full coverage."),{schema:w,rows:S,provenance:{datasetId:e.datasetId,sampled:L,mode:s,processedRows:N,totalRows:n,queryHash:k(JSON.stringify({by:o,metrics:e.metrics,filter:e.filter,orderBy:e.orderBy,limit:e.limit,mode:s})),filterCount:c,warnings:_}}},P=async(r,e)=>{const n=await r.readColumnStoreRecord(e.datasetId);if(!n)throw new Error("No cached metadata for aggregation.");const s=e.mode??"sample",o=e.sampleSize??3e3;try{const t=s==="full"?await r.readAllRows(e.datasetId):await r.readSampledRows(e.datasetId,o);if(t.length===0)throw new Error("No rows available for aggregation.");return R(t,e,n.rowCount)}catch(t){if(t instanceof Error&&t.message==="FULL_SCAN_BLOCKED")throw Object.assign(new Error("Full scan requires confirmation."),{code:"FULL_SCAN_BLOCKED"});if(t instanceof Error&&t.message==="AGG_TIMEOUT"&&s==="full"){const c=await r.readSampledRows(e.datasetId,o),i=R(c,{...e,mode:"sample"},n.rowCount);return i.provenance.warnings.push("Full scan timed out. Showing sampled results."),i}throw t}},x=async(r,e)=>{const{datasetId:n,n:s=1e3,withColumns:o=!1}=e;if(!n)throw new Error("datasetId is required for sampling.");const[t,c]=await Promise.all([r.readSampledRows(n,s),o?r.readColumnStoreRecord(n):Promise.resolve(null)]);if(t.length===0)throw new Error("No rows available to sample.");return{rows:t,sampled:!0,columns:c==null?void 0:c.columns}};let I=null;const v=()=>typeof indexedDB<"u"&&"IDBDatabase"in self,O=async()=>{if(!v())throw new Error("IndexedDB is not available inside the worker context.");return I||(I=import("./agent_csv_csvAgentDb-C7Lfyibv.js")),I},U=async()=>{const r=await O();return{readColumnStoreRecord:r.readColumnStoreRecord,readSampledRows:r.readSampledRows,readAllRows:r.readAllRows}},B=async r=>{const e=performance.now();try{let n;const s=await U();switch(r.action){case"profile":n=await D(s,r.payload);break;case"sample":n=await x(s,r.payload);break;case"aggregate":n=await P(s,r.payload);break;default:throw new Error(`Unknown action: ${r.action}`)}return{id:r.id,ok:!0,result:n,durationMs:performance.now()-e}}catch(n){const s=n instanceof Error?n.message:"Unknown worker error";let o;return n instanceof Error&&n.code==="FULL_SCAN_BLOCKED"?o="Please confirm full scan with the user, then retry with allowFullScan=true.":s.includes("IndexedDB")?o="Browser blocked IndexedDB in this worker; falling back to main thread.":o="Retry with a smaller sample or adjust your query.",{id:r.id,ok:!1,reason:s,hint:o,durationMs:performance.now()-e}}};self.addEventListener("message",r=>{const e=r.data;!e||typeof e.id!="string"||B(e).then(n=>{self.postMessage(n)})});
