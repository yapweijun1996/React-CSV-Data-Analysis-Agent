class P{constructor(){this.nodes=new Map,this.edges=new Map,this.entryPoint=null}addNode(t,n){return this.nodes.set(t,n),this}addEdge(t,n){return this.edges.set(t,n),this}setEntryPoint(t){return this.entryPoint=t,this}build(){if(!this.entryPoint)throw new Error("LangGraphBuilder requires an entry point via setEntryPoint().");return new T(this.entryPoint,this.nodes,this.edges)}}class T{constructor(t,n,a){this.entryPoint=t,this.nodes=n,this.edges=a}async invoke(t){var p;let n=this.entryPoint,a=t.state;const r=[];let s=!1,i=n;for(;n;){const l=this.nodes.get(n);if(!l)throw new Error(`LangGraphMachine missing node handler for "${n}".`);const o=await l({state:a,payload:t.payload});if(a=o.state,(p=o.actions)!=null&&p.length&&r.push(...o.actions),i=o.label??n,o.halted){s=!0;break}n=this.edges.get(n)}return{state:a,actions:r,halted:s,label:i??"complete"}}}const $="0.1.0",x="context_ready",B=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`session-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,U=(e,t)=>{const n=new Date().toISOString(),a={sessionId:B(),planId:null,stateTag:x,phase:"observe",awaitingUser:!1,awaitPrompt:null,awaitPromptId:null,pendingUserReply:null,pendingPlan:null,pendingVerification:null,steps:[],currentStepId:null,blockedBy:null,observations:[],viewIds:[],warnings:[],loopBudget:{maxActs:3,actsUsed:0,exceeded:!1},updatedAt:n};return{...a,...t,steps:a.steps,observations:a.observations,viewIds:a.viewIds,warnings:a.warnings,loopBudget:a.loopBudget,phase:a.phase}},k=["ready","in_progress","done"],b=e=>e?["context_ready","awaiting_clarification","needs_clarification"].includes(e)?!0:/^\d{5,}-\d+$/.test(e)||/^ts[0-9a-z]{2,}-[0-9a-z_-]+$/i.test(e):!1,D=e=>{if(!Array.isArray(e))return[];const t=new Set,n=[];return e.forEach(a=>{const r=typeof(a==null?void 0:a.id)=="string"?a.id.trim():"",s=typeof(a==null?void 0:a.label)=="string"?a.label.trim():"",i=typeof(a==null?void 0:a.intent)=="string"?a.intent.trim():"conversation";if(r.length<3||s.length<3||t.has(r))return;const p=k.includes(a.status)?a.status:"ready";n.push({id:r,label:s,intent:i,status:p}),t.add(r)}),n},O=(e,t)=>{var s;if(!t)return e;const n=D(t.steps??t.nextSteps),a=typeof t.currentStepId=="string"&&t.currentStepId.trim().length>=3?t.currentStepId.trim():((s=n[0])==null?void 0:s.id)??e.currentStepId,r=typeof t.planId=="string"&&t.planId.trim().length>=3?t.planId.trim():e.planId;return{...e,planId:r,steps:n,currentStepId:a,blockedBy:t.blockedBy??e.blockedBy,stateTag:t.stateTag&&b(t.stateTag)?t.stateTag:e.stateTag,updatedAt:new Date().toISOString(),awaitPrompt:e.awaitPrompt,awaitPromptId:e.awaitPromptId,pendingUserReply:e.pendingUserReply,phase:e.phase,loopBudget:e.loopBudget}},I=e=>e?b(e):!1,R=["text_response","await_user","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request"],E=(e,t)=>{if(!Array.isArray(t)||t.length===0)return{ok:!0,nextState:e,acceptedActions:[]};if(e.awaitingUser)return g("awaiting_user","Graph is waiting for user input; no actions can run.",e);if(t.length>2)return g("turn_budget_exceeded","Each turn may include at most 2 actions.",e);const n=t[0];if(n.responseType!=="plan_state_update")return g("first_action_plan_required","First action must be plan_state_update.",e);if(!I(n.stateTag))return g("invalid_state_tag","plan_state_update is missing a valid stateTag.",e);if(!n.planState)return g("missing_plan_state","plan_state_update is missing planState payload.",e);const a=t[1];if(a){if(a.responseType==="plan_state_update")return g("atomic_type_invalid","Second action must be atomic, not plan_state_update.",e);if(!R.includes(a.responseType))return g("atomic_type_invalid",`Atomic action ${a.responseType} is not permitted in this turn.`,e);if(!I(a.stateTag))return g("invalid_state_tag","Atomic action is missing a valid stateTag.",e)}return{ok:!0,nextState:C(e,n,a),acceptedActions:t}},C=(e,t,n)=>{var s,i,p,l,o,w;let a=O(e,t.planState);return a={...a,stateTag:t.stateTag??a.stateTag,updatedAt:new Date().toISOString()},!!((s=t.meta)!=null&&s.awaitUser)||((i=t.planState)==null?void 0:i.blockedBy)==="awaiting_user_choice"||!!((p=n==null?void 0:n.meta)!=null&&p.awaitUser)||(n==null?void 0:n.responseType)==="await_user"?a={...a,awaitingUser:!0,blockedBy:((l=t.planState)==null?void 0:l.blockedBy)??(n==null?void 0:n.reason)??"awaiting_user_choice",awaitPrompt:(n==null?void 0:n.awaitUserPayload)??a.awaitPrompt,awaitPromptId:((o=n==null?void 0:n.awaitUserPayload)==null?void 0:o.promptId)??a.awaitPromptId}:a={...a,awaitingUser:!1,blockedBy:((w=t.planState)==null?void 0:w.blockedBy)??null,awaitPrompt:null,awaitPromptId:null},a},g=(e,t,n)=>({ok:!1,violations:[{code:e,message:t}],nextState:n}),L=e=>U(),A=({state:e})=>({state:{...e,phase:"observe",updatedAt:new Date().toISOString()},actions:[],label:"observe"}),M={clean_month:{toolCall:{kind:"normalize_invoice_month",params:{column:"InvoiceMonth"}},stepId:"normalize-invoice-month",stepLabel:"标准化 InvoiceMonth 字段",stepIntent:"data_cleaning",planGoal:"标准化发票月份字段，确保后续聚合一致。",planProgress:"已进入 InvoiceMonth 字段标准化阶段。",reason:"根据你的选择，先统一 InvoiceMonth 字段格式。",text:"正在本地标准化 InvoiceMonth 字段（YYYY-MM），完成后我会告知影响行数。"},outlier:{toolCall:{kind:"detect_outliers",params:{valueColumn:"Amount",multiplier:3}},stepId:"detect-amount-outliers",stepLabel:"侦测金额异常值",stepIntent:"data_validation",planGoal:"识别金额异常交易记录，提供可疑清单。",planProgress:"已开始金额异常检测（以 Amount 字段计算阈值）。",reason:"根据你的选择，先扫描金额异常值。",text:"正在比较 Amount 分布，找出超过阈值的可疑记录，稍后回报。"}},G=e=>e?M[e]:void 0,N=e=>{if(!e||typeof e!="object")return!1;const t=e;return t.source==="langchain"&&typeof t.planId=="string"&&typeof t.stepId=="string"},z=()=>`plan-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,_=20,V=e=>({type:"execute_js_code",responseType:"execute_js_code",stepId:e.stepId,stateTag:`ts${Date.now().toString(36)}-tool`,timestamp:new Date().toISOString(),reason:e.reason,text:e.text,meta:{toolCall:e.toolCall},toolCall:e.toolCall}),j=(e,t)=>{const n=[...e,t];return n.length>_?n.slice(n.length-_):n},q=e=>{if(!e)return null;const t=e.langChainPlan;return N(t)?t:null},Y=(e,t)=>{const n={type:"plan_state_update",responseType:"plan_state_update",stepId:t.stepId,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`LangChain 计划完成：${t.summary}`,planState:t.planState,meta:{source:"langchain",telemetry:t.telemetry}},a={id:t.stepId,summary:t.summary,plan:t.plan,createdAt:new Date().toISOString()},r={id:`langchain-plan-${Date.now().toString(36)}`,kind:"langchain_plan",payload:{summary:t.summary,telemetry:t.telemetry},at:new Date().toISOString()};return{state:{...e,planId:t.planId,steps:t.planState.steps??e.steps,currentStepId:t.planState.currentStepId??t.stepId,pendingPlan:a,pendingUserReply:null,phase:"plan",observations:j(e.observations,r)},actions:[n],label:"plan"}},F=({state:e,payload:t})=>{var c;const n={...e,phase:"plan",updatedAt:new Date().toISOString()},a=e.pendingUserReply;if(!a)return{state:n,actions:[],label:"plan"};const r=q(t),s=a.optionId?G(a.optionId):void 0;if(!s){if(!r)throw new Error("LangChain plan payload missing; cannot construct plan node actions.");return Y(n,r)}const i=a.freeText||((c=a.options.find(h=>h.id===a.optionId))==null?void 0:c.label)||a.optionId||a.question,p=e.planId??z(),l=s.stepId,o={id:l,intent:s.stepIntent,label:s.stepLabel,status:"in_progress"},u=[{type:"plan_state_update",responseType:"plan_state_update",stepId:l,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`根据你的选择更新计划：${i}`,planState:{planId:p,goal:(s==null?void 0:s.planGoal)??"完成你刚刚点选的分析任务",contextSummary:a.question,progress:(s==null?void 0:s.planProgress)??`收到你的选择「${i}」，准备执行。`,nextSteps:[o],steps:[o],currentStepId:l,blockedBy:null,observationIds:[],confidence:.62,updatedAt:new Date().toISOString(),stateTag:`ts${Date.now().toString(36)}-planstate`}}];return u.push(V({toolCall:s.toolCall,stepId:s.stepId,reason:s.reason,text:s.text})),{state:{...n,planId:p,steps:[o],currentStepId:l,pendingPlan:null,pendingUserReply:null},actions:u,label:"plan"}},H=({state:e})=>{const t=e.pendingPlan;if(!t||!t.plan)return{state:{...e,phase:"act"},actions:[],label:"act"};const n={type:"plan_creation",responseType:"plan_creation",stepId:t.id,stateTag:`ts${Date.now().toString(36)}-act`,timestamp:new Date().toISOString(),reason:`根据选择「${t.summary}」创建分析计划`,plan:t.plan},a=Math.min(e.loopBudget.maxActs,e.loopBudget.actsUsed+1),r={...e.loopBudget,actsUsed:a,exceeded:a>=e.loopBudget.maxActs};return{state:{...e,phase:"act",pendingPlan:null,pendingVerification:{id:t.id,description:t.summary,meta:null,summary:t.summary,payload:null,createdAt:new Date().toISOString()},loopBudget:r},actions:[n],label:"act"}},X=({state:e})=>{var l;const t=e.pendingVerification;if(!t)return{state:{...e,phase:"verify"},actions:[],label:"verify"};const n=t.meta,a=[];t.summary?a.push(t.summary):n&&(n.source&&a.push(`数据源：${n.source==="sample"?"采样":"全量"}`),typeof n.rows=="number"&&a.push(`记录数：${n.rows}`),typeof n.processedRows=="number"&&typeof n.totalRows=="number"&&a.push(`处理行：${n.processedRows}/${n.totalRows}`),(l=n.warnings)!=null&&l.length&&a.push(`警告 ${n.warnings.length} 条`),n.summary&&a.push(n.summary));const s=(()=>{const o=t.payload;if(!o||typeof o!="object")return null;switch(typeof o.kind=="string"?o.kind:null){case"profile_dataset":{const u=o.columns,c=o.rowCount,h=o.sampledRows;return`列画像：${u??"?"} 列 · ${c??"?"} 行（采样 ${h??"?"}）`}case"normalize_invoice_month":{const u=o.column??"InvoiceMonth",c=o.normalizedCount,h=o.skippedCount;return`标准化 ${u}：成功 ${c??0}，跳过 ${h??0}`}case"detect_outliers":{const u=o.column??"value",c=o.count,h=o.threshold;return`异常检测 ${u}：找到 ${c??0} 条（阈值 ${h??"?"}）`}case"aggregate_plan":{const u=o.planTitle??t.description,c=o.rows;return`聚合视图「${u}」产生 ${c??0} 行结果。`}default:return null}})();s&&a.push(s);const i=e.loopBudget.exceeded||e.loopBudget.actsUsed>=e.loopBudget.maxActs,p={type:"text_response",responseType:"text_response",stepId:t.id,stateTag:`ts${Date.now().toString(36)}-verify`,timestamp:new Date().toISOString(),reason:"确认最新的聚合结果，并说明数据来源。",text:n?`已完成「${t.description}」。
${a.join(" · ")}${i?`
⚠️ 已达到自动执行次数上限，如需继续请确认。`:""}`:`已完成「${t.description}」的初步执行，准备生成可视化或进一步说明。${i?`
⚠️ 已达到自动执行次数上限，如需继续请确认。`:""}`};return{state:{...e,phase:"verify",pendingVerification:null,loopBudget:{...e.loopBudget,exceeded:i},blockedBy:i?"loop_budget_exceeded":e.blockedBy},actions:[p],label:"verify"}},f=self,K=new P().addNode("observe",A).addNode("plan",F).addNode("act",H).addNode("verify",X).addEdge("observe","plan").addEdge("plan","act").addEdge("act","verify").setEntryPoint("observe").build();let d=L();const S=20,m=()=>Date.now(),y=e=>{f.postMessage(e)},v=()=>{y({type:"graph/ready",version:$,timestamp:m()})},W=e=>{var a,r,s,i;const t=m(),n=E(d,e);n.ok&&n.nextState&&(d=n.nextState),y({type:"graph/validation",ok:n.ok,timestamp:t,code:(r=(a=n.violations)==null?void 0:a[0])==null?void 0:r.code,reason:(i=(s=n.violations)==null?void 0:s[0])==null?void 0:i.message,state:n.nextState})},J=e=>{const t=e.find(a=>a.meta&&"telemetry"in a.meta);return!t||!t.meta?null:t.meta.telemetry??null},Q=async e=>{const t=await K.invoke({state:d,payload:e});d=t.state;const n=J(t.actions);y({type:"graph/pipeline",node:t.label,actions:t.actions,state:d,phase:d.phase,loopBudget:d.loopBudget,telemetry:n,timestamp:m()})},Z=(e,t)=>{const n=d.awaitPrompt;d={...d,awaitingUser:!1,blockedBy:null,awaitPrompt:null,awaitPromptId:null,pendingUserReply:{optionId:e??null,freeText:t??null,promptId:(n==null?void 0:n.promptId)??null,question:(n==null?void 0:n.question)??"User follow-up",options:(n==null?void 0:n.options)??[],at:new Date().toISOString()},stateTag:"context_ready",updatedAt:new Date().toISOString()};const a=e||t?`User replied with ${e??""} ${t??""}`.trim():"User reply received.";y({type:"graph/log",level:"info",message:a,timestamp:m()})},ee=e=>{var i;const t=`verify-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,n=new Date().toISOString(),a={id:t,kind:typeof((i=e.payload)==null?void 0:i.kind)=="string"?e.payload.kind:"tool_result",payload:{description:e.description,summary:e.summary??null,meta:e.meta??null,...e.payload??{}},at:n},r=[...d.observations,a],s=r.length>S?r.slice(r.length-S):r;d={...d,pendingVerification:{id:t,description:e.description,meta:e.meta?{...e.meta,summary:e.summary??void 0}:null,summary:e.summary??null,payload:e.payload??null,createdAt:n},observations:s}},te=e=>{switch(e.type){case"graph/init":v();return;case"graph/ping":y({type:"graph/pong",nonce:e.nonce,timestamp:m()});return;case"graph/shutdown":y({type:"graph/log",level:"info",message:e.reason?`LangGraph runtime shutting down: ${e.reason}`:"LangGraph runtime shutting down by request.",timestamp:m()}),f.close();return;case"graph/applyActions":W(e.actions??[]);return;case"graph/runPipeline":Q(e.payload??{});return;case"graph/userReply":Z(e.optionId??null,e.freeText??null);return;case"graph/tool_result":ee(e.verification);return;default:y({type:"graph/log",level:"warn",message:`Unhandled client event ${e.type}`,timestamp:m()})}};f.addEventListener("message",e=>{const t=e.data;if(!t||typeof t!="object"||typeof t.type!="string"){y({type:"graph/log",level:"warn",message:"Ignored message without graph type.",timestamp:m()});return}te(t)});v();
