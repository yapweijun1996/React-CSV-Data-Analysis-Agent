const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["agent_csv_promptRunner-PxCNeSoz.js","agent_csv_planBridge-DdMBp1-m.js"])))=>i.map(i=>d[i]);
var tL=Object.defineProperty;var nL=(t,e,n)=>e in t?tL(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var z=(t,e,n)=>nL(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();function Ga(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Km={exports:{}},iu={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Fx;function rL(){if(Fx)return iu;Fx=1;var t=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function n(r,s,a){var o=null;if(a!==void 0&&(o=""+a),s.key!==void 0&&(o=""+s.key),"key"in s){a={};for(var u in s)u!=="key"&&(a[u]=s[u])}else a=s;return s=a.ref,{$$typeof:t,type:r,key:o,ref:s!==void 0?s:null,props:a}}return iu.Fragment=e,iu.jsx=n,iu.jsxs=n,iu}var Bx;function sL(){return Bx||(Bx=1,Km.exports=rL()),Km.exports}var S=sL(),Wm={exports:{}},Ye={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var qx;function aL(){if(qx)return Ye;qx=1;var t=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),n=Symbol.for("react.fragment"),r=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),a=Symbol.for("react.consumer"),o=Symbol.for("react.context"),u=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),c=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),m=Symbol.for("react.activity"),y=Symbol.iterator;function w(q){return q===null||typeof q!="object"?null:(q=y&&q[y]||q["@@iterator"],typeof q=="function"?q:null)}var x={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},A=Object.assign,E={};function C(q,W,ee){this.props=q,this.context=W,this.refs=E,this.updater=ee||x}C.prototype.isReactComponent={},C.prototype.setState=function(q,W){if(typeof q!="object"&&typeof q!="function"&&q!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,q,W,"setState")},C.prototype.forceUpdate=function(q){this.updater.enqueueForceUpdate(this,q,"forceUpdate")};function D(){}D.prototype=C.prototype;function O(q,W,ee){this.props=q,this.context=W,this.refs=E,this.updater=ee||x}var T=O.prototype=new D;T.constructor=O,A(T,C.prototype),T.isPureReactComponent=!0;var I=Array.isArray;function M(){}var N={H:null,A:null,T:null,S:null},P=Object.prototype.hasOwnProperty;function k(q,W,ee){var ce=ee.ref;return{$$typeof:t,type:q,key:W,ref:ce!==void 0?ce:null,props:ee}}function $(q,W){return k(q.type,W,q.props)}function U(q){return typeof q=="object"&&q!==null&&q.$$typeof===t}function F(q){var W={"=":"=0",":":"=2"};return"$"+q.replace(/[=:]/g,function(ee){return W[ee]})}var K=/\/+/g;function j(q,W){return typeof q=="object"&&q!==null&&q.key!=null?F(""+q.key):W.toString(36)}function V(q){switch(q.status){case"fulfilled":return q.value;case"rejected":throw q.reason;default:switch(typeof q.status=="string"?q.then(M,M):(q.status="pending",q.then(function(W){q.status==="pending"&&(q.status="fulfilled",q.value=W)},function(W){q.status==="pending"&&(q.status="rejected",q.reason=W)})),q.status){case"fulfilled":return q.value;case"rejected":throw q.reason}}throw q}function B(q,W,ee,ce,ie){var fe=typeof q;(fe==="undefined"||fe==="boolean")&&(q=null);var Re=!1;if(q===null)Re=!0;else switch(fe){case"bigint":case"string":case"number":Re=!0;break;case"object":switch(q.$$typeof){case t:case e:Re=!0;break;case p:return Re=q._init,B(Re(q._payload),W,ee,ce,ie)}}if(Re)return ie=ie(q),Re=ce===""?"."+j(q,0):ce,I(ie)?(ee="",Re!=null&&(ee=Re.replace(K,"$&/")+"/"),B(ie,W,ee,"",function(Ae){return Ae})):ie!=null&&(U(ie)&&(ie=$(ie,ee+(ie.key==null||q&&q.key===ie.key?"":(""+ie.key).replace(K,"$&/")+"/")+Re)),W.push(ie)),1;Re=0;var Ge=ce===""?".":ce+":";if(I(q))for(var ze=0;ze<q.length;ze++)ce=q[ze],fe=Ge+j(ce,ze),Re+=B(ce,W,ee,fe,ie);else if(ze=w(q),typeof ze=="function")for(q=ze.call(q),ze=0;!(ce=q.next()).done;)ce=ce.value,fe=Ge+j(ce,ze++),Re+=B(ce,W,ee,fe,ie);else if(fe==="object"){if(typeof q.then=="function")return B(V(q),W,ee,ce,ie);throw W=String(q),Error("Objects are not valid as a React child (found: "+(W==="[object Object]"?"object with keys {"+Object.keys(q).join(", ")+"}":W)+"). If you meant to render a collection of children, use an array instead.")}return Re}function G(q,W,ee){if(q==null)return q;var ce=[],ie=0;return B(q,ce,"","",function(fe){return W.call(ee,fe,ie++)}),ce}function Z(q){if(q._status===-1){var W=q._result;W=W(),W.then(function(ee){(q._status===0||q._status===-1)&&(q._status=1,q._result=ee)},function(ee){(q._status===0||q._status===-1)&&(q._status=2,q._result=ee)}),q._status===-1&&(q._status=0,q._result=W)}if(q._status===1)return q._result.default;throw q._result}var se=typeof reportError=="function"?reportError:function(q){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var W=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof q=="object"&&q!==null&&typeof q.message=="string"?String(q.message):String(q),error:q});if(!window.dispatchEvent(W))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",q);return}console.error(q)},le={map:G,forEach:function(q,W,ee){G(q,function(){W.apply(this,arguments)},ee)},count:function(q){var W=0;return G(q,function(){W++}),W},toArray:function(q){return G(q,function(W){return W})||[]},only:function(q){if(!U(q))throw Error("React.Children.only expected to receive a single React element child.");return q}};return Ye.Activity=m,Ye.Children=le,Ye.Component=C,Ye.Fragment=n,Ye.Profiler=s,Ye.PureComponent=O,Ye.StrictMode=r,Ye.Suspense=d,Ye.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=N,Ye.__COMPILER_RUNTIME={__proto__:null,c:function(q){return N.H.useMemoCache(q)}},Ye.cache=function(q){return function(){return q.apply(null,arguments)}},Ye.cacheSignal=function(){return null},Ye.cloneElement=function(q,W,ee){if(q==null)throw Error("The argument must be a React element, but you passed "+q+".");var ce=A({},q.props),ie=q.key;if(W!=null)for(fe in W.key!==void 0&&(ie=""+W.key),W)!P.call(W,fe)||fe==="key"||fe==="__self"||fe==="__source"||fe==="ref"&&W.ref===void 0||(ce[fe]=W[fe]);var fe=arguments.length-2;if(fe===1)ce.children=ee;else if(1<fe){for(var Re=Array(fe),Ge=0;Ge<fe;Ge++)Re[Ge]=arguments[Ge+2];ce.children=Re}return k(q.type,ie,ce)},Ye.createContext=function(q){return q={$$typeof:o,_currentValue:q,_currentValue2:q,_threadCount:0,Provider:null,Consumer:null},q.Provider=q,q.Consumer={$$typeof:a,_context:q},q},Ye.createElement=function(q,W,ee){var ce,ie={},fe=null;if(W!=null)for(ce in W.key!==void 0&&(fe=""+W.key),W)P.call(W,ce)&&ce!=="key"&&ce!=="__self"&&ce!=="__source"&&(ie[ce]=W[ce]);var Re=arguments.length-2;if(Re===1)ie.children=ee;else if(1<Re){for(var Ge=Array(Re),ze=0;ze<Re;ze++)Ge[ze]=arguments[ze+2];ie.children=Ge}if(q&&q.defaultProps)for(ce in Re=q.defaultProps,Re)ie[ce]===void 0&&(ie[ce]=Re[ce]);return k(q,fe,ie)},Ye.createRef=function(){return{current:null}},Ye.forwardRef=function(q){return{$$typeof:u,render:q}},Ye.isValidElement=U,Ye.lazy=function(q){return{$$typeof:p,_payload:{_status:-1,_result:q},_init:Z}},Ye.memo=function(q,W){return{$$typeof:c,type:q,compare:W===void 0?null:W}},Ye.startTransition=function(q){var W=N.T,ee={};N.T=ee;try{var ce=q(),ie=N.S;ie!==null&&ie(ee,ce),typeof ce=="object"&&ce!==null&&typeof ce.then=="function"&&ce.then(M,se)}catch(fe){se(fe)}finally{W!==null&&ee.types!==null&&(W.types=ee.types),N.T=W}},Ye.unstable_useCacheRefresh=function(){return N.H.useCacheRefresh()},Ye.use=function(q){return N.H.use(q)},Ye.useActionState=function(q,W,ee){return N.H.useActionState(q,W,ee)},Ye.useCallback=function(q,W){return N.H.useCallback(q,W)},Ye.useContext=function(q){return N.H.useContext(q)},Ye.useDebugValue=function(){},Ye.useDeferredValue=function(q,W){return N.H.useDeferredValue(q,W)},Ye.useEffect=function(q,W){return N.H.useEffect(q,W)},Ye.useEffectEvent=function(q){return N.H.useEffectEvent(q)},Ye.useId=function(){return N.H.useId()},Ye.useImperativeHandle=function(q,W,ee){return N.H.useImperativeHandle(q,W,ee)},Ye.useInsertionEffect=function(q,W){return N.H.useInsertionEffect(q,W)},Ye.useLayoutEffect=function(q,W){return N.H.useLayoutEffect(q,W)},Ye.useMemo=function(q,W){return N.H.useMemo(q,W)},Ye.useOptimistic=function(q,W){return N.H.useOptimistic(q,W)},Ye.useReducer=function(q,W,ee){return N.H.useReducer(q,W,ee)},Ye.useRef=function(q){return N.H.useRef(q)},Ye.useState=function(q){return N.H.useState(q)},Ye.useSyncExternalStore=function(q,W,ee){return N.H.useSyncExternalStore(q,W,ee)},Ye.useTransition=function(){return N.H.useTransition()},Ye.version="19.2.0",Ye}var Gx;function rc(){return Gx||(Gx=1,Wm.exports=aL()),Wm.exports}var de=rc();const Us=Ga(de);var Zm={exports:{}},ou={},Xm={exports:{}},Qm={};/**
 * @license React
 * scheduler.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Hx;function iL(){return Hx||(Hx=1,(function(t){function e(B,G){var Z=B.length;B.push(G);e:for(;0<Z;){var se=Z-1>>>1,le=B[se];if(0<s(le,G))B[se]=G,B[Z]=le,Z=se;else break e}}function n(B){return B.length===0?null:B[0]}function r(B){if(B.length===0)return null;var G=B[0],Z=B.pop();if(Z!==G){B[0]=Z;e:for(var se=0,le=B.length,q=le>>>1;se<q;){var W=2*(se+1)-1,ee=B[W],ce=W+1,ie=B[ce];if(0>s(ee,Z))ce<le&&0>s(ie,ee)?(B[se]=ie,B[ce]=Z,se=ce):(B[se]=ee,B[W]=Z,se=W);else if(ce<le&&0>s(ie,Z))B[se]=ie,B[ce]=Z,se=ce;else break e}}return G}function s(B,G){var Z=B.sortIndex-G.sortIndex;return Z!==0?Z:B.id-G.id}if(t.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var a=performance;t.unstable_now=function(){return a.now()}}else{var o=Date,u=o.now();t.unstable_now=function(){return o.now()-u}}var d=[],c=[],p=1,m=null,y=3,w=!1,x=!1,A=!1,E=!1,C=typeof setTimeout=="function"?setTimeout:null,D=typeof clearTimeout=="function"?clearTimeout:null,O=typeof setImmediate<"u"?setImmediate:null;function T(B){for(var G=n(c);G!==null;){if(G.callback===null)r(c);else if(G.startTime<=B)r(c),G.sortIndex=G.expirationTime,e(d,G);else break;G=n(c)}}function I(B){if(A=!1,T(B),!x)if(n(d)!==null)x=!0,M||(M=!0,F());else{var G=n(c);G!==null&&V(I,G.startTime-B)}}var M=!1,N=-1,P=5,k=-1;function $(){return E?!0:!(t.unstable_now()-k<P)}function U(){if(E=!1,M){var B=t.unstable_now();k=B;var G=!0;try{e:{x=!1,A&&(A=!1,D(N),N=-1),w=!0;var Z=y;try{t:{for(T(B),m=n(d);m!==null&&!(m.expirationTime>B&&$());){var se=m.callback;if(typeof se=="function"){m.callback=null,y=m.priorityLevel;var le=se(m.expirationTime<=B);if(B=t.unstable_now(),typeof le=="function"){m.callback=le,T(B),G=!0;break t}m===n(d)&&r(d),T(B)}else r(d);m=n(d)}if(m!==null)G=!0;else{var q=n(c);q!==null&&V(I,q.startTime-B),G=!1}}break e}finally{m=null,y=Z,w=!1}G=void 0}}finally{G?F():M=!1}}}var F;if(typeof O=="function")F=function(){O(U)};else if(typeof MessageChannel<"u"){var K=new MessageChannel,j=K.port2;K.port1.onmessage=U,F=function(){j.postMessage(null)}}else F=function(){C(U,0)};function V(B,G){N=C(function(){B(t.unstable_now())},G)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(B){B.callback=null},t.unstable_forceFrameRate=function(B){0>B||125<B?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):P=0<B?Math.floor(1e3/B):5},t.unstable_getCurrentPriorityLevel=function(){return y},t.unstable_next=function(B){switch(y){case 1:case 2:case 3:var G=3;break;default:G=y}var Z=y;y=G;try{return B()}finally{y=Z}},t.unstable_requestPaint=function(){E=!0},t.unstable_runWithPriority=function(B,G){switch(B){case 1:case 2:case 3:case 4:case 5:break;default:B=3}var Z=y;y=B;try{return G()}finally{y=Z}},t.unstable_scheduleCallback=function(B,G,Z){var se=t.unstable_now();switch(typeof Z=="object"&&Z!==null?(Z=Z.delay,Z=typeof Z=="number"&&0<Z?se+Z:se):Z=se,B){case 1:var le=-1;break;case 2:le=250;break;case 5:le=1073741823;break;case 4:le=1e4;break;default:le=5e3}return le=Z+le,B={id:p++,callback:G,priorityLevel:B,startTime:Z,expirationTime:le,sortIndex:-1},Z>se?(B.sortIndex=Z,e(c,B),n(d)===null&&B===n(c)&&(A?(D(N),N=-1):A=!0,V(I,Z-se))):(B.sortIndex=le,e(d,B),x||w||(x=!0,M||(M=!0,F()))),B},t.unstable_shouldYield=$,t.unstable_wrapCallback=function(B){var G=y;return function(){var Z=y;y=G;try{return B.apply(this,arguments)}finally{y=Z}}}})(Qm)),Qm}var zx;function oL(){return zx||(zx=1,Xm.exports=iL()),Xm.exports}var eg={exports:{}},En={};/**
 * @license React
 * react-dom.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var jx;function lL(){if(jx)return En;jx=1;var t=rc();function e(d){var c="https://react.dev/errors/"+d;if(1<arguments.length){c+="?args[]="+encodeURIComponent(arguments[1]);for(var p=2;p<arguments.length;p++)c+="&args[]="+encodeURIComponent(arguments[p])}return"Minified React error #"+d+"; visit "+c+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function n(){}var r={d:{f:n,r:function(){throw Error(e(522))},D:n,C:n,L:n,m:n,X:n,S:n,M:n},p:0,findDOMNode:null},s=Symbol.for("react.portal");function a(d,c,p){var m=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:s,key:m==null?null:""+m,children:d,containerInfo:c,implementation:p}}var o=t.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function u(d,c){if(d==="font")return"";if(typeof c=="string")return c==="use-credentials"?c:""}return En.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=r,En.createPortal=function(d,c){var p=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!c||c.nodeType!==1&&c.nodeType!==9&&c.nodeType!==11)throw Error(e(299));return a(d,c,null,p)},En.flushSync=function(d){var c=o.T,p=r.p;try{if(o.T=null,r.p=2,d)return d()}finally{o.T=c,r.p=p,r.d.f()}},En.preconnect=function(d,c){typeof d=="string"&&(c?(c=c.crossOrigin,c=typeof c=="string"?c==="use-credentials"?c:"":void 0):c=null,r.d.C(d,c))},En.prefetchDNS=function(d){typeof d=="string"&&r.d.D(d)},En.preinit=function(d,c){if(typeof d=="string"&&c&&typeof c.as=="string"){var p=c.as,m=u(p,c.crossOrigin),y=typeof c.integrity=="string"?c.integrity:void 0,w=typeof c.fetchPriority=="string"?c.fetchPriority:void 0;p==="style"?r.d.S(d,typeof c.precedence=="string"?c.precedence:void 0,{crossOrigin:m,integrity:y,fetchPriority:w}):p==="script"&&r.d.X(d,{crossOrigin:m,integrity:y,fetchPriority:w,nonce:typeof c.nonce=="string"?c.nonce:void 0})}},En.preinitModule=function(d,c){if(typeof d=="string")if(typeof c=="object"&&c!==null){if(c.as==null||c.as==="script"){var p=u(c.as,c.crossOrigin);r.d.M(d,{crossOrigin:p,integrity:typeof c.integrity=="string"?c.integrity:void 0,nonce:typeof c.nonce=="string"?c.nonce:void 0})}}else c==null&&r.d.M(d)},En.preload=function(d,c){if(typeof d=="string"&&typeof c=="object"&&c!==null&&typeof c.as=="string"){var p=c.as,m=u(p,c.crossOrigin);r.d.L(d,p,{crossOrigin:m,integrity:typeof c.integrity=="string"?c.integrity:void 0,nonce:typeof c.nonce=="string"?c.nonce:void 0,type:typeof c.type=="string"?c.type:void 0,fetchPriority:typeof c.fetchPriority=="string"?c.fetchPriority:void 0,referrerPolicy:typeof c.referrerPolicy=="string"?c.referrerPolicy:void 0,imageSrcSet:typeof c.imageSrcSet=="string"?c.imageSrcSet:void 0,imageSizes:typeof c.imageSizes=="string"?c.imageSizes:void 0,media:typeof c.media=="string"?c.media:void 0})}},En.preloadModule=function(d,c){if(typeof d=="string")if(c){var p=u(c.as,c.crossOrigin);r.d.m(d,{as:typeof c.as=="string"&&c.as!=="script"?c.as:void 0,crossOrigin:p,integrity:typeof c.integrity=="string"?c.integrity:void 0})}else r.d.m(d)},En.requestFormReset=function(d){r.d.r(d)},En.unstable_batchedUpdates=function(d,c){return d(c)},En.useFormState=function(d,c,p){return o.H.useFormState(d,c,p)},En.useFormStatus=function(){return o.H.useHostTransitionStatus()},En.version="19.2.0",En}var Vx;function uL(){if(Vx)return eg.exports;Vx=1;function t(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(t)}catch(e){console.error(e)}}return t(),eg.exports=lL(),eg.exports}/**
 * @license React
 * react-dom-client.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Jx;function cL(){if(Jx)return ou;Jx=1;var t=oL(),e=rc(),n=uL();function r(i){var l="https://react.dev/errors/"+i;if(1<arguments.length){l+="?args[]="+encodeURIComponent(arguments[1]);for(var f=2;f<arguments.length;f++)l+="&args[]="+encodeURIComponent(arguments[f])}return"Minified React error #"+i+"; visit "+l+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function s(i){return!(!i||i.nodeType!==1&&i.nodeType!==9&&i.nodeType!==11)}function a(i){var l=i,f=i;if(i.alternate)for(;l.return;)l=l.return;else{i=l;do l=i,(l.flags&4098)!==0&&(f=l.return),i=l.return;while(i)}return l.tag===3?f:null}function o(i){if(i.tag===13){var l=i.memoizedState;if(l===null&&(i=i.alternate,i!==null&&(l=i.memoizedState)),l!==null)return l.dehydrated}return null}function u(i){if(i.tag===31){var l=i.memoizedState;if(l===null&&(i=i.alternate,i!==null&&(l=i.memoizedState)),l!==null)return l.dehydrated}return null}function d(i){if(a(i)!==i)throw Error(r(188))}function c(i){var l=i.alternate;if(!l){if(l=a(i),l===null)throw Error(r(188));return l!==i?null:i}for(var f=i,h=l;;){var v=f.return;if(v===null)break;var b=v.alternate;if(b===null){if(h=v.return,h!==null){f=h;continue}break}if(v.child===b.child){for(b=v.child;b;){if(b===f)return d(v),i;if(b===h)return d(v),l;b=b.sibling}throw Error(r(188))}if(f.return!==h.return)f=v,h=b;else{for(var R=!1,L=v.child;L;){if(L===f){R=!0,f=v,h=b;break}if(L===h){R=!0,h=v,f=b;break}L=L.sibling}if(!R){for(L=b.child;L;){if(L===f){R=!0,f=b,h=v;break}if(L===h){R=!0,h=b,f=v;break}L=L.sibling}if(!R)throw Error(r(189))}}if(f.alternate!==h)throw Error(r(190))}if(f.tag!==3)throw Error(r(188));return f.stateNode.current===f?i:l}function p(i){var l=i.tag;if(l===5||l===26||l===27||l===6)return i;for(i=i.child;i!==null;){if(l=p(i),l!==null)return l;i=i.sibling}return null}var m=Object.assign,y=Symbol.for("react.element"),w=Symbol.for("react.transitional.element"),x=Symbol.for("react.portal"),A=Symbol.for("react.fragment"),E=Symbol.for("react.strict_mode"),C=Symbol.for("react.profiler"),D=Symbol.for("react.consumer"),O=Symbol.for("react.context"),T=Symbol.for("react.forward_ref"),I=Symbol.for("react.suspense"),M=Symbol.for("react.suspense_list"),N=Symbol.for("react.memo"),P=Symbol.for("react.lazy"),k=Symbol.for("react.activity"),$=Symbol.for("react.memo_cache_sentinel"),U=Symbol.iterator;function F(i){return i===null||typeof i!="object"?null:(i=U&&i[U]||i["@@iterator"],typeof i=="function"?i:null)}var K=Symbol.for("react.client.reference");function j(i){if(i==null)return null;if(typeof i=="function")return i.$$typeof===K?null:i.displayName||i.name||null;if(typeof i=="string")return i;switch(i){case A:return"Fragment";case C:return"Profiler";case E:return"StrictMode";case I:return"Suspense";case M:return"SuspenseList";case k:return"Activity"}if(typeof i=="object")switch(i.$$typeof){case x:return"Portal";case O:return i.displayName||"Context";case D:return(i._context.displayName||"Context")+".Consumer";case T:var l=i.render;return i=i.displayName,i||(i=l.displayName||l.name||"",i=i!==""?"ForwardRef("+i+")":"ForwardRef"),i;case N:return l=i.displayName||null,l!==null?l:j(i.type)||"Memo";case P:l=i._payload,i=i._init;try{return j(i(l))}catch{}}return null}var V=Array.isArray,B=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,G=n.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,Z={pending:!1,data:null,method:null,action:null},se=[],le=-1;function q(i){return{current:i}}function W(i){0>le||(i.current=se[le],se[le]=null,le--)}function ee(i,l){le++,se[le]=i.current,i.current=l}var ce=q(null),ie=q(null),fe=q(null),Re=q(null);function Ge(i,l){switch(ee(fe,l),ee(ie,i),ee(ce,null),l.nodeType){case 9:case 11:i=(i=l.documentElement)&&(i=i.namespaceURI)?lx(i):0;break;default:if(i=l.tagName,l=l.namespaceURI)l=lx(l),i=ux(l,i);else switch(i){case"svg":i=1;break;case"math":i=2;break;default:i=0}}W(ce),ee(ce,i)}function ze(){W(ce),W(ie),W(fe)}function Ae(i){i.memoizedState!==null&&ee(Re,i);var l=ce.current,f=ux(l,i.type);l!==f&&(ee(ie,i),ee(ce,f))}function Rt(i){ie.current===i&&(W(ce),W(ie)),Re.current===i&&(W(Re),nu._currentValue=Z)}var je,dn;function ct(i){if(je===void 0)try{throw Error()}catch(f){var l=f.stack.trim().match(/\n( *(at )?)/);je=l&&l[1]||"",dn=-1<f.stack.indexOf(`
    at`)?" (<anonymous>)":-1<f.stack.indexOf("@")?"@unknown:0:0":""}return`
`+je+i+dn}var nn=!1;function rn(i,l){if(!i||nn)return"";nn=!0;var f=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var h={DetermineComponentFrameRoot:function(){try{if(l){var ue=function(){throw Error()};if(Object.defineProperty(ue.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(ue,[])}catch(re){var ne=re}Reflect.construct(i,[],ue)}else{try{ue.call()}catch(re){ne=re}i.call(ue.prototype)}}else{try{throw Error()}catch(re){ne=re}(ue=i())&&typeof ue.catch=="function"&&ue.catch(function(){})}}catch(re){if(re&&ne&&typeof re.stack=="string")return[re.stack,ne.stack]}return[null,null]}};h.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var v=Object.getOwnPropertyDescriptor(h.DetermineComponentFrameRoot,"name");v&&v.configurable&&Object.defineProperty(h.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var b=h.DetermineComponentFrameRoot(),R=b[0],L=b[1];if(R&&L){var H=R.split(`
`),Q=L.split(`
`);for(v=h=0;h<H.length&&!H[h].includes("DetermineComponentFrameRoot");)h++;for(;v<Q.length&&!Q[v].includes("DetermineComponentFrameRoot");)v++;if(h===H.length||v===Q.length)for(h=H.length-1,v=Q.length-1;1<=h&&0<=v&&H[h]!==Q[v];)v--;for(;1<=h&&0<=v;h--,v--)if(H[h]!==Q[v]){if(h!==1||v!==1)do if(h--,v--,0>v||H[h]!==Q[v]){var ae=`
`+H[h].replace(" at new "," at ");return i.displayName&&ae.includes("<anonymous>")&&(ae=ae.replace("<anonymous>",i.displayName)),ae}while(1<=h&&0<=v);break}}}finally{nn=!1,Error.prepareStackTrace=f}return(f=i?i.displayName||i.name:"")?ct(f):""}function Oe(i,l){switch(i.tag){case 26:case 27:case 5:return ct(i.type);case 16:return ct("Lazy");case 13:return i.child!==l&&l!==null?ct("Suspense Fallback"):ct("Suspense");case 19:return ct("SuspenseList");case 0:case 15:return rn(i.type,!1);case 11:return rn(i.type.render,!1);case 1:return rn(i.type,!0);case 31:return ct("Activity");default:return""}}function lt(i){try{var l="",f=null;do l+=Oe(i,f),f=i,i=i.return;while(i);return l}catch(h){return`
Error generating stack: `+h.message+`
`+h.stack}}var Nn=Object.prototype.hasOwnProperty,ge=t.unstable_scheduleCallback,Ct=t.unstable_cancelCallback,Ee=t.unstable_shouldYield,Ce=t.unstable_requestPaint,_e=t.unstable_now,ve=t.unstable_getCurrentPriorityLevel,ye=t.unstable_ImmediatePriority,Be=t.unstable_UserBlockingPriority,De=t.unstable_NormalPriority,fn=t.unstable_LowPriority,fs=t.unstable_IdlePriority,Ka=t.log,_c=t.unstable_setDisableYieldValue,Ks=null,_n=null;function Jr(i){if(typeof Ka=="function"&&_c(i),_n&&typeof _n.setStrictMode=="function")try{_n.setStrictMode(Ks,i)}catch{}}var Pn=Math.clz32?Math.clz32:vc,ml=Math.log,Fp=Math.LN2;function vc(i){return i>>>=0,i===0?32:31-(ml(i)/Fp|0)|0}var Bi=256,qi=262144,Wa=4194304;function ps(i){var l=i&42;if(l!==0)return l;switch(i&-i){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return i&261888;case 262144:case 524288:case 1048576:case 2097152:return i&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return i&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return i}}function Gi(i,l,f){var h=i.pendingLanes;if(h===0)return 0;var v=0,b=i.suspendedLanes,R=i.pingedLanes;i=i.warmLanes;var L=h&134217727;return L!==0?(h=L&~b,h!==0?v=ps(h):(R&=L,R!==0?v=ps(R):f||(f=L&~i,f!==0&&(v=ps(f))))):(L=h&~b,L!==0?v=ps(L):R!==0?v=ps(R):f||(f=h&~i,f!==0&&(v=ps(f)))),v===0?0:l!==0&&l!==v&&(l&b)===0&&(b=v&-v,f=l&-l,b>=f||b===32&&(f&4194048)!==0)?l:v}function Za(i,l){return(i.pendingLanes&~(i.suspendedLanes&~i.pingedLanes)&l)===0}function Bp(i,l){switch(i){case 1:case 2:case 4:case 8:case 64:return l+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return l+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function wc(){var i=Wa;return Wa<<=1,(Wa&62914560)===0&&(Wa=4194304),i}function gl(i){for(var l=[],f=0;31>f;f++)l.push(i);return l}function Xa(i,l){i.pendingLanes|=l,l!==268435456&&(i.suspendedLanes=0,i.pingedLanes=0,i.warmLanes=0)}function qp(i,l,f,h,v,b){var R=i.pendingLanes;i.pendingLanes=f,i.suspendedLanes=0,i.pingedLanes=0,i.warmLanes=0,i.expiredLanes&=f,i.entangledLanes&=f,i.errorRecoveryDisabledLanes&=f,i.shellSuspendCounter=0;var L=i.entanglements,H=i.expirationTimes,Q=i.hiddenUpdates;for(f=R&~f;0<f;){var ae=31-Pn(f),ue=1<<ae;L[ae]=0,H[ae]=-1;var ne=Q[ae];if(ne!==null)for(Q[ae]=null,ae=0;ae<ne.length;ae++){var re=ne[ae];re!==null&&(re.lane&=-536870913)}f&=~ue}h!==0&&yl(i,h,0),b!==0&&v===0&&i.tag!==0&&(i.suspendedLanes|=b&~(R&~l))}function yl(i,l,f){i.pendingLanes|=l,i.suspendedLanes&=~l;var h=31-Pn(l);i.entangledLanes|=l,i.entanglements[h]=i.entanglements[h]|1073741824|f&261930}function bc(i,l){var f=i.entangledLanes|=l;for(i=i.entanglements;f;){var h=31-Pn(f),v=1<<h;v&l|i[h]&l&&(i[h]|=l),f&=~v}}function Sc(i,l){var f=l&-l;return f=(f&42)!==0?1:_l(f),(f&(i.suspendedLanes|l))!==0?0:f}function _l(i){switch(i){case 2:i=1;break;case 8:i=4;break;case 32:i=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:i=128;break;case 268435456:i=134217728;break;default:i=0}return i}function Hi(i){return i&=-i,2<i?8<i?(i&134217727)!==0?32:268435456:8:2}function pe(){var i=G.p;return i!==0?i:(i=window.event,i===void 0?32:Mx(i.type))}function Je(i,l){var f=G.p;try{return G.p=i,l()}finally{G.p=f}}var zt=Math.random().toString(36).slice(2),Nt="__reactFiber$"+zt,sn="__reactProps$"+zt,Ie="__reactContainer$"+zt,Ws="__reactEvents$"+zt,gt="__reactListeners$"+zt,Cr="__reactHandles$"+zt,Qa="__reactResources$"+zt,Zs="__reactMarker$"+zt;function ei(i){delete i[Nt],delete i[sn],delete i[Ws],delete i[gt],delete i[Cr]}function Xs(i){var l=i[Nt];if(l)return l;for(var f=i.parentNode;f;){if(l=f[Ie]||f[Nt]){if(f=l.alternate,l.child!==null||f!==null&&f.child!==null)for(i=gx(i);i!==null;){if(f=i[Nt])return f;i=gx(i)}return l}i=f,f=i.parentNode}return null}function Qs(i){if(i=i[Nt]||i[Ie]){var l=i.tag;if(l===5||l===6||l===13||l===31||l===26||l===27||l===3)return i}return null}function ea(i){var l=i.tag;if(l===5||l===26||l===27||l===6)return i.stateNode;throw Error(r(33))}function ta(i){var l=i[Qa];return l||(l=i[Qa]={hoistableStyles:new Map,hoistableScripts:new Map}),l}function Kt(i){i[Zs]=!0}var xc=new Set,Tc={};function Bt(i,l){zi(i,l),zi(i+"Capture",l)}function zi(i,l){for(Tc[i]=l,i=0;i<l.length;i++)xc.add(l[i])}var Vk=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),Xv={},Qv={};function Jk(i){return Nn.call(Qv,i)?!0:Nn.call(Xv,i)?!1:Vk.test(i)?Qv[i]=!0:(Xv[i]=!0,!1)}function Ac(i,l,f){if(Jk(l))if(f===null)i.removeAttribute(l);else{switch(typeof f){case"undefined":case"function":case"symbol":i.removeAttribute(l);return;case"boolean":var h=l.toLowerCase().slice(0,5);if(h!=="data-"&&h!=="aria-"){i.removeAttribute(l);return}}i.setAttribute(l,""+f)}}function Ec(i,l,f){if(f===null)i.removeAttribute(l);else{switch(typeof f){case"undefined":case"function":case"symbol":case"boolean":i.removeAttribute(l);return}i.setAttribute(l,""+f)}}function hs(i,l,f,h){if(h===null)i.removeAttribute(f);else{switch(typeof h){case"undefined":case"function":case"symbol":case"boolean":i.removeAttribute(f);return}i.setAttributeNS(l,f,""+h)}}function cr(i){switch(typeof i){case"bigint":case"boolean":case"number":case"string":case"undefined":return i;case"object":return i;default:return""}}function ew(i){var l=i.type;return(i=i.nodeName)&&i.toLowerCase()==="input"&&(l==="checkbox"||l==="radio")}function Yk(i,l,f){var h=Object.getOwnPropertyDescriptor(i.constructor.prototype,l);if(!i.hasOwnProperty(l)&&typeof h<"u"&&typeof h.get=="function"&&typeof h.set=="function"){var v=h.get,b=h.set;return Object.defineProperty(i,l,{configurable:!0,get:function(){return v.call(this)},set:function(R){f=""+R,b.call(this,R)}}),Object.defineProperty(i,l,{enumerable:h.enumerable}),{getValue:function(){return f},setValue:function(R){f=""+R},stopTracking:function(){i._valueTracker=null,delete i[l]}}}}function Gp(i){if(!i._valueTracker){var l=ew(i)?"checked":"value";i._valueTracker=Yk(i,l,""+i[l])}}function tw(i){if(!i)return!1;var l=i._valueTracker;if(!l)return!0;var f=l.getValue(),h="";return i&&(h=ew(i)?i.checked?"true":"false":i.value),i=h,i!==f?(l.setValue(i),!0):!1}function Cc(i){if(i=i||(typeof document<"u"?document:void 0),typeof i>"u")return null;try{return i.activeElement||i.body}catch{return i.body}}var Kk=/[\n"\\]/g;function dr(i){return i.replace(Kk,function(l){return"\\"+l.charCodeAt(0).toString(16)+" "})}function Hp(i,l,f,h,v,b,R,L){i.name="",R!=null&&typeof R!="function"&&typeof R!="symbol"&&typeof R!="boolean"?i.type=R:i.removeAttribute("type"),l!=null?R==="number"?(l===0&&i.value===""||i.value!=l)&&(i.value=""+cr(l)):i.value!==""+cr(l)&&(i.value=""+cr(l)):R!=="submit"&&R!=="reset"||i.removeAttribute("value"),l!=null?zp(i,R,cr(l)):f!=null?zp(i,R,cr(f)):h!=null&&i.removeAttribute("value"),v==null&&b!=null&&(i.defaultChecked=!!b),v!=null&&(i.checked=v&&typeof v!="function"&&typeof v!="symbol"),L!=null&&typeof L!="function"&&typeof L!="symbol"&&typeof L!="boolean"?i.name=""+cr(L):i.removeAttribute("name")}function nw(i,l,f,h,v,b,R,L){if(b!=null&&typeof b!="function"&&typeof b!="symbol"&&typeof b!="boolean"&&(i.type=b),l!=null||f!=null){if(!(b!=="submit"&&b!=="reset"||l!=null)){Gp(i);return}f=f!=null?""+cr(f):"",l=l!=null?""+cr(l):f,L||l===i.value||(i.value=l),i.defaultValue=l}h=h??v,h=typeof h!="function"&&typeof h!="symbol"&&!!h,i.checked=L?i.checked:!!h,i.defaultChecked=!!h,R!=null&&typeof R!="function"&&typeof R!="symbol"&&typeof R!="boolean"&&(i.name=R),Gp(i)}function zp(i,l,f){l==="number"&&Cc(i.ownerDocument)===i||i.defaultValue===""+f||(i.defaultValue=""+f)}function ji(i,l,f,h){if(i=i.options,l){l={};for(var v=0;v<f.length;v++)l["$"+f[v]]=!0;for(f=0;f<i.length;f++)v=l.hasOwnProperty("$"+i[f].value),i[f].selected!==v&&(i[f].selected=v),v&&h&&(i[f].defaultSelected=!0)}else{for(f=""+cr(f),l=null,v=0;v<i.length;v++){if(i[v].value===f){i[v].selected=!0,h&&(i[v].defaultSelected=!0);return}l!==null||i[v].disabled||(l=i[v])}l!==null&&(l.selected=!0)}}function rw(i,l,f){if(l!=null&&(l=""+cr(l),l!==i.value&&(i.value=l),f==null)){i.defaultValue!==l&&(i.defaultValue=l);return}i.defaultValue=f!=null?""+cr(f):""}function sw(i,l,f,h){if(l==null){if(h!=null){if(f!=null)throw Error(r(92));if(V(h)){if(1<h.length)throw Error(r(93));h=h[0]}f=h}f==null&&(f=""),l=f}f=cr(l),i.defaultValue=f,h=i.textContent,h===f&&h!==""&&h!==null&&(i.value=h),Gp(i)}function Vi(i,l){if(l){var f=i.firstChild;if(f&&f===i.lastChild&&f.nodeType===3){f.nodeValue=l;return}}i.textContent=l}var Wk=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function aw(i,l,f){var h=l.indexOf("--")===0;f==null||typeof f=="boolean"||f===""?h?i.setProperty(l,""):l==="float"?i.cssFloat="":i[l]="":h?i.setProperty(l,f):typeof f!="number"||f===0||Wk.has(l)?l==="float"?i.cssFloat=f:i[l]=(""+f).trim():i[l]=f+"px"}function iw(i,l,f){if(l!=null&&typeof l!="object")throw Error(r(62));if(i=i.style,f!=null){for(var h in f)!f.hasOwnProperty(h)||l!=null&&l.hasOwnProperty(h)||(h.indexOf("--")===0?i.setProperty(h,""):h==="float"?i.cssFloat="":i[h]="");for(var v in l)h=l[v],l.hasOwnProperty(v)&&f[v]!==h&&aw(i,v,h)}else for(var b in l)l.hasOwnProperty(b)&&aw(i,b,l[b])}function jp(i){if(i.indexOf("-")===-1)return!1;switch(i){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Zk=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),Xk=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Ic(i){return Xk.test(""+i)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":i}function ms(){}var Vp=null;function Jp(i){return i=i.target||i.srcElement||window,i.correspondingUseElement&&(i=i.correspondingUseElement),i.nodeType===3?i.parentNode:i}var Ji=null,Yi=null;function ow(i){var l=Qs(i);if(l&&(i=l.stateNode)){var f=i[sn]||null;e:switch(i=l.stateNode,l.type){case"input":if(Hp(i,f.value,f.defaultValue,f.defaultValue,f.checked,f.defaultChecked,f.type,f.name),l=f.name,f.type==="radio"&&l!=null){for(f=i;f.parentNode;)f=f.parentNode;for(f=f.querySelectorAll('input[name="'+dr(""+l)+'"][type="radio"]'),l=0;l<f.length;l++){var h=f[l];if(h!==i&&h.form===i.form){var v=h[sn]||null;if(!v)throw Error(r(90));Hp(h,v.value,v.defaultValue,v.defaultValue,v.checked,v.defaultChecked,v.type,v.name)}}for(l=0;l<f.length;l++)h=f[l],h.form===i.form&&tw(h)}break e;case"textarea":rw(i,f.value,f.defaultValue);break e;case"select":l=f.value,l!=null&&ji(i,!!f.multiple,l,!1)}}}var Yp=!1;function lw(i,l,f){if(Yp)return i(l,f);Yp=!0;try{var h=i(l);return h}finally{if(Yp=!1,(Ji!==null||Yi!==null)&&(md(),Ji&&(l=Ji,i=Yi,Yi=Ji=null,ow(l),i)))for(l=0;l<i.length;l++)ow(i[l])}}function vl(i,l){var f=i.stateNode;if(f===null)return null;var h=f[sn]||null;if(h===null)return null;f=h[l];e:switch(l){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(h=!h.disabled)||(i=i.type,h=!(i==="button"||i==="input"||i==="select"||i==="textarea")),i=!h;break e;default:i=!1}if(i)return null;if(f&&typeof f!="function")throw Error(r(231,l,typeof f));return f}var gs=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Kp=!1;if(gs)try{var wl={};Object.defineProperty(wl,"passive",{get:function(){Kp=!0}}),window.addEventListener("test",wl,wl),window.removeEventListener("test",wl,wl)}catch{Kp=!1}var na=null,Wp=null,Rc=null;function uw(){if(Rc)return Rc;var i,l=Wp,f=l.length,h,v="value"in na?na.value:na.textContent,b=v.length;for(i=0;i<f&&l[i]===v[i];i++);var R=f-i;for(h=1;h<=R&&l[f-h]===v[b-h];h++);return Rc=v.slice(i,1<h?1-h:void 0)}function Nc(i){var l=i.keyCode;return"charCode"in i?(i=i.charCode,i===0&&l===13&&(i=13)):i=l,i===10&&(i=13),32<=i||i===13?i:0}function Pc(){return!0}function cw(){return!1}function Un(i){function l(f,h,v,b,R){this._reactName=f,this._targetInst=v,this.type=h,this.nativeEvent=b,this.target=R,this.currentTarget=null;for(var L in i)i.hasOwnProperty(L)&&(f=i[L],this[L]=f?f(b):b[L]);return this.isDefaultPrevented=(b.defaultPrevented!=null?b.defaultPrevented:b.returnValue===!1)?Pc:cw,this.isPropagationStopped=cw,this}return m(l.prototype,{preventDefault:function(){this.defaultPrevented=!0;var f=this.nativeEvent;f&&(f.preventDefault?f.preventDefault():typeof f.returnValue!="unknown"&&(f.returnValue=!1),this.isDefaultPrevented=Pc)},stopPropagation:function(){var f=this.nativeEvent;f&&(f.stopPropagation?f.stopPropagation():typeof f.cancelBubble!="unknown"&&(f.cancelBubble=!0),this.isPropagationStopped=Pc)},persist:function(){},isPersistent:Pc}),l}var ti={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(i){return i.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Mc=Un(ti),bl=m({},ti,{view:0,detail:0}),Qk=Un(bl),Zp,Xp,Sl,kc=m({},bl,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:eh,button:0,buttons:0,relatedTarget:function(i){return i.relatedTarget===void 0?i.fromElement===i.srcElement?i.toElement:i.fromElement:i.relatedTarget},movementX:function(i){return"movementX"in i?i.movementX:(i!==Sl&&(Sl&&i.type==="mousemove"?(Zp=i.screenX-Sl.screenX,Xp=i.screenY-Sl.screenY):Xp=Zp=0,Sl=i),Zp)},movementY:function(i){return"movementY"in i?i.movementY:Xp}}),dw=Un(kc),eO=m({},kc,{dataTransfer:0}),tO=Un(eO),nO=m({},bl,{relatedTarget:0}),Qp=Un(nO),rO=m({},ti,{animationName:0,elapsedTime:0,pseudoElement:0}),sO=Un(rO),aO=m({},ti,{clipboardData:function(i){return"clipboardData"in i?i.clipboardData:window.clipboardData}}),iO=Un(aO),oO=m({},ti,{data:0}),fw=Un(oO),lO={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},uO={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},cO={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function dO(i){var l=this.nativeEvent;return l.getModifierState?l.getModifierState(i):(i=cO[i])?!!l[i]:!1}function eh(){return dO}var fO=m({},bl,{key:function(i){if(i.key){var l=lO[i.key]||i.key;if(l!=="Unidentified")return l}return i.type==="keypress"?(i=Nc(i),i===13?"Enter":String.fromCharCode(i)):i.type==="keydown"||i.type==="keyup"?uO[i.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:eh,charCode:function(i){return i.type==="keypress"?Nc(i):0},keyCode:function(i){return i.type==="keydown"||i.type==="keyup"?i.keyCode:0},which:function(i){return i.type==="keypress"?Nc(i):i.type==="keydown"||i.type==="keyup"?i.keyCode:0}}),pO=Un(fO),hO=m({},kc,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),pw=Un(hO),mO=m({},bl,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:eh}),gO=Un(mO),yO=m({},ti,{propertyName:0,elapsedTime:0,pseudoElement:0}),_O=Un(yO),vO=m({},kc,{deltaX:function(i){return"deltaX"in i?i.deltaX:"wheelDeltaX"in i?-i.wheelDeltaX:0},deltaY:function(i){return"deltaY"in i?i.deltaY:"wheelDeltaY"in i?-i.wheelDeltaY:"wheelDelta"in i?-i.wheelDelta:0},deltaZ:0,deltaMode:0}),wO=Un(vO),bO=m({},ti,{newState:0,oldState:0}),SO=Un(bO),xO=[9,13,27,32],th=gs&&"CompositionEvent"in window,xl=null;gs&&"documentMode"in document&&(xl=document.documentMode);var TO=gs&&"TextEvent"in window&&!xl,hw=gs&&(!th||xl&&8<xl&&11>=xl),mw=" ",gw=!1;function yw(i,l){switch(i){case"keyup":return xO.indexOf(l.keyCode)!==-1;case"keydown":return l.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function _w(i){return i=i.detail,typeof i=="object"&&"data"in i?i.data:null}var Ki=!1;function AO(i,l){switch(i){case"compositionend":return _w(l);case"keypress":return l.which!==32?null:(gw=!0,mw);case"textInput":return i=l.data,i===mw&&gw?null:i;default:return null}}function EO(i,l){if(Ki)return i==="compositionend"||!th&&yw(i,l)?(i=uw(),Rc=Wp=na=null,Ki=!1,i):null;switch(i){case"paste":return null;case"keypress":if(!(l.ctrlKey||l.altKey||l.metaKey)||l.ctrlKey&&l.altKey){if(l.char&&1<l.char.length)return l.char;if(l.which)return String.fromCharCode(l.which)}return null;case"compositionend":return hw&&l.locale!=="ko"?null:l.data;default:return null}}var CO={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function vw(i){var l=i&&i.nodeName&&i.nodeName.toLowerCase();return l==="input"?!!CO[i.type]:l==="textarea"}function ww(i,l,f,h){Ji?Yi?Yi.push(h):Yi=[h]:Ji=h,l=Sd(l,"onChange"),0<l.length&&(f=new Mc("onChange","change",null,f,h),i.push({event:f,listeners:l}))}var Tl=null,Al=null;function IO(i){nx(i,0)}function Oc(i){var l=ea(i);if(tw(l))return i}function bw(i,l){if(i==="change")return l}var Sw=!1;if(gs){var nh;if(gs){var rh="oninput"in document;if(!rh){var xw=document.createElement("div");xw.setAttribute("oninput","return;"),rh=typeof xw.oninput=="function"}nh=rh}else nh=!1;Sw=nh&&(!document.documentMode||9<document.documentMode)}function Tw(){Tl&&(Tl.detachEvent("onpropertychange",Aw),Al=Tl=null)}function Aw(i){if(i.propertyName==="value"&&Oc(Al)){var l=[];ww(l,Al,i,Jp(i)),lw(IO,l)}}function RO(i,l,f){i==="focusin"?(Tw(),Tl=l,Al=f,Tl.attachEvent("onpropertychange",Aw)):i==="focusout"&&Tw()}function NO(i){if(i==="selectionchange"||i==="keyup"||i==="keydown")return Oc(Al)}function PO(i,l){if(i==="click")return Oc(l)}function MO(i,l){if(i==="input"||i==="change")return Oc(l)}function kO(i,l){return i===l&&(i!==0||1/i===1/l)||i!==i&&l!==l}var Kn=typeof Object.is=="function"?Object.is:kO;function El(i,l){if(Kn(i,l))return!0;if(typeof i!="object"||i===null||typeof l!="object"||l===null)return!1;var f=Object.keys(i),h=Object.keys(l);if(f.length!==h.length)return!1;for(h=0;h<f.length;h++){var v=f[h];if(!Nn.call(l,v)||!Kn(i[v],l[v]))return!1}return!0}function Ew(i){for(;i&&i.firstChild;)i=i.firstChild;return i}function Cw(i,l){var f=Ew(i);i=0;for(var h;f;){if(f.nodeType===3){if(h=i+f.textContent.length,i<=l&&h>=l)return{node:f,offset:l-i};i=h}e:{for(;f;){if(f.nextSibling){f=f.nextSibling;break e}f=f.parentNode}f=void 0}f=Ew(f)}}function Iw(i,l){return i&&l?i===l?!0:i&&i.nodeType===3?!1:l&&l.nodeType===3?Iw(i,l.parentNode):"contains"in i?i.contains(l):i.compareDocumentPosition?!!(i.compareDocumentPosition(l)&16):!1:!1}function Rw(i){i=i!=null&&i.ownerDocument!=null&&i.ownerDocument.defaultView!=null?i.ownerDocument.defaultView:window;for(var l=Cc(i.document);l instanceof i.HTMLIFrameElement;){try{var f=typeof l.contentWindow.location.href=="string"}catch{f=!1}if(f)i=l.contentWindow;else break;l=Cc(i.document)}return l}function sh(i){var l=i&&i.nodeName&&i.nodeName.toLowerCase();return l&&(l==="input"&&(i.type==="text"||i.type==="search"||i.type==="tel"||i.type==="url"||i.type==="password")||l==="textarea"||i.contentEditable==="true")}var OO=gs&&"documentMode"in document&&11>=document.documentMode,Wi=null,ah=null,Cl=null,ih=!1;function Nw(i,l,f){var h=f.window===f?f.document:f.nodeType===9?f:f.ownerDocument;ih||Wi==null||Wi!==Cc(h)||(h=Wi,"selectionStart"in h&&sh(h)?h={start:h.selectionStart,end:h.selectionEnd}:(h=(h.ownerDocument&&h.ownerDocument.defaultView||window).getSelection(),h={anchorNode:h.anchorNode,anchorOffset:h.anchorOffset,focusNode:h.focusNode,focusOffset:h.focusOffset}),Cl&&El(Cl,h)||(Cl=h,h=Sd(ah,"onSelect"),0<h.length&&(l=new Mc("onSelect","select",null,l,f),i.push({event:l,listeners:h}),l.target=Wi)))}function ni(i,l){var f={};return f[i.toLowerCase()]=l.toLowerCase(),f["Webkit"+i]="webkit"+l,f["Moz"+i]="moz"+l,f}var Zi={animationend:ni("Animation","AnimationEnd"),animationiteration:ni("Animation","AnimationIteration"),animationstart:ni("Animation","AnimationStart"),transitionrun:ni("Transition","TransitionRun"),transitionstart:ni("Transition","TransitionStart"),transitioncancel:ni("Transition","TransitionCancel"),transitionend:ni("Transition","TransitionEnd")},oh={},Pw={};gs&&(Pw=document.createElement("div").style,"AnimationEvent"in window||(delete Zi.animationend.animation,delete Zi.animationiteration.animation,delete Zi.animationstart.animation),"TransitionEvent"in window||delete Zi.transitionend.transition);function ri(i){if(oh[i])return oh[i];if(!Zi[i])return i;var l=Zi[i],f;for(f in l)if(l.hasOwnProperty(f)&&f in Pw)return oh[i]=l[f];return i}var Mw=ri("animationend"),kw=ri("animationiteration"),Ow=ri("animationstart"),DO=ri("transitionrun"),LO=ri("transitionstart"),$O=ri("transitioncancel"),Dw=ri("transitionend"),Lw=new Map,lh="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");lh.push("scrollEnd");function Ir(i,l){Lw.set(i,l),Bt(l,[i])}var Dc=typeof reportError=="function"?reportError:function(i){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var l=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof i=="object"&&i!==null&&typeof i.message=="string"?String(i.message):String(i),error:i});if(!window.dispatchEvent(l))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",i);return}console.error(i)},fr=[],Xi=0,uh=0;function Lc(){for(var i=Xi,l=uh=Xi=0;l<i;){var f=fr[l];fr[l++]=null;var h=fr[l];fr[l++]=null;var v=fr[l];fr[l++]=null;var b=fr[l];if(fr[l++]=null,h!==null&&v!==null){var R=h.pending;R===null?v.next=v:(v.next=R.next,R.next=v),h.pending=v}b!==0&&$w(f,v,b)}}function $c(i,l,f,h){fr[Xi++]=i,fr[Xi++]=l,fr[Xi++]=f,fr[Xi++]=h,uh|=h,i.lanes|=h,i=i.alternate,i!==null&&(i.lanes|=h)}function ch(i,l,f,h){return $c(i,l,f,h),Uc(i)}function si(i,l){return $c(i,null,null,l),Uc(i)}function $w(i,l,f){i.lanes|=f;var h=i.alternate;h!==null&&(h.lanes|=f);for(var v=!1,b=i.return;b!==null;)b.childLanes|=f,h=b.alternate,h!==null&&(h.childLanes|=f),b.tag===22&&(i=b.stateNode,i===null||i._visibility&1||(v=!0)),i=b,b=b.return;return i.tag===3?(b=i.stateNode,v&&l!==null&&(v=31-Pn(f),i=b.hiddenUpdates,h=i[v],h===null?i[v]=[l]:h.push(l),l.lane=f|536870912),b):null}function Uc(i){if(50<Kl)throw Kl=0,vm=null,Error(r(185));for(var l=i.return;l!==null;)i=l,l=i.return;return i.tag===3?i.stateNode:null}var Qi={};function UO(i,l,f,h){this.tag=i,this.key=f,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=l,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=h,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Wn(i,l,f,h){return new UO(i,l,f,h)}function dh(i){return i=i.prototype,!(!i||!i.isReactComponent)}function ys(i,l){var f=i.alternate;return f===null?(f=Wn(i.tag,l,i.key,i.mode),f.elementType=i.elementType,f.type=i.type,f.stateNode=i.stateNode,f.alternate=i,i.alternate=f):(f.pendingProps=l,f.type=i.type,f.flags=0,f.subtreeFlags=0,f.deletions=null),f.flags=i.flags&65011712,f.childLanes=i.childLanes,f.lanes=i.lanes,f.child=i.child,f.memoizedProps=i.memoizedProps,f.memoizedState=i.memoizedState,f.updateQueue=i.updateQueue,l=i.dependencies,f.dependencies=l===null?null:{lanes:l.lanes,firstContext:l.firstContext},f.sibling=i.sibling,f.index=i.index,f.ref=i.ref,f.refCleanup=i.refCleanup,f}function Uw(i,l){i.flags&=65011714;var f=i.alternate;return f===null?(i.childLanes=0,i.lanes=l,i.child=null,i.subtreeFlags=0,i.memoizedProps=null,i.memoizedState=null,i.updateQueue=null,i.dependencies=null,i.stateNode=null):(i.childLanes=f.childLanes,i.lanes=f.lanes,i.child=f.child,i.subtreeFlags=0,i.deletions=null,i.memoizedProps=f.memoizedProps,i.memoizedState=f.memoizedState,i.updateQueue=f.updateQueue,i.type=f.type,l=f.dependencies,i.dependencies=l===null?null:{lanes:l.lanes,firstContext:l.firstContext}),i}function Fc(i,l,f,h,v,b){var R=0;if(h=i,typeof i=="function")dh(i)&&(R=1);else if(typeof i=="string")R=HD(i,f,ce.current)?26:i==="html"||i==="head"||i==="body"?27:5;else e:switch(i){case k:return i=Wn(31,f,l,v),i.elementType=k,i.lanes=b,i;case A:return ai(f.children,v,b,l);case E:R=8,v|=24;break;case C:return i=Wn(12,f,l,v|2),i.elementType=C,i.lanes=b,i;case I:return i=Wn(13,f,l,v),i.elementType=I,i.lanes=b,i;case M:return i=Wn(19,f,l,v),i.elementType=M,i.lanes=b,i;default:if(typeof i=="object"&&i!==null)switch(i.$$typeof){case O:R=10;break e;case D:R=9;break e;case T:R=11;break e;case N:R=14;break e;case P:R=16,h=null;break e}R=29,f=Error(r(130,i===null?"null":typeof i,"")),h=null}return l=Wn(R,f,l,v),l.elementType=i,l.type=h,l.lanes=b,l}function ai(i,l,f,h){return i=Wn(7,i,h,l),i.lanes=f,i}function fh(i,l,f){return i=Wn(6,i,null,l),i.lanes=f,i}function Fw(i){var l=Wn(18,null,null,0);return l.stateNode=i,l}function ph(i,l,f){return l=Wn(4,i.children!==null?i.children:[],i.key,l),l.lanes=f,l.stateNode={containerInfo:i.containerInfo,pendingChildren:null,implementation:i.implementation},l}var Bw=new WeakMap;function pr(i,l){if(typeof i=="object"&&i!==null){var f=Bw.get(i);return f!==void 0?f:(l={value:i,source:l,stack:lt(l)},Bw.set(i,l),l)}return{value:i,source:l,stack:lt(l)}}var eo=[],to=0,Bc=null,Il=0,hr=[],mr=0,ra=null,Yr=1,Kr="";function _s(i,l){eo[to++]=Il,eo[to++]=Bc,Bc=i,Il=l}function qw(i,l,f){hr[mr++]=Yr,hr[mr++]=Kr,hr[mr++]=ra,ra=i;var h=Yr;i=Kr;var v=32-Pn(h)-1;h&=~(1<<v),f+=1;var b=32-Pn(l)+v;if(30<b){var R=v-v%5;b=(h&(1<<R)-1).toString(32),h>>=R,v-=R,Yr=1<<32-Pn(l)+v|f<<v|h,Kr=b+i}else Yr=1<<b|f<<v|h,Kr=i}function hh(i){i.return!==null&&(_s(i,1),qw(i,1,0))}function mh(i){for(;i===Bc;)Bc=eo[--to],eo[to]=null,Il=eo[--to],eo[to]=null;for(;i===ra;)ra=hr[--mr],hr[mr]=null,Kr=hr[--mr],hr[mr]=null,Yr=hr[--mr],hr[mr]=null}function Gw(i,l){hr[mr++]=Yr,hr[mr++]=Kr,hr[mr++]=ra,Yr=l.id,Kr=l.overflow,ra=i}var vn=null,Pt=null,ot=!1,sa=null,gr=!1,gh=Error(r(519));function aa(i){var l=Error(r(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw Rl(pr(l,i)),gh}function Hw(i){var l=i.stateNode,f=i.type,h=i.memoizedProps;switch(l[Nt]=i,l[sn]=h,f){case"dialog":st("cancel",l),st("close",l);break;case"iframe":case"object":case"embed":st("load",l);break;case"video":case"audio":for(f=0;f<Zl.length;f++)st(Zl[f],l);break;case"source":st("error",l);break;case"img":case"image":case"link":st("error",l),st("load",l);break;case"details":st("toggle",l);break;case"input":st("invalid",l),nw(l,h.value,h.defaultValue,h.checked,h.defaultChecked,h.type,h.name,!0);break;case"select":st("invalid",l);break;case"textarea":st("invalid",l),sw(l,h.value,h.defaultValue,h.children)}f=h.children,typeof f!="string"&&typeof f!="number"&&typeof f!="bigint"||l.textContent===""+f||h.suppressHydrationWarning===!0||ix(l.textContent,f)?(h.popover!=null&&(st("beforetoggle",l),st("toggle",l)),h.onScroll!=null&&st("scroll",l),h.onScrollEnd!=null&&st("scrollend",l),h.onClick!=null&&(l.onclick=ms),l=!0):l=!1,l||aa(i,!0)}function zw(i){for(vn=i.return;vn;)switch(vn.tag){case 5:case 31:case 13:gr=!1;return;case 27:case 3:gr=!0;return;default:vn=vn.return}}function no(i){if(i!==vn)return!1;if(!ot)return zw(i),ot=!0,!1;var l=i.tag,f;if((f=l!==3&&l!==27)&&((f=l===5)&&(f=i.type,f=!(f!=="form"&&f!=="button")||Om(i.type,i.memoizedProps)),f=!f),f&&Pt&&aa(i),zw(i),l===13){if(i=i.memoizedState,i=i!==null?i.dehydrated:null,!i)throw Error(r(317));Pt=mx(i)}else if(l===31){if(i=i.memoizedState,i=i!==null?i.dehydrated:null,!i)throw Error(r(317));Pt=mx(i)}else l===27?(l=Pt,va(i.type)?(i=Fm,Fm=null,Pt=i):Pt=l):Pt=vn?_r(i.stateNode.nextSibling):null;return!0}function ii(){Pt=vn=null,ot=!1}function yh(){var i=sa;return i!==null&&(Gn===null?Gn=i:Gn.push.apply(Gn,i),sa=null),i}function Rl(i){sa===null?sa=[i]:sa.push(i)}var _h=q(null),oi=null,vs=null;function ia(i,l,f){ee(_h,l._currentValue),l._currentValue=f}function ws(i){i._currentValue=_h.current,W(_h)}function vh(i,l,f){for(;i!==null;){var h=i.alternate;if((i.childLanes&l)!==l?(i.childLanes|=l,h!==null&&(h.childLanes|=l)):h!==null&&(h.childLanes&l)!==l&&(h.childLanes|=l),i===f)break;i=i.return}}function wh(i,l,f,h){var v=i.child;for(v!==null&&(v.return=i);v!==null;){var b=v.dependencies;if(b!==null){var R=v.child;b=b.firstContext;e:for(;b!==null;){var L=b;b=v;for(var H=0;H<l.length;H++)if(L.context===l[H]){b.lanes|=f,L=b.alternate,L!==null&&(L.lanes|=f),vh(b.return,f,i),h||(R=null);break e}b=L.next}}else if(v.tag===18){if(R=v.return,R===null)throw Error(r(341));R.lanes|=f,b=R.alternate,b!==null&&(b.lanes|=f),vh(R,f,i),R=null}else R=v.child;if(R!==null)R.return=v;else for(R=v;R!==null;){if(R===i){R=null;break}if(v=R.sibling,v!==null){v.return=R.return,R=v;break}R=R.return}v=R}}function ro(i,l,f,h){i=null;for(var v=l,b=!1;v!==null;){if(!b){if((v.flags&524288)!==0)b=!0;else if((v.flags&262144)!==0)break}if(v.tag===10){var R=v.alternate;if(R===null)throw Error(r(387));if(R=R.memoizedProps,R!==null){var L=v.type;Kn(v.pendingProps.value,R.value)||(i!==null?i.push(L):i=[L])}}else if(v===Re.current){if(R=v.alternate,R===null)throw Error(r(387));R.memoizedState.memoizedState!==v.memoizedState.memoizedState&&(i!==null?i.push(nu):i=[nu])}v=v.return}i!==null&&wh(l,i,f,h),l.flags|=262144}function qc(i){for(i=i.firstContext;i!==null;){if(!Kn(i.context._currentValue,i.memoizedValue))return!0;i=i.next}return!1}function li(i){oi=i,vs=null,i=i.dependencies,i!==null&&(i.firstContext=null)}function wn(i){return jw(oi,i)}function Gc(i,l){return oi===null&&li(i),jw(i,l)}function jw(i,l){var f=l._currentValue;if(l={context:l,memoizedValue:f,next:null},vs===null){if(i===null)throw Error(r(308));vs=l,i.dependencies={lanes:0,firstContext:l},i.flags|=524288}else vs=vs.next=l;return f}var FO=typeof AbortController<"u"?AbortController:function(){var i=[],l=this.signal={aborted:!1,addEventListener:function(f,h){i.push(h)}};this.abort=function(){l.aborted=!0,i.forEach(function(f){return f()})}},BO=t.unstable_scheduleCallback,qO=t.unstable_NormalPriority,Wt={$$typeof:O,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function bh(){return{controller:new FO,data:new Map,refCount:0}}function Nl(i){i.refCount--,i.refCount===0&&BO(qO,function(){i.controller.abort()})}var Pl=null,Sh=0,so=0,ao=null;function GO(i,l){if(Pl===null){var f=Pl=[];Sh=0,so=Am(),ao={status:"pending",value:void 0,then:function(h){f.push(h)}}}return Sh++,l.then(Vw,Vw),l}function Vw(){if(--Sh===0&&Pl!==null){ao!==null&&(ao.status="fulfilled");var i=Pl;Pl=null,so=0,ao=null;for(var l=0;l<i.length;l++)(0,i[l])()}}function HO(i,l){var f=[],h={status:"pending",value:null,reason:null,then:function(v){f.push(v)}};return i.then(function(){h.status="fulfilled",h.value=l;for(var v=0;v<f.length;v++)(0,f[v])(l)},function(v){for(h.status="rejected",h.reason=v,v=0;v<f.length;v++)(0,f[v])(void 0)}),h}var Jw=B.S;B.S=function(i,l){NS=_e(),typeof l=="object"&&l!==null&&typeof l.then=="function"&&GO(i,l),Jw!==null&&Jw(i,l)};var ui=q(null);function xh(){var i=ui.current;return i!==null?i:It.pooledCache}function Hc(i,l){l===null?ee(ui,ui.current):ee(ui,l.pool)}function Yw(){var i=xh();return i===null?null:{parent:Wt._currentValue,pool:i}}var io=Error(r(460)),Th=Error(r(474)),zc=Error(r(542)),jc={then:function(){}};function Kw(i){return i=i.status,i==="fulfilled"||i==="rejected"}function Ww(i,l,f){switch(f=i[f],f===void 0?i.push(l):f!==l&&(l.then(ms,ms),l=f),l.status){case"fulfilled":return l.value;case"rejected":throw i=l.reason,Xw(i),i;default:if(typeof l.status=="string")l.then(ms,ms);else{if(i=It,i!==null&&100<i.shellSuspendCounter)throw Error(r(482));i=l,i.status="pending",i.then(function(h){if(l.status==="pending"){var v=l;v.status="fulfilled",v.value=h}},function(h){if(l.status==="pending"){var v=l;v.status="rejected",v.reason=h}})}switch(l.status){case"fulfilled":return l.value;case"rejected":throw i=l.reason,Xw(i),i}throw di=l,io}}function ci(i){try{var l=i._init;return l(i._payload)}catch(f){throw f!==null&&typeof f=="object"&&typeof f.then=="function"?(di=f,io):f}}var di=null;function Zw(){if(di===null)throw Error(r(459));var i=di;return di=null,i}function Xw(i){if(i===io||i===zc)throw Error(r(483))}var oo=null,Ml=0;function Vc(i){var l=Ml;return Ml+=1,oo===null&&(oo=[]),Ww(oo,i,l)}function kl(i,l){l=l.props.ref,i.ref=l!==void 0?l:null}function Jc(i,l){throw l.$$typeof===y?Error(r(525)):(i=Object.prototype.toString.call(l),Error(r(31,i==="[object Object]"?"object with keys {"+Object.keys(l).join(", ")+"}":i)))}function Qw(i){function l(Y,J){if(i){var X=Y.deletions;X===null?(Y.deletions=[J],Y.flags|=16):X.push(J)}}function f(Y,J){if(!i)return null;for(;J!==null;)l(Y,J),J=J.sibling;return null}function h(Y){for(var J=new Map;Y!==null;)Y.key!==null?J.set(Y.key,Y):J.set(Y.index,Y),Y=Y.sibling;return J}function v(Y,J){return Y=ys(Y,J),Y.index=0,Y.sibling=null,Y}function b(Y,J,X){return Y.index=X,i?(X=Y.alternate,X!==null?(X=X.index,X<J?(Y.flags|=67108866,J):X):(Y.flags|=67108866,J)):(Y.flags|=1048576,J)}function R(Y){return i&&Y.alternate===null&&(Y.flags|=67108866),Y}function L(Y,J,X,oe){return J===null||J.tag!==6?(J=fh(X,Y.mode,oe),J.return=Y,J):(J=v(J,X),J.return=Y,J)}function H(Y,J,X,oe){var Ue=X.type;return Ue===A?ae(Y,J,X.props.children,oe,X.key):J!==null&&(J.elementType===Ue||typeof Ue=="object"&&Ue!==null&&Ue.$$typeof===P&&ci(Ue)===J.type)?(J=v(J,X.props),kl(J,X),J.return=Y,J):(J=Fc(X.type,X.key,X.props,null,Y.mode,oe),kl(J,X),J.return=Y,J)}function Q(Y,J,X,oe){return J===null||J.tag!==4||J.stateNode.containerInfo!==X.containerInfo||J.stateNode.implementation!==X.implementation?(J=ph(X,Y.mode,oe),J.return=Y,J):(J=v(J,X.children||[]),J.return=Y,J)}function ae(Y,J,X,oe,Ue){return J===null||J.tag!==7?(J=ai(X,Y.mode,oe,Ue),J.return=Y,J):(J=v(J,X),J.return=Y,J)}function ue(Y,J,X){if(typeof J=="string"&&J!==""||typeof J=="number"||typeof J=="bigint")return J=fh(""+J,Y.mode,X),J.return=Y,J;if(typeof J=="object"&&J!==null){switch(J.$$typeof){case w:return X=Fc(J.type,J.key,J.props,null,Y.mode,X),kl(X,J),X.return=Y,X;case x:return J=ph(J,Y.mode,X),J.return=Y,J;case P:return J=ci(J),ue(Y,J,X)}if(V(J)||F(J))return J=ai(J,Y.mode,X,null),J.return=Y,J;if(typeof J.then=="function")return ue(Y,Vc(J),X);if(J.$$typeof===O)return ue(Y,Gc(Y,J),X);Jc(Y,J)}return null}function ne(Y,J,X,oe){var Ue=J!==null?J.key:null;if(typeof X=="string"&&X!==""||typeof X=="number"||typeof X=="bigint")return Ue!==null?null:L(Y,J,""+X,oe);if(typeof X=="object"&&X!==null){switch(X.$$typeof){case w:return X.key===Ue?H(Y,J,X,oe):null;case x:return X.key===Ue?Q(Y,J,X,oe):null;case P:return X=ci(X),ne(Y,J,X,oe)}if(V(X)||F(X))return Ue!==null?null:ae(Y,J,X,oe,null);if(typeof X.then=="function")return ne(Y,J,Vc(X),oe);if(X.$$typeof===O)return ne(Y,J,Gc(Y,X),oe);Jc(Y,X)}return null}function re(Y,J,X,oe,Ue){if(typeof oe=="string"&&oe!==""||typeof oe=="number"||typeof oe=="bigint")return Y=Y.get(X)||null,L(J,Y,""+oe,Ue);if(typeof oe=="object"&&oe!==null){switch(oe.$$typeof){case w:return Y=Y.get(oe.key===null?X:oe.key)||null,H(J,Y,oe,Ue);case x:return Y=Y.get(oe.key===null?X:oe.key)||null,Q(J,Y,oe,Ue);case P:return oe=ci(oe),re(Y,J,X,oe,Ue)}if(V(oe)||F(oe))return Y=Y.get(X)||null,ae(J,Y,oe,Ue,null);if(typeof oe.then=="function")return re(Y,J,X,Vc(oe),Ue);if(oe.$$typeof===O)return re(Y,J,X,Gc(J,oe),Ue);Jc(J,oe)}return null}function xe(Y,J,X,oe){for(var Ue=null,dt=null,Pe=J,et=J=0,it=null;Pe!==null&&et<X.length;et++){Pe.index>et?(it=Pe,Pe=null):it=Pe.sibling;var ft=ne(Y,Pe,X[et],oe);if(ft===null){Pe===null&&(Pe=it);break}i&&Pe&&ft.alternate===null&&l(Y,Pe),J=b(ft,J,et),dt===null?Ue=ft:dt.sibling=ft,dt=ft,Pe=it}if(et===X.length)return f(Y,Pe),ot&&_s(Y,et),Ue;if(Pe===null){for(;et<X.length;et++)Pe=ue(Y,X[et],oe),Pe!==null&&(J=b(Pe,J,et),dt===null?Ue=Pe:dt.sibling=Pe,dt=Pe);return ot&&_s(Y,et),Ue}for(Pe=h(Pe);et<X.length;et++)it=re(Pe,Y,et,X[et],oe),it!==null&&(i&&it.alternate!==null&&Pe.delete(it.key===null?et:it.key),J=b(it,J,et),dt===null?Ue=it:dt.sibling=it,dt=it);return i&&Pe.forEach(function(Ta){return l(Y,Ta)}),ot&&_s(Y,et),Ue}function qe(Y,J,X,oe){if(X==null)throw Error(r(151));for(var Ue=null,dt=null,Pe=J,et=J=0,it=null,ft=X.next();Pe!==null&&!ft.done;et++,ft=X.next()){Pe.index>et?(it=Pe,Pe=null):it=Pe.sibling;var Ta=ne(Y,Pe,ft.value,oe);if(Ta===null){Pe===null&&(Pe=it);break}i&&Pe&&Ta.alternate===null&&l(Y,Pe),J=b(Ta,J,et),dt===null?Ue=Ta:dt.sibling=Ta,dt=Ta,Pe=it}if(ft.done)return f(Y,Pe),ot&&_s(Y,et),Ue;if(Pe===null){for(;!ft.done;et++,ft=X.next())ft=ue(Y,ft.value,oe),ft!==null&&(J=b(ft,J,et),dt===null?Ue=ft:dt.sibling=ft,dt=ft);return ot&&_s(Y,et),Ue}for(Pe=h(Pe);!ft.done;et++,ft=X.next())ft=re(Pe,Y,et,ft.value,oe),ft!==null&&(i&&ft.alternate!==null&&Pe.delete(ft.key===null?et:ft.key),J=b(ft,J,et),dt===null?Ue=ft:dt.sibling=ft,dt=ft);return i&&Pe.forEach(function(eL){return l(Y,eL)}),ot&&_s(Y,et),Ue}function Tt(Y,J,X,oe){if(typeof X=="object"&&X!==null&&X.type===A&&X.key===null&&(X=X.props.children),typeof X=="object"&&X!==null){switch(X.$$typeof){case w:e:{for(var Ue=X.key;J!==null;){if(J.key===Ue){if(Ue=X.type,Ue===A){if(J.tag===7){f(Y,J.sibling),oe=v(J,X.props.children),oe.return=Y,Y=oe;break e}}else if(J.elementType===Ue||typeof Ue=="object"&&Ue!==null&&Ue.$$typeof===P&&ci(Ue)===J.type){f(Y,J.sibling),oe=v(J,X.props),kl(oe,X),oe.return=Y,Y=oe;break e}f(Y,J);break}else l(Y,J);J=J.sibling}X.type===A?(oe=ai(X.props.children,Y.mode,oe,X.key),oe.return=Y,Y=oe):(oe=Fc(X.type,X.key,X.props,null,Y.mode,oe),kl(oe,X),oe.return=Y,Y=oe)}return R(Y);case x:e:{for(Ue=X.key;J!==null;){if(J.key===Ue)if(J.tag===4&&J.stateNode.containerInfo===X.containerInfo&&J.stateNode.implementation===X.implementation){f(Y,J.sibling),oe=v(J,X.children||[]),oe.return=Y,Y=oe;break e}else{f(Y,J);break}else l(Y,J);J=J.sibling}oe=ph(X,Y.mode,oe),oe.return=Y,Y=oe}return R(Y);case P:return X=ci(X),Tt(Y,J,X,oe)}if(V(X))return xe(Y,J,X,oe);if(F(X)){if(Ue=F(X),typeof Ue!="function")throw Error(r(150));return X=Ue.call(X),qe(Y,J,X,oe)}if(typeof X.then=="function")return Tt(Y,J,Vc(X),oe);if(X.$$typeof===O)return Tt(Y,J,Gc(Y,X),oe);Jc(Y,X)}return typeof X=="string"&&X!==""||typeof X=="number"||typeof X=="bigint"?(X=""+X,J!==null&&J.tag===6?(f(Y,J.sibling),oe=v(J,X),oe.return=Y,Y=oe):(f(Y,J),oe=fh(X,Y.mode,oe),oe.return=Y,Y=oe),R(Y)):f(Y,J)}return function(Y,J,X,oe){try{Ml=0;var Ue=Tt(Y,J,X,oe);return oo=null,Ue}catch(Pe){if(Pe===io||Pe===zc)throw Pe;var dt=Wn(29,Pe,null,Y.mode);return dt.lanes=oe,dt.return=Y,dt}finally{}}}var fi=Qw(!0),eb=Qw(!1),oa=!1;function Ah(i){i.updateQueue={baseState:i.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function Eh(i,l){i=i.updateQueue,l.updateQueue===i&&(l.updateQueue={baseState:i.baseState,firstBaseUpdate:i.firstBaseUpdate,lastBaseUpdate:i.lastBaseUpdate,shared:i.shared,callbacks:null})}function la(i){return{lane:i,tag:0,payload:null,callback:null,next:null}}function ua(i,l,f){var h=i.updateQueue;if(h===null)return null;if(h=h.shared,(mt&2)!==0){var v=h.pending;return v===null?l.next=l:(l.next=v.next,v.next=l),h.pending=l,l=Uc(i),$w(i,null,f),l}return $c(i,h,l,f),Uc(i)}function Ol(i,l,f){if(l=l.updateQueue,l!==null&&(l=l.shared,(f&4194048)!==0)){var h=l.lanes;h&=i.pendingLanes,f|=h,l.lanes=f,bc(i,f)}}function Ch(i,l){var f=i.updateQueue,h=i.alternate;if(h!==null&&(h=h.updateQueue,f===h)){var v=null,b=null;if(f=f.firstBaseUpdate,f!==null){do{var R={lane:f.lane,tag:f.tag,payload:f.payload,callback:null,next:null};b===null?v=b=R:b=b.next=R,f=f.next}while(f!==null);b===null?v=b=l:b=b.next=l}else v=b=l;f={baseState:h.baseState,firstBaseUpdate:v,lastBaseUpdate:b,shared:h.shared,callbacks:h.callbacks},i.updateQueue=f;return}i=f.lastBaseUpdate,i===null?f.firstBaseUpdate=l:i.next=l,f.lastBaseUpdate=l}var Ih=!1;function Dl(){if(Ih){var i=ao;if(i!==null)throw i}}function Ll(i,l,f,h){Ih=!1;var v=i.updateQueue;oa=!1;var b=v.firstBaseUpdate,R=v.lastBaseUpdate,L=v.shared.pending;if(L!==null){v.shared.pending=null;var H=L,Q=H.next;H.next=null,R===null?b=Q:R.next=Q,R=H;var ae=i.alternate;ae!==null&&(ae=ae.updateQueue,L=ae.lastBaseUpdate,L!==R&&(L===null?ae.firstBaseUpdate=Q:L.next=Q,ae.lastBaseUpdate=H))}if(b!==null){var ue=v.baseState;R=0,ae=Q=H=null,L=b;do{var ne=L.lane&-536870913,re=ne!==L.lane;if(re?(at&ne)===ne:(h&ne)===ne){ne!==0&&ne===so&&(Ih=!0),ae!==null&&(ae=ae.next={lane:0,tag:L.tag,payload:L.payload,callback:null,next:null});e:{var xe=i,qe=L;ne=l;var Tt=f;switch(qe.tag){case 1:if(xe=qe.payload,typeof xe=="function"){ue=xe.call(Tt,ue,ne);break e}ue=xe;break e;case 3:xe.flags=xe.flags&-65537|128;case 0:if(xe=qe.payload,ne=typeof xe=="function"?xe.call(Tt,ue,ne):xe,ne==null)break e;ue=m({},ue,ne);break e;case 2:oa=!0}}ne=L.callback,ne!==null&&(i.flags|=64,re&&(i.flags|=8192),re=v.callbacks,re===null?v.callbacks=[ne]:re.push(ne))}else re={lane:ne,tag:L.tag,payload:L.payload,callback:L.callback,next:null},ae===null?(Q=ae=re,H=ue):ae=ae.next=re,R|=ne;if(L=L.next,L===null){if(L=v.shared.pending,L===null)break;re=L,L=re.next,re.next=null,v.lastBaseUpdate=re,v.shared.pending=null}}while(!0);ae===null&&(H=ue),v.baseState=H,v.firstBaseUpdate=Q,v.lastBaseUpdate=ae,b===null&&(v.shared.lanes=0),ha|=R,i.lanes=R,i.memoizedState=ue}}function tb(i,l){if(typeof i!="function")throw Error(r(191,i));i.call(l)}function nb(i,l){var f=i.callbacks;if(f!==null)for(i.callbacks=null,i=0;i<f.length;i++)tb(f[i],l)}var lo=q(null),Yc=q(0);function rb(i,l){i=Rs,ee(Yc,i),ee(lo,l),Rs=i|l.baseLanes}function Rh(){ee(Yc,Rs),ee(lo,lo.current)}function Nh(){Rs=Yc.current,W(lo),W(Yc)}var Zn=q(null),yr=null;function ca(i){var l=i.alternate;ee(jt,jt.current&1),ee(Zn,i),yr===null&&(l===null||lo.current!==null||l.memoizedState!==null)&&(yr=i)}function Ph(i){ee(jt,jt.current),ee(Zn,i),yr===null&&(yr=i)}function sb(i){i.tag===22?(ee(jt,jt.current),ee(Zn,i),yr===null&&(yr=i)):da()}function da(){ee(jt,jt.current),ee(Zn,Zn.current)}function Xn(i){W(Zn),yr===i&&(yr=null),W(jt)}var jt=q(0);function Kc(i){for(var l=i;l!==null;){if(l.tag===13){var f=l.memoizedState;if(f!==null&&(f=f.dehydrated,f===null||$m(f)||Um(f)))return l}else if(l.tag===19&&(l.memoizedProps.revealOrder==="forwards"||l.memoizedProps.revealOrder==="backwards"||l.memoizedProps.revealOrder==="unstable_legacy-backwards"||l.memoizedProps.revealOrder==="together")){if((l.flags&128)!==0)return l}else if(l.child!==null){l.child.return=l,l=l.child;continue}if(l===i)break;for(;l.sibling===null;){if(l.return===null||l.return===i)return null;l=l.return}l.sibling.return=l.return,l=l.sibling}return null}var bs=0,Qe=null,St=null,Zt=null,Wc=!1,uo=!1,pi=!1,Zc=0,$l=0,co=null,zO=0;function qt(){throw Error(r(321))}function Mh(i,l){if(l===null)return!1;for(var f=0;f<l.length&&f<i.length;f++)if(!Kn(i[f],l[f]))return!1;return!0}function kh(i,l,f,h,v,b){return bs=b,Qe=l,l.memoizedState=null,l.updateQueue=null,l.lanes=0,B.H=i===null||i.memoizedState===null?qb:Yh,pi=!1,b=f(h,v),pi=!1,uo&&(b=ib(l,f,h,v)),ab(i),b}function ab(i){B.H=Bl;var l=St!==null&&St.next!==null;if(bs=0,Zt=St=Qe=null,Wc=!1,$l=0,co=null,l)throw Error(r(300));i===null||Xt||(i=i.dependencies,i!==null&&qc(i)&&(Xt=!0))}function ib(i,l,f,h){Qe=i;var v=0;do{if(uo&&(co=null),$l=0,uo=!1,25<=v)throw Error(r(301));if(v+=1,Zt=St=null,i.updateQueue!=null){var b=i.updateQueue;b.lastEffect=null,b.events=null,b.stores=null,b.memoCache!=null&&(b.memoCache.index=0)}B.H=Gb,b=l(f,h)}while(uo);return b}function jO(){var i=B.H,l=i.useState()[0];return l=typeof l.then=="function"?Ul(l):l,i=i.useState()[0],(St!==null?St.memoizedState:null)!==i&&(Qe.flags|=1024),l}function Oh(){var i=Zc!==0;return Zc=0,i}function Dh(i,l,f){l.updateQueue=i.updateQueue,l.flags&=-2053,i.lanes&=~f}function Lh(i){if(Wc){for(i=i.memoizedState;i!==null;){var l=i.queue;l!==null&&(l.pending=null),i=i.next}Wc=!1}bs=0,Zt=St=Qe=null,uo=!1,$l=Zc=0,co=null}function Mn(){var i={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Zt===null?Qe.memoizedState=Zt=i:Zt=Zt.next=i,Zt}function Vt(){if(St===null){var i=Qe.alternate;i=i!==null?i.memoizedState:null}else i=St.next;var l=Zt===null?Qe.memoizedState:Zt.next;if(l!==null)Zt=l,St=i;else{if(i===null)throw Qe.alternate===null?Error(r(467)):Error(r(310));St=i,i={memoizedState:St.memoizedState,baseState:St.baseState,baseQueue:St.baseQueue,queue:St.queue,next:null},Zt===null?Qe.memoizedState=Zt=i:Zt=Zt.next=i}return Zt}function Xc(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Ul(i){var l=$l;return $l+=1,co===null&&(co=[]),i=Ww(co,i,l),l=Qe,(Zt===null?l.memoizedState:Zt.next)===null&&(l=l.alternate,B.H=l===null||l.memoizedState===null?qb:Yh),i}function Qc(i){if(i!==null&&typeof i=="object"){if(typeof i.then=="function")return Ul(i);if(i.$$typeof===O)return wn(i)}throw Error(r(438,String(i)))}function $h(i){var l=null,f=Qe.updateQueue;if(f!==null&&(l=f.memoCache),l==null){var h=Qe.alternate;h!==null&&(h=h.updateQueue,h!==null&&(h=h.memoCache,h!=null&&(l={data:h.data.map(function(v){return v.slice()}),index:0})))}if(l==null&&(l={data:[],index:0}),f===null&&(f=Xc(),Qe.updateQueue=f),f.memoCache=l,f=l.data[l.index],f===void 0)for(f=l.data[l.index]=Array(i),h=0;h<i;h++)f[h]=$;return l.index++,f}function Ss(i,l){return typeof l=="function"?l(i):l}function ed(i){var l=Vt();return Uh(l,St,i)}function Uh(i,l,f){var h=i.queue;if(h===null)throw Error(r(311));h.lastRenderedReducer=f;var v=i.baseQueue,b=h.pending;if(b!==null){if(v!==null){var R=v.next;v.next=b.next,b.next=R}l.baseQueue=v=b,h.pending=null}if(b=i.baseState,v===null)i.memoizedState=b;else{l=v.next;var L=R=null,H=null,Q=l,ae=!1;do{var ue=Q.lane&-536870913;if(ue!==Q.lane?(at&ue)===ue:(bs&ue)===ue){var ne=Q.revertLane;if(ne===0)H!==null&&(H=H.next={lane:0,revertLane:0,gesture:null,action:Q.action,hasEagerState:Q.hasEagerState,eagerState:Q.eagerState,next:null}),ue===so&&(ae=!0);else if((bs&ne)===ne){Q=Q.next,ne===so&&(ae=!0);continue}else ue={lane:0,revertLane:Q.revertLane,gesture:null,action:Q.action,hasEagerState:Q.hasEagerState,eagerState:Q.eagerState,next:null},H===null?(L=H=ue,R=b):H=H.next=ue,Qe.lanes|=ne,ha|=ne;ue=Q.action,pi&&f(b,ue),b=Q.hasEagerState?Q.eagerState:f(b,ue)}else ne={lane:ue,revertLane:Q.revertLane,gesture:Q.gesture,action:Q.action,hasEagerState:Q.hasEagerState,eagerState:Q.eagerState,next:null},H===null?(L=H=ne,R=b):H=H.next=ne,Qe.lanes|=ue,ha|=ue;Q=Q.next}while(Q!==null&&Q!==l);if(H===null?R=b:H.next=L,!Kn(b,i.memoizedState)&&(Xt=!0,ae&&(f=ao,f!==null)))throw f;i.memoizedState=b,i.baseState=R,i.baseQueue=H,h.lastRenderedState=b}return v===null&&(h.lanes=0),[i.memoizedState,h.dispatch]}function Fh(i){var l=Vt(),f=l.queue;if(f===null)throw Error(r(311));f.lastRenderedReducer=i;var h=f.dispatch,v=f.pending,b=l.memoizedState;if(v!==null){f.pending=null;var R=v=v.next;do b=i(b,R.action),R=R.next;while(R!==v);Kn(b,l.memoizedState)||(Xt=!0),l.memoizedState=b,l.baseQueue===null&&(l.baseState=b),f.lastRenderedState=b}return[b,h]}function ob(i,l,f){var h=Qe,v=Vt(),b=ot;if(b){if(f===void 0)throw Error(r(407));f=f()}else f=l();var R=!Kn((St||v).memoizedState,f);if(R&&(v.memoizedState=f,Xt=!0),v=v.queue,Gh(cb.bind(null,h,v,i),[i]),v.getSnapshot!==l||R||Zt!==null&&Zt.memoizedState.tag&1){if(h.flags|=2048,fo(9,{destroy:void 0},ub.bind(null,h,v,f,l),null),It===null)throw Error(r(349));b||(bs&127)!==0||lb(h,l,f)}return f}function lb(i,l,f){i.flags|=16384,i={getSnapshot:l,value:f},l=Qe.updateQueue,l===null?(l=Xc(),Qe.updateQueue=l,l.stores=[i]):(f=l.stores,f===null?l.stores=[i]:f.push(i))}function ub(i,l,f,h){l.value=f,l.getSnapshot=h,db(l)&&fb(i)}function cb(i,l,f){return f(function(){db(l)&&fb(i)})}function db(i){var l=i.getSnapshot;i=i.value;try{var f=l();return!Kn(i,f)}catch{return!0}}function fb(i){var l=si(i,2);l!==null&&Hn(l,i,2)}function Bh(i){var l=Mn();if(typeof i=="function"){var f=i;if(i=f(),pi){Jr(!0);try{f()}finally{Jr(!1)}}}return l.memoizedState=l.baseState=i,l.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Ss,lastRenderedState:i},l}function pb(i,l,f,h){return i.baseState=f,Uh(i,St,typeof h=="function"?h:Ss)}function VO(i,l,f,h,v){if(rd(i))throw Error(r(485));if(i=l.action,i!==null){var b={payload:v,action:i,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(R){b.listeners.push(R)}};B.T!==null?f(!0):b.isTransition=!1,h(b),f=l.pending,f===null?(b.next=l.pending=b,hb(l,b)):(b.next=f.next,l.pending=f.next=b)}}function hb(i,l){var f=l.action,h=l.payload,v=i.state;if(l.isTransition){var b=B.T,R={};B.T=R;try{var L=f(v,h),H=B.S;H!==null&&H(R,L),mb(i,l,L)}catch(Q){qh(i,l,Q)}finally{b!==null&&R.types!==null&&(b.types=R.types),B.T=b}}else try{b=f(v,h),mb(i,l,b)}catch(Q){qh(i,l,Q)}}function mb(i,l,f){f!==null&&typeof f=="object"&&typeof f.then=="function"?f.then(function(h){gb(i,l,h)},function(h){return qh(i,l,h)}):gb(i,l,f)}function gb(i,l,f){l.status="fulfilled",l.value=f,yb(l),i.state=f,l=i.pending,l!==null&&(f=l.next,f===l?i.pending=null:(f=f.next,l.next=f,hb(i,f)))}function qh(i,l,f){var h=i.pending;if(i.pending=null,h!==null){h=h.next;do l.status="rejected",l.reason=f,yb(l),l=l.next;while(l!==h)}i.action=null}function yb(i){i=i.listeners;for(var l=0;l<i.length;l++)(0,i[l])()}function _b(i,l){return l}function vb(i,l){if(ot){var f=It.formState;if(f!==null){e:{var h=Qe;if(ot){if(Pt){t:{for(var v=Pt,b=gr;v.nodeType!==8;){if(!b){v=null;break t}if(v=_r(v.nextSibling),v===null){v=null;break t}}b=v.data,v=b==="F!"||b==="F"?v:null}if(v){Pt=_r(v.nextSibling),h=v.data==="F!";break e}}aa(h)}h=!1}h&&(l=f[0])}}return f=Mn(),f.memoizedState=f.baseState=l,h={pending:null,lanes:0,dispatch:null,lastRenderedReducer:_b,lastRenderedState:l},f.queue=h,f=Ub.bind(null,Qe,h),h.dispatch=f,h=Bh(!1),b=Jh.bind(null,Qe,!1,h.queue),h=Mn(),v={state:l,dispatch:null,action:i,pending:null},h.queue=v,f=VO.bind(null,Qe,v,b,f),v.dispatch=f,h.memoizedState=i,[l,f,!1]}function wb(i){var l=Vt();return bb(l,St,i)}function bb(i,l,f){if(l=Uh(i,l,_b)[0],i=ed(Ss)[0],typeof l=="object"&&l!==null&&typeof l.then=="function")try{var h=Ul(l)}catch(R){throw R===io?zc:R}else h=l;l=Vt();var v=l.queue,b=v.dispatch;return f!==l.memoizedState&&(Qe.flags|=2048,fo(9,{destroy:void 0},JO.bind(null,v,f),null)),[h,b,i]}function JO(i,l){i.action=l}function Sb(i){var l=Vt(),f=St;if(f!==null)return bb(l,f,i);Vt(),l=l.memoizedState,f=Vt();var h=f.queue.dispatch;return f.memoizedState=i,[l,h,!1]}function fo(i,l,f,h){return i={tag:i,create:f,deps:h,inst:l,next:null},l=Qe.updateQueue,l===null&&(l=Xc(),Qe.updateQueue=l),f=l.lastEffect,f===null?l.lastEffect=i.next=i:(h=f.next,f.next=i,i.next=h,l.lastEffect=i),i}function xb(){return Vt().memoizedState}function td(i,l,f,h){var v=Mn();Qe.flags|=i,v.memoizedState=fo(1|l,{destroy:void 0},f,h===void 0?null:h)}function nd(i,l,f,h){var v=Vt();h=h===void 0?null:h;var b=v.memoizedState.inst;St!==null&&h!==null&&Mh(h,St.memoizedState.deps)?v.memoizedState=fo(l,b,f,h):(Qe.flags|=i,v.memoizedState=fo(1|l,b,f,h))}function Tb(i,l){td(8390656,8,i,l)}function Gh(i,l){nd(2048,8,i,l)}function YO(i){Qe.flags|=4;var l=Qe.updateQueue;if(l===null)l=Xc(),Qe.updateQueue=l,l.events=[i];else{var f=l.events;f===null?l.events=[i]:f.push(i)}}function Ab(i){var l=Vt().memoizedState;return YO({ref:l,nextImpl:i}),function(){if((mt&2)!==0)throw Error(r(440));return l.impl.apply(void 0,arguments)}}function Eb(i,l){return nd(4,2,i,l)}function Cb(i,l){return nd(4,4,i,l)}function Ib(i,l){if(typeof l=="function"){i=i();var f=l(i);return function(){typeof f=="function"?f():l(null)}}if(l!=null)return i=i(),l.current=i,function(){l.current=null}}function Rb(i,l,f){f=f!=null?f.concat([i]):null,nd(4,4,Ib.bind(null,l,i),f)}function Hh(){}function Nb(i,l){var f=Vt();l=l===void 0?null:l;var h=f.memoizedState;return l!==null&&Mh(l,h[1])?h[0]:(f.memoizedState=[i,l],i)}function Pb(i,l){var f=Vt();l=l===void 0?null:l;var h=f.memoizedState;if(l!==null&&Mh(l,h[1]))return h[0];if(h=i(),pi){Jr(!0);try{i()}finally{Jr(!1)}}return f.memoizedState=[h,l],h}function zh(i,l,f){return f===void 0||(bs&1073741824)!==0&&(at&261930)===0?i.memoizedState=l:(i.memoizedState=f,i=MS(),Qe.lanes|=i,ha|=i,f)}function Mb(i,l,f,h){return Kn(f,l)?f:lo.current!==null?(i=zh(i,f,h),Kn(i,l)||(Xt=!0),i):(bs&42)===0||(bs&1073741824)!==0&&(at&261930)===0?(Xt=!0,i.memoizedState=f):(i=MS(),Qe.lanes|=i,ha|=i,l)}function kb(i,l,f,h,v){var b=G.p;G.p=b!==0&&8>b?b:8;var R=B.T,L={};B.T=L,Jh(i,!1,l,f);try{var H=v(),Q=B.S;if(Q!==null&&Q(L,H),H!==null&&typeof H=="object"&&typeof H.then=="function"){var ae=HO(H,h);Fl(i,l,ae,tr(i))}else Fl(i,l,h,tr(i))}catch(ue){Fl(i,l,{then:function(){},status:"rejected",reason:ue},tr())}finally{G.p=b,R!==null&&L.types!==null&&(R.types=L.types),B.T=R}}function KO(){}function jh(i,l,f,h){if(i.tag!==5)throw Error(r(476));var v=Ob(i).queue;kb(i,v,l,Z,f===null?KO:function(){return Db(i),f(h)})}function Ob(i){var l=i.memoizedState;if(l!==null)return l;l={memoizedState:Z,baseState:Z,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Ss,lastRenderedState:Z},next:null};var f={};return l.next={memoizedState:f,baseState:f,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Ss,lastRenderedState:f},next:null},i.memoizedState=l,i=i.alternate,i!==null&&(i.memoizedState=l),l}function Db(i){var l=Ob(i);l.next===null&&(l=i.alternate.memoizedState),Fl(i,l.next.queue,{},tr())}function Vh(){return wn(nu)}function Lb(){return Vt().memoizedState}function $b(){return Vt().memoizedState}function WO(i){for(var l=i.return;l!==null;){switch(l.tag){case 24:case 3:var f=tr();i=la(f);var h=ua(l,i,f);h!==null&&(Hn(h,l,f),Ol(h,l,f)),l={cache:bh()},i.payload=l;return}l=l.return}}function ZO(i,l,f){var h=tr();f={lane:h,revertLane:0,gesture:null,action:f,hasEagerState:!1,eagerState:null,next:null},rd(i)?Fb(l,f):(f=ch(i,l,f,h),f!==null&&(Hn(f,i,h),Bb(f,l,h)))}function Ub(i,l,f){var h=tr();Fl(i,l,f,h)}function Fl(i,l,f,h){var v={lane:h,revertLane:0,gesture:null,action:f,hasEagerState:!1,eagerState:null,next:null};if(rd(i))Fb(l,v);else{var b=i.alternate;if(i.lanes===0&&(b===null||b.lanes===0)&&(b=l.lastRenderedReducer,b!==null))try{var R=l.lastRenderedState,L=b(R,f);if(v.hasEagerState=!0,v.eagerState=L,Kn(L,R))return $c(i,l,v,0),It===null&&Lc(),!1}catch{}finally{}if(f=ch(i,l,v,h),f!==null)return Hn(f,i,h),Bb(f,l,h),!0}return!1}function Jh(i,l,f,h){if(h={lane:2,revertLane:Am(),gesture:null,action:h,hasEagerState:!1,eagerState:null,next:null},rd(i)){if(l)throw Error(r(479))}else l=ch(i,f,h,2),l!==null&&Hn(l,i,2)}function rd(i){var l=i.alternate;return i===Qe||l!==null&&l===Qe}function Fb(i,l){uo=Wc=!0;var f=i.pending;f===null?l.next=l:(l.next=f.next,f.next=l),i.pending=l}function Bb(i,l,f){if((f&4194048)!==0){var h=l.lanes;h&=i.pendingLanes,f|=h,l.lanes=f,bc(i,f)}}var Bl={readContext:wn,use:Qc,useCallback:qt,useContext:qt,useEffect:qt,useImperativeHandle:qt,useLayoutEffect:qt,useInsertionEffect:qt,useMemo:qt,useReducer:qt,useRef:qt,useState:qt,useDebugValue:qt,useDeferredValue:qt,useTransition:qt,useSyncExternalStore:qt,useId:qt,useHostTransitionStatus:qt,useFormState:qt,useActionState:qt,useOptimistic:qt,useMemoCache:qt,useCacheRefresh:qt};Bl.useEffectEvent=qt;var qb={readContext:wn,use:Qc,useCallback:function(i,l){return Mn().memoizedState=[i,l===void 0?null:l],i},useContext:wn,useEffect:Tb,useImperativeHandle:function(i,l,f){f=f!=null?f.concat([i]):null,td(4194308,4,Ib.bind(null,l,i),f)},useLayoutEffect:function(i,l){return td(4194308,4,i,l)},useInsertionEffect:function(i,l){td(4,2,i,l)},useMemo:function(i,l){var f=Mn();l=l===void 0?null:l;var h=i();if(pi){Jr(!0);try{i()}finally{Jr(!1)}}return f.memoizedState=[h,l],h},useReducer:function(i,l,f){var h=Mn();if(f!==void 0){var v=f(l);if(pi){Jr(!0);try{f(l)}finally{Jr(!1)}}}else v=l;return h.memoizedState=h.baseState=v,i={pending:null,lanes:0,dispatch:null,lastRenderedReducer:i,lastRenderedState:v},h.queue=i,i=i.dispatch=ZO.bind(null,Qe,i),[h.memoizedState,i]},useRef:function(i){var l=Mn();return i={current:i},l.memoizedState=i},useState:function(i){i=Bh(i);var l=i.queue,f=Ub.bind(null,Qe,l);return l.dispatch=f,[i.memoizedState,f]},useDebugValue:Hh,useDeferredValue:function(i,l){var f=Mn();return zh(f,i,l)},useTransition:function(){var i=Bh(!1);return i=kb.bind(null,Qe,i.queue,!0,!1),Mn().memoizedState=i,[!1,i]},useSyncExternalStore:function(i,l,f){var h=Qe,v=Mn();if(ot){if(f===void 0)throw Error(r(407));f=f()}else{if(f=l(),It===null)throw Error(r(349));(at&127)!==0||lb(h,l,f)}v.memoizedState=f;var b={value:f,getSnapshot:l};return v.queue=b,Tb(cb.bind(null,h,b,i),[i]),h.flags|=2048,fo(9,{destroy:void 0},ub.bind(null,h,b,f,l),null),f},useId:function(){var i=Mn(),l=It.identifierPrefix;if(ot){var f=Kr,h=Yr;f=(h&~(1<<32-Pn(h)-1)).toString(32)+f,l="_"+l+"R_"+f,f=Zc++,0<f&&(l+="H"+f.toString(32)),l+="_"}else f=zO++,l="_"+l+"r_"+f.toString(32)+"_";return i.memoizedState=l},useHostTransitionStatus:Vh,useFormState:vb,useActionState:vb,useOptimistic:function(i){var l=Mn();l.memoizedState=l.baseState=i;var f={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return l.queue=f,l=Jh.bind(null,Qe,!0,f),f.dispatch=l,[i,l]},useMemoCache:$h,useCacheRefresh:function(){return Mn().memoizedState=WO.bind(null,Qe)},useEffectEvent:function(i){var l=Mn(),f={impl:i};return l.memoizedState=f,function(){if((mt&2)!==0)throw Error(r(440));return f.impl.apply(void 0,arguments)}}},Yh={readContext:wn,use:Qc,useCallback:Nb,useContext:wn,useEffect:Gh,useImperativeHandle:Rb,useInsertionEffect:Eb,useLayoutEffect:Cb,useMemo:Pb,useReducer:ed,useRef:xb,useState:function(){return ed(Ss)},useDebugValue:Hh,useDeferredValue:function(i,l){var f=Vt();return Mb(f,St.memoizedState,i,l)},useTransition:function(){var i=ed(Ss)[0],l=Vt().memoizedState;return[typeof i=="boolean"?i:Ul(i),l]},useSyncExternalStore:ob,useId:Lb,useHostTransitionStatus:Vh,useFormState:wb,useActionState:wb,useOptimistic:function(i,l){var f=Vt();return pb(f,St,i,l)},useMemoCache:$h,useCacheRefresh:$b};Yh.useEffectEvent=Ab;var Gb={readContext:wn,use:Qc,useCallback:Nb,useContext:wn,useEffect:Gh,useImperativeHandle:Rb,useInsertionEffect:Eb,useLayoutEffect:Cb,useMemo:Pb,useReducer:Fh,useRef:xb,useState:function(){return Fh(Ss)},useDebugValue:Hh,useDeferredValue:function(i,l){var f=Vt();return St===null?zh(f,i,l):Mb(f,St.memoizedState,i,l)},useTransition:function(){var i=Fh(Ss)[0],l=Vt().memoizedState;return[typeof i=="boolean"?i:Ul(i),l]},useSyncExternalStore:ob,useId:Lb,useHostTransitionStatus:Vh,useFormState:Sb,useActionState:Sb,useOptimistic:function(i,l){var f=Vt();return St!==null?pb(f,St,i,l):(f.baseState=i,[i,f.queue.dispatch])},useMemoCache:$h,useCacheRefresh:$b};Gb.useEffectEvent=Ab;function Kh(i,l,f,h){l=i.memoizedState,f=f(h,l),f=f==null?l:m({},l,f),i.memoizedState=f,i.lanes===0&&(i.updateQueue.baseState=f)}var Wh={enqueueSetState:function(i,l,f){i=i._reactInternals;var h=tr(),v=la(h);v.payload=l,f!=null&&(v.callback=f),l=ua(i,v,h),l!==null&&(Hn(l,i,h),Ol(l,i,h))},enqueueReplaceState:function(i,l,f){i=i._reactInternals;var h=tr(),v=la(h);v.tag=1,v.payload=l,f!=null&&(v.callback=f),l=ua(i,v,h),l!==null&&(Hn(l,i,h),Ol(l,i,h))},enqueueForceUpdate:function(i,l){i=i._reactInternals;var f=tr(),h=la(f);h.tag=2,l!=null&&(h.callback=l),l=ua(i,h,f),l!==null&&(Hn(l,i,f),Ol(l,i,f))}};function Hb(i,l,f,h,v,b,R){return i=i.stateNode,typeof i.shouldComponentUpdate=="function"?i.shouldComponentUpdate(h,b,R):l.prototype&&l.prototype.isPureReactComponent?!El(f,h)||!El(v,b):!0}function zb(i,l,f,h){i=l.state,typeof l.componentWillReceiveProps=="function"&&l.componentWillReceiveProps(f,h),typeof l.UNSAFE_componentWillReceiveProps=="function"&&l.UNSAFE_componentWillReceiveProps(f,h),l.state!==i&&Wh.enqueueReplaceState(l,l.state,null)}function hi(i,l){var f=l;if("ref"in l){f={};for(var h in l)h!=="ref"&&(f[h]=l[h])}if(i=i.defaultProps){f===l&&(f=m({},f));for(var v in i)f[v]===void 0&&(f[v]=i[v])}return f}function jb(i){Dc(i)}function Vb(i){console.error(i)}function Jb(i){Dc(i)}function sd(i,l){try{var f=i.onUncaughtError;f(l.value,{componentStack:l.stack})}catch(h){setTimeout(function(){throw h})}}function Yb(i,l,f){try{var h=i.onCaughtError;h(f.value,{componentStack:f.stack,errorBoundary:l.tag===1?l.stateNode:null})}catch(v){setTimeout(function(){throw v})}}function Zh(i,l,f){return f=la(f),f.tag=3,f.payload={element:null},f.callback=function(){sd(i,l)},f}function Kb(i){return i=la(i),i.tag=3,i}function Wb(i,l,f,h){var v=f.type.getDerivedStateFromError;if(typeof v=="function"){var b=h.value;i.payload=function(){return v(b)},i.callback=function(){Yb(l,f,h)}}var R=f.stateNode;R!==null&&typeof R.componentDidCatch=="function"&&(i.callback=function(){Yb(l,f,h),typeof v!="function"&&(ma===null?ma=new Set([this]):ma.add(this));var L=h.stack;this.componentDidCatch(h.value,{componentStack:L!==null?L:""})})}function XO(i,l,f,h,v){if(f.flags|=32768,h!==null&&typeof h=="object"&&typeof h.then=="function"){if(l=f.alternate,l!==null&&ro(l,f,v,!0),f=Zn.current,f!==null){switch(f.tag){case 31:case 13:return yr===null?gd():f.alternate===null&&Gt===0&&(Gt=3),f.flags&=-257,f.flags|=65536,f.lanes=v,h===jc?f.flags|=16384:(l=f.updateQueue,l===null?f.updateQueue=new Set([h]):l.add(h),Sm(i,h,v)),!1;case 22:return f.flags|=65536,h===jc?f.flags|=16384:(l=f.updateQueue,l===null?(l={transitions:null,markerInstances:null,retryQueue:new Set([h])},f.updateQueue=l):(f=l.retryQueue,f===null?l.retryQueue=new Set([h]):f.add(h)),Sm(i,h,v)),!1}throw Error(r(435,f.tag))}return Sm(i,h,v),gd(),!1}if(ot)return l=Zn.current,l!==null?((l.flags&65536)===0&&(l.flags|=256),l.flags|=65536,l.lanes=v,h!==gh&&(i=Error(r(422),{cause:h}),Rl(pr(i,f)))):(h!==gh&&(l=Error(r(423),{cause:h}),Rl(pr(l,f))),i=i.current.alternate,i.flags|=65536,v&=-v,i.lanes|=v,h=pr(h,f),v=Zh(i.stateNode,h,v),Ch(i,v),Gt!==4&&(Gt=2)),!1;var b=Error(r(520),{cause:h});if(b=pr(b,f),Yl===null?Yl=[b]:Yl.push(b),Gt!==4&&(Gt=2),l===null)return!0;h=pr(h,f),f=l;do{switch(f.tag){case 3:return f.flags|=65536,i=v&-v,f.lanes|=i,i=Zh(f.stateNode,h,i),Ch(f,i),!1;case 1:if(l=f.type,b=f.stateNode,(f.flags&128)===0&&(typeof l.getDerivedStateFromError=="function"||b!==null&&typeof b.componentDidCatch=="function"&&(ma===null||!ma.has(b))))return f.flags|=65536,v&=-v,f.lanes|=v,v=Kb(v),Wb(v,i,f,h),Ch(f,v),!1}f=f.return}while(f!==null);return!1}var Xh=Error(r(461)),Xt=!1;function bn(i,l,f,h){l.child=i===null?eb(l,null,f,h):fi(l,i.child,f,h)}function Zb(i,l,f,h,v){f=f.render;var b=l.ref;if("ref"in h){var R={};for(var L in h)L!=="ref"&&(R[L]=h[L])}else R=h;return li(l),h=kh(i,l,f,R,b,v),L=Oh(),i!==null&&!Xt?(Dh(i,l,v),xs(i,l,v)):(ot&&L&&hh(l),l.flags|=1,bn(i,l,h,v),l.child)}function Xb(i,l,f,h,v){if(i===null){var b=f.type;return typeof b=="function"&&!dh(b)&&b.defaultProps===void 0&&f.compare===null?(l.tag=15,l.type=b,Qb(i,l,b,h,v)):(i=Fc(f.type,null,h,l,l.mode,v),i.ref=l.ref,i.return=l,l.child=i)}if(b=i.child,!im(i,v)){var R=b.memoizedProps;if(f=f.compare,f=f!==null?f:El,f(R,h)&&i.ref===l.ref)return xs(i,l,v)}return l.flags|=1,i=ys(b,h),i.ref=l.ref,i.return=l,l.child=i}function Qb(i,l,f,h,v){if(i!==null){var b=i.memoizedProps;if(El(b,h)&&i.ref===l.ref)if(Xt=!1,l.pendingProps=h=b,im(i,v))(i.flags&131072)!==0&&(Xt=!0);else return l.lanes=i.lanes,xs(i,l,v)}return Qh(i,l,f,h,v)}function eS(i,l,f,h){var v=h.children,b=i!==null?i.memoizedState:null;if(i===null&&l.stateNode===null&&(l.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),h.mode==="hidden"){if((l.flags&128)!==0){if(b=b!==null?b.baseLanes|f:f,i!==null){for(h=l.child=i.child,v=0;h!==null;)v=v|h.lanes|h.childLanes,h=h.sibling;h=v&~b}else h=0,l.child=null;return tS(i,l,b,f,h)}if((f&536870912)!==0)l.memoizedState={baseLanes:0,cachePool:null},i!==null&&Hc(l,b!==null?b.cachePool:null),b!==null?rb(l,b):Rh(),sb(l);else return h=l.lanes=536870912,tS(i,l,b!==null?b.baseLanes|f:f,f,h)}else b!==null?(Hc(l,b.cachePool),rb(l,b),da(),l.memoizedState=null):(i!==null&&Hc(l,null),Rh(),da());return bn(i,l,v,f),l.child}function ql(i,l){return i!==null&&i.tag===22||l.stateNode!==null||(l.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),l.sibling}function tS(i,l,f,h,v){var b=xh();return b=b===null?null:{parent:Wt._currentValue,pool:b},l.memoizedState={baseLanes:f,cachePool:b},i!==null&&Hc(l,null),Rh(),sb(l),i!==null&&ro(i,l,h,!0),l.childLanes=v,null}function ad(i,l){return l=od({mode:l.mode,children:l.children},i.mode),l.ref=i.ref,i.child=l,l.return=i,l}function nS(i,l,f){return fi(l,i.child,null,f),i=ad(l,l.pendingProps),i.flags|=2,Xn(l),l.memoizedState=null,i}function QO(i,l,f){var h=l.pendingProps,v=(l.flags&128)!==0;if(l.flags&=-129,i===null){if(ot){if(h.mode==="hidden")return i=ad(l,h),l.lanes=536870912,ql(null,i);if(Ph(l),(i=Pt)?(i=hx(i,gr),i=i!==null&&i.data==="&"?i:null,i!==null&&(l.memoizedState={dehydrated:i,treeContext:ra!==null?{id:Yr,overflow:Kr}:null,retryLane:536870912,hydrationErrors:null},f=Fw(i),f.return=l,l.child=f,vn=l,Pt=null)):i=null,i===null)throw aa(l);return l.lanes=536870912,null}return ad(l,h)}var b=i.memoizedState;if(b!==null){var R=b.dehydrated;if(Ph(l),v)if(l.flags&256)l.flags&=-257,l=nS(i,l,f);else if(l.memoizedState!==null)l.child=i.child,l.flags|=128,l=null;else throw Error(r(558));else if(Xt||ro(i,l,f,!1),v=(f&i.childLanes)!==0,Xt||v){if(h=It,h!==null&&(R=Sc(h,f),R!==0&&R!==b.retryLane))throw b.retryLane=R,si(i,R),Hn(h,i,R),Xh;gd(),l=nS(i,l,f)}else i=b.treeContext,Pt=_r(R.nextSibling),vn=l,ot=!0,sa=null,gr=!1,i!==null&&Gw(l,i),l=ad(l,h),l.flags|=4096;return l}return i=ys(i.child,{mode:h.mode,children:h.children}),i.ref=l.ref,l.child=i,i.return=l,i}function id(i,l){var f=l.ref;if(f===null)i!==null&&i.ref!==null&&(l.flags|=4194816);else{if(typeof f!="function"&&typeof f!="object")throw Error(r(284));(i===null||i.ref!==f)&&(l.flags|=4194816)}}function Qh(i,l,f,h,v){return li(l),f=kh(i,l,f,h,void 0,v),h=Oh(),i!==null&&!Xt?(Dh(i,l,v),xs(i,l,v)):(ot&&h&&hh(l),l.flags|=1,bn(i,l,f,v),l.child)}function rS(i,l,f,h,v,b){return li(l),l.updateQueue=null,f=ib(l,h,f,v),ab(i),h=Oh(),i!==null&&!Xt?(Dh(i,l,b),xs(i,l,b)):(ot&&h&&hh(l),l.flags|=1,bn(i,l,f,b),l.child)}function sS(i,l,f,h,v){if(li(l),l.stateNode===null){var b=Qi,R=f.contextType;typeof R=="object"&&R!==null&&(b=wn(R)),b=new f(h,b),l.memoizedState=b.state!==null&&b.state!==void 0?b.state:null,b.updater=Wh,l.stateNode=b,b._reactInternals=l,b=l.stateNode,b.props=h,b.state=l.memoizedState,b.refs={},Ah(l),R=f.contextType,b.context=typeof R=="object"&&R!==null?wn(R):Qi,b.state=l.memoizedState,R=f.getDerivedStateFromProps,typeof R=="function"&&(Kh(l,f,R,h),b.state=l.memoizedState),typeof f.getDerivedStateFromProps=="function"||typeof b.getSnapshotBeforeUpdate=="function"||typeof b.UNSAFE_componentWillMount!="function"&&typeof b.componentWillMount!="function"||(R=b.state,typeof b.componentWillMount=="function"&&b.componentWillMount(),typeof b.UNSAFE_componentWillMount=="function"&&b.UNSAFE_componentWillMount(),R!==b.state&&Wh.enqueueReplaceState(b,b.state,null),Ll(l,h,b,v),Dl(),b.state=l.memoizedState),typeof b.componentDidMount=="function"&&(l.flags|=4194308),h=!0}else if(i===null){b=l.stateNode;var L=l.memoizedProps,H=hi(f,L);b.props=H;var Q=b.context,ae=f.contextType;R=Qi,typeof ae=="object"&&ae!==null&&(R=wn(ae));var ue=f.getDerivedStateFromProps;ae=typeof ue=="function"||typeof b.getSnapshotBeforeUpdate=="function",L=l.pendingProps!==L,ae||typeof b.UNSAFE_componentWillReceiveProps!="function"&&typeof b.componentWillReceiveProps!="function"||(L||Q!==R)&&zb(l,b,h,R),oa=!1;var ne=l.memoizedState;b.state=ne,Ll(l,h,b,v),Dl(),Q=l.memoizedState,L||ne!==Q||oa?(typeof ue=="function"&&(Kh(l,f,ue,h),Q=l.memoizedState),(H=oa||Hb(l,f,H,h,ne,Q,R))?(ae||typeof b.UNSAFE_componentWillMount!="function"&&typeof b.componentWillMount!="function"||(typeof b.componentWillMount=="function"&&b.componentWillMount(),typeof b.UNSAFE_componentWillMount=="function"&&b.UNSAFE_componentWillMount()),typeof b.componentDidMount=="function"&&(l.flags|=4194308)):(typeof b.componentDidMount=="function"&&(l.flags|=4194308),l.memoizedProps=h,l.memoizedState=Q),b.props=h,b.state=Q,b.context=R,h=H):(typeof b.componentDidMount=="function"&&(l.flags|=4194308),h=!1)}else{b=l.stateNode,Eh(i,l),R=l.memoizedProps,ae=hi(f,R),b.props=ae,ue=l.pendingProps,ne=b.context,Q=f.contextType,H=Qi,typeof Q=="object"&&Q!==null&&(H=wn(Q)),L=f.getDerivedStateFromProps,(Q=typeof L=="function"||typeof b.getSnapshotBeforeUpdate=="function")||typeof b.UNSAFE_componentWillReceiveProps!="function"&&typeof b.componentWillReceiveProps!="function"||(R!==ue||ne!==H)&&zb(l,b,h,H),oa=!1,ne=l.memoizedState,b.state=ne,Ll(l,h,b,v),Dl();var re=l.memoizedState;R!==ue||ne!==re||oa||i!==null&&i.dependencies!==null&&qc(i.dependencies)?(typeof L=="function"&&(Kh(l,f,L,h),re=l.memoizedState),(ae=oa||Hb(l,f,ae,h,ne,re,H)||i!==null&&i.dependencies!==null&&qc(i.dependencies))?(Q||typeof b.UNSAFE_componentWillUpdate!="function"&&typeof b.componentWillUpdate!="function"||(typeof b.componentWillUpdate=="function"&&b.componentWillUpdate(h,re,H),typeof b.UNSAFE_componentWillUpdate=="function"&&b.UNSAFE_componentWillUpdate(h,re,H)),typeof b.componentDidUpdate=="function"&&(l.flags|=4),typeof b.getSnapshotBeforeUpdate=="function"&&(l.flags|=1024)):(typeof b.componentDidUpdate!="function"||R===i.memoizedProps&&ne===i.memoizedState||(l.flags|=4),typeof b.getSnapshotBeforeUpdate!="function"||R===i.memoizedProps&&ne===i.memoizedState||(l.flags|=1024),l.memoizedProps=h,l.memoizedState=re),b.props=h,b.state=re,b.context=H,h=ae):(typeof b.componentDidUpdate!="function"||R===i.memoizedProps&&ne===i.memoizedState||(l.flags|=4),typeof b.getSnapshotBeforeUpdate!="function"||R===i.memoizedProps&&ne===i.memoizedState||(l.flags|=1024),h=!1)}return b=h,id(i,l),h=(l.flags&128)!==0,b||h?(b=l.stateNode,f=h&&typeof f.getDerivedStateFromError!="function"?null:b.render(),l.flags|=1,i!==null&&h?(l.child=fi(l,i.child,null,v),l.child=fi(l,null,f,v)):bn(i,l,f,v),l.memoizedState=b.state,i=l.child):i=xs(i,l,v),i}function aS(i,l,f,h){return ii(),l.flags|=256,bn(i,l,f,h),l.child}var em={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function tm(i){return{baseLanes:i,cachePool:Yw()}}function nm(i,l,f){return i=i!==null?i.childLanes&~f:0,l&&(i|=er),i}function iS(i,l,f){var h=l.pendingProps,v=!1,b=(l.flags&128)!==0,R;if((R=b)||(R=i!==null&&i.memoizedState===null?!1:(jt.current&2)!==0),R&&(v=!0,l.flags&=-129),R=(l.flags&32)!==0,l.flags&=-33,i===null){if(ot){if(v?ca(l):da(),(i=Pt)?(i=hx(i,gr),i=i!==null&&i.data!=="&"?i:null,i!==null&&(l.memoizedState={dehydrated:i,treeContext:ra!==null?{id:Yr,overflow:Kr}:null,retryLane:536870912,hydrationErrors:null},f=Fw(i),f.return=l,l.child=f,vn=l,Pt=null)):i=null,i===null)throw aa(l);return Um(i)?l.lanes=32:l.lanes=536870912,null}var L=h.children;return h=h.fallback,v?(da(),v=l.mode,L=od({mode:"hidden",children:L},v),h=ai(h,v,f,null),L.return=l,h.return=l,L.sibling=h,l.child=L,h=l.child,h.memoizedState=tm(f),h.childLanes=nm(i,R,f),l.memoizedState=em,ql(null,h)):(ca(l),rm(l,L))}var H=i.memoizedState;if(H!==null&&(L=H.dehydrated,L!==null)){if(b)l.flags&256?(ca(l),l.flags&=-257,l=sm(i,l,f)):l.memoizedState!==null?(da(),l.child=i.child,l.flags|=128,l=null):(da(),L=h.fallback,v=l.mode,h=od({mode:"visible",children:h.children},v),L=ai(L,v,f,null),L.flags|=2,h.return=l,L.return=l,h.sibling=L,l.child=h,fi(l,i.child,null,f),h=l.child,h.memoizedState=tm(f),h.childLanes=nm(i,R,f),l.memoizedState=em,l=ql(null,h));else if(ca(l),Um(L)){if(R=L.nextSibling&&L.nextSibling.dataset,R)var Q=R.dgst;R=Q,h=Error(r(419)),h.stack="",h.digest=R,Rl({value:h,source:null,stack:null}),l=sm(i,l,f)}else if(Xt||ro(i,l,f,!1),R=(f&i.childLanes)!==0,Xt||R){if(R=It,R!==null&&(h=Sc(R,f),h!==0&&h!==H.retryLane))throw H.retryLane=h,si(i,h),Hn(R,i,h),Xh;$m(L)||gd(),l=sm(i,l,f)}else $m(L)?(l.flags|=192,l.child=i.child,l=null):(i=H.treeContext,Pt=_r(L.nextSibling),vn=l,ot=!0,sa=null,gr=!1,i!==null&&Gw(l,i),l=rm(l,h.children),l.flags|=4096);return l}return v?(da(),L=h.fallback,v=l.mode,H=i.child,Q=H.sibling,h=ys(H,{mode:"hidden",children:h.children}),h.subtreeFlags=H.subtreeFlags&65011712,Q!==null?L=ys(Q,L):(L=ai(L,v,f,null),L.flags|=2),L.return=l,h.return=l,h.sibling=L,l.child=h,ql(null,h),h=l.child,L=i.child.memoizedState,L===null?L=tm(f):(v=L.cachePool,v!==null?(H=Wt._currentValue,v=v.parent!==H?{parent:H,pool:H}:v):v=Yw(),L={baseLanes:L.baseLanes|f,cachePool:v}),h.memoizedState=L,h.childLanes=nm(i,R,f),l.memoizedState=em,ql(i.child,h)):(ca(l),f=i.child,i=f.sibling,f=ys(f,{mode:"visible",children:h.children}),f.return=l,f.sibling=null,i!==null&&(R=l.deletions,R===null?(l.deletions=[i],l.flags|=16):R.push(i)),l.child=f,l.memoizedState=null,f)}function rm(i,l){return l=od({mode:"visible",children:l},i.mode),l.return=i,i.child=l}function od(i,l){return i=Wn(22,i,null,l),i.lanes=0,i}function sm(i,l,f){return fi(l,i.child,null,f),i=rm(l,l.pendingProps.children),i.flags|=2,l.memoizedState=null,i}function oS(i,l,f){i.lanes|=l;var h=i.alternate;h!==null&&(h.lanes|=l),vh(i.return,l,f)}function am(i,l,f,h,v,b){var R=i.memoizedState;R===null?i.memoizedState={isBackwards:l,rendering:null,renderingStartTime:0,last:h,tail:f,tailMode:v,treeForkCount:b}:(R.isBackwards=l,R.rendering=null,R.renderingStartTime=0,R.last=h,R.tail=f,R.tailMode=v,R.treeForkCount=b)}function lS(i,l,f){var h=l.pendingProps,v=h.revealOrder,b=h.tail;h=h.children;var R=jt.current,L=(R&2)!==0;if(L?(R=R&1|2,l.flags|=128):R&=1,ee(jt,R),bn(i,l,h,f),h=ot?Il:0,!L&&i!==null&&(i.flags&128)!==0)e:for(i=l.child;i!==null;){if(i.tag===13)i.memoizedState!==null&&oS(i,f,l);else if(i.tag===19)oS(i,f,l);else if(i.child!==null){i.child.return=i,i=i.child;continue}if(i===l)break e;for(;i.sibling===null;){if(i.return===null||i.return===l)break e;i=i.return}i.sibling.return=i.return,i=i.sibling}switch(v){case"forwards":for(f=l.child,v=null;f!==null;)i=f.alternate,i!==null&&Kc(i)===null&&(v=f),f=f.sibling;f=v,f===null?(v=l.child,l.child=null):(v=f.sibling,f.sibling=null),am(l,!1,v,f,b,h);break;case"backwards":case"unstable_legacy-backwards":for(f=null,v=l.child,l.child=null;v!==null;){if(i=v.alternate,i!==null&&Kc(i)===null){l.child=v;break}i=v.sibling,v.sibling=f,f=v,v=i}am(l,!0,f,null,b,h);break;case"together":am(l,!1,null,null,void 0,h);break;default:l.memoizedState=null}return l.child}function xs(i,l,f){if(i!==null&&(l.dependencies=i.dependencies),ha|=l.lanes,(f&l.childLanes)===0)if(i!==null){if(ro(i,l,f,!1),(f&l.childLanes)===0)return null}else return null;if(i!==null&&l.child!==i.child)throw Error(r(153));if(l.child!==null){for(i=l.child,f=ys(i,i.pendingProps),l.child=f,f.return=l;i.sibling!==null;)i=i.sibling,f=f.sibling=ys(i,i.pendingProps),f.return=l;f.sibling=null}return l.child}function im(i,l){return(i.lanes&l)!==0?!0:(i=i.dependencies,!!(i!==null&&qc(i)))}function eD(i,l,f){switch(l.tag){case 3:Ge(l,l.stateNode.containerInfo),ia(l,Wt,i.memoizedState.cache),ii();break;case 27:case 5:Ae(l);break;case 4:Ge(l,l.stateNode.containerInfo);break;case 10:ia(l,l.type,l.memoizedProps.value);break;case 31:if(l.memoizedState!==null)return l.flags|=128,Ph(l),null;break;case 13:var h=l.memoizedState;if(h!==null)return h.dehydrated!==null?(ca(l),l.flags|=128,null):(f&l.child.childLanes)!==0?iS(i,l,f):(ca(l),i=xs(i,l,f),i!==null?i.sibling:null);ca(l);break;case 19:var v=(i.flags&128)!==0;if(h=(f&l.childLanes)!==0,h||(ro(i,l,f,!1),h=(f&l.childLanes)!==0),v){if(h)return lS(i,l,f);l.flags|=128}if(v=l.memoizedState,v!==null&&(v.rendering=null,v.tail=null,v.lastEffect=null),ee(jt,jt.current),h)break;return null;case 22:return l.lanes=0,eS(i,l,f,l.pendingProps);case 24:ia(l,Wt,i.memoizedState.cache)}return xs(i,l,f)}function uS(i,l,f){if(i!==null)if(i.memoizedProps!==l.pendingProps)Xt=!0;else{if(!im(i,f)&&(l.flags&128)===0)return Xt=!1,eD(i,l,f);Xt=(i.flags&131072)!==0}else Xt=!1,ot&&(l.flags&1048576)!==0&&qw(l,Il,l.index);switch(l.lanes=0,l.tag){case 16:e:{var h=l.pendingProps;if(i=ci(l.elementType),l.type=i,typeof i=="function")dh(i)?(h=hi(i,h),l.tag=1,l=sS(null,l,i,h,f)):(l.tag=0,l=Qh(null,l,i,h,f));else{if(i!=null){var v=i.$$typeof;if(v===T){l.tag=11,l=Zb(null,l,i,h,f);break e}else if(v===N){l.tag=14,l=Xb(null,l,i,h,f);break e}}throw l=j(i)||i,Error(r(306,l,""))}}return l;case 0:return Qh(i,l,l.type,l.pendingProps,f);case 1:return h=l.type,v=hi(h,l.pendingProps),sS(i,l,h,v,f);case 3:e:{if(Ge(l,l.stateNode.containerInfo),i===null)throw Error(r(387));h=l.pendingProps;var b=l.memoizedState;v=b.element,Eh(i,l),Ll(l,h,null,f);var R=l.memoizedState;if(h=R.cache,ia(l,Wt,h),h!==b.cache&&wh(l,[Wt],f,!0),Dl(),h=R.element,b.isDehydrated)if(b={element:h,isDehydrated:!1,cache:R.cache},l.updateQueue.baseState=b,l.memoizedState=b,l.flags&256){l=aS(i,l,h,f);break e}else if(h!==v){v=pr(Error(r(424)),l),Rl(v),l=aS(i,l,h,f);break e}else{switch(i=l.stateNode.containerInfo,i.nodeType){case 9:i=i.body;break;default:i=i.nodeName==="HTML"?i.ownerDocument.body:i}for(Pt=_r(i.firstChild),vn=l,ot=!0,sa=null,gr=!0,f=eb(l,null,h,f),l.child=f;f;)f.flags=f.flags&-3|4096,f=f.sibling}else{if(ii(),h===v){l=xs(i,l,f);break e}bn(i,l,h,f)}l=l.child}return l;case 26:return id(i,l),i===null?(f=wx(l.type,null,l.pendingProps,null))?l.memoizedState=f:ot||(f=l.type,i=l.pendingProps,h=xd(fe.current).createElement(f),h[Nt]=l,h[sn]=i,Sn(h,f,i),Kt(h),l.stateNode=h):l.memoizedState=wx(l.type,i.memoizedProps,l.pendingProps,i.memoizedState),null;case 27:return Ae(l),i===null&&ot&&(h=l.stateNode=yx(l.type,l.pendingProps,fe.current),vn=l,gr=!0,v=Pt,va(l.type)?(Fm=v,Pt=_r(h.firstChild)):Pt=v),bn(i,l,l.pendingProps.children,f),id(i,l),i===null&&(l.flags|=4194304),l.child;case 5:return i===null&&ot&&((v=h=Pt)&&(h=ND(h,l.type,l.pendingProps,gr),h!==null?(l.stateNode=h,vn=l,Pt=_r(h.firstChild),gr=!1,v=!0):v=!1),v||aa(l)),Ae(l),v=l.type,b=l.pendingProps,R=i!==null?i.memoizedProps:null,h=b.children,Om(v,b)?h=null:R!==null&&Om(v,R)&&(l.flags|=32),l.memoizedState!==null&&(v=kh(i,l,jO,null,null,f),nu._currentValue=v),id(i,l),bn(i,l,h,f),l.child;case 6:return i===null&&ot&&((i=f=Pt)&&(f=PD(f,l.pendingProps,gr),f!==null?(l.stateNode=f,vn=l,Pt=null,i=!0):i=!1),i||aa(l)),null;case 13:return iS(i,l,f);case 4:return Ge(l,l.stateNode.containerInfo),h=l.pendingProps,i===null?l.child=fi(l,null,h,f):bn(i,l,h,f),l.child;case 11:return Zb(i,l,l.type,l.pendingProps,f);case 7:return bn(i,l,l.pendingProps,f),l.child;case 8:return bn(i,l,l.pendingProps.children,f),l.child;case 12:return bn(i,l,l.pendingProps.children,f),l.child;case 10:return h=l.pendingProps,ia(l,l.type,h.value),bn(i,l,h.children,f),l.child;case 9:return v=l.type._context,h=l.pendingProps.children,li(l),v=wn(v),h=h(v),l.flags|=1,bn(i,l,h,f),l.child;case 14:return Xb(i,l,l.type,l.pendingProps,f);case 15:return Qb(i,l,l.type,l.pendingProps,f);case 19:return lS(i,l,f);case 31:return QO(i,l,f);case 22:return eS(i,l,f,l.pendingProps);case 24:return li(l),h=wn(Wt),i===null?(v=xh(),v===null&&(v=It,b=bh(),v.pooledCache=b,b.refCount++,b!==null&&(v.pooledCacheLanes|=f),v=b),l.memoizedState={parent:h,cache:v},Ah(l),ia(l,Wt,v)):((i.lanes&f)!==0&&(Eh(i,l),Ll(l,null,null,f),Dl()),v=i.memoizedState,b=l.memoizedState,v.parent!==h?(v={parent:h,cache:h},l.memoizedState=v,l.lanes===0&&(l.memoizedState=l.updateQueue.baseState=v),ia(l,Wt,h)):(h=b.cache,ia(l,Wt,h),h!==v.cache&&wh(l,[Wt],f,!0))),bn(i,l,l.pendingProps.children,f),l.child;case 29:throw l.pendingProps}throw Error(r(156,l.tag))}function Ts(i){i.flags|=4}function om(i,l,f,h,v){if((l=(i.mode&32)!==0)&&(l=!1),l){if(i.flags|=16777216,(v&335544128)===v)if(i.stateNode.complete)i.flags|=8192;else if(LS())i.flags|=8192;else throw di=jc,Th}else i.flags&=-16777217}function cS(i,l){if(l.type!=="stylesheet"||(l.state.loading&4)!==0)i.flags&=-16777217;else if(i.flags|=16777216,!Ax(l))if(LS())i.flags|=8192;else throw di=jc,Th}function ld(i,l){l!==null&&(i.flags|=4),i.flags&16384&&(l=i.tag!==22?wc():536870912,i.lanes|=l,go|=l)}function Gl(i,l){if(!ot)switch(i.tailMode){case"hidden":l=i.tail;for(var f=null;l!==null;)l.alternate!==null&&(f=l),l=l.sibling;f===null?i.tail=null:f.sibling=null;break;case"collapsed":f=i.tail;for(var h=null;f!==null;)f.alternate!==null&&(h=f),f=f.sibling;h===null?l||i.tail===null?i.tail=null:i.tail.sibling=null:h.sibling=null}}function Mt(i){var l=i.alternate!==null&&i.alternate.child===i.child,f=0,h=0;if(l)for(var v=i.child;v!==null;)f|=v.lanes|v.childLanes,h|=v.subtreeFlags&65011712,h|=v.flags&65011712,v.return=i,v=v.sibling;else for(v=i.child;v!==null;)f|=v.lanes|v.childLanes,h|=v.subtreeFlags,h|=v.flags,v.return=i,v=v.sibling;return i.subtreeFlags|=h,i.childLanes=f,l}function tD(i,l,f){var h=l.pendingProps;switch(mh(l),l.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Mt(l),null;case 1:return Mt(l),null;case 3:return f=l.stateNode,h=null,i!==null&&(h=i.memoizedState.cache),l.memoizedState.cache!==h&&(l.flags|=2048),ws(Wt),ze(),f.pendingContext&&(f.context=f.pendingContext,f.pendingContext=null),(i===null||i.child===null)&&(no(l)?Ts(l):i===null||i.memoizedState.isDehydrated&&(l.flags&256)===0||(l.flags|=1024,yh())),Mt(l),null;case 26:var v=l.type,b=l.memoizedState;return i===null?(Ts(l),b!==null?(Mt(l),cS(l,b)):(Mt(l),om(l,v,null,h,f))):b?b!==i.memoizedState?(Ts(l),Mt(l),cS(l,b)):(Mt(l),l.flags&=-16777217):(i=i.memoizedProps,i!==h&&Ts(l),Mt(l),om(l,v,i,h,f)),null;case 27:if(Rt(l),f=fe.current,v=l.type,i!==null&&l.stateNode!=null)i.memoizedProps!==h&&Ts(l);else{if(!h){if(l.stateNode===null)throw Error(r(166));return Mt(l),null}i=ce.current,no(l)?Hw(l):(i=yx(v,h,f),l.stateNode=i,Ts(l))}return Mt(l),null;case 5:if(Rt(l),v=l.type,i!==null&&l.stateNode!=null)i.memoizedProps!==h&&Ts(l);else{if(!h){if(l.stateNode===null)throw Error(r(166));return Mt(l),null}if(b=ce.current,no(l))Hw(l);else{var R=xd(fe.current);switch(b){case 1:b=R.createElementNS("http://www.w3.org/2000/svg",v);break;case 2:b=R.createElementNS("http://www.w3.org/1998/Math/MathML",v);break;default:switch(v){case"svg":b=R.createElementNS("http://www.w3.org/2000/svg",v);break;case"math":b=R.createElementNS("http://www.w3.org/1998/Math/MathML",v);break;case"script":b=R.createElement("div"),b.innerHTML="<script><\/script>",b=b.removeChild(b.firstChild);break;case"select":b=typeof h.is=="string"?R.createElement("select",{is:h.is}):R.createElement("select"),h.multiple?b.multiple=!0:h.size&&(b.size=h.size);break;default:b=typeof h.is=="string"?R.createElement(v,{is:h.is}):R.createElement(v)}}b[Nt]=l,b[sn]=h;e:for(R=l.child;R!==null;){if(R.tag===5||R.tag===6)b.appendChild(R.stateNode);else if(R.tag!==4&&R.tag!==27&&R.child!==null){R.child.return=R,R=R.child;continue}if(R===l)break e;for(;R.sibling===null;){if(R.return===null||R.return===l)break e;R=R.return}R.sibling.return=R.return,R=R.sibling}l.stateNode=b;e:switch(Sn(b,v,h),v){case"button":case"input":case"select":case"textarea":h=!!h.autoFocus;break e;case"img":h=!0;break e;default:h=!1}h&&Ts(l)}}return Mt(l),om(l,l.type,i===null?null:i.memoizedProps,l.pendingProps,f),null;case 6:if(i&&l.stateNode!=null)i.memoizedProps!==h&&Ts(l);else{if(typeof h!="string"&&l.stateNode===null)throw Error(r(166));if(i=fe.current,no(l)){if(i=l.stateNode,f=l.memoizedProps,h=null,v=vn,v!==null)switch(v.tag){case 27:case 5:h=v.memoizedProps}i[Nt]=l,i=!!(i.nodeValue===f||h!==null&&h.suppressHydrationWarning===!0||ix(i.nodeValue,f)),i||aa(l,!0)}else i=xd(i).createTextNode(h),i[Nt]=l,l.stateNode=i}return Mt(l),null;case 31:if(f=l.memoizedState,i===null||i.memoizedState!==null){if(h=no(l),f!==null){if(i===null){if(!h)throw Error(r(318));if(i=l.memoizedState,i=i!==null?i.dehydrated:null,!i)throw Error(r(557));i[Nt]=l}else ii(),(l.flags&128)===0&&(l.memoizedState=null),l.flags|=4;Mt(l),i=!1}else f=yh(),i!==null&&i.memoizedState!==null&&(i.memoizedState.hydrationErrors=f),i=!0;if(!i)return l.flags&256?(Xn(l),l):(Xn(l),null);if((l.flags&128)!==0)throw Error(r(558))}return Mt(l),null;case 13:if(h=l.memoizedState,i===null||i.memoizedState!==null&&i.memoizedState.dehydrated!==null){if(v=no(l),h!==null&&h.dehydrated!==null){if(i===null){if(!v)throw Error(r(318));if(v=l.memoizedState,v=v!==null?v.dehydrated:null,!v)throw Error(r(317));v[Nt]=l}else ii(),(l.flags&128)===0&&(l.memoizedState=null),l.flags|=4;Mt(l),v=!1}else v=yh(),i!==null&&i.memoizedState!==null&&(i.memoizedState.hydrationErrors=v),v=!0;if(!v)return l.flags&256?(Xn(l),l):(Xn(l),null)}return Xn(l),(l.flags&128)!==0?(l.lanes=f,l):(f=h!==null,i=i!==null&&i.memoizedState!==null,f&&(h=l.child,v=null,h.alternate!==null&&h.alternate.memoizedState!==null&&h.alternate.memoizedState.cachePool!==null&&(v=h.alternate.memoizedState.cachePool.pool),b=null,h.memoizedState!==null&&h.memoizedState.cachePool!==null&&(b=h.memoizedState.cachePool.pool),b!==v&&(h.flags|=2048)),f!==i&&f&&(l.child.flags|=8192),ld(l,l.updateQueue),Mt(l),null);case 4:return ze(),i===null&&Rm(l.stateNode.containerInfo),Mt(l),null;case 10:return ws(l.type),Mt(l),null;case 19:if(W(jt),h=l.memoizedState,h===null)return Mt(l),null;if(v=(l.flags&128)!==0,b=h.rendering,b===null)if(v)Gl(h,!1);else{if(Gt!==0||i!==null&&(i.flags&128)!==0)for(i=l.child;i!==null;){if(b=Kc(i),b!==null){for(l.flags|=128,Gl(h,!1),i=b.updateQueue,l.updateQueue=i,ld(l,i),l.subtreeFlags=0,i=f,f=l.child;f!==null;)Uw(f,i),f=f.sibling;return ee(jt,jt.current&1|2),ot&&_s(l,h.treeForkCount),l.child}i=i.sibling}h.tail!==null&&_e()>pd&&(l.flags|=128,v=!0,Gl(h,!1),l.lanes=4194304)}else{if(!v)if(i=Kc(b),i!==null){if(l.flags|=128,v=!0,i=i.updateQueue,l.updateQueue=i,ld(l,i),Gl(h,!0),h.tail===null&&h.tailMode==="hidden"&&!b.alternate&&!ot)return Mt(l),null}else 2*_e()-h.renderingStartTime>pd&&f!==536870912&&(l.flags|=128,v=!0,Gl(h,!1),l.lanes=4194304);h.isBackwards?(b.sibling=l.child,l.child=b):(i=h.last,i!==null?i.sibling=b:l.child=b,h.last=b)}return h.tail!==null?(i=h.tail,h.rendering=i,h.tail=i.sibling,h.renderingStartTime=_e(),i.sibling=null,f=jt.current,ee(jt,v?f&1|2:f&1),ot&&_s(l,h.treeForkCount),i):(Mt(l),null);case 22:case 23:return Xn(l),Nh(),h=l.memoizedState!==null,i!==null?i.memoizedState!==null!==h&&(l.flags|=8192):h&&(l.flags|=8192),h?(f&536870912)!==0&&(l.flags&128)===0&&(Mt(l),l.subtreeFlags&6&&(l.flags|=8192)):Mt(l),f=l.updateQueue,f!==null&&ld(l,f.retryQueue),f=null,i!==null&&i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(f=i.memoizedState.cachePool.pool),h=null,l.memoizedState!==null&&l.memoizedState.cachePool!==null&&(h=l.memoizedState.cachePool.pool),h!==f&&(l.flags|=2048),i!==null&&W(ui),null;case 24:return f=null,i!==null&&(f=i.memoizedState.cache),l.memoizedState.cache!==f&&(l.flags|=2048),ws(Wt),Mt(l),null;case 25:return null;case 30:return null}throw Error(r(156,l.tag))}function nD(i,l){switch(mh(l),l.tag){case 1:return i=l.flags,i&65536?(l.flags=i&-65537|128,l):null;case 3:return ws(Wt),ze(),i=l.flags,(i&65536)!==0&&(i&128)===0?(l.flags=i&-65537|128,l):null;case 26:case 27:case 5:return Rt(l),null;case 31:if(l.memoizedState!==null){if(Xn(l),l.alternate===null)throw Error(r(340));ii()}return i=l.flags,i&65536?(l.flags=i&-65537|128,l):null;case 13:if(Xn(l),i=l.memoizedState,i!==null&&i.dehydrated!==null){if(l.alternate===null)throw Error(r(340));ii()}return i=l.flags,i&65536?(l.flags=i&-65537|128,l):null;case 19:return W(jt),null;case 4:return ze(),null;case 10:return ws(l.type),null;case 22:case 23:return Xn(l),Nh(),i!==null&&W(ui),i=l.flags,i&65536?(l.flags=i&-65537|128,l):null;case 24:return ws(Wt),null;case 25:return null;default:return null}}function dS(i,l){switch(mh(l),l.tag){case 3:ws(Wt),ze();break;case 26:case 27:case 5:Rt(l);break;case 4:ze();break;case 31:l.memoizedState!==null&&Xn(l);break;case 13:Xn(l);break;case 19:W(jt);break;case 10:ws(l.type);break;case 22:case 23:Xn(l),Nh(),i!==null&&W(ui);break;case 24:ws(Wt)}}function Hl(i,l){try{var f=l.updateQueue,h=f!==null?f.lastEffect:null;if(h!==null){var v=h.next;f=v;do{if((f.tag&i)===i){h=void 0;var b=f.create,R=f.inst;h=b(),R.destroy=h}f=f.next}while(f!==v)}}catch(L){vt(l,l.return,L)}}function fa(i,l,f){try{var h=l.updateQueue,v=h!==null?h.lastEffect:null;if(v!==null){var b=v.next;h=b;do{if((h.tag&i)===i){var R=h.inst,L=R.destroy;if(L!==void 0){R.destroy=void 0,v=l;var H=f,Q=L;try{Q()}catch(ae){vt(v,H,ae)}}}h=h.next}while(h!==b)}}catch(ae){vt(l,l.return,ae)}}function fS(i){var l=i.updateQueue;if(l!==null){var f=i.stateNode;try{nb(l,f)}catch(h){vt(i,i.return,h)}}}function pS(i,l,f){f.props=hi(i.type,i.memoizedProps),f.state=i.memoizedState;try{f.componentWillUnmount()}catch(h){vt(i,l,h)}}function zl(i,l){try{var f=i.ref;if(f!==null){switch(i.tag){case 26:case 27:case 5:var h=i.stateNode;break;case 30:h=i.stateNode;break;default:h=i.stateNode}typeof f=="function"?i.refCleanup=f(h):f.current=h}}catch(v){vt(i,l,v)}}function Wr(i,l){var f=i.ref,h=i.refCleanup;if(f!==null)if(typeof h=="function")try{h()}catch(v){vt(i,l,v)}finally{i.refCleanup=null,i=i.alternate,i!=null&&(i.refCleanup=null)}else if(typeof f=="function")try{f(null)}catch(v){vt(i,l,v)}else f.current=null}function hS(i){var l=i.type,f=i.memoizedProps,h=i.stateNode;try{e:switch(l){case"button":case"input":case"select":case"textarea":f.autoFocus&&h.focus();break e;case"img":f.src?h.src=f.src:f.srcSet&&(h.srcset=f.srcSet)}}catch(v){vt(i,i.return,v)}}function lm(i,l,f){try{var h=i.stateNode;TD(h,i.type,f,l),h[sn]=l}catch(v){vt(i,i.return,v)}}function mS(i){return i.tag===5||i.tag===3||i.tag===26||i.tag===27&&va(i.type)||i.tag===4}function um(i){e:for(;;){for(;i.sibling===null;){if(i.return===null||mS(i.return))return null;i=i.return}for(i.sibling.return=i.return,i=i.sibling;i.tag!==5&&i.tag!==6&&i.tag!==18;){if(i.tag===27&&va(i.type)||i.flags&2||i.child===null||i.tag===4)continue e;i.child.return=i,i=i.child}if(!(i.flags&2))return i.stateNode}}function cm(i,l,f){var h=i.tag;if(h===5||h===6)i=i.stateNode,l?(f.nodeType===9?f.body:f.nodeName==="HTML"?f.ownerDocument.body:f).insertBefore(i,l):(l=f.nodeType===9?f.body:f.nodeName==="HTML"?f.ownerDocument.body:f,l.appendChild(i),f=f._reactRootContainer,f!=null||l.onclick!==null||(l.onclick=ms));else if(h!==4&&(h===27&&va(i.type)&&(f=i.stateNode,l=null),i=i.child,i!==null))for(cm(i,l,f),i=i.sibling;i!==null;)cm(i,l,f),i=i.sibling}function ud(i,l,f){var h=i.tag;if(h===5||h===6)i=i.stateNode,l?f.insertBefore(i,l):f.appendChild(i);else if(h!==4&&(h===27&&va(i.type)&&(f=i.stateNode),i=i.child,i!==null))for(ud(i,l,f),i=i.sibling;i!==null;)ud(i,l,f),i=i.sibling}function gS(i){var l=i.stateNode,f=i.memoizedProps;try{for(var h=i.type,v=l.attributes;v.length;)l.removeAttributeNode(v[0]);Sn(l,h,f),l[Nt]=i,l[sn]=f}catch(b){vt(i,i.return,b)}}var As=!1,Qt=!1,dm=!1,yS=typeof WeakSet=="function"?WeakSet:Set,pn=null;function rD(i,l){if(i=i.containerInfo,Mm=Nd,i=Rw(i),sh(i)){if("selectionStart"in i)var f={start:i.selectionStart,end:i.selectionEnd};else e:{f=(f=i.ownerDocument)&&f.defaultView||window;var h=f.getSelection&&f.getSelection();if(h&&h.rangeCount!==0){f=h.anchorNode;var v=h.anchorOffset,b=h.focusNode;h=h.focusOffset;try{f.nodeType,b.nodeType}catch{f=null;break e}var R=0,L=-1,H=-1,Q=0,ae=0,ue=i,ne=null;t:for(;;){for(var re;ue!==f||v!==0&&ue.nodeType!==3||(L=R+v),ue!==b||h!==0&&ue.nodeType!==3||(H=R+h),ue.nodeType===3&&(R+=ue.nodeValue.length),(re=ue.firstChild)!==null;)ne=ue,ue=re;for(;;){if(ue===i)break t;if(ne===f&&++Q===v&&(L=R),ne===b&&++ae===h&&(H=R),(re=ue.nextSibling)!==null)break;ue=ne,ne=ue.parentNode}ue=re}f=L===-1||H===-1?null:{start:L,end:H}}else f=null}f=f||{start:0,end:0}}else f=null;for(km={focusedElem:i,selectionRange:f},Nd=!1,pn=l;pn!==null;)if(l=pn,i=l.child,(l.subtreeFlags&1028)!==0&&i!==null)i.return=l,pn=i;else for(;pn!==null;){switch(l=pn,b=l.alternate,i=l.flags,l.tag){case 0:if((i&4)!==0&&(i=l.updateQueue,i=i!==null?i.events:null,i!==null))for(f=0;f<i.length;f++)v=i[f],v.ref.impl=v.nextImpl;break;case 11:case 15:break;case 1:if((i&1024)!==0&&b!==null){i=void 0,f=l,v=b.memoizedProps,b=b.memoizedState,h=f.stateNode;try{var xe=hi(f.type,v);i=h.getSnapshotBeforeUpdate(xe,b),h.__reactInternalSnapshotBeforeUpdate=i}catch(qe){vt(f,f.return,qe)}}break;case 3:if((i&1024)!==0){if(i=l.stateNode.containerInfo,f=i.nodeType,f===9)Lm(i);else if(f===1)switch(i.nodeName){case"HEAD":case"HTML":case"BODY":Lm(i);break;default:i.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((i&1024)!==0)throw Error(r(163))}if(i=l.sibling,i!==null){i.return=l.return,pn=i;break}pn=l.return}}function _S(i,l,f){var h=f.flags;switch(f.tag){case 0:case 11:case 15:Cs(i,f),h&4&&Hl(5,f);break;case 1:if(Cs(i,f),h&4)if(i=f.stateNode,l===null)try{i.componentDidMount()}catch(R){vt(f,f.return,R)}else{var v=hi(f.type,l.memoizedProps);l=l.memoizedState;try{i.componentDidUpdate(v,l,i.__reactInternalSnapshotBeforeUpdate)}catch(R){vt(f,f.return,R)}}h&64&&fS(f),h&512&&zl(f,f.return);break;case 3:if(Cs(i,f),h&64&&(i=f.updateQueue,i!==null)){if(l=null,f.child!==null)switch(f.child.tag){case 27:case 5:l=f.child.stateNode;break;case 1:l=f.child.stateNode}try{nb(i,l)}catch(R){vt(f,f.return,R)}}break;case 27:l===null&&h&4&&gS(f);case 26:case 5:Cs(i,f),l===null&&h&4&&hS(f),h&512&&zl(f,f.return);break;case 12:Cs(i,f);break;case 31:Cs(i,f),h&4&&bS(i,f);break;case 13:Cs(i,f),h&4&&SS(i,f),h&64&&(i=f.memoizedState,i!==null&&(i=i.dehydrated,i!==null&&(f=fD.bind(null,f),MD(i,f))));break;case 22:if(h=f.memoizedState!==null||As,!h){l=l!==null&&l.memoizedState!==null||Qt,v=As;var b=Qt;As=h,(Qt=l)&&!b?Is(i,f,(f.subtreeFlags&8772)!==0):Cs(i,f),As=v,Qt=b}break;case 30:break;default:Cs(i,f)}}function vS(i){var l=i.alternate;l!==null&&(i.alternate=null,vS(l)),i.child=null,i.deletions=null,i.sibling=null,i.tag===5&&(l=i.stateNode,l!==null&&ei(l)),i.stateNode=null,i.return=null,i.dependencies=null,i.memoizedProps=null,i.memoizedState=null,i.pendingProps=null,i.stateNode=null,i.updateQueue=null}var Ot=null,Fn=!1;function Es(i,l,f){for(f=f.child;f!==null;)wS(i,l,f),f=f.sibling}function wS(i,l,f){if(_n&&typeof _n.onCommitFiberUnmount=="function")try{_n.onCommitFiberUnmount(Ks,f)}catch{}switch(f.tag){case 26:Qt||Wr(f,l),Es(i,l,f),f.memoizedState?f.memoizedState.count--:f.stateNode&&(f=f.stateNode,f.parentNode.removeChild(f));break;case 27:Qt||Wr(f,l);var h=Ot,v=Fn;va(f.type)&&(Ot=f.stateNode,Fn=!1),Es(i,l,f),Ql(f.stateNode),Ot=h,Fn=v;break;case 5:Qt||Wr(f,l);case 6:if(h=Ot,v=Fn,Ot=null,Es(i,l,f),Ot=h,Fn=v,Ot!==null)if(Fn)try{(Ot.nodeType===9?Ot.body:Ot.nodeName==="HTML"?Ot.ownerDocument.body:Ot).removeChild(f.stateNode)}catch(b){vt(f,l,b)}else try{Ot.removeChild(f.stateNode)}catch(b){vt(f,l,b)}break;case 18:Ot!==null&&(Fn?(i=Ot,fx(i.nodeType===9?i.body:i.nodeName==="HTML"?i.ownerDocument.body:i,f.stateNode),To(i)):fx(Ot,f.stateNode));break;case 4:h=Ot,v=Fn,Ot=f.stateNode.containerInfo,Fn=!0,Es(i,l,f),Ot=h,Fn=v;break;case 0:case 11:case 14:case 15:fa(2,f,l),Qt||fa(4,f,l),Es(i,l,f);break;case 1:Qt||(Wr(f,l),h=f.stateNode,typeof h.componentWillUnmount=="function"&&pS(f,l,h)),Es(i,l,f);break;case 21:Es(i,l,f);break;case 22:Qt=(h=Qt)||f.memoizedState!==null,Es(i,l,f),Qt=h;break;default:Es(i,l,f)}}function bS(i,l){if(l.memoizedState===null&&(i=l.alternate,i!==null&&(i=i.memoizedState,i!==null))){i=i.dehydrated;try{To(i)}catch(f){vt(l,l.return,f)}}}function SS(i,l){if(l.memoizedState===null&&(i=l.alternate,i!==null&&(i=i.memoizedState,i!==null&&(i=i.dehydrated,i!==null))))try{To(i)}catch(f){vt(l,l.return,f)}}function sD(i){switch(i.tag){case 31:case 13:case 19:var l=i.stateNode;return l===null&&(l=i.stateNode=new yS),l;case 22:return i=i.stateNode,l=i._retryCache,l===null&&(l=i._retryCache=new yS),l;default:throw Error(r(435,i.tag))}}function cd(i,l){var f=sD(i);l.forEach(function(h){if(!f.has(h)){f.add(h);var v=pD.bind(null,i,h);h.then(v,v)}})}function Bn(i,l){var f=l.deletions;if(f!==null)for(var h=0;h<f.length;h++){var v=f[h],b=i,R=l,L=R;e:for(;L!==null;){switch(L.tag){case 27:if(va(L.type)){Ot=L.stateNode,Fn=!1;break e}break;case 5:Ot=L.stateNode,Fn=!1;break e;case 3:case 4:Ot=L.stateNode.containerInfo,Fn=!0;break e}L=L.return}if(Ot===null)throw Error(r(160));wS(b,R,v),Ot=null,Fn=!1,b=v.alternate,b!==null&&(b.return=null),v.return=null}if(l.subtreeFlags&13886)for(l=l.child;l!==null;)xS(l,i),l=l.sibling}var Rr=null;function xS(i,l){var f=i.alternate,h=i.flags;switch(i.tag){case 0:case 11:case 14:case 15:Bn(l,i),qn(i),h&4&&(fa(3,i,i.return),Hl(3,i),fa(5,i,i.return));break;case 1:Bn(l,i),qn(i),h&512&&(Qt||f===null||Wr(f,f.return)),h&64&&As&&(i=i.updateQueue,i!==null&&(h=i.callbacks,h!==null&&(f=i.shared.hiddenCallbacks,i.shared.hiddenCallbacks=f===null?h:f.concat(h))));break;case 26:var v=Rr;if(Bn(l,i),qn(i),h&512&&(Qt||f===null||Wr(f,f.return)),h&4){var b=f!==null?f.memoizedState:null;if(h=i.memoizedState,f===null)if(h===null)if(i.stateNode===null){e:{h=i.type,f=i.memoizedProps,v=v.ownerDocument||v;t:switch(h){case"title":b=v.getElementsByTagName("title")[0],(!b||b[Zs]||b[Nt]||b.namespaceURI==="http://www.w3.org/2000/svg"||b.hasAttribute("itemprop"))&&(b=v.createElement(h),v.head.insertBefore(b,v.querySelector("head > title"))),Sn(b,h,f),b[Nt]=i,Kt(b),h=b;break e;case"link":var R=xx("link","href",v).get(h+(f.href||""));if(R){for(var L=0;L<R.length;L++)if(b=R[L],b.getAttribute("href")===(f.href==null||f.href===""?null:f.href)&&b.getAttribute("rel")===(f.rel==null?null:f.rel)&&b.getAttribute("title")===(f.title==null?null:f.title)&&b.getAttribute("crossorigin")===(f.crossOrigin==null?null:f.crossOrigin)){R.splice(L,1);break t}}b=v.createElement(h),Sn(b,h,f),v.head.appendChild(b);break;case"meta":if(R=xx("meta","content",v).get(h+(f.content||""))){for(L=0;L<R.length;L++)if(b=R[L],b.getAttribute("content")===(f.content==null?null:""+f.content)&&b.getAttribute("name")===(f.name==null?null:f.name)&&b.getAttribute("property")===(f.property==null?null:f.property)&&b.getAttribute("http-equiv")===(f.httpEquiv==null?null:f.httpEquiv)&&b.getAttribute("charset")===(f.charSet==null?null:f.charSet)){R.splice(L,1);break t}}b=v.createElement(h),Sn(b,h,f),v.head.appendChild(b);break;default:throw Error(r(468,h))}b[Nt]=i,Kt(b),h=b}i.stateNode=h}else Tx(v,i.type,i.stateNode);else i.stateNode=Sx(v,h,i.memoizedProps);else b!==h?(b===null?f.stateNode!==null&&(f=f.stateNode,f.parentNode.removeChild(f)):b.count--,h===null?Tx(v,i.type,i.stateNode):Sx(v,h,i.memoizedProps)):h===null&&i.stateNode!==null&&lm(i,i.memoizedProps,f.memoizedProps)}break;case 27:Bn(l,i),qn(i),h&512&&(Qt||f===null||Wr(f,f.return)),f!==null&&h&4&&lm(i,i.memoizedProps,f.memoizedProps);break;case 5:if(Bn(l,i),qn(i),h&512&&(Qt||f===null||Wr(f,f.return)),i.flags&32){v=i.stateNode;try{Vi(v,"")}catch(xe){vt(i,i.return,xe)}}h&4&&i.stateNode!=null&&(v=i.memoizedProps,lm(i,v,f!==null?f.memoizedProps:v)),h&1024&&(dm=!0);break;case 6:if(Bn(l,i),qn(i),h&4){if(i.stateNode===null)throw Error(r(162));h=i.memoizedProps,f=i.stateNode;try{f.nodeValue=h}catch(xe){vt(i,i.return,xe)}}break;case 3:if(Ed=null,v=Rr,Rr=Td(l.containerInfo),Bn(l,i),Rr=v,qn(i),h&4&&f!==null&&f.memoizedState.isDehydrated)try{To(l.containerInfo)}catch(xe){vt(i,i.return,xe)}dm&&(dm=!1,TS(i));break;case 4:h=Rr,Rr=Td(i.stateNode.containerInfo),Bn(l,i),qn(i),Rr=h;break;case 12:Bn(l,i),qn(i);break;case 31:Bn(l,i),qn(i),h&4&&(h=i.updateQueue,h!==null&&(i.updateQueue=null,cd(i,h)));break;case 13:Bn(l,i),qn(i),i.child.flags&8192&&i.memoizedState!==null!=(f!==null&&f.memoizedState!==null)&&(fd=_e()),h&4&&(h=i.updateQueue,h!==null&&(i.updateQueue=null,cd(i,h)));break;case 22:v=i.memoizedState!==null;var H=f!==null&&f.memoizedState!==null,Q=As,ae=Qt;if(As=Q||v,Qt=ae||H,Bn(l,i),Qt=ae,As=Q,qn(i),h&8192)e:for(l=i.stateNode,l._visibility=v?l._visibility&-2:l._visibility|1,v&&(f===null||H||As||Qt||mi(i)),f=null,l=i;;){if(l.tag===5||l.tag===26){if(f===null){H=f=l;try{if(b=H.stateNode,v)R=b.style,typeof R.setProperty=="function"?R.setProperty("display","none","important"):R.display="none";else{L=H.stateNode;var ue=H.memoizedProps.style,ne=ue!=null&&ue.hasOwnProperty("display")?ue.display:null;L.style.display=ne==null||typeof ne=="boolean"?"":(""+ne).trim()}}catch(xe){vt(H,H.return,xe)}}}else if(l.tag===6){if(f===null){H=l;try{H.stateNode.nodeValue=v?"":H.memoizedProps}catch(xe){vt(H,H.return,xe)}}}else if(l.tag===18){if(f===null){H=l;try{var re=H.stateNode;v?px(re,!0):px(H.stateNode,!1)}catch(xe){vt(H,H.return,xe)}}}else if((l.tag!==22&&l.tag!==23||l.memoizedState===null||l===i)&&l.child!==null){l.child.return=l,l=l.child;continue}if(l===i)break e;for(;l.sibling===null;){if(l.return===null||l.return===i)break e;f===l&&(f=null),l=l.return}f===l&&(f=null),l.sibling.return=l.return,l=l.sibling}h&4&&(h=i.updateQueue,h!==null&&(f=h.retryQueue,f!==null&&(h.retryQueue=null,cd(i,f))));break;case 19:Bn(l,i),qn(i),h&4&&(h=i.updateQueue,h!==null&&(i.updateQueue=null,cd(i,h)));break;case 30:break;case 21:break;default:Bn(l,i),qn(i)}}function qn(i){var l=i.flags;if(l&2){try{for(var f,h=i.return;h!==null;){if(mS(h)){f=h;break}h=h.return}if(f==null)throw Error(r(160));switch(f.tag){case 27:var v=f.stateNode,b=um(i);ud(i,b,v);break;case 5:var R=f.stateNode;f.flags&32&&(Vi(R,""),f.flags&=-33);var L=um(i);ud(i,L,R);break;case 3:case 4:var H=f.stateNode.containerInfo,Q=um(i);cm(i,Q,H);break;default:throw Error(r(161))}}catch(ae){vt(i,i.return,ae)}i.flags&=-3}l&4096&&(i.flags&=-4097)}function TS(i){if(i.subtreeFlags&1024)for(i=i.child;i!==null;){var l=i;TS(l),l.tag===5&&l.flags&1024&&l.stateNode.reset(),i=i.sibling}}function Cs(i,l){if(l.subtreeFlags&8772)for(l=l.child;l!==null;)_S(i,l.alternate,l),l=l.sibling}function mi(i){for(i=i.child;i!==null;){var l=i;switch(l.tag){case 0:case 11:case 14:case 15:fa(4,l,l.return),mi(l);break;case 1:Wr(l,l.return);var f=l.stateNode;typeof f.componentWillUnmount=="function"&&pS(l,l.return,f),mi(l);break;case 27:Ql(l.stateNode);case 26:case 5:Wr(l,l.return),mi(l);break;case 22:l.memoizedState===null&&mi(l);break;case 30:mi(l);break;default:mi(l)}i=i.sibling}}function Is(i,l,f){for(f=f&&(l.subtreeFlags&8772)!==0,l=l.child;l!==null;){var h=l.alternate,v=i,b=l,R=b.flags;switch(b.tag){case 0:case 11:case 15:Is(v,b,f),Hl(4,b);break;case 1:if(Is(v,b,f),h=b,v=h.stateNode,typeof v.componentDidMount=="function")try{v.componentDidMount()}catch(Q){vt(h,h.return,Q)}if(h=b,v=h.updateQueue,v!==null){var L=h.stateNode;try{var H=v.shared.hiddenCallbacks;if(H!==null)for(v.shared.hiddenCallbacks=null,v=0;v<H.length;v++)tb(H[v],L)}catch(Q){vt(h,h.return,Q)}}f&&R&64&&fS(b),zl(b,b.return);break;case 27:gS(b);case 26:case 5:Is(v,b,f),f&&h===null&&R&4&&hS(b),zl(b,b.return);break;case 12:Is(v,b,f);break;case 31:Is(v,b,f),f&&R&4&&bS(v,b);break;case 13:Is(v,b,f),f&&R&4&&SS(v,b);break;case 22:b.memoizedState===null&&Is(v,b,f),zl(b,b.return);break;case 30:break;default:Is(v,b,f)}l=l.sibling}}function fm(i,l){var f=null;i!==null&&i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(f=i.memoizedState.cachePool.pool),i=null,l.memoizedState!==null&&l.memoizedState.cachePool!==null&&(i=l.memoizedState.cachePool.pool),i!==f&&(i!=null&&i.refCount++,f!=null&&Nl(f))}function pm(i,l){i=null,l.alternate!==null&&(i=l.alternate.memoizedState.cache),l=l.memoizedState.cache,l!==i&&(l.refCount++,i!=null&&Nl(i))}function Nr(i,l,f,h){if(l.subtreeFlags&10256)for(l=l.child;l!==null;)AS(i,l,f,h),l=l.sibling}function AS(i,l,f,h){var v=l.flags;switch(l.tag){case 0:case 11:case 15:Nr(i,l,f,h),v&2048&&Hl(9,l);break;case 1:Nr(i,l,f,h);break;case 3:Nr(i,l,f,h),v&2048&&(i=null,l.alternate!==null&&(i=l.alternate.memoizedState.cache),l=l.memoizedState.cache,l!==i&&(l.refCount++,i!=null&&Nl(i)));break;case 12:if(v&2048){Nr(i,l,f,h),i=l.stateNode;try{var b=l.memoizedProps,R=b.id,L=b.onPostCommit;typeof L=="function"&&L(R,l.alternate===null?"mount":"update",i.passiveEffectDuration,-0)}catch(H){vt(l,l.return,H)}}else Nr(i,l,f,h);break;case 31:Nr(i,l,f,h);break;case 13:Nr(i,l,f,h);break;case 23:break;case 22:b=l.stateNode,R=l.alternate,l.memoizedState!==null?b._visibility&2?Nr(i,l,f,h):jl(i,l):b._visibility&2?Nr(i,l,f,h):(b._visibility|=2,po(i,l,f,h,(l.subtreeFlags&10256)!==0||!1)),v&2048&&fm(R,l);break;case 24:Nr(i,l,f,h),v&2048&&pm(l.alternate,l);break;default:Nr(i,l,f,h)}}function po(i,l,f,h,v){for(v=v&&((l.subtreeFlags&10256)!==0||!1),l=l.child;l!==null;){var b=i,R=l,L=f,H=h,Q=R.flags;switch(R.tag){case 0:case 11:case 15:po(b,R,L,H,v),Hl(8,R);break;case 23:break;case 22:var ae=R.stateNode;R.memoizedState!==null?ae._visibility&2?po(b,R,L,H,v):jl(b,R):(ae._visibility|=2,po(b,R,L,H,v)),v&&Q&2048&&fm(R.alternate,R);break;case 24:po(b,R,L,H,v),v&&Q&2048&&pm(R.alternate,R);break;default:po(b,R,L,H,v)}l=l.sibling}}function jl(i,l){if(l.subtreeFlags&10256)for(l=l.child;l!==null;){var f=i,h=l,v=h.flags;switch(h.tag){case 22:jl(f,h),v&2048&&fm(h.alternate,h);break;case 24:jl(f,h),v&2048&&pm(h.alternate,h);break;default:jl(f,h)}l=l.sibling}}var Vl=8192;function ho(i,l,f){if(i.subtreeFlags&Vl)for(i=i.child;i!==null;)ES(i,l,f),i=i.sibling}function ES(i,l,f){switch(i.tag){case 26:ho(i,l,f),i.flags&Vl&&i.memoizedState!==null&&zD(f,Rr,i.memoizedState,i.memoizedProps);break;case 5:ho(i,l,f);break;case 3:case 4:var h=Rr;Rr=Td(i.stateNode.containerInfo),ho(i,l,f),Rr=h;break;case 22:i.memoizedState===null&&(h=i.alternate,h!==null&&h.memoizedState!==null?(h=Vl,Vl=16777216,ho(i,l,f),Vl=h):ho(i,l,f));break;default:ho(i,l,f)}}function CS(i){var l=i.alternate;if(l!==null&&(i=l.child,i!==null)){l.child=null;do l=i.sibling,i.sibling=null,i=l;while(i!==null)}}function Jl(i){var l=i.deletions;if((i.flags&16)!==0){if(l!==null)for(var f=0;f<l.length;f++){var h=l[f];pn=h,RS(h,i)}CS(i)}if(i.subtreeFlags&10256)for(i=i.child;i!==null;)IS(i),i=i.sibling}function IS(i){switch(i.tag){case 0:case 11:case 15:Jl(i),i.flags&2048&&fa(9,i,i.return);break;case 3:Jl(i);break;case 12:Jl(i);break;case 22:var l=i.stateNode;i.memoizedState!==null&&l._visibility&2&&(i.return===null||i.return.tag!==13)?(l._visibility&=-3,dd(i)):Jl(i);break;default:Jl(i)}}function dd(i){var l=i.deletions;if((i.flags&16)!==0){if(l!==null)for(var f=0;f<l.length;f++){var h=l[f];pn=h,RS(h,i)}CS(i)}for(i=i.child;i!==null;){switch(l=i,l.tag){case 0:case 11:case 15:fa(8,l,l.return),dd(l);break;case 22:f=l.stateNode,f._visibility&2&&(f._visibility&=-3,dd(l));break;default:dd(l)}i=i.sibling}}function RS(i,l){for(;pn!==null;){var f=pn;switch(f.tag){case 0:case 11:case 15:fa(8,f,l);break;case 23:case 22:if(f.memoizedState!==null&&f.memoizedState.cachePool!==null){var h=f.memoizedState.cachePool.pool;h!=null&&h.refCount++}break;case 24:Nl(f.memoizedState.cache)}if(h=f.child,h!==null)h.return=f,pn=h;else e:for(f=i;pn!==null;){h=pn;var v=h.sibling,b=h.return;if(vS(h),h===f){pn=null;break e}if(v!==null){v.return=b,pn=v;break e}pn=b}}}var aD={getCacheForType:function(i){var l=wn(Wt),f=l.data.get(i);return f===void 0&&(f=i(),l.data.set(i,f)),f},cacheSignal:function(){return wn(Wt).controller.signal}},iD=typeof WeakMap=="function"?WeakMap:Map,mt=0,It=null,rt=null,at=0,_t=0,Qn=null,pa=!1,mo=!1,hm=!1,Rs=0,Gt=0,ha=0,gi=0,mm=0,er=0,go=0,Yl=null,Gn=null,gm=!1,fd=0,NS=0,pd=1/0,hd=null,ma=null,an=0,ga=null,yo=null,Ns=0,ym=0,_m=null,PS=null,Kl=0,vm=null;function tr(){return(mt&2)!==0&&at!==0?at&-at:B.T!==null?Am():pe()}function MS(){if(er===0)if((at&536870912)===0||ot){var i=qi;qi<<=1,(qi&3932160)===0&&(qi=262144),er=i}else er=536870912;return i=Zn.current,i!==null&&(i.flags|=32),er}function Hn(i,l,f){(i===It&&(_t===2||_t===9)||i.cancelPendingCommit!==null)&&(_o(i,0),ya(i,at,er,!1)),Xa(i,f),((mt&2)===0||i!==It)&&(i===It&&((mt&2)===0&&(gi|=f),Gt===4&&ya(i,at,er,!1)),Zr(i))}function kS(i,l,f){if((mt&6)!==0)throw Error(r(327));var h=!f&&(l&127)===0&&(l&i.expiredLanes)===0||Za(i,l),v=h?uD(i,l):bm(i,l,!0),b=h;do{if(v===0){mo&&!h&&ya(i,l,0,!1);break}else{if(f=i.current.alternate,b&&!oD(f)){v=bm(i,l,!1),b=!1;continue}if(v===2){if(b=l,i.errorRecoveryDisabledLanes&b)var R=0;else R=i.pendingLanes&-536870913,R=R!==0?R:R&536870912?536870912:0;if(R!==0){l=R;e:{var L=i;v=Yl;var H=L.current.memoizedState.isDehydrated;if(H&&(_o(L,R).flags|=256),R=bm(L,R,!1),R!==2){if(hm&&!H){L.errorRecoveryDisabledLanes|=b,gi|=b,v=4;break e}b=Gn,Gn=v,b!==null&&(Gn===null?Gn=b:Gn.push.apply(Gn,b))}v=R}if(b=!1,v!==2)continue}}if(v===1){_o(i,0),ya(i,l,0,!0);break}e:{switch(h=i,b=v,b){case 0:case 1:throw Error(r(345));case 4:if((l&4194048)!==l)break;case 6:ya(h,l,er,!pa);break e;case 2:Gn=null;break;case 3:case 5:break;default:throw Error(r(329))}if((l&62914560)===l&&(v=fd+300-_e(),10<v)){if(ya(h,l,er,!pa),Gi(h,0,!0)!==0)break e;Ns=l,h.timeoutHandle=cx(OS.bind(null,h,f,Gn,hd,gm,l,er,gi,go,pa,b,"Throttled",-0,0),v);break e}OS(h,f,Gn,hd,gm,l,er,gi,go,pa,b,null,-0,0)}}break}while(!0);Zr(i)}function OS(i,l,f,h,v,b,R,L,H,Q,ae,ue,ne,re){if(i.timeoutHandle=-1,ue=l.subtreeFlags,ue&8192||(ue&16785408)===16785408){ue={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:ms},ES(l,b,ue);var xe=(b&62914560)===b?fd-_e():(b&4194048)===b?NS-_e():0;if(xe=jD(ue,xe),xe!==null){Ns=b,i.cancelPendingCommit=xe(GS.bind(null,i,l,b,f,h,v,R,L,H,ae,ue,null,ne,re)),ya(i,b,R,!Q);return}}GS(i,l,b,f,h,v,R,L,H)}function oD(i){for(var l=i;;){var f=l.tag;if((f===0||f===11||f===15)&&l.flags&16384&&(f=l.updateQueue,f!==null&&(f=f.stores,f!==null)))for(var h=0;h<f.length;h++){var v=f[h],b=v.getSnapshot;v=v.value;try{if(!Kn(b(),v))return!1}catch{return!1}}if(f=l.child,l.subtreeFlags&16384&&f!==null)f.return=l,l=f;else{if(l===i)break;for(;l.sibling===null;){if(l.return===null||l.return===i)return!0;l=l.return}l.sibling.return=l.return,l=l.sibling}}return!0}function ya(i,l,f,h){l&=~mm,l&=~gi,i.suspendedLanes|=l,i.pingedLanes&=~l,h&&(i.warmLanes|=l),h=i.expirationTimes;for(var v=l;0<v;){var b=31-Pn(v),R=1<<b;h[b]=-1,v&=~R}f!==0&&yl(i,f,l)}function md(){return(mt&6)===0?(Wl(0),!1):!0}function wm(){if(rt!==null){if(_t===0)var i=rt.return;else i=rt,vs=oi=null,Lh(i),oo=null,Ml=0,i=rt;for(;i!==null;)dS(i.alternate,i),i=i.return;rt=null}}function _o(i,l){var f=i.timeoutHandle;f!==-1&&(i.timeoutHandle=-1,CD(f)),f=i.cancelPendingCommit,f!==null&&(i.cancelPendingCommit=null,f()),Ns=0,wm(),It=i,rt=f=ys(i.current,null),at=l,_t=0,Qn=null,pa=!1,mo=Za(i,l),hm=!1,go=er=mm=gi=ha=Gt=0,Gn=Yl=null,gm=!1,(l&8)!==0&&(l|=l&32);var h=i.entangledLanes;if(h!==0)for(i=i.entanglements,h&=l;0<h;){var v=31-Pn(h),b=1<<v;l|=i[v],h&=~b}return Rs=l,Lc(),f}function DS(i,l){Qe=null,B.H=Bl,l===io||l===zc?(l=Zw(),_t=3):l===Th?(l=Zw(),_t=4):_t=l===Xh?8:l!==null&&typeof l=="object"&&typeof l.then=="function"?6:1,Qn=l,rt===null&&(Gt=1,sd(i,pr(l,i.current)))}function LS(){var i=Zn.current;return i===null?!0:(at&4194048)===at?yr===null:(at&62914560)===at||(at&536870912)!==0?i===yr:!1}function $S(){var i=B.H;return B.H=Bl,i===null?Bl:i}function US(){var i=B.A;return B.A=aD,i}function gd(){Gt=4,pa||(at&4194048)!==at&&Zn.current!==null||(mo=!0),(ha&134217727)===0&&(gi&134217727)===0||It===null||ya(It,at,er,!1)}function bm(i,l,f){var h=mt;mt|=2;var v=$S(),b=US();(It!==i||at!==l)&&(hd=null,_o(i,l)),l=!1;var R=Gt;e:do try{if(_t!==0&&rt!==null){var L=rt,H=Qn;switch(_t){case 8:wm(),R=6;break e;case 3:case 2:case 9:case 6:Zn.current===null&&(l=!0);var Q=_t;if(_t=0,Qn=null,vo(i,L,H,Q),f&&mo){R=0;break e}break;default:Q=_t,_t=0,Qn=null,vo(i,L,H,Q)}}lD(),R=Gt;break}catch(ae){DS(i,ae)}while(!0);return l&&i.shellSuspendCounter++,vs=oi=null,mt=h,B.H=v,B.A=b,rt===null&&(It=null,at=0,Lc()),R}function lD(){for(;rt!==null;)FS(rt)}function uD(i,l){var f=mt;mt|=2;var h=$S(),v=US();It!==i||at!==l?(hd=null,pd=_e()+500,_o(i,l)):mo=Za(i,l);e:do try{if(_t!==0&&rt!==null){l=rt;var b=Qn;t:switch(_t){case 1:_t=0,Qn=null,vo(i,l,b,1);break;case 2:case 9:if(Kw(b)){_t=0,Qn=null,BS(l);break}l=function(){_t!==2&&_t!==9||It!==i||(_t=7),Zr(i)},b.then(l,l);break e;case 3:_t=7;break e;case 4:_t=5;break e;case 7:Kw(b)?(_t=0,Qn=null,BS(l)):(_t=0,Qn=null,vo(i,l,b,7));break;case 5:var R=null;switch(rt.tag){case 26:R=rt.memoizedState;case 5:case 27:var L=rt;if(R?Ax(R):L.stateNode.complete){_t=0,Qn=null;var H=L.sibling;if(H!==null)rt=H;else{var Q=L.return;Q!==null?(rt=Q,yd(Q)):rt=null}break t}}_t=0,Qn=null,vo(i,l,b,5);break;case 6:_t=0,Qn=null,vo(i,l,b,6);break;case 8:wm(),Gt=6;break e;default:throw Error(r(462))}}cD();break}catch(ae){DS(i,ae)}while(!0);return vs=oi=null,B.H=h,B.A=v,mt=f,rt!==null?0:(It=null,at=0,Lc(),Gt)}function cD(){for(;rt!==null&&!Ee();)FS(rt)}function FS(i){var l=uS(i.alternate,i,Rs);i.memoizedProps=i.pendingProps,l===null?yd(i):rt=l}function BS(i){var l=i,f=l.alternate;switch(l.tag){case 15:case 0:l=rS(f,l,l.pendingProps,l.type,void 0,at);break;case 11:l=rS(f,l,l.pendingProps,l.type.render,l.ref,at);break;case 5:Lh(l);default:dS(f,l),l=rt=Uw(l,Rs),l=uS(f,l,Rs)}i.memoizedProps=i.pendingProps,l===null?yd(i):rt=l}function vo(i,l,f,h){vs=oi=null,Lh(l),oo=null,Ml=0;var v=l.return;try{if(XO(i,v,l,f,at)){Gt=1,sd(i,pr(f,i.current)),rt=null;return}}catch(b){if(v!==null)throw rt=v,b;Gt=1,sd(i,pr(f,i.current)),rt=null;return}l.flags&32768?(ot||h===1?i=!0:mo||(at&536870912)!==0?i=!1:(pa=i=!0,(h===2||h===9||h===3||h===6)&&(h=Zn.current,h!==null&&h.tag===13&&(h.flags|=16384))),qS(l,i)):yd(l)}function yd(i){var l=i;do{if((l.flags&32768)!==0){qS(l,pa);return}i=l.return;var f=tD(l.alternate,l,Rs);if(f!==null){rt=f;return}if(l=l.sibling,l!==null){rt=l;return}rt=l=i}while(l!==null);Gt===0&&(Gt=5)}function qS(i,l){do{var f=nD(i.alternate,i);if(f!==null){f.flags&=32767,rt=f;return}if(f=i.return,f!==null&&(f.flags|=32768,f.subtreeFlags=0,f.deletions=null),!l&&(i=i.sibling,i!==null)){rt=i;return}rt=i=f}while(i!==null);Gt=6,rt=null}function GS(i,l,f,h,v,b,R,L,H){i.cancelPendingCommit=null;do _d();while(an!==0);if((mt&6)!==0)throw Error(r(327));if(l!==null){if(l===i.current)throw Error(r(177));if(b=l.lanes|l.childLanes,b|=uh,qp(i,f,b,R,L,H),i===It&&(rt=It=null,at=0),yo=l,ga=i,Ns=f,ym=b,_m=v,PS=h,(l.subtreeFlags&10256)!==0||(l.flags&10256)!==0?(i.callbackNode=null,i.callbackPriority=0,hD(De,function(){return JS(),null})):(i.callbackNode=null,i.callbackPriority=0),h=(l.flags&13878)!==0,(l.subtreeFlags&13878)!==0||h){h=B.T,B.T=null,v=G.p,G.p=2,R=mt,mt|=4;try{rD(i,l,f)}finally{mt=R,G.p=v,B.T=h}}an=1,HS(),zS(),jS()}}function HS(){if(an===1){an=0;var i=ga,l=yo,f=(l.flags&13878)!==0;if((l.subtreeFlags&13878)!==0||f){f=B.T,B.T=null;var h=G.p;G.p=2;var v=mt;mt|=4;try{xS(l,i);var b=km,R=Rw(i.containerInfo),L=b.focusedElem,H=b.selectionRange;if(R!==L&&L&&L.ownerDocument&&Iw(L.ownerDocument.documentElement,L)){if(H!==null&&sh(L)){var Q=H.start,ae=H.end;if(ae===void 0&&(ae=Q),"selectionStart"in L)L.selectionStart=Q,L.selectionEnd=Math.min(ae,L.value.length);else{var ue=L.ownerDocument||document,ne=ue&&ue.defaultView||window;if(ne.getSelection){var re=ne.getSelection(),xe=L.textContent.length,qe=Math.min(H.start,xe),Tt=H.end===void 0?qe:Math.min(H.end,xe);!re.extend&&qe>Tt&&(R=Tt,Tt=qe,qe=R);var Y=Cw(L,qe),J=Cw(L,Tt);if(Y&&J&&(re.rangeCount!==1||re.anchorNode!==Y.node||re.anchorOffset!==Y.offset||re.focusNode!==J.node||re.focusOffset!==J.offset)){var X=ue.createRange();X.setStart(Y.node,Y.offset),re.removeAllRanges(),qe>Tt?(re.addRange(X),re.extend(J.node,J.offset)):(X.setEnd(J.node,J.offset),re.addRange(X))}}}}for(ue=[],re=L;re=re.parentNode;)re.nodeType===1&&ue.push({element:re,left:re.scrollLeft,top:re.scrollTop});for(typeof L.focus=="function"&&L.focus(),L=0;L<ue.length;L++){var oe=ue[L];oe.element.scrollLeft=oe.left,oe.element.scrollTop=oe.top}}Nd=!!Mm,km=Mm=null}finally{mt=v,G.p=h,B.T=f}}i.current=l,an=2}}function zS(){if(an===2){an=0;var i=ga,l=yo,f=(l.flags&8772)!==0;if((l.subtreeFlags&8772)!==0||f){f=B.T,B.T=null;var h=G.p;G.p=2;var v=mt;mt|=4;try{_S(i,l.alternate,l)}finally{mt=v,G.p=h,B.T=f}}an=3}}function jS(){if(an===4||an===3){an=0,Ce();var i=ga,l=yo,f=Ns,h=PS;(l.subtreeFlags&10256)!==0||(l.flags&10256)!==0?an=5:(an=0,yo=ga=null,VS(i,i.pendingLanes));var v=i.pendingLanes;if(v===0&&(ma=null),Hi(f),l=l.stateNode,_n&&typeof _n.onCommitFiberRoot=="function")try{_n.onCommitFiberRoot(Ks,l,void 0,(l.current.flags&128)===128)}catch{}if(h!==null){l=B.T,v=G.p,G.p=2,B.T=null;try{for(var b=i.onRecoverableError,R=0;R<h.length;R++){var L=h[R];b(L.value,{componentStack:L.stack})}}finally{B.T=l,G.p=v}}(Ns&3)!==0&&_d(),Zr(i),v=i.pendingLanes,(f&261930)!==0&&(v&42)!==0?i===vm?Kl++:(Kl=0,vm=i):Kl=0,Wl(0)}}function VS(i,l){(i.pooledCacheLanes&=l)===0&&(l=i.pooledCache,l!=null&&(i.pooledCache=null,Nl(l)))}function _d(){return HS(),zS(),jS(),JS()}function JS(){if(an!==5)return!1;var i=ga,l=ym;ym=0;var f=Hi(Ns),h=B.T,v=G.p;try{G.p=32>f?32:f,B.T=null,f=_m,_m=null;var b=ga,R=Ns;if(an=0,yo=ga=null,Ns=0,(mt&6)!==0)throw Error(r(331));var L=mt;if(mt|=4,IS(b.current),AS(b,b.current,R,f),mt=L,Wl(0,!1),_n&&typeof _n.onPostCommitFiberRoot=="function")try{_n.onPostCommitFiberRoot(Ks,b)}catch{}return!0}finally{G.p=v,B.T=h,VS(i,l)}}function YS(i,l,f){l=pr(f,l),l=Zh(i.stateNode,l,2),i=ua(i,l,2),i!==null&&(Xa(i,2),Zr(i))}function vt(i,l,f){if(i.tag===3)YS(i,i,f);else for(;l!==null;){if(l.tag===3){YS(l,i,f);break}else if(l.tag===1){var h=l.stateNode;if(typeof l.type.getDerivedStateFromError=="function"||typeof h.componentDidCatch=="function"&&(ma===null||!ma.has(h))){i=pr(f,i),f=Kb(2),h=ua(l,f,2),h!==null&&(Wb(f,h,l,i),Xa(h,2),Zr(h));break}}l=l.return}}function Sm(i,l,f){var h=i.pingCache;if(h===null){h=i.pingCache=new iD;var v=new Set;h.set(l,v)}else v=h.get(l),v===void 0&&(v=new Set,h.set(l,v));v.has(f)||(hm=!0,v.add(f),i=dD.bind(null,i,l,f),l.then(i,i))}function dD(i,l,f){var h=i.pingCache;h!==null&&h.delete(l),i.pingedLanes|=i.suspendedLanes&f,i.warmLanes&=~f,It===i&&(at&f)===f&&(Gt===4||Gt===3&&(at&62914560)===at&&300>_e()-fd?(mt&2)===0&&_o(i,0):mm|=f,go===at&&(go=0)),Zr(i)}function KS(i,l){l===0&&(l=wc()),i=si(i,l),i!==null&&(Xa(i,l),Zr(i))}function fD(i){var l=i.memoizedState,f=0;l!==null&&(f=l.retryLane),KS(i,f)}function pD(i,l){var f=0;switch(i.tag){case 31:case 13:var h=i.stateNode,v=i.memoizedState;v!==null&&(f=v.retryLane);break;case 19:h=i.stateNode;break;case 22:h=i.stateNode._retryCache;break;default:throw Error(r(314))}h!==null&&h.delete(l),KS(i,f)}function hD(i,l){return ge(i,l)}var vd=null,wo=null,xm=!1,wd=!1,Tm=!1,_a=0;function Zr(i){i!==wo&&i.next===null&&(wo===null?vd=wo=i:wo=wo.next=i),wd=!0,xm||(xm=!0,gD())}function Wl(i,l){if(!Tm&&wd){Tm=!0;do for(var f=!1,h=vd;h!==null;){if(i!==0){var v=h.pendingLanes;if(v===0)var b=0;else{var R=h.suspendedLanes,L=h.pingedLanes;b=(1<<31-Pn(42|i)+1)-1,b&=v&~(R&~L),b=b&201326741?b&201326741|1:b?b|2:0}b!==0&&(f=!0,QS(h,b))}else b=at,b=Gi(h,h===It?b:0,h.cancelPendingCommit!==null||h.timeoutHandle!==-1),(b&3)===0||Za(h,b)||(f=!0,QS(h,b));h=h.next}while(f);Tm=!1}}function mD(){WS()}function WS(){wd=xm=!1;var i=0;_a!==0&&ED()&&(i=_a);for(var l=_e(),f=null,h=vd;h!==null;){var v=h.next,b=ZS(h,l);b===0?(h.next=null,f===null?vd=v:f.next=v,v===null&&(wo=f)):(f=h,(i!==0||(b&3)!==0)&&(wd=!0)),h=v}an!==0&&an!==5||Wl(i),_a!==0&&(_a=0)}function ZS(i,l){for(var f=i.suspendedLanes,h=i.pingedLanes,v=i.expirationTimes,b=i.pendingLanes&-62914561;0<b;){var R=31-Pn(b),L=1<<R,H=v[R];H===-1?((L&f)===0||(L&h)!==0)&&(v[R]=Bp(L,l)):H<=l&&(i.expiredLanes|=L),b&=~L}if(l=It,f=at,f=Gi(i,i===l?f:0,i.cancelPendingCommit!==null||i.timeoutHandle!==-1),h=i.callbackNode,f===0||i===l&&(_t===2||_t===9)||i.cancelPendingCommit!==null)return h!==null&&h!==null&&Ct(h),i.callbackNode=null,i.callbackPriority=0;if((f&3)===0||Za(i,f)){if(l=f&-f,l===i.callbackPriority)return l;switch(h!==null&&Ct(h),Hi(f)){case 2:case 8:f=Be;break;case 32:f=De;break;case 268435456:f=fs;break;default:f=De}return h=XS.bind(null,i),f=ge(f,h),i.callbackPriority=l,i.callbackNode=f,l}return h!==null&&h!==null&&Ct(h),i.callbackPriority=2,i.callbackNode=null,2}function XS(i,l){if(an!==0&&an!==5)return i.callbackNode=null,i.callbackPriority=0,null;var f=i.callbackNode;if(_d()&&i.callbackNode!==f)return null;var h=at;return h=Gi(i,i===It?h:0,i.cancelPendingCommit!==null||i.timeoutHandle!==-1),h===0?null:(kS(i,h,l),ZS(i,_e()),i.callbackNode!=null&&i.callbackNode===f?XS.bind(null,i):null)}function QS(i,l){if(_d())return null;kS(i,l,!0)}function gD(){ID(function(){(mt&6)!==0?ge(ye,mD):WS()})}function Am(){if(_a===0){var i=so;i===0&&(i=Bi,Bi<<=1,(Bi&261888)===0&&(Bi=256)),_a=i}return _a}function ex(i){return i==null||typeof i=="symbol"||typeof i=="boolean"?null:typeof i=="function"?i:Ic(""+i)}function tx(i,l){var f=l.ownerDocument.createElement("input");return f.name=l.name,f.value=l.value,i.id&&f.setAttribute("form",i.id),l.parentNode.insertBefore(f,l),i=new FormData(i),f.parentNode.removeChild(f),i}function yD(i,l,f,h,v){if(l==="submit"&&f&&f.stateNode===v){var b=ex((v[sn]||null).action),R=h.submitter;R&&(l=(l=R[sn]||null)?ex(l.formAction):R.getAttribute("formAction"),l!==null&&(b=l,R=null));var L=new Mc("action","action",null,h,v);i.push({event:L,listeners:[{instance:null,listener:function(){if(h.defaultPrevented){if(_a!==0){var H=R?tx(v,R):new FormData(v);jh(f,{pending:!0,data:H,method:v.method,action:b},null,H)}}else typeof b=="function"&&(L.preventDefault(),H=R?tx(v,R):new FormData(v),jh(f,{pending:!0,data:H,method:v.method,action:b},b,H))},currentTarget:v}]})}}for(var Em=0;Em<lh.length;Em++){var Cm=lh[Em],_D=Cm.toLowerCase(),vD=Cm[0].toUpperCase()+Cm.slice(1);Ir(_D,"on"+vD)}Ir(Mw,"onAnimationEnd"),Ir(kw,"onAnimationIteration"),Ir(Ow,"onAnimationStart"),Ir("dblclick","onDoubleClick"),Ir("focusin","onFocus"),Ir("focusout","onBlur"),Ir(DO,"onTransitionRun"),Ir(LO,"onTransitionStart"),Ir($O,"onTransitionCancel"),Ir(Dw,"onTransitionEnd"),zi("onMouseEnter",["mouseout","mouseover"]),zi("onMouseLeave",["mouseout","mouseover"]),zi("onPointerEnter",["pointerout","pointerover"]),zi("onPointerLeave",["pointerout","pointerover"]),Bt("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Bt("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Bt("onBeforeInput",["compositionend","keypress","textInput","paste"]),Bt("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Bt("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Bt("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Zl="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),wD=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(Zl));function nx(i,l){l=(l&4)!==0;for(var f=0;f<i.length;f++){var h=i[f],v=h.event;h=h.listeners;e:{var b=void 0;if(l)for(var R=h.length-1;0<=R;R--){var L=h[R],H=L.instance,Q=L.currentTarget;if(L=L.listener,H!==b&&v.isPropagationStopped())break e;b=L,v.currentTarget=Q;try{b(v)}catch(ae){Dc(ae)}v.currentTarget=null,b=H}else for(R=0;R<h.length;R++){if(L=h[R],H=L.instance,Q=L.currentTarget,L=L.listener,H!==b&&v.isPropagationStopped())break e;b=L,v.currentTarget=Q;try{b(v)}catch(ae){Dc(ae)}v.currentTarget=null,b=H}}}}function st(i,l){var f=l[Ws];f===void 0&&(f=l[Ws]=new Set);var h=i+"__bubble";f.has(h)||(rx(l,i,2,!1),f.add(h))}function Im(i,l,f){var h=0;l&&(h|=4),rx(f,i,h,l)}var bd="_reactListening"+Math.random().toString(36).slice(2);function Rm(i){if(!i[bd]){i[bd]=!0,xc.forEach(function(f){f!=="selectionchange"&&(wD.has(f)||Im(f,!1,i),Im(f,!0,i))});var l=i.nodeType===9?i:i.ownerDocument;l===null||l[bd]||(l[bd]=!0,Im("selectionchange",!1,l))}}function rx(i,l,f,h){switch(Mx(l)){case 2:var v=YD;break;case 8:v=KD;break;default:v=zm}f=v.bind(null,l,f,i),v=void 0,!Kp||l!=="touchstart"&&l!=="touchmove"&&l!=="wheel"||(v=!0),h?v!==void 0?i.addEventListener(l,f,{capture:!0,passive:v}):i.addEventListener(l,f,!0):v!==void 0?i.addEventListener(l,f,{passive:v}):i.addEventListener(l,f,!1)}function Nm(i,l,f,h,v){var b=h;if((l&1)===0&&(l&2)===0&&h!==null)e:for(;;){if(h===null)return;var R=h.tag;if(R===3||R===4){var L=h.stateNode.containerInfo;if(L===v)break;if(R===4)for(R=h.return;R!==null;){var H=R.tag;if((H===3||H===4)&&R.stateNode.containerInfo===v)return;R=R.return}for(;L!==null;){if(R=Xs(L),R===null)return;if(H=R.tag,H===5||H===6||H===26||H===27){h=b=R;continue e}L=L.parentNode}}h=h.return}lw(function(){var Q=b,ae=Jp(f),ue=[];e:{var ne=Lw.get(i);if(ne!==void 0){var re=Mc,xe=i;switch(i){case"keypress":if(Nc(f)===0)break e;case"keydown":case"keyup":re=pO;break;case"focusin":xe="focus",re=Qp;break;case"focusout":xe="blur",re=Qp;break;case"beforeblur":case"afterblur":re=Qp;break;case"click":if(f.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":re=dw;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":re=tO;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":re=gO;break;case Mw:case kw:case Ow:re=sO;break;case Dw:re=_O;break;case"scroll":case"scrollend":re=Qk;break;case"wheel":re=wO;break;case"copy":case"cut":case"paste":re=iO;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":re=pw;break;case"toggle":case"beforetoggle":re=SO}var qe=(l&4)!==0,Tt=!qe&&(i==="scroll"||i==="scrollend"),Y=qe?ne!==null?ne+"Capture":null:ne;qe=[];for(var J=Q,X;J!==null;){var oe=J;if(X=oe.stateNode,oe=oe.tag,oe!==5&&oe!==26&&oe!==27||X===null||Y===null||(oe=vl(J,Y),oe!=null&&qe.push(Xl(J,oe,X))),Tt)break;J=J.return}0<qe.length&&(ne=new re(ne,xe,null,f,ae),ue.push({event:ne,listeners:qe}))}}if((l&7)===0){e:{if(ne=i==="mouseover"||i==="pointerover",re=i==="mouseout"||i==="pointerout",ne&&f!==Vp&&(xe=f.relatedTarget||f.fromElement)&&(Xs(xe)||xe[Ie]))break e;if((re||ne)&&(ne=ae.window===ae?ae:(ne=ae.ownerDocument)?ne.defaultView||ne.parentWindow:window,re?(xe=f.relatedTarget||f.toElement,re=Q,xe=xe?Xs(xe):null,xe!==null&&(Tt=a(xe),qe=xe.tag,xe!==Tt||qe!==5&&qe!==27&&qe!==6)&&(xe=null)):(re=null,xe=Q),re!==xe)){if(qe=dw,oe="onMouseLeave",Y="onMouseEnter",J="mouse",(i==="pointerout"||i==="pointerover")&&(qe=pw,oe="onPointerLeave",Y="onPointerEnter",J="pointer"),Tt=re==null?ne:ea(re),X=xe==null?ne:ea(xe),ne=new qe(oe,J+"leave",re,f,ae),ne.target=Tt,ne.relatedTarget=X,oe=null,Xs(ae)===Q&&(qe=new qe(Y,J+"enter",xe,f,ae),qe.target=X,qe.relatedTarget=Tt,oe=qe),Tt=oe,re&&xe)t:{for(qe=bD,Y=re,J=xe,X=0,oe=Y;oe;oe=qe(oe))X++;oe=0;for(var Ue=J;Ue;Ue=qe(Ue))oe++;for(;0<X-oe;)Y=qe(Y),X--;for(;0<oe-X;)J=qe(J),oe--;for(;X--;){if(Y===J||J!==null&&Y===J.alternate){qe=Y;break t}Y=qe(Y),J=qe(J)}qe=null}else qe=null;re!==null&&sx(ue,ne,re,qe,!1),xe!==null&&Tt!==null&&sx(ue,Tt,xe,qe,!0)}}e:{if(ne=Q?ea(Q):window,re=ne.nodeName&&ne.nodeName.toLowerCase(),re==="select"||re==="input"&&ne.type==="file")var dt=bw;else if(vw(ne))if(Sw)dt=MO;else{dt=NO;var Pe=RO}else re=ne.nodeName,!re||re.toLowerCase()!=="input"||ne.type!=="checkbox"&&ne.type!=="radio"?Q&&jp(Q.elementType)&&(dt=bw):dt=PO;if(dt&&(dt=dt(i,Q))){ww(ue,dt,f,ae);break e}Pe&&Pe(i,ne,Q),i==="focusout"&&Q&&ne.type==="number"&&Q.memoizedProps.value!=null&&zp(ne,"number",ne.value)}switch(Pe=Q?ea(Q):window,i){case"focusin":(vw(Pe)||Pe.contentEditable==="true")&&(Wi=Pe,ah=Q,Cl=null);break;case"focusout":Cl=ah=Wi=null;break;case"mousedown":ih=!0;break;case"contextmenu":case"mouseup":case"dragend":ih=!1,Nw(ue,f,ae);break;case"selectionchange":if(OO)break;case"keydown":case"keyup":Nw(ue,f,ae)}var et;if(th)e:{switch(i){case"compositionstart":var it="onCompositionStart";break e;case"compositionend":it="onCompositionEnd";break e;case"compositionupdate":it="onCompositionUpdate";break e}it=void 0}else Ki?yw(i,f)&&(it="onCompositionEnd"):i==="keydown"&&f.keyCode===229&&(it="onCompositionStart");it&&(hw&&f.locale!=="ko"&&(Ki||it!=="onCompositionStart"?it==="onCompositionEnd"&&Ki&&(et=uw()):(na=ae,Wp="value"in na?na.value:na.textContent,Ki=!0)),Pe=Sd(Q,it),0<Pe.length&&(it=new fw(it,i,null,f,ae),ue.push({event:it,listeners:Pe}),et?it.data=et:(et=_w(f),et!==null&&(it.data=et)))),(et=TO?AO(i,f):EO(i,f))&&(it=Sd(Q,"onBeforeInput"),0<it.length&&(Pe=new fw("onBeforeInput","beforeinput",null,f,ae),ue.push({event:Pe,listeners:it}),Pe.data=et)),yD(ue,i,Q,f,ae)}nx(ue,l)})}function Xl(i,l,f){return{instance:i,listener:l,currentTarget:f}}function Sd(i,l){for(var f=l+"Capture",h=[];i!==null;){var v=i,b=v.stateNode;if(v=v.tag,v!==5&&v!==26&&v!==27||b===null||(v=vl(i,f),v!=null&&h.unshift(Xl(i,v,b)),v=vl(i,l),v!=null&&h.push(Xl(i,v,b))),i.tag===3)return h;i=i.return}return[]}function bD(i){if(i===null)return null;do i=i.return;while(i&&i.tag!==5&&i.tag!==27);return i||null}function sx(i,l,f,h,v){for(var b=l._reactName,R=[];f!==null&&f!==h;){var L=f,H=L.alternate,Q=L.stateNode;if(L=L.tag,H!==null&&H===h)break;L!==5&&L!==26&&L!==27||Q===null||(H=Q,v?(Q=vl(f,b),Q!=null&&R.unshift(Xl(f,Q,H))):v||(Q=vl(f,b),Q!=null&&R.push(Xl(f,Q,H)))),f=f.return}R.length!==0&&i.push({event:l,listeners:R})}var SD=/\r\n?/g,xD=/\u0000|\uFFFD/g;function ax(i){return(typeof i=="string"?i:""+i).replace(SD,`
`).replace(xD,"")}function ix(i,l){return l=ax(l),ax(i)===l}function xt(i,l,f,h,v,b){switch(f){case"children":typeof h=="string"?l==="body"||l==="textarea"&&h===""||Vi(i,h):(typeof h=="number"||typeof h=="bigint")&&l!=="body"&&Vi(i,""+h);break;case"className":Ec(i,"class",h);break;case"tabIndex":Ec(i,"tabindex",h);break;case"dir":case"role":case"viewBox":case"width":case"height":Ec(i,f,h);break;case"style":iw(i,h,b);break;case"data":if(l!=="object"){Ec(i,"data",h);break}case"src":case"href":if(h===""&&(l!=="a"||f!=="href")){i.removeAttribute(f);break}if(h==null||typeof h=="function"||typeof h=="symbol"||typeof h=="boolean"){i.removeAttribute(f);break}h=Ic(""+h),i.setAttribute(f,h);break;case"action":case"formAction":if(typeof h=="function"){i.setAttribute(f,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof b=="function"&&(f==="formAction"?(l!=="input"&&xt(i,l,"name",v.name,v,null),xt(i,l,"formEncType",v.formEncType,v,null),xt(i,l,"formMethod",v.formMethod,v,null),xt(i,l,"formTarget",v.formTarget,v,null)):(xt(i,l,"encType",v.encType,v,null),xt(i,l,"method",v.method,v,null),xt(i,l,"target",v.target,v,null)));if(h==null||typeof h=="symbol"||typeof h=="boolean"){i.removeAttribute(f);break}h=Ic(""+h),i.setAttribute(f,h);break;case"onClick":h!=null&&(i.onclick=ms);break;case"onScroll":h!=null&&st("scroll",i);break;case"onScrollEnd":h!=null&&st("scrollend",i);break;case"dangerouslySetInnerHTML":if(h!=null){if(typeof h!="object"||!("__html"in h))throw Error(r(61));if(f=h.__html,f!=null){if(v.children!=null)throw Error(r(60));i.innerHTML=f}}break;case"multiple":i.multiple=h&&typeof h!="function"&&typeof h!="symbol";break;case"muted":i.muted=h&&typeof h!="function"&&typeof h!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(h==null||typeof h=="function"||typeof h=="boolean"||typeof h=="symbol"){i.removeAttribute("xlink:href");break}f=Ic(""+h),i.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",f);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":h!=null&&typeof h!="function"&&typeof h!="symbol"?i.setAttribute(f,""+h):i.removeAttribute(f);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":h&&typeof h!="function"&&typeof h!="symbol"?i.setAttribute(f,""):i.removeAttribute(f);break;case"capture":case"download":h===!0?i.setAttribute(f,""):h!==!1&&h!=null&&typeof h!="function"&&typeof h!="symbol"?i.setAttribute(f,h):i.removeAttribute(f);break;case"cols":case"rows":case"size":case"span":h!=null&&typeof h!="function"&&typeof h!="symbol"&&!isNaN(h)&&1<=h?i.setAttribute(f,h):i.removeAttribute(f);break;case"rowSpan":case"start":h==null||typeof h=="function"||typeof h=="symbol"||isNaN(h)?i.removeAttribute(f):i.setAttribute(f,h);break;case"popover":st("beforetoggle",i),st("toggle",i),Ac(i,"popover",h);break;case"xlinkActuate":hs(i,"http://www.w3.org/1999/xlink","xlink:actuate",h);break;case"xlinkArcrole":hs(i,"http://www.w3.org/1999/xlink","xlink:arcrole",h);break;case"xlinkRole":hs(i,"http://www.w3.org/1999/xlink","xlink:role",h);break;case"xlinkShow":hs(i,"http://www.w3.org/1999/xlink","xlink:show",h);break;case"xlinkTitle":hs(i,"http://www.w3.org/1999/xlink","xlink:title",h);break;case"xlinkType":hs(i,"http://www.w3.org/1999/xlink","xlink:type",h);break;case"xmlBase":hs(i,"http://www.w3.org/XML/1998/namespace","xml:base",h);break;case"xmlLang":hs(i,"http://www.w3.org/XML/1998/namespace","xml:lang",h);break;case"xmlSpace":hs(i,"http://www.w3.org/XML/1998/namespace","xml:space",h);break;case"is":Ac(i,"is",h);break;case"innerText":case"textContent":break;default:(!(2<f.length)||f[0]!=="o"&&f[0]!=="O"||f[1]!=="n"&&f[1]!=="N")&&(f=Zk.get(f)||f,Ac(i,f,h))}}function Pm(i,l,f,h,v,b){switch(f){case"style":iw(i,h,b);break;case"dangerouslySetInnerHTML":if(h!=null){if(typeof h!="object"||!("__html"in h))throw Error(r(61));if(f=h.__html,f!=null){if(v.children!=null)throw Error(r(60));i.innerHTML=f}}break;case"children":typeof h=="string"?Vi(i,h):(typeof h=="number"||typeof h=="bigint")&&Vi(i,""+h);break;case"onScroll":h!=null&&st("scroll",i);break;case"onScrollEnd":h!=null&&st("scrollend",i);break;case"onClick":h!=null&&(i.onclick=ms);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!Tc.hasOwnProperty(f))e:{if(f[0]==="o"&&f[1]==="n"&&(v=f.endsWith("Capture"),l=f.slice(2,v?f.length-7:void 0),b=i[sn]||null,b=b!=null?b[f]:null,typeof b=="function"&&i.removeEventListener(l,b,v),typeof h=="function")){typeof b!="function"&&b!==null&&(f in i?i[f]=null:i.hasAttribute(f)&&i.removeAttribute(f)),i.addEventListener(l,h,v);break e}f in i?i[f]=h:h===!0?i.setAttribute(f,""):Ac(i,f,h)}}}function Sn(i,l,f){switch(l){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":st("error",i),st("load",i);var h=!1,v=!1,b;for(b in f)if(f.hasOwnProperty(b)){var R=f[b];if(R!=null)switch(b){case"src":h=!0;break;case"srcSet":v=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(r(137,l));default:xt(i,l,b,R,f,null)}}v&&xt(i,l,"srcSet",f.srcSet,f,null),h&&xt(i,l,"src",f.src,f,null);return;case"input":st("invalid",i);var L=b=R=v=null,H=null,Q=null;for(h in f)if(f.hasOwnProperty(h)){var ae=f[h];if(ae!=null)switch(h){case"name":v=ae;break;case"type":R=ae;break;case"checked":H=ae;break;case"defaultChecked":Q=ae;break;case"value":b=ae;break;case"defaultValue":L=ae;break;case"children":case"dangerouslySetInnerHTML":if(ae!=null)throw Error(r(137,l));break;default:xt(i,l,h,ae,f,null)}}nw(i,b,L,H,Q,R,v,!1);return;case"select":st("invalid",i),h=R=b=null;for(v in f)if(f.hasOwnProperty(v)&&(L=f[v],L!=null))switch(v){case"value":b=L;break;case"defaultValue":R=L;break;case"multiple":h=L;default:xt(i,l,v,L,f,null)}l=b,f=R,i.multiple=!!h,l!=null?ji(i,!!h,l,!1):f!=null&&ji(i,!!h,f,!0);return;case"textarea":st("invalid",i),b=v=h=null;for(R in f)if(f.hasOwnProperty(R)&&(L=f[R],L!=null))switch(R){case"value":h=L;break;case"defaultValue":v=L;break;case"children":b=L;break;case"dangerouslySetInnerHTML":if(L!=null)throw Error(r(91));break;default:xt(i,l,R,L,f,null)}sw(i,h,v,b);return;case"option":for(H in f)if(f.hasOwnProperty(H)&&(h=f[H],h!=null))switch(H){case"selected":i.selected=h&&typeof h!="function"&&typeof h!="symbol";break;default:xt(i,l,H,h,f,null)}return;case"dialog":st("beforetoggle",i),st("toggle",i),st("cancel",i),st("close",i);break;case"iframe":case"object":st("load",i);break;case"video":case"audio":for(h=0;h<Zl.length;h++)st(Zl[h],i);break;case"image":st("error",i),st("load",i);break;case"details":st("toggle",i);break;case"embed":case"source":case"link":st("error",i),st("load",i);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(Q in f)if(f.hasOwnProperty(Q)&&(h=f[Q],h!=null))switch(Q){case"children":case"dangerouslySetInnerHTML":throw Error(r(137,l));default:xt(i,l,Q,h,f,null)}return;default:if(jp(l)){for(ae in f)f.hasOwnProperty(ae)&&(h=f[ae],h!==void 0&&Pm(i,l,ae,h,f,void 0));return}}for(L in f)f.hasOwnProperty(L)&&(h=f[L],h!=null&&xt(i,l,L,h,f,null))}function TD(i,l,f,h){switch(l){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var v=null,b=null,R=null,L=null,H=null,Q=null,ae=null;for(re in f){var ue=f[re];if(f.hasOwnProperty(re)&&ue!=null)switch(re){case"checked":break;case"value":break;case"defaultValue":H=ue;default:h.hasOwnProperty(re)||xt(i,l,re,null,h,ue)}}for(var ne in h){var re=h[ne];if(ue=f[ne],h.hasOwnProperty(ne)&&(re!=null||ue!=null))switch(ne){case"type":b=re;break;case"name":v=re;break;case"checked":Q=re;break;case"defaultChecked":ae=re;break;case"value":R=re;break;case"defaultValue":L=re;break;case"children":case"dangerouslySetInnerHTML":if(re!=null)throw Error(r(137,l));break;default:re!==ue&&xt(i,l,ne,re,h,ue)}}Hp(i,R,L,H,Q,ae,b,v);return;case"select":re=R=L=ne=null;for(b in f)if(H=f[b],f.hasOwnProperty(b)&&H!=null)switch(b){case"value":break;case"multiple":re=H;default:h.hasOwnProperty(b)||xt(i,l,b,null,h,H)}for(v in h)if(b=h[v],H=f[v],h.hasOwnProperty(v)&&(b!=null||H!=null))switch(v){case"value":ne=b;break;case"defaultValue":L=b;break;case"multiple":R=b;default:b!==H&&xt(i,l,v,b,h,H)}l=L,f=R,h=re,ne!=null?ji(i,!!f,ne,!1):!!h!=!!f&&(l!=null?ji(i,!!f,l,!0):ji(i,!!f,f?[]:"",!1));return;case"textarea":re=ne=null;for(L in f)if(v=f[L],f.hasOwnProperty(L)&&v!=null&&!h.hasOwnProperty(L))switch(L){case"value":break;case"children":break;default:xt(i,l,L,null,h,v)}for(R in h)if(v=h[R],b=f[R],h.hasOwnProperty(R)&&(v!=null||b!=null))switch(R){case"value":ne=v;break;case"defaultValue":re=v;break;case"children":break;case"dangerouslySetInnerHTML":if(v!=null)throw Error(r(91));break;default:v!==b&&xt(i,l,R,v,h,b)}rw(i,ne,re);return;case"option":for(var xe in f)if(ne=f[xe],f.hasOwnProperty(xe)&&ne!=null&&!h.hasOwnProperty(xe))switch(xe){case"selected":i.selected=!1;break;default:xt(i,l,xe,null,h,ne)}for(H in h)if(ne=h[H],re=f[H],h.hasOwnProperty(H)&&ne!==re&&(ne!=null||re!=null))switch(H){case"selected":i.selected=ne&&typeof ne!="function"&&typeof ne!="symbol";break;default:xt(i,l,H,ne,h,re)}return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var qe in f)ne=f[qe],f.hasOwnProperty(qe)&&ne!=null&&!h.hasOwnProperty(qe)&&xt(i,l,qe,null,h,ne);for(Q in h)if(ne=h[Q],re=f[Q],h.hasOwnProperty(Q)&&ne!==re&&(ne!=null||re!=null))switch(Q){case"children":case"dangerouslySetInnerHTML":if(ne!=null)throw Error(r(137,l));break;default:xt(i,l,Q,ne,h,re)}return;default:if(jp(l)){for(var Tt in f)ne=f[Tt],f.hasOwnProperty(Tt)&&ne!==void 0&&!h.hasOwnProperty(Tt)&&Pm(i,l,Tt,void 0,h,ne);for(ae in h)ne=h[ae],re=f[ae],!h.hasOwnProperty(ae)||ne===re||ne===void 0&&re===void 0||Pm(i,l,ae,ne,h,re);return}}for(var Y in f)ne=f[Y],f.hasOwnProperty(Y)&&ne!=null&&!h.hasOwnProperty(Y)&&xt(i,l,Y,null,h,ne);for(ue in h)ne=h[ue],re=f[ue],!h.hasOwnProperty(ue)||ne===re||ne==null&&re==null||xt(i,l,ue,ne,h,re)}function ox(i){switch(i){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function AD(){if(typeof performance.getEntriesByType=="function"){for(var i=0,l=0,f=performance.getEntriesByType("resource"),h=0;h<f.length;h++){var v=f[h],b=v.transferSize,R=v.initiatorType,L=v.duration;if(b&&L&&ox(R)){for(R=0,L=v.responseEnd,h+=1;h<f.length;h++){var H=f[h],Q=H.startTime;if(Q>L)break;var ae=H.transferSize,ue=H.initiatorType;ae&&ox(ue)&&(H=H.responseEnd,R+=ae*(H<L?1:(L-Q)/(H-Q)))}if(--h,l+=8*(b+R)/(v.duration/1e3),i++,10<i)break}}if(0<i)return l/i/1e6}return navigator.connection&&(i=navigator.connection.downlink,typeof i=="number")?i:5}var Mm=null,km=null;function xd(i){return i.nodeType===9?i:i.ownerDocument}function lx(i){switch(i){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function ux(i,l){if(i===0)switch(l){case"svg":return 1;case"math":return 2;default:return 0}return i===1&&l==="foreignObject"?0:i}function Om(i,l){return i==="textarea"||i==="noscript"||typeof l.children=="string"||typeof l.children=="number"||typeof l.children=="bigint"||typeof l.dangerouslySetInnerHTML=="object"&&l.dangerouslySetInnerHTML!==null&&l.dangerouslySetInnerHTML.__html!=null}var Dm=null;function ED(){var i=window.event;return i&&i.type==="popstate"?i===Dm?!1:(Dm=i,!0):(Dm=null,!1)}var cx=typeof setTimeout=="function"?setTimeout:void 0,CD=typeof clearTimeout=="function"?clearTimeout:void 0,dx=typeof Promise=="function"?Promise:void 0,ID=typeof queueMicrotask=="function"?queueMicrotask:typeof dx<"u"?function(i){return dx.resolve(null).then(i).catch(RD)}:cx;function RD(i){setTimeout(function(){throw i})}function va(i){return i==="head"}function fx(i,l){var f=l,h=0;do{var v=f.nextSibling;if(i.removeChild(f),v&&v.nodeType===8)if(f=v.data,f==="/$"||f==="/&"){if(h===0){i.removeChild(v),To(l);return}h--}else if(f==="$"||f==="$?"||f==="$~"||f==="$!"||f==="&")h++;else if(f==="html")Ql(i.ownerDocument.documentElement);else if(f==="head"){f=i.ownerDocument.head,Ql(f);for(var b=f.firstChild;b;){var R=b.nextSibling,L=b.nodeName;b[Zs]||L==="SCRIPT"||L==="STYLE"||L==="LINK"&&b.rel.toLowerCase()==="stylesheet"||f.removeChild(b),b=R}}else f==="body"&&Ql(i.ownerDocument.body);f=v}while(f);To(l)}function px(i,l){var f=i;i=0;do{var h=f.nextSibling;if(f.nodeType===1?l?(f._stashedDisplay=f.style.display,f.style.display="none"):(f.style.display=f._stashedDisplay||"",f.getAttribute("style")===""&&f.removeAttribute("style")):f.nodeType===3&&(l?(f._stashedText=f.nodeValue,f.nodeValue=""):f.nodeValue=f._stashedText||""),h&&h.nodeType===8)if(f=h.data,f==="/$"){if(i===0)break;i--}else f!=="$"&&f!=="$?"&&f!=="$~"&&f!=="$!"||i++;f=h}while(f)}function Lm(i){var l=i.firstChild;for(l&&l.nodeType===10&&(l=l.nextSibling);l;){var f=l;switch(l=l.nextSibling,f.nodeName){case"HTML":case"HEAD":case"BODY":Lm(f),ei(f);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(f.rel.toLowerCase()==="stylesheet")continue}i.removeChild(f)}}function ND(i,l,f,h){for(;i.nodeType===1;){var v=f;if(i.nodeName.toLowerCase()!==l.toLowerCase()){if(!h&&(i.nodeName!=="INPUT"||i.type!=="hidden"))break}else if(h){if(!i[Zs])switch(l){case"meta":if(!i.hasAttribute("itemprop"))break;return i;case"link":if(b=i.getAttribute("rel"),b==="stylesheet"&&i.hasAttribute("data-precedence"))break;if(b!==v.rel||i.getAttribute("href")!==(v.href==null||v.href===""?null:v.href)||i.getAttribute("crossorigin")!==(v.crossOrigin==null?null:v.crossOrigin)||i.getAttribute("title")!==(v.title==null?null:v.title))break;return i;case"style":if(i.hasAttribute("data-precedence"))break;return i;case"script":if(b=i.getAttribute("src"),(b!==(v.src==null?null:v.src)||i.getAttribute("type")!==(v.type==null?null:v.type)||i.getAttribute("crossorigin")!==(v.crossOrigin==null?null:v.crossOrigin))&&b&&i.hasAttribute("async")&&!i.hasAttribute("itemprop"))break;return i;default:return i}}else if(l==="input"&&i.type==="hidden"){var b=v.name==null?null:""+v.name;if(v.type==="hidden"&&i.getAttribute("name")===b)return i}else return i;if(i=_r(i.nextSibling),i===null)break}return null}function PD(i,l,f){if(l==="")return null;for(;i.nodeType!==3;)if((i.nodeType!==1||i.nodeName!=="INPUT"||i.type!=="hidden")&&!f||(i=_r(i.nextSibling),i===null))return null;return i}function hx(i,l){for(;i.nodeType!==8;)if((i.nodeType!==1||i.nodeName!=="INPUT"||i.type!=="hidden")&&!l||(i=_r(i.nextSibling),i===null))return null;return i}function $m(i){return i.data==="$?"||i.data==="$~"}function Um(i){return i.data==="$!"||i.data==="$?"&&i.ownerDocument.readyState!=="loading"}function MD(i,l){var f=i.ownerDocument;if(i.data==="$~")i._reactRetry=l;else if(i.data!=="$?"||f.readyState!=="loading")l();else{var h=function(){l(),f.removeEventListener("DOMContentLoaded",h)};f.addEventListener("DOMContentLoaded",h),i._reactRetry=h}}function _r(i){for(;i!=null;i=i.nextSibling){var l=i.nodeType;if(l===1||l===3)break;if(l===8){if(l=i.data,l==="$"||l==="$!"||l==="$?"||l==="$~"||l==="&"||l==="F!"||l==="F")break;if(l==="/$"||l==="/&")return null}}return i}var Fm=null;function mx(i){i=i.nextSibling;for(var l=0;i;){if(i.nodeType===8){var f=i.data;if(f==="/$"||f==="/&"){if(l===0)return _r(i.nextSibling);l--}else f!=="$"&&f!=="$!"&&f!=="$?"&&f!=="$~"&&f!=="&"||l++}i=i.nextSibling}return null}function gx(i){i=i.previousSibling;for(var l=0;i;){if(i.nodeType===8){var f=i.data;if(f==="$"||f==="$!"||f==="$?"||f==="$~"||f==="&"){if(l===0)return i;l--}else f!=="/$"&&f!=="/&"||l++}i=i.previousSibling}return null}function yx(i,l,f){switch(l=xd(f),i){case"html":if(i=l.documentElement,!i)throw Error(r(452));return i;case"head":if(i=l.head,!i)throw Error(r(453));return i;case"body":if(i=l.body,!i)throw Error(r(454));return i;default:throw Error(r(451))}}function Ql(i){for(var l=i.attributes;l.length;)i.removeAttributeNode(l[0]);ei(i)}var vr=new Map,_x=new Set;function Td(i){return typeof i.getRootNode=="function"?i.getRootNode():i.nodeType===9?i:i.ownerDocument}var Ps=G.d;G.d={f:kD,r:OD,D:DD,C:LD,L:$D,m:UD,X:BD,S:FD,M:qD};function kD(){var i=Ps.f(),l=md();return i||l}function OD(i){var l=Qs(i);l!==null&&l.tag===5&&l.type==="form"?Db(l):Ps.r(i)}var bo=typeof document>"u"?null:document;function vx(i,l,f){var h=bo;if(h&&typeof l=="string"&&l){var v=dr(l);v='link[rel="'+i+'"][href="'+v+'"]',typeof f=="string"&&(v+='[crossorigin="'+f+'"]'),_x.has(v)||(_x.add(v),i={rel:i,crossOrigin:f,href:l},h.querySelector(v)===null&&(l=h.createElement("link"),Sn(l,"link",i),Kt(l),h.head.appendChild(l)))}}function DD(i){Ps.D(i),vx("dns-prefetch",i,null)}function LD(i,l){Ps.C(i,l),vx("preconnect",i,l)}function $D(i,l,f){Ps.L(i,l,f);var h=bo;if(h&&i&&l){var v='link[rel="preload"][as="'+dr(l)+'"]';l==="image"&&f&&f.imageSrcSet?(v+='[imagesrcset="'+dr(f.imageSrcSet)+'"]',typeof f.imageSizes=="string"&&(v+='[imagesizes="'+dr(f.imageSizes)+'"]')):v+='[href="'+dr(i)+'"]';var b=v;switch(l){case"style":b=So(i);break;case"script":b=xo(i)}vr.has(b)||(i=m({rel:"preload",href:l==="image"&&f&&f.imageSrcSet?void 0:i,as:l},f),vr.set(b,i),h.querySelector(v)!==null||l==="style"&&h.querySelector(eu(b))||l==="script"&&h.querySelector(tu(b))||(l=h.createElement("link"),Sn(l,"link",i),Kt(l),h.head.appendChild(l)))}}function UD(i,l){Ps.m(i,l);var f=bo;if(f&&i){var h=l&&typeof l.as=="string"?l.as:"script",v='link[rel="modulepreload"][as="'+dr(h)+'"][href="'+dr(i)+'"]',b=v;switch(h){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":b=xo(i)}if(!vr.has(b)&&(i=m({rel:"modulepreload",href:i},l),vr.set(b,i),f.querySelector(v)===null)){switch(h){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(f.querySelector(tu(b)))return}h=f.createElement("link"),Sn(h,"link",i),Kt(h),f.head.appendChild(h)}}}function FD(i,l,f){Ps.S(i,l,f);var h=bo;if(h&&i){var v=ta(h).hoistableStyles,b=So(i);l=l||"default";var R=v.get(b);if(!R){var L={loading:0,preload:null};if(R=h.querySelector(eu(b)))L.loading=5;else{i=m({rel:"stylesheet",href:i,"data-precedence":l},f),(f=vr.get(b))&&Bm(i,f);var H=R=h.createElement("link");Kt(H),Sn(H,"link",i),H._p=new Promise(function(Q,ae){H.onload=Q,H.onerror=ae}),H.addEventListener("load",function(){L.loading|=1}),H.addEventListener("error",function(){L.loading|=2}),L.loading|=4,Ad(R,l,h)}R={type:"stylesheet",instance:R,count:1,state:L},v.set(b,R)}}}function BD(i,l){Ps.X(i,l);var f=bo;if(f&&i){var h=ta(f).hoistableScripts,v=xo(i),b=h.get(v);b||(b=f.querySelector(tu(v)),b||(i=m({src:i,async:!0},l),(l=vr.get(v))&&qm(i,l),b=f.createElement("script"),Kt(b),Sn(b,"link",i),f.head.appendChild(b)),b={type:"script",instance:b,count:1,state:null},h.set(v,b))}}function qD(i,l){Ps.M(i,l);var f=bo;if(f&&i){var h=ta(f).hoistableScripts,v=xo(i),b=h.get(v);b||(b=f.querySelector(tu(v)),b||(i=m({src:i,async:!0,type:"module"},l),(l=vr.get(v))&&qm(i,l),b=f.createElement("script"),Kt(b),Sn(b,"link",i),f.head.appendChild(b)),b={type:"script",instance:b,count:1,state:null},h.set(v,b))}}function wx(i,l,f,h){var v=(v=fe.current)?Td(v):null;if(!v)throw Error(r(446));switch(i){case"meta":case"title":return null;case"style":return typeof f.precedence=="string"&&typeof f.href=="string"?(l=So(f.href),f=ta(v).hoistableStyles,h=f.get(l),h||(h={type:"style",instance:null,count:0,state:null},f.set(l,h)),h):{type:"void",instance:null,count:0,state:null};case"link":if(f.rel==="stylesheet"&&typeof f.href=="string"&&typeof f.precedence=="string"){i=So(f.href);var b=ta(v).hoistableStyles,R=b.get(i);if(R||(v=v.ownerDocument||v,R={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},b.set(i,R),(b=v.querySelector(eu(i)))&&!b._p&&(R.instance=b,R.state.loading=5),vr.has(i)||(f={rel:"preload",as:"style",href:f.href,crossOrigin:f.crossOrigin,integrity:f.integrity,media:f.media,hrefLang:f.hrefLang,referrerPolicy:f.referrerPolicy},vr.set(i,f),b||GD(v,i,f,R.state))),l&&h===null)throw Error(r(528,""));return R}if(l&&h!==null)throw Error(r(529,""));return null;case"script":return l=f.async,f=f.src,typeof f=="string"&&l&&typeof l!="function"&&typeof l!="symbol"?(l=xo(f),f=ta(v).hoistableScripts,h=f.get(l),h||(h={type:"script",instance:null,count:0,state:null},f.set(l,h)),h):{type:"void",instance:null,count:0,state:null};default:throw Error(r(444,i))}}function So(i){return'href="'+dr(i)+'"'}function eu(i){return'link[rel="stylesheet"]['+i+"]"}function bx(i){return m({},i,{"data-precedence":i.precedence,precedence:null})}function GD(i,l,f,h){i.querySelector('link[rel="preload"][as="style"]['+l+"]")?h.loading=1:(l=i.createElement("link"),h.preload=l,l.addEventListener("load",function(){return h.loading|=1}),l.addEventListener("error",function(){return h.loading|=2}),Sn(l,"link",f),Kt(l),i.head.appendChild(l))}function xo(i){return'[src="'+dr(i)+'"]'}function tu(i){return"script[async]"+i}function Sx(i,l,f){if(l.count++,l.instance===null)switch(l.type){case"style":var h=i.querySelector('style[data-href~="'+dr(f.href)+'"]');if(h)return l.instance=h,Kt(h),h;var v=m({},f,{"data-href":f.href,"data-precedence":f.precedence,href:null,precedence:null});return h=(i.ownerDocument||i).createElement("style"),Kt(h),Sn(h,"style",v),Ad(h,f.precedence,i),l.instance=h;case"stylesheet":v=So(f.href);var b=i.querySelector(eu(v));if(b)return l.state.loading|=4,l.instance=b,Kt(b),b;h=bx(f),(v=vr.get(v))&&Bm(h,v),b=(i.ownerDocument||i).createElement("link"),Kt(b);var R=b;return R._p=new Promise(function(L,H){R.onload=L,R.onerror=H}),Sn(b,"link",h),l.state.loading|=4,Ad(b,f.precedence,i),l.instance=b;case"script":return b=xo(f.src),(v=i.querySelector(tu(b)))?(l.instance=v,Kt(v),v):(h=f,(v=vr.get(b))&&(h=m({},f),qm(h,v)),i=i.ownerDocument||i,v=i.createElement("script"),Kt(v),Sn(v,"link",h),i.head.appendChild(v),l.instance=v);case"void":return null;default:throw Error(r(443,l.type))}else l.type==="stylesheet"&&(l.state.loading&4)===0&&(h=l.instance,l.state.loading|=4,Ad(h,f.precedence,i));return l.instance}function Ad(i,l,f){for(var h=f.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),v=h.length?h[h.length-1]:null,b=v,R=0;R<h.length;R++){var L=h[R];if(L.dataset.precedence===l)b=L;else if(b!==v)break}b?b.parentNode.insertBefore(i,b.nextSibling):(l=f.nodeType===9?f.head:f,l.insertBefore(i,l.firstChild))}function Bm(i,l){i.crossOrigin==null&&(i.crossOrigin=l.crossOrigin),i.referrerPolicy==null&&(i.referrerPolicy=l.referrerPolicy),i.title==null&&(i.title=l.title)}function qm(i,l){i.crossOrigin==null&&(i.crossOrigin=l.crossOrigin),i.referrerPolicy==null&&(i.referrerPolicy=l.referrerPolicy),i.integrity==null&&(i.integrity=l.integrity)}var Ed=null;function xx(i,l,f){if(Ed===null){var h=new Map,v=Ed=new Map;v.set(f,h)}else v=Ed,h=v.get(f),h||(h=new Map,v.set(f,h));if(h.has(i))return h;for(h.set(i,null),f=f.getElementsByTagName(i),v=0;v<f.length;v++){var b=f[v];if(!(b[Zs]||b[Nt]||i==="link"&&b.getAttribute("rel")==="stylesheet")&&b.namespaceURI!=="http://www.w3.org/2000/svg"){var R=b.getAttribute(l)||"";R=i+R;var L=h.get(R);L?L.push(b):h.set(R,[b])}}return h}function Tx(i,l,f){i=i.ownerDocument||i,i.head.insertBefore(f,l==="title"?i.querySelector("head > title"):null)}function HD(i,l,f){if(f===1||l.itemProp!=null)return!1;switch(i){case"meta":case"title":return!0;case"style":if(typeof l.precedence!="string"||typeof l.href!="string"||l.href==="")break;return!0;case"link":if(typeof l.rel!="string"||typeof l.href!="string"||l.href===""||l.onLoad||l.onError)break;switch(l.rel){case"stylesheet":return i=l.disabled,typeof l.precedence=="string"&&i==null;default:return!0}case"script":if(l.async&&typeof l.async!="function"&&typeof l.async!="symbol"&&!l.onLoad&&!l.onError&&l.src&&typeof l.src=="string")return!0}return!1}function Ax(i){return!(i.type==="stylesheet"&&(i.state.loading&3)===0)}function zD(i,l,f,h){if(f.type==="stylesheet"&&(typeof h.media!="string"||matchMedia(h.media).matches!==!1)&&(f.state.loading&4)===0){if(f.instance===null){var v=So(h.href),b=l.querySelector(eu(v));if(b){l=b._p,l!==null&&typeof l=="object"&&typeof l.then=="function"&&(i.count++,i=Cd.bind(i),l.then(i,i)),f.state.loading|=4,f.instance=b,Kt(b);return}b=l.ownerDocument||l,h=bx(h),(v=vr.get(v))&&Bm(h,v),b=b.createElement("link"),Kt(b);var R=b;R._p=new Promise(function(L,H){R.onload=L,R.onerror=H}),Sn(b,"link",h),f.instance=b}i.stylesheets===null&&(i.stylesheets=new Map),i.stylesheets.set(f,l),(l=f.state.preload)&&(f.state.loading&3)===0&&(i.count++,f=Cd.bind(i),l.addEventListener("load",f),l.addEventListener("error",f))}}var Gm=0;function jD(i,l){return i.stylesheets&&i.count===0&&Rd(i,i.stylesheets),0<i.count||0<i.imgCount?function(f){var h=setTimeout(function(){if(i.stylesheets&&Rd(i,i.stylesheets),i.unsuspend){var b=i.unsuspend;i.unsuspend=null,b()}},6e4+l);0<i.imgBytes&&Gm===0&&(Gm=62500*AD());var v=setTimeout(function(){if(i.waitingForImages=!1,i.count===0&&(i.stylesheets&&Rd(i,i.stylesheets),i.unsuspend)){var b=i.unsuspend;i.unsuspend=null,b()}},(i.imgBytes>Gm?50:800)+l);return i.unsuspend=f,function(){i.unsuspend=null,clearTimeout(h),clearTimeout(v)}}:null}function Cd(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)Rd(this,this.stylesheets);else if(this.unsuspend){var i=this.unsuspend;this.unsuspend=null,i()}}}var Id=null;function Rd(i,l){i.stylesheets=null,i.unsuspend!==null&&(i.count++,Id=new Map,l.forEach(VD,i),Id=null,Cd.call(i))}function VD(i,l){if(!(l.state.loading&4)){var f=Id.get(i);if(f)var h=f.get(null);else{f=new Map,Id.set(i,f);for(var v=i.querySelectorAll("link[data-precedence],style[data-precedence]"),b=0;b<v.length;b++){var R=v[b];(R.nodeName==="LINK"||R.getAttribute("media")!=="not all")&&(f.set(R.dataset.precedence,R),h=R)}h&&f.set(null,h)}v=l.instance,R=v.getAttribute("data-precedence"),b=f.get(R)||h,b===h&&f.set(null,v),f.set(R,v),this.count++,h=Cd.bind(this),v.addEventListener("load",h),v.addEventListener("error",h),b?b.parentNode.insertBefore(v,b.nextSibling):(i=i.nodeType===9?i.head:i,i.insertBefore(v,i.firstChild)),l.state.loading|=4}}var nu={$$typeof:O,Provider:null,Consumer:null,_currentValue:Z,_currentValue2:Z,_threadCount:0};function JD(i,l,f,h,v,b,R,L,H){this.tag=1,this.containerInfo=i,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=gl(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=gl(0),this.hiddenUpdates=gl(null),this.identifierPrefix=h,this.onUncaughtError=v,this.onCaughtError=b,this.onRecoverableError=R,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=H,this.incompleteTransitions=new Map}function Ex(i,l,f,h,v,b,R,L,H,Q,ae,ue){return i=new JD(i,l,f,R,H,Q,ae,ue,L),l=1,b===!0&&(l|=24),b=Wn(3,null,null,l),i.current=b,b.stateNode=i,l=bh(),l.refCount++,i.pooledCache=l,l.refCount++,b.memoizedState={element:h,isDehydrated:f,cache:l},Ah(b),i}function Cx(i){return i?(i=Qi,i):Qi}function Ix(i,l,f,h,v,b){v=Cx(v),h.context===null?h.context=v:h.pendingContext=v,h=la(l),h.payload={element:f},b=b===void 0?null:b,b!==null&&(h.callback=b),f=ua(i,h,l),f!==null&&(Hn(f,i,l),Ol(f,i,l))}function Rx(i,l){if(i=i.memoizedState,i!==null&&i.dehydrated!==null){var f=i.retryLane;i.retryLane=f!==0&&f<l?f:l}}function Hm(i,l){Rx(i,l),(i=i.alternate)&&Rx(i,l)}function Nx(i){if(i.tag===13||i.tag===31){var l=si(i,67108864);l!==null&&Hn(l,i,67108864),Hm(i,67108864)}}function Px(i){if(i.tag===13||i.tag===31){var l=tr();l=_l(l);var f=si(i,l);f!==null&&Hn(f,i,l),Hm(i,l)}}var Nd=!0;function YD(i,l,f,h){var v=B.T;B.T=null;var b=G.p;try{G.p=2,zm(i,l,f,h)}finally{G.p=b,B.T=v}}function KD(i,l,f,h){var v=B.T;B.T=null;var b=G.p;try{G.p=8,zm(i,l,f,h)}finally{G.p=b,B.T=v}}function zm(i,l,f,h){if(Nd){var v=jm(h);if(v===null)Nm(i,l,h,Pd,f),kx(i,h);else if(ZD(v,i,l,f,h))h.stopPropagation();else if(kx(i,h),l&4&&-1<WD.indexOf(i)){for(;v!==null;){var b=Qs(v);if(b!==null)switch(b.tag){case 3:if(b=b.stateNode,b.current.memoizedState.isDehydrated){var R=ps(b.pendingLanes);if(R!==0){var L=b;for(L.pendingLanes|=2,L.entangledLanes|=2;R;){var H=1<<31-Pn(R);L.entanglements[1]|=H,R&=~H}Zr(b),(mt&6)===0&&(pd=_e()+500,Wl(0))}}break;case 31:case 13:L=si(b,2),L!==null&&Hn(L,b,2),md(),Hm(b,2)}if(b=jm(h),b===null&&Nm(i,l,h,Pd,f),b===v)break;v=b}v!==null&&h.stopPropagation()}else Nm(i,l,h,null,f)}}function jm(i){return i=Jp(i),Vm(i)}var Pd=null;function Vm(i){if(Pd=null,i=Xs(i),i!==null){var l=a(i);if(l===null)i=null;else{var f=l.tag;if(f===13){if(i=o(l),i!==null)return i;i=null}else if(f===31){if(i=u(l),i!==null)return i;i=null}else if(f===3){if(l.stateNode.current.memoizedState.isDehydrated)return l.tag===3?l.stateNode.containerInfo:null;i=null}else l!==i&&(i=null)}}return Pd=i,null}function Mx(i){switch(i){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(ve()){case ye:return 2;case Be:return 8;case De:case fn:return 32;case fs:return 268435456;default:return 32}default:return 32}}var Jm=!1,wa=null,ba=null,Sa=null,ru=new Map,su=new Map,xa=[],WD="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function kx(i,l){switch(i){case"focusin":case"focusout":wa=null;break;case"dragenter":case"dragleave":ba=null;break;case"mouseover":case"mouseout":Sa=null;break;case"pointerover":case"pointerout":ru.delete(l.pointerId);break;case"gotpointercapture":case"lostpointercapture":su.delete(l.pointerId)}}function au(i,l,f,h,v,b){return i===null||i.nativeEvent!==b?(i={blockedOn:l,domEventName:f,eventSystemFlags:h,nativeEvent:b,targetContainers:[v]},l!==null&&(l=Qs(l),l!==null&&Nx(l)),i):(i.eventSystemFlags|=h,l=i.targetContainers,v!==null&&l.indexOf(v)===-1&&l.push(v),i)}function ZD(i,l,f,h,v){switch(l){case"focusin":return wa=au(wa,i,l,f,h,v),!0;case"dragenter":return ba=au(ba,i,l,f,h,v),!0;case"mouseover":return Sa=au(Sa,i,l,f,h,v),!0;case"pointerover":var b=v.pointerId;return ru.set(b,au(ru.get(b)||null,i,l,f,h,v)),!0;case"gotpointercapture":return b=v.pointerId,su.set(b,au(su.get(b)||null,i,l,f,h,v)),!0}return!1}function Ox(i){var l=Xs(i.target);if(l!==null){var f=a(l);if(f!==null){if(l=f.tag,l===13){if(l=o(f),l!==null){i.blockedOn=l,Je(i.priority,function(){Px(f)});return}}else if(l===31){if(l=u(f),l!==null){i.blockedOn=l,Je(i.priority,function(){Px(f)});return}}else if(l===3&&f.stateNode.current.memoizedState.isDehydrated){i.blockedOn=f.tag===3?f.stateNode.containerInfo:null;return}}}i.blockedOn=null}function Md(i){if(i.blockedOn!==null)return!1;for(var l=i.targetContainers;0<l.length;){var f=jm(i.nativeEvent);if(f===null){f=i.nativeEvent;var h=new f.constructor(f.type,f);Vp=h,f.target.dispatchEvent(h),Vp=null}else return l=Qs(f),l!==null&&Nx(l),i.blockedOn=f,!1;l.shift()}return!0}function Dx(i,l,f){Md(i)&&f.delete(l)}function XD(){Jm=!1,wa!==null&&Md(wa)&&(wa=null),ba!==null&&Md(ba)&&(ba=null),Sa!==null&&Md(Sa)&&(Sa=null),ru.forEach(Dx),su.forEach(Dx)}function kd(i,l){i.blockedOn===l&&(i.blockedOn=null,Jm||(Jm=!0,t.unstable_scheduleCallback(t.unstable_NormalPriority,XD)))}var Od=null;function Lx(i){Od!==i&&(Od=i,t.unstable_scheduleCallback(t.unstable_NormalPriority,function(){Od===i&&(Od=null);for(var l=0;l<i.length;l+=3){var f=i[l],h=i[l+1],v=i[l+2];if(typeof h!="function"){if(Vm(h||f)===null)continue;break}var b=Qs(f);b!==null&&(i.splice(l,3),l-=3,jh(b,{pending:!0,data:v,method:f.method,action:h},h,v))}}))}function To(i){function l(H){return kd(H,i)}wa!==null&&kd(wa,i),ba!==null&&kd(ba,i),Sa!==null&&kd(Sa,i),ru.forEach(l),su.forEach(l);for(var f=0;f<xa.length;f++){var h=xa[f];h.blockedOn===i&&(h.blockedOn=null)}for(;0<xa.length&&(f=xa[0],f.blockedOn===null);)Ox(f),f.blockedOn===null&&xa.shift();if(f=(i.ownerDocument||i).$$reactFormReplay,f!=null)for(h=0;h<f.length;h+=3){var v=f[h],b=f[h+1],R=v[sn]||null;if(typeof b=="function")R||Lx(f);else if(R){var L=null;if(b&&b.hasAttribute("formAction")){if(v=b,R=b[sn]||null)L=R.formAction;else if(Vm(v)!==null)continue}else L=R.action;typeof L=="function"?f[h+1]=L:(f.splice(h,3),h-=3),Lx(f)}}}function $x(){function i(b){b.canIntercept&&b.info==="react-transition"&&b.intercept({handler:function(){return new Promise(function(R){return v=R})},focusReset:"manual",scroll:"manual"})}function l(){v!==null&&(v(),v=null),h||setTimeout(f,20)}function f(){if(!h&&!navigation.transition){var b=navigation.currentEntry;b&&b.url!=null&&navigation.navigate(b.url,{state:b.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var h=!1,v=null;return navigation.addEventListener("navigate",i),navigation.addEventListener("navigatesuccess",l),navigation.addEventListener("navigateerror",l),setTimeout(f,100),function(){h=!0,navigation.removeEventListener("navigate",i),navigation.removeEventListener("navigatesuccess",l),navigation.removeEventListener("navigateerror",l),v!==null&&(v(),v=null)}}}function Ym(i){this._internalRoot=i}Dd.prototype.render=Ym.prototype.render=function(i){var l=this._internalRoot;if(l===null)throw Error(r(409));var f=l.current,h=tr();Ix(f,h,i,l,null,null)},Dd.prototype.unmount=Ym.prototype.unmount=function(){var i=this._internalRoot;if(i!==null){this._internalRoot=null;var l=i.containerInfo;Ix(i.current,2,null,i,null,null),md(),l[Ie]=null}};function Dd(i){this._internalRoot=i}Dd.prototype.unstable_scheduleHydration=function(i){if(i){var l=pe();i={blockedOn:null,target:i,priority:l};for(var f=0;f<xa.length&&l!==0&&l<xa[f].priority;f++);xa.splice(f,0,i),f===0&&Ox(i)}};var Ux=e.version;if(Ux!=="19.2.0")throw Error(r(527,Ux,"19.2.0"));G.findDOMNode=function(i){var l=i._reactInternals;if(l===void 0)throw typeof i.render=="function"?Error(r(188)):(i=Object.keys(i).join(","),Error(r(268,i)));return i=c(l),i=i!==null?p(i):null,i=i===null?null:i.stateNode,i};var QD={bundleType:0,version:"19.2.0",rendererPackageName:"react-dom",currentDispatcherRef:B,reconcilerVersion:"19.2.0"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Ld=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Ld.isDisabled&&Ld.supportsFiber)try{Ks=Ld.inject(QD),_n=Ld}catch{}}return ou.createRoot=function(i,l){if(!s(i))throw Error(r(299));var f=!1,h="",v=jb,b=Vb,R=Jb;return l!=null&&(l.unstable_strictMode===!0&&(f=!0),l.identifierPrefix!==void 0&&(h=l.identifierPrefix),l.onUncaughtError!==void 0&&(v=l.onUncaughtError),l.onCaughtError!==void 0&&(b=l.onCaughtError),l.onRecoverableError!==void 0&&(R=l.onRecoverableError)),l=Ex(i,1,!1,null,null,f,h,null,v,b,R,$x),i[Ie]=l.current,Rm(i),new Ym(l)},ou.hydrateRoot=function(i,l,f){if(!s(i))throw Error(r(299));var h=!1,v="",b=jb,R=Vb,L=Jb,H=null;return f!=null&&(f.unstable_strictMode===!0&&(h=!0),f.identifierPrefix!==void 0&&(v=f.identifierPrefix),f.onUncaughtError!==void 0&&(b=f.onUncaughtError),f.onCaughtError!==void 0&&(R=f.onCaughtError),f.onRecoverableError!==void 0&&(L=f.onRecoverableError),f.formState!==void 0&&(H=f.formState)),l=Ex(i,1,!0,l,f??null,h,v,H,b,R,L,$x),l.context=Cx(null),f=l.current,h=tr(),h=_l(h),v=la(h),v.callback=null,ua(f,v,h),f=h,l.current.lanes=f,Xa(l,f),Zr(l),i[Ie]=l.current,Rm(i),new Dd(l)},ou.version="19.2.0",ou}var Yx;function dL(){if(Yx)return Zm.exports;Yx=1;function t(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(t)}catch(e){console.error(e)}}return t(),Zm.exports=cL(),Zm.exports}var fL=dL();const pL=Ga(fL);function hL(t,e){if(t==null)return{};var n=mL(t,e),r,s;if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);for(s=0;s<a.length;s++)r=a[s],!(e.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}function mL(t,e){if(t==null)return{};var n={},r=Object.keys(t),s,a;for(a=0;a<r.length;a++)s=r[a],!(e.indexOf(s)>=0)&&(n[s]=t[s]);return n}function xf(){return xf=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},xf.apply(this,arguments)}function Kx(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable})),n.push.apply(n,r)}return n}function lu(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Kx(Object(n),!0).forEach(function(r){gL(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Kx(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function gL(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const yL={breakpointCols:void 0,className:void 0,columnClassName:void 0,children:void 0,columnAttrs:void 0,column:void 0},tg=2;class NR extends Us.Component{constructor(e){super(e),this.reCalculateColumnCount=this.reCalculateColumnCount.bind(this),this.reCalculateColumnCountDebounce=this.reCalculateColumnCountDebounce.bind(this);let n;this.props.breakpointCols&&this.props.breakpointCols.default?n=this.props.breakpointCols.default:n=parseInt(this.props.breakpointCols)||tg,this.state={columnCount:n}}componentDidMount(){this.reCalculateColumnCount(),window&&window.addEventListener("resize",this.reCalculateColumnCountDebounce)}componentDidUpdate(){this.reCalculateColumnCount()}componentWillUnmount(){window&&window.removeEventListener("resize",this.reCalculateColumnCountDebounce)}reCalculateColumnCountDebounce(){if(!window||!window.requestAnimationFrame){this.reCalculateColumnCount();return}window.cancelAnimationFrame&&window.cancelAnimationFrame(this._lastRecalculateAnimationFrame),this._lastRecalculateAnimationFrame=window.requestAnimationFrame(()=>{this.reCalculateColumnCount()})}reCalculateColumnCount(){const e=window&&window.innerWidth||1/0;let n=this.props.breakpointCols;typeof n!="object"&&(n={default:parseInt(n)||tg});let r=1/0,s=n.default||tg;for(let a in n){const o=parseInt(a);o>0&&e<=o&&o<r&&(r=o,s=n[a])}s=Math.max(1,parseInt(s)||1),this.state.columnCount!==s&&this.setState({columnCount:s})}itemsInColumns(){const e=this.state.columnCount,n=new Array(e),r=Us.Children.toArray(this.props.children);for(let s=0;s<r.length;s++){const a=s%e;n[a]||(n[a]=[]),n[a].push(r[s])}return n}renderColumns(){const{column:e,columnAttrs:n={},columnClassName:r}=this.props,s=this.itemsInColumns(),a=`${100/s.length}%`;let o=r;o&&typeof o!="string"&&(this.logDeprecated('The property "columnClassName" requires a string'),typeof o>"u"&&(o="my-masonry-grid_column"));const u=lu(lu(lu({},e),n),{},{style:lu(lu({},n.style),{},{width:a}),className:o});return s.map((d,c)=>Us.createElement("div",xf({},u,{key:c}),d))}logDeprecated(e){console.error("[Masonry]",e)}render(){const e=this.props,{children:n,breakpointCols:r,columnClassName:s,columnAttrs:a,column:o,className:u}=e,d=hL(e,["children","breakpointCols","columnClassName","columnAttrs","column","className"]);let c=u;return typeof u!="string"&&(this.logDeprecated('The property "className" requires a string'),typeof u>"u"&&(c="my-masonry-grid")),Us.createElement("div",xf({},d,{className:c}),this.renderColumns())}}NR.defaultProps=yL;const Oo=["#4e79a7","#f28e2c","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ab"],Ao=Oo.map(t=>`${t}B3`),$d=Oo.map(t=>`${t}80`),_L="#3b82f6",vL="#2563eb",Wx="rgba(107, 114, 128, 0.2)",Ud="rgba(107, 114, 128, 0.5)";let Zx=!1;const wL=de.forwardRef(({chartType:t,data:e,plan:n,selectedIndices:r,onElementClick:s,onZoomChange:a,disableAnimation:o},u)=>{const d=de.useRef(null),c=de.useRef(null);return typeof Chart<"u"&&typeof ChartZoom<"u"&&!Zx&&(Chart.register(ChartZoom),Zx=!0),de.useImperativeHandle(u,()=>({resetZoom:()=>{var p;(p=c.current)==null||p.resetZoom()}})),de.useEffect(()=>{if(!d.current||!n)return;c.current&&c.current.destroy();const p=d.current.getContext("2d");if(!p)return;const{groupByColumn:m,valueColumn:y,xValueColumn:w,yValueColumn:x}=n,A=y||"count",E=r.length>0,C=P=>E?e.map((k,$)=>r.includes($)?_L:Wx):P,D=P=>E?e.map((k,$)=>r.includes($)?vL:Ud):P,O=P=>{if(!P||!P.scales||!P.scales.x)return!1;const k=P.getInitialScaleBounds().x,$={min:P.scales.x.min,max:P.scales.x.max};return k.min!==$.min||k.max!==$.max},T={maintainAspectRatio:!1,responsive:!0,animation:o?{duration:0}:void 0,onClick:(P,k)=>{k.length>0&&s(k[0].index,P)},plugins:{legend:{display:!1},tooltip:{backgroundColor:"#ffffff",titleColor:"#1e293b",bodyColor:"#475569",borderColor:"#e2e8f0",borderWidth:1,titleFont:{weight:"bold"},bodyFont:{size:13},padding:10}},scales:{x:{ticks:{color:"#64748b",callback:function(P){const k=this.getLabelForValue(Number(P));return typeof k=="string"&&k.length>30?k.substring(0,27)+"...":k}},grid:{color:"#e2e8f0"}},y:{ticks:{color:"#64748b"},grid:{color:"#e2e8f0"}}}},I={pan:{enabled:!0,mode:"xy",onPanComplete:({chart:P})=>a(O(P))},zoom:{wheel:{enabled:!1},pinch:{enabled:!0},mode:"xy",onZoomComplete:({chart:P})=>a(O(P))}},M=m?e.map(P=>P[m]):[],N=e.map(P=>P[A]);switch(t){case"bar":c.current=new Chart(p,{type:"bar",data:{labels:M,datasets:[{label:A,data:N,backgroundColor:C($d),borderColor:D(Ao),borderWidth:1}]},options:{...T}});break;case"line":c.current=new Chart(p,{type:"line",data:{labels:M,datasets:[{label:A,data:N,fill:!1,borderColor:E?Ud:Oo[0],pointBackgroundColor:C([Oo[0]]),pointBorderColor:D([Ao[0]]),pointRadius:E?5:3,pointHoverRadius:7,tension:.1}]},options:{...T,plugins:{...T.plugins,zoom:I}}});break;case"pie":case"doughnut":c.current=new Chart(p,{type:t,data:{labels:M,datasets:[{label:A,data:N,backgroundColor:C($d),borderColor:D(Ao),borderWidth:1,offset:E?e.map((F,K)=>r.includes(K)?20:0):0}]},options:{...T,scales:{x:{display:!1},y:{display:!1}}}});break;case"scatter":if(!w||!x)break;const P=e.map(F=>({x:F[w],y:F[x]}));c.current=new Chart(p,{type:"scatter",data:{datasets:[{label:`${x} vs ${w}`,data:P,backgroundColor:C($d),borderColor:D(Ao),borderWidth:1.5,pointRadius:E?e.map((F,K)=>r.includes(K)?7:4):5,pointHoverRadius:E?e.map((F,K)=>r.includes(K)?9:6):7}]},options:{...T,scales:{x:{...T.scales.x,title:{display:!0,text:w,color:"#64748b"}},y:{...T.scales.y,title:{display:!0,text:x,color:"#64748b"}}},plugins:{...T.plugins,zoom:I}}});break;case"combo":if(!m||!A||!n.secondaryValueColumn)break;const k=n.secondaryValueColumn,$=e.map(F=>F[A]),U=e.map(F=>F[k]);c.current=new Chart(p,{type:"bar",data:{labels:M,datasets:[{type:"bar",label:A,data:$,backgroundColor:C($d),borderColor:D(Ao),borderWidth:1,yAxisID:"y"},{type:"line",label:k,data:U,fill:!1,borderColor:E?Ud:Oo[1],pointBackgroundColor:E?Wx:Oo[1],pointBorderColor:E?Ud:Ao[1],pointRadius:E?5:3,pointHoverRadius:7,tension:.1,yAxisID:"y1"}]},options:{...T,scales:{...T.scales,y:{type:"linear",display:!0,position:"left",ticks:{color:"#64748b"},grid:{color:"#e2e8f0"},title:{display:!0,text:A,color:"#64748b"}},y1:{type:"linear",display:!0,position:"right",ticks:{color:"#64748b"},grid:{drawOnChartArea:!1},title:{display:!0,text:k,color:"#64748b"}}}}});break}return()=>{c.current&&c.current.destroy()}},[t,e,n,r,s,a,o]),S.jsx("canvas",{ref:d})}),Tf=(t,e=0,n)=>{if(t==null)return"";if(typeof t=="number")return Xx(t,n);if(typeof t=="string"){if(n&&(n==="currency"||n==="percentage"||n==="number")){const r=Number(t);if(!Number.isNaN(r))return Xx(r,n)}return t}if(typeof t=="boolean")return t?"true":"false";if(Array.isArray(t))return e>=1?`[${t.length} items]`:t.map(r=>Tf(r,e+1,n)).join(", ");if(typeof t=="object"){const r=Object.entries(t);return r.length===0?"{}":e>=1?`{${r.length} keys}`:r.map(([s,a])=>`${s}: ${Tf(a,e+1,n)}`).join("; ")}return String(t)},Xx=(t,e)=>{const n=e==null?void 0:e.toLowerCase();return n==="currency"?t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):n==="percentage"?`${t.toFixed(2)}%`:t.toLocaleString(void 0,{maximumFractionDigits:2})};class PR extends Error{constructor(e,n="unknown"){super(e),this.name="PlanExecutionError",this.code=n}}const MR=t=>typeof t=="string"&&t.startsWith("=")?`'${t}`:t,or=t=>{if(t==null)return null;let e=String(t).trim();if(e==="")return null;let n=!1;e.startsWith("(")&&e.endsWith(")")&&(e=e.substring(1,e.length-1),n=!0),e=e.replace(/[$\s%]/g,"");const r=e.lastIndexOf(","),s=e.lastIndexOf(".");r>s?e=e.replace(/\./g,"").replace(",","."):e=e.replace(/,/g,"");const a=parseFloat(e);return isNaN(a)?null:n?-a:a},bL=t=>typeof t!="string"||!t?!1:!isNaN(new Date(t).getTime())&&/[0-9]{1,4}[-/][0-9]{1,2}[-/][0-9]{1,4}/.test(t),kR=/^Q([1-4])(?:\s*\/?\s*('?\d{2,4}))?$/i,OR={january:1,jan:1,february:2,feb:2,march:3,mar:3,april:4,apr:4,may:5,june:6,jun:6,july:7,jul:7,august:8,aug:8,september:9,sep:9,october:10,oct:10,november:11,nov:11,december:12,dec:12},DR={monday:1,mon:1,tuesday:2,tue:2,wednesday:3,wed:3,thursday:4,thu:4,friday:5,fri:5,saturday:6,sat:6,sunday:7,sun:7},Qx=(t,e)=>{const n=String(t).toLowerCase().trim();switch(e){case"quarter":const r=n.match(kR);if(r){const s=parseInt(r[1],10);let a=0;if(r[2]){const o=r[2].replace("'","");a=parseInt(o,10),o.length===2&&(a+=a>50?1900:2e3)}return a*10+s}return 1/0;case"month":return OR[n]||1/0;case"day":return DR[n]||1/0}return 1/0},eT=(t,e)=>{if(t.length<2)return t;const n=t.slice(0,10).map(d=>String(d[e]).toLowerCase().trim());let r=null;const s=n.filter(d=>kR.test(d)).length,a=n.filter(d=>OR[d]!==void 0).length,o=n.filter(d=>DR[d]!==void 0).length,u=n.filter(bL).length;if(s/n.length>=.5)r="quarter";else if(a/n.length>=.5)r="month";else if(o/n.length>=.5)r="day";else if(u/n.length>=.5)return[...t].sort((d,c)=>new Date(String(d[e])).getTime()-new Date(String(c[e])).getTime());return r?[...t].sort((d,c)=>{const p=Qx(String(d[e]),r),m=Qx(String(c[e]),r);return p-m}):null},LR=(t,e,n,r)=>{if(t.length<=r)return t;const s=[...t].sort((u,d)=>(Number(d[n])||0)-(Number(u[n])||0)),a=s.slice(0,r),o=s.slice(r);if(o.length>0){const u=o.reduce((c,p)=>c+(Number(p[n])||0),0),d={[e]:"Others",[n]:u};return[...a,d]}return a},SL=/^column_\d+$/i,xL=t=>typeof t!="string"?"":t.replace(/[\u0000-\u001F]/g,"").trim(),TL=()=>{const t=new Map;return(e,n)=>{const r=xL(e),s=r.length>0?r:`column_${n+1}`,a=t.get(s)??0;return t.set(s,a+1),a===0?s:`${s}_${a+1}`}},AL=(t,e)=>t.filter(n=>e.some(r=>{const s=n[r];return s!==void 0&&String(s).trim()!==""})).map(n=>{const r={};return e.forEach(s=>{r[s]=MR(String(n[s]??""))}),r}),EL=t=>new Promise((e,n)=>{Papa.parse(t,{header:!1,skipEmptyLines:"greedy",worker:!0,complete:r=>{if(r.data.length===0){e({fileName:t.name,data:[]});return}const s=r.data.reduce((u,d)=>Math.max(u,d.length),0),a=Array.from({length:s},(u,d)=>`column_${d+1}`),o=r.data.map(u=>{const d={};return a.forEach((c,p)=>{const m=u[p]!==void 0?u[p]:"";d[c]=MR(String(m))}),d});e({fileName:t.name,data:o})},error:n})}),CL=t=>new Promise((e,n)=>{const r=TL(),s=[];Papa.parse(t,{header:!0,skipEmptyLines:"greedy",worker:!1,transformHeader:(a,o)=>{const u=r(a,o);return s[o]=u,u},complete:async a=>{try{if(!(s.length>0&&s.some(u=>!SL.test(u)))){const u=await EL(t);e(u);return}e({fileName:t.name,data:AL(a.data,s)})}catch(o){n(o)}},error:n})}),$u=t=>{if(!t||t.length===0)return[];const e=Object.keys(t[0]),n=[];for(const r of e){let s=!0;const a=t.map(c=>c[r]);let o=0;const u=t.length,d=a.filter(c=>c!==null&&String(c).trim()!=="").length;for(const c of a){const p=or(c);if(c!==null&&String(c).trim()!==""){if(p===null){s=!1;break}o++}}if(s&&o>0){const c=a.map(or).filter(m=>m!==null),p=u>0?c.length/u:0;n.push({name:r,type:"numerical",valueRange:[Math.min(...c),Math.max(...c)],missingPercentage:(1-p)*100,sampleSize:u,nonNullCount:d,numericSampleCount:c.length,numericSampleRatio:p})}else{const c=new Set(a.map(String));n.push({name:r,type:"categorical",uniqueValues:c.size,missingPercentage:u===0?0:a.filter(p=>p===null||String(p).trim()==="").length/u*100,sampleSize:u,nonNullCount:d})}}return n},$R=t=>t?String(t).replace(/,(?=-?\d)/g,"|").split("|"):[],yi=t=>t==null||t===""?"__NULL__":String(t),tT=(t,e)=>{const n=t.map(s=>typeof s=="number"?s:or(s)).filter(s=>typeof s=="number");if(n.length===0)return 0;const r=n.reduce((s,a)=>s+a,0);switch(e){case"avg":return r/n.length;case"count":return n.length;default:return r}},UR=()=>({parseNumber:or,splitNumericString:$R,groupBy:(t=[],e)=>{const n=typeof e=="function"?e:s=>s[e],r={};return t.forEach(s=>{const a=yi(n(s));r[a]||(r[a]=[]),r[a].push(s)}),Object.entries(r).map(([s,a])=>({key:s==="__NULL__"?null:s,rows:a,count:a.length}))},pivot:(t=[],e,n,r,s="sum")=>{const a=new Set,o=new Map;t.forEach(c=>{const p=yi(c[e]),m=yi(c[n]);a.add(m);const y=o.get(p)??{[e]:c[e]},w=y[m]??[];w.push(c[r]),y[m]=w,o.set(p,y)});const u=typeof s=="function"?s:c=>tT(c,s),d=Array.from(a);return Array.from(o.values()).map(c=>{const p={...c};return d.forEach(m=>{const y=Array.isArray(p[m])?p[m]:[];p[m]=u(y)}),p})},join:(t=[],e=[],n)=>{if(!(n!=null&&n.leftKey))throw new Error("join requires a leftKey.");const r=n.how||"inner",s=n.rightKey??n.leftKey,a=new Map;e.forEach(c=>{const p=yi(c[s]),m=a.get(p)??[];m.push(c),a.set(p,m)});const o=(c,p)=>c&&p?{...p,...c}:c?{...c}:p?{...p}:{},u=[],d=new Set;return t.forEach(c=>{const p=yi(c[n.leftKey]),m=a.get(p);m&&m.length>0?m.forEach(y=>{d.add(y),u.push(o(c,y))}):(r==="left"||r==="full")&&u.push(o(c,null))}),(r==="right"||r==="full")&&e.forEach(c=>{if(!d.has(c)){if(r==="right")u.push(o(null,c));else if(r==="full"){const p=yi(c[s]);t.filter(y=>yi(y[n.leftKey])===p).length===0&&u.push(o(null,c))}}}),u},rollingWindow:(t=[],e,n={column:"value",op:"avg"})=>{if(!Array.isArray(t)||e<=0)return[];const r=typeof n=="function"?n:s=>{const a=s.map(o=>o[n.column]);return tT(a,n.op??"avg")};return t.map((s,a)=>{const o=Math.max(0,a-e+1),u=t.slice(o,a+1);return{index:a,start:o,end:a,value:r(u,a)}})}}),nT=t=>t==null?"":typeof t=="number"?t.toString():String(t),IL=(t,e)=>{const n=Object.keys(t),r=Object.keys(e);if(n.length!==r.length)return!1;for(const s of n)if(!Object.prototype.hasOwnProperty.call(e,s)||nT(t[s])!==nT(e[s]))return!1;return!0},RL=t=>{const e=t.trim(),n=a=>`const __transform = ${a}; return __transform(data, _util);`,r=/^(?:async\s+)?function\s*(?:[\w$]+)?\s*\(/i,s=/^(?:async\s*)?\(?[\w\s,$]*\)?\s*=>/;return r.test(e)||s.test(e)?n(e):t},FR=(t,e)=>{try{const n=UR(),r=RL(e),a=new Function("data","_util",r)(t,n),o=()=>({rowsBefore:t.length,rowsAfter:t.length,addedRows:0,removedRows:0,modifiedRows:0,noOp:!0});if(!Array.isArray(a)||a.length>0&&typeof a[0]!="object")return console.warn("AI-generated transform function did not produce an array of row objects. Treating as pass-through.",{returnedValue:a,generatedCode:e}),{data:t,meta:o()};const u=a,d=t.length,c=u.length,p=d>c?d-c:0,m=c>d?c-d:0,y=Math.min(d,c);let w=0;for(let E=0;E<y;E++)IL(t[E],u[E])||w++;const x=p>0||m>0||w>0,A={rowsBefore:d,rowsAfter:c,addedRows:m,removedRows:p,modifiedRows:w,noOp:!x};return x||console.warn("AI-generated data transformation produced no observable row changes. Treating result as a no-op.",{generatedCode:e}),{data:u,meta:A}}catch(n){throw console.error("Error executing AI-generated JavaScript:",n),new Error(`AI-generated data transformation failed: ${n instanceof Error?n.message:String(n)}`)}},BR=(t,e)=>{try{const n=UR(),s=new Function("data","_util",e)(t,n);if(!Array.isArray(s))throw new Error("AI-generated filter function did not return an array.");return s}catch(n){throw console.error("Error executing AI-generated JavaScript filter:",n),new Error(`AI-generated data filter failed: ${n instanceof Error?n.message:String(n)}`)}},rT=t=>{if(t==null)return null;const e=String(t).trim();return e===""?null:e},NL=(t,e)=>{if(!(e!=null&&e.column)||!Array.isArray(e.values)||e.values.length===0)return t;const n=new Set(e.values.map(rT).filter(r=>r!==null));return n.size===0?t:t.filter(r=>{const s=rT(r[e.column]);return s!==null&&n.has(s)})},ng=(t,e)=>{if(t.length===0)return 0;switch(e){case"sum":return t.reduce((r,s)=>r+s,0);case"count":return t.length;case"avg":return t.reduce((r,s)=>r+s,0)/t.length;default:throw new Error(`Unsupported aggregation type: ${e}`)}},qR=(t,e)=>{const n=NL(t.data,e.rowFilter);if(e.rowFilter&&e.rowFilter.column&&Array.isArray(e.rowFilter.values)&&e.rowFilter.values.length>0&&n.length===0){const c=e.rowFilter.values.map(p=>`"${String(p)}"`).join(", ");throw new PR(`No rows matched the filter ${e.rowFilter.column}  ${c}. Remove or adjust the filter and try again.`,"no_rows")}if(e.chartType==="scatter"){const{xValueColumn:c,yValueColumn:p}=e;if(!c||!p)throw new Error("Scatter plot plan is missing xValueColumn or yValueColumn.");return n.map(m=>({[c]:or(m[c]),[p]:or(m[p])})).filter(m=>m[c]!==null&&m[p]!==null)}if(e.chartType==="combo"){const{groupByColumn:c,valueColumn:p,aggregation:m,secondaryValueColumn:y,secondaryAggregation:w}=e;if(!c||!p||!m||!y||!w)throw new Error("Combo chart plan is missing required aggregation fields.");const x={};n.forEach(C=>{const D=String(C[c]);if(D==="undefined"||D==="null")return;x[D]||(x[D]={primaryValues:[],secondaryValues:[]});const O=or(C[p]);O!==null&&x[D].primaryValues.push(O);const T=or(C[y]);T!==null&&x[D].secondaryValues.push(T)});const A=Object.keys(x).filter(C=>x[C].primaryValues.length>0||x[C].secondaryValues.length>0).map(C=>{const D=ng(x[C].primaryValues,m),O=ng(x[C].secondaryValues,w);return{[c]:C,[p]:D,[y]:O}});return eT(A,c)||A.sort((C,D)=>(Number(D[p])||0)-(Number(C[p])||0))}const{groupByColumn:r,valueColumn:s,aggregation:a}=e;if(!r||!a)throw new Error("Analysis plan is missing groupByColumn or aggregation type for non-scatter chart.");const o={};n.forEach(c=>{const p=String(c[r]);if(!(p==="undefined"||p==="null"))if(o[p]||(o[p]=[]),s){const m=or(c[s]);m!==null&&o[p].push(m)}else a==="count"&&o[p].push(1)});const u=Object.keys(o).filter(c=>o[c].length>0).map(c=>{const p=ng(o[c],a),m=s||"count";return{[r]:c,[m]:p}}),d=eT(u,r);if(d)return d;{const c=s||"count";return u.sort((p,m)=>(Number(m[c])||0)-(Number(p[c])||0))}},PL=new Set(["number","currency","percentage"]),Af=({data:t,schema:e})=>{if(!t||t.length===0)return S.jsx("p",{className:"text-slate-500",children:"No data to display."});const n=(e==null?void 0:e.map(o=>o.name))??Object.keys(t[0]),r=de.useMemo(()=>{if(!e)return new Map;const o=new Map;return e.forEach(u=>o.set(u.name,u.type)),o},[e]),s=de.useMemo(()=>{for(const o of n){const u=(r.get(o)??"").toLowerCase();if(PL.has(u))return o}return null},[n,r]),a=de.useMemo(()=>s?[...t].sort((o,u)=>{const d=or(o[s]),c=or(u[s]);return d===c?0:d==null?1:c==null?-1:c-d}):t,[t,s]);return S.jsx("div",{className:"w-full text-sm",children:S.jsxs("table",{className:"w-full text-left",children:[S.jsx("thead",{className:"bg-slate-100 text-slate-600",children:S.jsx("tr",{children:n.map(o=>S.jsx("th",{className:"p-2 font-semibold",children:o},o))})}),S.jsx("tbody",{className:"bg-white",children:a.map((o,u)=>S.jsx("tr",{className:"border-b border-slate-200 last:border-b-0",children:n.map(d=>S.jsx("td",{className:"p-2 text-slate-700",children:Tf(o[d],0,r.get(d))},`${u}-${d}`))},u))})]})})},GR=async(t,e)=>{try{const n=await htmlToImage.toPng(t,{backgroundColor:"#ffffff",pixelRatio:2}),r=document.createElement("a");r.download=`${e.replace(/ /g,"_")}.png`,r.href=n,r.click()}catch(n){console.error("Error exporting to PNG:",n)}},HR=(t,e)=>{try{const n=Papa.unparse(t),r=new Blob([n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(r),s.setAttribute("download",`${e.replace(/ /g,"_")}.csv`),s.click()}catch(n){console.error("Error exporting to CSV:",n)}},zR=async(t,e,n,r)=>{try{const s=t.querySelector("canvas");if(!s)throw new Error("Chart canvas not found for export.");const a=s.toDataURL("image/png"),o=`
      <table border="1" style="border-collapse: collapse; width: 100%; font-family: sans-serif; color: #333;">
        <thead>
          <tr style="background-color: #f2f2f2;">
            ${Object.keys(n[0]||{}).map(m=>`<th style="padding: 8px;">${m}</th>`).join("")}
          </tr>
        </thead>
        <tbody>
          ${n.map(m=>`
            <tr>
              ${Object.values(m).map(y=>`<td style="padding: 8px;">${y}</td>`).join("")}
            </tr>
          `).join("")}
        </tbody>
      </table>
    `,u=r.replace(/\n/g,"<br>").replace("---","<hr>"),d=`
      <!DOCTYPE html>
      <html lang="en">
        <head>
          <meta charset="UTF-8">
          <title>${e}</title>
          <style> body { font-family: sans-serif; line-height: 1.6; padding: 20px; } h1, h2 { color: #111827; } .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; } </style>
        </head>
        <body>
          <h1>Analysis Report: ${e}</h1>
          <div class="card">
            <h2>Chart</h2>
            <img src="${a}" alt="Chart for ${e}" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div class="card">
            <h2>AI Summary</h2>
            <p>${u}</p>
          </div>
          <div class="card">
            <h2>Data</h2>
            ${o}
          </div>
          <p style="font-size: 0.8em; color: #888;">Generated by CSV Data Analysis Agent on ${new Date().toLocaleString()}</p>
        </body>
      </html>
    `,c=new Blob([d],{type:"text/html;charset=utf-8;"}),p=document.createElement("a");p.href=URL.createObjectURL(c),p.setAttribute("download",`Report_${e.replace(/ /g,"_")}.html`),p.click()}catch(s){console.error("Error exporting to HTML:",s)}},ML=t=>{try{const e=new Blob([JSON.stringify(t,null,2)],{type:"application/json;charset=utf-8;"}),n=document.createElement("a");n.href=URL.createObjectURL(e),n.setAttribute("download",`${t.plan.title.replace(/ /g,"_")}.json`),n.click()}catch(e){console.error("Error exporting JSON:",e)}},kL=({type:t})=>{switch(t){case"bar":return S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{d:"M2 10a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H3a1 1 0 01-1-1v-4zM8 8a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1H9a1 1 0 01-1-1V8zM14 4a1 1 0 011-1h1a1 1 0 011 1v10a1 1 0 01-1 1h-1a1 1 0 01-1-1V4z"})});case"line":return S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{fillRule:"evenodd",d:"M3 3a1 1 0 000 2v8a1 1 0 001 1h12a1 1 0 100-2H5V3a1 1 0 00-2 0zm12.293 4.293a1 1 0 011.414 0l2 2a1 1 0 01-1.414 1.414L15 8.414l-2.293 2.293a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L12 7.586l1.293-1.293z",clipRule:"evenodd"})});case"pie":return S.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[S.jsx("path",{d:"M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"}),S.jsx("path",{d:"M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"})]});case"doughnut":return S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM7 10a3 3 0 116 0 3 3 0 01-6 0z",clipRule:"evenodd"})});case"scatter":return S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{d:"M5 3a2 2 0 100 4 2 2 0 000-4zM5 13a2 2 0 100 4 2 2 0 000-4zM15 3a2 2 0 100 4 2 2 0 000-4zM15 13a2 2 0 100 4 2 2 0 000-4zM8 8a2 2 0 100 4 2 2 0 000-4zM12 8a2 2 0 100 4 2 2 0 000-4z"})});case"combo":return S.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[S.jsx("path",{opacity:"0.6",d:"M2 10a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H3a1 1 0 01-1-1v-4zM8 8a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1H9a1 1 0 01-1-1V8zM14 4a1 1 0 011-1h1a1 1 0 011 1v10a1 1 0 01-1 1h-1a1 1 0 01-1-1V4z"}),S.jsx("path",{fillRule:"evenodd",d:"M3.293 11.293a1 1 0 011.414 0L8 14.586l2.293-2.293a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 15.414l-2.293 2.293a1 1 0 01-1.414 0L3.293 12.707a1 1 0 010-1.414z",clipRule:"evenodd"})]});default:return null}},OL=["bar","line","pie","doughnut","scatter","combo"],DL=({currentType:t,onChange:e})=>S.jsx("div",{className:"flex items-center space-x-1 bg-slate-200 p-1 rounded-md",children:OL.map(n=>S.jsx("button",{onClick:()=>e(n),title:`Switch to ${n} chart`,className:`p-1 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${t===n?"bg-blue-600 text-white":"text-slate-500 hover:bg-slate-300 hover:text-slate-700"}`,children:S.jsx(kL,{type:n})},n))}),sT=["#4e79a7","#f28e2c","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ab"],LL=({data:t,total:e,groupByKey:n,valueKey:r,hiddenLabels:s,onLabelClick:a})=>{const o=u=>typeof u=="number"?u.toLocaleString(void 0,{maximumFractionDigits:2}):u;return S.jsx("div",{className:"text-sm space-y-1 max-h-48 overflow-y-auto pr-2",children:t.map((u,d)=>{const c=String(u[n]),p=Number(u[r])||0,m=e>0?(p/e*100).toFixed(1):"0.0",y=s.includes(c),w=sT[d%sT.length];return S.jsxs("button",{onClick:()=>a(c),className:`w-full flex items-center justify-between p-1.5 rounded-md transition-all duration-200 ${y?"opacity-50":"hover:bg-slate-100"}`,title:`Click to ${y?"show":"hide"} "${c}"`,children:[S.jsxs("div",{className:"flex items-center truncate mr-2",children:[S.jsx("span",{className:"w-3 h-3 rounded-sm mr-2 flex-shrink-0",style:{backgroundColor:y?"#9ca3af":w}}),S.jsx("span",{className:`truncate text-xs ${y?"line-through text-slate-400":"text-slate-700"}`,children:c})]}),S.jsxs("div",{className:"flex items-baseline ml-2 flex-shrink-0",children:[S.jsx("span",{className:`font-semibold text-xs ${y?"text-slate-400":"text-slate-800"}`,children:o(p)}),S.jsxs("span",{className:"text-xs text-slate-500 ml-1.5 w-12 text-right",children:["(",m,"%)"]})]})]},c)})})},$L="modulepreload",UL=function(t){return"/"+t},aT={},np=function(e,n,r){let s=Promise.resolve();if(n&&n.length>0){let o=function(c){return Promise.all(c.map(p=>Promise.resolve(p).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),d=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));s=o(n.map(c=>{if(c=UL(c),c in aT)return;aT[c]=!0;const p=c.endsWith(".css"),m=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${m}`))return;const y=document.createElement("link");if(y.rel=p?"stylesheet":$L,p||(y.as="script"),y.crossOrigin="",y.href=c,d&&y.setAttribute("nonce",d),document.head.appendChild(y),p)return new Promise((w,x)=>{y.addEventListener("load",w),y.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(o){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=o,window.dispatchEvent(u),!u.defaultPrevented)throw o}return s.then(o=>{for(const u of o||[])u.status==="rejected"&&a(u.reason);return e().catch(a)})},FL={},iT=t=>{let e;const n=new Set,r=(p,m)=>{const y=typeof p=="function"?p(e):p;if(!Object.is(y,e)){const w=e;e=m??(typeof y!="object"||y===null)?y:Object.assign({},e,y),n.forEach(x=>x(e,w))}},s=()=>e,d={setState:r,getState:s,getInitialState:()=>c,subscribe:p=>(n.add(p),()=>n.delete(p)),destroy:()=>{(FL?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},c=e=t(r,s,d);return d},BL=t=>t?iT(t):iT;var rg={exports:{}},sg={},ag={exports:{}},ig={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var oT;function qL(){if(oT)return ig;oT=1;var t=rc();function e(m,y){return m===y&&(m!==0||1/m===1/y)||m!==m&&y!==y}var n=typeof Object.is=="function"?Object.is:e,r=t.useState,s=t.useEffect,a=t.useLayoutEffect,o=t.useDebugValue;function u(m,y){var w=y(),x=r({inst:{value:w,getSnapshot:y}}),A=x[0].inst,E=x[1];return a(function(){A.value=w,A.getSnapshot=y,d(A)&&E({inst:A})},[m,w,y]),s(function(){return d(A)&&E({inst:A}),m(function(){d(A)&&E({inst:A})})},[m]),o(w),w}function d(m){var y=m.getSnapshot;m=m.value;try{var w=y();return!n(m,w)}catch{return!0}}function c(m,y){return y()}var p=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?c:u;return ig.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:p,ig}var lT;function GL(){return lT||(lT=1,ag.exports=qL()),ag.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var uT;function HL(){if(uT)return sg;uT=1;var t=rc(),e=GL();function n(c,p){return c===p&&(c!==0||1/c===1/p)||c!==c&&p!==p}var r=typeof Object.is=="function"?Object.is:n,s=e.useSyncExternalStore,a=t.useRef,o=t.useEffect,u=t.useMemo,d=t.useDebugValue;return sg.useSyncExternalStoreWithSelector=function(c,p,m,y,w){var x=a(null);if(x.current===null){var A={hasValue:!1,value:null};x.current=A}else A=x.current;x=u(function(){function C(M){if(!D){if(D=!0,O=M,M=y(M),w!==void 0&&A.hasValue){var N=A.value;if(w(N,M))return T=N}return T=M}if(N=T,r(O,M))return N;var P=y(M);return w!==void 0&&w(N,P)?(O=M,N):(O=M,T=P)}var D=!1,O,T,I=m===void 0?null:m;return[function(){return C(p())},I===null?void 0:function(){return C(I())}]},[p,m,y,w]);var E=s(c,x[0],x[1]);return o(function(){A.hasValue=!0,A.value=E},[E]),d(E),E},sg}var cT;function zL(){return cT||(cT=1,rg.exports=HL()),rg.exports}var jL=zL();const VL=Ga(jL),jR={},{useDebugValue:JL}=Us,{useSyncExternalStoreWithSelector:YL}=VL;let dT=!1;const KL=t=>t;function WL(t,e=KL,n){(jR?"production":void 0)!=="production"&&n&&!dT&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),dT=!0);const r=YL(t.subscribe,t.getState,t.getServerState||t.getInitialState,e,n);return JL(r),r}const fT=t=>{(jR?"production":void 0)!=="production"&&typeof t!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const e=typeof t=="function"?BL(t):t,n=(r,s)=>WL(e,r,s);return Object.assign(n,e),n},ZL=t=>t?fT(t):fT;/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let XL,QL;function e$(){return{geminiUrl:XL,vertexUrl:QL}}function t$(t,e,n,r){var s,a;if(!(t!=null&&t.baseUrl)){const o=e$();return e?(s=o.vertexUrl)!==null&&s!==void 0?s:n:(a=o.geminiUrl)!==null&&a!==void 0?a:r}return t.baseUrl}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Vs{}function we(t,e){const n=/\{([^}]+)\}/g;return t.replace(n,(r,s)=>{if(Object.prototype.hasOwnProperty.call(e,s)){const a=e[s];return a!=null?String(a):""}else throw new Error(`Key '${s}' not found in valueMap.`)})}function _(t,e,n){for(let a=0;a<e.length-1;a++){const o=e[a];if(o.endsWith("[]")){const u=o.slice(0,-2);if(!(u in t))if(Array.isArray(n))t[u]=Array.from({length:n.length},()=>({}));else throw new Error(`Value must be a list given an array path ${o}`);if(Array.isArray(t[u])){const d=t[u];if(Array.isArray(n))for(let c=0;c<d.length;c++){const p=d[c];_(p,e.slice(a+1),n[c])}else for(const c of d)_(c,e.slice(a+1),n)}return}else if(o.endsWith("[0]")){const u=o.slice(0,-3);u in t||(t[u]=[{}]);const d=t[u];_(d[0],e.slice(a+1),n);return}(!t[o]||typeof t[o]!="object")&&(t[o]={}),t=t[o]}const r=e[e.length-1],s=t[r];if(s!==void 0){if(!n||typeof n=="object"&&Object.keys(n).length===0||n===s)return;if(typeof s=="object"&&typeof n=="object"&&s!==null&&n!==null)Object.assign(s,n);else throw new Error(`Cannot set value for an existing key. Key: ${r}`)}else r==="_self"&&typeof n=="object"&&n!==null&&!Array.isArray(n)?Object.assign(t,n):t[r]=n}function g(t,e,n=void 0){try{if(e.length===1&&e[0]==="_self")return t;for(let r=0;r<e.length;r++){if(typeof t!="object"||t===null)return n;const s=e[r];if(s.endsWith("[]")){const a=s.slice(0,-2);if(a in t){const o=t[a];return Array.isArray(o)?o.map(u=>g(u,e.slice(r+1),n)):n}else return n}else t=t[s]}return t}catch(r){if(r instanceof TypeError)return n;throw r}}function n$(t,e){for(const[n,r]of Object.entries(e)){const s=n.split("."),a=r.split("."),o=new Set;let u=-1;for(let d=0;d<s.length;d++)if(s[d]==="*"){u=d;break}if(u!==-1&&a.length>u)for(let d=u;d<a.length;d++){const c=a[d];c!=="*"&&!c.endsWith("[]")&&!c.endsWith("[0]")&&o.add(c)}e_(t,s,a,0,o)}}function e_(t,e,n,r,s){if(r>=e.length||typeof t!="object"||t===null)return;const a=e[r];if(a.endsWith("[]")){const o=a.slice(0,-2),u=t;if(o in u&&Array.isArray(u[o]))for(const d of u[o])e_(d,e,n,r+1,s)}else if(a==="*"){if(typeof t=="object"&&t!==null&&!Array.isArray(t)){const o=t,u=Object.keys(o).filter(c=>!c.startsWith("_")&&!s.has(c)),d={};for(const c of u)d[c]=o[c];for(const[c,p]of Object.entries(d)){const m=[];for(const y of n.slice(r))y==="*"?m.push(c):m.push(y);_(o,m,p)}for(const c of u)delete o[c]}}else{const o=t;a in o&&e_(o[a],e,n,r+1,s)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function m0(t){if(typeof t!="string")throw new Error("fromImageBytes must be a string");return t}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function r$(t){const e={},n=g(t,["operationName"]);n!=null&&_(e,["operationName"],n);const r=g(t,["resourceName"]);return r!=null&&_(e,["_url","resourceName"],r),e}function s$(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata"]);r!=null&&_(e,["metadata"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["response","generateVideoResponse"]);return o!=null&&_(e,["response"],i$(o)),e}function a$(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata"]);r!=null&&_(e,["metadata"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["response"]);return o!=null&&_(e,["response"],o$(o)),e}function i$(t){const e={},n=g(t,["generatedSamples"]);if(n!=null){let a=n;Array.isArray(a)&&(a=a.map(o=>l$(o))),_(e,["generatedVideos"],a)}const r=g(t,["raiMediaFilteredCount"]);r!=null&&_(e,["raiMediaFilteredCount"],r);const s=g(t,["raiMediaFilteredReasons"]);return s!=null&&_(e,["raiMediaFilteredReasons"],s),e}function o$(t){const e={},n=g(t,["videos"]);if(n!=null){let a=n;Array.isArray(a)&&(a=a.map(o=>u$(o))),_(e,["generatedVideos"],a)}const r=g(t,["raiMediaFilteredCount"]);r!=null&&_(e,["raiMediaFilteredCount"],r);const s=g(t,["raiMediaFilteredReasons"]);return s!=null&&_(e,["raiMediaFilteredReasons"],s),e}function l$(t){const e={},n=g(t,["video"]);return n!=null&&_(e,["video"],m$(n)),e}function u$(t){const e={},n=g(t,["_self"]);return n!=null&&_(e,["video"],g$(n)),e}function c$(t){const e={},n=g(t,["operationName"]);return n!=null&&_(e,["_url","operationName"],n),e}function d$(t){const e={},n=g(t,["operationName"]);return n!=null&&_(e,["_url","operationName"],n),e}function f$(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata"]);r!=null&&_(e,["metadata"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["response"]);return o!=null&&_(e,["response"],p$(o)),e}function p$(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["parent"]);r!=null&&_(e,["parent"],r);const s=g(t,["documentName"]);return s!=null&&_(e,["documentName"],s),e}function VR(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata"]);r!=null&&_(e,["metadata"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["response"]);return o!=null&&_(e,["response"],h$(o)),e}function h$(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["parent"]);r!=null&&_(e,["parent"],r);const s=g(t,["documentName"]);return s!=null&&_(e,["documentName"],s),e}function m$(t){const e={},n=g(t,["uri"]);n!=null&&_(e,["uri"],n);const r=g(t,["encodedVideo"]);r!=null&&_(e,["videoBytes"],m0(r));const s=g(t,["encoding"]);return s!=null&&_(e,["mimeType"],s),e}function g$(t){const e={},n=g(t,["gcsUri"]);n!=null&&_(e,["uri"],n);const r=g(t,["bytesBase64Encoded"]);r!=null&&_(e,["videoBytes"],m0(r));const s=g(t,["mimeType"]);return s!=null&&_(e,["mimeType"],s),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var pT;(function(t){t.OUTCOME_UNSPECIFIED="OUTCOME_UNSPECIFIED",t.OUTCOME_OK="OUTCOME_OK",t.OUTCOME_FAILED="OUTCOME_FAILED",t.OUTCOME_DEADLINE_EXCEEDED="OUTCOME_DEADLINE_EXCEEDED"})(pT||(pT={}));var hT;(function(t){t.LANGUAGE_UNSPECIFIED="LANGUAGE_UNSPECIFIED",t.PYTHON="PYTHON"})(hT||(hT={}));var mT;(function(t){t.SCHEDULING_UNSPECIFIED="SCHEDULING_UNSPECIFIED",t.SILENT="SILENT",t.WHEN_IDLE="WHEN_IDLE",t.INTERRUPT="INTERRUPT"})(mT||(mT={}));var te;(function(t){t.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",t.STRING="STRING",t.NUMBER="NUMBER",t.INTEGER="INTEGER",t.BOOLEAN="BOOLEAN",t.ARRAY="ARRAY",t.OBJECT="OBJECT",t.NULL="NULL"})(te||(te={}));var gT;(function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.MODE_DYNAMIC="MODE_DYNAMIC"})(gT||(gT={}));var yT;(function(t){t.API_SPEC_UNSPECIFIED="API_SPEC_UNSPECIFIED",t.SIMPLE_SEARCH="SIMPLE_SEARCH",t.ELASTIC_SEARCH="ELASTIC_SEARCH"})(yT||(yT={}));var _T;(function(t){t.AUTH_TYPE_UNSPECIFIED="AUTH_TYPE_UNSPECIFIED",t.NO_AUTH="NO_AUTH",t.API_KEY_AUTH="API_KEY_AUTH",t.HTTP_BASIC_AUTH="HTTP_BASIC_AUTH",t.GOOGLE_SERVICE_ACCOUNT_AUTH="GOOGLE_SERVICE_ACCOUNT_AUTH",t.OAUTH="OAUTH",t.OIDC_AUTH="OIDC_AUTH"})(_T||(_T={}));var vT;(function(t){t.HTTP_IN_UNSPECIFIED="HTTP_IN_UNSPECIFIED",t.HTTP_IN_QUERY="HTTP_IN_QUERY",t.HTTP_IN_HEADER="HTTP_IN_HEADER",t.HTTP_IN_PATH="HTTP_IN_PATH",t.HTTP_IN_BODY="HTTP_IN_BODY",t.HTTP_IN_COOKIE="HTTP_IN_COOKIE"})(vT||(vT={}));var wT;(function(t){t.PHISH_BLOCK_THRESHOLD_UNSPECIFIED="PHISH_BLOCK_THRESHOLD_UNSPECIFIED",t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_HIGH_AND_ABOVE="BLOCK_HIGH_AND_ABOVE",t.BLOCK_HIGHER_AND_ABOVE="BLOCK_HIGHER_AND_ABOVE",t.BLOCK_VERY_HIGH_AND_ABOVE="BLOCK_VERY_HIGH_AND_ABOVE",t.BLOCK_ONLY_EXTREMELY_HIGH="BLOCK_ONLY_EXTREMELY_HIGH"})(wT||(wT={}));var bT;(function(t){t.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",t.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",t.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",t.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",t.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",t.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",t.HARM_CATEGORY_IMAGE_HATE="HARM_CATEGORY_IMAGE_HATE",t.HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT="HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT",t.HARM_CATEGORY_IMAGE_HARASSMENT="HARM_CATEGORY_IMAGE_HARASSMENT",t.HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT="HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT",t.HARM_CATEGORY_JAILBREAK="HARM_CATEGORY_JAILBREAK"})(bT||(bT={}));var ST;(function(t){t.HARM_BLOCK_METHOD_UNSPECIFIED="HARM_BLOCK_METHOD_UNSPECIFIED",t.SEVERITY="SEVERITY",t.PROBABILITY="PROBABILITY"})(ST||(ST={}));var xT;(function(t){t.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",t.BLOCK_NONE="BLOCK_NONE",t.OFF="OFF"})(xT||(xT={}));var TT;(function(t){t.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",t.STOP="STOP",t.MAX_TOKENS="MAX_TOKENS",t.SAFETY="SAFETY",t.RECITATION="RECITATION",t.LANGUAGE="LANGUAGE",t.OTHER="OTHER",t.BLOCKLIST="BLOCKLIST",t.PROHIBITED_CONTENT="PROHIBITED_CONTENT",t.SPII="SPII",t.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",t.IMAGE_SAFETY="IMAGE_SAFETY",t.UNEXPECTED_TOOL_CALL="UNEXPECTED_TOOL_CALL",t.IMAGE_PROHIBITED_CONTENT="IMAGE_PROHIBITED_CONTENT",t.NO_IMAGE="NO_IMAGE"})(TT||(TT={}));var AT;(function(t){t.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",t.NEGLIGIBLE="NEGLIGIBLE",t.LOW="LOW",t.MEDIUM="MEDIUM",t.HIGH="HIGH"})(AT||(AT={}));var ET;(function(t){t.HARM_SEVERITY_UNSPECIFIED="HARM_SEVERITY_UNSPECIFIED",t.HARM_SEVERITY_NEGLIGIBLE="HARM_SEVERITY_NEGLIGIBLE",t.HARM_SEVERITY_LOW="HARM_SEVERITY_LOW",t.HARM_SEVERITY_MEDIUM="HARM_SEVERITY_MEDIUM",t.HARM_SEVERITY_HIGH="HARM_SEVERITY_HIGH"})(ET||(ET={}));var CT;(function(t){t.URL_RETRIEVAL_STATUS_UNSPECIFIED="URL_RETRIEVAL_STATUS_UNSPECIFIED",t.URL_RETRIEVAL_STATUS_SUCCESS="URL_RETRIEVAL_STATUS_SUCCESS",t.URL_RETRIEVAL_STATUS_ERROR="URL_RETRIEVAL_STATUS_ERROR",t.URL_RETRIEVAL_STATUS_PAYWALL="URL_RETRIEVAL_STATUS_PAYWALL",t.URL_RETRIEVAL_STATUS_UNSAFE="URL_RETRIEVAL_STATUS_UNSAFE"})(CT||(CT={}));var IT;(function(t){t.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",t.SAFETY="SAFETY",t.OTHER="OTHER",t.BLOCKLIST="BLOCKLIST",t.PROHIBITED_CONTENT="PROHIBITED_CONTENT",t.IMAGE_SAFETY="IMAGE_SAFETY",t.MODEL_ARMOR="MODEL_ARMOR",t.JAILBREAK="JAILBREAK"})(IT||(IT={}));var RT;(function(t){t.TRAFFIC_TYPE_UNSPECIFIED="TRAFFIC_TYPE_UNSPECIFIED",t.ON_DEMAND="ON_DEMAND",t.PROVISIONED_THROUGHPUT="PROVISIONED_THROUGHPUT"})(RT||(RT={}));var Ef;(function(t){t.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",t.TEXT="TEXT",t.IMAGE="IMAGE",t.AUDIO="AUDIO"})(Ef||(Ef={}));var NT;(function(t){t.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",t.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",t.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",t.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH"})(NT||(NT={}));var PT;(function(t){t.TUNING_MODE_UNSPECIFIED="TUNING_MODE_UNSPECIFIED",t.TUNING_MODE_FULL="TUNING_MODE_FULL",t.TUNING_MODE_PEFT_ADAPTER="TUNING_MODE_PEFT_ADAPTER"})(PT||(PT={}));var MT;(function(t){t.ADAPTER_SIZE_UNSPECIFIED="ADAPTER_SIZE_UNSPECIFIED",t.ADAPTER_SIZE_ONE="ADAPTER_SIZE_ONE",t.ADAPTER_SIZE_TWO="ADAPTER_SIZE_TWO",t.ADAPTER_SIZE_FOUR="ADAPTER_SIZE_FOUR",t.ADAPTER_SIZE_EIGHT="ADAPTER_SIZE_EIGHT",t.ADAPTER_SIZE_SIXTEEN="ADAPTER_SIZE_SIXTEEN",t.ADAPTER_SIZE_THIRTY_TWO="ADAPTER_SIZE_THIRTY_TWO"})(MT||(MT={}));var t_;(function(t){t.JOB_STATE_UNSPECIFIED="JOB_STATE_UNSPECIFIED",t.JOB_STATE_QUEUED="JOB_STATE_QUEUED",t.JOB_STATE_PENDING="JOB_STATE_PENDING",t.JOB_STATE_RUNNING="JOB_STATE_RUNNING",t.JOB_STATE_SUCCEEDED="JOB_STATE_SUCCEEDED",t.JOB_STATE_FAILED="JOB_STATE_FAILED",t.JOB_STATE_CANCELLING="JOB_STATE_CANCELLING",t.JOB_STATE_CANCELLED="JOB_STATE_CANCELLED",t.JOB_STATE_PAUSED="JOB_STATE_PAUSED",t.JOB_STATE_EXPIRED="JOB_STATE_EXPIRED",t.JOB_STATE_UPDATING="JOB_STATE_UPDATING",t.JOB_STATE_PARTIALLY_SUCCEEDED="JOB_STATE_PARTIALLY_SUCCEEDED"})(t_||(t_={}));var kT;(function(t){t.TUNING_TASK_UNSPECIFIED="TUNING_TASK_UNSPECIFIED",t.TUNING_TASK_I2V="TUNING_TASK_I2V",t.TUNING_TASK_T2V="TUNING_TASK_T2V",t.TUNING_TASK_R2V="TUNING_TASK_R2V"})(kT||(kT={}));var OT;(function(t){t.FEATURE_SELECTION_PREFERENCE_UNSPECIFIED="FEATURE_SELECTION_PREFERENCE_UNSPECIFIED",t.PRIORITIZE_QUALITY="PRIORITIZE_QUALITY",t.BALANCED="BALANCED",t.PRIORITIZE_COST="PRIORITIZE_COST"})(OT||(OT={}));var DT;(function(t){t.UNSPECIFIED="UNSPECIFIED",t.BLOCKING="BLOCKING",t.NON_BLOCKING="NON_BLOCKING"})(DT||(DT={}));var LT;(function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.MODE_DYNAMIC="MODE_DYNAMIC"})(LT||(LT={}));var $T;(function(t){t.ENVIRONMENT_UNSPECIFIED="ENVIRONMENT_UNSPECIFIED",t.ENVIRONMENT_BROWSER="ENVIRONMENT_BROWSER"})($T||($T={}));var UT;(function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.AUTO="AUTO",t.ANY="ANY",t.NONE="NONE",t.VALIDATED="VALIDATED"})(UT||(UT={}));var FT;(function(t){t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",t.BLOCK_NONE="BLOCK_NONE"})(FT||(FT={}));var BT;(function(t){t.DONT_ALLOW="DONT_ALLOW",t.ALLOW_ADULT="ALLOW_ADULT",t.ALLOW_ALL="ALLOW_ALL"})(BT||(BT={}));var qT;(function(t){t.auto="auto",t.en="en",t.ja="ja",t.ko="ko",t.hi="hi",t.zh="zh",t.pt="pt",t.es="es"})(qT||(qT={}));var GT;(function(t){t.MASK_MODE_DEFAULT="MASK_MODE_DEFAULT",t.MASK_MODE_USER_PROVIDED="MASK_MODE_USER_PROVIDED",t.MASK_MODE_BACKGROUND="MASK_MODE_BACKGROUND",t.MASK_MODE_FOREGROUND="MASK_MODE_FOREGROUND",t.MASK_MODE_SEMANTIC="MASK_MODE_SEMANTIC"})(GT||(GT={}));var HT;(function(t){t.CONTROL_TYPE_DEFAULT="CONTROL_TYPE_DEFAULT",t.CONTROL_TYPE_CANNY="CONTROL_TYPE_CANNY",t.CONTROL_TYPE_SCRIBBLE="CONTROL_TYPE_SCRIBBLE",t.CONTROL_TYPE_FACE_MESH="CONTROL_TYPE_FACE_MESH"})(HT||(HT={}));var zT;(function(t){t.SUBJECT_TYPE_DEFAULT="SUBJECT_TYPE_DEFAULT",t.SUBJECT_TYPE_PERSON="SUBJECT_TYPE_PERSON",t.SUBJECT_TYPE_ANIMAL="SUBJECT_TYPE_ANIMAL",t.SUBJECT_TYPE_PRODUCT="SUBJECT_TYPE_PRODUCT"})(zT||(zT={}));var jT;(function(t){t.EDIT_MODE_DEFAULT="EDIT_MODE_DEFAULT",t.EDIT_MODE_INPAINT_REMOVAL="EDIT_MODE_INPAINT_REMOVAL",t.EDIT_MODE_INPAINT_INSERTION="EDIT_MODE_INPAINT_INSERTION",t.EDIT_MODE_OUTPAINT="EDIT_MODE_OUTPAINT",t.EDIT_MODE_CONTROLLED_EDITING="EDIT_MODE_CONTROLLED_EDITING",t.EDIT_MODE_STYLE="EDIT_MODE_STYLE",t.EDIT_MODE_BGSWAP="EDIT_MODE_BGSWAP",t.EDIT_MODE_PRODUCT_IMAGE="EDIT_MODE_PRODUCT_IMAGE"})(jT||(jT={}));var VT;(function(t){t.FOREGROUND="FOREGROUND",t.BACKGROUND="BACKGROUND",t.PROMPT="PROMPT",t.SEMANTIC="SEMANTIC",t.INTERACTIVE="INTERACTIVE"})(VT||(VT={}));var JT;(function(t){t.ASSET="ASSET",t.STYLE="STYLE"})(JT||(JT={}));var YT;(function(t){t.INSERT="INSERT",t.REMOVE="REMOVE",t.REMOVE_STATIC="REMOVE_STATIC",t.OUTPAINT="OUTPAINT"})(YT||(YT={}));var KT;(function(t){t.OPTIMIZED="OPTIMIZED",t.LOSSLESS="LOSSLESS"})(KT||(KT={}));var WT;(function(t){t.SUPERVISED_FINE_TUNING="SUPERVISED_FINE_TUNING",t.PREFERENCE_TUNING="PREFERENCE_TUNING"})(WT||(WT={}));var ZT;(function(t){t.STATE_UNSPECIFIED="STATE_UNSPECIFIED",t.STATE_PENDING="STATE_PENDING",t.STATE_ACTIVE="STATE_ACTIVE",t.STATE_FAILED="STATE_FAILED"})(ZT||(ZT={}));var XT;(function(t){t.STATE_UNSPECIFIED="STATE_UNSPECIFIED",t.PROCESSING="PROCESSING",t.ACTIVE="ACTIVE",t.FAILED="FAILED"})(XT||(XT={}));var QT;(function(t){t.SOURCE_UNSPECIFIED="SOURCE_UNSPECIFIED",t.UPLOADED="UPLOADED",t.GENERATED="GENERATED"})(QT||(QT={}));var eA;(function(t){t.TURN_COMPLETE_REASON_UNSPECIFIED="TURN_COMPLETE_REASON_UNSPECIFIED",t.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",t.RESPONSE_REJECTED="RESPONSE_REJECTED",t.NEED_MORE_INPUT="NEED_MORE_INPUT"})(eA||(eA={}));var tA;(function(t){t.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",t.TEXT="TEXT",t.IMAGE="IMAGE",t.VIDEO="VIDEO",t.AUDIO="AUDIO",t.DOCUMENT="DOCUMENT"})(tA||(tA={}));var nA;(function(t){t.START_SENSITIVITY_UNSPECIFIED="START_SENSITIVITY_UNSPECIFIED",t.START_SENSITIVITY_HIGH="START_SENSITIVITY_HIGH",t.START_SENSITIVITY_LOW="START_SENSITIVITY_LOW"})(nA||(nA={}));var rA;(function(t){t.END_SENSITIVITY_UNSPECIFIED="END_SENSITIVITY_UNSPECIFIED",t.END_SENSITIVITY_HIGH="END_SENSITIVITY_HIGH",t.END_SENSITIVITY_LOW="END_SENSITIVITY_LOW"})(rA||(rA={}));var sA;(function(t){t.ACTIVITY_HANDLING_UNSPECIFIED="ACTIVITY_HANDLING_UNSPECIFIED",t.START_OF_ACTIVITY_INTERRUPTS="START_OF_ACTIVITY_INTERRUPTS",t.NO_INTERRUPTION="NO_INTERRUPTION"})(sA||(sA={}));var aA;(function(t){t.TURN_COVERAGE_UNSPECIFIED="TURN_COVERAGE_UNSPECIFIED",t.TURN_INCLUDES_ONLY_ACTIVITY="TURN_INCLUDES_ONLY_ACTIVITY",t.TURN_INCLUDES_ALL_INPUT="TURN_INCLUDES_ALL_INPUT"})(aA||(aA={}));var iA;(function(t){t.SCALE_UNSPECIFIED="SCALE_UNSPECIFIED",t.C_MAJOR_A_MINOR="C_MAJOR_A_MINOR",t.D_FLAT_MAJOR_B_FLAT_MINOR="D_FLAT_MAJOR_B_FLAT_MINOR",t.D_MAJOR_B_MINOR="D_MAJOR_B_MINOR",t.E_FLAT_MAJOR_C_MINOR="E_FLAT_MAJOR_C_MINOR",t.E_MAJOR_D_FLAT_MINOR="E_MAJOR_D_FLAT_MINOR",t.F_MAJOR_D_MINOR="F_MAJOR_D_MINOR",t.G_FLAT_MAJOR_E_FLAT_MINOR="G_FLAT_MAJOR_E_FLAT_MINOR",t.G_MAJOR_E_MINOR="G_MAJOR_E_MINOR",t.A_FLAT_MAJOR_F_MINOR="A_FLAT_MAJOR_F_MINOR",t.A_MAJOR_G_FLAT_MINOR="A_MAJOR_G_FLAT_MINOR",t.B_FLAT_MAJOR_G_MINOR="B_FLAT_MAJOR_G_MINOR",t.B_MAJOR_A_FLAT_MINOR="B_MAJOR_A_FLAT_MINOR"})(iA||(iA={}));var oA;(function(t){t.MUSIC_GENERATION_MODE_UNSPECIFIED="MUSIC_GENERATION_MODE_UNSPECIFIED",t.QUALITY="QUALITY",t.DIVERSITY="DIVERSITY",t.VOCALIZATION="VOCALIZATION"})(oA||(oA={}));var Do;(function(t){t.PLAYBACK_CONTROL_UNSPECIFIED="PLAYBACK_CONTROL_UNSPECIFIED",t.PLAY="PLAY",t.PAUSE="PAUSE",t.STOP="STOP",t.RESET_CONTEXT="RESET_CONTEXT"})(Do||(Do={}));class n_{constructor(e){const n={};for(const r of e.headers.entries())n[r[0]]=r[1];this.headers=n,this.responseInternal=e}json(){return this.responseInternal.json()}}class uu{get text(){var e,n,r,s,a,o,u,d;if(((s=(r=(n=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||n===void 0?void 0:n.content)===null||r===void 0?void 0:r.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning text from the first one.");let c="",p=!1;const m=[];for(const y of(d=(u=(o=(a=this.candidates)===null||a===void 0?void 0:a[0])===null||o===void 0?void 0:o.content)===null||u===void 0?void 0:u.parts)!==null&&d!==void 0?d:[]){for(const[w,x]of Object.entries(y))w!=="text"&&w!=="thought"&&(x!==null||x!==void 0)&&m.push(w);if(typeof y.text=="string"){if(typeof y.thought=="boolean"&&y.thought)continue;p=!0,c+=y.text}}return m.length>0&&console.warn(`there are non-text parts ${m} in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.`),p?c:void 0}get data(){var e,n,r,s,a,o,u,d;if(((s=(r=(n=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||n===void 0?void 0:n.content)===null||r===void 0?void 0:r.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning data from the first one.");let c="";const p=[];for(const m of(d=(u=(o=(a=this.candidates)===null||a===void 0?void 0:a[0])===null||o===void 0?void 0:o.content)===null||u===void 0?void 0:u.parts)!==null&&d!==void 0?d:[]){for(const[y,w]of Object.entries(m))y!=="inlineData"&&(w!==null||w!==void 0)&&p.push(y);m.inlineData&&typeof m.inlineData.data=="string"&&(c+=atob(m.inlineData.data))}return p.length>0&&console.warn(`there are non-data parts ${p} in the response, returning concatenation of all data parts. Please refer to the non data parts for a full response from model.`),c.length>0?btoa(c):void 0}get functionCalls(){var e,n,r,s,a,o,u,d;if(((s=(r=(n=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||n===void 0?void 0:n.content)===null||r===void 0?void 0:r.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning function calls from the first one.");const c=(d=(u=(o=(a=this.candidates)===null||a===void 0?void 0:a[0])===null||o===void 0?void 0:o.content)===null||u===void 0?void 0:u.parts)===null||d===void 0?void 0:d.filter(p=>p.functionCall).map(p=>p.functionCall).filter(p=>p!==void 0);if((c==null?void 0:c.length)!==0)return c}get executableCode(){var e,n,r,s,a,o,u,d,c;if(((s=(r=(n=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||n===void 0?void 0:n.content)===null||r===void 0?void 0:r.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning executable code from the first one.");const p=(d=(u=(o=(a=this.candidates)===null||a===void 0?void 0:a[0])===null||o===void 0?void 0:o.content)===null||u===void 0?void 0:u.parts)===null||d===void 0?void 0:d.filter(m=>m.executableCode).map(m=>m.executableCode).filter(m=>m!==void 0);if((p==null?void 0:p.length)!==0)return(c=p==null?void 0:p[0])===null||c===void 0?void 0:c.code}get codeExecutionResult(){var e,n,r,s,a,o,u,d,c;if(((s=(r=(n=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||n===void 0?void 0:n.content)===null||r===void 0?void 0:r.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning code execution result from the first one.");const p=(d=(u=(o=(a=this.candidates)===null||a===void 0?void 0:a[0])===null||o===void 0?void 0:o.content)===null||u===void 0?void 0:u.parts)===null||d===void 0?void 0:d.filter(m=>m.codeExecutionResult).map(m=>m.codeExecutionResult).filter(m=>m!==void 0);if((p==null?void 0:p.length)!==0)return(c=p==null?void 0:p[0])===null||c===void 0?void 0:c.output}}class lA{}class uA{}class y${}class _${}class v${}class w${}class cA{}class dA{}class fA{}class b${}class Cf{_fromAPIResponse({apiResponse:e,_isVertexAI:n}){const r=new Cf;let s;const a=e;return n?s=a$(a):s=s$(a),Object.assign(r,s),r}}class pA{}class hA{}class mA{}class S${}class x${}class T${}class g0{_fromAPIResponse({apiResponse:e,_isVertexAI:n}){const r=new g0,a=f$(e);return Object.assign(r,a),r}}class A${}class E${}class C${}class gA{}class I${get text(){var e,n,r;let s="",a=!1;const o=[];for(const u of(r=(n=(e=this.serverContent)===null||e===void 0?void 0:e.modelTurn)===null||n===void 0?void 0:n.parts)!==null&&r!==void 0?r:[]){for(const[d,c]of Object.entries(u))d!=="text"&&d!=="thought"&&c!==null&&o.push(d);if(typeof u.text=="string"){if(typeof u.thought=="boolean"&&u.thought)continue;a=!0,s+=u.text}}return o.length>0&&console.warn(`there are non-text parts ${o} in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.`),a?s:void 0}get data(){var e,n,r;let s="";const a=[];for(const o of(r=(n=(e=this.serverContent)===null||e===void 0?void 0:e.modelTurn)===null||n===void 0?void 0:n.parts)!==null&&r!==void 0?r:[]){for(const[u,d]of Object.entries(o))u!=="inlineData"&&d!==null&&a.push(u);o.inlineData&&typeof o.inlineData.data=="string"&&(s+=atob(o.inlineData.data))}return a.length>0&&console.warn(`there are non-data parts ${a} in the response, returning concatenation of all data parts. Please refer to the non data parts for a full response from model.`),s.length>0?btoa(s):void 0}}class R${get audioChunk(){if(this.serverContent&&this.serverContent.audioChunks&&this.serverContent.audioChunks.length>0)return this.serverContent.audioChunks[0]}}class y0{_fromAPIResponse({apiResponse:e,_isVertexAI:n}){const r=new y0,a=VR(e);return Object.assign(r,a),r}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function ht(t,e){if(!e||typeof e!="string")throw new Error("model is required and must be a string");if(t.isVertexAI()){if(e.startsWith("publishers/")||e.startsWith("projects/")||e.startsWith("models/"))return e;if(e.indexOf("/")>=0){const n=e.split("/",2);return`publishers/${n[0]}/models/${n[1]}`}else return`publishers/google/models/${e}`}else return e.startsWith("models/")||e.startsWith("tunedModels/")?e:`models/${e}`}function JR(t,e){const n=ht(t,e);return n?n.startsWith("publishers/")&&t.isVertexAI()?`projects/${t.getProject()}/locations/${t.getLocation()}/${n}`:n.startsWith("models/")&&t.isVertexAI()?`projects/${t.getProject()}/locations/${t.getLocation()}/publishers/google/${n}`:n:""}function YR(t){return Array.isArray(t)?t.map(e=>If(e)):[If(t)]}function If(t){if(typeof t=="object"&&t!==null)return t;throw new Error(`Could not parse input as Blob. Unsupported blob type: ${typeof t}`)}function KR(t){const e=If(t);if(e.mimeType&&e.mimeType.startsWith("image/"))return e;throw new Error(`Unsupported mime type: ${e.mimeType}`)}function WR(t){const e=If(t);if(e.mimeType&&e.mimeType.startsWith("audio/"))return e;throw new Error(`Unsupported mime type: ${e.mimeType}`)}function yA(t){if(t==null)throw new Error("PartUnion is required");if(typeof t=="object")return t;if(typeof t=="string")return{text:t};throw new Error(`Unsupported part type: ${typeof t}`)}function ZR(t){if(t==null||Array.isArray(t)&&t.length===0)throw new Error("PartListUnion is required");return Array.isArray(t)?t.map(e=>yA(e)):[yA(t)]}function r_(t){return t!=null&&typeof t=="object"&&"parts"in t&&Array.isArray(t.parts)}function _A(t){return t!=null&&typeof t=="object"&&"functionCall"in t}function vA(t){return t!=null&&typeof t=="object"&&"functionResponse"in t}function In(t){if(t==null)throw new Error("ContentUnion is required");return r_(t)?t:{role:"user",parts:ZR(t)}}function _0(t,e){if(!e)return[];if(t.isVertexAI()&&Array.isArray(e))return e.flatMap(n=>{const r=In(n);return r.parts&&r.parts.length>0&&r.parts[0].text!==void 0?[r.parts[0].text]:[]});if(t.isVertexAI()){const n=In(e);return n.parts&&n.parts.length>0&&n.parts[0].text!==void 0?[n.parts[0].text]:[]}return Array.isArray(e)?e.map(n=>In(n)):[In(e)]}function xr(t){if(t==null||Array.isArray(t)&&t.length===0)throw new Error("contents are required");if(!Array.isArray(t)){if(_A(t)||vA(t))throw new Error("To specify functionCall or functionResponse parts, please wrap them in a Content object, specifying the role for them");return[In(t)]}const e=[],n=[],r=r_(t[0]);for(const s of t){const a=r_(s);if(a!=r)throw new Error("Mixing Content and Parts is not supported, please group the parts into a the appropriate Content objects and specify the roles for them");if(a)e.push(s);else{if(_A(s)||vA(s))throw new Error("To specify functionCall or functionResponse parts, please wrap them, and any other parts, in Content objects as appropriate, specifying the role for them");n.push(s)}}return r||e.push({role:"user",parts:ZR(n)}),e}function N$(t,e){t.includes("null")&&(e.nullable=!0);const n=t.filter(r=>r!=="null");if(n.length===1)e.type=Object.values(te).includes(n[0].toUpperCase())?n[0].toUpperCase():te.TYPE_UNSPECIFIED;else{e.anyOf=[];for(const r of n)e.anyOf.push({type:Object.values(te).includes(r.toUpperCase())?r.toUpperCase():te.TYPE_UNSPECIFIED})}}function Go(t){const e={},n=["items"],r=["anyOf"],s=["properties"];if(t.type&&t.anyOf)throw new Error("type and anyOf cannot be both populated.");const a=t.anyOf;a!=null&&a.length==2&&(a[0].type==="null"?(e.nullable=!0,t=a[1]):a[1].type==="null"&&(e.nullable=!0,t=a[0])),t.type instanceof Array&&N$(t.type,e);for(const[o,u]of Object.entries(t))if(u!=null)if(o=="type"){if(u==="null")throw new Error("type: null can not be the only possible type for the field.");if(u instanceof Array)continue;e.type=Object.values(te).includes(u.toUpperCase())?u.toUpperCase():te.TYPE_UNSPECIFIED}else if(n.includes(o))e[o]=Go(u);else if(r.includes(o)){const d=[];for(const c of u){if(c.type=="null"){e.nullable=!0;continue}d.push(Go(c))}e[o]=d}else if(s.includes(o)){const d={};for(const[c,p]of Object.entries(u))d[c]=Go(p);e[o]=d}else{if(o==="additionalProperties")continue;e[o]=u}return e}function v0(t){return Go(t)}function w0(t){if(typeof t=="object")return t;if(typeof t=="string")return{voiceConfig:{prebuiltVoiceConfig:{voiceName:t}}};throw new Error(`Unsupported speechConfig type: ${typeof t}`)}function b0(t){if("multiSpeakerVoiceConfig"in t)throw new Error("multiSpeakerVoiceConfig is not supported in the live API.");return t}function al(t){if(t.functionDeclarations)for(const e of t.functionDeclarations)e.parameters&&(Object.keys(e.parameters).includes("$schema")?e.parametersJsonSchema||(e.parametersJsonSchema=e.parameters,delete e.parameters):e.parameters=Go(e.parameters)),e.response&&(Object.keys(e.response).includes("$schema")?e.responseJsonSchema||(e.responseJsonSchema=e.response,delete e.response):e.response=Go(e.response));return t}function il(t){if(t==null)throw new Error("tools is required");if(!Array.isArray(t))throw new Error("tools is required and must be an array of Tools");const e=[];for(const n of t)e.push(n);return e}function P$(t,e,n,r=1){const s=!e.startsWith(`${n}/`)&&e.split("/").length===r;return t.isVertexAI()?e.startsWith("projects/")?e:e.startsWith("locations/")?`projects/${t.getProject()}/${e}`:e.startsWith(`${n}/`)?`projects/${t.getProject()}/locations/${t.getLocation()}/${e}`:s?`projects/${t.getProject()}/locations/${t.getLocation()}/${n}/${e}`:e:s?`${n}/${e}`:e}function Js(t,e){if(typeof e!="string")throw new Error("name must be a string");return P$(t,e,"cachedContents")}function XR(t){switch(t){case"STATE_UNSPECIFIED":return"JOB_STATE_UNSPECIFIED";case"CREATING":return"JOB_STATE_RUNNING";case"ACTIVE":return"JOB_STATE_SUCCEEDED";case"FAILED":return"JOB_STATE_FAILED";default:return t}}function Ha(t){return m0(t)}function M$(t){return t!=null&&typeof t=="object"&&"name"in t}function k$(t){return t!=null&&typeof t=="object"&&"video"in t}function O$(t){return t!=null&&typeof t=="object"&&"uri"in t}function QR(t){var e;let n;if(M$(t)&&(n=t.name),!(O$(t)&&(n=t.uri,n===void 0))&&!(k$(t)&&(n=(e=t.video)===null||e===void 0?void 0:e.uri,n===void 0))){if(typeof t=="string"&&(n=t),n===void 0)throw new Error("Could not extract file name from the provided input.");if(n.startsWith("https://")){const s=n.split("files/")[1].match(/[a-z0-9]+/);if(s===null)throw new Error(`Could not extract file name from URI ${n}`);n=s[0]}else n.startsWith("files/")&&(n=n.split("files/")[1]);return n}}function eN(t,e){let n;return t.isVertexAI()?n=e?"publishers/google/models":"models":n=e?"models":"tunedModels",n}function tN(t){for(const e of["models","tunedModels","publisherModels"])if(D$(t,e))return t[e];return[]}function D$(t,e){return t!==null&&typeof t=="object"&&e in t}function L$(t,e={}){const n=t,r={name:n.name,description:n.description,parametersJsonSchema:n.inputSchema};return n.outputSchema&&(r.responseJsonSchema=n.outputSchema),e.behavior&&(r.behavior=e.behavior),{functionDeclarations:[r]}}function $$(t,e={}){const n=[],r=new Set;for(const s of t){const a=s.name;if(r.has(a))throw new Error(`Duplicate function name ${a} found in MCP tools. Please ensure function names are unique.`);r.add(a);const o=L$(s,e);o.functionDeclarations&&n.push(...o.functionDeclarations)}return{functionDeclarations:n}}function nN(t,e){let n;if(typeof e=="string")if(t.isVertexAI())if(e.startsWith("gs://"))n={format:"jsonl",gcsUri:[e]};else if(e.startsWith("bq://"))n={format:"bigquery",bigqueryUri:e};else throw new Error(`Unsupported string source for Vertex AI: ${e}`);else if(e.startsWith("files/"))n={fileName:e};else throw new Error(`Unsupported string source for Gemini API: ${e}`);else if(Array.isArray(e)){if(t.isVertexAI())throw new Error("InlinedRequest[] is not supported in Vertex AI.");n={inlinedRequests:e}}else n=e;const r=[n.gcsUri,n.bigqueryUri].filter(Boolean).length,s=[n.inlinedRequests,n.fileName].filter(Boolean).length;if(t.isVertexAI()){if(s>0||r!==1)throw new Error("Exactly one of `gcsUri` or `bigqueryUri` must be set for Vertex AI.")}else if(r>0||s!==1)throw new Error("Exactly one of `inlinedRequests`, `fileName`, must be set for Gemini API.");return n}function U$(t){if(typeof t!="string")return t;const e=t;if(e.startsWith("gs://"))return{format:"jsonl",gcsUri:e};if(e.startsWith("bq://"))return{format:"bigquery",bigqueryUri:e};throw new Error(`Unsupported destination: ${e}`)}function rN(t){if(typeof t!="object"||t===null)return{};const e=t,n=e.inlinedResponses;if(typeof n!="object"||n===null)return t;const s=n.inlinedResponses;if(!Array.isArray(s)||s.length===0)return t;let a=!1;for(const o of s){if(typeof o!="object"||o===null)continue;const d=o.response;if(typeof d!="object"||d===null)continue;if(d.embedding!==void 0){a=!0;break}}return a&&(e.inlinedEmbedContentResponses=e.inlinedResponses,delete e.inlinedResponses),t}function ol(t,e){const n=e;if(!t.isVertexAI()){if(/batches\/[^/]+$/.test(n))return n.split("/").pop();throw new Error(`Invalid batch job name: ${n}.`)}if(/^projects\/[^/]+\/locations\/[^/]+\/batchPredictionJobs\/[^/]+$/.test(n))return n.split("/").pop();if(/^\d+$/.test(n))return n;throw new Error(`Invalid batch job name: ${n}.`)}function sN(t){const e=t;return e==="BATCH_STATE_UNSPECIFIED"?"JOB_STATE_UNSPECIFIED":e==="BATCH_STATE_PENDING"?"JOB_STATE_PENDING":e==="BATCH_STATE_RUNNING"?"JOB_STATE_RUNNING":e==="BATCH_STATE_SUCCEEDED"?"JOB_STATE_SUCCEEDED":e==="BATCH_STATE_FAILED"?"JOB_STATE_FAILED":e==="BATCH_STATE_CANCELLED"?"JOB_STATE_CANCELLED":e==="BATCH_STATE_EXPIRED"?"JOB_STATE_EXPIRED":e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function F$(t){const e={},n=g(t,["responsesFile"]);n!=null&&_(e,["fileName"],n);const r=g(t,["inlinedResponses","inlinedResponses"]);if(r!=null){let a=r;Array.isArray(a)&&(a=a.map(o=>g2(o))),_(e,["inlinedResponses"],a)}const s=g(t,["inlinedEmbedContentResponses","inlinedResponses"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["inlinedEmbedContentResponses"],a)}return e}function B$(t){const e={},n=g(t,["predictionsFormat"]);n!=null&&_(e,["format"],n);const r=g(t,["gcsDestination","outputUriPrefix"]);r!=null&&_(e,["gcsUri"],r);const s=g(t,["bigqueryDestination","outputUri"]);return s!=null&&_(e,["bigqueryUri"],s),e}function q$(t){const e={},n=g(t,["format"]);n!=null&&_(e,["predictionsFormat"],n);const r=g(t,["gcsUri"]);r!=null&&_(e,["gcsDestination","outputUriPrefix"],r);const s=g(t,["bigqueryUri"]);if(s!=null&&_(e,["bigqueryDestination","outputUri"],s),g(t,["fileName"])!==void 0)throw new Error("fileName parameter is not supported in Vertex AI.");if(g(t,["inlinedResponses"])!==void 0)throw new Error("inlinedResponses parameter is not supported in Vertex AI.");if(g(t,["inlinedEmbedContentResponses"])!==void 0)throw new Error("inlinedEmbedContentResponses parameter is not supported in Vertex AI.");return e}function cf(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata","displayName"]);r!=null&&_(e,["displayName"],r);const s=g(t,["metadata","state"]);s!=null&&_(e,["state"],sN(s));const a=g(t,["metadata","createTime"]);a!=null&&_(e,["createTime"],a);const o=g(t,["metadata","endTime"]);o!=null&&_(e,["endTime"],o);const u=g(t,["metadata","updateTime"]);u!=null&&_(e,["updateTime"],u);const d=g(t,["metadata","model"]);d!=null&&_(e,["model"],d);const c=g(t,["metadata","output"]);return c!=null&&_(e,["dest"],F$(rN(c))),e}function s_(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["displayName"]);r!=null&&_(e,["displayName"],r);const s=g(t,["state"]);s!=null&&_(e,["state"],sN(s));const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["createTime"]);o!=null&&_(e,["createTime"],o);const u=g(t,["startTime"]);u!=null&&_(e,["startTime"],u);const d=g(t,["endTime"]);d!=null&&_(e,["endTime"],d);const c=g(t,["updateTime"]);c!=null&&_(e,["updateTime"],c);const p=g(t,["model"]);p!=null&&_(e,["model"],p);const m=g(t,["inputConfig"]);m!=null&&_(e,["src"],G$(m));const y=g(t,["outputConfig"]);y!=null&&_(e,["dest"],B$(rN(y)));const w=g(t,["completionStats"]);return w!=null&&_(e,["completionStats"],w),e}function G$(t){const e={},n=g(t,["instancesFormat"]);n!=null&&_(e,["format"],n);const r=g(t,["gcsSource","uris"]);r!=null&&_(e,["gcsUri"],r);const s=g(t,["bigquerySource","inputUri"]);return s!=null&&_(e,["bigqueryUri"],s),e}function H$(t,e){const n={};if(g(e,["format"])!==void 0)throw new Error("format parameter is not supported in Gemini API.");if(g(e,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");if(g(e,["bigqueryUri"])!==void 0)throw new Error("bigqueryUri parameter is not supported in Gemini API.");const r=g(e,["fileName"]);r!=null&&_(n,["fileName"],r);const s=g(e,["inlinedRequests"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>m2(t,o))),_(n,["requests","requests"],a)}return n}function z$(t){const e={},n=g(t,["format"]);n!=null&&_(e,["instancesFormat"],n);const r=g(t,["gcsUri"]);r!=null&&_(e,["gcsSource","uris"],r);const s=g(t,["bigqueryUri"]);if(s!=null&&_(e,["bigquerySource","inputUri"],s),g(t,["fileName"])!==void 0)throw new Error("fileName parameter is not supported in Vertex AI.");if(g(t,["inlinedRequests"])!==void 0)throw new Error("inlinedRequests parameter is not supported in Vertex AI.");return e}function j$(t){const e={},n=g(t,["data"]);if(n!=null&&_(e,["data"],n),g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function V$(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],ol(t,r)),n}function J$(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],ol(t,r)),n}function Y$(t){const e={},n=g(t,["content"]);n!=null&&_(e,["content"],n);const r=g(t,["citationMetadata"]);r!=null&&_(e,["citationMetadata"],K$(r));const s=g(t,["tokenCount"]);s!=null&&_(e,["tokenCount"],s);const a=g(t,["finishReason"]);a!=null&&_(e,["finishReason"],a);const o=g(t,["avgLogprobs"]);o!=null&&_(e,["avgLogprobs"],o);const u=g(t,["groundingMetadata"]);u!=null&&_(e,["groundingMetadata"],u);const d=g(t,["index"]);d!=null&&_(e,["index"],d);const c=g(t,["logprobsResult"]);c!=null&&_(e,["logprobsResult"],c);const p=g(t,["safetyRatings"]);if(p!=null){let y=p;Array.isArray(y)&&(y=y.map(w=>w)),_(e,["safetyRatings"],y)}const m=g(t,["urlContextMetadata"]);return m!=null&&_(e,["urlContextMetadata"],m),e}function K$(t){const e={},n=g(t,["citationSources"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(s=>s)),_(e,["citations"],r)}return e}function aN(t){const e={},n=g(t,["parts"]);if(n!=null){let s=n;Array.isArray(s)&&(s=s.map(a=>x2(a))),_(e,["parts"],s)}const r=g(t,["role"]);return r!=null&&_(e,["role"],r),e}function W$(t,e){const n={},r=g(t,["displayName"]);if(e!==void 0&&r!=null&&_(e,["batch","displayName"],r),g(t,["dest"])!==void 0)throw new Error("dest parameter is not supported in Gemini API.");return n}function Z$(t,e){const n={},r=g(t,["displayName"]);e!==void 0&&r!=null&&_(e,["displayName"],r);const s=g(t,["dest"]);return e!==void 0&&s!=null&&_(e,["outputConfig"],q$(U$(s))),n}function wA(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["src"]);s!=null&&_(n,["batch","inputConfig"],H$(t,nN(t,s)));const a=g(e,["config"]);return a!=null&&W$(a,n),n}function X$(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["model"],ht(t,r));const s=g(e,["src"]);s!=null&&_(n,["inputConfig"],z$(nN(t,s)));const a=g(e,["config"]);return a!=null&&Z$(a,n),n}function Q$(t,e){const n={},r=g(t,["displayName"]);return e!==void 0&&r!=null&&_(e,["batch","displayName"],r),n}function e2(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["src"]);s!=null&&_(n,["batch","inputConfig"],o2(t,s));const a=g(e,["config"]);return a!=null&&Q$(a,n),n}function t2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],ol(t,r)),n}function n2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],ol(t,r)),n}function r2(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["name"]);r!=null&&_(e,["name"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);return a!=null&&_(e,["error"],a),e}function s2(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["name"]);r!=null&&_(e,["name"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);return a!=null&&_(e,["error"],a),e}function a2(t,e){const n={},r=g(e,["contents"]);if(r!=null){let a=_0(t,r);Array.isArray(a)&&(a=a.map(o=>o)),_(n,["requests[]","request","content"],a)}const s=g(e,["config"]);return s!=null&&(_(n,["_self"],i2(s,n)),n$(n,{"requests[].*":"requests[].request.*"})),n}function i2(t,e){const n={},r=g(t,["taskType"]);e!==void 0&&r!=null&&_(e,["requests[]","taskType"],r);const s=g(t,["title"]);e!==void 0&&s!=null&&_(e,["requests[]","title"],s);const a=g(t,["outputDimensionality"]);if(e!==void 0&&a!=null&&_(e,["requests[]","outputDimensionality"],a),g(t,["mimeType"])!==void 0)throw new Error("mimeType parameter is not supported in Gemini API.");if(g(t,["autoTruncate"])!==void 0)throw new Error("autoTruncate parameter is not supported in Gemini API.");return n}function o2(t,e){const n={},r=g(e,["fileName"]);r!=null&&_(n,["file_name"],r);const s=g(e,["inlinedRequests"]);return s!=null&&_(n,["requests"],a2(t,s)),n}function l2(t){const e={};if(g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const n=g(t,["fileUri"]);n!=null&&_(e,["fileUri"],n);const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function u2(t,e,n){const r={},s=g(e,["systemInstruction"]);n!==void 0&&s!=null&&_(n,["systemInstruction"],aN(In(s)));const a=g(e,["temperature"]);a!=null&&_(r,["temperature"],a);const o=g(e,["topP"]);o!=null&&_(r,["topP"],o);const u=g(e,["topK"]);u!=null&&_(r,["topK"],u);const d=g(e,["candidateCount"]);d!=null&&_(r,["candidateCount"],d);const c=g(e,["maxOutputTokens"]);c!=null&&_(r,["maxOutputTokens"],c);const p=g(e,["stopSequences"]);p!=null&&_(r,["stopSequences"],p);const m=g(e,["responseLogprobs"]);m!=null&&_(r,["responseLogprobs"],m);const y=g(e,["logprobs"]);y!=null&&_(r,["logprobs"],y);const w=g(e,["presencePenalty"]);w!=null&&_(r,["presencePenalty"],w);const x=g(e,["frequencyPenalty"]);x!=null&&_(r,["frequencyPenalty"],x);const A=g(e,["seed"]);A!=null&&_(r,["seed"],A);const E=g(e,["responseMimeType"]);E!=null&&_(r,["responseMimeType"],E);const C=g(e,["responseSchema"]);C!=null&&_(r,["responseSchema"],v0(C));const D=g(e,["responseJsonSchema"]);if(D!=null&&_(r,["responseJsonSchema"],D),g(e,["routingConfig"])!==void 0)throw new Error("routingConfig parameter is not supported in Gemini API.");if(g(e,["modelSelectionConfig"])!==void 0)throw new Error("modelSelectionConfig parameter is not supported in Gemini API.");const O=g(e,["safetySettings"]);if(n!==void 0&&O!=null){let F=O;Array.isArray(F)&&(F=F.map(K=>T2(K))),_(n,["safetySettings"],F)}const T=g(e,["tools"]);if(n!==void 0&&T!=null){let F=il(T);Array.isArray(F)&&(F=F.map(K=>A2(al(K)))),_(n,["tools"],F)}const I=g(e,["toolConfig"]);if(n!==void 0&&I!=null&&_(n,["toolConfig"],I),g(e,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");const M=g(e,["cachedContent"]);n!==void 0&&M!=null&&_(n,["cachedContent"],Js(t,M));const N=g(e,["responseModalities"]);N!=null&&_(r,["responseModalities"],N);const P=g(e,["mediaResolution"]);P!=null&&_(r,["mediaResolution"],P);const k=g(e,["speechConfig"]);if(k!=null&&_(r,["speechConfig"],w0(k)),g(e,["audioTimestamp"])!==void 0)throw new Error("audioTimestamp parameter is not supported in Gemini API.");const $=g(e,["thinkingConfig"]);$!=null&&_(r,["thinkingConfig"],$);const U=g(e,["imageConfig"]);return U!=null&&_(r,["imageConfig"],U),r}function c2(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["candidates"]);if(r!=null){let d=r;Array.isArray(d)&&(d=d.map(c=>Y$(c))),_(e,["candidates"],d)}const s=g(t,["modelVersion"]);s!=null&&_(e,["modelVersion"],s);const a=g(t,["promptFeedback"]);a!=null&&_(e,["promptFeedback"],a);const o=g(t,["responseId"]);o!=null&&_(e,["responseId"],o);const u=g(t,["usageMetadata"]);return u!=null&&_(e,["usageMetadata"],u),e}function d2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],ol(t,r)),n}function f2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],ol(t,r)),n}function p2(t){const e={};if(g(t,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const n=g(t,["enableWidget"]);return n!=null&&_(e,["enableWidget"],n),e}function h2(t){const e={};if(g(t,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(t,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const n=g(t,["timeRangeFilter"]);return n!=null&&_(e,["timeRangeFilter"],n),e}function m2(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["request","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let u=xr(s);Array.isArray(u)&&(u=u.map(d=>aN(d))),_(n,["request","contents"],u)}const a=g(e,["metadata"]);a!=null&&_(n,["metadata"],a);const o=g(e,["config"]);return o!=null&&_(n,["request","generationConfig"],u2(t,o,g(n,["request"],{}))),n}function g2(t){const e={},n=g(t,["response"]);n!=null&&_(e,["response"],c2(n));const r=g(t,["error"]);return r!=null&&_(e,["error"],r),e}function y2(t,e){const n={},r=g(t,["pageSize"]);e!==void 0&&r!=null&&_(e,["_query","pageSize"],r);const s=g(t,["pageToken"]);if(e!==void 0&&s!=null&&_(e,["_query","pageToken"],s),g(t,["filter"])!==void 0)throw new Error("filter parameter is not supported in Gemini API.");return n}function _2(t,e){const n={},r=g(t,["pageSize"]);e!==void 0&&r!=null&&_(e,["_query","pageSize"],r);const s=g(t,["pageToken"]);e!==void 0&&s!=null&&_(e,["_query","pageToken"],s);const a=g(t,["filter"]);return e!==void 0&&a!=null&&_(e,["_query","filter"],a),n}function v2(t){const e={},n=g(t,["config"]);return n!=null&&y2(n,e),e}function w2(t){const e={},n=g(t,["config"]);return n!=null&&_2(n,e),e}function b2(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["operations"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>cf(o))),_(e,["batchJobs"],a)}return e}function S2(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["batchPredictionJobs"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>s_(o))),_(e,["batchJobs"],a)}return e}function x2(t){const e={},n=g(t,["functionCall"]);n!=null&&_(e,["functionCall"],n);const r=g(t,["codeExecutionResult"]);r!=null&&_(e,["codeExecutionResult"],r);const s=g(t,["executableCode"]);s!=null&&_(e,["executableCode"],s);const a=g(t,["fileData"]);a!=null&&_(e,["fileData"],l2(a));const o=g(t,["functionResponse"]);o!=null&&_(e,["functionResponse"],o);const u=g(t,["inlineData"]);u!=null&&_(e,["inlineData"],j$(u));const d=g(t,["text"]);d!=null&&_(e,["text"],d);const c=g(t,["thought"]);c!=null&&_(e,["thought"],c);const p=g(t,["thoughtSignature"]);p!=null&&_(e,["thoughtSignature"],p);const m=g(t,["videoMetadata"]);return m!=null&&_(e,["videoMetadata"],m),e}function T2(t){const e={},n=g(t,["category"]);if(n!=null&&_(e,["category"],n),g(t,["method"])!==void 0)throw new Error("method parameter is not supported in Gemini API.");const r=g(t,["threshold"]);return r!=null&&_(e,["threshold"],r),e}function A2(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let p=n;Array.isArray(p)&&(p=p.map(m=>m)),_(e,["functionDeclarations"],p)}if(g(t,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const r=g(t,["googleSearchRetrieval"]);r!=null&&_(e,["googleSearchRetrieval"],r);const s=g(t,["computerUse"]);s!=null&&_(e,["computerUse"],s);const a=g(t,["fileSearch"]);a!=null&&_(e,["fileSearch"],a);const o=g(t,["codeExecution"]);if(o!=null&&_(e,["codeExecution"],o),g(t,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const u=g(t,["googleMaps"]);u!=null&&_(e,["googleMaps"],p2(u));const d=g(t,["googleSearch"]);d!=null&&_(e,["googleSearch"],h2(d));const c=g(t,["urlContext"]);return c!=null&&_(e,["urlContext"],c),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var zs;(function(t){t.PAGED_ITEM_BATCH_JOBS="batchJobs",t.PAGED_ITEM_MODELS="models",t.PAGED_ITEM_TUNING_JOBS="tuningJobs",t.PAGED_ITEM_FILES="files",t.PAGED_ITEM_CACHED_CONTENTS="cachedContents",t.PAGED_ITEM_FILE_SEARCH_STORES="fileSearchStores",t.PAGED_ITEM_DOCUMENTS="documents"})(zs||(zs={}));class Ui{constructor(e,n,r,s){this.pageInternal=[],this.paramsInternal={},this.requestInternal=n,this.init(e,r,s)}init(e,n,r){var s,a;this.nameInternal=e,this.pageInternal=n[this.nameInternal]||[],this.sdkHttpResponseInternal=n==null?void 0:n.sdkHttpResponse,this.idxInternal=0;let o={config:{}};!r||Object.keys(r).length===0?o={config:{}}:typeof r=="object"?o=Object.assign({},r):o=r,o.config&&(o.config.pageToken=n.nextPageToken),this.paramsInternal=o,this.pageInternalSize=(a=(s=o.config)===null||s===void 0?void 0:s.pageSize)!==null&&a!==void 0?a:this.pageInternal.length}initNextPage(e){this.init(this.nameInternal,e,this.paramsInternal)}get page(){return this.pageInternal}get name(){return this.nameInternal}get pageSize(){return this.pageInternalSize}get sdkHttpResponse(){return this.sdkHttpResponseInternal}get params(){return this.paramsInternal}get pageLength(){return this.pageInternal.length}getItem(e){return this.pageInternal[e]}[Symbol.asyncIterator](){return{next:async()=>{if(this.idxInternal>=this.pageLength)if(this.hasNextPage())await this.nextPage();else return{value:void 0,done:!0};const e=this.getItem(this.idxInternal);return this.idxInternal+=1,{value:e,done:!1}},return:async()=>({value:void 0,done:!0})}}async nextPage(){if(!this.hasNextPage())throw new Error("No more pages to fetch.");const e=await this.requestInternal(this.params);return this.initNextPage(e),this.page}hasNextPage(){var e;return((e=this.params.config)===null||e===void 0?void 0:e.pageToken)!==void 0}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let E2=class extends Vs{constructor(e){super(),this.apiClient=e,this.create=async n=>(this.apiClient.isVertexAI()&&(n.config=this.formatDestination(n.src,n.config)),this.createInternal(n)),this.createEmbeddings=async n=>{if(console.warn("batches.createEmbeddings() is experimental and may change without notice."),this.apiClient.isVertexAI())throw new Error("Vertex AI does not support batches.createEmbeddings.");return this.createEmbeddingsInternal(n)},this.list=async(n={})=>new Ui(zs.PAGED_ITEM_BATCH_JOBS,r=>this.listInternal(r),await this.listInternal(n),n)}createInlinedGenerateContentRequest(e){const n=wA(this.apiClient,e),r=n._url,s=we("{model}:batchGenerateContent",r),u=n.batch.inputConfig.requests,d=u.requests,c=[];for(const p of d){const m=Object.assign({},p);if(m.systemInstruction){const y=m.systemInstruction;delete m.systemInstruction;const w=m.request;w.systemInstruction=y,m.request=w}c.push(m)}return u.requests=c,delete n.config,delete n._url,delete n._query,{path:s,body:n}}getGcsUri(e){if(typeof e=="string")return e.startsWith("gs://")?e:void 0;if(!Array.isArray(e)&&e.gcsUri&&e.gcsUri.length>0)return e.gcsUri[0]}getBigqueryUri(e){if(typeof e=="string")return e.startsWith("bq://")?e:void 0;if(!Array.isArray(e))return e.bigqueryUri}formatDestination(e,n){const r=n?Object.assign({},n):{},s=Date.now().toString();if(r.displayName||(r.displayName=`genaiBatchJob_${s}`),r.dest===void 0){const a=this.getGcsUri(e),o=this.getBigqueryUri(e);if(a)a.endsWith(".jsonl")?r.dest=`${a.slice(0,-6)}/dest`:r.dest=`${a}_dest_${s}`;else if(o)r.dest=`${o}_dest_${s}`;else throw new Error("Unsupported source for Vertex AI: No GCS or BigQuery URI found.")}return r}async createInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=X$(this.apiClient,e);return u=we("batchPredictionJobs",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>s_(p))}else{const c=wA(this.apiClient,e);return u=we("{model}:batchGenerateContent",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>cf(p))}}async createEmbeddingsInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=e2(this.apiClient,e);return a=we("{model}:asyncBatchEmbedContent",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>cf(d))}}async get(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=f2(this.apiClient,e);return u=we("batchPredictionJobs/{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>s_(p))}else{const c=d2(this.apiClient,e);return u=we("batches/{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>cf(p))}}async cancel(e){var n,r,s,a;let o="",u={};if(this.apiClient.isVertexAI()){const d=J$(this.apiClient,e);o=we("batchPredictionJobs/{name}:cancel",d._url),u=d._query,delete d._url,delete d._query,await this.apiClient.request({path:o,queryParams:u,body:JSON.stringify(d),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal})}else{const d=V$(this.apiClient,e);o=we("batches/{name}:cancel",d._url),u=d._query,delete d._url,delete d._query,await this.apiClient.request({path:o,queryParams:u,body:JSON.stringify(d),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal})}}async listInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=w2(e);return u=we("batchPredictionJobs",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=S2(p),y=new gA;return Object.assign(y,m),y})}else{const c=v2(e);return u=we("batches",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=b2(p),y=new gA;return Object.assign(y,m),y})}}async delete(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=n2(this.apiClient,e);return u=we("batchPredictionJobs/{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>s2(p))}else{const c=t2(this.apiClient,e);return u=we("batches/{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>r2(p))}}};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function C2(t){const e={},n=g(t,["data"]);if(n!=null&&_(e,["data"],n),g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function bA(t){const e={},n=g(t,["parts"]);if(n!=null){let s=n;Array.isArray(s)&&(s=s.map(a=>Y2(a))),_(e,["parts"],s)}const r=g(t,["role"]);return r!=null&&_(e,["role"],r),e}function I2(t,e){const n={},r=g(t,["ttl"]);e!==void 0&&r!=null&&_(e,["ttl"],r);const s=g(t,["expireTime"]);e!==void 0&&s!=null&&_(e,["expireTime"],s);const a=g(t,["displayName"]);e!==void 0&&a!=null&&_(e,["displayName"],a);const o=g(t,["contents"]);if(e!==void 0&&o!=null){let p=xr(o);Array.isArray(p)&&(p=p.map(m=>bA(m))),_(e,["contents"],p)}const u=g(t,["systemInstruction"]);e!==void 0&&u!=null&&_(e,["systemInstruction"],bA(In(u)));const d=g(t,["tools"]);if(e!==void 0&&d!=null){let p=d;Array.isArray(p)&&(p=p.map(m=>K2(m))),_(e,["tools"],p)}const c=g(t,["toolConfig"]);if(e!==void 0&&c!=null&&_(e,["toolConfig"],c),g(t,["kmsKeyName"])!==void 0)throw new Error("kmsKeyName parameter is not supported in Gemini API.");return n}function R2(t,e){const n={},r=g(t,["ttl"]);e!==void 0&&r!=null&&_(e,["ttl"],r);const s=g(t,["expireTime"]);e!==void 0&&s!=null&&_(e,["expireTime"],s);const a=g(t,["displayName"]);e!==void 0&&a!=null&&_(e,["displayName"],a);const o=g(t,["contents"]);if(e!==void 0&&o!=null){let m=xr(o);Array.isArray(m)&&(m=m.map(y=>y)),_(e,["contents"],m)}const u=g(t,["systemInstruction"]);e!==void 0&&u!=null&&_(e,["systemInstruction"],In(u));const d=g(t,["tools"]);if(e!==void 0&&d!=null){let m=d;Array.isArray(m)&&(m=m.map(y=>W2(y))),_(e,["tools"],m)}const c=g(t,["toolConfig"]);e!==void 0&&c!=null&&_(e,["toolConfig"],c);const p=g(t,["kmsKeyName"]);return e!==void 0&&p!=null&&_(e,["encryption_spec","kmsKeyName"],p),n}function N2(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["model"],JR(t,r));const s=g(e,["config"]);return s!=null&&I2(s,n),n}function P2(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["model"],JR(t,r));const s=g(e,["config"]);return s!=null&&R2(s,n),n}function M2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],Js(t,r)),n}function k2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],Js(t,r)),n}function O2(t){const e={},n=g(t,["sdkHttpResponse"]);return n!=null&&_(e,["sdkHttpResponse"],n),e}function D2(t){const e={},n=g(t,["sdkHttpResponse"]);return n!=null&&_(e,["sdkHttpResponse"],n),e}function L2(t){const e={};if(g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const n=g(t,["fileUri"]);n!=null&&_(e,["fileUri"],n);const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function $2(t){const e={};if(g(t,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");const n=g(t,["description"]);n!=null&&_(e,["description"],n);const r=g(t,["name"]);r!=null&&_(e,["name"],r);const s=g(t,["parameters"]);s!=null&&_(e,["parameters"],s);const a=g(t,["parametersJsonSchema"]);a!=null&&_(e,["parametersJsonSchema"],a);const o=g(t,["response"]);o!=null&&_(e,["response"],o);const u=g(t,["responseJsonSchema"]);return u!=null&&_(e,["responseJsonSchema"],u),e}function U2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],Js(t,r)),n}function F2(t,e){const n={},r=g(e,["name"]);return r!=null&&_(n,["_url","name"],Js(t,r)),n}function B2(t){const e={};if(g(t,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const n=g(t,["enableWidget"]);return n!=null&&_(e,["enableWidget"],n),e}function q2(t){const e={};if(g(t,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(t,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const n=g(t,["timeRangeFilter"]);return n!=null&&_(e,["timeRangeFilter"],n),e}function G2(t,e){const n={},r=g(t,["pageSize"]);e!==void 0&&r!=null&&_(e,["_query","pageSize"],r);const s=g(t,["pageToken"]);return e!==void 0&&s!=null&&_(e,["_query","pageToken"],s),n}function H2(t,e){const n={},r=g(t,["pageSize"]);e!==void 0&&r!=null&&_(e,["_query","pageSize"],r);const s=g(t,["pageToken"]);return e!==void 0&&s!=null&&_(e,["_query","pageToken"],s),n}function z2(t){const e={},n=g(t,["config"]);return n!=null&&G2(n,e),e}function j2(t){const e={},n=g(t,["config"]);return n!=null&&H2(n,e),e}function V2(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["cachedContents"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["cachedContents"],a)}return e}function J2(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["cachedContents"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["cachedContents"],a)}return e}function Y2(t){const e={},n=g(t,["functionCall"]);n!=null&&_(e,["functionCall"],n);const r=g(t,["codeExecutionResult"]);r!=null&&_(e,["codeExecutionResult"],r);const s=g(t,["executableCode"]);s!=null&&_(e,["executableCode"],s);const a=g(t,["fileData"]);a!=null&&_(e,["fileData"],L2(a));const o=g(t,["functionResponse"]);o!=null&&_(e,["functionResponse"],o);const u=g(t,["inlineData"]);u!=null&&_(e,["inlineData"],C2(u));const d=g(t,["text"]);d!=null&&_(e,["text"],d);const c=g(t,["thought"]);c!=null&&_(e,["thought"],c);const p=g(t,["thoughtSignature"]);p!=null&&_(e,["thoughtSignature"],p);const m=g(t,["videoMetadata"]);return m!=null&&_(e,["videoMetadata"],m),e}function K2(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let p=n;Array.isArray(p)&&(p=p.map(m=>m)),_(e,["functionDeclarations"],p)}if(g(t,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const r=g(t,["googleSearchRetrieval"]);r!=null&&_(e,["googleSearchRetrieval"],r);const s=g(t,["computerUse"]);s!=null&&_(e,["computerUse"],s);const a=g(t,["fileSearch"]);a!=null&&_(e,["fileSearch"],a);const o=g(t,["codeExecution"]);if(o!=null&&_(e,["codeExecution"],o),g(t,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const u=g(t,["googleMaps"]);u!=null&&_(e,["googleMaps"],B2(u));const d=g(t,["googleSearch"]);d!=null&&_(e,["googleSearch"],q2(d));const c=g(t,["urlContext"]);return c!=null&&_(e,["urlContext"],c),e}function W2(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let m=n;Array.isArray(m)&&(m=m.map(y=>$2(y))),_(e,["functionDeclarations"],m)}const r=g(t,["retrieval"]);r!=null&&_(e,["retrieval"],r);const s=g(t,["googleSearchRetrieval"]);s!=null&&_(e,["googleSearchRetrieval"],s);const a=g(t,["computerUse"]);if(a!=null&&_(e,["computerUse"],a),g(t,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");const o=g(t,["codeExecution"]);o!=null&&_(e,["codeExecution"],o);const u=g(t,["enterpriseWebSearch"]);u!=null&&_(e,["enterpriseWebSearch"],u);const d=g(t,["googleMaps"]);d!=null&&_(e,["googleMaps"],d);const c=g(t,["googleSearch"]);c!=null&&_(e,["googleSearch"],c);const p=g(t,["urlContext"]);return p!=null&&_(e,["urlContext"],p),e}function Z2(t,e){const n={},r=g(t,["ttl"]);e!==void 0&&r!=null&&_(e,["ttl"],r);const s=g(t,["expireTime"]);return e!==void 0&&s!=null&&_(e,["expireTime"],s),n}function X2(t,e){const n={},r=g(t,["ttl"]);e!==void 0&&r!=null&&_(e,["ttl"],r);const s=g(t,["expireTime"]);return e!==void 0&&s!=null&&_(e,["expireTime"],s),n}function Q2(t,e){const n={},r=g(e,["name"]);r!=null&&_(n,["_url","name"],Js(t,r));const s=g(e,["config"]);return s!=null&&Z2(s,n),n}function eU(t,e){const n={},r=g(e,["name"]);r!=null&&_(n,["_url","name"],Js(t,r));const s=g(e,["config"]);return s!=null&&X2(s,n),n}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class tU extends Vs{constructor(e){super(),this.apiClient=e,this.list=async(n={})=>new Ui(zs.PAGED_ITEM_CACHED_CONTENTS,r=>this.listInternal(r),await this.listInternal(n),n)}async create(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=P2(this.apiClient,e);return u=we("cachedContents",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>p)}else{const c=N2(this.apiClient,e);return u=we("cachedContents",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>p)}}async get(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=F2(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>p)}else{const c=U2(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>p)}}async delete(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=k2(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=D2(p),y=new hA;return Object.assign(y,m),y})}else{const c=M2(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=O2(p),y=new hA;return Object.assign(y,m),y})}}async update(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=eU(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>p)}else{const c=Q2(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>p)}}async listInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=j2(e);return u=we("cachedContents",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=J2(p),y=new mA;return Object.assign(y,m),y})}else{const c=z2(e);return u=we("cachedContents",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=V2(p),y=new mA;return Object.assign(y,m),y})}}}function SA(t){var e=typeof Symbol=="function"&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function kt(t){return this instanceof kt?(this.v=t,this):new kt(t)}function Ho(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=n.apply(t,e||[]),s,a=[];return s=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),u("next"),u("throw"),u("return",o),s[Symbol.asyncIterator]=function(){return this},s;function o(w){return function(x){return Promise.resolve(x).then(w,m)}}function u(w,x){r[w]&&(s[w]=function(A){return new Promise(function(E,C){a.push([w,A,E,C])>1||d(w,A)})},x&&(s[w]=x(s[w])))}function d(w,x){try{c(r[w](x))}catch(A){y(a[0][3],A)}}function c(w){w.value instanceof kt?Promise.resolve(w.value.v).then(p,m):y(a[0][2],w)}function p(w){d("next",w)}function m(w){d("throw",w)}function y(w,x){w(x),a.shift(),a.length&&d(a[0][0],a[0][1])}}function Eu(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],n;return e?e.call(t):(t=typeof SA=="function"?SA(t):t[Symbol.iterator](),n={},r("next"),r("throw"),r("return"),n[Symbol.asyncIterator]=function(){return this},n);function r(a){n[a]=t[a]&&function(o){return new Promise(function(u,d){o=t[a](o),s(u,d,o.done,o.value)})}}function s(a,o,u,d){Promise.resolve(d).then(function(c){a({value:c,done:u})},o)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function nU(t){var e;if(t.candidates==null||t.candidates.length===0)return!1;const n=(e=t.candidates[0])===null||e===void 0?void 0:e.content;return n===void 0?!1:iN(n)}function iN(t){if(t.parts===void 0||t.parts.length===0)return!1;for(const e of t.parts)if(e===void 0||Object.keys(e).length===0)return!1;return!0}function rU(t){if(t.length!==0){for(const e of t)if(e.role!=="user"&&e.role!=="model")throw new Error(`Role must be user or model, but got ${e.role}.`)}}function xA(t){if(t===void 0||t.length===0)return[];const e=[],n=t.length;let r=0;for(;r<n;)if(t[r].role==="user")e.push(t[r]),r++;else{const s=[];let a=!0;for(;r<n&&t[r].role==="model";)s.push(t[r]),a&&!iN(t[r])&&(a=!1),r++;a?e.push(...s):e.pop()}return e}class sU{constructor(e,n){this.modelsModule=e,this.apiClient=n}create(e){return new aU(this.apiClient,this.modelsModule,e.model,e.config,structuredClone(e.history))}}let aU=class{constructor(e,n,r,s={},a=[]){this.apiClient=e,this.modelsModule=n,this.model=r,this.config=s,this.history=a,this.sendPromise=Promise.resolve(),rU(a)}async sendMessage(e){var n;await this.sendPromise;const r=In(e.message),s=this.modelsModule.generateContent({model:this.model,contents:this.getHistory(!0).concat(r),config:(n=e.config)!==null&&n!==void 0?n:this.config});return this.sendPromise=(async()=>{var a,o,u;const d=await s,c=(o=(a=d.candidates)===null||a===void 0?void 0:a[0])===null||o===void 0?void 0:o.content,p=d.automaticFunctionCallingHistory,m=this.getHistory(!0).length;let y=[];p!=null&&(y=(u=p.slice(m))!==null&&u!==void 0?u:[]);const w=c?[c]:[];this.recordHistory(r,w,y)})(),await this.sendPromise.catch(()=>{this.sendPromise=Promise.resolve()}),s}async sendMessageStream(e){var n;await this.sendPromise;const r=In(e.message),s=this.modelsModule.generateContentStream({model:this.model,contents:this.getHistory(!0).concat(r),config:(n=e.config)!==null&&n!==void 0?n:this.config});this.sendPromise=s.then(()=>{}).catch(()=>{});const a=await s;return this.processStreamResponse(a,r)}getHistory(e=!1){const n=e?xA(this.history):this.history;return structuredClone(n)}processStreamResponse(e,n){var r,s;return Ho(this,arguments,function*(){var o,u,d,c;const p=[];try{for(var m=!0,y=Eu(e),w;w=yield kt(y.next()),o=w.done,!o;m=!0){c=w.value,m=!1;const x=c;if(nU(x)){const A=(s=(r=x.candidates)===null||r===void 0?void 0:r[0])===null||s===void 0?void 0:s.content;A!==void 0&&p.push(A)}yield yield kt(x)}}catch(x){u={error:x}}finally{try{!m&&!o&&(d=y.return)&&(yield kt(d.call(y)))}finally{if(u)throw u.error}}this.recordHistory(n,p)})}recordHistory(e,n,r){let s=[];n.length>0&&n.every(a=>a.role!==void 0)?s=n:s.push({role:"model",parts:[]}),r&&r.length>0?this.history.push(...xA(r)):this.history.push(e),this.history.push(...s)}};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class rp extends Error{constructor(e){super(e.message),this.name="ApiError",this.status=e.status,Object.setPrototypeOf(this,rp.prototype)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function iU(t){const e={},n=g(t,["file"]);return n!=null&&_(e,["file"],n),e}function oU(t){const e={},n=g(t,["sdkHttpResponse"]);return n!=null&&_(e,["sdkHttpResponse"],n),e}function lU(t){const e={},n=g(t,["name"]);return n!=null&&_(e,["_url","file"],QR(n)),e}function uU(t){const e={},n=g(t,["sdkHttpResponse"]);return n!=null&&_(e,["sdkHttpResponse"],n),e}function cU(t){const e={},n=g(t,["name"]);return n!=null&&_(e,["_url","file"],QR(n)),e}function dU(t,e){const n={},r=g(t,["pageSize"]);e!==void 0&&r!=null&&_(e,["_query","pageSize"],r);const s=g(t,["pageToken"]);return e!==void 0&&s!=null&&_(e,["_query","pageToken"],s),n}function fU(t){const e={},n=g(t,["config"]);return n!=null&&dU(n,e),e}function pU(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["files"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["files"],a)}return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let hU=class extends Vs{constructor(e){super(),this.apiClient=e,this.list=async(n={})=>new Ui(zs.PAGED_ITEM_FILES,r=>this.listInternal(r),await this.listInternal(n),n)}async upload(e){if(this.apiClient.isVertexAI())throw new Error("Vertex AI does not support uploading files. You can share files through a GCS bucket.");return this.apiClient.uploadFile(e.file,e.config).then(n=>n)}async download(e){await this.apiClient.downloadFile(e)}async listInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=fU(e);return a=we("files",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(c=>{const p=c;return p.sdkHttpResponse={headers:d.headers},p})),s.then(d=>{const c=pU(d),p=new A$;return Object.assign(p,c),p})}}async createInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=iU(e);return a=we("upload/v1beta/files",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>{const c=oU(d),p=new E$;return Object.assign(p,c),p})}}async get(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=cU(e);return a=we("files/{file}",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>d)}}async delete(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=lU(e);return a=we("files/{file}",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"DELETE",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(c=>{const p=c;return p.sdkHttpResponse={headers:d.headers},p})),s.then(d=>{const c=uU(d),p=new C$;return Object.assign(p,c),p})}}};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function df(t){const e={},n=g(t,["data"]);if(n!=null&&_(e,["data"],n),g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function mU(t){const e={},n=g(t,["parts"]);if(n!=null){let s=n;Array.isArray(s)&&(s=s.map(a=>NU(a))),_(e,["parts"],s)}const r=g(t,["role"]);return r!=null&&_(e,["role"],r),e}function gU(t){const e={};if(g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const n=g(t,["fileUri"]);n!=null&&_(e,["fileUri"],n);const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function yU(t){const e={};if(g(t,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");const n=g(t,["description"]);n!=null&&_(e,["description"],n);const r=g(t,["name"]);r!=null&&_(e,["name"],r);const s=g(t,["parameters"]);s!=null&&_(e,["parameters"],s);const a=g(t,["parametersJsonSchema"]);a!=null&&_(e,["parametersJsonSchema"],a);const o=g(t,["response"]);o!=null&&_(e,["response"],o);const u=g(t,["responseJsonSchema"]);return u!=null&&_(e,["responseJsonSchema"],u),e}function _U(t){const e={},n=g(t,["modelSelectionConfig"]);n!=null&&_(e,["modelConfig"],n);const r=g(t,["responseJsonSchema"]);r!=null&&_(e,["responseJsonSchema"],r);const s=g(t,["audioTimestamp"]);s!=null&&_(e,["audioTimestamp"],s);const a=g(t,["candidateCount"]);a!=null&&_(e,["candidateCount"],a);const o=g(t,["enableAffectiveDialog"]);o!=null&&_(e,["enableAffectiveDialog"],o);const u=g(t,["frequencyPenalty"]);u!=null&&_(e,["frequencyPenalty"],u);const d=g(t,["logprobs"]);d!=null&&_(e,["logprobs"],d);const c=g(t,["maxOutputTokens"]);c!=null&&_(e,["maxOutputTokens"],c);const p=g(t,["mediaResolution"]);p!=null&&_(e,["mediaResolution"],p);const m=g(t,["presencePenalty"]);m!=null&&_(e,["presencePenalty"],m);const y=g(t,["responseLogprobs"]);y!=null&&_(e,["responseLogprobs"],y);const w=g(t,["responseMimeType"]);w!=null&&_(e,["responseMimeType"],w);const x=g(t,["responseModalities"]);x!=null&&_(e,["responseModalities"],x);const A=g(t,["responseSchema"]);A!=null&&_(e,["responseSchema"],A);const E=g(t,["routingConfig"]);E!=null&&_(e,["routingConfig"],E);const C=g(t,["seed"]);C!=null&&_(e,["seed"],C);const D=g(t,["speechConfig"]);D!=null&&_(e,["speechConfig"],oN(D));const O=g(t,["stopSequences"]);O!=null&&_(e,["stopSequences"],O);const T=g(t,["temperature"]);T!=null&&_(e,["temperature"],T);const I=g(t,["thinkingConfig"]);I!=null&&_(e,["thinkingConfig"],I);const M=g(t,["topK"]);M!=null&&_(e,["topK"],M);const N=g(t,["topP"]);if(N!=null&&_(e,["topP"],N),g(t,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");return e}function vU(t){const e={};if(g(t,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const n=g(t,["enableWidget"]);return n!=null&&_(e,["enableWidget"],n),e}function wU(t){const e={};if(g(t,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(t,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const n=g(t,["timeRangeFilter"]);return n!=null&&_(e,["timeRangeFilter"],n),e}function bU(t,e){const n={},r=g(t,["generationConfig"]);e!==void 0&&r!=null&&_(e,["setup","generationConfig"],r);const s=g(t,["responseModalities"]);e!==void 0&&s!=null&&_(e,["setup","generationConfig","responseModalities"],s);const a=g(t,["temperature"]);e!==void 0&&a!=null&&_(e,["setup","generationConfig","temperature"],a);const o=g(t,["topP"]);e!==void 0&&o!=null&&_(e,["setup","generationConfig","topP"],o);const u=g(t,["topK"]);e!==void 0&&u!=null&&_(e,["setup","generationConfig","topK"],u);const d=g(t,["maxOutputTokens"]);e!==void 0&&d!=null&&_(e,["setup","generationConfig","maxOutputTokens"],d);const c=g(t,["mediaResolution"]);e!==void 0&&c!=null&&_(e,["setup","generationConfig","mediaResolution"],c);const p=g(t,["seed"]);e!==void 0&&p!=null&&_(e,["setup","generationConfig","seed"],p);const m=g(t,["speechConfig"]);e!==void 0&&m!=null&&_(e,["setup","generationConfig","speechConfig"],b0(m));const y=g(t,["thinkingConfig"]);e!==void 0&&y!=null&&_(e,["setup","generationConfig","thinkingConfig"],y);const w=g(t,["enableAffectiveDialog"]);e!==void 0&&w!=null&&_(e,["setup","generationConfig","enableAffectiveDialog"],w);const x=g(t,["systemInstruction"]);e!==void 0&&x!=null&&_(e,["setup","systemInstruction"],mU(In(x)));const A=g(t,["tools"]);if(e!==void 0&&A!=null){let M=il(A);Array.isArray(M)&&(M=M.map(N=>MU(al(N)))),_(e,["setup","tools"],M)}const E=g(t,["sessionResumption"]);e!==void 0&&E!=null&&_(e,["setup","sessionResumption"],PU(E));const C=g(t,["inputAudioTranscription"]);e!==void 0&&C!=null&&_(e,["setup","inputAudioTranscription"],C);const D=g(t,["outputAudioTranscription"]);e!==void 0&&D!=null&&_(e,["setup","outputAudioTranscription"],D);const O=g(t,["realtimeInputConfig"]);e!==void 0&&O!=null&&_(e,["setup","realtimeInputConfig"],O);const T=g(t,["contextWindowCompression"]);e!==void 0&&T!=null&&_(e,["setup","contextWindowCompression"],T);const I=g(t,["proactivity"]);return e!==void 0&&I!=null&&_(e,["setup","proactivity"],I),n}function SU(t,e){const n={},r=g(t,["generationConfig"]);e!==void 0&&r!=null&&_(e,["setup","generationConfig"],_U(r));const s=g(t,["responseModalities"]);e!==void 0&&s!=null&&_(e,["setup","generationConfig","responseModalities"],s);const a=g(t,["temperature"]);e!==void 0&&a!=null&&_(e,["setup","generationConfig","temperature"],a);const o=g(t,["topP"]);e!==void 0&&o!=null&&_(e,["setup","generationConfig","topP"],o);const u=g(t,["topK"]);e!==void 0&&u!=null&&_(e,["setup","generationConfig","topK"],u);const d=g(t,["maxOutputTokens"]);e!==void 0&&d!=null&&_(e,["setup","generationConfig","maxOutputTokens"],d);const c=g(t,["mediaResolution"]);e!==void 0&&c!=null&&_(e,["setup","generationConfig","mediaResolution"],c);const p=g(t,["seed"]);e!==void 0&&p!=null&&_(e,["setup","generationConfig","seed"],p);const m=g(t,["speechConfig"]);e!==void 0&&m!=null&&_(e,["setup","generationConfig","speechConfig"],oN(b0(m)));const y=g(t,["thinkingConfig"]);e!==void 0&&y!=null&&_(e,["setup","generationConfig","thinkingConfig"],y);const w=g(t,["enableAffectiveDialog"]);e!==void 0&&w!=null&&_(e,["setup","generationConfig","enableAffectiveDialog"],w);const x=g(t,["systemInstruction"]);e!==void 0&&x!=null&&_(e,["setup","systemInstruction"],In(x));const A=g(t,["tools"]);if(e!==void 0&&A!=null){let M=il(A);Array.isArray(M)&&(M=M.map(N=>kU(al(N)))),_(e,["setup","tools"],M)}const E=g(t,["sessionResumption"]);e!==void 0&&E!=null&&_(e,["setup","sessionResumption"],E);const C=g(t,["inputAudioTranscription"]);e!==void 0&&C!=null&&_(e,["setup","inputAudioTranscription"],C);const D=g(t,["outputAudioTranscription"]);e!==void 0&&D!=null&&_(e,["setup","outputAudioTranscription"],D);const O=g(t,["realtimeInputConfig"]);e!==void 0&&O!=null&&_(e,["setup","realtimeInputConfig"],O);const T=g(t,["contextWindowCompression"]);e!==void 0&&T!=null&&_(e,["setup","contextWindowCompression"],T);const I=g(t,["proactivity"]);return e!==void 0&&I!=null&&_(e,["setup","proactivity"],I),n}function xU(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["setup","model"],ht(t,r));const s=g(e,["config"]);return s!=null&&_(n,["config"],bU(s,n)),n}function TU(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["setup","model"],ht(t,r));const s=g(e,["config"]);return s!=null&&_(n,["config"],SU(s,n)),n}function AU(t){const e={},n=g(t,["musicGenerationConfig"]);return n!=null&&_(e,["musicGenerationConfig"],n),e}function EU(t){const e={},n=g(t,["weightedPrompts"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(s=>s)),_(e,["weightedPrompts"],r)}return e}function CU(t){const e={},n=g(t,["media"]);if(n!=null){let c=YR(n);Array.isArray(c)&&(c=c.map(p=>df(p))),_(e,["mediaChunks"],c)}const r=g(t,["audio"]);r!=null&&_(e,["audio"],df(WR(r)));const s=g(t,["audioStreamEnd"]);s!=null&&_(e,["audioStreamEnd"],s);const a=g(t,["video"]);a!=null&&_(e,["video"],df(KR(a)));const o=g(t,["text"]);o!=null&&_(e,["text"],o);const u=g(t,["activityStart"]);u!=null&&_(e,["activityStart"],u);const d=g(t,["activityEnd"]);return d!=null&&_(e,["activityEnd"],d),e}function IU(t){const e={},n=g(t,["media"]);if(n!=null){let c=YR(n);Array.isArray(c)&&(c=c.map(p=>p)),_(e,["mediaChunks"],c)}const r=g(t,["audio"]);r!=null&&_(e,["audio"],WR(r));const s=g(t,["audioStreamEnd"]);s!=null&&_(e,["audioStreamEnd"],s);const a=g(t,["video"]);a!=null&&_(e,["video"],KR(a));const o=g(t,["text"]);o!=null&&_(e,["text"],o);const u=g(t,["activityStart"]);u!=null&&_(e,["activityStart"],u);const d=g(t,["activityEnd"]);return d!=null&&_(e,["activityEnd"],d),e}function RU(t){const e={},n=g(t,["setupComplete"]);n!=null&&_(e,["setupComplete"],n);const r=g(t,["serverContent"]);r!=null&&_(e,["serverContent"],r);const s=g(t,["toolCall"]);s!=null&&_(e,["toolCall"],s);const a=g(t,["toolCallCancellation"]);a!=null&&_(e,["toolCallCancellation"],a);const o=g(t,["usageMetadata"]);o!=null&&_(e,["usageMetadata"],OU(o));const u=g(t,["goAway"]);u!=null&&_(e,["goAway"],u);const d=g(t,["sessionResumptionUpdate"]);return d!=null&&_(e,["sessionResumptionUpdate"],d),e}function NU(t){const e={},n=g(t,["functionCall"]);n!=null&&_(e,["functionCall"],n);const r=g(t,["codeExecutionResult"]);r!=null&&_(e,["codeExecutionResult"],r);const s=g(t,["executableCode"]);s!=null&&_(e,["executableCode"],s);const a=g(t,["fileData"]);a!=null&&_(e,["fileData"],gU(a));const o=g(t,["functionResponse"]);o!=null&&_(e,["functionResponse"],o);const u=g(t,["inlineData"]);u!=null&&_(e,["inlineData"],df(u));const d=g(t,["text"]);d!=null&&_(e,["text"],d);const c=g(t,["thought"]);c!=null&&_(e,["thought"],c);const p=g(t,["thoughtSignature"]);p!=null&&_(e,["thoughtSignature"],p);const m=g(t,["videoMetadata"]);return m!=null&&_(e,["videoMetadata"],m),e}function PU(t){const e={},n=g(t,["handle"]);if(n!=null&&_(e,["handle"],n),g(t,["transparent"])!==void 0)throw new Error("transparent parameter is not supported in Gemini API.");return e}function oN(t){const e={},n=g(t,["languageCode"]);n!=null&&_(e,["languageCode"],n);const r=g(t,["voiceConfig"]);if(r!=null&&_(e,["voiceConfig"],r),g(t,["multiSpeakerVoiceConfig"])!==void 0)throw new Error("multiSpeakerVoiceConfig parameter is not supported in Vertex AI.");return e}function MU(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let p=n;Array.isArray(p)&&(p=p.map(m=>m)),_(e,["functionDeclarations"],p)}if(g(t,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const r=g(t,["googleSearchRetrieval"]);r!=null&&_(e,["googleSearchRetrieval"],r);const s=g(t,["computerUse"]);s!=null&&_(e,["computerUse"],s);const a=g(t,["fileSearch"]);a!=null&&_(e,["fileSearch"],a);const o=g(t,["codeExecution"]);if(o!=null&&_(e,["codeExecution"],o),g(t,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const u=g(t,["googleMaps"]);u!=null&&_(e,["googleMaps"],vU(u));const d=g(t,["googleSearch"]);d!=null&&_(e,["googleSearch"],wU(d));const c=g(t,["urlContext"]);return c!=null&&_(e,["urlContext"],c),e}function kU(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let m=n;Array.isArray(m)&&(m=m.map(y=>yU(y))),_(e,["functionDeclarations"],m)}const r=g(t,["retrieval"]);r!=null&&_(e,["retrieval"],r);const s=g(t,["googleSearchRetrieval"]);s!=null&&_(e,["googleSearchRetrieval"],s);const a=g(t,["computerUse"]);if(a!=null&&_(e,["computerUse"],a),g(t,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");const o=g(t,["codeExecution"]);o!=null&&_(e,["codeExecution"],o);const u=g(t,["enterpriseWebSearch"]);u!=null&&_(e,["enterpriseWebSearch"],u);const d=g(t,["googleMaps"]);d!=null&&_(e,["googleMaps"],d);const c=g(t,["googleSearch"]);c!=null&&_(e,["googleSearch"],c);const p=g(t,["urlContext"]);return p!=null&&_(e,["urlContext"],p),e}function OU(t){const e={},n=g(t,["promptTokenCount"]);n!=null&&_(e,["promptTokenCount"],n);const r=g(t,["cachedContentTokenCount"]);r!=null&&_(e,["cachedContentTokenCount"],r);const s=g(t,["candidatesTokenCount"]);s!=null&&_(e,["responseTokenCount"],s);const a=g(t,["toolUsePromptTokenCount"]);a!=null&&_(e,["toolUsePromptTokenCount"],a);const o=g(t,["thoughtsTokenCount"]);o!=null&&_(e,["thoughtsTokenCount"],o);const u=g(t,["totalTokenCount"]);u!=null&&_(e,["totalTokenCount"],u);const d=g(t,["promptTokensDetails"]);if(d!=null){let w=d;Array.isArray(w)&&(w=w.map(x=>x)),_(e,["promptTokensDetails"],w)}const c=g(t,["cacheTokensDetails"]);if(c!=null){let w=c;Array.isArray(w)&&(w=w.map(x=>x)),_(e,["cacheTokensDetails"],w)}const p=g(t,["candidatesTokensDetails"]);if(p!=null){let w=p;Array.isArray(w)&&(w=w.map(x=>x)),_(e,["responseTokensDetails"],w)}const m=g(t,["toolUsePromptTokensDetails"]);if(m!=null){let w=m;Array.isArray(w)&&(w=w.map(x=>x)),_(e,["toolUsePromptTokensDetails"],w)}const y=g(t,["trafficType"]);return y!=null&&_(e,["trafficType"],y),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function DU(t){const e={},n=g(t,["data"]);if(n!=null&&_(e,["data"],n),g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function LU(t){const e={},n=g(t,["content"]);n!=null&&_(e,["content"],n);const r=g(t,["citationMetadata"]);r!=null&&_(e,["citationMetadata"],$U(r));const s=g(t,["tokenCount"]);s!=null&&_(e,["tokenCount"],s);const a=g(t,["finishReason"]);a!=null&&_(e,["finishReason"],a);const o=g(t,["avgLogprobs"]);o!=null&&_(e,["avgLogprobs"],o);const u=g(t,["groundingMetadata"]);u!=null&&_(e,["groundingMetadata"],u);const d=g(t,["index"]);d!=null&&_(e,["index"],d);const c=g(t,["logprobsResult"]);c!=null&&_(e,["logprobsResult"],c);const p=g(t,["safetyRatings"]);if(p!=null){let y=p;Array.isArray(y)&&(y=y.map(w=>w)),_(e,["safetyRatings"],y)}const m=g(t,["urlContextMetadata"]);return m!=null&&_(e,["urlContextMetadata"],m),e}function $U(t){const e={},n=g(t,["citationSources"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(s=>s)),_(e,["citations"],r)}return e}function UU(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let a=xr(s);Array.isArray(a)&&(a=a.map(o=>o)),_(n,["contents"],a)}return n}function FU(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["tokensInfo"]);if(r!=null){let s=r;Array.isArray(s)&&(s=s.map(a=>a)),_(e,["tokensInfo"],s)}return e}function BU(t){const e={},n=g(t,["values"]);n!=null&&_(e,["values"],n);const r=g(t,["statistics"]);return r!=null&&_(e,["statistics"],qU(r)),e}function qU(t){const e={},n=g(t,["truncated"]);n!=null&&_(e,["truncated"],n);const r=g(t,["token_count"]);return r!=null&&_(e,["tokenCount"],r),e}function sp(t){const e={},n=g(t,["parts"]);if(n!=null){let s=n;Array.isArray(s)&&(s=s.map(a=>V4(a))),_(e,["parts"],s)}const r=g(t,["role"]);return r!=null&&_(e,["role"],r),e}function GU(t){const e={},n=g(t,["controlType"]);n!=null&&_(e,["controlType"],n);const r=g(t,["enableControlImageComputation"]);return r!=null&&_(e,["computeControl"],r),e}function HU(t){const e={};if(g(t,["systemInstruction"])!==void 0)throw new Error("systemInstruction parameter is not supported in Gemini API.");if(g(t,["tools"])!==void 0)throw new Error("tools parameter is not supported in Gemini API.");if(g(t,["generationConfig"])!==void 0)throw new Error("generationConfig parameter is not supported in Gemini API.");return e}function zU(t,e){const n={},r=g(t,["systemInstruction"]);e!==void 0&&r!=null&&_(e,["systemInstruction"],In(r));const s=g(t,["tools"]);if(e!==void 0&&s!=null){let o=s;Array.isArray(o)&&(o=o.map(u=>fN(u))),_(e,["tools"],o)}const a=g(t,["generationConfig"]);return e!==void 0&&a!=null&&_(e,["generationConfig"],k4(a)),n}function jU(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let o=xr(s);Array.isArray(o)&&(o=o.map(u=>sp(u))),_(n,["contents"],o)}const a=g(e,["config"]);return a!=null&&HU(a),n}function VU(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let o=xr(s);Array.isArray(o)&&(o=o.map(u=>u)),_(n,["contents"],o)}const a=g(e,["config"]);return a!=null&&zU(a,n),n}function JU(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["totalTokens"]);r!=null&&_(e,["totalTokens"],r);const s=g(t,["cachedContentTokenCount"]);return s!=null&&_(e,["cachedContentTokenCount"],s),e}function YU(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["totalTokens"]);return r!=null&&_(e,["totalTokens"],r),e}function KU(t,e){const n={},r=g(e,["model"]);return r!=null&&_(n,["_url","name"],ht(t,r)),n}function WU(t,e){const n={},r=g(e,["model"]);return r!=null&&_(n,["_url","name"],ht(t,r)),n}function ZU(t){const e={},n=g(t,["sdkHttpResponse"]);return n!=null&&_(e,["sdkHttpResponse"],n),e}function XU(t){const e={},n=g(t,["sdkHttpResponse"]);return n!=null&&_(e,["sdkHttpResponse"],n),e}function QU(t,e){const n={},r=g(t,["outputGcsUri"]);e!==void 0&&r!=null&&_(e,["parameters","storageUri"],r);const s=g(t,["negativePrompt"]);e!==void 0&&s!=null&&_(e,["parameters","negativePrompt"],s);const a=g(t,["numberOfImages"]);e!==void 0&&a!=null&&_(e,["parameters","sampleCount"],a);const o=g(t,["aspectRatio"]);e!==void 0&&o!=null&&_(e,["parameters","aspectRatio"],o);const u=g(t,["guidanceScale"]);e!==void 0&&u!=null&&_(e,["parameters","guidanceScale"],u);const d=g(t,["seed"]);e!==void 0&&d!=null&&_(e,["parameters","seed"],d);const c=g(t,["safetyFilterLevel"]);e!==void 0&&c!=null&&_(e,["parameters","safetySetting"],c);const p=g(t,["personGeneration"]);e!==void 0&&p!=null&&_(e,["parameters","personGeneration"],p);const m=g(t,["includeSafetyAttributes"]);e!==void 0&&m!=null&&_(e,["parameters","includeSafetyAttributes"],m);const y=g(t,["includeRaiReason"]);e!==void 0&&y!=null&&_(e,["parameters","includeRaiReason"],y);const w=g(t,["language"]);e!==void 0&&w!=null&&_(e,["parameters","language"],w);const x=g(t,["outputMimeType"]);e!==void 0&&x!=null&&_(e,["parameters","outputOptions","mimeType"],x);const A=g(t,["outputCompressionQuality"]);e!==void 0&&A!=null&&_(e,["parameters","outputOptions","compressionQuality"],A);const E=g(t,["addWatermark"]);e!==void 0&&E!=null&&_(e,["parameters","addWatermark"],E);const C=g(t,["labels"]);e!==void 0&&C!=null&&_(e,["labels"],C);const D=g(t,["editMode"]);e!==void 0&&D!=null&&_(e,["parameters","editMode"],D);const O=g(t,["baseSteps"]);return e!==void 0&&O!=null&&_(e,["parameters","editConfig","baseSteps"],O),n}function e4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["prompt"]);s!=null&&_(n,["instances[0]","prompt"],s);const a=g(e,["referenceImages"]);if(a!=null){let u=a;Array.isArray(u)&&(u=u.map(d=>X4(d))),_(n,["instances[0]","referenceImages"],u)}const o=g(e,["config"]);return o!=null&&QU(o,n),n}function t4(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["predictions"]);if(r!=null){let s=r;Array.isArray(s)&&(s=s.map(a=>ap(a))),_(e,["generatedImages"],s)}return e}function n4(t,e){const n={},r=g(t,["taskType"]);e!==void 0&&r!=null&&_(e,["requests[]","taskType"],r);const s=g(t,["title"]);e!==void 0&&s!=null&&_(e,["requests[]","title"],s);const a=g(t,["outputDimensionality"]);if(e!==void 0&&a!=null&&_(e,["requests[]","outputDimensionality"],a),g(t,["mimeType"])!==void 0)throw new Error("mimeType parameter is not supported in Gemini API.");if(g(t,["autoTruncate"])!==void 0)throw new Error("autoTruncate parameter is not supported in Gemini API.");return n}function r4(t,e){const n={},r=g(t,["taskType"]);e!==void 0&&r!=null&&_(e,["instances[]","task_type"],r);const s=g(t,["title"]);e!==void 0&&s!=null&&_(e,["instances[]","title"],s);const a=g(t,["outputDimensionality"]);e!==void 0&&a!=null&&_(e,["parameters","outputDimensionality"],a);const o=g(t,["mimeType"]);e!==void 0&&o!=null&&_(e,["instances[]","mimeType"],o);const u=g(t,["autoTruncate"]);return e!==void 0&&u!=null&&_(e,["parameters","autoTruncate"],u),n}function s4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let u=_0(t,s);Array.isArray(u)&&(u=u.map(d=>d)),_(n,["requests[]","content"],u)}const a=g(e,["config"]);a!=null&&n4(a,n);const o=g(e,["model"]);return o!==void 0&&_(n,["requests[]","model"],ht(t,o)),n}function a4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let o=_0(t,s);Array.isArray(o)&&(o=o.map(u=>u)),_(n,["instances[]","content"],o)}const a=g(e,["config"]);return a!=null&&r4(a,n),n}function i4(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["embeddings"]);if(r!=null){let a=r;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["embeddings"],a)}const s=g(t,["metadata"]);return s!=null&&_(e,["metadata"],s),e}function o4(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["predictions[]","embeddings"]);if(r!=null){let a=r;Array.isArray(a)&&(a=a.map(o=>BU(o))),_(e,["embeddings"],a)}const s=g(t,["metadata"]);return s!=null&&_(e,["metadata"],s),e}function l4(t){const e={},n=g(t,["endpoint"]);n!=null&&_(e,["name"],n);const r=g(t,["deployedModelId"]);return r!=null&&_(e,["deployedModelId"],r),e}function u4(t){const e={};if(g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const n=g(t,["fileUri"]);n!=null&&_(e,["fileUri"],n);const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function c4(t){const e={};if(g(t,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");const n=g(t,["description"]);n!=null&&_(e,["description"],n);const r=g(t,["name"]);r!=null&&_(e,["name"],r);const s=g(t,["parameters"]);s!=null&&_(e,["parameters"],s);const a=g(t,["parametersJsonSchema"]);a!=null&&_(e,["parametersJsonSchema"],a);const o=g(t,["response"]);o!=null&&_(e,["response"],o);const u=g(t,["responseJsonSchema"]);return u!=null&&_(e,["responseJsonSchema"],u),e}function d4(t,e,n){const r={},s=g(e,["systemInstruction"]);n!==void 0&&s!=null&&_(n,["systemInstruction"],sp(In(s)));const a=g(e,["temperature"]);a!=null&&_(r,["temperature"],a);const o=g(e,["topP"]);o!=null&&_(r,["topP"],o);const u=g(e,["topK"]);u!=null&&_(r,["topK"],u);const d=g(e,["candidateCount"]);d!=null&&_(r,["candidateCount"],d);const c=g(e,["maxOutputTokens"]);c!=null&&_(r,["maxOutputTokens"],c);const p=g(e,["stopSequences"]);p!=null&&_(r,["stopSequences"],p);const m=g(e,["responseLogprobs"]);m!=null&&_(r,["responseLogprobs"],m);const y=g(e,["logprobs"]);y!=null&&_(r,["logprobs"],y);const w=g(e,["presencePenalty"]);w!=null&&_(r,["presencePenalty"],w);const x=g(e,["frequencyPenalty"]);x!=null&&_(r,["frequencyPenalty"],x);const A=g(e,["seed"]);A!=null&&_(r,["seed"],A);const E=g(e,["responseMimeType"]);E!=null&&_(r,["responseMimeType"],E);const C=g(e,["responseSchema"]);C!=null&&_(r,["responseSchema"],v0(C));const D=g(e,["responseJsonSchema"]);if(D!=null&&_(r,["responseJsonSchema"],D),g(e,["routingConfig"])!==void 0)throw new Error("routingConfig parameter is not supported in Gemini API.");if(g(e,["modelSelectionConfig"])!==void 0)throw new Error("modelSelectionConfig parameter is not supported in Gemini API.");const O=g(e,["safetySettings"]);if(n!==void 0&&O!=null){let F=O;Array.isArray(F)&&(F=F.map(K=>Q4(K))),_(n,["safetySettings"],F)}const T=g(e,["tools"]);if(n!==void 0&&T!=null){let F=il(T);Array.isArray(F)&&(F=F.map(K=>a3(al(K)))),_(n,["tools"],F)}const I=g(e,["toolConfig"]);if(n!==void 0&&I!=null&&_(n,["toolConfig"],I),g(e,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");const M=g(e,["cachedContent"]);n!==void 0&&M!=null&&_(n,["cachedContent"],Js(t,M));const N=g(e,["responseModalities"]);N!=null&&_(r,["responseModalities"],N);const P=g(e,["mediaResolution"]);P!=null&&_(r,["mediaResolution"],P);const k=g(e,["speechConfig"]);if(k!=null&&_(r,["speechConfig"],w0(k)),g(e,["audioTimestamp"])!==void 0)throw new Error("audioTimestamp parameter is not supported in Gemini API.");const $=g(e,["thinkingConfig"]);$!=null&&_(r,["thinkingConfig"],$);const U=g(e,["imageConfig"]);return U!=null&&_(r,["imageConfig"],U),r}function f4(t,e,n){const r={},s=g(e,["systemInstruction"]);n!==void 0&&s!=null&&_(n,["systemInstruction"],In(s));const a=g(e,["temperature"]);a!=null&&_(r,["temperature"],a);const o=g(e,["topP"]);o!=null&&_(r,["topP"],o);const u=g(e,["topK"]);u!=null&&_(r,["topK"],u);const d=g(e,["candidateCount"]);d!=null&&_(r,["candidateCount"],d);const c=g(e,["maxOutputTokens"]);c!=null&&_(r,["maxOutputTokens"],c);const p=g(e,["stopSequences"]);p!=null&&_(r,["stopSequences"],p);const m=g(e,["responseLogprobs"]);m!=null&&_(r,["responseLogprobs"],m);const y=g(e,["logprobs"]);y!=null&&_(r,["logprobs"],y);const w=g(e,["presencePenalty"]);w!=null&&_(r,["presencePenalty"],w);const x=g(e,["frequencyPenalty"]);x!=null&&_(r,["frequencyPenalty"],x);const A=g(e,["seed"]);A!=null&&_(r,["seed"],A);const E=g(e,["responseMimeType"]);E!=null&&_(r,["responseMimeType"],E);const C=g(e,["responseSchema"]);C!=null&&_(r,["responseSchema"],v0(C));const D=g(e,["responseJsonSchema"]);D!=null&&_(r,["responseJsonSchema"],D);const O=g(e,["routingConfig"]);O!=null&&_(r,["routingConfig"],O);const T=g(e,["modelSelectionConfig"]);T!=null&&_(r,["modelConfig"],T);const I=g(e,["safetySettings"]);if(n!==void 0&&I!=null){let B=I;Array.isArray(B)&&(B=B.map(G=>G)),_(n,["safetySettings"],B)}const M=g(e,["tools"]);if(n!==void 0&&M!=null){let B=il(M);Array.isArray(B)&&(B=B.map(G=>fN(al(G)))),_(n,["tools"],B)}const N=g(e,["toolConfig"]);n!==void 0&&N!=null&&_(n,["toolConfig"],N);const P=g(e,["labels"]);n!==void 0&&P!=null&&_(n,["labels"],P);const k=g(e,["cachedContent"]);n!==void 0&&k!=null&&_(n,["cachedContent"],Js(t,k));const $=g(e,["responseModalities"]);$!=null&&_(r,["responseModalities"],$);const U=g(e,["mediaResolution"]);U!=null&&_(r,["mediaResolution"],U);const F=g(e,["speechConfig"]);F!=null&&_(r,["speechConfig"],dN(w0(F)));const K=g(e,["audioTimestamp"]);K!=null&&_(r,["audioTimestamp"],K);const j=g(e,["thinkingConfig"]);j!=null&&_(r,["thinkingConfig"],j);const V=g(e,["imageConfig"]);return V!=null&&_(r,["imageConfig"],V),r}function TA(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let o=xr(s);Array.isArray(o)&&(o=o.map(u=>sp(u))),_(n,["contents"],o)}const a=g(e,["config"]);return a!=null&&_(n,["generationConfig"],d4(t,a,n)),n}function AA(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["contents"]);if(s!=null){let o=xr(s);Array.isArray(o)&&(o=o.map(u=>u)),_(n,["contents"],o)}const a=g(e,["config"]);return a!=null&&_(n,["generationConfig"],f4(t,a,n)),n}function EA(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["candidates"]);if(r!=null){let d=r;Array.isArray(d)&&(d=d.map(c=>LU(c))),_(e,["candidates"],d)}const s=g(t,["modelVersion"]);s!=null&&_(e,["modelVersion"],s);const a=g(t,["promptFeedback"]);a!=null&&_(e,["promptFeedback"],a);const o=g(t,["responseId"]);o!=null&&_(e,["responseId"],o);const u=g(t,["usageMetadata"]);return u!=null&&_(e,["usageMetadata"],u),e}function CA(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["candidates"]);if(r!=null){let c=r;Array.isArray(c)&&(c=c.map(p=>p)),_(e,["candidates"],c)}const s=g(t,["createTime"]);s!=null&&_(e,["createTime"],s);const a=g(t,["modelVersion"]);a!=null&&_(e,["modelVersion"],a);const o=g(t,["promptFeedback"]);o!=null&&_(e,["promptFeedback"],o);const u=g(t,["responseId"]);u!=null&&_(e,["responseId"],u);const d=g(t,["usageMetadata"]);return d!=null&&_(e,["usageMetadata"],d),e}function p4(t,e){const n={};if(g(t,["outputGcsUri"])!==void 0)throw new Error("outputGcsUri parameter is not supported in Gemini API.");if(g(t,["negativePrompt"])!==void 0)throw new Error("negativePrompt parameter is not supported in Gemini API.");const r=g(t,["numberOfImages"]);e!==void 0&&r!=null&&_(e,["parameters","sampleCount"],r);const s=g(t,["aspectRatio"]);e!==void 0&&s!=null&&_(e,["parameters","aspectRatio"],s);const a=g(t,["guidanceScale"]);if(e!==void 0&&a!=null&&_(e,["parameters","guidanceScale"],a),g(t,["seed"])!==void 0)throw new Error("seed parameter is not supported in Gemini API.");const o=g(t,["safetyFilterLevel"]);e!==void 0&&o!=null&&_(e,["parameters","safetySetting"],o);const u=g(t,["personGeneration"]);e!==void 0&&u!=null&&_(e,["parameters","personGeneration"],u);const d=g(t,["includeSafetyAttributes"]);e!==void 0&&d!=null&&_(e,["parameters","includeSafetyAttributes"],d);const c=g(t,["includeRaiReason"]);e!==void 0&&c!=null&&_(e,["parameters","includeRaiReason"],c);const p=g(t,["language"]);e!==void 0&&p!=null&&_(e,["parameters","language"],p);const m=g(t,["outputMimeType"]);e!==void 0&&m!=null&&_(e,["parameters","outputOptions","mimeType"],m);const y=g(t,["outputCompressionQuality"]);if(e!==void 0&&y!=null&&_(e,["parameters","outputOptions","compressionQuality"],y),g(t,["addWatermark"])!==void 0)throw new Error("addWatermark parameter is not supported in Gemini API.");if(g(t,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");const w=g(t,["imageSize"]);if(e!==void 0&&w!=null&&_(e,["parameters","sampleImageSize"],w),g(t,["enhancePrompt"])!==void 0)throw new Error("enhancePrompt parameter is not supported in Gemini API.");return n}function h4(t,e){const n={},r=g(t,["outputGcsUri"]);e!==void 0&&r!=null&&_(e,["parameters","storageUri"],r);const s=g(t,["negativePrompt"]);e!==void 0&&s!=null&&_(e,["parameters","negativePrompt"],s);const a=g(t,["numberOfImages"]);e!==void 0&&a!=null&&_(e,["parameters","sampleCount"],a);const o=g(t,["aspectRatio"]);e!==void 0&&o!=null&&_(e,["parameters","aspectRatio"],o);const u=g(t,["guidanceScale"]);e!==void 0&&u!=null&&_(e,["parameters","guidanceScale"],u);const d=g(t,["seed"]);e!==void 0&&d!=null&&_(e,["parameters","seed"],d);const c=g(t,["safetyFilterLevel"]);e!==void 0&&c!=null&&_(e,["parameters","safetySetting"],c);const p=g(t,["personGeneration"]);e!==void 0&&p!=null&&_(e,["parameters","personGeneration"],p);const m=g(t,["includeSafetyAttributes"]);e!==void 0&&m!=null&&_(e,["parameters","includeSafetyAttributes"],m);const y=g(t,["includeRaiReason"]);e!==void 0&&y!=null&&_(e,["parameters","includeRaiReason"],y);const w=g(t,["language"]);e!==void 0&&w!=null&&_(e,["parameters","language"],w);const x=g(t,["outputMimeType"]);e!==void 0&&x!=null&&_(e,["parameters","outputOptions","mimeType"],x);const A=g(t,["outputCompressionQuality"]);e!==void 0&&A!=null&&_(e,["parameters","outputOptions","compressionQuality"],A);const E=g(t,["addWatermark"]);e!==void 0&&E!=null&&_(e,["parameters","addWatermark"],E);const C=g(t,["labels"]);e!==void 0&&C!=null&&_(e,["labels"],C);const D=g(t,["imageSize"]);e!==void 0&&D!=null&&_(e,["parameters","sampleImageSize"],D);const O=g(t,["enhancePrompt"]);return e!==void 0&&O!=null&&_(e,["parameters","enhancePrompt"],O),n}function m4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["prompt"]);s!=null&&_(n,["instances[0]","prompt"],s);const a=g(e,["config"]);return a!=null&&p4(a,n),n}function g4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["prompt"]);s!=null&&_(n,["instances[0]","prompt"],s);const a=g(e,["config"]);return a!=null&&h4(a,n),n}function y4(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["predictions"]);if(r!=null){let a=r;Array.isArray(a)&&(a=a.map(o=>R4(o))),_(e,["generatedImages"],a)}const s=g(t,["positivePromptSafetyAttributes"]);return s!=null&&_(e,["positivePromptSafetyAttributes"],uN(s)),e}function _4(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["predictions"]);if(r!=null){let a=r;Array.isArray(a)&&(a=a.map(o=>ap(o))),_(e,["generatedImages"],a)}const s=g(t,["positivePromptSafetyAttributes"]);return s!=null&&_(e,["positivePromptSafetyAttributes"],cN(s)),e}function v4(t,e){const n={},r=g(t,["numberOfVideos"]);if(e!==void 0&&r!=null&&_(e,["parameters","sampleCount"],r),g(t,["outputGcsUri"])!==void 0)throw new Error("outputGcsUri parameter is not supported in Gemini API.");if(g(t,["fps"])!==void 0)throw new Error("fps parameter is not supported in Gemini API.");const s=g(t,["durationSeconds"]);if(e!==void 0&&s!=null&&_(e,["parameters","durationSeconds"],s),g(t,["seed"])!==void 0)throw new Error("seed parameter is not supported in Gemini API.");const a=g(t,["aspectRatio"]);e!==void 0&&a!=null&&_(e,["parameters","aspectRatio"],a);const o=g(t,["resolution"]);e!==void 0&&o!=null&&_(e,["parameters","resolution"],o);const u=g(t,["personGeneration"]);if(e!==void 0&&u!=null&&_(e,["parameters","personGeneration"],u),g(t,["pubsubTopic"])!==void 0)throw new Error("pubsubTopic parameter is not supported in Gemini API.");const d=g(t,["negativePrompt"]);e!==void 0&&d!=null&&_(e,["parameters","negativePrompt"],d);const c=g(t,["enhancePrompt"]);if(e!==void 0&&c!=null&&_(e,["parameters","enhancePrompt"],c),g(t,["generateAudio"])!==void 0)throw new Error("generateAudio parameter is not supported in Gemini API.");const p=g(t,["lastFrame"]);e!==void 0&&p!=null&&_(e,["instances[0]","lastFrame"],ip(p));const m=g(t,["referenceImages"]);if(e!==void 0&&m!=null){let y=m;Array.isArray(y)&&(y=y.map(w=>_3(w))),_(e,["instances[0]","referenceImages"],y)}if(g(t,["mask"])!==void 0)throw new Error("mask parameter is not supported in Gemini API.");if(g(t,["compressionQuality"])!==void 0)throw new Error("compressionQuality parameter is not supported in Gemini API.");return n}function w4(t,e){const n={},r=g(t,["numberOfVideos"]);e!==void 0&&r!=null&&_(e,["parameters","sampleCount"],r);const s=g(t,["outputGcsUri"]);e!==void 0&&s!=null&&_(e,["parameters","storageUri"],s);const a=g(t,["fps"]);e!==void 0&&a!=null&&_(e,["parameters","fps"],a);const o=g(t,["durationSeconds"]);e!==void 0&&o!=null&&_(e,["parameters","durationSeconds"],o);const u=g(t,["seed"]);e!==void 0&&u!=null&&_(e,["parameters","seed"],u);const d=g(t,["aspectRatio"]);e!==void 0&&d!=null&&_(e,["parameters","aspectRatio"],d);const c=g(t,["resolution"]);e!==void 0&&c!=null&&_(e,["parameters","resolution"],c);const p=g(t,["personGeneration"]);e!==void 0&&p!=null&&_(e,["parameters","personGeneration"],p);const m=g(t,["pubsubTopic"]);e!==void 0&&m!=null&&_(e,["parameters","pubsubTopic"],m);const y=g(t,["negativePrompt"]);e!==void 0&&y!=null&&_(e,["parameters","negativePrompt"],y);const w=g(t,["enhancePrompt"]);e!==void 0&&w!=null&&_(e,["parameters","enhancePrompt"],w);const x=g(t,["generateAudio"]);e!==void 0&&x!=null&&_(e,["parameters","generateAudio"],x);const A=g(t,["lastFrame"]);e!==void 0&&A!=null&&_(e,["instances[0]","lastFrame"],zr(A));const E=g(t,["referenceImages"]);if(e!==void 0&&E!=null){let O=E;Array.isArray(O)&&(O=O.map(T=>v3(T))),_(e,["instances[0]","referenceImages"],O)}const C=g(t,["mask"]);e!==void 0&&C!=null&&_(e,["instances[0]","mask"],y3(C));const D=g(t,["compressionQuality"]);return e!==void 0&&D!=null&&_(e,["parameters","compressionQuality"],D),n}function b4(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata"]);r!=null&&_(e,["metadata"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["response","generateVideoResponse"]);return o!=null&&_(e,["response"],A4(o)),e}function S4(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata"]);r!=null&&_(e,["metadata"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["response"]);return o!=null&&_(e,["response"],E4(o)),e}function x4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["prompt"]);s!=null&&_(n,["instances[0]","prompt"],s);const a=g(e,["image"]);a!=null&&_(n,["instances[0]","image"],ip(a));const o=g(e,["video"]);o!=null&&_(n,["instances[0]","video"],pN(o));const u=g(e,["source"]);u!=null&&C4(u,n);const d=g(e,["config"]);return d!=null&&v4(d,n),n}function T4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["prompt"]);s!=null&&_(n,["instances[0]","prompt"],s);const a=g(e,["image"]);a!=null&&_(n,["instances[0]","image"],zr(a));const o=g(e,["video"]);o!=null&&_(n,["instances[0]","video"],hN(o));const u=g(e,["source"]);u!=null&&I4(u,n);const d=g(e,["config"]);return d!=null&&w4(d,n),n}function A4(t){const e={},n=g(t,["generatedSamples"]);if(n!=null){let a=n;Array.isArray(a)&&(a=a.map(o=>P4(o))),_(e,["generatedVideos"],a)}const r=g(t,["raiMediaFilteredCount"]);r!=null&&_(e,["raiMediaFilteredCount"],r);const s=g(t,["raiMediaFilteredReasons"]);return s!=null&&_(e,["raiMediaFilteredReasons"],s),e}function E4(t){const e={},n=g(t,["videos"]);if(n!=null){let a=n;Array.isArray(a)&&(a=a.map(o=>M4(o))),_(e,["generatedVideos"],a)}const r=g(t,["raiMediaFilteredCount"]);r!=null&&_(e,["raiMediaFilteredCount"],r);const s=g(t,["raiMediaFilteredReasons"]);return s!=null&&_(e,["raiMediaFilteredReasons"],s),e}function C4(t,e){const n={},r=g(t,["prompt"]);e!==void 0&&r!=null&&_(e,["instances[0]","prompt"],r);const s=g(t,["image"]);e!==void 0&&s!=null&&_(e,["instances[0]","image"],ip(s));const a=g(t,["video"]);return e!==void 0&&a!=null&&_(e,["instances[0]","video"],pN(a)),n}function I4(t,e){const n={},r=g(t,["prompt"]);e!==void 0&&r!=null&&_(e,["instances[0]","prompt"],r);const s=g(t,["image"]);e!==void 0&&s!=null&&_(e,["instances[0]","image"],zr(s));const a=g(t,["video"]);return e!==void 0&&a!=null&&_(e,["instances[0]","video"],hN(a)),n}function R4(t){const e={},n=g(t,["_self"]);n!=null&&_(e,["image"],U4(n));const r=g(t,["raiFilteredReason"]);r!=null&&_(e,["raiFilteredReason"],r);const s=g(t,["_self"]);return s!=null&&_(e,["safetyAttributes"],uN(s)),e}function ap(t){const e={},n=g(t,["_self"]);n!=null&&_(e,["image"],lN(n));const r=g(t,["raiFilteredReason"]);r!=null&&_(e,["raiFilteredReason"],r);const s=g(t,["_self"]);s!=null&&_(e,["safetyAttributes"],cN(s));const a=g(t,["prompt"]);return a!=null&&_(e,["enhancedPrompt"],a),e}function N4(t){const e={},n=g(t,["_self"]);n!=null&&_(e,["mask"],lN(n));const r=g(t,["labels"]);if(r!=null){let s=r;Array.isArray(s)&&(s=s.map(a=>a)),_(e,["labels"],s)}return e}function P4(t){const e={},n=g(t,["video"]);return n!=null&&_(e,["video"],m3(n)),e}function M4(t){const e={},n=g(t,["_self"]);return n!=null&&_(e,["video"],g3(n)),e}function k4(t){const e={},n=g(t,["modelSelectionConfig"]);n!=null&&_(e,["modelConfig"],n);const r=g(t,["responseJsonSchema"]);r!=null&&_(e,["responseJsonSchema"],r);const s=g(t,["audioTimestamp"]);s!=null&&_(e,["audioTimestamp"],s);const a=g(t,["candidateCount"]);a!=null&&_(e,["candidateCount"],a);const o=g(t,["enableAffectiveDialog"]);o!=null&&_(e,["enableAffectiveDialog"],o);const u=g(t,["frequencyPenalty"]);u!=null&&_(e,["frequencyPenalty"],u);const d=g(t,["logprobs"]);d!=null&&_(e,["logprobs"],d);const c=g(t,["maxOutputTokens"]);c!=null&&_(e,["maxOutputTokens"],c);const p=g(t,["mediaResolution"]);p!=null&&_(e,["mediaResolution"],p);const m=g(t,["presencePenalty"]);m!=null&&_(e,["presencePenalty"],m);const y=g(t,["responseLogprobs"]);y!=null&&_(e,["responseLogprobs"],y);const w=g(t,["responseMimeType"]);w!=null&&_(e,["responseMimeType"],w);const x=g(t,["responseModalities"]);x!=null&&_(e,["responseModalities"],x);const A=g(t,["responseSchema"]);A!=null&&_(e,["responseSchema"],A);const E=g(t,["routingConfig"]);E!=null&&_(e,["routingConfig"],E);const C=g(t,["seed"]);C!=null&&_(e,["seed"],C);const D=g(t,["speechConfig"]);D!=null&&_(e,["speechConfig"],dN(D));const O=g(t,["stopSequences"]);O!=null&&_(e,["stopSequences"],O);const T=g(t,["temperature"]);T!=null&&_(e,["temperature"],T);const I=g(t,["thinkingConfig"]);I!=null&&_(e,["thinkingConfig"],I);const M=g(t,["topK"]);M!=null&&_(e,["topK"],M);const N=g(t,["topP"]);if(N!=null&&_(e,["topP"],N),g(t,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");return e}function O4(t,e){const n={},r=g(e,["model"]);return r!=null&&_(n,["_url","name"],ht(t,r)),n}function D4(t,e){const n={},r=g(e,["model"]);return r!=null&&_(n,["_url","name"],ht(t,r)),n}function L4(t){const e={};if(g(t,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const n=g(t,["enableWidget"]);return n!=null&&_(e,["enableWidget"],n),e}function $4(t){const e={};if(g(t,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(t,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const n=g(t,["timeRangeFilter"]);return n!=null&&_(e,["timeRangeFilter"],n),e}function U4(t){const e={},n=g(t,["bytesBase64Encoded"]);n!=null&&_(e,["imageBytes"],Ha(n));const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function lN(t){const e={},n=g(t,["gcsUri"]);n!=null&&_(e,["gcsUri"],n);const r=g(t,["bytesBase64Encoded"]);r!=null&&_(e,["imageBytes"],Ha(r));const s=g(t,["mimeType"]);return s!=null&&_(e,["mimeType"],s),e}function ip(t){const e={};if(g(t,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");const n=g(t,["imageBytes"]);n!=null&&_(e,["bytesBase64Encoded"],Ha(n));const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function zr(t){const e={},n=g(t,["gcsUri"]);n!=null&&_(e,["gcsUri"],n);const r=g(t,["imageBytes"]);r!=null&&_(e,["bytesBase64Encoded"],Ha(r));const s=g(t,["mimeType"]);return s!=null&&_(e,["mimeType"],s),e}function F4(t,e,n){const r={},s=g(e,["pageSize"]);n!==void 0&&s!=null&&_(n,["_query","pageSize"],s);const a=g(e,["pageToken"]);n!==void 0&&a!=null&&_(n,["_query","pageToken"],a);const o=g(e,["filter"]);n!==void 0&&o!=null&&_(n,["_query","filter"],o);const u=g(e,["queryBase"]);return n!==void 0&&u!=null&&_(n,["_url","models_url"],eN(t,u)),r}function B4(t,e,n){const r={},s=g(e,["pageSize"]);n!==void 0&&s!=null&&_(n,["_query","pageSize"],s);const a=g(e,["pageToken"]);n!==void 0&&a!=null&&_(n,["_query","pageToken"],a);const o=g(e,["filter"]);n!==void 0&&o!=null&&_(n,["_query","filter"],o);const u=g(e,["queryBase"]);return n!==void 0&&u!=null&&_(n,["_url","models_url"],eN(t,u)),r}function q4(t,e){const n={},r=g(e,["config"]);return r!=null&&F4(t,r,n),n}function G4(t,e){const n={},r=g(e,["config"]);return r!=null&&B4(t,r,n),n}function H4(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["_self"]);if(s!=null){let a=tN(s);Array.isArray(a)&&(a=a.map(o=>a_(o))),_(e,["models"],a)}return e}function z4(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["_self"]);if(s!=null){let a=tN(s);Array.isArray(a)&&(a=a.map(o=>i_(o))),_(e,["models"],a)}return e}function j4(t){const e={},n=g(t,["maskMode"]);n!=null&&_(e,["maskMode"],n);const r=g(t,["segmentationClasses"]);r!=null&&_(e,["maskClasses"],r);const s=g(t,["maskDilation"]);return s!=null&&_(e,["dilation"],s),e}function a_(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["displayName"]);r!=null&&_(e,["displayName"],r);const s=g(t,["description"]);s!=null&&_(e,["description"],s);const a=g(t,["version"]);a!=null&&_(e,["version"],a);const o=g(t,["_self"]);o!=null&&_(e,["tunedModelInfo"],i3(o));const u=g(t,["inputTokenLimit"]);u!=null&&_(e,["inputTokenLimit"],u);const d=g(t,["outputTokenLimit"]);d!=null&&_(e,["outputTokenLimit"],d);const c=g(t,["supportedGenerationMethods"]);return c!=null&&_(e,["supportedActions"],c),e}function i_(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["displayName"]);r!=null&&_(e,["displayName"],r);const s=g(t,["description"]);s!=null&&_(e,["description"],s);const a=g(t,["versionId"]);a!=null&&_(e,["version"],a);const o=g(t,["deployedModels"]);if(o!=null){let m=o;Array.isArray(m)&&(m=m.map(y=>l4(y))),_(e,["endpoints"],m)}const u=g(t,["labels"]);u!=null&&_(e,["labels"],u);const d=g(t,["_self"]);d!=null&&_(e,["tunedModelInfo"],o3(d));const c=g(t,["defaultCheckpointId"]);c!=null&&_(e,["defaultCheckpointId"],c);const p=g(t,["checkpoints"]);if(p!=null){let m=p;Array.isArray(m)&&(m=m.map(y=>y)),_(e,["checkpoints"],m)}return e}function V4(t){const e={},n=g(t,["functionCall"]);n!=null&&_(e,["functionCall"],n);const r=g(t,["codeExecutionResult"]);r!=null&&_(e,["codeExecutionResult"],r);const s=g(t,["executableCode"]);s!=null&&_(e,["executableCode"],s);const a=g(t,["fileData"]);a!=null&&_(e,["fileData"],u4(a));const o=g(t,["functionResponse"]);o!=null&&_(e,["functionResponse"],o);const u=g(t,["inlineData"]);u!=null&&_(e,["inlineData"],DU(u));const d=g(t,["text"]);d!=null&&_(e,["text"],d);const c=g(t,["thought"]);c!=null&&_(e,["thought"],c);const p=g(t,["thoughtSignature"]);p!=null&&_(e,["thoughtSignature"],p);const m=g(t,["videoMetadata"]);return m!=null&&_(e,["videoMetadata"],m),e}function J4(t){const e={},n=g(t,["productImage"]);return n!=null&&_(e,["image"],zr(n)),e}function Y4(t,e){const n={},r=g(t,["numberOfImages"]);e!==void 0&&r!=null&&_(e,["parameters","sampleCount"],r);const s=g(t,["baseSteps"]);e!==void 0&&s!=null&&_(e,["parameters","editConfig","baseSteps"],s);const a=g(t,["outputGcsUri"]);e!==void 0&&a!=null&&_(e,["parameters","storageUri"],a);const o=g(t,["seed"]);e!==void 0&&o!=null&&_(e,["parameters","seed"],o);const u=g(t,["safetyFilterLevel"]);e!==void 0&&u!=null&&_(e,["parameters","safetySetting"],u);const d=g(t,["personGeneration"]);e!==void 0&&d!=null&&_(e,["parameters","personGeneration"],d);const c=g(t,["addWatermark"]);e!==void 0&&c!=null&&_(e,["parameters","addWatermark"],c);const p=g(t,["outputMimeType"]);e!==void 0&&p!=null&&_(e,["parameters","outputOptions","mimeType"],p);const m=g(t,["outputCompressionQuality"]);e!==void 0&&m!=null&&_(e,["parameters","outputOptions","compressionQuality"],m);const y=g(t,["enhancePrompt"]);e!==void 0&&y!=null&&_(e,["parameters","enhancePrompt"],y);const w=g(t,["labels"]);return e!==void 0&&w!=null&&_(e,["labels"],w),n}function K4(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["source"]);s!=null&&Z4(s,n);const a=g(e,["config"]);return a!=null&&Y4(a,n),n}function W4(t){const e={},n=g(t,["predictions"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(s=>ap(s))),_(e,["generatedImages"],r)}return e}function Z4(t,e){const n={},r=g(t,["prompt"]);e!==void 0&&r!=null&&_(e,["instances[0]","prompt"],r);const s=g(t,["personImage"]);e!==void 0&&s!=null&&_(e,["instances[0]","personImage","image"],zr(s));const a=g(t,["productImages"]);if(e!==void 0&&a!=null){let o=a;Array.isArray(o)&&(o=o.map(u=>J4(u))),_(e,["instances[0]","productImages"],o)}return n}function X4(t){const e={},n=g(t,["referenceImage"]);n!=null&&_(e,["referenceImage"],zr(n));const r=g(t,["referenceId"]);r!=null&&_(e,["referenceId"],r);const s=g(t,["referenceType"]);s!=null&&_(e,["referenceType"],s);const a=g(t,["maskImageConfig"]);a!=null&&_(e,["maskImageConfig"],j4(a));const o=g(t,["controlImageConfig"]);o!=null&&_(e,["controlImageConfig"],GU(o));const u=g(t,["styleImageConfig"]);u!=null&&_(e,["styleImageConfig"],u);const d=g(t,["subjectImageConfig"]);return d!=null&&_(e,["subjectImageConfig"],d),e}function uN(t){const e={},n=g(t,["safetyAttributes","categories"]);n!=null&&_(e,["categories"],n);const r=g(t,["safetyAttributes","scores"]);r!=null&&_(e,["scores"],r);const s=g(t,["contentType"]);return s!=null&&_(e,["contentType"],s),e}function cN(t){const e={},n=g(t,["safetyAttributes","categories"]);n!=null&&_(e,["categories"],n);const r=g(t,["safetyAttributes","scores"]);r!=null&&_(e,["scores"],r);const s=g(t,["contentType"]);return s!=null&&_(e,["contentType"],s),e}function Q4(t){const e={},n=g(t,["category"]);if(n!=null&&_(e,["category"],n),g(t,["method"])!==void 0)throw new Error("method parameter is not supported in Gemini API.");const r=g(t,["threshold"]);return r!=null&&_(e,["threshold"],r),e}function e3(t){const e={},n=g(t,["image"]);return n!=null&&_(e,["image"],zr(n)),e}function t3(t,e){const n={},r=g(t,["mode"]);e!==void 0&&r!=null&&_(e,["parameters","mode"],r);const s=g(t,["maxPredictions"]);e!==void 0&&s!=null&&_(e,["parameters","maxPredictions"],s);const a=g(t,["confidenceThreshold"]);e!==void 0&&a!=null&&_(e,["parameters","confidenceThreshold"],a);const o=g(t,["maskDilation"]);e!==void 0&&o!=null&&_(e,["parameters","maskDilation"],o);const u=g(t,["binaryColorThreshold"]);e!==void 0&&u!=null&&_(e,["parameters","binaryColorThreshold"],u);const d=g(t,["labels"]);return e!==void 0&&d!=null&&_(e,["labels"],d),n}function n3(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["source"]);s!=null&&s3(s,n);const a=g(e,["config"]);return a!=null&&t3(a,n),n}function r3(t){const e={},n=g(t,["predictions"]);if(n!=null){let r=n;Array.isArray(r)&&(r=r.map(s=>N4(s))),_(e,["generatedMasks"],r)}return e}function s3(t,e){const n={},r=g(t,["prompt"]);e!==void 0&&r!=null&&_(e,["instances[0]","prompt"],r);const s=g(t,["image"]);e!==void 0&&s!=null&&_(e,["instances[0]","image"],zr(s));const a=g(t,["scribbleImage"]);return e!==void 0&&a!=null&&_(e,["instances[0]","scribble"],e3(a)),n}function dN(t){const e={},n=g(t,["languageCode"]);n!=null&&_(e,["languageCode"],n);const r=g(t,["voiceConfig"]);if(r!=null&&_(e,["voiceConfig"],r),g(t,["multiSpeakerVoiceConfig"])!==void 0)throw new Error("multiSpeakerVoiceConfig parameter is not supported in Vertex AI.");return e}function a3(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let p=n;Array.isArray(p)&&(p=p.map(m=>m)),_(e,["functionDeclarations"],p)}if(g(t,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const r=g(t,["googleSearchRetrieval"]);r!=null&&_(e,["googleSearchRetrieval"],r);const s=g(t,["computerUse"]);s!=null&&_(e,["computerUse"],s);const a=g(t,["fileSearch"]);a!=null&&_(e,["fileSearch"],a);const o=g(t,["codeExecution"]);if(o!=null&&_(e,["codeExecution"],o),g(t,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const u=g(t,["googleMaps"]);u!=null&&_(e,["googleMaps"],L4(u));const d=g(t,["googleSearch"]);d!=null&&_(e,["googleSearch"],$4(d));const c=g(t,["urlContext"]);return c!=null&&_(e,["urlContext"],c),e}function fN(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let m=n;Array.isArray(m)&&(m=m.map(y=>c4(y))),_(e,["functionDeclarations"],m)}const r=g(t,["retrieval"]);r!=null&&_(e,["retrieval"],r);const s=g(t,["googleSearchRetrieval"]);s!=null&&_(e,["googleSearchRetrieval"],s);const a=g(t,["computerUse"]);if(a!=null&&_(e,["computerUse"],a),g(t,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");const o=g(t,["codeExecution"]);o!=null&&_(e,["codeExecution"],o);const u=g(t,["enterpriseWebSearch"]);u!=null&&_(e,["enterpriseWebSearch"],u);const d=g(t,["googleMaps"]);d!=null&&_(e,["googleMaps"],d);const c=g(t,["googleSearch"]);c!=null&&_(e,["googleSearch"],c);const p=g(t,["urlContext"]);return p!=null&&_(e,["urlContext"],p),e}function i3(t){const e={},n=g(t,["baseModel"]);n!=null&&_(e,["baseModel"],n);const r=g(t,["createTime"]);r!=null&&_(e,["createTime"],r);const s=g(t,["updateTime"]);return s!=null&&_(e,["updateTime"],s),e}function o3(t){const e={},n=g(t,["labels","google-vertex-llm-tuning-base-model-id"]);n!=null&&_(e,["baseModel"],n);const r=g(t,["createTime"]);r!=null&&_(e,["createTime"],r);const s=g(t,["updateTime"]);return s!=null&&_(e,["updateTime"],s),e}function l3(t,e){const n={},r=g(t,["displayName"]);e!==void 0&&r!=null&&_(e,["displayName"],r);const s=g(t,["description"]);e!==void 0&&s!=null&&_(e,["description"],s);const a=g(t,["defaultCheckpointId"]);return e!==void 0&&a!=null&&_(e,["defaultCheckpointId"],a),n}function u3(t,e){const n={},r=g(t,["displayName"]);e!==void 0&&r!=null&&_(e,["displayName"],r);const s=g(t,["description"]);e!==void 0&&s!=null&&_(e,["description"],s);const a=g(t,["defaultCheckpointId"]);return e!==void 0&&a!=null&&_(e,["defaultCheckpointId"],a),n}function c3(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","name"],ht(t,r));const s=g(e,["config"]);return s!=null&&l3(s,n),n}function d3(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["config"]);return s!=null&&u3(s,n),n}function f3(t,e){const n={},r=g(t,["outputGcsUri"]);e!==void 0&&r!=null&&_(e,["parameters","storageUri"],r);const s=g(t,["safetyFilterLevel"]);e!==void 0&&s!=null&&_(e,["parameters","safetySetting"],s);const a=g(t,["personGeneration"]);e!==void 0&&a!=null&&_(e,["parameters","personGeneration"],a);const o=g(t,["includeRaiReason"]);e!==void 0&&o!=null&&_(e,["parameters","includeRaiReason"],o);const u=g(t,["outputMimeType"]);e!==void 0&&u!=null&&_(e,["parameters","outputOptions","mimeType"],u);const d=g(t,["outputCompressionQuality"]);e!==void 0&&d!=null&&_(e,["parameters","outputOptions","compressionQuality"],d);const c=g(t,["enhanceInputImage"]);e!==void 0&&c!=null&&_(e,["parameters","upscaleConfig","enhanceInputImage"],c);const p=g(t,["imagePreservationFactor"]);e!==void 0&&p!=null&&_(e,["parameters","upscaleConfig","imagePreservationFactor"],p);const m=g(t,["labels"]);e!==void 0&&m!=null&&_(e,["labels"],m);const y=g(t,["numberOfImages"]);e!==void 0&&y!=null&&_(e,["parameters","sampleCount"],y);const w=g(t,["mode"]);return e!==void 0&&w!=null&&_(e,["parameters","mode"],w),n}function p3(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["_url","model"],ht(t,r));const s=g(e,["image"]);s!=null&&_(n,["instances[0]","image"],zr(s));const a=g(e,["upscaleFactor"]);a!=null&&_(n,["parameters","upscaleConfig","upscaleFactor"],a);const o=g(e,["config"]);return o!=null&&f3(o,n),n}function h3(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["predictions"]);if(r!=null){let s=r;Array.isArray(s)&&(s=s.map(a=>ap(a))),_(e,["generatedImages"],s)}return e}function m3(t){const e={},n=g(t,["uri"]);n!=null&&_(e,["uri"],n);const r=g(t,["encodedVideo"]);r!=null&&_(e,["videoBytes"],Ha(r));const s=g(t,["encoding"]);return s!=null&&_(e,["mimeType"],s),e}function g3(t){const e={},n=g(t,["gcsUri"]);n!=null&&_(e,["uri"],n);const r=g(t,["bytesBase64Encoded"]);r!=null&&_(e,["videoBytes"],Ha(r));const s=g(t,["mimeType"]);return s!=null&&_(e,["mimeType"],s),e}function y3(t){const e={},n=g(t,["image"]);n!=null&&_(e,["_self"],zr(n));const r=g(t,["maskMode"]);return r!=null&&_(e,["maskMode"],r),e}function _3(t){const e={},n=g(t,["image"]);n!=null&&_(e,["image"],ip(n));const r=g(t,["referenceType"]);return r!=null&&_(e,["referenceType"],r),e}function v3(t){const e={},n=g(t,["image"]);n!=null&&_(e,["image"],zr(n));const r=g(t,["referenceType"]);return r!=null&&_(e,["referenceType"],r),e}function pN(t){const e={},n=g(t,["uri"]);n!=null&&_(e,["uri"],n);const r=g(t,["videoBytes"]);r!=null&&_(e,["encodedVideo"],Ha(r));const s=g(t,["mimeType"]);return s!=null&&_(e,["encoding"],s),e}function hN(t){const e={},n=g(t,["uri"]);n!=null&&_(e,["gcsUri"],n);const r=g(t,["videoBytes"]);r!=null&&_(e,["bytesBase64Encoded"],Ha(r));const s=g(t,["mimeType"]);return s!=null&&_(e,["mimeType"],s),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const w3="Content-Type",b3="X-Server-Timeout",S3="User-Agent",o_="x-goog-api-client",x3="1.29.0",T3=`google-genai-sdk/${x3}`,A3="v1beta1",E3="v1beta",IA=/^\s*data: (.*)(?:\n\n|\r\r|\r\n\r\n)/;class C3{constructor(e){var n,r;this.clientOptions=Object.assign(Object.assign({},e),{project:e.project,location:e.location,apiKey:e.apiKey,vertexai:e.vertexai});const s={};this.clientOptions.vertexai?(s.apiVersion=(n=this.clientOptions.apiVersion)!==null&&n!==void 0?n:A3,s.baseUrl=this.baseUrlFromProjectLocation(),this.normalizeAuthParameters()):(s.apiVersion=(r=this.clientOptions.apiVersion)!==null&&r!==void 0?r:E3,s.baseUrl="https://generativelanguage.googleapis.com/"),s.headers=this.getDefaultHeaders(),this.clientOptions.httpOptions=s,e.httpOptions&&(this.clientOptions.httpOptions=this.patchHttpOptions(s,e.httpOptions))}baseUrlFromProjectLocation(){return this.clientOptions.project&&this.clientOptions.location&&this.clientOptions.location!=="global"?`https://${this.clientOptions.location}-aiplatform.googleapis.com/`:"https://aiplatform.googleapis.com/"}normalizeAuthParameters(){if(this.clientOptions.project&&this.clientOptions.location){this.clientOptions.apiKey=void 0;return}this.clientOptions.project=void 0,this.clientOptions.location=void 0}isVertexAI(){var e;return(e=this.clientOptions.vertexai)!==null&&e!==void 0?e:!1}getProject(){return this.clientOptions.project}getLocation(){return this.clientOptions.location}getApiVersion(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.apiVersion!==void 0)return this.clientOptions.httpOptions.apiVersion;throw new Error("API version is not set.")}getBaseUrl(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.baseUrl!==void 0)return this.clientOptions.httpOptions.baseUrl;throw new Error("Base URL is not set.")}getRequestUrl(){return this.getRequestUrlInternal(this.clientOptions.httpOptions)}getHeaders(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.headers!==void 0)return this.clientOptions.httpOptions.headers;throw new Error("Headers are not set.")}getRequestUrlInternal(e){if(!e||e.baseUrl===void 0||e.apiVersion===void 0)throw new Error("HTTP options are not correctly set.");const r=[e.baseUrl.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl];return e.apiVersion&&e.apiVersion!==""&&r.push(e.apiVersion),r.join("/")}getBaseResourcePath(){return`projects/${this.clientOptions.project}/locations/${this.clientOptions.location}`}getApiKey(){return this.clientOptions.apiKey}getWebsocketBaseUrl(){const e=this.getBaseUrl(),n=new URL(e);return n.protocol=n.protocol=="http:"?"ws":"wss",n.toString()}setBaseUrl(e){if(this.clientOptions.httpOptions)this.clientOptions.httpOptions.baseUrl=e;else throw new Error("HTTP options are not correctly set.")}constructUrl(e,n,r){const s=[this.getRequestUrlInternal(n)];return r&&s.push(this.getBaseResourcePath()),e!==""&&s.push(e),new URL(`${s.join("/")}`)}shouldPrependVertexProjectPath(e){return!(this.clientOptions.apiKey||!this.clientOptions.vertexai||e.path.startsWith("projects/")||e.httpMethod==="GET"&&e.path.startsWith("publishers/google/models"))}async request(e){let n=this.clientOptions.httpOptions;e.httpOptions&&(n=this.patchHttpOptions(this.clientOptions.httpOptions,e.httpOptions));const r=this.shouldPrependVertexProjectPath(e),s=this.constructUrl(e.path,n,r);if(e.queryParams)for(const[o,u]of Object.entries(e.queryParams))s.searchParams.append(o,String(u));let a={};if(e.httpMethod==="GET"){if(e.body&&e.body!=="{}")throw new Error("Request body should be empty for GET request, but got non empty request body")}else a.body=e.body;return a=await this.includeExtraHttpOptionsToRequestInit(a,n,s.toString(),e.abortSignal),this.unaryApiCall(s,a,e.httpMethod)}patchHttpOptions(e,n){const r=JSON.parse(JSON.stringify(e));for(const[s,a]of Object.entries(n))typeof a=="object"?r[s]=Object.assign(Object.assign({},r[s]),a):a!==void 0&&(r[s]=a);return r}async requestStream(e){let n=this.clientOptions.httpOptions;e.httpOptions&&(n=this.patchHttpOptions(this.clientOptions.httpOptions,e.httpOptions));const r=this.shouldPrependVertexProjectPath(e),s=this.constructUrl(e.path,n,r);(!s.searchParams.has("alt")||s.searchParams.get("alt")!=="sse")&&s.searchParams.set("alt","sse");let a={};return a.body=e.body,a=await this.includeExtraHttpOptionsToRequestInit(a,n,s.toString(),e.abortSignal),this.streamApiCall(s,a,e.httpMethod)}async includeExtraHttpOptionsToRequestInit(e,n,r,s){if(n&&n.timeout||s){const a=new AbortController,o=a.signal;if(n.timeout&&(n==null?void 0:n.timeout)>0){const u=setTimeout(()=>a.abort(),n.timeout);u&&typeof u.unref=="function"&&u.unref()}s&&s.addEventListener("abort",()=>{a.abort()}),e.signal=o}return n&&n.extraBody!==null&&I3(e,n.extraBody),e.headers=await this.getHeadersInternal(n,r),e}async unaryApiCall(e,n,r){return this.apiCall(e.toString(),Object.assign(Object.assign({},n),{method:r})).then(async s=>(await RA(s),new n_(s))).catch(s=>{throw s instanceof Error?s:new Error(JSON.stringify(s))})}async streamApiCall(e,n,r){return this.apiCall(e.toString(),Object.assign(Object.assign({},n),{method:r})).then(async s=>(await RA(s),this.processStreamResponse(s))).catch(s=>{throw s instanceof Error?s:new Error(JSON.stringify(s))})}processStreamResponse(e){var n;return Ho(this,arguments,function*(){const s=(n=e==null?void 0:e.body)===null||n===void 0?void 0:n.getReader(),a=new TextDecoder("utf-8");if(!s)throw new Error("Response body is empty");try{let o="";for(;;){const{done:u,value:d}=yield kt(s.read());if(u){if(o.trim().length>0)throw new Error("Incomplete JSON segment at the end");break}const c=a.decode(d,{stream:!0});try{const m=JSON.parse(c);if("error"in m){const y=JSON.parse(JSON.stringify(m.error)),w=y.status,x=y.code,A=`got status: ${w}. ${JSON.stringify(m)}`;if(x>=400&&x<600)throw new rp({message:A,status:x})}}catch(m){if(m.name==="ApiError")throw m}o+=c;let p=o.match(IA);for(;p;){const m=p[1];try{const y=new Response(m,{headers:e==null?void 0:e.headers,status:e==null?void 0:e.status,statusText:e==null?void 0:e.statusText});yield yield kt(new n_(y)),o=o.slice(p[0].length),p=o.match(IA)}catch(y){throw new Error(`exception parsing stream chunk ${m}. ${y}`)}}}}finally{s.releaseLock()}})}async apiCall(e,n){return fetch(e,n).catch(r=>{throw new Error(`exception ${r} sending request`)})}getDefaultHeaders(){const e={},n=T3+" "+this.clientOptions.userAgentExtra;return e[S3]=n,e[o_]=n,e[w3]="application/json",e}async getHeadersInternal(e,n){const r=new Headers;if(e&&e.headers){for(const[s,a]of Object.entries(e.headers))r.append(s,a);e.timeout&&e.timeout>0&&r.append(b3,String(Math.ceil(e.timeout/1e3)))}return await this.clientOptions.auth.addAuthHeaders(r,n),r}getFileName(e){var n;let r="";return typeof e=="string"&&(r=e.replace(/[/\\]+$/,""),r=(n=r.split(/[/\\]/).pop())!==null&&n!==void 0?n:""),r}async uploadFile(e,n){var r;const s={};n!=null&&(s.mimeType=n.mimeType,s.name=n.name,s.displayName=n.displayName),s.name&&!s.name.startsWith("files/")&&(s.name=`files/${s.name}`);const a=this.clientOptions.uploader,o=await a.stat(e);s.sizeBytes=String(o.size);const u=(r=n==null?void 0:n.mimeType)!==null&&r!==void 0?r:o.type;if(u===void 0||u==="")throw new Error("Can not determine mimeType. Please provide mimeType in the config.");s.mimeType=u;const d={file:s},c=this.getFileName(e),p=we("upload/v1beta/files",d._url),m=await this.fetchUploadUrl(p,s.sizeBytes,s.mimeType,c,d,n==null?void 0:n.httpOptions);return a.upload(e,m,this)}async uploadFileToFileSearchStore(e,n,r){var s;const a=this.clientOptions.uploader,o=await a.stat(n),u=String(o.size),d=(s=r==null?void 0:r.mimeType)!==null&&s!==void 0?s:o.type;if(d===void 0||d==="")throw new Error("Can not determine mimeType. Please provide mimeType in the config.");const c=`upload/v1beta/${e}:uploadToFileSearchStore`,p=this.getFileName(n),m={};r!=null&&r.customMetadata&&(m.customMetadata=r.customMetadata),r!=null&&r.chunkingConfig&&(m.chunkingConfig=r.chunkingConfig);const y=await this.fetchUploadUrl(c,u,d,p,m,r==null?void 0:r.httpOptions);return a.uploadToFileSearchStore(n,y,this)}async downloadFile(e){await this.clientOptions.downloader.download(e,this)}async fetchUploadUrl(e,n,r,s,a,o){var u;let d={};o?d=o:d={apiVersion:"",headers:Object.assign({"Content-Type":"application/json","X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":`${n}`,"X-Goog-Upload-Header-Content-Type":`${r}`},s?{"X-Goog-Upload-File-Name":s}:{})};const c=await this.request({path:e,body:JSON.stringify(a),httpMethod:"POST",httpOptions:d});if(!c||!(c!=null&&c.headers))throw new Error("Server did not return an HttpResponse or the returned HttpResponse did not have headers.");const p=(u=c==null?void 0:c.headers)===null||u===void 0?void 0:u["x-goog-upload-url"];if(p===void 0)throw new Error("Failed to get upload url. Server did not return the x-google-upload-url in the headers");return p}}async function RA(t){var e;if(t===void 0)throw new Error("response is undefined");if(!t.ok){const n=t.status;let r;!((e=t.headers.get("content-type"))===null||e===void 0)&&e.includes("application/json")?r=await t.json():r={error:{message:await t.text(),code:t.status,status:t.statusText}};const s=JSON.stringify(r);throw n>=400&&n<600?new rp({message:s,status:n}):new Error(s)}}function I3(t,e){if(!e||Object.keys(e).length===0)return;if(t.body instanceof Blob){console.warn("includeExtraBodyToRequestInit: extraBody provided but current request body is a Blob. extraBody will be ignored as merging is not supported for Blob bodies.");return}let n={};if(typeof t.body=="string"&&t.body.length>0)try{const a=JSON.parse(t.body);if(typeof a=="object"&&a!==null&&!Array.isArray(a))n=a;else{console.warn("includeExtraBodyToRequestInit: Original request body is valid JSON but not a non-array object. Skip applying extraBody to the request body.");return}}catch{console.warn("includeExtraBodyToRequestInit: Original request body is not valid JSON. Skip applying extraBody to the request body.");return}function r(a,o){const u=Object.assign({},a);for(const d in o)if(Object.prototype.hasOwnProperty.call(o,d)){const c=o[d],p=u[d];c&&typeof c=="object"&&!Array.isArray(c)&&p&&typeof p=="object"&&!Array.isArray(p)?u[d]=r(p,c):(p&&c&&typeof p!=typeof c&&console.warn(`includeExtraBodyToRequestInit:deepMerge: Type mismatch for key "${d}". Original type: ${typeof p}, New type: ${typeof c}. Overwriting.`),u[d]=c)}return u}const s=r(n,e);t.body=JSON.stringify(s)}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const R3="mcp_used/unknown";let N3=!1;function mN(t){for(const e of t)if(P3(e)||typeof e=="object"&&"inputSchema"in e)return!0;return N3}function gN(t){var e;const n=(e=t[o_])!==null&&e!==void 0?e:"";t[o_]=(n+` ${R3}`).trimStart()}function P3(t){return t!==null&&typeof t=="object"&&t instanceof S0}function M3(t,e=100){return Ho(this,arguments,function*(){let r,s=0;for(;s<e;){const a=yield kt(t.listTools({cursor:r}));for(const o of a.tools)yield yield kt(o),s++;if(!a.nextCursor)break;r=a.nextCursor}})}class S0{constructor(e=[],n){this.mcpTools=[],this.functionNameToMcpClient={},this.mcpClients=e,this.config=n}static create(e,n){return new S0(e,n)}async initialize(){var e,n,r,s;if(this.mcpTools.length>0)return;const a={},o=[];for(const p of this.mcpClients)try{for(var u=!0,d=(n=void 0,Eu(M3(p))),c;c=await d.next(),e=c.done,!e;u=!0){s=c.value,u=!1;const m=s;o.push(m);const y=m.name;if(a[y])throw new Error(`Duplicate function name ${y} found in MCP tools. Please ensure function names are unique.`);a[y]=p}}catch(m){n={error:m}}finally{try{!u&&!e&&(r=d.return)&&await r.call(d)}finally{if(n)throw n.error}}this.mcpTools=o,this.functionNameToMcpClient=a}async tool(){return await this.initialize(),$$(this.mcpTools,this.config)}async callTool(e){await this.initialize();const n=[];for(const r of e)if(r.name in this.functionNameToMcpClient){const s=this.functionNameToMcpClient[r.name];let a;this.config.timeout&&(a={timeout:this.config.timeout});const o=await s.callTool({name:r.name,arguments:r.args},void 0,a);n.push({functionResponse:{name:r.name,response:o.isError?{error:o}:o}})}return n}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */async function k3(t,e,n){const r=new R$;let s;n.data instanceof Blob?s=JSON.parse(await n.data.text()):s=JSON.parse(n.data),Object.assign(r,s),e(r)}class O3{constructor(e,n,r){this.apiClient=e,this.auth=n,this.webSocketFactory=r}async connect(e){var n,r;if(this.apiClient.isVertexAI())throw new Error("Live music is not supported for Vertex AI.");console.warn("Live music generation is experimental and may change in future versions.");const s=this.apiClient.getWebsocketBaseUrl(),a=this.apiClient.getApiVersion(),o=$3(this.apiClient.getDefaultHeaders()),u=this.apiClient.getApiKey(),d=`${s}/ws/google.ai.generativelanguage.${a}.GenerativeService.BidiGenerateMusic?key=${u}`;let c=()=>{};const p=new Promise(O=>{c=O}),m=e.callbacks,y=function(){c({})},w=this.apiClient,x={onopen:y,onmessage:O=>{k3(w,m.onmessage,O)},onerror:(n=m==null?void 0:m.onerror)!==null&&n!==void 0?n:function(O){},onclose:(r=m==null?void 0:m.onclose)!==null&&r!==void 0?r:function(O){}},A=this.webSocketFactory.create(d,L3(o),x);A.connect(),await p;const D={setup:{model:ht(this.apiClient,e.model)}};return A.send(JSON.stringify(D)),new D3(A,this.apiClient)}}class D3{constructor(e,n){this.conn=e,this.apiClient=n}async setWeightedPrompts(e){if(!e.weightedPrompts||Object.keys(e.weightedPrompts).length===0)throw new Error("Weighted prompts must be set and contain at least one entry.");const n=EU(e);this.conn.send(JSON.stringify({clientContent:n}))}async setMusicGenerationConfig(e){e.musicGenerationConfig||(e.musicGenerationConfig={});const n=AU(e);this.conn.send(JSON.stringify(n))}sendPlaybackControl(e){const n={playbackControl:e};this.conn.send(JSON.stringify(n))}play(){this.sendPlaybackControl(Do.PLAY)}pause(){this.sendPlaybackControl(Do.PAUSE)}stop(){this.sendPlaybackControl(Do.STOP)}resetContext(){this.sendPlaybackControl(Do.RESET_CONTEXT)}close(){this.conn.close()}}function L3(t){const e={};return t.forEach((n,r)=>{e[r]=n}),e}function $3(t){const e=new Headers;for(const[n,r]of Object.entries(t))e.append(n,r);return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const U3="FunctionResponse request must have an `id` field from the response of a ToolCall.FunctionalCalls in Google AI.";async function F3(t,e,n){const r=new I$;let s;n.data instanceof Blob?s=await n.data.text():n.data instanceof ArrayBuffer?s=new TextDecoder().decode(n.data):s=n.data;const a=JSON.parse(s);if(t.isVertexAI()){const o=RU(a);Object.assign(r,o)}else Object.assign(r,a);e(r)}class B3{constructor(e,n,r){this.apiClient=e,this.auth=n,this.webSocketFactory=r,this.music=new O3(this.apiClient,this.auth,this.webSocketFactory)}async connect(e){var n,r,s,a,o,u;if(e.config&&e.config.httpOptions)throw new Error("The Live module does not support httpOptions at request-level in LiveConnectConfig yet. Please use the client-level httpOptions configuration instead.");const d=this.apiClient.getWebsocketBaseUrl(),c=this.apiClient.getApiVersion();let p;const m=this.apiClient.getHeaders();e.config&&e.config.tools&&mN(e.config.tools)&&gN(m);const y=z3(m);if(this.apiClient.isVertexAI())p=`${d}/ws/google.cloud.aiplatform.${c}.LlmBidiService/BidiGenerateContent`,await this.auth.addAuthHeaders(y,p);else{const k=this.apiClient.getApiKey();let $="BidiGenerateContent",U="key";k!=null&&k.startsWith("auth_tokens/")&&(console.warn("Warning: Ephemeral token support is experimental and may change in future versions."),c!=="v1alpha"&&console.warn("Warning: The SDK's ephemeral token support is in v1alpha only. Please use const ai = new GoogleGenAI({apiKey: token.name, httpOptions: { apiVersion: 'v1alpha' }}); before session connection."),$="BidiGenerateContentConstrained",U="access_token"),p=`${d}/ws/google.ai.generativelanguage.${c}.GenerativeService.${$}?${U}=${k}`}let w=()=>{};const x=new Promise(k=>{w=k}),A=e.callbacks,E=function(){var k;(k=A==null?void 0:A.onopen)===null||k===void 0||k.call(A),w({})},C=this.apiClient,D={onopen:E,onmessage:k=>{F3(C,A.onmessage,k)},onerror:(n=A==null?void 0:A.onerror)!==null&&n!==void 0?n:function(k){},onclose:(r=A==null?void 0:A.onclose)!==null&&r!==void 0?r:function(k){}},O=this.webSocketFactory.create(p,H3(y),D);O.connect(),await x;let T=ht(this.apiClient,e.model);if(this.apiClient.isVertexAI()&&T.startsWith("publishers/")){const k=this.apiClient.getProject(),$=this.apiClient.getLocation();T=`projects/${k}/locations/${$}/`+T}let I={};this.apiClient.isVertexAI()&&((s=e.config)===null||s===void 0?void 0:s.responseModalities)===void 0&&(e.config===void 0?e.config={responseModalities:[Ef.AUDIO]}:e.config.responseModalities=[Ef.AUDIO]),!((a=e.config)===null||a===void 0)&&a.generationConfig&&console.warn("Setting `LiveConnectConfig.generation_config` is deprecated, please set the fields on `LiveConnectConfig` directly. This will become an error in a future version (not before Q3 2025).");const M=(u=(o=e.config)===null||o===void 0?void 0:o.tools)!==null&&u!==void 0?u:[],N=[];for(const k of M)if(this.isCallableTool(k)){const $=k;N.push(await $.tool())}else N.push(k);N.length>0&&(e.config.tools=N);const P={model:T,config:e.config,callbacks:e.callbacks};return this.apiClient.isVertexAI()?I=TU(this.apiClient,P):I=xU(this.apiClient,P),delete I.config,O.send(JSON.stringify(I)),new G3(O,this.apiClient)}isCallableTool(e){return"callTool"in e&&typeof e.callTool=="function"}}const q3={turnComplete:!0};class G3{constructor(e,n){this.conn=e,this.apiClient=n}tLiveClientContent(e,n){if(n.turns!==null&&n.turns!==void 0){let r=[];try{r=xr(n.turns),e.isVertexAI()||(r=r.map(s=>sp(s)))}catch{throw new Error(`Failed to parse client content "turns", type: '${typeof n.turns}'`)}return{clientContent:{turns:r,turnComplete:n.turnComplete}}}return{clientContent:{turnComplete:n.turnComplete}}}tLiveClienttToolResponse(e,n){let r=[];if(n.functionResponses==null)throw new Error("functionResponses is required.");if(Array.isArray(n.functionResponses)?r=n.functionResponses:r=[n.functionResponses],r.length===0)throw new Error("functionResponses is required.");for(const a of r){if(typeof a!="object"||a===null||!("name"in a)||!("response"in a))throw new Error(`Could not parse function response, type '${typeof a}'.`);if(!e.isVertexAI()&&!("id"in a))throw new Error(U3)}return{toolResponse:{functionResponses:r}}}sendClientContent(e){e=Object.assign(Object.assign({},q3),e);const n=this.tLiveClientContent(this.apiClient,e);this.conn.send(JSON.stringify(n))}sendRealtimeInput(e){let n={};this.apiClient.isVertexAI()?n={realtimeInput:IU(e)}:n={realtimeInput:CU(e)},this.conn.send(JSON.stringify(n))}sendToolResponse(e){if(e.functionResponses==null)throw new Error("Tool response parameters are required.");const n=this.tLiveClienttToolResponse(this.apiClient,e);this.conn.send(JSON.stringify(n))}close(){this.conn.close()}}function H3(t){const e={};return t.forEach((n,r)=>{e[r]=n}),e}function z3(t){const e=new Headers;for(const[n,r]of Object.entries(t))e.append(n,r);return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const NA=10;function PA(t){var e,n,r;if(!((e=t==null?void 0:t.automaticFunctionCalling)===null||e===void 0)&&e.disable)return!0;let s=!1;for(const o of(n=t==null?void 0:t.tools)!==null&&n!==void 0?n:[])if(zo(o)){s=!0;break}if(!s)return!0;const a=(r=t==null?void 0:t.automaticFunctionCalling)===null||r===void 0?void 0:r.maximumRemoteCalls;return a&&(a<0||!Number.isInteger(a))||a==0?(console.warn("Invalid maximumRemoteCalls value provided for automatic function calling. Disabled automatic function calling. Please provide a valid integer value greater than 0. maximumRemoteCalls provided:",a),!0):!1}function zo(t){return"callTool"in t&&typeof t.callTool=="function"}function j3(t){var e,n,r;return(r=(n=(e=t.config)===null||e===void 0?void 0:e.tools)===null||n===void 0?void 0:n.some(s=>zo(s)))!==null&&r!==void 0?r:!1}function MA(t){var e;const n=[];return!((e=t==null?void 0:t.config)===null||e===void 0)&&e.tools&&t.config.tools.forEach((r,s)=>{if(zo(r))return;const a=r;a.functionDeclarations&&a.functionDeclarations.length>0&&n.push(s)}),n}function kA(t){var e;return!(!((e=t==null?void 0:t.automaticFunctionCalling)===null||e===void 0)&&e.ignoreCallHistory)}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let V3=class extends Vs{constructor(e){super(),this.apiClient=e,this.generateContent=async n=>{var r,s,a,o,u;const d=await this.processParamsMaybeAddMcpUsage(n);if(this.maybeMoveToResponseJsonSchem(n),!j3(n)||PA(n.config))return await this.generateContentInternal(d);const c=MA(n);if(c.length>0){const A=c.map(E=>`tools[${E}]`).join(", ");throw new Error(`Automatic function calling with CallableTools (or MCP objects) and basic FunctionDeclarations is not yet supported. Incompatible tools found at ${A}.`)}let p,m;const y=xr(d.contents),w=(a=(s=(r=d.config)===null||r===void 0?void 0:r.automaticFunctionCalling)===null||s===void 0?void 0:s.maximumRemoteCalls)!==null&&a!==void 0?a:NA;let x=0;for(;x<w&&(p=await this.generateContentInternal(d),!(!p.functionCalls||p.functionCalls.length===0));){const A=p.candidates[0].content,E=[];for(const C of(u=(o=n.config)===null||o===void 0?void 0:o.tools)!==null&&u!==void 0?u:[])if(zo(C)){const O=await C.callTool(p.functionCalls);E.push(...O)}x++,m={role:"user",parts:E},d.contents=xr(d.contents),d.contents.push(A),d.contents.push(m),kA(d.config)&&(y.push(A),y.push(m))}return kA(d.config)&&(p.automaticFunctionCallingHistory=y),p},this.generateContentStream=async n=>{if(this.maybeMoveToResponseJsonSchem(n),PA(n.config)){const s=await this.processParamsMaybeAddMcpUsage(n);return await this.generateContentStreamInternal(s)}const r=MA(n);if(r.length>0){const s=r.map(a=>`tools[${a}]`).join(", ");throw new Error(`Incompatible tools found at ${s}. Automatic function calling with CallableTools (or MCP objects) and basic FunctionDeclarations" is not yet supported.`)}return await this.processAfcStream(n)},this.generateImages=async n=>await this.generateImagesInternal(n).then(r=>{var s;let a;const o=[];if(r!=null&&r.generatedImages)for(const d of r.generatedImages)d&&(d!=null&&d.safetyAttributes)&&((s=d==null?void 0:d.safetyAttributes)===null||s===void 0?void 0:s.contentType)==="Positive Prompt"?a=d==null?void 0:d.safetyAttributes:o.push(d);let u;return a?u={generatedImages:o,positivePromptSafetyAttributes:a,sdkHttpResponse:r.sdkHttpResponse}:u={generatedImages:o,sdkHttpResponse:r.sdkHttpResponse},u}),this.list=async n=>{var r;const o={config:Object.assign(Object.assign({},{queryBase:!0}),n==null?void 0:n.config)};if(this.apiClient.isVertexAI()&&!o.config.queryBase){if(!((r=o.config)===null||r===void 0)&&r.filter)throw new Error("Filtering tuned models list for Vertex AI is not currently supported");o.config.filter="labels.tune-type:*"}return new Ui(zs.PAGED_ITEM_MODELS,u=>this.listInternal(u),await this.listInternal(o),o)},this.editImage=async n=>{const r={model:n.model,prompt:n.prompt,referenceImages:[],config:n.config};return n.referenceImages&&n.referenceImages&&(r.referenceImages=n.referenceImages.map(s=>s.toReferenceImageAPI())),await this.editImageInternal(r)},this.upscaleImage=async n=>{let r={numberOfImages:1,mode:"upscale"};n.config&&(r=Object.assign(Object.assign({},r),n.config));const s={model:n.model,image:n.image,upscaleFactor:n.upscaleFactor,config:r};return await this.upscaleImageInternal(s)},this.generateVideos=async n=>{var r,s,a,o,u,d;if((n.prompt||n.image||n.video)&&n.source)throw new Error("Source and prompt/image/video are mutually exclusive. Please only use source.");return this.apiClient.isVertexAI()||(!((r=n.video)===null||r===void 0)&&r.uri&&(!((s=n.video)===null||s===void 0)&&s.videoBytes)?n.video={uri:n.video.uri,mimeType:n.video.mimeType}:!((o=(a=n.source)===null||a===void 0?void 0:a.video)===null||o===void 0)&&o.uri&&(!((d=(u=n.source)===null||u===void 0?void 0:u.video)===null||d===void 0)&&d.videoBytes)&&(n.source.video={uri:n.source.video.uri,mimeType:n.source.video.mimeType})),await this.generateVideosInternal(n)}}maybeMoveToResponseJsonSchem(e){e.config&&e.config.responseSchema&&(e.config.responseJsonSchema||Object.keys(e.config.responseSchema).includes("$schema")&&(e.config.responseJsonSchema=e.config.responseSchema,delete e.config.responseSchema))}async processParamsMaybeAddMcpUsage(e){var n,r,s;const a=(n=e.config)===null||n===void 0?void 0:n.tools;if(!a)return e;const o=await Promise.all(a.map(async d=>zo(d)?await d.tool():d)),u={model:e.model,contents:e.contents,config:Object.assign(Object.assign({},e.config),{tools:o})};if(u.config.tools=o,e.config&&e.config.tools&&mN(e.config.tools)){const d=(s=(r=e.config.httpOptions)===null||r===void 0?void 0:r.headers)!==null&&s!==void 0?s:{};let c=Object.assign({},d);Object.keys(c).length===0&&(c=this.apiClient.getDefaultHeaders()),gN(c),u.config.httpOptions=Object.assign(Object.assign({},e.config.httpOptions),{headers:c})}return u}async initAfcToolsMap(e){var n,r,s;const a=new Map;for(const o of(r=(n=e.config)===null||n===void 0?void 0:n.tools)!==null&&r!==void 0?r:[])if(zo(o)){const u=o,d=await u.tool();for(const c of(s=d.functionDeclarations)!==null&&s!==void 0?s:[]){if(!c.name)throw new Error("Function declaration name is required.");if(a.has(c.name))throw new Error(`Duplicate tool declaration name: ${c.name}`);a.set(c.name,u)}}return a}async processAfcStream(e){var n,r,s;const a=(s=(r=(n=e.config)===null||n===void 0?void 0:n.automaticFunctionCalling)===null||r===void 0?void 0:r.maximumRemoteCalls)!==null&&s!==void 0?s:NA;let o=!1,u=0;const d=await this.initAfcToolsMap(e);return(function(c,p,m){var y,w;return Ho(this,arguments,function*(){for(var x,A,E,C;u<a;){o&&(u++,o=!1);const I=yield kt(c.processParamsMaybeAddMcpUsage(m)),M=yield kt(c.generateContentStreamInternal(I)),N=[],P=[];try{for(var D=!0,O=(A=void 0,Eu(M)),T;T=yield kt(O.next()),x=T.done,!x;D=!0){C=T.value,D=!1;const k=C;if(yield yield kt(k),k.candidates&&(!((y=k.candidates[0])===null||y===void 0)&&y.content)){P.push(k.candidates[0].content);for(const $ of(w=k.candidates[0].content.parts)!==null&&w!==void 0?w:[])if(u<a&&$.functionCall){if(!$.functionCall.name)throw new Error("Function call name was not returned by the model.");if(p.has($.functionCall.name)){const U=yield kt(p.get($.functionCall.name).callTool([$.functionCall]));N.push(...U)}else throw new Error(`Automatic function calling was requested, but not all the tools the model used implement the CallableTool interface. Available tools: ${p.keys()}, mising tool: ${$.functionCall.name}`)}}}}catch(k){A={error:k}}finally{try{!D&&!x&&(E=O.return)&&(yield kt(E.call(O)))}finally{if(A)throw A.error}}if(N.length>0){o=!0;const k=new uu;k.candidates=[{content:{role:"user",parts:N}}],yield yield kt(k);const $=[];$.push(...P),$.push({role:"user",parts:N});const U=xr(m.contents).concat($);m.contents=U}else break}})})(this,d,e)}async generateContentInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=AA(this.apiClient,e);return u=we("{model}:generateContent",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=CA(p),y=new uu;return Object.assign(y,m),y})}else{const c=TA(this.apiClient,e);return u=we("{model}:generateContent",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=EA(p),y=new uu;return Object.assign(y,m),y})}}async generateContentStreamInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=AA(this.apiClient,e);return u=we("{model}:streamGenerateContent?alt=sse",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.requestStream({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}),o.then(function(m){return Ho(this,arguments,function*(){var y,w,x,A;try{for(var E=!0,C=Eu(m),D;D=yield kt(C.next()),y=D.done,!y;E=!0){A=D.value,E=!1;const O=A,T=CA(yield kt(O.json()));T.sdkHttpResponse={headers:O.headers};const I=new uu;Object.assign(I,T),yield yield kt(I)}}catch(O){w={error:O}}finally{try{!E&&!y&&(x=C.return)&&(yield kt(x.call(C)))}finally{if(w)throw w.error}}})})}else{const c=TA(this.apiClient,e);return u=we("{model}:streamGenerateContent?alt=sse",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.requestStream({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}),o.then(function(m){return Ho(this,arguments,function*(){var y,w,x,A;try{for(var E=!0,C=Eu(m),D;D=yield kt(C.next()),y=D.done,!y;E=!0){A=D.value,E=!1;const O=A,T=EA(yield kt(O.json()));T.sdkHttpResponse={headers:O.headers};const I=new uu;Object.assign(I,T),yield yield kt(I)}}catch(O){w={error:O}}finally{try{!E&&!y&&(x=C.return)&&(yield kt(x.call(C)))}finally{if(w)throw w.error}}})})}}async embedContent(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=a4(this.apiClient,e);return u=we("{model}:predict",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=o4(p),y=new lA;return Object.assign(y,m),y})}else{const c=s4(this.apiClient,e);return u=we("{model}:batchEmbedContents",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=i4(p),y=new lA;return Object.assign(y,m),y})}}async generateImagesInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=g4(this.apiClient,e);return u=we("{model}:predict",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=_4(p),y=new uA;return Object.assign(y,m),y})}else{const c=m4(this.apiClient,e);return u=we("{model}:predict",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=y4(p),y=new uA;return Object.assign(y,m),y})}}async editImageInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI()){const u=e4(this.apiClient,e);return a=we("{model}:predict",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(c=>{const p=c;return p.sdkHttpResponse={headers:d.headers},p})),s.then(d=>{const c=t4(d),p=new y$;return Object.assign(p,c),p})}else throw new Error("This method is only supported by the Vertex AI.")}async upscaleImageInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI()){const u=p3(this.apiClient,e);return a=we("{model}:predict",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(c=>{const p=c;return p.sdkHttpResponse={headers:d.headers},p})),s.then(d=>{const c=h3(d),p=new _$;return Object.assign(p,c),p})}else throw new Error("This method is only supported by the Vertex AI.")}async recontextImage(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI()){const u=K4(this.apiClient,e);return a=we("{model}:predict",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>{const c=W4(d),p=new v$;return Object.assign(p,c),p})}else throw new Error("This method is only supported by the Vertex AI.")}async segmentImage(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI()){const u=n3(this.apiClient,e);return a=we("{model}:predict",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>{const c=r3(d),p=new w$;return Object.assign(p,c),p})}else throw new Error("This method is only supported by the Vertex AI.")}async get(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=D4(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>i_(p))}else{const c=O4(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>a_(p))}}async listInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=G4(this.apiClient,e);return u=we("{models_url}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=z4(p),y=new cA;return Object.assign(y,m),y})}else{const c=q4(this.apiClient,e);return u=we("{models_url}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=H4(p),y=new cA;return Object.assign(y,m),y})}}async update(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=d3(this.apiClient,e);return u=we("{model}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>i_(p))}else{const c=c3(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"PATCH",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>a_(p))}}async delete(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=WU(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=XU(p),y=new dA;return Object.assign(y,m),y})}else{const c=KU(this.apiClient,e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"DELETE",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=ZU(p),y=new dA;return Object.assign(y,m),y})}}async countTokens(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=VU(this.apiClient,e);return u=we("{model}:countTokens",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=YU(p),y=new fA;return Object.assign(y,m),y})}else{const c=jU(this.apiClient,e);return u=we("{model}:countTokens",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=JU(p),y=new fA;return Object.assign(y,m),y})}}async computeTokens(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI()){const u=UU(this.apiClient,e);return a=we("{model}:computeTokens",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(c=>{const p=c;return p.sdkHttpResponse={headers:d.headers},p})),s.then(d=>{const c=FU(d),p=new b$;return Object.assign(p,c),p})}else throw new Error("This method is only supported by the Vertex AI.")}async generateVideosInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=T4(this.apiClient,e);return u=we("{model}:predictLongRunning",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o.then(p=>{const m=S4(p),y=new Cf;return Object.assign(y,m),y})}else{const c=x4(this.apiClient,e);return u=we("{model}:predictLongRunning",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o.then(p=>{const m=b4(p),y=new Cf;return Object.assign(y,m),y})}}};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class J3 extends Vs{constructor(e){super(),this.apiClient=e}async getVideosOperation(e){const n=e.operation,r=e.config;if(n.name===void 0||n.name==="")throw new Error("Operation name is required.");if(this.apiClient.isVertexAI()){const s=n.name.split("/operations/")[0];let a;r&&"httpOptions"in r&&(a=r.httpOptions);const o=await this.fetchPredictVideosOperationInternal({operationName:n.name,resourceName:s,config:{httpOptions:a}});return n._fromAPIResponse({apiResponse:o,_isVertexAI:!0})}else{const s=await this.getVideosOperationInternal({operationName:n.name,config:r});return n._fromAPIResponse({apiResponse:s,_isVertexAI:!1})}}async get(e){const n=e.operation,r=e.config;if(n.name===void 0||n.name==="")throw new Error("Operation name is required.");if(this.apiClient.isVertexAI()){const s=n.name.split("/operations/")[0];let a;r&&"httpOptions"in r&&(a=r.httpOptions);const o=await this.fetchPredictVideosOperationInternal({operationName:n.name,resourceName:s,config:{httpOptions:a}});return n._fromAPIResponse({apiResponse:o,_isVertexAI:!0})}else{const s=await this.getVideosOperationInternal({operationName:n.name,config:r});return n._fromAPIResponse({apiResponse:s,_isVertexAI:!1})}}async getVideosOperationInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=d$(e);return u=we("{operationName}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json()),o}else{const c=c$(e);return u=we("{operationName}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json()),o}}async fetchPredictVideosOperationInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI()){const u=r$(e);return a=we("{resourceName}:fetchPredictOperation",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s}else throw new Error("This method is only supported by the Vertex AI.")}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Y3(t){const e={},n=g(t,["data"]);if(n!=null&&_(e,["data"],n),g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function K3(t){const e={},n=g(t,["parts"]);if(n!=null){let s=n;Array.isArray(s)&&(s=s.map(a=>rF(a))),_(e,["parts"],s)}const r=g(t,["role"]);return r!=null&&_(e,["role"],r),e}function W3(t,e,n){const r={},s=g(e,["expireTime"]);n!==void 0&&s!=null&&_(n,["expireTime"],s);const a=g(e,["newSessionExpireTime"]);n!==void 0&&a!=null&&_(n,["newSessionExpireTime"],a);const o=g(e,["uses"]);n!==void 0&&o!=null&&_(n,["uses"],o);const u=g(e,["liveConnectConstraints"]);n!==void 0&&u!=null&&_(n,["bidiGenerateContentSetup"],nF(t,u));const d=g(e,["lockAdditionalFields"]);return n!==void 0&&d!=null&&_(n,["fieldMask"],d),r}function Z3(t,e){const n={},r=g(e,["config"]);return r!=null&&_(n,["config"],W3(t,r,n)),n}function X3(t){const e={};if(g(t,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const n=g(t,["fileUri"]);n!=null&&_(e,["fileUri"],n);const r=g(t,["mimeType"]);return r!=null&&_(e,["mimeType"],r),e}function Q3(t){const e={};if(g(t,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const n=g(t,["enableWidget"]);return n!=null&&_(e,["enableWidget"],n),e}function eF(t){const e={};if(g(t,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(g(t,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const n=g(t,["timeRangeFilter"]);return n!=null&&_(e,["timeRangeFilter"],n),e}function tF(t,e){const n={},r=g(t,["generationConfig"]);e!==void 0&&r!=null&&_(e,["setup","generationConfig"],r);const s=g(t,["responseModalities"]);e!==void 0&&s!=null&&_(e,["setup","generationConfig","responseModalities"],s);const a=g(t,["temperature"]);e!==void 0&&a!=null&&_(e,["setup","generationConfig","temperature"],a);const o=g(t,["topP"]);e!==void 0&&o!=null&&_(e,["setup","generationConfig","topP"],o);const u=g(t,["topK"]);e!==void 0&&u!=null&&_(e,["setup","generationConfig","topK"],u);const d=g(t,["maxOutputTokens"]);e!==void 0&&d!=null&&_(e,["setup","generationConfig","maxOutputTokens"],d);const c=g(t,["mediaResolution"]);e!==void 0&&c!=null&&_(e,["setup","generationConfig","mediaResolution"],c);const p=g(t,["seed"]);e!==void 0&&p!=null&&_(e,["setup","generationConfig","seed"],p);const m=g(t,["speechConfig"]);e!==void 0&&m!=null&&_(e,["setup","generationConfig","speechConfig"],b0(m));const y=g(t,["thinkingConfig"]);e!==void 0&&y!=null&&_(e,["setup","generationConfig","thinkingConfig"],y);const w=g(t,["enableAffectiveDialog"]);e!==void 0&&w!=null&&_(e,["setup","generationConfig","enableAffectiveDialog"],w);const x=g(t,["systemInstruction"]);e!==void 0&&x!=null&&_(e,["setup","systemInstruction"],K3(In(x)));const A=g(t,["tools"]);if(e!==void 0&&A!=null){let M=il(A);Array.isArray(M)&&(M=M.map(N=>aF(al(N)))),_(e,["setup","tools"],M)}const E=g(t,["sessionResumption"]);e!==void 0&&E!=null&&_(e,["setup","sessionResumption"],sF(E));const C=g(t,["inputAudioTranscription"]);e!==void 0&&C!=null&&_(e,["setup","inputAudioTranscription"],C);const D=g(t,["outputAudioTranscription"]);e!==void 0&&D!=null&&_(e,["setup","outputAudioTranscription"],D);const O=g(t,["realtimeInputConfig"]);e!==void 0&&O!=null&&_(e,["setup","realtimeInputConfig"],O);const T=g(t,["contextWindowCompression"]);e!==void 0&&T!=null&&_(e,["setup","contextWindowCompression"],T);const I=g(t,["proactivity"]);return e!==void 0&&I!=null&&_(e,["setup","proactivity"],I),n}function nF(t,e){const n={},r=g(e,["model"]);r!=null&&_(n,["setup","model"],ht(t,r));const s=g(e,["config"]);return s!=null&&_(n,["config"],tF(s,n)),n}function rF(t){const e={},n=g(t,["functionCall"]);n!=null&&_(e,["functionCall"],n);const r=g(t,["codeExecutionResult"]);r!=null&&_(e,["codeExecutionResult"],r);const s=g(t,["executableCode"]);s!=null&&_(e,["executableCode"],s);const a=g(t,["fileData"]);a!=null&&_(e,["fileData"],X3(a));const o=g(t,["functionResponse"]);o!=null&&_(e,["functionResponse"],o);const u=g(t,["inlineData"]);u!=null&&_(e,["inlineData"],Y3(u));const d=g(t,["text"]);d!=null&&_(e,["text"],d);const c=g(t,["thought"]);c!=null&&_(e,["thought"],c);const p=g(t,["thoughtSignature"]);p!=null&&_(e,["thoughtSignature"],p);const m=g(t,["videoMetadata"]);return m!=null&&_(e,["videoMetadata"],m),e}function sF(t){const e={},n=g(t,["handle"]);if(n!=null&&_(e,["handle"],n),g(t,["transparent"])!==void 0)throw new Error("transparent parameter is not supported in Gemini API.");return e}function aF(t){const e={},n=g(t,["functionDeclarations"]);if(n!=null){let p=n;Array.isArray(p)&&(p=p.map(m=>m)),_(e,["functionDeclarations"],p)}if(g(t,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const r=g(t,["googleSearchRetrieval"]);r!=null&&_(e,["googleSearchRetrieval"],r);const s=g(t,["computerUse"]);s!=null&&_(e,["computerUse"],s);const a=g(t,["fileSearch"]);a!=null&&_(e,["fileSearch"],a);const o=g(t,["codeExecution"]);if(o!=null&&_(e,["codeExecution"],o),g(t,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const u=g(t,["googleMaps"]);u!=null&&_(e,["googleMaps"],Q3(u));const d=g(t,["googleSearch"]);d!=null&&_(e,["googleSearch"],eF(d));const c=g(t,["urlContext"]);return c!=null&&_(e,["urlContext"],c),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function iF(t){const e=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const r=t[n];if(typeof r=="object"&&r!=null&&Object.keys(r).length>0){const s=Object.keys(r).map(a=>`${n}.${a}`);e.push(...s)}else e.push(n)}return e.join(",")}function oF(t,e){let n=null;const r=t.bidiGenerateContentSetup;if(typeof r=="object"&&r!==null&&"setup"in r){const a=r.setup;typeof a=="object"&&a!==null?(t.bidiGenerateContentSetup=a,n=a):delete t.bidiGenerateContentSetup}else r!==void 0&&delete t.bidiGenerateContentSetup;const s=t.fieldMask;if(n){const a=iF(n);if(Array.isArray(e==null?void 0:e.lockAdditionalFields)&&(e==null?void 0:e.lockAdditionalFields.length)===0)a?t.fieldMask=a:delete t.fieldMask;else if(e!=null&&e.lockAdditionalFields&&e.lockAdditionalFields.length>0&&s!==null&&Array.isArray(s)&&s.length>0){const o=["temperature","topK","topP","maxOutputTokens","responseModalities","seed","speechConfig"];let u=[];s.length>0&&(u=s.map(c=>o.includes(c)?`generationConfig.${c}`:c));const d=[];a&&d.push(a),u.length>0&&d.push(...u),d.length>0?t.fieldMask=d.join(","):delete t.fieldMask}else delete t.fieldMask}else s!==null&&Array.isArray(s)&&s.length>0?t.fieldMask=s.join(","):delete t.fieldMask;return t}class lF extends Vs{constructor(e){super(),this.apiClient=e}async create(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("The client.tokens.create method is only supported by the Gemini Developer API.");{const u=Z3(this.apiClient,e);a=we("auth_tokens",u._url),o=u._query,delete u.config,delete u._url,delete u._query;const d=oF(u,e.config);return s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(d),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),s.then(c=>c)}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function uF(t,e){const n={},r=g(t,["displayName"]);return e!==void 0&&r!=null&&_(e,["displayName"],r),n}function cF(t){const e={},n=g(t,["config"]);return n!=null&&uF(n,e),e}function dF(t,e){const n={},r=g(t,["force"]);return e!==void 0&&r!=null&&_(e,["_query","force"],r),n}function fF(t){const e={},n=g(t,["name"]);n!=null&&_(e,["_url","name"],n);const r=g(t,["config"]);return r!=null&&dF(r,e),e}function pF(t){const e={},n=g(t,["name"]);return n!=null&&_(e,["_url","name"],n),e}function hF(t,e){const n={},r=g(t,["customMetadata"]);if(e!==void 0&&r!=null){let a=r;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["customMetadata"],a)}const s=g(t,["chunkingConfig"]);return e!==void 0&&s!=null&&_(e,["chunkingConfig"],s),n}function mF(t){const e={},n=g(t,["name"]);n!=null&&_(e,["name"],n);const r=g(t,["metadata"]);r!=null&&_(e,["metadata"],r);const s=g(t,["done"]);s!=null&&_(e,["done"],s);const a=g(t,["error"]);a!=null&&_(e,["error"],a);const o=g(t,["response"]);return o!=null&&_(e,["response"],yF(o)),e}function gF(t){const e={},n=g(t,["fileSearchStoreName"]);n!=null&&_(e,["_url","file_search_store_name"],n);const r=g(t,["fileName"]);r!=null&&_(e,["fileName"],r);const s=g(t,["config"]);return s!=null&&hF(s,e),e}function yF(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["parent"]);r!=null&&_(e,["parent"],r);const s=g(t,["documentName"]);return s!=null&&_(e,["documentName"],s),e}function _F(t,e){const n={},r=g(t,["pageSize"]);e!==void 0&&r!=null&&_(e,["_query","pageSize"],r);const s=g(t,["pageToken"]);return e!==void 0&&s!=null&&_(e,["_query","pageToken"],s),n}function vF(t){const e={},n=g(t,["config"]);return n!=null&&_F(n,e),e}function wF(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["fileSearchStores"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["fileSearchStores"],a)}return e}function bF(t,e){const n={},r=g(t,["mimeType"]);e!==void 0&&r!=null&&_(e,["mimeType"],r);const s=g(t,["displayName"]);e!==void 0&&s!=null&&_(e,["displayName"],s);const a=g(t,["customMetadata"]);if(e!==void 0&&a!=null){let u=a;Array.isArray(u)&&(u=u.map(d=>d)),_(e,["customMetadata"],u)}const o=g(t,["chunkingConfig"]);return e!==void 0&&o!=null&&_(e,["chunkingConfig"],o),n}function SF(t){const e={},n=g(t,["fileSearchStoreName"]);n!=null&&_(e,["_url","file_search_store_name"],n);const r=g(t,["config"]);return r!=null&&bF(r,e),e}function xF(t){const e={},n=g(t,["sdkHttpResponse"]);return n!=null&&_(e,["sdkHttpResponse"],n),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function TF(t,e){const n={},r=g(t,["force"]);return e!==void 0&&r!=null&&_(e,["_query","force"],r),n}function AF(t){const e={},n=g(t,["name"]);n!=null&&_(e,["_url","name"],n);const r=g(t,["config"]);return r!=null&&TF(r,e),e}function EF(t){const e={},n=g(t,["name"]);return n!=null&&_(e,["_url","name"],n),e}function CF(t,e){const n={},r=g(t,["pageSize"]);e!==void 0&&r!=null&&_(e,["_query","pageSize"],r);const s=g(t,["pageToken"]);return e!==void 0&&s!=null&&_(e,["_query","pageToken"],s),n}function IF(t){const e={},n=g(t,["parent"]);n!=null&&_(e,["_url","parent"],n);const r=g(t,["config"]);return r!=null&&CF(r,e),e}function RF(t){const e={},n=g(t,["sdkHttpResponse"]);n!=null&&_(e,["sdkHttpResponse"],n);const r=g(t,["nextPageToken"]);r!=null&&_(e,["nextPageToken"],r);const s=g(t,["documents"]);if(s!=null){let a=s;Array.isArray(a)&&(a=a.map(o=>o)),_(e,["documents"],a)}return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class NF extends Vs{constructor(e){super(),this.apiClient=e,this.list=async n=>new Ui(zs.PAGED_ITEM_DOCUMENTS,r=>this.listInternal({parent:n.parent,config:r.config}),await this.listInternal(n),n)}async get(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=EF(e);return a=we("{name}",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>d)}}async delete(e){var n,r;let s="",a={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const o=AF(e);s=we("{name}",o._url),a=o._query,delete o._url,delete o._query,await this.apiClient.request({path:s,queryParams:a,body:JSON.stringify(o),httpMethod:"DELETE",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal})}}async listInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=IF(e);return a=we("{parent}/documents",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>{const c=RF(d),p=new S$;return Object.assign(p,c),p})}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class PF extends Vs{constructor(e,n=new NF(e)){super(),this.apiClient=e,this.documents=n,this.list=async(r={})=>new Ui(zs.PAGED_ITEM_FILE_SEARCH_STORES,s=>this.listInternal(s),await this.listInternal(r),r)}async uploadToFileSearchStore(e){if(this.apiClient.isVertexAI())throw new Error("Vertex AI does not support uploading files to a file search store.");return this.apiClient.uploadFileToFileSearchStore(e.fileSearchStoreName,e.file,e.config)}async create(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=cF(e);return a=we("fileSearchStores",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>d)}}async get(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=pF(e);return a=we("{name}",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>d)}}async delete(e){var n,r;let s="",a={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const o=fF(e);s=we("{name}",o._url),a=o._query,delete o._url,delete o._query,await this.apiClient.request({path:s,queryParams:a,body:JSON.stringify(o),httpMethod:"DELETE",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal})}}async listInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=vF(e);return a=we("fileSearchStores",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>{const c=wF(d),p=new x$;return Object.assign(p,c),p})}}async uploadToFileSearchStoreInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=SF(e);return a=we("upload/v1beta/{file_search_store_name}:uploadToFileSearchStore",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>{const c=xF(d),p=new T$;return Object.assign(p,c),p})}}async importFile(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=gF(e);return a=we("{file_search_store_name}:importFile",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json()),s.then(d=>{const c=mF(d),p=new g0;return Object.assign(p,c),p})}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function MF(t,e){const n={},r=g(t,["name"]);return r!=null&&_(n,["_url","name"],r),n}function kF(t,e){const n={},r=g(t,["name"]);return r!=null&&_(n,["_url","name"],r),n}function OF(t,e,n){const r={};if(g(t,["validationDataset"])!==void 0)throw new Error("validationDataset parameter is not supported in Gemini API.");const s=g(t,["tunedModelDisplayName"]);if(e!==void 0&&s!=null&&_(e,["displayName"],s),g(t,["description"])!==void 0)throw new Error("description parameter is not supported in Gemini API.");const a=g(t,["epochCount"]);e!==void 0&&a!=null&&_(e,["tuningTask","hyperparameters","epochCount"],a);const o=g(t,["learningRateMultiplier"]);if(o!=null&&_(r,["tuningTask","hyperparameters","learningRateMultiplier"],o),g(t,["exportLastCheckpointOnly"])!==void 0)throw new Error("exportLastCheckpointOnly parameter is not supported in Gemini API.");if(g(t,["preTunedModelCheckpointId"])!==void 0)throw new Error("preTunedModelCheckpointId parameter is not supported in Gemini API.");if(g(t,["adapterSize"])!==void 0)throw new Error("adapterSize parameter is not supported in Gemini API.");const u=g(t,["batchSize"]);e!==void 0&&u!=null&&_(e,["tuningTask","hyperparameters","batchSize"],u);const d=g(t,["learningRate"]);if(e!==void 0&&d!=null&&_(e,["tuningTask","hyperparameters","learningRate"],d),g(t,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");if(g(t,["beta"])!==void 0)throw new Error("beta parameter is not supported in Gemini API.");return r}function DF(t,e,n){const r={};let s=g(n,["config","method"]);if(s===void 0&&(s="SUPERVISED_FINE_TUNING"),s==="SUPERVISED_FINE_TUNING"){const w=g(t,["validationDataset"]);e!==void 0&&w!=null&&_(e,["supervisedTuningSpec"],OA(w))}else if(s==="PREFERENCE_TUNING"){const w=g(t,["validationDataset"]);e!==void 0&&w!=null&&_(e,["preferenceOptimizationSpec"],OA(w))}const a=g(t,["tunedModelDisplayName"]);e!==void 0&&a!=null&&_(e,["tunedModelDisplayName"],a);const o=g(t,["description"]);e!==void 0&&o!=null&&_(e,["description"],o);let u=g(n,["config","method"]);if(u===void 0&&(u="SUPERVISED_FINE_TUNING"),u==="SUPERVISED_FINE_TUNING"){const w=g(t,["epochCount"]);e!==void 0&&w!=null&&_(e,["supervisedTuningSpec","hyperParameters","epochCount"],w)}else if(u==="PREFERENCE_TUNING"){const w=g(t,["epochCount"]);e!==void 0&&w!=null&&_(e,["preferenceOptimizationSpec","hyperParameters","epochCount"],w)}let d=g(n,["config","method"]);if(d===void 0&&(d="SUPERVISED_FINE_TUNING"),d==="SUPERVISED_FINE_TUNING"){const w=g(t,["learningRateMultiplier"]);e!==void 0&&w!=null&&_(e,["supervisedTuningSpec","hyperParameters","learningRateMultiplier"],w)}else if(d==="PREFERENCE_TUNING"){const w=g(t,["learningRateMultiplier"]);e!==void 0&&w!=null&&_(e,["preferenceOptimizationSpec","hyperParameters","learningRateMultiplier"],w)}let c=g(n,["config","method"]);if(c===void 0&&(c="SUPERVISED_FINE_TUNING"),c==="SUPERVISED_FINE_TUNING"){const w=g(t,["exportLastCheckpointOnly"]);e!==void 0&&w!=null&&_(e,["supervisedTuningSpec","exportLastCheckpointOnly"],w)}else if(c==="PREFERENCE_TUNING"){const w=g(t,["exportLastCheckpointOnly"]);e!==void 0&&w!=null&&_(e,["preferenceOptimizationSpec","exportLastCheckpointOnly"],w)}let p=g(n,["config","method"]);if(p===void 0&&(p="SUPERVISED_FINE_TUNING"),p==="SUPERVISED_FINE_TUNING"){const w=g(t,["adapterSize"]);e!==void 0&&w!=null&&_(e,["supervisedTuningSpec","hyperParameters","adapterSize"],w)}else if(p==="PREFERENCE_TUNING"){const w=g(t,["adapterSize"]);e!==void 0&&w!=null&&_(e,["preferenceOptimizationSpec","hyperParameters","adapterSize"],w)}if(g(t,["batchSize"])!==void 0)throw new Error("batchSize parameter is not supported in Vertex AI.");if(g(t,["learningRate"])!==void 0)throw new Error("learningRate parameter is not supported in Vertex AI.");const m=g(t,["labels"]);e!==void 0&&m!=null&&_(e,["labels"],m);const y=g(t,["beta"]);return e!==void 0&&y!=null&&_(e,["preferenceOptimizationSpec","hyperParameters","beta"],y),r}function LF(t,e){const n={},r=g(t,["baseModel"]);r!=null&&_(n,["baseModel"],r);const s=g(t,["preTunedModel"]);s!=null&&_(n,["preTunedModel"],s);const a=g(t,["trainingDataset"]);a!=null&&JF(a);const o=g(t,["config"]);return o!=null&&OF(o,n),n}function $F(t,e){const n={},r=g(t,["baseModel"]);r!=null&&_(n,["baseModel"],r);const s=g(t,["preTunedModel"]);s!=null&&_(n,["preTunedModel"],s);const a=g(t,["trainingDataset"]);a!=null&&YF(a,n,e);const o=g(t,["config"]);return o!=null&&DF(o,n,e),n}function UF(t,e){const n={},r=g(t,["name"]);return r!=null&&_(n,["_url","name"],r),n}function FF(t,e){const n={},r=g(t,["name"]);return r!=null&&_(n,["_url","name"],r),n}function BF(t,e,n){const r={},s=g(t,["pageSize"]);e!==void 0&&s!=null&&_(e,["_query","pageSize"],s);const a=g(t,["pageToken"]);e!==void 0&&a!=null&&_(e,["_query","pageToken"],a);const o=g(t,["filter"]);return e!==void 0&&o!=null&&_(e,["_query","filter"],o),r}function qF(t,e,n){const r={},s=g(t,["pageSize"]);e!==void 0&&s!=null&&_(e,["_query","pageSize"],s);const a=g(t,["pageToken"]);e!==void 0&&a!=null&&_(e,["_query","pageToken"],a);const o=g(t,["filter"]);return e!==void 0&&o!=null&&_(e,["_query","filter"],o),r}function GF(t,e){const n={},r=g(t,["config"]);return r!=null&&BF(r,n),n}function HF(t,e){const n={},r=g(t,["config"]);return r!=null&&qF(r,n),n}function zF(t,e){const n={},r=g(t,["sdkHttpResponse"]);r!=null&&_(n,["sdkHttpResponse"],r);const s=g(t,["nextPageToken"]);s!=null&&_(n,["nextPageToken"],s);const a=g(t,["tunedModels"]);if(a!=null){let o=a;Array.isArray(o)&&(o=o.map(u=>yN(u))),_(n,["tuningJobs"],o)}return n}function jF(t,e){const n={},r=g(t,["sdkHttpResponse"]);r!=null&&_(n,["sdkHttpResponse"],r);const s=g(t,["nextPageToken"]);s!=null&&_(n,["nextPageToken"],s);const a=g(t,["tuningJobs"]);if(a!=null){let o=a;Array.isArray(o)&&(o=o.map(u=>l_(u))),_(n,["tuningJobs"],o)}return n}function VF(t,e){const n={},r=g(t,["name"]);r!=null&&_(n,["model"],r);const s=g(t,["name"]);return s!=null&&_(n,["endpoint"],s),n}function JF(t,e){const n={};if(g(t,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");if(g(t,["vertexDatasetResource"])!==void 0)throw new Error("vertexDatasetResource parameter is not supported in Gemini API.");const r=g(t,["examples"]);if(r!=null){let s=r;Array.isArray(s)&&(s=s.map(a=>a)),_(n,["examples","examples"],s)}return n}function YF(t,e,n){const r={};let s=g(n,["config","method"]);if(s===void 0&&(s="SUPERVISED_FINE_TUNING"),s==="SUPERVISED_FINE_TUNING"){const o=g(t,["gcsUri"]);e!==void 0&&o!=null&&_(e,["supervisedTuningSpec","trainingDatasetUri"],o)}else if(s==="PREFERENCE_TUNING"){const o=g(t,["gcsUri"]);e!==void 0&&o!=null&&_(e,["preferenceOptimizationSpec","trainingDatasetUri"],o)}let a=g(n,["config","method"]);if(a===void 0&&(a="SUPERVISED_FINE_TUNING"),a==="SUPERVISED_FINE_TUNING"){const o=g(t,["vertexDatasetResource"]);e!==void 0&&o!=null&&_(e,["supervisedTuningSpec","trainingDatasetUri"],o)}else if(a==="PREFERENCE_TUNING"){const o=g(t,["vertexDatasetResource"]);e!==void 0&&o!=null&&_(e,["preferenceOptimizationSpec","trainingDatasetUri"],o)}if(g(t,["examples"])!==void 0)throw new Error("examples parameter is not supported in Vertex AI.");return r}function yN(t,e){const n={},r=g(t,["sdkHttpResponse"]);r!=null&&_(n,["sdkHttpResponse"],r);const s=g(t,["name"]);s!=null&&_(n,["name"],s);const a=g(t,["state"]);a!=null&&_(n,["state"],XR(a));const o=g(t,["createTime"]);o!=null&&_(n,["createTime"],o);const u=g(t,["tuningTask","startTime"]);u!=null&&_(n,["startTime"],u);const d=g(t,["tuningTask","completeTime"]);d!=null&&_(n,["endTime"],d);const c=g(t,["updateTime"]);c!=null&&_(n,["updateTime"],c);const p=g(t,["description"]);p!=null&&_(n,["description"],p);const m=g(t,["baseModel"]);m!=null&&_(n,["baseModel"],m);const y=g(t,["_self"]);return y!=null&&_(n,["tunedModel"],VF(y)),n}function l_(t,e){const n={},r=g(t,["sdkHttpResponse"]);r!=null&&_(n,["sdkHttpResponse"],r);const s=g(t,["name"]);s!=null&&_(n,["name"],s);const a=g(t,["state"]);a!=null&&_(n,["state"],XR(a));const o=g(t,["createTime"]);o!=null&&_(n,["createTime"],o);const u=g(t,["startTime"]);u!=null&&_(n,["startTime"],u);const d=g(t,["endTime"]);d!=null&&_(n,["endTime"],d);const c=g(t,["updateTime"]);c!=null&&_(n,["updateTime"],c);const p=g(t,["error"]);p!=null&&_(n,["error"],p);const m=g(t,["description"]);m!=null&&_(n,["description"],m);const y=g(t,["baseModel"]);y!=null&&_(n,["baseModel"],y);const w=g(t,["tunedModel"]);w!=null&&_(n,["tunedModel"],w);const x=g(t,["preTunedModel"]);x!=null&&_(n,["preTunedModel"],x);const A=g(t,["supervisedTuningSpec"]);A!=null&&_(n,["supervisedTuningSpec"],A);const E=g(t,["preferenceOptimizationSpec"]);E!=null&&_(n,["preferenceOptimizationSpec"],E);const C=g(t,["tuningDataStats"]);C!=null&&_(n,["tuningDataStats"],C);const D=g(t,["encryptionSpec"]);D!=null&&_(n,["encryptionSpec"],D);const O=g(t,["partnerModelTuningSpec"]);O!=null&&_(n,["partnerModelTuningSpec"],O);const T=g(t,["customBaseModel"]);T!=null&&_(n,["customBaseModel"],T);const I=g(t,["experiment"]);I!=null&&_(n,["experiment"],I);const M=g(t,["labels"]);M!=null&&_(n,["labels"],M);const N=g(t,["outputUri"]);N!=null&&_(n,["outputUri"],N);const P=g(t,["pipelineJob"]);P!=null&&_(n,["pipelineJob"],P);const k=g(t,["serviceAccount"]);k!=null&&_(n,["serviceAccount"],k);const $=g(t,["tunedModelDisplayName"]);$!=null&&_(n,["tunedModelDisplayName"],$);const U=g(t,["veoTuningSpec"]);return U!=null&&_(n,["veoTuningSpec"],U),n}function KF(t,e){const n={},r=g(t,["sdkHttpResponse"]);r!=null&&_(n,["sdkHttpResponse"],r);const s=g(t,["name"]);s!=null&&_(n,["name"],s);const a=g(t,["metadata"]);a!=null&&_(n,["metadata"],a);const o=g(t,["done"]);o!=null&&_(n,["done"],o);const u=g(t,["error"]);return u!=null&&_(n,["error"],u),n}function OA(t,e){const n={},r=g(t,["gcsUri"]);r!=null&&_(n,["validationDatasetUri"],r);const s=g(t,["vertexDatasetResource"]);return s!=null&&_(n,["validationDatasetUri"],s),n}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class WF extends Vs{constructor(e){super(),this.apiClient=e,this.get=async n=>await this.getInternal(n),this.list=async(n={})=>new Ui(zs.PAGED_ITEM_TUNING_JOBS,r=>this.listInternal(r),await this.listInternal(n),n),this.tune=async n=>{var r;if(this.apiClient.isVertexAI())if(n.baseModel.startsWith("projects/")){const s={tunedModelName:n.baseModel};!((r=n.config)===null||r===void 0)&&r.preTunedModelCheckpointId&&(s.checkpointId=n.config.preTunedModelCheckpointId);const a=Object.assign(Object.assign({},n),{preTunedModel:s});return a.baseModel=void 0,await this.tuneInternal(a)}else{const s=Object.assign({},n);return await this.tuneInternal(s)}else{const s=Object.assign({},n),a=await this.tuneMldevInternal(s);let o="";return a.metadata!==void 0&&a.metadata.tunedModel!==void 0?o=a.metadata.tunedModel:a.name!==void 0&&a.name.includes("/operations/")&&(o=a.name.split("/operations/")[0]),{name:o,state:t_.JOB_STATE_QUEUED}}}}async getInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=FF(e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>l_(p))}else{const c=UF(e);return u=we("{name}",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>yN(p))}}async listInternal(e){var n,r,s,a;let o,u="",d={};if(this.apiClient.isVertexAI()){const c=HF(e);return u=we("tuningJobs",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=jF(p),y=new pA;return Object.assign(y,m),y})}else{const c=GF(e);return u=we("tunedModels",c._url),d=c._query,delete c._url,delete c._query,o=this.apiClient.request({path:u,queryParams:d,body:JSON.stringify(c),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal}).then(p=>p.json().then(m=>{const y=m;return y.sdkHttpResponse={headers:p.headers},y})),o.then(p=>{const m=zF(p),y=new pA;return Object.assign(y,m),y})}}async cancel(e){var n,r,s,a;let o="",u={};if(this.apiClient.isVertexAI()){const d=kF(e);o=we("{name}:cancel",d._url),u=d._query,delete d._url,delete d._query,await this.apiClient.request({path:o,queryParams:u,body:JSON.stringify(d),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal})}else{const d=MF(e);o=we("{name}:cancel",d._url),u=d._query,delete d._url,delete d._query,await this.apiClient.request({path:o,queryParams:u,body:JSON.stringify(d),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(a=e.config)===null||a===void 0?void 0:a.abortSignal})}}async tuneInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI()){const u=$F(e,e);return a=we("tuningJobs",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(c=>{const p=c;return p.sdkHttpResponse={headers:d.headers},p})),s.then(d=>l_(d))}else throw new Error("This method is only supported by the Vertex AI.")}async tuneMldevInternal(e){var n,r;let s,a="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const u=LF(e);return a=we("tunedModels",u._url),o=u._query,delete u._url,delete u._query,s=this.apiClient.request({path:a,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(n=e.config)===null||n===void 0?void 0:n.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(d=>d.json().then(c=>{const p=c;return p.sdkHttpResponse={headers:d.headers},p})),s.then(d=>KF(d))}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class ZF{async download(e,n){throw new Error("Download to file is not supported in the browser, please use a browser compliant download like an <a> tag.")}}const XF=1024*1024*8,QF=3,eB=1e3,tB=2,Rf="x-goog-upload-status";async function nB(t,e,n){var r;const s=await _N(t,e,n),a=await(s==null?void 0:s.json());if(((r=s==null?void 0:s.headers)===null||r===void 0?void 0:r[Rf])!=="final")throw new Error("Failed to upload file: Upload status is not finalized.");return a.file}async function rB(t,e,n){var r;const s=await _N(t,e,n),a=await(s==null?void 0:s.json());if(((r=s==null?void 0:s.headers)===null||r===void 0?void 0:r[Rf])!=="final")throw new Error("Failed to upload file: Upload status is not finalized.");const o=VR(a),u=new y0;return Object.assign(u,o),u}async function _N(t,e,n){var r,s;let a=0,o=0,u=new n_(new Response),d="upload";for(a=t.size;o<a;){const c=Math.min(XF,a-o),p=t.slice(o,o+c);o+c>=a&&(d+=", finalize");let m=0,y=eB;for(;m<QF&&(u=await n.request({path:"",body:p,httpMethod:"POST",httpOptions:{apiVersion:"",baseUrl:e,headers:{"X-Goog-Upload-Command":d,"X-Goog-Upload-Offset":String(o),"Content-Length":String(c)}}}),!(!((r=u==null?void 0:u.headers)===null||r===void 0)&&r[Rf]));)m++,await aB(y),y=y*tB;if(o+=c,((s=u==null?void 0:u.headers)===null||s===void 0?void 0:s[Rf])!=="active")break;if(a<=o)throw new Error("All content has been uploaded, but the upload status is not finalized.")}return u}async function sB(t){return{size:t.size,type:t.type}}function aB(t){return new Promise(e=>setTimeout(e,t))}class iB{async upload(e,n,r){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await nB(e,n,r)}async uploadToFileSearchStore(e,n,r){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await rB(e,n,r)}async stat(e){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await sB(e)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class oB{create(e,n,r){return new lB(e,n,r)}}class lB{constructor(e,n,r){this.url=e,this.headers=n,this.callbacks=r}connect(){this.ws=new WebSocket(this.url),this.ws.onopen=this.callbacks.onopen,this.ws.onerror=this.callbacks.onerror,this.ws.onclose=this.callbacks.onclose,this.ws.onmessage=this.callbacks.onmessage}send(e){if(this.ws===void 0)throw new Error("WebSocket is not connected");this.ws.send(e)}close(){if(this.ws===void 0)throw new Error("WebSocket is not connected");this.ws.close()}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const DA="x-goog-api-key";class uB{constructor(e){this.apiKey=e}async addAuthHeaders(e,n){if(e.get(DA)===null){if(this.apiKey.startsWith("auth_tokens/"))throw new Error("Ephemeral tokens are only supported by the live API.");if(!this.apiKey)throw new Error("API key is missing. Please provide a valid API key.");e.append(DA,this.apiKey)}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const cB="gl-node/";class dB{constructor(e){var n;if(e.apiKey==null)throw new Error("An API Key must be set when running in a browser");if(e.project||e.location)throw new Error("Vertex AI project based authentication is not supported on browser runtimes. Please do not provide a project or location.");this.vertexai=(n=e.vertexai)!==null&&n!==void 0?n:!1,this.apiKey=e.apiKey;const r=t$(e.httpOptions,e.vertexai,void 0,void 0);r&&(e.httpOptions?e.httpOptions.baseUrl=r:e.httpOptions={baseUrl:r}),this.apiVersion=e.apiVersion;const s=new uB(this.apiKey);this.apiClient=new C3({auth:s,apiVersion:this.apiVersion,apiKey:this.apiKey,vertexai:this.vertexai,httpOptions:e.httpOptions,userAgentExtra:cB+"web",uploader:new iB,downloader:new ZF}),this.models=new V3(this.apiClient),this.live=new B3(this.apiClient,s,new oB),this.batches=new E2(this.apiClient),this.chats=new sU(this.models,this.apiClient),this.caches=new tU(this.apiClient),this.files=new hU(this.apiClient),this.operations=new J3(this.apiClient),this.authTokens=new lF(this.apiClient),this.tunings=new WF(this.apiClient),this.fileSearchStores=new PF(this.apiClient)}}const u_="RFC3986",c_={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:t=>String(t)},fB="RFC1738",pB=Array.isArray,Xr=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),og=1024,hB=(t,e,n,r,s)=>{if(t.length===0)return t;let a=t;if(typeof t=="symbol"?a=Symbol.prototype.toString.call(t):typeof t!="string"&&(a=String(t)),n==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(u){return"%26%23"+parseInt(u.slice(2),16)+"%3B"});let o="";for(let u=0;u<a.length;u+=og){const d=a.length>=og?a.slice(u,u+og):a,c=[];for(let p=0;p<d.length;++p){let m=d.charCodeAt(p);if(m===45||m===46||m===95||m===126||m>=48&&m<=57||m>=65&&m<=90||m>=97&&m<=122||s===fB&&(m===40||m===41)){c[c.length]=d.charAt(p);continue}if(m<128){c[c.length]=Xr[m];continue}if(m<2048){c[c.length]=Xr[192|m>>6]+Xr[128|m&63];continue}if(m<55296||m>=57344){c[c.length]=Xr[224|m>>12]+Xr[128|m>>6&63]+Xr[128|m&63];continue}p+=1,m=65536+((m&1023)<<10|d.charCodeAt(p)&1023),c[c.length]=Xr[240|m>>18]+Xr[128|m>>12&63]+Xr[128|m>>6&63]+Xr[128|m&63]}o+=c.join("")}return o};function mB(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function LA(t,e){if(pB(t)){const n=[];for(let r=0;r<t.length;r+=1)n.push(e(t[r]));return n}return e(t)}const gB=Object.prototype.hasOwnProperty,vN={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},ts=Array.isArray,yB=Array.prototype.push,wN=function(t,e){yB.apply(t,ts(e)?e:[e])},_B=Date.prototype.toISOString,un={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:hB,encodeValuesOnly:!1,format:u_,formatter:c_[u_],indices:!1,serializeDate(t){return _B.call(t)},skipNulls:!1,strictNullHandling:!1};function vB(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const lg={};function bN(t,e,n,r,s,a,o,u,d,c,p,m,y,w,x,A,E,C){let D=t,O=C,T=0,I=!1;for(;(O=O.get(lg))!==void 0&&!I;){const $=O.get(t);if(T+=1,typeof $<"u"){if($===T)throw new RangeError("Cyclic object value");I=!0}typeof O.get(lg)>"u"&&(T=0)}if(typeof c=="function"?D=c(e,D):D instanceof Date?D=y==null?void 0:y(D):n==="comma"&&ts(D)&&(D=LA(D,function($){return $ instanceof Date?y==null?void 0:y($):$})),D===null){if(a)return d&&!A?d(e,un.encoder,E,"key",w):e;D=""}if(vB(D)||mB(D)){if(d){const $=A?e:d(e,un.encoder,E,"key",w);return[(x==null?void 0:x($))+"="+(x==null?void 0:x(d(D,un.encoder,E,"value",w)))]}return[(x==null?void 0:x(e))+"="+(x==null?void 0:x(String(D)))]}const M=[];if(typeof D>"u")return M;let N;if(n==="comma"&&ts(D))A&&d&&(D=LA(D,d)),N=[{value:D.length>0?D.join(",")||null:void 0}];else if(ts(c))N=c;else{const $=Object.keys(D);N=p?$.sort(p):$}const P=u?String(e).replace(/\./g,"%2E"):String(e),k=r&&ts(D)&&D.length===1?P+"[]":P;if(s&&ts(D)&&D.length===0)return k+"[]";for(let $=0;$<N.length;++$){const U=N[$],F=typeof U=="object"&&typeof U.value<"u"?U.value:D[U];if(o&&F===null)continue;const K=m&&u?U.replace(/\./g,"%2E"):U,j=ts(D)?typeof n=="function"?n(k,K):k:k+(m?"."+K:"["+K+"]");C.set(t,T);const V=new WeakMap;V.set(lg,C),wN(M,bN(F,j,n,r,s,a,o,u,n==="comma"&&A&&ts(D)?null:d,c,p,m,y,w,x,A,E,V))}return M}function wB(t=un){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||un.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=u_;if(typeof t.format<"u"){if(!gB.call(c_,t.format))throw new TypeError("Unknown format option provided.");n=t.format}const r=c_[n];let s=un.filter;(typeof t.filter=="function"||ts(t.filter))&&(s=t.filter);let a;if(t.arrayFormat&&t.arrayFormat in vN?a=t.arrayFormat:"indices"in t?a=t.indices?"indices":"repeat":a=un.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const o=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:un.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:un.addQueryPrefix,allowDots:o,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:un.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:un.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?un.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:un.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:un.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:un.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:un.encodeValuesOnly,filter:s,format:n,formatter:r,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:un.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:un.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:un.strictNullHandling}}function bB(t,e={}){let n=t;const r=wB(e);let s,a;typeof r.filter=="function"?(a=r.filter,n=a("",n)):ts(r.filter)&&(a=r.filter,s=a);const o=[];if(typeof n!="object"||n===null)return"";const u=vN[r.arrayFormat],d=u==="comma"&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const c=new WeakMap;for(let y=0;y<s.length;++y){const w=s[y];r.skipNulls&&n[w]===null||wN(o,bN(n[w],w,u,d,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const p=o.join(r.delimiter);let m=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?m+="utf8=%26%2310003%3B&":m+="utf8=%E2%9C%93&"),p.length>0?m+p:""}const No="4.104.0";let $A=!1,Cu,SN,xN,d_,TN,AN,EN,CN,IN;function SB(t,e={auto:!1}){if($A)throw new Error(`you must \`import 'openai/shims/${t.kind}'\` before importing anything else from openai`);if(Cu)throw new Error(`can't \`import 'openai/shims/${t.kind}'\` after \`import 'openai/shims/${Cu}'\``);$A=e.auto,Cu=t.kind,SN=t.fetch,xN=t.FormData,d_=t.File,TN=t.ReadableStream,AN=t.getMultipartRequestOptions,EN=t.getDefaultAgent,CN=t.fileFromPath,IN=t.isFsReadStream}class xB{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function TB({manuallyImported:t}={}){const e=t?"You may need to use polyfills":"Add one of these imports before your first `import  from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(o){throw new Error(`this environment is missing the following Web Fetch API type: ${o.message}. ${e}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(o,u)=>({...u,body:new xB(o)}),getDefaultAgent:o=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:o=>!1}}const RN=()=>{Cu||SB(TB(),{auto:!0})};RN();class He extends Error{}class An extends He{constructor(e,n,r,s){super(`${An.makeMessage(e,n,r)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["x-request-id"],this.error=n;const a=n;this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,n,r){const s=n!=null&&n.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,n,r,s){if(!e||!s)return new op({message:r,cause:p_(n)});const a=n==null?void 0:n.error;return e===400?new NN(e,a,r,s):e===401?new PN(e,a,r,s):e===403?new MN(e,a,r,s):e===404?new kN(e,a,r,s):e===409?new ON(e,a,r,s):e===422?new DN(e,a,r,s):e===429?new LN(e,a,r,s):e>=500?new $N(e,a,r,s):new An(e,a,r,s)}}class Sr extends An{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class op extends An{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),n&&(this.cause=n)}}class x0 extends op{constructor({message:e}={}){super({message:e??"Request timed out."})}}class NN extends An{}class PN extends An{}class MN extends An{}class kN extends An{}class ON extends An{}class DN extends An{}class LN extends An{}class $N extends An{}class UN extends He{constructor(){super("Could not parse response content as the length limit was reached")}}class FN extends He{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var Fd=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},_i=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},rr;class lp{constructor(){rr.set(this,void 0),this.buffer=new Uint8Array,Fd(this,rr,null,"f")}decode(e){if(e==null)return[];const n=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let r=new Uint8Array(this.buffer.length+n.length);r.set(this.buffer),r.set(n,this.buffer.length),this.buffer=r;const s=[];let a;for(;(a=AB(this.buffer,_i(this,rr,"f")))!=null;){if(a.carriage&&_i(this,rr,"f")==null){Fd(this,rr,a.index,"f");continue}if(_i(this,rr,"f")!=null&&(a.index!==_i(this,rr,"f")+1||a.carriage)){s.push(this.decodeText(this.buffer.slice(0,_i(this,rr,"f")-1))),this.buffer=this.buffer.slice(_i(this,rr,"f")),Fd(this,rr,null,"f");continue}const o=_i(this,rr,"f")!==null?a.preceding-1:a.preceding,u=this.decodeText(this.buffer.slice(0,o));s.push(u),this.buffer=this.buffer.slice(a.index),Fd(this,rr,null,"f")}return s}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new He(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new He(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new He("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}rr=new WeakMap;lp.NEWLINE_CHARS=new Set([`
`,"\r"]);lp.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function AB(t,e){for(let s=e??0;s<t.length;s++){if(t[s]===10)return{preceding:s,index:s+1,carriage:!1};if(t[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function EB(t){for(let r=0;r<t.length-1;r++){if(t[r]===10&&t[r+1]===10||t[r]===13&&t[r+1]===13)return r+2;if(t[r]===13&&t[r+1]===10&&r+3<t.length&&t[r+2]===13&&t[r+3]===10)return r+4}return-1}function BN(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n!=null&&n.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class as{constructor(e,n){this.iterator=e,this.controller=n}static fromSSEResponse(e,n){let r=!1;async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const o of CB(e,n))if(!a){if(o.data.startsWith("[DONE]")){a=!0;continue}if(o.event===null||o.event.startsWith("response.")||o.event.startsWith("transcript.")){let u;try{u=JSON.parse(o.data)}catch(d){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),d}if(u&&u.error)throw new An(void 0,u.error,void 0,JN(e.headers));yield u}else{let u;try{u=JSON.parse(o.data)}catch(d){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),d}if(o.event=="error")throw new An(void 0,u.error,u.message,void 0);yield{event:o.event,data:u}}}a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||n.abort()}}return new as(s,n)}static fromReadableStream(e,n){let r=!1;async function*s(){const o=new lp,u=BN(e);for await(const d of u)for(const c of o.decode(d))yield c;for(const d of o.flush())yield d}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const u of s())o||u&&(yield JSON.parse(u));o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||n.abort()}}return new as(a,n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],n=[],r=this.iterator(),s=a=>({next:()=>{if(a.length===0){const o=r.next();e.push(o),n.push(o)}return a.shift()}});return[new as(()=>s(e),this.controller),new as(()=>s(n),this.controller)]}toReadableStream(){const e=this;let n;const r=new TextEncoder;return new TN({async start(){n=e[Symbol.asyncIterator]()},async pull(s){try{const{value:a,done:o}=await n.next();if(o)return s.close();const u=r.encode(JSON.stringify(a)+`
`);s.enqueue(u)}catch(a){s.error(a)}},async cancel(){var s;await((s=n.return)==null?void 0:s.call(n))}})}}async function*CB(t,e){if(!t.body)throw e.abort(),new He("Attempted to iterate over a response with no body");const n=new RB,r=new lp,s=BN(t.body);for await(const a of IB(s))for(const o of r.decode(a)){const u=n.decode(o);u&&(yield u)}for(const a of r.flush()){const o=n.decode(a);o&&(yield o)}}async function*IB(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let a;for(;(a=EB(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}class RB{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,r,s]=NB(e,":");return s.startsWith(" ")&&(s=s.substring(1)),n==="event"?this.event=s:n==="data"&&this.data.push(s),null}}function NB(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}const qN=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function",GN=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&up(t),up=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",PB=t=>GN(t)||qN(t)||IN(t);async function HN(t,e,n){var s;if(t=await t,GN(t))return t;if(qN(t)){const a=await t.blob();e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()??"unknown_file");const o=up(a)?[await a.arrayBuffer()]:[a];return new d_(o,e,n)}const r=await MB(t);if(e||(e=OB(t)??"unknown_file"),!(n!=null&&n.type)){const a=(s=r[0])==null?void 0:s.type;typeof a=="string"&&(n={...n,type:a})}return new d_(r,e,n)}async function MB(t){var n;let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(up(t))e.push(await t.arrayBuffer());else if(DB(t))for await(const r of t)e.push(r);else throw new Error(`Unexpected data type: ${typeof t}; constructor: ${(n=t==null?void 0:t.constructor)==null?void 0:n.name}; props: ${kB(t)}`);return e}function kB(t){return`[${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}function OB(t){var e;return ug(t.name)||ug(t.filename)||((e=ug(t.path))==null?void 0:e.split(/[\\/]/).pop())}const ug=t=>{if(typeof t=="string")return t;if(typeof Buffer<"u"&&t instanceof Buffer)return String(t)},DB=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",UA=t=>t&&typeof t=="object"&&t.body&&t[Symbol.toStringTag]==="MultipartBody",ki=async t=>{const e=await LB(t.body);return AN(e,t)},LB=async t=>{const e=new xN;return await Promise.all(Object.entries(t||{}).map(([n,r])=>f_(e,n,r))),e},f_=async(t,e,n)=>{if(n!==void 0){if(n==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")t.append(e,String(n));else if(PB(n)){const r=await HN(n);t.append(e,r)}else if(Array.isArray(n))await Promise.all(n.map(r=>f_(t,e+"[]",r)));else if(typeof n=="object")await Promise.all(Object.entries(n).map(([r,s])=>f_(t,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}};var jo={},$B=function(t,e,n,r,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n},UB=function(t,e,n,r){if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},Bd;RN();async function zN(t){var o;const{response:e}=t;if(t.options.stream)return Da("response",e.status,e.url,e.headers,e.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(e,t.controller):as.fromSSEResponse(e,t.controller);if(e.status===204)return null;if(t.options.__binaryResponse)return e;const n=e.headers.get("content-type"),r=(o=n==null?void 0:n.split(";")[0])==null?void 0:o.trim();if((r==null?void 0:r.includes("application/json"))||(r==null?void 0:r.endsWith("+json"))){const u=await e.json();return Da("response",e.status,e.url,e.headers,u),jN(u,e)}const a=await e.text();return Da("response",e.status,e.url,e.headers,a),a}function jN(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class cp extends Promise{constructor(e,n=zN){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=n}_thenUnwrap(e){return new cp(this.responsePromise,async n=>jN(e(await this.parseResponse(n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n,request_id:n.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class FB{constructor({baseURL:e,maxRetries:n=2,timeout:r=6e5,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=cg("maxRetries",n),this.timeout=cg("timeout",r),this.httpAgent=s,this.fetch=a??SN}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...zB(),...this.authHeaders(e)}}validateHeaders(e,n){}defaultIdempotencyKey(){return`stainless-node-retry-${YB()}`}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,r){return this.request(Promise.resolve(r).then(async s=>{const a=s&&up(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:n,...s,body:a}}))}getAPIList(e,n,r){return this.requestAPIList(n,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:n=0}={}){var A;const r={...e},{method:s,path:a,query:o,headers:u={}}=r,d=ArrayBuffer.isView(r.body)||r.__binaryRequest&&typeof r.body=="string"?r.body:UA(r.body)?r.body.body:r.body?JSON.stringify(r.body,null,2):null,c=this.calculateContentLength(d),p=this.buildURL(a,o);"timeout"in r&&cg("timeout",r.timeout),r.timeout=r.timeout??this.timeout;const m=r.httpAgent??this.httpAgent??EN(p),y=r.timeout+1e3;typeof((A=m==null?void 0:m.options)==null?void 0:A.timeout)=="number"&&y>(m.options.timeout??0)&&(m.options.timeout=y),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),u[this.idempotencyHeader]=e.idempotencyKey);const w=this.buildHeaders({options:r,headers:u,contentLength:c,retryCount:n});return{req:{method:s,...d&&{body:d},headers:w,...m&&{agent:m},signal:r.signal??null},url:p,timeout:r.timeout}}buildHeaders({options:e,headers:n,contentLength:r,retryCount:s}){const a={};r&&(a["content-length"]=r);const o=this.defaultHeaders(e);return GA(a,o),GA(a,n),UA(e.body)&&Cu!=="node"&&delete a["content-type"],Gd(o,"x-stainless-retry-count")===void 0&&Gd(n,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),Gd(o,"x-stainless-timeout")===void 0&&Gd(n,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(a,n),a}async prepareOptions(e){}async prepareRequest(e,{url:n,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(n=>[...n])):{...e}:{}}makeStatusError(e,n,r,s){return An.generate(e,n,r,s)}request(e,n=null){return new cp(this.makeRequest(e,n))}async makeRequest(e,n){var m,y;const r=await e,s=r.maxRetries??this.maxRetries;n==null&&(n=s),await this.prepareOptions(r);const{req:a,url:o,timeout:u}=this.buildRequest(r,{retryCount:s-n});if(await this.prepareRequest(a,{url:o,options:r}),Da("request",o,r,a.headers),(m=r.signal)!=null&&m.aborted)throw new Sr;const d=new AbortController,c=await this.fetchWithTimeout(o,a,u,d).catch(p_);if(c instanceof Error){if((y=r.signal)!=null&&y.aborted)throw new Sr;if(n)return this.retryRequest(r,n);throw c.name==="AbortError"?new x0:new op({cause:c})}const p=JN(c.headers);if(!c.ok){if(n&&this.shouldRetry(c)){const D=`retrying, ${n} attempts remaining`;return Da(`response (error; ${D})`,c.status,o,p),this.retryRequest(r,n,p)}const w=await c.text().catch(D=>p_(D).message),x=jB(w),A=x?void 0:w;throw Da(`response (error; ${n?"(error; no more retries left)":"(error; not retryable)"})`,c.status,o,p,A),this.makeStatusError(c.status,x,A,p)}return{response:c,options:r,controller:d}}requestAPIList(e,n){const r=this.makeRequest(n,null);return new BB(this,r,e)}buildURL(e,n){const r=JB(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return YN(s)||(n={...s,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(r.search=this.stringifyQuery(n)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([n,r])=>typeof r<"u").map(([n,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(n)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(n)}=`;throw new He(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,n,r,s){const{signal:a,...o}=n||{};a&&a.addEventListener("abort",()=>s.abort());const u=setTimeout(()=>s.abort(),r),d={signal:s.signal,...o};return d.method&&(d.method=d.method.toUpperCase()),this.fetch.call(void 0,e,d).finally(()=>{clearTimeout(u)})}shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,r){let s;const a=r==null?void 0:r["retry-after-ms"];if(a){const u=parseFloat(a);Number.isNaN(u)||(s=u)}const o=r==null?void 0:r["retry-after"];if(o&&!s){const u=parseFloat(o);Number.isNaN(u)?s=Date.parse(o)-Date.now():s=u*1e3}if(!(s&&0<=s&&s<60*1e3)){const u=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(n,u)}return await sc(s),this.makeRequest(e,n-1)}calculateDefaultRetryTimeoutMillis(e,n){const a=n-e,o=Math.min(.5*Math.pow(2,a),8),u=1-Math.random()*.25;return o*u*1e3}getUserAgent(){return`${this.constructor.name}/JS ${No}`}}class VN{constructor(e,n,r,s){Bd.set(this,void 0),$B(this,Bd,e),this.options=s,this.response=n,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new He("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const n={...this.options};if("params"in e&&typeof n.query=="object")n.query={...n.query,...e.params};else if("url"in e){const r=[...Object.entries(n.query||{}),...e.url.searchParams.entries()];for(const[s,a]of r)e.url.searchParams.set(s,a);n.query=void 0,n.path=e.url.toString()}return await UB(this,Bd,"f").requestAPIList(this.constructor,n)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Bd=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}}class BB extends cp{constructor(e,n,r){super(n,async s=>new r(e,s.response,await zN(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}}const JN=t=>new Proxy(Object.fromEntries(t.entries()),{get(e,n){const r=n.toString();return e[r.toLowerCase()]||e[r]}}),qB={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Ut=t=>typeof t=="object"&&t!==null&&!YN(t)&&Object.keys(t).every(e=>KN(qB,e)),GB=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":No,"X-Stainless-OS":BA(Deno.build.os),"X-Stainless-Arch":FA(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":No,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":No,"X-Stainless-OS":BA(process.platform),"X-Stainless-Arch":FA(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const t=HB();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":No,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":No,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function HB(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const r=n.exec(navigator.userAgent);if(r){const s=r[1]||0,a=r[2]||0,o=r[3]||0;return{browser:e,version:`${s}.${a}.${o}`}}}return null}const FA=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",BA=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let qA;const zB=()=>qA??(qA=GB()),jB=t=>{try{return JSON.parse(t)}catch{return}},VB=/^[a-z][a-z0-9+.-]*:/i,JB=t=>VB.test(t),sc=t=>new Promise(e=>setTimeout(e,t)),cg=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new He(`${t} must be an integer`);if(e<0)throw new He(`${t} must be a positive integer`);return e},p_=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null)try{return new Error(JSON.stringify(t))}catch{}return new Error(t)},qd=t=>{var e,n,r,s;if(typeof process<"u")return((e=jo==null?void 0:jo[t])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(s=(r=(n=Deno.env)==null?void 0:n.get)==null?void 0:r.call(n,t))==null?void 0:s.trim()};function YN(t){if(!t)return!0;for(const e in t)return!1;return!0}function KN(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function GA(t,e){for(const n in e){if(!KN(e,n))continue;const r=n.toLowerCase();if(!r)continue;const s=e[n];s===null?delete t[r]:s!==void 0&&(t[r]=s)}}const HA=new Set(["authorization","api-key"]);function Da(t,...e){if(typeof process<"u"&&(jo==null?void 0:jo.DEBUG)==="true"){const n=e.map(r=>{if(!r)return r;if(r.headers){const a={...r,headers:{...r.headers}};for(const o in r.headers)HA.has(o.toLowerCase())&&(a.headers[o]="REDACTED");return a}let s=null;for(const a in r)HA.has(a.toLowerCase())&&(s??(s={...r}),s[a]="REDACTED");return s??r});console.log(`OpenAI:DEBUG:${t}`,...n)}}const YB=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),KB=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",WB=t=>typeof(t==null?void 0:t.get)=="function",Gd=(t,e)=>{var r;const n=e.toLowerCase();if(WB(t)){const s=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,o,u)=>o+u.toUpperCase());for(const a of[e,n,e.toUpperCase(),s]){const o=t.get(a);if(o)return o}}for(const[s,a]of Object.entries(t))if(s.toLowerCase()===n)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a},ZB=t=>{if(typeof Buffer<"u"){const e=Buffer.from(t,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(t),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.charCodeAt(s);return Array.from(new Float32Array(r.buffer))}};function dg(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}class dp extends VN{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class cn extends VN{constructor(e,n,r,s){super(e,n,r,s),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const n=Object.fromEntries(e.url.searchParams);return Object.keys(n).length?n:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const n=(r=e[e.length-1])==null?void 0:r.id;return n?{params:{after:n}}:null}}class Ve{constructor(e){this._client=e}}let WN=class extends Ve{list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/chat/completions/${e}/messages`,XB,{query:n,...r})}},fp=class extends Ve{constructor(){super(...arguments),this.messages=new WN(this._client)}create(e,n){return this._client.post("/chat/completions",{body:e,...n,stream:e.stream??!1})}retrieve(e,n){return this._client.get(`/chat/completions/${e}`,n)}update(e,n,r){return this._client.post(`/chat/completions/${e}`,{body:n,...r})}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/chat/completions",pp,{query:e,...n})}del(e,n){return this._client.delete(`/chat/completions/${e}`,n)}};class pp extends cn{}class XB extends cn{}fp.ChatCompletionsPage=pp;fp.Messages=WN;let hp=class extends Ve{constructor(){super(...arguments),this.completions=new fp(this._client)}};hp.Completions=fp;hp.ChatCompletionsPage=pp;class ZN extends Ve{create(e,n){return this._client.post("/audio/speech",{body:e,...n,headers:{Accept:"application/octet-stream",...n==null?void 0:n.headers},__binaryResponse:!0})}}class XN extends Ve{create(e,n){return this._client.post("/audio/transcriptions",ki({body:e,...n,stream:e.stream??!1,__metadata:{model:e.model}}))}}class QN extends Ve{create(e,n){return this._client.post("/audio/translations",ki({body:e,...n,__metadata:{model:e.model}}))}}class ac extends Ve{constructor(){super(...arguments),this.transcriptions=new XN(this._client),this.translations=new QN(this._client),this.speech=new ZN(this._client)}}ac.Transcriptions=XN;ac.Translations=QN;ac.Speech=ZN;class T0 extends Ve{create(e,n){return this._client.post("/batches",{body:e,...n})}retrieve(e,n){return this._client.get(`/batches/${e}`,n)}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/batches",A0,{query:e,...n})}cancel(e,n){return this._client.post(`/batches/${e}/cancel`,n)}}class A0 extends cn{}T0.BatchesPage=A0;var Or=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},$t=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},h_,ff,pf,mu,gu,hf,yu,Os,_u,Nf,Pf,Po,e1;class E0{constructor(){h_.add(this),this.controller=new AbortController,ff.set(this,void 0),pf.set(this,()=>{}),mu.set(this,()=>{}),gu.set(this,void 0),hf.set(this,()=>{}),yu.set(this,()=>{}),Os.set(this,{}),_u.set(this,!1),Nf.set(this,!1),Pf.set(this,!1),Po.set(this,!1),Or(this,ff,new Promise((e,n)=>{Or(this,pf,e,"f"),Or(this,mu,n,"f")}),"f"),Or(this,gu,new Promise((e,n)=>{Or(this,hf,e,"f"),Or(this,yu,n,"f")}),"f"),$t(this,ff,"f").catch(()=>{}),$t(this,gu,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},$t(this,h_,"m",e1).bind(this))},0)}_connected(){this.ended||($t(this,pf,"f").call(this),this._emit("connect"))}get ended(){return $t(this,_u,"f")}get errored(){return $t(this,Nf,"f")}get aborted(){return $t(this,Pf,"f")}abort(){this.controller.abort()}on(e,n){return($t(this,Os,"f")[e]||($t(this,Os,"f")[e]=[])).push({listener:n}),this}off(e,n){const r=$t(this,Os,"f")[e];if(!r)return this;const s=r.findIndex(a=>a.listener===n);return s>=0&&r.splice(s,1),this}once(e,n){return($t(this,Os,"f")[e]||($t(this,Os,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,r)=>{Or(this,Po,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,n)})}async done(){Or(this,Po,!0,"f"),await $t(this,gu,"f")}_emit(e,...n){if($t(this,_u,"f"))return;e==="end"&&(Or(this,_u,!0,"f"),$t(this,hf,"f").call(this));const r=$t(this,Os,"f")[e];if(r&&($t(this,Os,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...n))),e==="abort"){const s=n[0];!$t(this,Po,"f")&&!(r!=null&&r.length)&&Promise.reject(s),$t(this,mu,"f").call(this,s),$t(this,yu,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=n[0];!$t(this,Po,"f")&&!(r!=null&&r.length)&&Promise.reject(s),$t(this,mu,"f").call(this,s),$t(this,yu,"f").call(this,s),this._emit("end")}}_emitFinal(){}}ff=new WeakMap,pf=new WeakMap,mu=new WeakMap,gu=new WeakMap,hf=new WeakMap,yu=new WeakMap,Os=new WeakMap,_u=new WeakMap,Nf=new WeakMap,Pf=new WeakMap,Po=new WeakMap,h_=new WeakSet,e1=function(e){if(Or(this,Nf,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Sr),e instanceof Sr)return Or(this,Pf,!0,"f"),this._emit("abort",e);if(e instanceof He)return this._emit("error",e);if(e instanceof Error){const n=new He(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new He(String(e)))};var $e=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},nr=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Tn,m_,ns,mf,Lr,Ti,Lo,Si,Mf,ar,gf,yf,Iu,vu,wu,zA,jA,VA,JA,YA,KA,WA;class Fr extends E0{constructor(){super(...arguments),Tn.add(this),m_.set(this,[]),ns.set(this,{}),mf.set(this,{}),Lr.set(this,void 0),Ti.set(this,void 0),Lo.set(this,void 0),Si.set(this,void 0),Mf.set(this,void 0),ar.set(this,void 0),gf.set(this,void 0),yf.set(this,void 0),Iu.set(this,void 0)}[(m_=new WeakMap,ns=new WeakMap,mf=new WeakMap,Lr=new WeakMap,Ti=new WeakMap,Lo=new WeakMap,Si=new WeakMap,Mf=new WeakMap,ar=new WeakMap,gf=new WeakMap,yf=new WeakMap,Iu=new WeakMap,Tn=new WeakSet,Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,o)=>n.push({resolve:a,reject:o})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const n=new Fr;return n._run(()=>n._fromReadableStream(e)),n}async _fromReadableStream(e,n){var a;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=as.fromReadableStream(e,this.controller);for await(const o of s)$e(this,Tn,"m",vu).call(this,o);if((a=s.controller.signal)!=null&&a.aborted)throw new Sr;return this._addRun($e(this,Tn,"m",wu).call(this))}toReadableStream(){return new as(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,n,r,s,a){const o=new Fr;return o._run(()=>o._runToolAssistantStream(e,n,r,s,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),o}async _createToolAssistantStream(e,n,r,s,a){var c;const o=a==null?void 0:a.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort()));const u={...s,stream:!0},d=await e.submitToolOutputs(n,r,u,{...a,signal:this.controller.signal});this._connected();for await(const p of d)$e(this,Tn,"m",vu).call(this,p);if((c=d.controller.signal)!=null&&c.aborted)throw new Sr;return this._addRun($e(this,Tn,"m",wu).call(this))}static createThreadAssistantStream(e,n,r){const s=new Fr;return s._run(()=>s._threadAssistantStream(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,n,r,s){const a=new Fr;return a._run(()=>a._runAssistantStream(e,n,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return $e(this,gf,"f")}currentRun(){return $e(this,yf,"f")}currentMessageSnapshot(){return $e(this,Lr,"f")}currentRunStepSnapshot(){return $e(this,Iu,"f")}async finalRunSteps(){return await this.done(),Object.values($e(this,ns,"f"))}async finalMessages(){return await this.done(),Object.values($e(this,mf,"f"))}async finalRun(){if(await this.done(),!$e(this,Ti,"f"))throw Error("Final run was not received.");return $e(this,Ti,"f")}async _createThreadAssistantStream(e,n,r){var u;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.createAndRun(a,{...r,signal:this.controller.signal});this._connected();for await(const d of o)$e(this,Tn,"m",vu).call(this,d);if((u=o.controller.signal)!=null&&u.aborted)throw new Sr;return this._addRun($e(this,Tn,"m",wu).call(this))}async _createAssistantStream(e,n,r,s){var d;const a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const o={...r,stream:!0},u=await e.create(n,o,{...s,signal:this.controller.signal});this._connected();for await(const c of u)$e(this,Tn,"m",vu).call(this,c);if((d=u.controller.signal)!=null&&d.aborted)throw new Sr;return this._addRun($e(this,Tn,"m",wu).call(this))}static accumulateDelta(e,n){for(const[r,s]of Object.entries(n)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let a=e[r];if(a==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof a=="string"&&typeof s=="string")a+=s;else if(typeof a=="number"&&typeof s=="number")a+=s;else if(dg(a)&&dg(s))a=this.accumulateDelta(a,s);else if(Array.isArray(a)&&Array.isArray(s)){if(a.every(o=>typeof o=="string"||typeof o=="number")){a.push(...s);continue}for(const o of s){if(!dg(o))throw new Error(`Expected array delta entry to be an object but got: ${o}`);const u=o.index;if(u==null)throw console.error(o),new Error("Expected array delta entry to have an `index` property");if(typeof u!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${u}`);const d=a[u];d==null?a.push(o):a[u]=this.accumulateDelta(d,o)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${a}`);e[r]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,n,r){return await this._createThreadAssistantStream(n,e,r)}async _runAssistantStream(e,n,r,s){return await this._createAssistantStream(n,e,r,s)}async _runToolAssistantStream(e,n,r,s,a){return await this._createToolAssistantStream(r,e,n,s,a)}}vu=function(e){if(!this.ended)switch(nr(this,gf,e,"f"),$e(this,Tn,"m",VA).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":$e(this,Tn,"m",WA).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":$e(this,Tn,"m",jA).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":$e(this,Tn,"m",zA).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},wu=function(){if(this.ended)throw new He("stream has ended, this shouldn't happen");if(!$e(this,Ti,"f"))throw Error("Final run has not been received");return $e(this,Ti,"f")},zA=function(e){const[n,r]=$e(this,Tn,"m",YA).call(this,e,$e(this,Lr,"f"));nr(this,Lr,n,"f"),$e(this,mf,"f")[n.id]=n;for(const s of r){const a=n.content[s.index];(a==null?void 0:a.type)=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,n),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let a=s.text,o=n.content[s.index];if(o&&o.type=="text")this._emit("textDelta",a,o.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=$e(this,Lo,"f")){if($e(this,Si,"f"))switch($e(this,Si,"f").type){case"text":this._emit("textDone",$e(this,Si,"f").text,$e(this,Lr,"f"));break;case"image_file":this._emit("imageFileDone",$e(this,Si,"f").image_file,$e(this,Lr,"f"));break}nr(this,Lo,s.index,"f")}nr(this,Si,n.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if($e(this,Lo,"f")!==void 0){const s=e.data.content[$e(this,Lo,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,$e(this,Lr,"f"));break;case"text":this._emit("textDone",s.text,$e(this,Lr,"f"));break}}$e(this,Lr,"f")&&this._emit("messageDone",e.data),nr(this,Lr,void 0,"f")}},jA=function(e){const n=$e(this,Tn,"m",JA).call(this,e);switch(nr(this,Iu,n,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&n.step_details.type=="tool_calls")for(const a of r.step_details.tool_calls)a.index==$e(this,Mf,"f")?this._emit("toolCallDelta",a,n.step_details.tool_calls[a.index]):($e(this,ar,"f")&&this._emit("toolCallDone",$e(this,ar,"f")),nr(this,Mf,a.index,"f"),nr(this,ar,n.step_details.tool_calls[a.index],"f"),$e(this,ar,"f")&&this._emit("toolCallCreated",$e(this,ar,"f")));this._emit("runStepDelta",e.data.delta,n);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":nr(this,Iu,void 0,"f"),e.data.step_details.type=="tool_calls"&&$e(this,ar,"f")&&(this._emit("toolCallDone",$e(this,ar,"f")),nr(this,ar,void 0,"f")),this._emit("runStepDone",e.data,n);break}},VA=function(e){$e(this,m_,"f").push(e),this._emit("event",e)},JA=function(e){switch(e.event){case"thread.run.step.created":return $e(this,ns,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let n=$e(this,ns,"f")[e.data.id];if(!n)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const s=Fr.accumulateDelta(n,r.delta);$e(this,ns,"f")[e.data.id]=s}return $e(this,ns,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":$e(this,ns,"f")[e.data.id]=e.data;break}if($e(this,ns,"f")[e.data.id])return $e(this,ns,"f")[e.data.id];throw new Error("No snapshot available")},YA=function(e,n){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!n)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const a of s.delta.content)if(a.index in n.content){let o=n.content[a.index];n.content[a.index]=$e(this,Tn,"m",KA).call(this,a,o)}else n.content[a.index]=a,r.push(a);return[n,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(n)return[n,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},KA=function(e,n){return Fr.accumulateDelta(n,e)},WA=function(e){switch(nr(this,yf,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":nr(this,Ti,e.data,"f"),$e(this,ar,"f")&&(this._emit("toolCallDone",$e(this,ar,"f")),nr(this,ar,void 0,"f"));break}};class C0 extends Ve{create(e,n){return this._client.post("/assistants",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/assistants/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/assistants/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/assistants",I0,{query:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,n){return this._client.delete(`/assistants/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class I0 extends cn{}C0.AssistantsPage=I0;function ZA(t){return typeof t.parse=="function"}const Vo=t=>(t==null?void 0:t.role)==="assistant",t1=t=>(t==null?void 0:t.role)==="function",n1=t=>(t==null?void 0:t.role)==="tool";function R0(t){return(t==null?void 0:t.$brand)==="auto-parseable-response-format"}function ic(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function QB(t,e){return!e||!r1(e)?{...t,choices:t.choices.map(n=>({...n,message:{...n.message,parsed:null,...n.message.tool_calls?{tool_calls:n.message.tool_calls}:void 0}}))}:N0(t,e)}function N0(t,e){const n=t.choices.map(r=>{var s;if(r.finish_reason==="length")throw new UN;if(r.finish_reason==="content_filter")throw new FN;return{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:((s=r.message.tool_calls)==null?void 0:s.map(a=>tq(e,a)))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?eq(e,r.message.content):null}}});return{...t,choices:n}}function eq(t,e){var n,r;return((n=t.response_format)==null?void 0:n.type)!=="json_schema"?null:((r=t.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function tq(t,e){var r;const n=(r=t.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:ic(n)?n.$parseRaw(e.function.arguments):n!=null&&n.function.strict?JSON.parse(e.function.arguments):null}}}function nq(t,e){var r;if(!t)return!1;const n=(r=t.tools)==null?void 0:r.find(s=>{var a;return((a=s.function)==null?void 0:a.name)===e.function.name});return ic(n)||(n==null?void 0:n.function.strict)||!1}function r1(t){var e;return R0(t.response_format)?!0:((e=t.tools)==null?void 0:e.some(n=>ic(n)||n.type==="function"&&n.function.strict===!0))??!1}function rq(t){for(const e of t??[]){if(e.type!=="function")throw new He(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new He(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var jn=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},Cn,g_,kf,y_,__,v_,s1,w_;const XA=10;class a1 extends E0{constructor(){super(...arguments),Cn.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const n=(r=e.choices[0])==null?void 0:r.message;return n&&this._addMessage(n),e}_addMessage(e,n=!0){if("content"in e||(e.content=null),this.messages.push(e),n){if(this._emit("message",e),(t1(e)||n1(e))&&e.content)this._emit("functionCallResult",e.content);else if(Vo(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Vo(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new He("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),jn(this,Cn,"m",g_).call(this)}async finalMessage(){return await this.done(),jn(this,Cn,"m",kf).call(this)}async finalFunctionCall(){return await this.done(),jn(this,Cn,"m",y_).call(this)}async finalFunctionCallResult(){return await this.done(),jn(this,Cn,"m",__).call(this)}async totalUsage(){return await this.done(),jn(this,Cn,"m",v_).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const n=jn(this,Cn,"m",kf).call(this);n&&this._emit("finalMessage",n);const r=jn(this,Cn,"m",g_).call(this);r&&this._emit("finalContent",r);const s=jn(this,Cn,"m",y_).call(this);s&&this._emit("finalFunctionCall",s);const a=jn(this,Cn,"m",__).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(o=>o.usage)&&this._emit("totalUsage",jn(this,Cn,"m",v_).call(this))}async _createChatCompletion(e,n,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),jn(this,Cn,"m",s1).call(this,n);const a=await e.chat.completions.create({...n,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(N0(a,n))}async _runChatCompletion(e,n,r){for(const s of n.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,n,r)}async _runFunctions(e,n,r){var y;const s="function",{function_call:a="auto",stream:o,...u}=n,d=typeof a!="string"&&(a==null?void 0:a.name),{maxChatCompletions:c=XA}=r||{},p={};for(const w of n.functions)p[w.name||w.function.name]=w;const m=n.functions.map(w=>({name:w.name||w.function.name,parameters:w.parameters,description:w.description}));for(const w of n.messages)this._addMessage(w,!1);for(let w=0;w<c;++w){const A=(y=(await this._createChatCompletion(e,{...u,function_call:a,functions:m,messages:[...this.messages]},r)).choices[0])==null?void 0:y.message;if(!A)throw new He("missing message in ChatCompletion response");if(!A.function_call)return;const{name:E,arguments:C}=A.function_call,D=p[E];if(D){if(d&&d!==E){const M=`Invalid function_call: ${JSON.stringify(E)}. ${JSON.stringify(d)} requested. Please try again`;this._addMessage({role:s,name:E,content:M});continue}}else{const M=`Invalid function_call: ${JSON.stringify(E)}. Available options are: ${m.map(N=>JSON.stringify(N.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:E,content:M});continue}let O;try{O=ZA(D)?await D.parse(C):C}catch(M){this._addMessage({role:s,name:E,content:M instanceof Error?M.message:String(M)});continue}const T=await D.function(O,this),I=jn(this,Cn,"m",w_).call(this,T);if(this._addMessage({role:s,name:E,content:I}),d)return}}async _runTools(e,n,r){var w,x,A;const s="tool",{tool_choice:a="auto",stream:o,...u}=n,d=typeof a!="string"&&((w=a==null?void 0:a.function)==null?void 0:w.name),{maxChatCompletions:c=XA}=r||{},p=n.tools.map(E=>{if(ic(E)){if(!E.$callback)throw new He("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:E.$callback,name:E.function.name,description:E.function.description||"",parameters:E.function.parameters,parse:E.$parseRaw,strict:!0}}}return E}),m={};for(const E of p)E.type==="function"&&(m[E.function.name||E.function.function.name]=E.function);const y="tools"in n?p.map(E=>E.type==="function"?{type:"function",function:{name:E.function.name||E.function.function.name,parameters:E.function.parameters,description:E.function.description,strict:E.function.strict}}:E):void 0;for(const E of n.messages)this._addMessage(E,!1);for(let E=0;E<c;++E){const D=(x=(await this._createChatCompletion(e,{...u,tool_choice:a,tools:y,messages:[...this.messages]},r)).choices[0])==null?void 0:x.message;if(!D)throw new He("missing message in ChatCompletion response");if(!((A=D.tool_calls)!=null&&A.length))return;for(const O of D.tool_calls){if(O.type!=="function")continue;const T=O.id,{name:I,arguments:M}=O.function,N=m[I];if(N){if(d&&d!==I){const U=`Invalid tool_call: ${JSON.stringify(I)}. ${JSON.stringify(d)} requested. Please try again`;this._addMessage({role:s,tool_call_id:T,content:U});continue}}else{const U=`Invalid tool_call: ${JSON.stringify(I)}. Available options are: ${Object.keys(m).map(F=>JSON.stringify(F)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:T,content:U});continue}let P;try{P=ZA(N)?await N.parse(M):M}catch(U){const F=U instanceof Error?U.message:String(U);this._addMessage({role:s,tool_call_id:T,content:F});continue}const k=await N.function(P,this),$=jn(this,Cn,"m",w_).call(this,k);if(this._addMessage({role:s,tool_call_id:T,content:$}),d)return}}}}Cn=new WeakSet,g_=function(){return jn(this,Cn,"m",kf).call(this).content??null},kf=function(){let e=this.messages.length;for(;e-- >0;){const n=this.messages[e];if(Vo(n)){const{function_call:r,...s}=n,a={...s,content:n.content??null,refusal:n.refusal??null};return r&&(a.function_call=r),a}}throw new He("stream ended without producing a ChatCompletionMessage with role=assistant")},y_=function(){var e,n;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(Vo(s)&&(s!=null&&s.function_call))return s.function_call;if(Vo(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(n=s.tool_calls.at(-1))==null?void 0:n.function}},__=function(){for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];if(t1(n)&&n.content!=null||n1(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(a=>a.type==="function"&&a.id===n.tool_call_id))}))return n.content}},v_=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:n}of this._chatCompletions)n&&(e.completion_tokens+=n.completion_tokens,e.prompt_tokens+=n.prompt_tokens,e.total_tokens+=n.total_tokens);return e},s1=function(e){if(e.n!=null&&e.n>1)throw new He("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},w_=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Uu extends a1{static runFunctions(e,n,r){const s=new Uu,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,n,a)),s}static runTools(e,n,r){const s=new Uu,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,a)),s}_addMessage(e,n=!0){super._addMessage(e,n),Vo(e)&&e.content&&this._emit("content",e.content)}}const i1=1,o1=2,l1=4,u1=8,c1=16,d1=32,f1=64,p1=128,h1=256,m1=p1|h1,g1=c1|d1|m1|f1,y1=i1|o1|g1,_1=l1|u1,sq=y1|_1,mn={STR:i1,NUM:o1,ARR:l1,OBJ:u1,NULL:c1,BOOL:d1,NAN:f1,INFINITY:p1,MINUS_INFINITY:h1,INF:m1,SPECIAL:g1,ATOM:y1,COLLECTION:_1,ALL:sq};class aq extends Error{}class iq extends Error{}function oq(t,e=mn.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return lq(t.trim(),e)}const lq=(t,e)=>{const n=t.length;let r=0;const s=y=>{throw new aq(`${y} at position ${r}`)},a=y=>{throw new iq(`${y} at position ${r}`)},o=()=>(m(),r>=n&&s("Unexpected end of input"),t[r]==='"'?u():t[r]==="{"?d():t[r]==="["?c():t.substring(r,r+4)==="null"||mn.NULL&e&&n-r<4&&"null".startsWith(t.substring(r))?(r+=4,null):t.substring(r,r+4)==="true"||mn.BOOL&e&&n-r<4&&"true".startsWith(t.substring(r))?(r+=4,!0):t.substring(r,r+5)==="false"||mn.BOOL&e&&n-r<5&&"false".startsWith(t.substring(r))?(r+=5,!1):t.substring(r,r+8)==="Infinity"||mn.INFINITY&e&&n-r<8&&"Infinity".startsWith(t.substring(r))?(r+=8,1/0):t.substring(r,r+9)==="-Infinity"||mn.MINUS_INFINITY&e&&1<n-r&&n-r<9&&"-Infinity".startsWith(t.substring(r))?(r+=9,-1/0):t.substring(r,r+3)==="NaN"||mn.NAN&e&&n-r<3&&"NaN".startsWith(t.substring(r))?(r+=3,NaN):p()),u=()=>{const y=r;let w=!1;for(r++;r<n&&(t[r]!=='"'||w&&t[r-1]==="\\");)w=t[r]==="\\"?!w:!1,r++;if(t.charAt(r)=='"')try{return JSON.parse(t.substring(y,++r-Number(w)))}catch(x){a(String(x))}else if(mn.STR&e)try{return JSON.parse(t.substring(y,r-Number(w))+'"')}catch{return JSON.parse(t.substring(y,t.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},d=()=>{r++,m();const y={};try{for(;t[r]!=="}";){if(m(),r>=n&&mn.OBJ&e)return y;const w=u();m(),r++;try{const x=o();Object.defineProperty(y,w,{value:x,writable:!0,enumerable:!0,configurable:!0})}catch(x){if(mn.OBJ&e)return y;throw x}m(),t[r]===","&&r++}}catch{if(mn.OBJ&e)return y;s("Expected '}' at end of object")}return r++,y},c=()=>{r++;const y=[];try{for(;t[r]!=="]";)y.push(o()),m(),t[r]===","&&r++}catch{if(mn.ARR&e)return y;s("Expected ']' at end of array")}return r++,y},p=()=>{if(r===0){t==="-"&&mn.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t)}catch(w){if(mn.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}a(String(w))}}const y=r;for(t[r]==="-"&&r++;t[r]&&!",]}".includes(t[r]);)r++;r==n&&!(mn.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(t.substring(y,r))}catch{t.substring(y,r)==="-"&&mn.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(t.substring(y,t.lastIndexOf("e")))}catch(x){a(String(x))}}},m=()=>{for(;r<n&&` 
\r	`.includes(t[r]);)r++};return o()},QA=t=>oq(t,mn.ALL^mn.NUM);var Eo=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},At=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},on,Ms,Co,Aa,fg,Hd,pg,hg,mg,zd,gg,eE;class Fu extends a1{constructor(e){super(),on.add(this),Ms.set(this,void 0),Co.set(this,void 0),Aa.set(this,void 0),Eo(this,Ms,e,"f"),Eo(this,Co,[],"f")}get currentChatCompletionSnapshot(){return At(this,Aa,"f")}static fromReadableStream(e){const n=new Fu(null);return n._run(()=>n._fromReadableStream(e)),n}static createChatCompletion(e,n,r){const s=new Fu(n);return s._run(()=>s._runChatCompletion(e,{...n,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,n,r){var o;super._createChatCompletion;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),At(this,on,"m",fg).call(this);const a=await e.chat.completions.create({...n,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const u of a)At(this,on,"m",pg).call(this,u);if((o=a.controller.signal)!=null&&o.aborted)throw new Sr;return this._addChatCompletion(At(this,on,"m",zd).call(this))}async _fromReadableStream(e,n){var o;const r=n==null?void 0:n.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),At(this,on,"m",fg).call(this),this._connected();const s=as.fromReadableStream(e,this.controller);let a;for await(const u of s)a&&a!==u.id&&this._addChatCompletion(At(this,on,"m",zd).call(this)),At(this,on,"m",pg).call(this,u),a=u.id;if((o=s.controller.signal)!=null&&o.aborted)throw new Sr;return this._addChatCompletion(At(this,on,"m",zd).call(this))}[(Ms=new WeakMap,Co=new WeakMap,Aa=new WeakMap,on=new WeakSet,fg=function(){this.ended||Eo(this,Aa,void 0,"f")},Hd=function(n){let r=At(this,Co,"f")[n.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},At(this,Co,"f")[n.index]=r,r)},pg=function(n){var s,a,o,u,d,c,p,m,y,w,x,A,E,C,D;if(this.ended)return;const r=At(this,on,"m",eE).call(this,n);this._emit("chunk",n,r);for(const O of n.choices){const T=r.choices[O.index];O.delta.content!=null&&((s=T.message)==null?void 0:s.role)==="assistant"&&((a=T.message)!=null&&a.content)&&(this._emit("content",O.delta.content,T.message.content),this._emit("content.delta",{delta:O.delta.content,snapshot:T.message.content,parsed:T.message.parsed})),O.delta.refusal!=null&&((o=T.message)==null?void 0:o.role)==="assistant"&&((u=T.message)!=null&&u.refusal)&&this._emit("refusal.delta",{delta:O.delta.refusal,snapshot:T.message.refusal}),((d=O.logprobs)==null?void 0:d.content)!=null&&((c=T.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(p=O.logprobs)==null?void 0:p.content,snapshot:((m=T.logprobs)==null?void 0:m.content)??[]}),((y=O.logprobs)==null?void 0:y.refusal)!=null&&((w=T.message)==null?void 0:w.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(x=O.logprobs)==null?void 0:x.refusal,snapshot:((A=T.logprobs)==null?void 0:A.refusal)??[]});const I=At(this,on,"m",Hd).call(this,T);T.finish_reason&&(At(this,on,"m",mg).call(this,T),I.current_tool_call_index!=null&&At(this,on,"m",hg).call(this,T,I.current_tool_call_index));for(const M of O.delta.tool_calls??[])I.current_tool_call_index!==M.index&&(At(this,on,"m",mg).call(this,T),I.current_tool_call_index!=null&&At(this,on,"m",hg).call(this,T,I.current_tool_call_index)),I.current_tool_call_index=M.index;for(const M of O.delta.tool_calls??[]){const N=(E=T.message.tool_calls)==null?void 0:E[M.index];N!=null&&N.type&&((N==null?void 0:N.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(C=N.function)==null?void 0:C.name,index:M.index,arguments:N.function.arguments,parsed_arguments:N.function.parsed_arguments,arguments_delta:((D=M.function)==null?void 0:D.arguments)??""}):(N==null||N.type,void 0))}}},hg=function(n,r){var o,u,d;if(At(this,on,"m",Hd).call(this,n).done_tool_calls.has(r))return;const a=(o=n.message.tool_calls)==null?void 0:o[r];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const c=(d=(u=At(this,Ms,"f"))==null?void 0:u.tools)==null?void 0:d.find(p=>p.type==="function"&&p.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:r,arguments:a.function.arguments,parsed_arguments:ic(c)?c.$parseRaw(a.function.arguments):c!=null&&c.function.strict?JSON.parse(a.function.arguments):null})}else a.type},mg=function(n){var s,a;const r=At(this,on,"m",Hd).call(this,n);if(n.message.content&&!r.content_done){r.content_done=!0;const o=At(this,on,"m",gg).call(this);this._emit("content.done",{content:n.message.content,parsed:o?o.$parseRaw(n.message.content):null})}n.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:n.message.refusal})),(s=n.logprobs)!=null&&s.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:n.logprobs.content})),(a=n.logprobs)!=null&&a.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:n.logprobs.refusal}))},zd=function(){if(this.ended)throw new He("stream has ended, this shouldn't happen");const n=At(this,Aa,"f");if(!n)throw new He("request ended without sending any chunks");return Eo(this,Aa,void 0,"f"),Eo(this,Co,[],"f"),uq(n,At(this,Ms,"f"))},gg=function(){var r;const n=(r=At(this,Ms,"f"))==null?void 0:r.response_format;return R0(n)?n:null},eE=function(n){var r,s,a,o;let u=At(this,Aa,"f");const{choices:d,...c}=n;u?Object.assign(u,c):u=Eo(this,Aa,{...c,choices:[]},"f");for(const{delta:p,finish_reason:m,index:y,logprobs:w=null,...x}of n.choices){let A=u.choices[y];if(A||(A=u.choices[y]={finish_reason:m,index:y,message:{},logprobs:w,...x}),w)if(!A.logprobs)A.logprobs=Object.assign({},w);else{const{content:M,refusal:N,...P}=w;Object.assign(A.logprobs,P),M&&((r=A.logprobs).content??(r.content=[]),A.logprobs.content.push(...M)),N&&((s=A.logprobs).refusal??(s.refusal=[]),A.logprobs.refusal.push(...N))}if(m&&(A.finish_reason=m,At(this,Ms,"f")&&r1(At(this,Ms,"f")))){if(m==="length")throw new UN;if(m==="content_filter")throw new FN}if(Object.assign(A,x),!p)continue;const{content:E,refusal:C,function_call:D,role:O,tool_calls:T,...I}=p;if(Object.assign(A.message,I),C&&(A.message.refusal=(A.message.refusal||"")+C),O&&(A.message.role=O),D&&(A.message.function_call?(D.name&&(A.message.function_call.name=D.name),D.arguments&&((a=A.message.function_call).arguments??(a.arguments=""),A.message.function_call.arguments+=D.arguments)):A.message.function_call=D),E&&(A.message.content=(A.message.content||"")+E,!A.message.refusal&&At(this,on,"m",gg).call(this)&&(A.message.parsed=QA(A.message.content))),T){A.message.tool_calls||(A.message.tool_calls=[]);for(const{index:M,id:N,type:P,function:k,...$}of T){const U=(o=A.message.tool_calls)[M]??(o[M]={});Object.assign(U,$),N&&(U.id=N),P&&(U.type=P),k&&(U.function??(U.function={name:k.name??"",arguments:""})),k!=null&&k.name&&(U.function.name=k.name),k!=null&&k.arguments&&(U.function.arguments+=k.arguments,nq(At(this,Ms,"f"),U)&&(U.function.parsed_arguments=QA(U.function.arguments)))}}}return u},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("chunk",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,o)=>n.push({resolve:a,reject:o})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new as(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function uq(t,e){const{id:n,choices:r,created:s,model:a,system_fingerprint:o,...u}=t,d={...u,id:n,choices:r.map(({message:c,finish_reason:p,index:m,logprobs:y,...w})=>{if(!p)throw new He(`missing finish_reason for choice ${m}`);const{content:x=null,function_call:A,tool_calls:E,...C}=c,D=c.role;if(!D)throw new He(`missing role for choice ${m}`);if(A){const{arguments:O,name:T}=A;if(O==null)throw new He(`missing function_call.arguments for choice ${m}`);if(!T)throw new He(`missing function_call.name for choice ${m}`);return{...w,message:{content:x,function_call:{arguments:O,name:T},role:D,refusal:c.refusal??null},finish_reason:p,index:m,logprobs:y}}return E?{...w,index:m,finish_reason:p,logprobs:y,message:{...C,role:D,content:x,refusal:c.refusal??null,tool_calls:E.map((O,T)=>{const{function:I,type:M,id:N,...P}=O,{arguments:k,name:$,...U}=I||{};if(N==null)throw new He(`missing choices[${m}].tool_calls[${T}].id
${jd(t)}`);if(M==null)throw new He(`missing choices[${m}].tool_calls[${T}].type
${jd(t)}`);if($==null)throw new He(`missing choices[${m}].tool_calls[${T}].function.name
${jd(t)}`);if(k==null)throw new He(`missing choices[${m}].tool_calls[${T}].function.arguments
${jd(t)}`);return{...P,id:N,type:M,function:{...U,name:$,arguments:k}}})}}:{...w,message:{...C,content:x,role:D,refusal:c.refusal??null},finish_reason:p,index:m,logprobs:y}}),created:s,model:a,object:"chat.completion",...o?{system_fingerprint:o}:{}};return QB(d,e)}function jd(t){return JSON.stringify(t)}class Jo extends Fu{static fromReadableStream(e){const n=new Jo(null);return n._run(()=>n._fromReadableStream(e)),n}static runFunctions(e,n,r){const s=new Jo(null),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,n,a)),s}static runTools(e,n,r){const s=new Jo(n),a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,n,a)),s}}let v1=class extends Ve{parse(e,n){return rq(e.tools),this._client.chat.completions.create(e,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>N0(r,e))}runFunctions(e,n){return e.stream?Jo.runFunctions(this._client,e,n):Uu.runFunctions(this._client,e,n)}runTools(e,n){return e.stream?Jo.runTools(this._client,e,n):Uu.runTools(this._client,e,n)}stream(e,n){return Fu.createChatCompletion(this._client,e,n)}};class b_ extends Ve{constructor(){super(...arguments),this.completions=new v1(this._client)}}(function(t){t.Completions=v1})(b_||(b_={}));class w1 extends Ve{create(e,n){return this._client.post("/realtime/sessions",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class b1 extends Ve{create(e,n){return this._client.post("/realtime/transcription_sessions",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}}class mp extends Ve{constructor(){super(...arguments),this.sessions=new w1(this._client),this.transcriptionSessions=new b1(this._client)}}mp.Sessions=w1;mp.TranscriptionSessions=b1;class P0 extends Ve{create(e,n,r){return this._client.post(`/threads/${e}/messages`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/threads/${e}/messages/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,n,r,s){return this._client.post(`/threads/${e}/messages/${n}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/threads/${e}/messages`,M0,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n,r){return this._client.delete(`/threads/${e}/messages/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class M0 extends cn{}P0.MessagesPage=M0;class k0 extends Ve{retrieve(e,n,r,s={},a){return Ut(s)?this.retrieve(e,n,r,{},s):this._client.get(`/threads/${e}/runs/${n}/steps/${r}`,{query:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,n,r={},s){return Ut(r)?this.list(e,n,{},r):this._client.getAPIList(`/threads/${e}/runs/${n}/steps`,O0,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}}class O0 extends cn{}k0.RunStepsPage=O0;let oc=class extends Ve{constructor(){super(...arguments),this.steps=new k0(this._client)}create(e,n,r){const{include:s,...a}=n;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:n.stream??!1})}retrieve(e,n,r){return this._client.get(`/threads/${e}/runs/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,n,r,s){return this._client.post(`/threads/${e}/runs/${n}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/threads/${e}/runs`,D0,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,n,r){return this._client.post(`/threads/${e}/runs/${n}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}createAndStream(e,n,r){return Fr.createAssistantStream(e,this._client.beta.threads.runs,n,r)}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:o}=await this.retrieve(e,n,{...r,headers:{...r==null?void 0:r.headers,...s}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let u=5e3;if(r!=null&&r.pollIntervalMs)u=r.pollIntervalMs;else{const d=o.headers.get("openai-poll-after-ms");if(d){const c=parseInt(d);isNaN(c)||(u=c)}}await sc(u);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,n,r){return Fr.createAssistantStream(e,this._client.beta.threads.runs,n,r)}submitToolOutputs(e,n,r,s){return this._client.post(`/threads/${e}/runs/${n}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,n,r,s){const a=await this.submitToolOutputs(e,n,r,s);return await this.poll(e,a.id,s)}submitToolOutputsStream(e,n,r,s){return Fr.createToolAssistantStream(e,n,this._client.beta.threads.runs,r,s)}};class D0 extends cn{}oc.RunsPage=D0;oc.Steps=k0;oc.RunStepsPage=O0;class ll extends Ve{constructor(){super(...arguments),this.runs=new oc(this._client),this.messages=new P0(this._client)}create(e={},n){return Ut(e)?this.create({},e):this._client.post("/threads",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/threads/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/threads/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n){return this._client.delete(`/threads/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}createAndRun(e,n){return this._client.post("/threads/runs",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers},stream:e.stream??!1})}async createAndRunPoll(e,n){const r=await this.createAndRun(e,n);return await this.runs.poll(r.thread_id,r.id,n)}createAndRunStream(e,n){return Fr.createThreadAssistantStream(e,this._client.beta.threads,n)}}ll.Runs=oc;ll.RunsPage=D0;ll.Messages=P0;ll.MessagesPage=M0;class ul extends Ve{constructor(){super(...arguments),this.realtime=new mp(this._client),this.chat=new b_(this._client),this.assistants=new C0(this._client),this.threads=new ll(this._client)}}ul.Realtime=mp;ul.Assistants=C0;ul.AssistantsPage=I0;ul.Threads=ll;class S1 extends Ve{create(e,n){return this._client.post("/completions",{body:e,...n,stream:e.stream??!1})}}class x1 extends Ve{retrieve(e,n,r){return this._client.get(`/containers/${e}/files/${n}/content`,{...r,headers:{Accept:"application/binary",...r==null?void 0:r.headers},__binaryResponse:!0})}}let gp=class extends Ve{constructor(){super(...arguments),this.content=new x1(this._client)}create(e,n,r){return this._client.post(`/containers/${e}/files`,ki({body:n,...r}))}retrieve(e,n,r){return this._client.get(`/containers/${e}/files/${n}`,r)}list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/containers/${e}/files`,L0,{query:n,...r})}del(e,n,r){return this._client.delete(`/containers/${e}/files/${n}`,{...r,headers:{Accept:"*/*",...r==null?void 0:r.headers}})}};class L0 extends cn{}gp.FileListResponsesPage=L0;gp.Content=x1;class lc extends Ve{constructor(){super(...arguments),this.files=new gp(this._client)}create(e,n){return this._client.post("/containers",{body:e,...n})}retrieve(e,n){return this._client.get(`/containers/${e}`,n)}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/containers",$0,{query:e,...n})}del(e,n){return this._client.delete(`/containers/${e}`,{...n,headers:{Accept:"*/*",...n==null?void 0:n.headers}})}}class $0 extends cn{}lc.ContainerListResponsesPage=$0;lc.Files=gp;lc.FileListResponsesPage=L0;class T1 extends Ve{create(e,n){const r=!!e.encoding_format;let s=r?e.encoding_format:"base64";r&&Da("Request","User defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:s},...n});return r?a:(Da("response","Decoding base64 embeddings to float32 array"),a._thenUnwrap(o=>(o&&o.data&&o.data.forEach(u=>{const d=u.embedding;u.embedding=ZB(d)}),o)))}}class U0 extends Ve{retrieve(e,n,r,s){return this._client.get(`/evals/${e}/runs/${n}/output_items/${r}`,s)}list(e,n,r={},s){return Ut(r)?this.list(e,n,{},r):this._client.getAPIList(`/evals/${e}/runs/${n}/output_items`,F0,{query:r,...s})}}class F0 extends cn{}U0.OutputItemListResponsesPage=F0;class uc extends Ve{constructor(){super(...arguments),this.outputItems=new U0(this._client)}create(e,n,r){return this._client.post(`/evals/${e}/runs`,{body:n,...r})}retrieve(e,n,r){return this._client.get(`/evals/${e}/runs/${n}`,r)}list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/evals/${e}/runs`,B0,{query:n,...r})}del(e,n,r){return this._client.delete(`/evals/${e}/runs/${n}`,r)}cancel(e,n,r){return this._client.post(`/evals/${e}/runs/${n}`,r)}}class B0 extends cn{}uc.RunListResponsesPage=B0;uc.OutputItems=U0;uc.OutputItemListResponsesPage=F0;class cc extends Ve{constructor(){super(...arguments),this.runs=new uc(this._client)}create(e,n){return this._client.post("/evals",{body:e,...n})}retrieve(e,n){return this._client.get(`/evals/${e}`,n)}update(e,n,r){return this._client.post(`/evals/${e}`,{body:n,...r})}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/evals",q0,{query:e,...n})}del(e,n){return this._client.delete(`/evals/${e}`,n)}}class q0 extends cn{}cc.EvalListResponsesPage=q0;cc.Runs=uc;cc.RunListResponsesPage=B0;let G0=class extends Ve{create(e,n){return this._client.post("/files",ki({body:e,...n}))}retrieve(e,n){return this._client.get(`/files/${e}`,n)}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/files",H0,{query:e,...n})}del(e,n){return this._client.delete(`/files/${e}`,n)}content(e,n){return this._client.get(`/files/${e}/content`,{...n,headers:{Accept:"application/binary",...n==null?void 0:n.headers},__binaryResponse:!0})}retrieveContent(e,n){return this._client.get(`/files/${e}/content`,n)}async waitForProcessing(e,{pollInterval:n=5e3,maxWait:r=1800*1e3}={}){const s=new Set(["processed","error","deleted"]),a=Date.now();let o=await this.retrieve(e);for(;!o.status||!s.has(o.status);)if(await sc(n),o=await this.retrieve(e),Date.now()-a>r)throw new x0({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return o}};class H0 extends cn{}G0.FileObjectsPage=H0;class A1 extends Ve{}let E1=class extends Ve{run(e,n){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...n})}validate(e,n){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...n})}};class z0 extends Ve{constructor(){super(...arguments),this.graders=new E1(this._client)}}z0.Graders=E1;class j0 extends Ve{create(e,n,r){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,V0,{body:n,method:"post",...r})}retrieve(e,n={},r){return Ut(n)?this.retrieve(e,{},n):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:n,...r})}del(e,n,r){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${n}`,r)}}class V0 extends dp{}j0.PermissionCreateResponsesPage=V0;let yp=class extends Ve{constructor(){super(...arguments),this.permissions=new j0(this._client)}};yp.Permissions=j0;yp.PermissionCreateResponsesPage=V0;class J0 extends Ve{list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Y0,{query:n,...r})}}class Y0 extends cn{}J0.FineTuningJobCheckpointsPage=Y0;class cl extends Ve{constructor(){super(...arguments),this.checkpoints=new J0(this._client)}create(e,n){return this._client.post("/fine_tuning/jobs",{body:e,...n})}retrieve(e,n){return this._client.get(`/fine_tuning/jobs/${e}`,n)}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",K0,{query:e,...n})}cancel(e,n){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,n)}listEvents(e,n={},r){return Ut(n)?this.listEvents(e,{},n):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,W0,{query:n,...r})}pause(e,n){return this._client.post(`/fine_tuning/jobs/${e}/pause`,n)}resume(e,n){return this._client.post(`/fine_tuning/jobs/${e}/resume`,n)}}class K0 extends cn{}class W0 extends cn{}cl.FineTuningJobsPage=K0;cl.FineTuningJobEventsPage=W0;cl.Checkpoints=J0;cl.FineTuningJobCheckpointsPage=Y0;class za extends Ve{constructor(){super(...arguments),this.methods=new A1(this._client),this.jobs=new cl(this._client),this.checkpoints=new yp(this._client),this.alpha=new z0(this._client)}}za.Methods=A1;za.Jobs=cl;za.FineTuningJobsPage=K0;za.FineTuningJobEventsPage=W0;za.Checkpoints=yp;za.Alpha=z0;class C1 extends Ve{}class Z0 extends Ve{constructor(){super(...arguments),this.graderModels=new C1(this._client)}}Z0.GraderModels=C1;class I1 extends Ve{createVariation(e,n){return this._client.post("/images/variations",ki({body:e,...n}))}edit(e,n){return this._client.post("/images/edits",ki({body:e,...n}))}generate(e,n){return this._client.post("/images/generations",{body:e,...n})}}class X0 extends Ve{retrieve(e,n){return this._client.get(`/models/${e}`,n)}list(e){return this._client.getAPIList("/models",Q0,e)}del(e,n){return this._client.delete(`/models/${e}`,n)}}class Q0 extends dp{}X0.ModelsPage=Q0;class R1 extends Ve{create(e,n){return this._client.post("/moderations",{body:e,...n})}}function cq(t,e){return!e||!fq(e)?{...t,output_parsed:null,output:t.output.map(n=>n.type==="function_call"?{...n,parsed_arguments:null}:n.type==="message"?{...n,content:n.content.map(r=>({...r,parsed:null}))}:n)}:N1(t,e)}function N1(t,e){const n=t.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:mq(e,s)};if(s.type==="message"){const a=s.content.map(o=>o.type==="output_text"?{...o,parsed:dq(e,o.text)}:o);return{...s,content:a}}return s}),r=Object.assign({},t,{output:n});return Object.getOwnPropertyDescriptor(t,"output_text")||P1(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const s of r.output)if(s.type==="message"){for(const a of s.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),r}function dq(t,e){var n,r,s,a;return((r=(n=t.text)==null?void 0:n.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((s=t.text)==null?void 0:s.format)?((a=t.text)==null?void 0:a.format).$parseRaw(e):JSON.parse(e)}function fq(t){var e;return!!R0((e=t.text)==null?void 0:e.format)}function pq(t){return(t==null?void 0:t.$brand)==="auto-parseable-tool"}function hq(t,e){return t.find(n=>n.type==="function"&&n.name===e)}function mq(t,e){const n=hq(t.tools??[],e.name);return{...e,...e,parsed_arguments:pq(n)?n.$parseRaw(e.arguments):n!=null&&n.strict?JSON.parse(e.arguments):null}}function P1(t){const e=[];for(const n of t.output)if(n.type==="message")for(const r of n.content)r.type==="output_text"&&e.push(r.text);t.output_text=e.join("")}class M1 extends Ve{list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/responses/${e}/input_items`,yq,{query:n,...r})}}var Io=function(t,e,n,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(t,n):s?s.value=n:e.set(t,n),n},Ea=function(t,e,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(t):r?r.value:e.get(t)},Ro,Vd,Ca,Jd,tE,nE,rE,sE;class ev extends E0{constructor(e){super(),Ro.add(this),Vd.set(this,void 0),Ca.set(this,void 0),Jd.set(this,void 0),Io(this,Vd,e,"f")}static createResponse(e,n,r){const s=new ev(n);return s._run(()=>s._createOrRetrieveResponse(e,n,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,n,r){var u;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Ea(this,Ro,"m",tE).call(this);let a,o=null;"response_id"in n?(a=await e.responses.retrieve(n.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),o=n.starting_after??null):a=await e.responses.create({...n,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(const d of a)Ea(this,Ro,"m",nE).call(this,d,o);if((u=a.controller.signal)!=null&&u.aborted)throw new Sr;return Ea(this,Ro,"m",rE).call(this)}[(Vd=new WeakMap,Ca=new WeakMap,Jd=new WeakMap,Ro=new WeakSet,tE=function(){this.ended||Io(this,Ca,void 0,"f")},nE=function(n,r){if(this.ended)return;const s=(o,u)=>{(r==null||u.sequence_number>r)&&this._emit(o,u)},a=Ea(this,Ro,"m",sE).call(this,n);switch(s("event",n),n.type){case"response.output_text.delta":{const o=a.output[n.output_index];if(!o)throw new He(`missing output at index ${n.output_index}`);if(o.type==="message"){const u=o.content[n.content_index];if(!u)throw new He(`missing content at index ${n.content_index}`);if(u.type!=="output_text")throw new He(`expected content to be 'output_text', got ${u.type}`);s("response.output_text.delta",{...n,snapshot:u.text})}break}case"response.function_call_arguments.delta":{const o=a.output[n.output_index];if(!o)throw new He(`missing output at index ${n.output_index}`);o.type==="function_call"&&s("response.function_call_arguments.delta",{...n,snapshot:o.arguments});break}default:s(n.type,n);break}},rE=function(){if(this.ended)throw new He("stream has ended, this shouldn't happen");const n=Ea(this,Ca,"f");if(!n)throw new He("request ended without sending any events");Io(this,Ca,void 0,"f");const r=gq(n,Ea(this,Vd,"f"));return Io(this,Jd,r,"f"),r},sE=function(n){let r=Ea(this,Ca,"f");if(!r){if(n.type!=="response.created")throw new He(`When snapshot hasn't been set yet, expected 'response.created' event, got ${n.type}`);return r=Io(this,Ca,n.response,"f"),r}switch(n.type){case"response.output_item.added":{r.output.push(n.item);break}case"response.content_part.added":{const s=r.output[n.output_index];if(!s)throw new He(`missing output at index ${n.output_index}`);s.type==="message"&&s.content.push(n.part);break}case"response.output_text.delta":{const s=r.output[n.output_index];if(!s)throw new He(`missing output at index ${n.output_index}`);if(s.type==="message"){const a=s.content[n.content_index];if(!a)throw new He(`missing content at index ${n.content_index}`);if(a.type!=="output_text")throw new He(`expected content to be 'output_text', got ${a.type}`);a.text+=n.delta}break}case"response.function_call_arguments.delta":{const s=r.output[n.output_index];if(!s)throw new He(`missing output at index ${n.output_index}`);s.type==="function_call"&&(s.arguments+=n.delta);break}case"response.completed":{Io(this,Ca,n.response,"f");break}}return r},Symbol.asyncIterator)](){const e=[],n=[];let r=!1;return this.on("event",s=>{const a=n.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of n)s.resolve(void 0);n.length=0}),this.on("abort",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),this.on("error",s=>{r=!0;for(const a of n)a.reject(s);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,o)=>n.push({resolve:a,reject:o})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Ea(this,Jd,"f");if(!e)throw new He("stream ended without producing a ChatCompletion");return e}}function gq(t,e){return cq(t,e)}class tv extends Ve{constructor(){super(...arguments),this.inputItems=new M1(this._client)}create(e,n){return this._client.post("/responses",{body:e,...n,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&P1(r),r))}retrieve(e,n={},r){return this._client.get(`/responses/${e}`,{query:n,...r,stream:(n==null?void 0:n.stream)??!1})}del(e,n){return this._client.delete(`/responses/${e}`,{...n,headers:{Accept:"*/*",...n==null?void 0:n.headers}})}parse(e,n){return this._client.responses.create(e,n)._thenUnwrap(r=>N1(r,e))}stream(e,n){return ev.createResponse(this._client,e,n)}cancel(e,n){return this._client.post(`/responses/${e}/cancel`,{...n,headers:{Accept:"*/*",...n==null?void 0:n.headers}})}}class yq extends cn{}tv.InputItems=M1;class k1 extends Ve{create(e,n,r){return this._client.post(`/uploads/${e}/parts`,ki({body:n,...r}))}}class nv extends Ve{constructor(){super(...arguments),this.parts=new k1(this._client)}create(e,n){return this._client.post("/uploads",{body:e,...n})}cancel(e,n){return this._client.post(`/uploads/${e}/cancel`,n)}complete(e,n,r){return this._client.post(`/uploads/${e}/complete`,{body:n,...r})}}nv.Parts=k1;const _q=async t=>{const e=await Promise.allSettled(t),n=e.filter(s=>s.status==="rejected");if(n.length){for(const s of n)console.error(s.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const s of e)s.status==="fulfilled"&&r.push(s.value);return r};class _p extends Ve{create(e,n,r){return this._client.post(`/vector_stores/${e}/files`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/vector_stores/${e}/files/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,n,r,s){return this._client.post(`/vector_stores/${e}/files/${n}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,n={},r){return Ut(n)?this.list(e,{},n):this._client.getAPIList(`/vector_stores/${e}/files`,vp,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,n,r){return this._client.delete(`/vector_stores/${e}/files/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n,r);return await this.poll(e,s.id,r)}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const a=await this.retrieve(e,n,{...r,headers:s}).withResponse(),o=a.data;switch(o.status){case"in_progress":let u=5e3;if(r!=null&&r.pollIntervalMs)u=r.pollIntervalMs;else{const d=a.response.headers.get("openai-poll-after-ms");if(d){const c=parseInt(d);isNaN(c)||(u=c)}}await sc(u);break;case"failed":case"completed":return o}}}async upload(e,n,r){const s=await this._client.files.create({file:n,purpose:"assistants"},r);return this.create(e,{file_id:s.id},r)}async uploadAndPoll(e,n,r){const s=await this.upload(e,n,r);return await this.poll(e,s.id,r)}content(e,n,r){return this._client.getAPIList(`/vector_stores/${e}/files/${n}/content`,rv,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class vp extends cn{}class rv extends dp{}_p.VectorStoreFilesPage=vp;_p.FileContentResponsesPage=rv;class O1 extends Ve{create(e,n,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,n,r){return this._client.get(`/vector_stores/${e}/file_batches/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,n,r){return this._client.post(`/vector_stores/${e}/file_batches/${n}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,n,r){const s=await this.create(e,n);return await this.poll(e,s.id,r)}listFiles(e,n,r={},s){return Ut(r)?this.listFiles(e,n,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${n}/files`,vp,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}async poll(e,n,r){const s={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:o}=await this.retrieve(e,n,{...r,headers:s}).withResponse();switch(a.status){case"in_progress":let u=5e3;if(r!=null&&r.pollIntervalMs)u=r.pollIntervalMs;else{const d=o.headers.get("openai-poll-after-ms");if(d){const c=parseInt(d);isNaN(c)||(u=c)}}await sc(u);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:n,fileIds:r=[]},s){if(n==null||n.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(s==null?void 0:s.maxConcurrency)??5,o=Math.min(a,n.length),u=this._client,d=n.values(),c=[...r];async function p(y){for(let w of y){const x=await u.files.create({file:w,purpose:"assistants"},s);c.push(x.id)}}const m=Array(o).fill(d).map(p);return await _q(m),await this.createAndPoll(e,{file_ids:c})}}class ja extends Ve{constructor(){super(...arguments),this.files=new _p(this._client),this.fileBatches=new O1(this._client)}create(e,n){return this._client.post("/vector_stores",{body:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}retrieve(e,n){return this._client.get(`/vector_stores/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}update(e,n,r){return this._client.post(`/vector_stores/${e}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},n){return Ut(e)?this.list({},e):this._client.getAPIList("/vector_stores",sv,{query:e,...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}del(e,n){return this._client.delete(`/vector_stores/${e}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n==null?void 0:n.headers}})}search(e,n,r){return this._client.getAPIList(`/vector_stores/${e}/search`,av,{body:n,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class sv extends cn{}class av extends dp{}ja.VectorStoresPage=sv;ja.VectorStoreSearchResponsesPage=av;ja.Files=_p;ja.VectorStoreFilesPage=vp;ja.FileContentResponsesPage=rv;ja.FileBatches=O1;var D1;class Ze extends FB{constructor({baseURL:e=qd("OPENAI_BASE_URL"),apiKey:n=qd("OPENAI_API_KEY"),organization:r=qd("OPENAI_ORG_ID")??null,project:s=qd("OPENAI_PROJECT_ID")??null,...a}={}){if(n===void 0)throw new He("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const o={apiKey:n,organization:r,project:s,...a,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&KB())throw new He(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new S1(this),this.chat=new hp(this),this.embeddings=new T1(this),this.files=new G0(this),this.images=new I1(this),this.audio=new ac(this),this.moderations=new R1(this),this.models=new X0(this),this.fineTuning=new za(this),this.graders=new Z0(this),this.vectorStores=new ja(this),this.beta=new ul(this),this.batches=new T0(this),this.uploads=new nv(this),this.responses=new tv(this),this.evals=new cc(this),this.containers=new lc(this),this._options=o,this.apiKey=n,this.organization=r,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return bB(e,{arrayFormat:"brackets"})}}D1=Ze;Ze.OpenAI=D1;Ze.DEFAULT_TIMEOUT=6e5;Ze.OpenAIError=He;Ze.APIError=An;Ze.APIConnectionError=op;Ze.APIConnectionTimeoutError=x0;Ze.APIUserAbortError=Sr;Ze.NotFoundError=kN;Ze.ConflictError=ON;Ze.RateLimitError=LN;Ze.BadRequestError=NN;Ze.AuthenticationError=PN;Ze.InternalServerError=$N;Ze.PermissionDeniedError=MN;Ze.UnprocessableEntityError=DN;Ze.toFile=HN;Ze.fileFromPath=CN;Ze.Completions=S1;Ze.Chat=hp;Ze.ChatCompletionsPage=pp;Ze.Embeddings=T1;Ze.Files=G0;Ze.FileObjectsPage=H0;Ze.Images=I1;Ze.Audio=ac;Ze.Moderations=R1;Ze.Models=X0;Ze.ModelsPage=Q0;Ze.FineTuning=za;Ze.Graders=Z0;Ze.VectorStores=ja;Ze.VectorStoresPage=sv;Ze.VectorStoreSearchResponsesPage=av;Ze.Beta=ul;Ze.Batches=T0;Ze.BatchesPage=A0;Ze.Uploads=nv;Ze.Responses=tv;Ze.Evals=cc;Ze.EvalListResponsesPage=q0;Ze.Containers=lc;Ze.ContainerListResponsesPage=$0;const vq=t=>typeof t=="object"&&t!==null&&"aborted"in t,L1=t=>t?vq(t)?{signal:t}:t:{},wq=async(t,e=2,n)=>{let r;for(let s=0;s<e;s++){if(n!=null&&n.aborted)throw new DOMException("Aborted","AbortError");try{return await t()}catch(a){if(r=a,n!=null&&n.aborted||s===e-1)throw r;console.warn(`API call failed, retrying... (${s+1}/${e})`,a),await new Promise(o=>setTimeout(o,500))}}throw r};class bu extends Error{constructor(e,n){super(e),this.name="PlanParsingError",this.rawContent=n}}const S_=t=>{try{return JSON.parse(t)}catch{return null}},bq=t=>{const e=[["[","]"],["{","}"]];for(const[n,r]of e){const s=t.indexOf(n),a=t.lastIndexOf(r);if(s!==-1&&a!==-1&&a>s){const o=t.slice(s,a+1).trim();if(o&&S_(o)!==null)return o}}return null},Of=(t,e)=>{let n=t.trim();const r=n.match(/```(?:json)?\s*([\s\S]*?)\s*```/);r&&r[1]&&(n=r[1]);let a=S_(n);if(a===null){const o=bq(n);o&&(a=S_(o))}if(a!==null){const o=a;if(Array.isArray(o))return o;if(typeof o=="object"&&o!==null){if(e!=null&&e.rootKey){if(!(e.rootKey in o))throw new bu(`Response is missing required "${e.rootKey}" property.`,n);if(e.requireRootKeyOnly&&Object.keys(o).some(c=>c!==e.rootKey))throw new bu(`Response must only include the "${e.rootKey}" property.`,n);const d=o[e.rootKey];if(!Array.isArray(d))throw new bu(`"${e.rootKey}" must be an array.`,n);return d}const u=Object.values(o).find(d=>Array.isArray(d));if(u&&Array.isArray(u))return u;if("chartType"in o&&"title"in o)return[o]}}throw console.error("Failed to parse AI response as JSON. Content:",n),new bu(`AI response could not be parsed as JSON. Content starts with: "${n.substring(0,150)}..."`,n)},Sq=new Set(["user","assistant","system","developer"]),xq=t=>Sq.has(t)?t:"user",Tq=t=>{if(typeof t=="string")return t;if(Array.isArray(t))return t.map(e=>typeof e=="string"?e:"text"in e&&typeof e.text=="string"?e.text:JSON.stringify(e)).join(`
`);if(t&&typeof t=="object"&&"text"in t){const e=t.text;if(typeof e=="string")return e}return""},Aq=t=>t.map(e=>({role:xq(e.role),content:Tq(e.content),type:"message"})),Eq=t=>{if(typeof t=="boolean")return t?{type:"json_object"}:void 0;if(t)return{type:"json_schema",name:t.name,schema:t.schema,strict:t.strict??!0}},Cq=t=>{var e,n,r;return(t==null?void 0:t.status)??((e=t==null?void 0:t.response)==null?void 0:e.status)??(t==null?void 0:t.code)??((n=t==null?void 0:t.error)==null?void 0:n.status)??((r=t==null?void 0:t.cause)==null?void 0:r.status)},Iq=(t,e)=>new Promise((n,r)=>{if(e!=null&&e.aborted){r(new DOMException("Aborted","AbortError"));return}const s=setTimeout(n,t);if(e){const a=()=>{clearTimeout(s),r(new DOMException("Aborted","AbortError"))};e.addEventListener("abort",a,{once:!0})}}),cs=async(t,e,n,r)=>{var w;if(!t.openAIApiKey)throw new Error("OpenAI API key is not set.");const s=new Ze({apiKey:t.openAIApiKey,dangerouslyAllowBrowser:!0}),a=L1(r),o=Eq(n),u={model:t.model,input:Aq(e)};o&&(u.text={format:o});const d=2,c=3e4,p=Date.now();let m=0,y;for(;m<d;){if((w=a.signal)!=null&&w.aborted)throw new DOMException("Aborted","AbortError");try{const x=await s.responses.create(u,a.signal?{signal:a.signal}:void 0),A=x==null?void 0:x.usage;A&&a.onUsage&&a.onUsage({provider:"openai",model:t.model,promptTokens:A.prompt_tokens??A.input_tokens??A.input_token_count,completionTokens:A.completion_tokens??A.output_tokens??A.output_token_count,totalTokens:A.total_tokens??A.total_token_count,operation:a.operation});const E=(x.output_text??"").trim();if(!E)throw new Error("OpenAI returned an empty response.");return E}catch(x){y=x;const A=Cq(x),E=A===429||typeof A=="number"&&A>=500,C=Date.now()-p;if(!E||m===d-1||C>=c)throw x;const D=Math.min(2e3,500*Math.pow(2,m));await Iq(D,a.signal),m+=1}}throw y instanceof Error?y:new Error("OpenAI request failed.")},ds=async(t,e,n,r)=>{if(!t.geminiApiKey)throw new Error("Gemini API key is not set.");const s=new dB({apiKey:t.geminiApiKey}),a=L1(r),o=n?`

SCHEMA (for reference only):
${JSON.stringify(n,null,2)}

Return a JSON object that matches this structure exactly.`:"",u=`${e}${o}`.trim(),d=await wq(()=>s.models.generateContent({model:t.model,contents:u},a.signal?{signal:a.signal}:void 0),2,a.signal),c=d.usageMetadata;return c&&a.onUsage&&a.onUsage({provider:"gemini",model:t.model,promptTokens:c.promptTokenCount??void 0,completionTokens:c.candidatesTokenCount??void 0,totalTokens:c.totalTokenCount??void 0,operation:a.operation}),d.text.trim()};var pt;(function(t){t.assertEqual=s=>{};function e(s){}t.assertIs=e;function n(s){throw new Error}t.assertNever=n,t.arrayToEnum=s=>{const a={};for(const o of s)a[o]=o;return a},t.getValidEnumValues=s=>{const a=t.objectKeys(s).filter(u=>typeof s[s[u]]!="number"),o={};for(const u of a)o[u]=s[u];return t.objectValues(o)},t.objectValues=s=>t.objectKeys(s).map(function(a){return s[a]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const a=[];for(const o in s)Object.prototype.hasOwnProperty.call(s,o)&&a.push(o);return a},t.find=(s,a)=>{for(const o of s)if(a(o))return o},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function r(s,a=" | "){return s.map(o=>typeof o=="string"?`'${o}'`:o).join(a)}t.joinValues=r,t.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(pt||(pt={}));var aE;(function(t){t.mergeShapes=(e,n)=>({...e,...n})})(aE||(aE={}));const Ne=pt.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Na=t=>{switch(typeof t){case"undefined":return Ne.undefined;case"string":return Ne.string;case"number":return Number.isNaN(t)?Ne.nan:Ne.number;case"boolean":return Ne.boolean;case"function":return Ne.function;case"bigint":return Ne.bigint;case"symbol":return Ne.symbol;case"object":return Array.isArray(t)?Ne.array:t===null?Ne.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?Ne.promise:typeof Map<"u"&&t instanceof Map?Ne.map:typeof Set<"u"&&t instanceof Set?Ne.set:typeof Date<"u"&&t instanceof Date?Ne.date:Ne.object;default:return Ne.unknown}},he=pt.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class js extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const n=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,n):this.__proto__=n,this.name="ZodError",this.issues=e}format(e){const n=e||function(a){return a.message},r={_errors:[]},s=a=>{for(const o of a.issues)if(o.code==="invalid_union")o.unionErrors.map(s);else if(o.code==="invalid_return_type")s(o.returnTypeError);else if(o.code==="invalid_arguments")s(o.argumentsError);else if(o.path.length===0)r._errors.push(n(o));else{let u=r,d=0;for(;d<o.path.length;){const c=o.path[d];d===o.path.length-1?(u[c]=u[c]||{_errors:[]},u[c]._errors.push(n(o))):u[c]=u[c]||{_errors:[]},u=u[c],d++}}};return s(this),r}static assert(e){if(!(e instanceof js))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,pt.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=n=>n.message){const n={},r=[];for(const s of this.issues)if(s.path.length>0){const a=s.path[0];n[a]=n[a]||[],n[a].push(e(s))}else r.push(e(s));return{formErrors:r,fieldErrors:n}}get formErrors(){return this.flatten()}}js.create=t=>new js(t);const x_=(t,e)=>{let n;switch(t.code){case he.invalid_type:t.received===Ne.undefined?n="Required":n=`Expected ${t.expected}, received ${t.received}`;break;case he.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(t.expected,pt.jsonStringifyReplacer)}`;break;case he.unrecognized_keys:n=`Unrecognized key(s) in object: ${pt.joinValues(t.keys,", ")}`;break;case he.invalid_union:n="Invalid input";break;case he.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${pt.joinValues(t.options)}`;break;case he.invalid_enum_value:n=`Invalid enum value. Expected ${pt.joinValues(t.options)}, received '${t.received}'`;break;case he.invalid_arguments:n="Invalid function arguments";break;case he.invalid_return_type:n="Invalid function return type";break;case he.invalid_date:n="Invalid date";break;case he.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(n=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(n=`${n} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?n=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?n=`Invalid input: must end with "${t.validation.endsWith}"`:pt.assertNever(t.validation):t.validation!=="regex"?n=`Invalid ${t.validation}`:n="Invalid";break;case he.too_small:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:n="Invalid input";break;case he.too_big:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?n=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:n="Invalid input";break;case he.custom:n="Invalid input";break;case he.invalid_intersection_types:n="Intersection results could not be merged";break;case he.not_multiple_of:n=`Number must be a multiple of ${t.multipleOf}`;break;case he.not_finite:n="Number must be finite";break;default:n=e.defaultError,pt.assertNever(t)}return{message:n}};let Rq=x_;function Nq(){return Rq}const Pq=t=>{const{data:e,path:n,errorMaps:r,issueData:s}=t,a=[...n,...s.path||[]],o={...s,path:a};if(s.message!==void 0)return{...s,path:a,message:s.message};let u="";const d=r.filter(c=>!!c).slice().reverse();for(const c of d)u=c(o,{data:e,defaultError:u}).message;return{...s,path:a,message:u}};function be(t,e){const n=Nq(),r=Pq({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,n,n===x_?void 0:x_].filter(s=>!!s)});t.common.issues.push(r)}class lr{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,n){const r=[];for(const s of n){if(s.status==="aborted")return We;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,n){const r=[];for(const s of n){const a=await s.key,o=await s.value;r.push({key:a,value:o})}return lr.mergeObjectSync(e,r)}static mergeObjectSync(e,n){const r={};for(const s of n){const{key:a,value:o}=s;if(a.status==="aborted"||o.status==="aborted")return We;a.status==="dirty"&&e.dirty(),o.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof o.value<"u"||s.alwaysSet)&&(r[a.value]=o.value)}return{status:e.value,value:r}}}const We=Object.freeze({status:"aborted"}),Su=t=>({status:"dirty",value:t}),Ar=t=>({status:"valid",value:t}),iE=t=>t.status==="aborted",oE=t=>t.status==="dirty",Zo=t=>t.status==="valid",Df=t=>typeof Promise<"u"&&t instanceof Promise;var Me;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(Me||(Me={}));class Ua{constructor(e,n,r,s){this._cachedPath=[],this.parent=e,this.data=n,this._path=r,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const lE=(t,e)=>{if(Zo(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const n=new js(t.common.issues);return this._error=n,this._error}}};function nt(t){if(!t)return{};const{errorMap:e,invalid_type_error:n,required_error:r,description:s}=t;if(e&&(n||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(o,u)=>{const{message:d}=t;return o.code==="invalid_enum_value"?{message:d??u.defaultError}:typeof u.data>"u"?{message:d??r??u.defaultError}:o.code!=="invalid_type"?{message:u.defaultError}:{message:d??n??u.defaultError}},description:s}}class ut{get description(){return this._def.description}_getType(e){return Na(e.data)}_getOrReturnCtx(e,n){return n||{common:e.parent.common,data:e.data,parsedType:Na(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new lr,ctx:{common:e.parent.common,data:e.data,parsedType:Na(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const n=this._parse(e);if(Df(n))throw new Error("Synchronous parse encountered promise.");return n}_parseAsync(e){const n=this._parse(e);return Promise.resolve(n)}parse(e,n){const r=this.safeParse(e,n);if(r.success)return r.data;throw r.error}safeParse(e,n){const r={common:{issues:[],async:(n==null?void 0:n.async)??!1,contextualErrorMap:n==null?void 0:n.errorMap},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Na(e)},s=this._parseSync({data:e,path:r.path,parent:r});return lE(r,s)}"~validate"(e){var r,s;const n={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Na(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:n});return Zo(a)?{value:a.value}:{issues:n.common.issues}}catch(a){(s=(r=a==null?void 0:a.message)==null?void 0:r.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),n.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:n}).then(a=>Zo(a)?{value:a.value}:{issues:n.common.issues})}async parseAsync(e,n){const r=await this.safeParseAsync(e,n);if(r.success)return r.data;throw r.error}async safeParseAsync(e,n){const r={common:{issues:[],contextualErrorMap:n==null?void 0:n.errorMap,async:!0},path:(n==null?void 0:n.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Na(e)},s=this._parse({data:e,path:r.path,parent:r}),a=await(Df(s)?s:Promise.resolve(s));return lE(r,a)}refine(e,n){const r=s=>typeof n=="string"||typeof n>"u"?{message:n}:typeof n=="function"?n(s):n;return this._refinement((s,a)=>{const o=e(s),u=()=>a.addIssue({code:he.custom,...r(s)});return typeof Promise<"u"&&o instanceof Promise?o.then(d=>d?!0:(u(),!1)):o?!0:(u(),!1)})}refinement(e,n){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof n=="function"?n(r,s):n),!1))}_refinement(e){return new el({schema:this,typeName:me.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:n=>this["~validate"](n)}}optional(){return La.create(this,this._def)}nullable(){return tl.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return is.create(this)}promise(){return Ff.create(this,this._def)}or(e){return $f.create([this,e],this._def)}and(e){return Uf.create(this,e,this._def)}transform(e){return new el({...nt(this._def),schema:this,typeName:me.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const n=typeof e=="function"?e:()=>e;return new C_({...nt(this._def),innerType:this,defaultValue:n,typeName:me.ZodDefault})}brand(){return new e5({typeName:me.ZodBranded,type:this,...nt(this._def)})}catch(e){const n=typeof e=="function"?e:()=>e;return new I_({...nt(this._def),innerType:this,catchValue:n,typeName:me.ZodCatch})}describe(e){const n=this.constructor;return new n({...this._def,description:e})}pipe(e){return iv.create(this,e)}readonly(){return R_.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Mq=/^c[^\s-]{8,}$/i,kq=/^[0-9a-z]+$/,Oq=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Dq=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Lq=/^[a-z0-9_-]{21}$/i,$q=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Uq=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Fq=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Bq="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let yg;const qq=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Gq=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Hq=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,zq=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,jq=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Vq=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,$1="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Jq=new RegExp(`^${$1}$`);function U1(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const n=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${n}`}function Yq(t){return new RegExp(`^${U1(t)}$`)}function Kq(t){let e=`${$1}T${U1(t)}`;const n=[];return n.push(t.local?"Z?":"Z"),t.offset&&n.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${n.join("|")})`,new RegExp(`^${e}$`)}function Wq(t,e){return!!((e==="v4"||!e)&&qq.test(t)||(e==="v6"||!e)&&Hq.test(t))}function Zq(t,e){if(!$q.test(t))return!1;try{const[n]=t.split(".");if(!n)return!1;const r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function Xq(t,e){return!!((e==="v4"||!e)&&Gq.test(t)||(e==="v6"||!e)&&zq.test(t))}class Pa extends ut{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==Ne.string){const a=this._getOrReturnCtx(e);return be(a,{code:he.invalid_type,expected:Ne.string,received:a.parsedType}),We}const r=new lr;let s;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),be(s,{code:he.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),be(s,{code:he.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="length"){const o=e.data.length>a.value,u=e.data.length<a.value;(o||u)&&(s=this._getOrReturnCtx(e,s),o?be(s,{code:he.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):u&&be(s,{code:he.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),r.dirty())}else if(a.kind==="email")Fq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"email",code:he.invalid_string,message:a.message}),r.dirty());else if(a.kind==="emoji")yg||(yg=new RegExp(Bq,"u")),yg.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"emoji",code:he.invalid_string,message:a.message}),r.dirty());else if(a.kind==="uuid")Dq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"uuid",code:he.invalid_string,message:a.message}),r.dirty());else if(a.kind==="nanoid")Lq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"nanoid",code:he.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid")Mq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"cuid",code:he.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid2")kq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"cuid2",code:he.invalid_string,message:a.message}),r.dirty());else if(a.kind==="ulid")Oq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"ulid",code:he.invalid_string,message:a.message}),r.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),be(s,{validation:"url",code:he.invalid_string,message:a.message}),r.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"regex",code:he.invalid_string,message:a.message}),r.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),be(s,{code:he.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),r.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),be(s,{code:he.invalid_string,validation:{startsWith:a.value},message:a.message}),r.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),be(s,{code:he.invalid_string,validation:{endsWith:a.value},message:a.message}),r.dirty()):a.kind==="datetime"?Kq(a).test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{code:he.invalid_string,validation:"datetime",message:a.message}),r.dirty()):a.kind==="date"?Jq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{code:he.invalid_string,validation:"date",message:a.message}),r.dirty()):a.kind==="time"?Yq(a).test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{code:he.invalid_string,validation:"time",message:a.message}),r.dirty()):a.kind==="duration"?Uq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"duration",code:he.invalid_string,message:a.message}),r.dirty()):a.kind==="ip"?Wq(e.data,a.version)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"ip",code:he.invalid_string,message:a.message}),r.dirty()):a.kind==="jwt"?Zq(e.data,a.alg)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"jwt",code:he.invalid_string,message:a.message}),r.dirty()):a.kind==="cidr"?Xq(e.data,a.version)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"cidr",code:he.invalid_string,message:a.message}),r.dirty()):a.kind==="base64"?jq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"base64",code:he.invalid_string,message:a.message}),r.dirty()):a.kind==="base64url"?Vq.test(e.data)||(s=this._getOrReturnCtx(e,s),be(s,{validation:"base64url",code:he.invalid_string,message:a.message}),r.dirty()):pt.assertNever(a);return{status:r.value,value:e.data}}_regex(e,n,r){return this.refinement(s=>e.test(s),{validation:n,code:he.invalid_string,...Me.errToObj(r)})}_addCheck(e){return new Pa({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Me.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Me.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Me.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Me.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Me.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Me.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Me.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Me.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Me.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...Me.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...Me.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Me.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...Me.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...Me.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...Me.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...Me.errToObj(e)})}regex(e,n){return this._addCheck({kind:"regex",regex:e,...Me.errToObj(n)})}includes(e,n){return this._addCheck({kind:"includes",value:e,position:n==null?void 0:n.position,...Me.errToObj(n==null?void 0:n.message)})}startsWith(e,n){return this._addCheck({kind:"startsWith",value:e,...Me.errToObj(n)})}endsWith(e,n){return this._addCheck({kind:"endsWith",value:e,...Me.errToObj(n)})}min(e,n){return this._addCheck({kind:"min",value:e,...Me.errToObj(n)})}max(e,n){return this._addCheck({kind:"max",value:e,...Me.errToObj(n)})}length(e,n){return this._addCheck({kind:"length",value:e,...Me.errToObj(n)})}nonempty(e){return this.min(1,Me.errToObj(e))}trim(){return new Pa({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Pa({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Pa({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxLength(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}Pa.create=t=>new Pa({checks:[],typeName:me.ZodString,coerce:(t==null?void 0:t.coerce)??!1,...nt(t)});function Qq(t,e){const n=(t.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=n>r?n:r,a=Number.parseInt(t.toFixed(s).replace(".","")),o=Number.parseInt(e.toFixed(s).replace(".",""));return a%o/10**s}class Xo extends ut{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==Ne.number){const a=this._getOrReturnCtx(e);return be(a,{code:he.invalid_type,expected:Ne.number,received:a.parsedType}),We}let r;const s=new lr;for(const a of this._def.checks)a.kind==="int"?pt.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),be(r,{code:he.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),be(r,{code:he.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),be(r,{code:he.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?Qq(e.data,a.value)!==0&&(r=this._getOrReturnCtx(e,r),be(r,{code:he.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),be(r,{code:he.not_finite,message:a.message}),s.dirty()):pt.assertNever(a);return{status:s.value,value:e.data}}gte(e,n){return this.setLimit("min",e,!0,Me.toString(n))}gt(e,n){return this.setLimit("min",e,!1,Me.toString(n))}lte(e,n){return this.setLimit("max",e,!0,Me.toString(n))}lt(e,n){return this.setLimit("max",e,!1,Me.toString(n))}setLimit(e,n,r,s){return new Xo({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:Me.toString(s)}]})}_addCheck(e){return new Xo({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Me.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Me.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Me.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Me.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Me.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:Me.toString(n)})}finite(e){return this._addCheck({kind:"finite",message:Me.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Me.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Me.toString(e)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&pt.isInteger(e.value))}get isFinite(){let e=null,n=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(n===null||r.value>n)&&(n=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(n)&&Number.isFinite(e)}}Xo.create=t=>new Xo({checks:[],typeName:me.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...nt(t)});class Bu extends ut{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==Ne.bigint)return this._getInvalidInput(e);let r;const s=new lr;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),be(r,{code:he.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),be(r,{code:he.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),be(r,{code:he.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):pt.assertNever(a);return{status:s.value,value:e.data}}_getInvalidInput(e){const n=this._getOrReturnCtx(e);return be(n,{code:he.invalid_type,expected:Ne.bigint,received:n.parsedType}),We}gte(e,n){return this.setLimit("min",e,!0,Me.toString(n))}gt(e,n){return this.setLimit("min",e,!1,Me.toString(n))}lte(e,n){return this.setLimit("max",e,!0,Me.toString(n))}lt(e,n){return this.setLimit("max",e,!1,Me.toString(n))}setLimit(e,n,r,s){return new Bu({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:r,message:Me.toString(s)}]})}_addCheck(e){return new Bu({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Me.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Me.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Me.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Me.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:Me.toString(n)})}get minValue(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}}Bu.create=t=>new Bu({checks:[],typeName:me.ZodBigInt,coerce:(t==null?void 0:t.coerce)??!1,...nt(t)});class T_ extends ut{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==Ne.boolean){const r=this._getOrReturnCtx(e);return be(r,{code:he.invalid_type,expected:Ne.boolean,received:r.parsedType}),We}return Ar(e.data)}}T_.create=t=>new T_({typeName:me.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...nt(t)});class Lf extends ut{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==Ne.date){const a=this._getOrReturnCtx(e);return be(a,{code:he.invalid_type,expected:Ne.date,received:a.parsedType}),We}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return be(a,{code:he.invalid_date}),We}const r=new lr;let s;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),be(s,{code:he.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),be(s,{code:he.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):pt.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Lf({...this._def,checks:[...this._def.checks,e]})}min(e,n){return this._addCheck({kind:"min",value:e.getTime(),message:Me.toString(n)})}max(e,n){return this._addCheck({kind:"max",value:e.getTime(),message:Me.toString(n)})}get minDate(){let e=null;for(const n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e!=null?new Date(e):null}}Lf.create=t=>new Lf({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:me.ZodDate,...nt(t)});class uE extends ut{_parse(e){if(this._getType(e)!==Ne.symbol){const r=this._getOrReturnCtx(e);return be(r,{code:he.invalid_type,expected:Ne.symbol,received:r.parsedType}),We}return Ar(e.data)}}uE.create=t=>new uE({typeName:me.ZodSymbol,...nt(t)});class cE extends ut{_parse(e){if(this._getType(e)!==Ne.undefined){const r=this._getOrReturnCtx(e);return be(r,{code:he.invalid_type,expected:Ne.undefined,received:r.parsedType}),We}return Ar(e.data)}}cE.create=t=>new cE({typeName:me.ZodUndefined,...nt(t)});class dE extends ut{_parse(e){if(this._getType(e)!==Ne.null){const r=this._getOrReturnCtx(e);return be(r,{code:he.invalid_type,expected:Ne.null,received:r.parsedType}),We}return Ar(e.data)}}dE.create=t=>new dE({typeName:me.ZodNull,...nt(t)});class A_ extends ut{constructor(){super(...arguments),this._any=!0}_parse(e){return Ar(e.data)}}A_.create=t=>new A_({typeName:me.ZodAny,...nt(t)});class fE extends ut{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ar(e.data)}}fE.create=t=>new fE({typeName:me.ZodUnknown,...nt(t)});class Fa extends ut{_parse(e){const n=this._getOrReturnCtx(e);return be(n,{code:he.invalid_type,expected:Ne.never,received:n.parsedType}),We}}Fa.create=t=>new Fa({typeName:me.ZodNever,...nt(t)});class pE extends ut{_parse(e){if(this._getType(e)!==Ne.undefined){const r=this._getOrReturnCtx(e);return be(r,{code:he.invalid_type,expected:Ne.void,received:r.parsedType}),We}return Ar(e.data)}}pE.create=t=>new pE({typeName:me.ZodVoid,...nt(t)});class is extends ut{_parse(e){const{ctx:n,status:r}=this._processInputParams(e),s=this._def;if(n.parsedType!==Ne.array)return be(n,{code:he.invalid_type,expected:Ne.array,received:n.parsedType}),We;if(s.exactLength!==null){const o=n.data.length>s.exactLength.value,u=n.data.length<s.exactLength.value;(o||u)&&(be(n,{code:o?he.too_big:he.too_small,minimum:u?s.exactLength.value:void 0,maximum:o?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&n.data.length<s.minLength.value&&(be(n,{code:he.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&n.data.length>s.maxLength.value&&(be(n,{code:he.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),n.common.async)return Promise.all([...n.data].map((o,u)=>s.type._parseAsync(new Ua(n,o,n.path,u)))).then(o=>lr.mergeArray(r,o));const a=[...n.data].map((o,u)=>s.type._parseSync(new Ua(n,o,n.path,u)));return lr.mergeArray(r,a)}get element(){return this._def.type}min(e,n){return new is({...this._def,minLength:{value:e,message:Me.toString(n)}})}max(e,n){return new is({...this._def,maxLength:{value:e,message:Me.toString(n)}})}length(e,n){return new is({...this._def,exactLength:{value:e,message:Me.toString(n)}})}nonempty(e){return this.min(1,e)}}is.create=(t,e)=>new is({type:t,minLength:null,maxLength:null,exactLength:null,typeName:me.ZodArray,...nt(e)});function Mo(t){if(t instanceof en){const e={};for(const n in t.shape){const r=t.shape[n];e[n]=La.create(Mo(r))}return new en({...t._def,shape:()=>e})}else return t instanceof is?new is({...t._def,type:Mo(t.element)}):t instanceof La?La.create(Mo(t.unwrap())):t instanceof tl?tl.create(Mo(t.unwrap())):t instanceof Oi?Oi.create(t.items.map(e=>Mo(e))):t}class en extends ut{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),n=pt.objectKeys(e);return this._cached={shape:e,keys:n},this._cached}_parse(e){if(this._getType(e)!==Ne.object){const c=this._getOrReturnCtx(e);return be(c,{code:he.invalid_type,expected:Ne.object,received:c.parsedType}),We}const{status:r,ctx:s}=this._processInputParams(e),{shape:a,keys:o}=this._getCached(),u=[];if(!(this._def.catchall instanceof Fa&&this._def.unknownKeys==="strip"))for(const c in s.data)o.includes(c)||u.push(c);const d=[];for(const c of o){const p=a[c],m=s.data[c];d.push({key:{status:"valid",value:c},value:p._parse(new Ua(s,m,s.path,c)),alwaysSet:c in s.data})}if(this._def.catchall instanceof Fa){const c=this._def.unknownKeys;if(c==="passthrough")for(const p of u)d.push({key:{status:"valid",value:p},value:{status:"valid",value:s.data[p]}});else if(c==="strict")u.length>0&&(be(s,{code:he.unrecognized_keys,keys:u}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const p of u){const m=s.data[p];d.push({key:{status:"valid",value:p},value:c._parse(new Ua(s,m,s.path,p)),alwaysSet:p in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const c=[];for(const p of d){const m=await p.key,y=await p.value;c.push({key:m,value:y,alwaysSet:p.alwaysSet})}return c}).then(c=>lr.mergeObjectSync(r,c)):lr.mergeObjectSync(r,d)}get shape(){return this._def.shape()}strict(e){return Me.errToObj,new en({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(n,r)=>{var a,o;const s=((o=(a=this._def).errorMap)==null?void 0:o.call(a,n,r).message)??r.defaultError;return n.code==="unrecognized_keys"?{message:Me.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new en({...this._def,unknownKeys:"strip"})}passthrough(){return new en({...this._def,unknownKeys:"passthrough"})}extend(e){return new en({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new en({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:me.ZodObject})}setKey(e,n){return this.augment({[e]:n})}catchall(e){return new en({...this._def,catchall:e})}pick(e){const n={};for(const r of pt.objectKeys(e))e[r]&&this.shape[r]&&(n[r]=this.shape[r]);return new en({...this._def,shape:()=>n})}omit(e){const n={};for(const r of pt.objectKeys(this.shape))e[r]||(n[r]=this.shape[r]);return new en({...this._def,shape:()=>n})}deepPartial(){return Mo(this)}partial(e){const n={};for(const r of pt.objectKeys(this.shape)){const s=this.shape[r];e&&!e[r]?n[r]=s:n[r]=s.optional()}return new en({...this._def,shape:()=>n})}required(e){const n={};for(const r of pt.objectKeys(this.shape))if(e&&!e[r])n[r]=this.shape[r];else{let a=this.shape[r];for(;a instanceof La;)a=a._def.innerType;n[r]=a}return new en({...this._def,shape:()=>n})}keyof(){return F1(pt.objectKeys(this.shape))}}en.create=(t,e)=>new en({shape:()=>t,unknownKeys:"strip",catchall:Fa.create(),typeName:me.ZodObject,...nt(e)});en.strictCreate=(t,e)=>new en({shape:()=>t,unknownKeys:"strict",catchall:Fa.create(),typeName:me.ZodObject,...nt(e)});en.lazycreate=(t,e)=>new en({shape:t,unknownKeys:"strip",catchall:Fa.create(),typeName:me.ZodObject,...nt(e)});class $f extends ut{_parse(e){const{ctx:n}=this._processInputParams(e),r=this._def.options;function s(a){for(const u of a)if(u.result.status==="valid")return u.result;for(const u of a)if(u.result.status==="dirty")return n.common.issues.push(...u.ctx.common.issues),u.result;const o=a.map(u=>new js(u.ctx.common.issues));return be(n,{code:he.invalid_union,unionErrors:o}),We}if(n.common.async)return Promise.all(r.map(async a=>{const o={...n,common:{...n.common,issues:[]},parent:null};return{result:await a._parseAsync({data:n.data,path:n.path,parent:o}),ctx:o}})).then(s);{let a;const o=[];for(const d of r){const c={...n,common:{...n.common,issues:[]},parent:null},p=d._parseSync({data:n.data,path:n.path,parent:c});if(p.status==="valid")return p;p.status==="dirty"&&!a&&(a={result:p,ctx:c}),c.common.issues.length&&o.push(c.common.issues)}if(a)return n.common.issues.push(...a.ctx.common.issues),a.result;const u=o.map(d=>new js(d));return be(n,{code:he.invalid_union,unionErrors:u}),We}}get options(){return this._def.options}}$f.create=(t,e)=>new $f({options:t,typeName:me.ZodUnion,...nt(e)});function E_(t,e){const n=Na(t),r=Na(e);if(t===e)return{valid:!0,data:t};if(n===Ne.object&&r===Ne.object){const s=pt.objectKeys(e),a=pt.objectKeys(t).filter(u=>s.indexOf(u)!==-1),o={...t,...e};for(const u of a){const d=E_(t[u],e[u]);if(!d.valid)return{valid:!1};o[u]=d.data}return{valid:!0,data:o}}else if(n===Ne.array&&r===Ne.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let a=0;a<t.length;a++){const o=t[a],u=e[a],d=E_(o,u);if(!d.valid)return{valid:!1};s.push(d.data)}return{valid:!0,data:s}}else return n===Ne.date&&r===Ne.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}class Uf extends ut{_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=(a,o)=>{if(iE(a)||iE(o))return We;const u=E_(a.value,o.value);return u.valid?((oE(a)||oE(o))&&n.dirty(),{status:n.value,value:u.data}):(be(r,{code:he.invalid_intersection_types}),We)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([a,o])=>s(a,o)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}Uf.create=(t,e,n)=>new Uf({left:t,right:e,typeName:me.ZodIntersection,...nt(n)});class Oi extends ut{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==Ne.array)return be(r,{code:he.invalid_type,expected:Ne.array,received:r.parsedType}),We;if(r.data.length<this._def.items.length)return be(r,{code:he.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),We;!this._def.rest&&r.data.length>this._def.items.length&&(be(r,{code:he.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),n.dirty());const a=[...r.data].map((o,u)=>{const d=this._def.items[u]||this._def.rest;return d?d._parse(new Ua(r,o,r.path,u)):null}).filter(o=>!!o);return r.common.async?Promise.all(a).then(o=>lr.mergeArray(n,o)):lr.mergeArray(n,a)}get items(){return this._def.items}rest(e){return new Oi({...this._def,rest:e})}}Oi.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Oi({items:t,typeName:me.ZodTuple,rest:null,...nt(e)})};class hE extends ut{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==Ne.map)return be(r,{code:he.invalid_type,expected:Ne.map,received:r.parsedType}),We;const s=this._def.keyType,a=this._def.valueType,o=[...r.data.entries()].map(([u,d],c)=>({key:s._parse(new Ua(r,u,r.path,[c,"key"])),value:a._parse(new Ua(r,d,r.path,[c,"value"]))}));if(r.common.async){const u=new Map;return Promise.resolve().then(async()=>{for(const d of o){const c=await d.key,p=await d.value;if(c.status==="aborted"||p.status==="aborted")return We;(c.status==="dirty"||p.status==="dirty")&&n.dirty(),u.set(c.value,p.value)}return{status:n.value,value:u}})}else{const u=new Map;for(const d of o){const c=d.key,p=d.value;if(c.status==="aborted"||p.status==="aborted")return We;(c.status==="dirty"||p.status==="dirty")&&n.dirty(),u.set(c.value,p.value)}return{status:n.value,value:u}}}}hE.create=(t,e,n)=>new hE({valueType:e,keyType:t,typeName:me.ZodMap,...nt(n)});class qu extends ut{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.parsedType!==Ne.set)return be(r,{code:he.invalid_type,expected:Ne.set,received:r.parsedType}),We;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(be(r,{code:he.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),n.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(be(r,{code:he.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),n.dirty());const a=this._def.valueType;function o(d){const c=new Set;for(const p of d){if(p.status==="aborted")return We;p.status==="dirty"&&n.dirty(),c.add(p.value)}return{status:n.value,value:c}}const u=[...r.data.values()].map((d,c)=>a._parse(new Ua(r,d,r.path,c)));return r.common.async?Promise.all(u).then(d=>o(d)):o(u)}min(e,n){return new qu({...this._def,minSize:{value:e,message:Me.toString(n)}})}max(e,n){return new qu({...this._def,maxSize:{value:e,message:Me.toString(n)}})}size(e,n){return this.min(e,n).max(e,n)}nonempty(e){return this.min(1,e)}}qu.create=(t,e)=>new qu({valueType:t,minSize:null,maxSize:null,typeName:me.ZodSet,...nt(e)});class mE extends ut{get schema(){return this._def.getter()}_parse(e){const{ctx:n}=this._processInputParams(e);return this._def.getter()._parse({data:n.data,path:n.path,parent:n})}}mE.create=(t,e)=>new mE({getter:t,typeName:me.ZodLazy,...nt(e)});class gE extends ut{_parse(e){if(e.data!==this._def.value){const n=this._getOrReturnCtx(e);return be(n,{received:n.data,code:he.invalid_literal,expected:this._def.value}),We}return{status:"valid",value:e.data}}get value(){return this._def.value}}gE.create=(t,e)=>new gE({value:t,typeName:me.ZodLiteral,...nt(e)});function F1(t,e){return new Qo({values:t,typeName:me.ZodEnum,...nt(e)})}class Qo extends ut{_parse(e){if(typeof e.data!="string"){const n=this._getOrReturnCtx(e),r=this._def.values;return be(n,{expected:pt.joinValues(r),received:n.parsedType,code:he.invalid_type}),We}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const n=this._getOrReturnCtx(e),r=this._def.values;return be(n,{received:n.data,code:he.invalid_enum_value,options:r}),We}return Ar(e.data)}get options(){return this._def.values}get enum(){const e={};for(const n of this._def.values)e[n]=n;return e}get Values(){const e={};for(const n of this._def.values)e[n]=n;return e}get Enum(){const e={};for(const n of this._def.values)e[n]=n;return e}extract(e,n=this._def){return Qo.create(e,{...this._def,...n})}exclude(e,n=this._def){return Qo.create(this.options.filter(r=>!e.includes(r)),{...this._def,...n})}}Qo.create=F1;class yE extends ut{_parse(e){const n=pt.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==Ne.string&&r.parsedType!==Ne.number){const s=pt.objectValues(n);return be(r,{expected:pt.joinValues(s),received:r.parsedType,code:he.invalid_type}),We}if(this._cache||(this._cache=new Set(pt.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=pt.objectValues(n);return be(r,{received:r.data,code:he.invalid_enum_value,options:s}),We}return Ar(e.data)}get enum(){return this._def.values}}yE.create=(t,e)=>new yE({values:t,typeName:me.ZodNativeEnum,...nt(e)});class Ff extends ut{unwrap(){return this._def.type}_parse(e){const{ctx:n}=this._processInputParams(e);if(n.parsedType!==Ne.promise&&n.common.async===!1)return be(n,{code:he.invalid_type,expected:Ne.promise,received:n.parsedType}),We;const r=n.parsedType===Ne.promise?n.data:Promise.resolve(n.data);return Ar(r.then(s=>this._def.type.parseAsync(s,{path:n.path,errorMap:n.common.contextualErrorMap})))}}Ff.create=(t,e)=>new Ff({type:t,typeName:me.ZodPromise,...nt(e)});class el extends ut{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===me.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:n,ctx:r}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:o=>{be(r,o),o.fatal?n.abort():n.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){const o=s.transform(r.data,a);if(r.common.async)return Promise.resolve(o).then(async u=>{if(n.value==="aborted")return We;const d=await this._def.schema._parseAsync({data:u,path:r.path,parent:r});return d.status==="aborted"?We:d.status==="dirty"||n.value==="dirty"?Su(d.value):d});{if(n.value==="aborted")return We;const u=this._def.schema._parseSync({data:o,path:r.path,parent:r});return u.status==="aborted"?We:u.status==="dirty"||n.value==="dirty"?Su(u.value):u}}if(s.type==="refinement"){const o=u=>{const d=s.refinement(u,a);if(r.common.async)return Promise.resolve(d);if(d instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return u};if(r.common.async===!1){const u=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return u.status==="aborted"?We:(u.status==="dirty"&&n.dirty(),o(u.value),{status:n.value,value:u.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(u=>u.status==="aborted"?We:(u.status==="dirty"&&n.dirty(),o(u.value).then(()=>({status:n.value,value:u.value}))))}if(s.type==="transform")if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Zo(o))return We;const u=s.transform(o.value,a);if(u instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:n.value,value:u}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>Zo(o)?Promise.resolve(s.transform(o.value,a)).then(u=>({status:n.value,value:u})):We);pt.assertNever(s)}}el.create=(t,e,n)=>new el({schema:t,typeName:me.ZodEffects,effect:e,...nt(n)});el.createWithPreprocess=(t,e,n)=>new el({schema:e,effect:{type:"preprocess",transform:t},typeName:me.ZodEffects,...nt(n)});class La extends ut{_parse(e){return this._getType(e)===Ne.undefined?Ar(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}La.create=(t,e)=>new La({innerType:t,typeName:me.ZodOptional,...nt(e)});class tl extends ut{_parse(e){return this._getType(e)===Ne.null?Ar(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}tl.create=(t,e)=>new tl({innerType:t,typeName:me.ZodNullable,...nt(e)});class C_ extends ut{_parse(e){const{ctx:n}=this._processInputParams(e);let r=n.data;return n.parsedType===Ne.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:n.path,parent:n})}removeDefault(){return this._def.innerType}}C_.create=(t,e)=>new C_({innerType:t,typeName:me.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...nt(e)});class I_ extends ut{_parse(e){const{ctx:n}=this._processInputParams(e),r={...n,common:{...n.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Df(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new js(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new js(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}I_.create=(t,e)=>new I_({innerType:t,typeName:me.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...nt(e)});class _E extends ut{_parse(e){if(this._getType(e)!==Ne.nan){const r=this._getOrReturnCtx(e);return be(r,{code:he.invalid_type,expected:Ne.nan,received:r.parsedType}),We}return{status:"valid",value:e.data}}}_E.create=t=>new _E({typeName:me.ZodNaN,...nt(t)});class e5 extends ut{_parse(e){const{ctx:n}=this._processInputParams(e),r=n.data;return this._def.type._parse({data:r,path:n.path,parent:n})}unwrap(){return this._def.type}}class iv extends ut{_parse(e){const{status:n,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?We:a.status==="dirty"?(n.dirty(),Su(a.value)):this._def.out._parseAsync({data:a.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?We:s.status==="dirty"?(n.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,n){return new iv({in:e,out:n,typeName:me.ZodPipeline})}}class R_ extends ut{_parse(e){const n=this._def.innerType._parse(e),r=s=>(Zo(s)&&(s.value=Object.freeze(s.value)),s);return Df(n)?n.then(s=>r(s)):r(n)}unwrap(){return this._def.innerType}}R_.create=(t,e)=>new R_({innerType:t,typeName:me.ZodReadonly,...nt(e)});var me;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(me||(me={}));const Lt=Pa.create,rs=Xo.create,Bf=T_.create,vE=A_.create;Fa.create;const N_=is.create,ss=en.create,wE=$f.create;Uf.create;Oi.create;const qf=Qo.create;Ff.create;La.create;tl.create;const t5=["aggregate","profile","clean","detect_anomaly","remove_card","save_view","ask_clarify"],n5=["csv.aggregate","csv.profile","csv.clean_invoice_month","csv.detect_outliers","ui.remove_card","idb.save_view"],r5={aggregate:["csv.aggregate"],profile:["csv.profile"],clean:["csv.clean_invoice_month"],detect_anomaly:["csv.detect_outliers"],remove_card:["ui.remove_card"],save_view:["idb.save_view"],ask_clarify:[]},s5=qf(["=","!=",">",">=","<","<=","in","contains"]),a5=ss({column:Lt().min(1,"Filter column is required."),op:s5.default("="),value:wE([Lt(),rs(),Bf(),N_(wE([Lt(),rs(),Bf()])).nonempty()])}).strict(),i5=ss({datasetId:Lt().min(1).optional().nullable(),column:Lt().min(1).optional(),valueColumn:Lt().min(1).optional(),groupBy:N_(Lt().min(1)).default([]),aggregation:qf(["sum","avg","count","min","max"]).default("sum"),filters:N_(a5).default([]),limit:rs().int().positive().optional(),topN:rs().int().positive().optional(),thresholdMultiplier:rs().positive().optional(),viewTitle:Lt().min(1).optional(),cardId:Lt().min(1).optional()}).strict(),B1=ss({intent:qf(t5),tool:qf(n5).nullable().default(null),args:i5.default({}),awaitUser:Bf().default(!1),message:Lt().max(280).optional().nullable()}).superRefine((t,e)=>{const n=r5[t.intent]??[];n.length===0?t.tool!==null&&e.addIssue({code:he.custom,message:`Intent "${t.intent}" should not specify a tool.`,path:["tool"]}):(!t.tool||!n.includes(t.tool))&&e.addIssue({code:he.custom,message:`Tool "${t.tool}" is not allowed for intent "${t.intent}".`,path:["tool"]}),t.intent==="ask_clarify"&&!t.awaitUser&&e.addIssue({code:he.custom,message:"ask_clarify intent must set awaitUser=true.",path:["awaitUser"]})}),P_=t=>{const e={awaitUser:!1,args:{groupBy:[],aggregation:"sum",filters:[]},...t},n=B1.safeParse(e);if(!n.success)throw n.error;return n.data},wp=t=>{const e={...t};if(Array.isArray(e.enum))return e.enum.includes(null)||(e.enum=[...e.enum,null]),e;const n=e.type;return Array.isArray(n)?n.includes("null")||(e.type=[...n,"null"]):n?e.type=[n,"null"]:e.type=["null"],e},dc=(t,e)=>{const n={...t};return e.forEach(r=>{if(!n[r])throw new Error(`Attempted to mark missing property "${r}" as nullable.`);n[r]=wp(n[r])}),n},q1={type:te.OBJECT,properties:{chartType:{type:te.STRING,enum:["bar","line","pie","doughnut","scatter","combo"],description:"Type of chart to generate."},title:{type:te.STRING,description:"A concise title for the analysis."},description:{type:te.STRING,minLength:8,description:"A brief explanation of what the analysis shows. Must be a full sentence with at least 8 characters."},aggregation:{type:te.STRING,enum:["sum","count","avg"],description:"The aggregation function to apply. Omit for scatter plots."},groupByColumn:{type:te.STRING,description:"The column to group data by (categorical). Omit for scatter plots."},valueColumn:{type:te.STRING,description:'The column for aggregation (numerical). Not needed for "count".'},xValueColumn:{type:te.STRING,description:"The column for the X-axis of a scatter plot (numerical). Required for scatter plots."},yValueColumn:{type:te.STRING,description:"The column for the Y-axis of a scatter plot (numerical). Required for scatter plots."},secondaryValueColumn:{type:te.STRING,description:"For combo charts, the secondary column for aggregation (numerical)."},secondaryAggregation:{type:te.STRING,enum:["sum","count","avg"],description:"For combo charts, the aggregation for the secondary value column."},defaultTopN:{type:te.INTEGER,description:"Optional. If the analysis has many categories, this suggests a default Top N view (e.g., 8)."},defaultHideOthers:{type:te.BOOLEAN,description:'Optional. If using defaultTopN, suggests whether to hide the "Others" category by default.'},orderBy:{type:te.ARRAY,description:"Optional ordering instructions applied before limiting rows.",items:{type:te.OBJECT,properties:{column:{type:te.STRING,description:"Column to sort by (group or metric alias)."},direction:{type:te.STRING,enum:["asc","desc"],description:"Sort direction (default desc)."}},required:["column","direction"],additionalProperties:!1}},limit:{type:te.INTEGER,description:"Optional limit applied after sorting (e.g., Top N rows)."},rowFilter:{type:te.OBJECT,description:"Optional row-level filter to limit rows before aggregation (e.g., single customer or region).",properties:{column:{type:te.STRING,description:"Column to filter on. Must be categorical."},values:{type:te.ARRAY,minItems:1,description:"Exact values to keep (case-sensitive, as they appear in the dataset).",items:{type:te.STRING}}},required:["column","values"],additionalProperties:!1}},required:["chartType","title","description","aggregation","groupByColumn","valueColumn","xValueColumn","yValueColumn","secondaryValueColumn","secondaryAggregation","defaultTopN","defaultHideOthers","orderBy","limit","rowFilter"],additionalProperties:!1},ov={type:te.OBJECT,properties:{plans:{type:te.ARRAY,description:"Array of analysis plans to execute.",items:q1}},required:["plans"],additionalProperties:!1},o5={type:te.OBJECT,properties:{name:{type:te.STRING,description:"The column name."},type:{type:te.STRING,enum:["numerical","categorical","date","time","currency","percentage"],description:"The data type of the column. Identify specific types like 'date', 'currency', etc., where possible."}},required:["name","type"],additionalProperties:!1},G1={type:te.OBJECT,properties:{explanation:{type:te.STRING,description:"A brief, user-facing explanation of the transformations that will be applied to the data (e.g., 'Removed 3 summary rows and reshaped the data from a cross-tab format')."},jsFunctionBody:wp({type:te.STRING,description:"The body of a JavaScript function that takes two arguments `data` (an array of objects) and `_util` (a helper object) and returns the transformed array of objects. This code will be executed to clean and reshape the data."}),outputColumns:{type:te.ARRAY,description:"A list of column profiles describing the structure of the data AFTER the transformation. If no transformation is performed, this should be the same as the input column profiles.",items:o5}},required:["explanation","jsFunctionBody","outputColumns"],additionalProperties:!1},H1={type:te.OBJECT,properties:{explanation:{type:te.STRING,description:"A brief, user-facing explanation of the filter that was created from the natural language query."},jsFunctionBody:{type:te.STRING,description:"The body of a JavaScript function that takes 'data' and '_util' as arguments and returns a filtered array of objects. It should be a single line starting with 'return data.filter(...);'."}},required:["explanation","jsFunctionBody"],additionalProperties:!1},z1={type:te.OBJECT,properties:{insight:{type:te.STRING,description:"A concise, user-facing message describing the single most important finding."},cardId:{type:te.STRING,description:"The ID of the card where this insight was observed."}},required:["insight","cardId"],additionalProperties:!1},l5=q1,j1={chartType:{type:te.STRING,enum:["bar","line","pie","doughnut","scatter","combo"]},title:{type:te.STRING},description:{type:te.STRING},aggregation:{type:te.STRING,enum:["sum","count","avg"]},groupByColumn:{type:te.STRING},valueColumn:{type:te.STRING},xValueColumn:{type:te.STRING},yValueColumn:{type:te.STRING},secondaryValueColumn:{type:te.STRING},secondaryAggregation:{type:te.STRING,enum:["sum","count","avg"]},defaultTopN:{type:te.INTEGER},defaultHideOthers:{type:te.BOOLEAN},orderBy:{type:te.ARRAY,items:{type:te.OBJECT,properties:{column:{type:te.STRING},direction:{type:te.STRING,enum:["asc","desc"]}},required:["column","direction"],additionalProperties:!1}},limit:{type:te.INTEGER},rowFilter:{type:te.OBJECT,properties:{column:{type:te.STRING},values:{type:te.ARRAY,items:{type:te.STRING}}},additionalProperties:!1,required:["column","values"]}},bE=Object.keys(j1),u5={type:te.OBJECT,properties:{question:{type:te.STRING,description:"The clear, user-facing question to ask for clarification."},options:{type:te.ARRAY,items:{type:te.OBJECT,properties:{label:{type:te.STRING,description:"The user-friendly text for the option button."},value:{type:te.STRING,description:"The exact column name (case-sensitive) or literal value that should be assigned to the plan when this option is selected. Do not invent new names."}},required:["label","value"],additionalProperties:!1}},pendingPlan:{type:te.OBJECT,description:"The partial analysis plan that is waiting for the user's input. It should contain all known parameters.",properties:dc(j1,bE),required:bE,additionalProperties:!1},targetProperty:{type:te.STRING,description:"The name of the property in the 'pendingPlan' that the user's selected value should be assigned to."},reasonHint:wp({type:te.STRING,description:"Optional short explanation describing why the clarification is required."})},required:["question","options","pendingPlan","targetProperty"],additionalProperties:!1},c5={type:te.OBJECT,description:"Declarative representation of a pending plan step.",properties:{id:{type:te.STRING,minLength:3,description:"Stable identifier (kebab-case recommended) used to reference this step in future actions."},label:{type:te.STRING,minLength:4,description:"Human-readable summary of the step."}},required:["id","label"],additionalProperties:!1},d5={goal:{type:te.STRING,minLength:6},contextSummary:{type:te.STRING},progress:{type:te.STRING,minLength:6},nextSteps:{type:te.ARRAY,minItems:1,items:c5},planId:{type:te.STRING},blockedBy:{type:te.STRING},observationIds:{type:te.ARRAY,items:{type:te.STRING}},confidence:{type:te.NUMBER,minimum:0,maximum:1},updatedAt:{type:te.STRING},currentStepId:{type:te.STRING},steps:{type:te.ARRAY,minItems:1,items:{type:te.OBJECT,properties:{id:{type:te.STRING},label:{type:te.STRING},intent:{type:te.STRING},status:{type:te.STRING,enum:["ready","in_progress","done","waiting_user"]}},required:["id","label","intent","status"],additionalProperties:!1}},stateTag:{type:te.STRING}},f5={type:te.OBJECT,properties:dc(d5,["contextSummary","planId","blockedBy","confidence"]),required:["goal","contextSummary","progress","nextSteps","planId","blockedBy","observationIds","confidence","updatedAt","currentStepId","steps","stateTag"],additionalProperties:!1},p5={type:te.OBJECT,properties:{awaitUser:{type:te.BOOLEAN},haltAfter:{type:te.BOOLEAN},resumePlanner:{type:te.BOOLEAN},promptId:{type:te.STRING}},required:["awaitUser","haltAfter","resumePlanner","promptId"],additionalProperties:!1},h5={type:te.OBJECT,properties:{id:{type:te.STRING},label:{type:te.STRING}},required:["id","label"],additionalProperties:!1},m5={type:te.OBJECT,properties:{promptId:{type:te.STRING},question:{type:te.STRING},options:{type:te.ARRAY,minItems:1,items:h5},allowFreeText:{type:te.BOOLEAN},placeholder:{type:te.STRING}},required:["promptId","question","options","allowFreeText","placeholder"],additionalProperties:!1},_g={byId:{type:te.STRING},byTitle:{type:te.STRING},selector:{type:te.STRING}},g5={type:te.OBJECT,properties:dc(_g,Object.keys(_g)),required:Object.keys(_g),additionalProperties:!1},vg={cardId:{type:te.STRING},cardTitle:{type:te.STRING},newType:{type:te.STRING,enum:["bar","line","pie","doughnut","scatter","combo"]},visible:{type:te.BOOLEAN},column:{type:te.STRING},values:{type:te.ARRAY,items:{type:te.STRING}},topN:{type:te.INTEGER},hide:{type:te.BOOLEAN},label:{type:te.STRING},format:{type:te.STRING,enum:["png","csv","html"]}},y5={type:te.OBJECT,properties:dc(vg,Object.keys(vg)),required:Object.keys(vg),additionalProperties:!1},_5={type:te.OBJECT,properties:{toolName:{type:te.STRING,enum:["highlightCard","changeCardChartType","showCardData","filterCard","setTopN","toggleHideOthers","toggleLegendLabel","exportCard","removeCard"]},target:g5,args:y5},required:["toolName","target","args"],additionalProperties:!1},v5={type:te.OBJECT,properties:{explanation:{type:te.STRING},jsFunctionBody:{type:te.STRING,minLength:10}},required:["explanation","jsFunctionBody"],additionalProperties:!1},w5={type:te.OBJECT,properties:{query:{type:te.STRING}},required:["query"],additionalProperties:!1},b5=["plan_state_update","text_response","await_user","plan_creation","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request"],S5=["intentContract","meta","planState","text","cardId","awaitUserPayload","plan","domAction","code","args","clarification"],V1=(t=b5)=>({type:te.OBJECT,properties:dc({type:{type:te.STRING,enum:t},responseType:{type:te.STRING,enum:t},reason:{type:te.STRING,maxLength:280},stepId:{type:te.STRING},intentContract:B1,meta:p5,planState:f5,text:{type:te.STRING},cardId:{type:te.STRING},awaitUserPayload:m5,plan:l5,domAction:_5,code:v5,args:w5,clarification:u5},S5),required:["type","responseType","reason","stepId","intentContract","meta","planState","text","cardId","awaitUserPayload","plan","domAction","code","args","clarification"],additionalProperties:!1}),x5=V1(),T5={type:te.ARRAY,minItems:1,maxItems:1,items:V1(["plan_state_update"])};te.OBJECT,te.STRING,wp({type:te.OBJECT,description:"Tool arguments payload (free-form keys allowed).",patternProperties:{"^.*$":{type:["string","number","integer","boolean","array","object","null"]}},additionalProperties:!1}),te.BOOLEAN;const A5={type:te.OBJECT,properties:{actions:{type:te.ARRAY,description:"A sequence of actions for the assistant to perform.",minItems:1,items:x5}},required:["actions"],additionalProperties:!1},E5={type:te.OBJECT,properties:{actions:T5},required:["actions"],additionalProperties:!1},SE=new Map([[te.STRING,"string"],[te.INTEGER,"integer"],[te.NUMBER,"number"],[te.BOOLEAN,"boolean"],[te.ARRAY,"array"],[te.OBJECT,"object"]]),C5=new Set,xE=new Set(["properties.actions.items.properties.text","properties.actions.items.properties.cardId","properties.actions.items.properties.domAction.properties.args","properties.actions.items.properties.domAction.properties.args.properties.newType","properties.actions.items.properties.domAction.properties.args.properties.visible","properties.actions.items.properties.domAction.properties.args.properties.cardTitle","properties.actions.items.properties.domAction.properties.args.properties.column","properties.actions.items.properties.domAction.properties.args.properties.values","properties.actions.items.properties.domAction.properties.args.properties.topN","properties.actions.items.properties.domAction.properties.args.properties.hide","properties.actions.items.properties.domAction.properties.args.properties.label","properties.actions.items.properties.domAction.properties.args.properties.format","properties.actions.items.properties.domAction.properties.target.properties.byId","properties.actions.items.properties.domAction.properties.target.properties.byTitle","properties.actions.items.properties.domAction.properties.target.properties.selector","properties.actions.items.properties.planState.properties.contextSummary","properties.actions.items.properties.planState.properties.blockedBy","properties.actions.items.properties.planState.properties.confidence","properties.actions.items.properties.intentContract.properties.tool","properties.actions.items.properties.intentContract.properties.args.properties.datasetId","properties.actions.items.properties.intentContract.properties.args.properties.column","properties.actions.items.properties.intentContract.properties.args.properties.valueColumn","properties.actions.items.properties.intentContract.properties.args.properties.limit","properties.actions.items.properties.intentContract.properties.args.properties.topN","properties.actions.items.properties.intentContract.properties.args.properties.thresholdMultiplier","properties.actions.items.properties.intentContract.properties.args.properties.viewTitle","properties.actions.items.properties.intentContract.properties.args.properties.cardId","properties.actions.items.properties.intentContract.properties.message","properties.actions.items.properties.clarification.properties.pendingPlan.properties.chartType","properties.actions.items.properties.clarification.properties.pendingPlan.properties.title","properties.actions.items.properties.clarification.properties.pendingPlan.properties.description","properties.actions.items.properties.clarification.properties.pendingPlan.properties.aggregation","properties.actions.items.properties.clarification.properties.pendingPlan.properties.groupByColumn","properties.actions.items.properties.clarification.properties.pendingPlan.properties.valueColumn","properties.actions.items.properties.clarification.properties.pendingPlan.properties.xValueColumn","properties.actions.items.properties.clarification.properties.pendingPlan.properties.yValueColumn","properties.actions.items.properties.clarification.properties.pendingPlan.properties.secondaryValueColumn","properties.actions.items.properties.clarification.properties.pendingPlan.properties.secondaryAggregation","properties.actions.items.properties.clarification.properties.pendingPlan.properties.defaultTopN","properties.actions.items.properties.clarification.properties.pendingPlan.properties.defaultHideOthers","properties.actions.items.properties.clarification.properties.pendingPlan.properties.orderBy","properties.actions.items.properties.clarification.properties.pendingPlan.properties.orderBy.items.properties.direction","properties.actions.items.properties.clarification.properties.pendingPlan.properties.rowFilter","properties.actions.items.properties.clarification.properties.pendingPlan.properties.rowFilter.properties.column","properties.actions.items.properties.clarification.properties.pendingPlan.properties.rowFilter.properties.values","properties.actions.items.properties.clarification.properties.pendingPlan.properties.limit","properties.plans.items.properties.aggregation","properties.plans.items.properties.groupByColumn","properties.plans.items.properties.valueColumn","properties.plans.items.properties.xValueColumn","properties.plans.items.properties.yValueColumn","properties.plans.items.properties.secondaryValueColumn","properties.plans.items.properties.secondaryAggregation","properties.plans.items.properties.defaultTopN","properties.plans.items.properties.defaultHideOthers","properties.plans.items.properties.orderBy","properties.plans.items.properties.orderBy.items.properties.direction","properties.plans.items.properties.rowFilter","properties.plans.items.properties.rowFilter.properties.column","properties.plans.items.properties.rowFilter.properties.values","properties.plans.items.properties.limit"]),TE=t=>{if(!t)return t;let e=!1;return t.enum&&(e=!0,t.enum.includes(null)||(t.enum=[...t.enum,null])),t.type?Array.isArray(t.type)?t.type.includes("null")||(t.type=[...t.type,"null"]):t.type!=="null"&&(t.type=[t.type,"null"]):e||(t.type=["null"]),t},AE=t=>t.replace(/\.oneOf\[\d+\]/g,"").replace(/\.anyOf\[\d+\]/g,""),br=(t,e="")=>{if(Array.isArray(t))return t.map(r=>br(r,`${e}[]`));if(t&&typeof t=="object"){const r={};for(const[a,o]of Object.entries(t)){if(a==="type"){Array.isArray(o)?r.type=o.map(u=>SE.get(u)??u):r.type=SE.get(o)??o;continue}if(a==="properties"&&o&&typeof o=="object"){r.properties={};for(const[u,d]of Object.entries(o)){const c=e?`${e}.properties.${u}`:`properties.${u}`;r.properties[u]=br(d,c)}continue}if(a==="items"){const u=e?`${e}.items`:"items";r.items=br(o,u);continue}if(a==="oneOf"&&Array.isArray(o)){r.oneOf=o.map((u,d)=>br(u,`${e}.oneOf[${d}]`));continue}if(a==="anyOf"&&Array.isArray(o)){r.anyOf=o.map((u,d)=>br(u,`${e}.anyOf[${d}]`));continue}r[a]=br(o,e?`${e}.${a}`:a)}const s=AE(e);if(r.type==="object"&&C5.has(s)){const a=r.properties?Object.keys(r.properties):[];r.required=a}return xE.has(s)?TE(r):r}const n=AE(e);return xE.has(n)?TE(t):t},J1=br(ov),I5=br(G1),R5=br(H1),N5=br(z1);br(A5);br(E5);const P5=7e3,M5="[Context trimmed due to budget: ",lv=(t,e=P5,n)=>{const r=(n==null?void 0:n.includeTrimNote)??!0,s=n!=null&&n.stageFilter?new Set(Array.isArray(n.stageFilter)?n.stageFilter:[n.stageFilter]):null,o=[...s?t.filter(m=>m.stage?s.has(m.stage):!1):t].sort((m,y)=>{const w=typeof m.priority=="number"?m.priority:5,x=typeof y.priority=="number"?y.priority:5;return w-x}),u=[],d=[];let c=0;o.forEach((m,y)=>{var C;const w=(C=m.content)==null?void 0:C.trim();if(!w)return;const x=w,A=x.length+(u.length>0?2:0);m.required||u.length===0||c+A<=e?(u.push(x),c+=A):d.push(m.label||`Section ${y+1}`)});let p=u.join(`

`);if(r&&d.length>0){const m=`${M5}${d.join(", ")}]`;p=`${p}

${m}`}return{prompt:p,trimmedSections:d}},$o={numberParsing:'- **CRITICAL RULE on NUMBER PARSING**: This is the most common source of errors. To handle numbers that might be formatted as strings (e.g., "$1,234.56", "50%"), you are provided with a safe utility function: `_util.parseNumber(value)`.\n    - **YOU MUST use `_util.parseNumber(value)` for ALL numeric conversions.**\n    - **DO NOT use `parseInt()`, `parseFloat()`, or `Number()` directly.** The provided utility is guaranteed to handle various formats correctly.',splitNumeric:"- **CRITICAL RULE on SPLITTING NUMERIC STRINGS**: If you encounter a single string field that contains multiple comma-separated numbers (which themselves may contain commas as thousand separators, e.g., \"1,234.50,5,678.00,-9,123.45\"), you are provided a utility `_util.splitNumericString(value)` to correctly split the string into an array of number strings.\n    - **YOU MUST use this utility for this specific case.**\n    - **DO NOT use a simple `string.split(',')`**, as this will incorrectly break up numbers.\n    - **Example**: To parse a field 'MonthlyValues' containing \"1,500.00,2,000.00\", your code should be: `const values = _util.splitNumericString(row.MonthlyValues);` This will correctly return `['1,500.00', '2,000.00']`.",dataVsSummaries:`- **Distinguishing Data from Summaries**: Your most critical task is to differentiate between valid data rows and non-data rows (like summaries or metadata).
    - A row is likely **valid data** if it has a value in its primary identifier column(s) (e.g., 'Account Code', 'Product ID') and in its metric columns.
    - **CRITICAL: Do not confuse hierarchical data with summary rows.** Look for patterns in identifier columns where one code is a prefix of another (e.g., '50' is a parent to '5010'). These hierarchical parent rows are **valid data** representing a higher level of aggregation and MUST be kept. Your role is to reshape the data, not to pre-summarize it by removing these levels.
    - A row is likely **non-data** and should be removed if it's explicitly a summary (e.g., contains 'Total', 'Subtotal' in a descriptive column) OR if it's metadata (e.g., the primary identifier column is empty but other columns contain text, like a section header).`,dataframeHelpers:"- **DataFrame Helper DSL**: The runtime provides reliable helpers via `_util`. Use `_util.groupBy(rows, key)`, `_util.pivot(rows, rowKey, columnKey, valueKey, reducer)`, `_util.join(leftRows, rightRows, { leftKey, rightKey, how })`, and `_util.rollingWindow(rows, windowSize, { column, op })` instead of rewriting these routines. These helpers dramatically reduce JavaScript mistakesuse them whenever you need grouping, reshaping, joining, or window calculations."},EE=`
You are an expert data engineer. Your job is to analyze the provided dataset snapshot and, only when necessary, emit JavaScript code that converts it into a tidy, analysis-ready table. Always include the new output schema with precise data types. A tidy table has one column per variable and one row per observation.

Common issues to fix (apply only when observed):
${$o.numberParsing}
${$o.splitNumeric}
${$o.dataVsSummaries}
${$o.dataframeHelpers}
- **Crosstab/Wide Format**: Pivot columns like years/regions back into rows.
- **Multi-header Rows**: Remove banner/header rows before processing.

Response contract:
- Return exactly one JSON object matching the provided schema (explanation, jsFunctionBody, outputColumns).
- If no transformation is required, set jsFunctionBody to null and keep outputColumns aligned with the detected column types (upgrade to date/currency/percentage when obvious).
- If code is emitted, it must end with \`return data;\` (or the transformed array) and rely on the provided \`_util\` helpers for parsing numbers or splitting numeric strings.
`,k5=(t,e,n)=>{const r=t.slice(0,15).map((a,o)=>{const u=[a.type?`type=${a.type}`:null,typeof a.uniqueValues=="number"?`unique${a.uniqueValues}`:null,typeof a.missingPercentage=="number"?`missing=${a.missingPercentage}%`:null].filter(Boolean).join(", ");return`${o+1}. ${a.name}${u?` (${u})`:""}`});return[`Dataset snapshot: ${t.length} columns, ${e.length} sampled rows (raw rows omitted for privacy).`,r.length>0?`Column inventory (first ${Math.min(t.length,15)}):
${r.join(`
`)}`:"No column metadata was provided.","Identify obvious metric columns (amount, revenue, quantity) and dimension columns (region, product, channel). Note any columns that should be cast to date/currency/percentage.",n?`Previous attempt failed with: ${n.message}`:null].filter(Boolean).join(`

`)},O5=(t,e,n)=>`
    You are an expert data analyst. Your task is to convert a user's natural language query into a JavaScript filter function body for a dataset.
    
    **User Query:** "${t}"
    
    **Dataset Columns (Schema):**
    ${JSON.stringify(e,null,2)}
    
    **Sample Data (first 5 rows):**
    ${JSON.stringify(n,null,2)}
    
    **CRITICAL Rules for Code Generation:**
    ${$o.numberParsing}
    ${$o.dataframeHelpers}
    - When comparing strings, convert both the data and the comparison value to the same case (e.g., lower case) using \`.toLowerCase()\` to ensure case-insensitive matching.
    - For date comparisons, you can use \`new Date(row.date_column) > new Date('YYYY-MM-DD')\`.
    - The function you write will be the body of a new Function that receives 'data' (the full array of objects) and '_util'.
    - Your function body MUST start with \`return data.filter(row => ...);\`.
    
    **Your Task:**
    1.  **Analyze Query:** Understand the user's intent. Identify columns, values, and operators (e.g., >, <, =, contains).
    2.  **Write JS Code:** Write a single line of JavaScript that filters the data array.
    3.  **Explain:** Briefly explain the filter you created in plain language.
    
    **Example:**
    - User Query: "show me all rows where sales > 5000 and region is North America"
    - Columns: [{ name: 'sales', type: 'currency' }, { name: 'region', type: 'categorical' }]
    - Your Response (JSON):
    {
      "explanation": "Filtering for rows where 'sales' is greater than 5000 and 'region' is 'North America'.",
      "jsFunctionBody": "return data.filter(row => _util.parseNumber(row.sales) > 5000 && row.region.toLowerCase() === 'north america');"
    }
`,D5=(t,e,n,r,s=[])=>`
    You are a senior business intelligence analyst specializing in ERP and financial data. Your task is to generate a diverse list of insightful analysis plan candidates for a given dataset by identifying common data patterns.
    
    Dataset columns:
    - Categorical: ${t.join(", ")}
    - Numerical: ${e.join(", ")}
    Sample Data (first 5 rows):
    ${JSON.stringify(n,null,2)}

    Historical high-signal views (cached from previous runs):
    ${s.length>0?s.map(a=>`- ${a}`).join(`
`):"None cached yet. Assume this dataset has no prior highlights to reuse."}
    
    Please generate up to ${r} diverse analysis plans.
    **MANDATORY COPY RULE**: Every plan MUST include a natural-language \`description\` (at least 8 characters) that states what the user will learn. Do not leave it blank or use placeholders.
    
    **CRITICAL: Think like a Business/ERP Analyst.**
    1.  **Identify Key Metrics**: First, find the columns that represent measurable values. Look for names like 'VALUE', 'AMOUNT', 'SALES', 'COST', 'QUANTITY', 'PRICE'. These are almost always the columns you should be aggregating (e.g., using 'sum' or 'avg').
    2.  **Identify Dimensions**: Next, find columns that describe the data. Look for names ending in 'CODE', 'ID', 'TYPE', 'CATEGORY', or containing 'NAME', 'DESCRIPTION', 'PROJECT', 'REGION'. These are your primary grouping columns (dimensions).
    3.  **Find Relationships**: Codes and descriptions often go together (e.g., 'PROJECT_CODE' and 'PROJECT_DESCRIPTION'). A very valuable analysis is to group by a description column (which is more human-readable for a chart) and sum a value column.
    4.  **Prioritize High-Value Aggregations**: Focus on creating plans that answer common business questions like 'What are our top revenue sources?', 'Where are the biggest costs?', or 'How are items distributed across categories?'. A simple 'count' is less valuable than a 'sum' of a 'VALUE' or 'AMOUNT' column.
    
    **Example Task**: Given columns ['CODE', 'DESCRIPTION', 'PROJECT_CODE', 'VALUE'], a HIGH-QUALITY plan would be:
    - Title: "Sum of VALUE by DESCRIPTION"
    - Aggregation: 'sum'
    - groupByColumn: 'DESCRIPTION'
    - valueColumn: 'VALUE'
    - Chart Type: 'bar'
    
    For each plan, choose the most appropriate chartType ('bar', 'line', 'pie', 'doughnut', 'scatter', 'combo'). 
    - Use 'line' for time series trends.
    - Use 'bar' for most categorical comparisons, especially for "top X" style reports.
    - Use 'pie' or 'doughnut' for compositions with few categories.
    - Use 'scatter' to show the relationship between two numerical variables.
    - **Use 'combo' (bar + line) to compare two different metrics against the same category (e.g., sum of 'Sales' as bars and average of 'Profit' as a line). You MUST provide both a primary and secondary value column and aggregation for combo charts.**
    
    Rules:
    - For 'scatter' plots, you MUST provide 'xValueColumn' and 'yValueColumn' (both numerical) and you MUST NOT provide 'aggregation' or 'groupByColumn'.
    - For 'combo' charts, you MUST provide 'groupByColumn', 'valueColumn', 'aggregation', 'secondaryValueColumn', and 'secondaryAggregation'.
    - **CRITICAL**: Only use one of the following aggregation types: 'sum', 'count', 'avg'. Do NOT use other statistical measures like 'stddev', 'variance', 'median', etc.
    - Do not create plans that are too granular (e.g., grouping by a unique ID column if there are thousands of them).
    - Never leave the \`description\` empty; summarize the business takeaway in a sentence.

    **Output Format:** Return a single JSON object with this shape:
    {
        "plans": [ /* array of plan objects */ ]
    }
    Do not include any other top-level properties or commentary.
`,L5=(t,e=[])=>`
    You are a Quality Review Data Analyst. Your job is to review a list of proposed analysis plans and their data samples. Your goal is to select ONLY the most insightful and readable charts for the end-user, and configure them for the best default view.
    
    Previously approved high-signal views for this dataset:
    ${e.length>0?e.map(n=>`- ${n}`).join(`
`):"- None cached yet. Prioritize discovering net-new, high-variance stories."}
    
    **Review Criteria & Rules:**
    1.  **Discard Low-Value Charts**: This is your most important task. You MUST discard any plan that is not genuinely insightful.
        - **Example of a low-value chart**: A bar chart where all values are nearly identical (e.g., [77, 77, 77, 76, 78]). This shows uniformity but is not a useful visualization. DISCARD IT.
        - **Example of another low-value chart**: A pie/doughnut chart where one category makes up over 95% of the total. This is not insightful. DISCARD IT.
    2.  **Discard Unreadable Charts**: If a chart groups by a high-cardinality column resulting in too many categories to be readable (e.g., more than 50 tiny bars), discard it unless it's a clear time-series line chart.
    3.  **Configure for Readability**: For good, insightful charts that have a moderate number of categories (e.g., 15 to 50), you MUST add default settings to make them readable. Set \`defaultTopN\` to 8 and \`defaultHideOthers\` to \`true\`.
    4.  **Keep Good Charts**: If a chart is insightful and has a reasonable number of categories (e.g., under 15), keep it as is without adding default settings.
    5.  **Copy Quality Gate**: Reject any plan whose \`description\` is blank, shorter than 8 characters, or not an explanatory sentence.
    6.  **Return the Result**: Your final output must be a JSON object shaped as { "plans": [ ... ] } containing ONLY the good, configured plan objects. Do not include the discarded plans or any additional commentary.
    
    **Proposed Plans and Data Samples:**
    ${JSON.stringify(t,null,2)}
`,$5=(t,e,n)=>{const r=n==="Mandarin"?`Provide a concise, insightful summary in two languages, separated by '---'.
Format: English Summary --- Mandarin Summary`:`Provide a concise, insightful summary in ${n}.`;return`
        You are a business intelligence analyst.
        The following data is for a chart titled "${t}".
        Data:
        ${JSON.stringify(e.slice(0,10),null,2)} 
        ${e.length>10?`(...and ${e.length-10} more rows)`:""}
        ${r}
        The summary should highlight key trends, outliers, or business implications. Do not just describe the data; interpret its meaning.
        For example, instead of "Region A has 500 sales", say "Region A is the top performer, contributing the majority of sales, which suggests a strong market presence there."
    `},U5=(t,e,n)=>`
    You are a senior data analyst. After performing an initial automated analysis of a dataset, your task is to create a concise "Core Analysis Briefing". This briefing will be shown to the user and will serve as the shared foundation of understanding for your conversation.
    Based on the columns and the analysis cards you have just generated, summarize the dataset's primary characteristics.
    Your briefing should cover:
    1.  **Primary Subject**: What is this data fundamentally about? (e.g., "This dataset appears to be about online sales transactions...")
    2.  **Key Metrics**: What are the most important numerical columns? (e.g., "...where the key metrics are 'Sale_Amount' and 'Profit'.")
    3.  **Core Dimensions**: What are the main categorical columns used for analysis? (e.g., "The data is primarily broken down by 'Region' and 'Product_Category'.")
    4.  **Suggested Focus**: Based on the initial charts, what should be the focus of further analysis? (e.g., "Future analysis should focus on identifying the most profitable regions and product categories.")
    
    **Available Information:**
    - **Dataset Columns**: ${JSON.stringify(e.map(r=>r.name))}
    - **Generated Analysis Cards**: ${JSON.stringify(t,null,2)}
    
    Produce a single, concise paragraph in ${n}. This is your initial assessment that you will share with your human counterpart.
`,F5=(t,e)=>`
    You are a proactive data analyst. Review the following summaries of data visualizations you have created. Your task is to identify the single most commercially significant or surprising insight. This could be a major trend, a key outlier, or a dominant category that has clear business implications.
    
    **Generated Analysis Cards & Data Samples:**
    ${JSON.stringify(t,null,2)}

    Your Task:
    1.  **Analyze**: Review all the cards provided.
    2.  **Identify**: Find the ONE most important finding. Don't list everything, just the top insight.
    3.  **Formulate**: Write a concise, user-facing message in ${e} that explains this insight (e.g., "I noticed that sales in August were unusually high, you might want to investigate what caused this spike.").
    4.  **Respond**: Return a JSON object containing this message and the ID of the card it relates to.
`,B5=(t,e)=>`
    You are a senior business strategist. You have been provided with several automated data analyses.
    Your task is to synthesize these individual findings into a single, high-level executive summary in ${e}.
    Here are the individual analysis summaries (they are in English):
    ${t}
    Please provide a concise, overarching summary that connects the dots between these analyses. 
    Identify the most critical business insights, potential opportunities, or risks revealed by the data as a whole.
    Do not just repeat the individual summaries. Create a new, synthesized narrative.
    Your response should be a single paragraph of insightful business analysis.
`,q5=(t,e)=>{const n=t.map((r,s)=>{const a=r.timestamp instanceof Date&&!Number.isNaN(r.timestamp.getTime())?r.timestamp.toISOString():new Date(r.timestamp).toISOString(),o=r.sender==="ai"?"Agent":"User";return`${s+1}. [${a}] ${o}: ${r.text}`}).join(`
`);return`
You are compressing a dialogue between a data analysis agent and the user. Summarize the durable takeaways so the agent can quickly recall prior context.

Instructions:
- Use ${e}.
- Include 23 concise bullet points that capture business insights, commitments, or blockers.
- List any open questions or TODOs separately.
- Mention the relative timing (e.g., "Early discussion", "Later follow-up") so the agent knows where this occurred.
- Do NOT invent facts that aren't in the transcript.

Conversation Transcript:
${n}
`},Y1=(t,e=5)=>{const n=t.length>0?t.slice(-e):[];return n.length===0?"No prior conversation.":n.map(r=>`${r.sender==="ai"?"Agent":"User"}: ${r.text}`).join(`
`)},G5=(t,e,n,r,s,a,o,u)=>{const d=Y1(e,5),c='\nYou are beginning STEP 1 of a multi-stage workflow. Your sole objective in this turn is to emit a high-quality `plan_state_update` action that sets the shared goal tracker for the UI. Do **not** run tools, transformations, DOM actions, or conversational replies yet.\nRequirements for this response:\n- The first action must be `plan_state_update` with goal, contextSummary, progress, nextSteps (each having id + label), blockedBy (or null), observationIds (array, can be empty), confidence (0-1 or null), and updatedAt.\n- Every action you send must include `type`, `responseType`, and `stepId`. The runtime will append metadata such as timestamps and stateTag tokens.\n- Each action\'s `reason` must be no more than 280 characters and clearly state the immediate justification for that step (e.g., "Plan: drafting the chart creation steps").\n- The plan_state_update payload must include `planId`, `currentStepId`, and a comprehensive `steps` array where each entry has `intent` and `status` (`ready`|`in_progress`|`done`).\n- Emit exactly **one** action (the plan_state_update). **Do NOT** include `text_response`; the host UI will provide any greeting copy.\n- If the user\'s latest message is merely a greeting or check-in (e.g., "hi", "hello there", ""), still include a first nextSteps entry with id "acknowledge_user" and a label that confirms you will greet/clarify with them before moving to data work.\n- Keep nextSteps focused on the minimum set of concrete moves (e.g., build chart, run filter, gather clarification). Reference dataset columns exactly as they appear.\n- Return **raw JSON only** (no Markdown fences/backticks, no commentary) and only include the fields described abovedo not invent extra keys.\n- Never wrap the JSON in ``` ``` or prepend/append explanatory text; the response must begin with { and end with }.\n'.trim(),p=`
Recent conversation (last ${Math.min(e.length,5)} turn${Math.min(e.length,5)===1?"":"s"}):
${d}
`.trim(),m=`
The user's latest request is: "${n}"

Output your answer as a JSON object with an "actions" array. Remember: stay in planning mode only; do not issue executions until the goal tracker is established.
`.trim(),y=[{label:"Instructions",content:c,required:!0,priority:0,stage:"seed"},{label:"Recent conversation",content:p,priority:1,stage:"conversation"},{label:"Latest request",content:m,required:!0,priority:2,stage:"action"}],{prompt:w,trimmedSections:x}=lv(y);return x.length>0&&typeof console<"u"&&console.info("[promptBudget] Plan primer trimmed sections:",x),w},K1=(t,e,n,r,s,a,o,u,d,c,p,m)=>{const y=Y1(e,5),x=`${p.length>0?p.slice(-5).map(j=>`- [${j.source}/${j.status.toUpperCase()}] ${j.actionType}: ${j.summary}${j.details?` (${j.details})`:""}`).join(`
`):"No prior tool actions have been recorded yet. You are starting fresh. Always observe before acting."}
- [DATA_VIEW] Raw Data Explorer filter: ${m}`,A=u.length>0?u.slice(-5).map(j=>{const V=j.outputs?JSON.stringify(j.outputs).slice(0,160):"No structured output reported.";return`- [${j.status.toUpperCase()}] ${j.responseType} (action ${j.actionId.slice(-6)}): ${V}`}).join(`
`):"No runtime observations captured yet for this session.",E=d?`Goal: ${d.goal}
Context: ${d.contextSummary||""}
Progress: ${d.progress}
Next Steps:
${d.nextSteps.map((j,V)=>`  ${V+1}. [${j.id}] ${j.label}`).join(`
`)}
Blocked By: ${d.blockedBy||"Nothing reported."}
Confidence: ${typeof d.confidence=="number"?d.confidence.toFixed(2):"Not provided"}
Referenced Observations: ${d.observationIds&&d.observationIds.length>0?d.observationIds.join(", "):"None specified."}`:"No structured goal has been recorded yet. Your first action must be a plan_state_update that defines a clear goal, ties it to current data, and lists concrete next steps.",C=t.length>0?`Column inventory (${t.length} total, showing up to 10): ${t.slice(0,10).map(j=>`${j.name} (${j.type})`).join(", ")}`:"No columns detected.",D=r.length>0?`Existing cards (${r.length} total, showing up to 4):
${r.slice(0,4).map(j=>`- ${j.title}${j.chartType?` (${j.chartType})`:""}`).join(`
`)}`:"No analysis cards visible yet.",O=`Core analysis briefing:
${a||"Not generated yet."}`,T=c?`Data preparation log:
Explanation: ${c.explanation}
Code:
${c.jsFunctionBody}`:"No AI-driven data preparation was performed.",I=o.length>0?`Long-term memory (top ${Math.min(o.length,3)}):
${o.slice(0,3).join(`
---
`)}`:"No relevant long-term memories.",M=`
You are an expert data analyst and strategist operating with a Reason-Act (ReAct) framework. Every action needs a short reason first, then the action payload. Keep final conversational replies in ${s}.
`.trim(),N='\nPLAN TRACKER PROTOCOL (Follow exactly):\n- Every action JSON must include `type`, `responseType`, and `stepId`. The host app will supply timestamps/stateTags after validation.\n- `plan_state_update` entries must list `nextSteps` objects (id + label) and a `steps` array including `intent` + `status`.\n- Emit at most two actions per turn (plan_state_update + one atomic action). Reasons 280 chars referencing the plan step.\n- Use `await_user` when the user must choose; include numbered options and set `meta.awaitUser=true`.\n- For `dom_action`, always specify `domAction.target`. If the target is unknown, fall back to a text_response asking the user.\n- When blocked, set `plan_state_update.blockedBy` to the waiting label (e.g., "awaiting_clarification").\n- Structured tool intents must be placed in `intentContract` (object with `intent`, `tool`, `args`, `awaitUser`, `message`). Supported tools: csv.aggregate, csv.profile, csv.clean_invoice_month, csv.detect_outliers, ui.remove_card, idb.save_view. For ask_clarify set `tool=null` and `awaitUser=true`. Default aggregation "sum" and groupBy [] when unspecified.\n'.trim();`
DATA PREPARATION LOG:
${c?`Explanation: ${c.explanation}
Code:
${c.jsFunctionBody}`:"No AI-driven data preparation was performed."}
`.trim(),`
LONG-TERM MEMORY:
${o.length>0?o.join(`
---
`):"No specific long-term memories are relevant."}
`.trim();const P=`
AGENT PLAN STATE:
${E}
`.trim();r.length>0&&r.slice(0,6).map(j=>`  - ${j.title}${j.chartType?` (${j.chartType})`:""}`).join(`
`);const k=`
Agent runtime notes:
- Pipeline: Context Builder  Planner  Action Dispatcher. Keep plans concise for downstream executors.
`.trim(),$=`
Recent tool actions:
${x}
`.trim(),U=`
Runtime observations (latest up to 5):
${A}
`.trim(),F=`
Recent conversation:
${y||"No prior conversation."}
`.trim(),K=`
Latest user message: "${n}"

Respond with a JSON object containing an "actions" array. Example (pseudocode):
{
  "actions": [
    { "type": "plan_state_update", ... },
    { "type": "text_response", ... }
  ]
}

Primary actions available: text_response, plan_creation, dom_action, execute_js_code, clarification_request, await_user, filter_spreadsheet, proceed_to_analysis. Always acknowledge the user via text_response when you finish a complex step.
- Output raw JSON only (no Markdown fences/backticks). Stick to the documented fields; do not add extra keys or prose outside the JSON object.
- The response must start with { and end with }no greetings or commentary outside the JSON.
`.trim();return[{label:"Seed instructions",content:M,required:!0,priority:0,stage:"seed"},{label:"Plan protocol",content:N,required:!0,priority:1,stage:"seed"},{label:"Conversation",content:F,priority:2,stage:"conversation"},{label:"Context: columns",content:C,priority:3,stage:"context"},{label:"Context: cards",content:D,priority:3,stage:"context"},{label:"Context: analysis briefing",content:O,priority:4,stage:"context"},{label:"Context: data prep",content:T,priority:4,stage:"context"},{label:"Context: long-term memory",content:I,priority:5,stage:"context"},{label:"Context: plan state",content:P,priority:5,stage:"context"},{label:"Context: runtime notes",content:k,priority:7,stage:"context"},{label:"Context: action traces",content:$,priority:7,stage:"context"},{label:"Context: observations",content:U,priority:7,stage:"context"},{label:"Action / user request",content:K,required:!0,priority:8,stage:"action"}]},H5=(t,e,n,r,s,a,o,u,d,c,p,m)=>{const y=K1(t,e,n,r,s,a,o,u,d,c,p,m),{prompt:w,trimmedSections:x}=lv(y);return x.length>0&&typeof console<"u"&&console.info("[promptBudget] Chat prompt trimmed sections:",x),w},z5=(t,e,n,r,s,a,o,u,d,c,p,m,y)=>{const w=K1(e,n,r,s,a,o,u,d,c,p,m,y);return lv(w,void 0,{includeTrimNote:!1,stageFilter:t}).prompt};class W1 extends Error{constructor(e,n){super(e),this.name="JsonCoercionError",this.rawContent=n}}const j5=/```(?:json)?\s*([\s\S]*?)```/i,V5=t=>{try{const e=JSON.parse(t);if(e&&typeof e=="object"&&!Array.isArray(e))return e}catch{return null}return null},J5=t=>{let e=0,n=-1,r=!1,s=!1;for(let a=0;a<t.length;a++){const o=t[a];if(r){if(s){s=!1;continue}if(o==="\\"){s=!0;continue}o==='"'&&(r=!1);continue}if(o==='"'){r=!0;continue}if(o==="{")e===0&&(n=a),e+=1;else if(o==="}"&&e>0&&(e-=1,e===0&&n!==-1))return t.slice(n,a+1).trim()}return null},uv=t=>{if(t&&typeof t=="object"&&!Array.isArray(t))return t;const n=(typeof t=="string"?t:t!=null?String(t):"").trim(),r=[];n&&r.push(n);const s=n.match(j5);s!=null&&s[1]&&r.push(s[1].trim());const a=J5(n);a&&r.push(a);for(const o of r){const u=V5(o);if(u)return u}throw new W1("Failed to parse JSON object.",n)},Y5=async(t,e,n,r)=>{var a,o;let s;for(let u=0;u<3;u++){if((a=r==null?void 0:r.signal)!=null&&a.aborted)throw new DOMException("Aborted","AbortError");try{let d;const c=k5(t,e,s),p="data_prep.plan";if(n.provider==="openai"){if(!n.openAIApiKey)return{explanation:"No transformation needed as API key is not set.",jsFunctionBody:null,outputColumns:t};d=await cs(n,[{role:"system",content:EE},{role:"user",content:c}],{name:"DataPreparationPlan",schema:I5,strict:!0},{signal:r==null?void 0:r.signal,operation:p,onUsage:w=>{var x;return(x=r==null?void 0:r.onUsage)==null?void 0:x.call(r,{...w,operation:p})}})}else{if(!n.geminiApiKey)return{explanation:"No transformation needed as Gemini API key is not set.",jsFunctionBody:null,outputColumns:t};d=await ds(n,`${EE}

${c}`,G1,{signal:r==null?void 0:r.signal,operation:p,onUsage:y=>{var w;return(w=r==null?void 0:r.onUsage)==null?void 0:w.call(r,{...y,operation:p})}})}const m=uv(d);if(m.jsFunctionBody)try{const y={parseNumber:A=>or(A)??0,splitNumericString:$R},x=new Function("data","_util",m.jsFunctionBody)(e,y);if(!Array.isArray(x))throw new Error("Generated function did not return an array.");return m}catch(y){s=y,console.warn(`AI self-correction attempt ${u+1} failed due to JS execution error. Retrying...`,s);continue}return!m.jsFunctionBody&&(!m.outputColumns||m.outputColumns.length===0)&&(m.outputColumns=t),m}catch(d){if((o=r==null?void 0:r.signal)!=null&&o.aborted)throw d;console.error(`Error in data preparation plan generation (Attempt ${u+1}):`,d),s=d}}throw new Error(`AI failed to generate a valid data preparation plan after multiple attempts. Last error: ${s==null?void 0:s.message}`)},K5=new Set(["sum","count","avg"]),Z1=(t,e=4)=>!t||t.length===0?[]:t.slice(0,e).map(n=>{const r=n.qualityScore!=null?`score=${n.qualityScore.toFixed(2)}`:"score=n/a",s=n.tags&&n.tags.length>0?`tags: ${n.tags.slice(0,3).join(", ")}`:"";return`${n.title}  ${n.summary} (${r}${s?`, ${s}`:""})`}),W5=t=>{const e={};return t.forEach(n=>{Object.entries(n||{}).forEach(([r,s])=>{r&&(e[r]||(e[r]={distinct:new Set,total:0}),e[r].total+=1,s!=null&&e[r].distinct.add(String(s)))})}),Object.entries(e).reduce((n,[r,s])=>(n[r]={distinct:s.distinct.size,total:s.total},n),{})},Z5=(t,e)=>{const n=new Set(["categorical","date","time"]),r=e.filter(a=>n.has(a.type)),s=r.find(a=>a.name!==t.valueColumn)??r[0]??e.find(a=>a.name!==t.valueColumn);return(s==null?void 0:s.name)??null},X1=(t,e)=>{const n={...t};if(n.chartType&&n.chartType!=="scatter"&&n.chartType!=="combo"&&!n.groupByColumn){const r=Z5(n,e);r&&(n.groupByColumn=r)}return n},Q1=t=>{if(!t||typeof t!="object"||!t.chartType||!t.title)return console.warn("Skipping invalid plan: missing chartType or title.",t),!1;if(!t.description||typeof t.description!="string"||t.description.trim().length<8)return console.warn("Skipping invalid plan: description missing or too short.",t),!1;if(t.chartType==="scatter"){if(!t.xValueColumn||!t.yValueColumn)return console.warn("Skipping invalid scatter plot plan: missing xValueColumn or yValueColumn.",t),!1}else{if(!t.aggregation||!t.groupByColumn)return console.warn(`Skipping invalid plan: missing aggregation or groupByColumn for chart type ${t.chartType}.`,t),!1;if(!K5.has(t.aggregation))return console.warn(`Skipping invalid plan: unsupported aggregation type "${t.aggregation}".`,t),!1;if(t.aggregation!=="count"&&!t.valueColumn)return console.warn("Skipping invalid plan: missing valueColumn for sum/avg aggregation.",t),!1}return!0},X5=.01,Q5=.95,eG=.9,tG=8,nG=t=>{if(t.length<=1)return!0;const e=Math.max(...t),n=Math.min(...t);if(e===n)return!0;const r=Math.max(Math.abs(e),1);return(e-n)/r<=X5},rG=t=>{if(t.length===0)return!1;const e=t.reduce((r,s)=>r+Math.abs(s),0);return e===0?!0:Math.max(...t.map(r=>Math.abs(r)))/e>=Q5},sG=(t,e)=>{const n=t.groupByColumn;if(!n)return!1;const r=e[n];return!r||r.total<tG?!1:r.distinct/r.total>=eG},aG=(t,e,n)=>{if(t.chartType==="scatter"||t.chartType==="combo"||!Array.isArray(e)||e.length===0)return null;const r=t.valueColumn||"count",s=e.map(a=>Number(a[r])).filter(a=>Number.isFinite(a));return s.length<=1?"not enough variation for a readable chart":nG(s)?"metric values are nearly identical":rG(s)?"a single category carries 95% of the total":sG(t,n)?`grouping column "${t.groupByColumn}" behaves like a unique identifier`:null},iG=(t,e)=>{const n=[],r=[];return t.forEach(s=>{const a=aG(s.plan,s.aggregatedSample,e);if(a){r.push({code:"low_value_plan_discarded",message:`Dropped "${s.plan.title}" because ${a}.`,hint:"This dataset needs a more varied metric or different grouping to produce an informative chart."});return}n.push(s)}),{viablePlans:n,warnings:r}},eP=async(t,e,n,r,s)=>{const a=t.filter(c=>c.type==="categorical"||c.type==="date"||c.type==="time").map(c=>c.name),o=t.filter(c=>c.type==="numerical"||c.type==="currency"||c.type==="percentage").map(c=>c.name);let u;const d=D5(a,o,e,r,Z1(s==null?void 0:s.memorySnapshots));if(n.provider==="openai"){const m=await cs(n,[{role:"system",content:`You are a senior business intelligence analyst specializing in ERP and financial data. Your task is to generate a diverse list of insightful analysis plan candidates for a given dataset by identifying common data patterns.
You MUST respond with JSON that adheres exactly to the provided schema (an array of plan objects) and includes no extra commentary.`},{role:"user",content:d}],{name:"AnalysisPlanArray",schema:J1,strict:!0},{signal:s==null?void 0:s.signal,operation:"analysis_plan.candidates",onUsage:y=>{var w;return(w=s==null?void 0:s.usageCollector)==null?void 0:w.call(s,{...y,label:"plan_candidates"})}});u=Of(m,{rootKey:"plans",requireRootKeyOnly:!0})}else{const c=await ds(n,d,ov,{signal:s==null?void 0:s.signal,operation:"analysis_plan.candidates",onUsage:p=>{var m;return(m=s==null?void 0:s.usageCollector)==null?void 0:m.call(s,{...p,label:"plan_candidates"})}});u=Of(c,{rootKey:"plans",requireRootKeyOnly:!0})}return u.map(c=>X1(c,t)).filter(Q1)},oG=async(t,e,n,r)=>{let s;const a=L5(t,Z1(r==null?void 0:r.memorySnapshots));if(e.provider==="openai"){const c=await cs(e,[{role:"system",content:`You are a Quality Review Data Analyst. Your job is to review a list of proposed analysis plans and their data samples. Select ONLY the most insightful and readable charts and configure them for the best default view.
You MUST respond with JSON that strictly adheres to the provided schema (an array of plan objects) and contains no additional explanation.`},{role:"user",content:a}],{name:"RefinedAnalysisPlanArray",schema:J1,strict:!0},{signal:r==null?void 0:r.signal,operation:"analysis_plan.refine",onUsage:p=>{var m;return(m=r==null?void 0:r.usageCollector)==null?void 0:m.call(r,{...p,label:"plan_refine"})}});s=Of(c,{rootKey:"plans",requireRootKeyOnly:!0})}else{const u=await ds(e,a,ov,{signal:r==null?void 0:r.signal,operation:"analysis_plan.refine",onUsage:d=>{var c;return(c=r==null?void 0:r.usageCollector)==null?void 0:c.call(r,{...d,label:"plan_refine"})}});s=Of(u,{rootKey:"plans",requireRootKeyOnly:!0})}return s.map(u=>u&&u.plan&&typeof u.plan=="object"?u.plan:u).map(u=>X1(u,n)).filter(Q1)},lG=async(t,e,n,r)=>{if(!(n.provider==="google"&&!!n.geminiApiKey||n.provider==="openai"&&!!n.openAIApiKey))throw new Error("API Key not provided.");const a=[],o=W5(e),u=[],d=await eP(t,e,n,12,{signal:r==null?void 0:r.signal,memorySnapshots:r==null?void 0:r.memorySnapshots,usageCollector:A=>u.push(A)});if(d.length===0)return{plans:[],warnings:a,telemetry:u};const c={fileName:"sample",data:e},p=d.map(A=>{try{const E=qR(c,A);return E.length>0?{plan:A,aggregatedSample:E.slice(0,20)}:null}catch(E){return console.warn(`Execution of plan "${A.title}" failed during review stage:`,E),null}}).filter(A=>A!==null),{viablePlans:m,warnings:y}=iG(p,o);if(y.forEach(A=>a.push(A)),m.length===0)return console.warn("No candidate plans produced high-value samples, returning initial valid candidates."),{plans:d.slice(0,4),warnings:a,telemetry:u};let x=await oG(m,n,t,{signal:r==null?void 0:r.signal,memorySnapshots:r==null?void 0:r.memorySnapshots,usageCollector:A=>u.push(A)});if(x.length<4&&d.length>x.length){const A=new Set(x.map(D=>D.title)),E=d.filter(D=>!A.has(D.title)),C=4-x.length;x.push(...E.slice(0,C))}return{plans:x.slice(0,12),warnings:a,telemetry:u}};class tP extends Error{constructor(e,n,r){super(e),this.name="PlanGenerationFatalError",this.warnings=n,r&&(this.cause=r)}}const uG=async(t,e,n,r)=>{if(!(n.provider==="google"&&!!n.geminiApiKey||n.provider==="openai"&&!!n.openAIApiKey))throw new Error("API Key not provided.");const a=[];try{const{plans:o,warnings:u,telemetry:d}=await lG(t,e,n,r);return a.push(...u),{plans:o,warnings:a,telemetry:d}}catch(o){const u=o instanceof bu,d=u?"AI plan response was not valid JSON. Retrying with a simpler generator.":"AI plan generator failed on the first attempt. Retrying with a simpler prompt.";a.push({code:u?"plan_parse_error":"plan_generation_error",message:d,hint:"If this happens repeatedly, ask the assistant to retry with fewer plans."}),console.warn("Plan generation warning:",o);try{const c=[];return{plans:await eP(t,e,n,8,{signal:r==null?void 0:r.signal,memorySnapshots:r==null?void 0:r.memorySnapshots,usageCollector:m=>c.push(m)}),warnings:a,telemetry:c}}catch(c){throw console.error("Fallback plan generation also failed:",c),new tP("Failed to generate any analysis plans from AI.",a,c)}}};class cv{constructor(){this.seq=0,this.lastEpoch=0}mint(e=Date.now(),n){const r=e>this.lastEpoch?e:this.lastEpoch;return r!==this.lastEpoch&&(this.seq=0,this.lastEpoch=r),this.seq+=1,`${r.toString().padStart(13,"0")}-${this.seq}`}}class CE extends Error{constructor(e,n){super(e),this.name="AiChatResponseParsingError",this.rawContent=n}}const cG=t=>{try{const e=uv(t);if(!e.actions||!Array.isArray(e.actions))throw new CE("Invalid response structure: 'actions' array missing.",JSON.stringify(e));return e}catch(e){throw e instanceof W1?new CE(e.message,e.rawContent):e}},IE={plan:{phase:"plan",title:"Plan Primer",summary:"During the PLAN phase you are only confirming the mission. Emit exactly two actions in this order: (1) plan_state_update capturing the refreshed plan tracker, (2) text_response that acknowledges the plan and next steps. Do not run tools or code yet.",expectations:["The plan_state_update includes planId, goal, contextSummary, progress, currentStepId, nextSteps, steps, blockedBy, observationIds, confidence, updatedAt, stateTag.","The text_response should reassure the user that their request is understood and restate what happens next.","No execute_js_code, dom_action, or proceed_to_analysis actions are allowed in this phase."]},talk:{phase:"talk",title:"Conversation & Clarification",summary:"During the TALK phase you keep the user in the loop or gather missing info. Start with a plan_state_update when the context changes, then follow with a conversational action such as text_response, clarification_request, or await_user.",expectations:["Never emit execute_js_code or dom_action in the TALK phase.","If you must wait for the user, use await_user with clear choices; otherwise answer with text_response.","Reuse the existing planId and progress when nothing has changed rather than inventing a new plan."]},act:{phase:"act",title:"Action & Tool Execution",summary:"During the ACT phase you must pair a plan_state_update with a single atomic tool call. Keep the planner in sync, then run exactly one action such as execute_js_code, proceed_to_analysis, filter_spreadsheet, or a dom_action that fulfills the current step.",expectations:["When emitting execute_js_code you must provide runnable JavaScript in code.jsFunctionBody that mutates the data array and returns it.","If you are removing or adjusting cards, prefer dom_action with the correct toolName and target metadata.","Keep the action list to two entries max (plan_state_update plus one tool call) so the runtime can stream progress safely."]}},dG="talk",fG=t=>{const e=t?IE[t]:IE[dG],n=e.expectations.map(r=>`- ${r}`).join(`
`);return`Phase directive  ${e.title}:
${e.summary}
${n}`},pG=t=>t.actions.some(e=>{var r;if(e.responseType!=="execute_js_code")return!1;const n=(r=e.code)==null?void 0:r.jsFunctionBody;return!n||n.trim().length===0}),nP=new cv,hG=`Example JSON response (plan_state_update + text acknowledgement):
\`\`\`json
{
  "actions": [
    {
      "type": "plan_state_update",
      "responseType": "plan_state_update",
      "stepId": "plan-init",
      "reason": "Restating the plan so the UI stays in sync.",
      "planState": {
        "planId": "plan-abc123",
        "goal": "Compare revenue vs. orders by channel.",
        "contextSummary": "User asked for the top-performing channels in 2024.",
        "progress": "Ready to build the comparison card.",
        "blockedBy": null,
        "observationIds": [],
        "confidence": 0.65,
        "updatedAt": "2024-05-18T09:00:00.000Z",
        "currentStepId": "plan-init",
        "nextSteps": [{ "id": "acknowledge_user", "label": "" }],
        "steps": [
          {
            "id": "acknowledge_user",
            "label": "",
            "intent": "conversation",
            "status": "in_progress"
          }
        ],
        "stateTag": "context_ready"
      }
    },
    {
      "type": "text_response",
      "responseType": "text_response",
      "stepId": "plan-init",
      "reason": "Let the user know I captured the plan.",
      "text": ""
    }
  ]
}
\`\`\``,mG=t=>typeof t!="number"||Number.isNaN(t)||!Number.isFinite(t)?.65:Math.min(1,Math.max(0,t)),gG=t=>{if(t.type!=="plan_state_update"||!t.planState)return;const e=t.planState;(typeof e.updatedAt!="string"||!e.updatedAt.trim())&&(e.updatedAt=new Date().toISOString()),(typeof e.stateTag!="string"||!e.stateTag.trim())&&(e.stateTag=nP.mint(Date.now(),"plan")),Array.isArray(e.observationIds)||(e.observationIds=[]),e.blockedBy=e.blockedBy??null,(typeof e.contextSummary!="string"||e.contextSummary.trim().length===0)&&(e.contextSummary=null),e.confidence=mG(e.confidence)},yG=async(t,e,n,r,s,a,o,u,d,c,p,m,y,w)=>{if(!(s.provider==="google"&&!!s.geminiApiKey||s.provider==="openai"&&!!s.openAIApiKey))return{actions:[{type:"text_response",responseType:"text_response",stepId:"ad_hoc_response",stateTag:nP.mint(Date.now(),"fallback"),text:"Cloud AI is disabled. API Key not provided.",reason:"API key is missing, so I must inform the user."}]};try{const A=(w==null?void 0:w.mode)??"full",E=A==="full"?w==null?void 0:w.promptStage:void 0,C=A==="plan_only"?"chat.plan_only":"chat.full",D=(w==null?void 0:w.phase)??(A==="plan_only"?"plan":void 0),O=fG(D),T=A==="plan_only"?G5(t,e,n,s.language,a,u,d,r):E?(Array.isArray(E)?E:[E]).map(P=>z5(P,t,e,n,r,s.language,a,u,d,c,p,m,y)).join(`

`):H5(t,e,n,r,s.language,a,u,d,c,p,m,y);if(w!=null&&w.onPromptProfile){const P=A==="full"&&E?Array.isArray(E)?E.join("+"):E:null,k=A==="plan_only"?"chat_plan_primer":`chat_full${P?`_stage_${P}`:""}`,$=T.length,U=Math.ceil($/4);w.onPromptProfile({mode:A,charCount:$,estimatedTokens:U,promptLabel:k})}const I=`You are an expert data analyst and business strategist, required to operate using a Reason-Act (ReAct) framework. For every action you take, you must first explain your reasoning in the 'reason' field, and then define the action itself. Keep each reason under 280 characters (ideally two sentences or fewer) and tie it to the plan step you're executing. You also maintain an explicit goal tracker by emitting a 'plan_state_update' action at the start of each response (and whenever the mission changes) so the UI can display your progress. Every action JSON object must include \`type\`, \`responseType\`, and \`stepId\`. The runtime appends metadata like timestamps and stateTags automatically, so you may omit them. The plan_state_update payload must include \`planId\`, \`currentStepId\`, and a \`steps\` array (each entry with intent + status). Emit at most two actions per response: the plan_state_update plus a single atomic action. When the user's latest message is only a greeting or check-in, the first entry in \`nextSteps\` (and \`steps\`) must be an \`acknowledge_user\` conversation step before any data work. Your final conversational responses should be in ${s.language}.
${hG}
Your output MUST be a single JSON object with an "actions" key containing an array of action objects. Never wrap the JSON in markdown fences or add commentarythe response must start with '{' and end with '}'.`,M=s.provider==="openai"?2:1;let N="";for(let P=0;P<M;P++){let k;if(s.provider==="openai"){const K=[{role:"system",content:`${I}
${O}${N}`},{role:"user",content:T}];k=await cs(s,K,!1,{signal:w==null?void 0:w.signal,operation:C,onUsage:j=>{var V;return(V=w==null?void 0:w.onUsage)==null?void 0:V.call(w,{...j,operation:C})}})}else{const F=`${T}

${O}`;k=await ds(s,F,void 0,{signal:w==null?void 0:w.signal,operation:C,onUsage:K=>{var j;return(j=w==null?void 0:w.onUsage)==null?void 0:j.call(w,{...K,operation:C})}})}const $=cG(k);if(!$.actions||!Array.isArray($.actions))throw new Error("Invalid response structure from AI: 'actions' array not found.");if($.actions.forEach(F=>gG(F)),s.provider==="openai"&&pG($)&&P<M-1){N=`
IMPORTANT VALIDATION FAILURE: Your previous response included an action with responseType=execute_js_code but did not include a valid code.jsFunctionBody. You must respond with executable JavaScript that mutates the provided data and returns the updated array (including an explicit return statement). Provide only valid JSON matching the required action envelope.`;continue}return $}throw new Error("Failed to obtain a valid AI response after retries.")}catch(A){throw console.error("Error generating chat response:",A),new Error(`Failed to get a valid response from the AI. ${A instanceof Error?A.message:""}`)}},_G=async(t,e,n,r,s)=>{var o,u;let a;for(let d=0;d<2;d++){if((o=s==null?void 0:s.signal)!=null&&o.aborted)throw new DOMException("Aborted","AbortError");try{let c;const p=O5(t,e,n),m="filter.generate";r.provider==="openai"?c=await cs(r,[{role:"system",content:"You are an expert data analyst. Your task is to convert a user's natural language query into a JavaScript filter function body for a dataset. You MUST respond with a single valid JSON object, and nothing else. The JSON object must adhere to the provided schema."},{role:"user",content:p}],{name:"FilterFunctionResponse",schema:R5,strict:!0},{signal:s==null?void 0:s.signal,operation:m,onUsage:A=>{var E;return(E=s==null?void 0:s.onUsage)==null?void 0:E.call(s,{...A,operation:m})}}):c=await ds(r,p,H1,{signal:s==null?void 0:s.signal,operation:m,onUsage:w=>{var x;return(x=s==null?void 0:s.onUsage)==null?void 0:x.call(s,{...w,operation:m})}});const y=JSON.parse(c);if(y.jsFunctionBody&&y.explanation)return y;throw new Error("AI response was missing required fields 'jsFunctionBody' or 'explanation'.")}catch(c){if((u=s==null?void 0:s.signal)!=null&&u.aborted)throw c;console.error(`Error in filter function generation (Attempt ${d+1}):`,c),a=c}}throw new Error(`AI failed to generate a valid filter function. Last error: ${a==null?void 0:a.message}`)},vG=async(t,e,n,r)=>{if(!(n.provider==="google"&&!!n.geminiApiKey||n.provider==="openai"&&!!n.openAIApiKey))return"AI Summaries are disabled. No API Key provided.";try{const a=$5(t,e,n.language),o="summary.generate";return n.provider==="openai"?await cs(n,[{role:"system",content:'You are a business intelligence analyst. Your response must be only the summary text in the specified format. The summary should highlight key trends, outliers, or business implications. Do not just describe the data; interpret its meaning. For example, instead of "Region A has 500 sales", say "Region A is the top performer, contributing the majority of sales, which suggests a strong market presence there."'},{role:"user",content:a}],!1,{signal:r==null?void 0:r.signal,operation:o,onUsage:c=>{var p;return(p=r==null?void 0:r.onUsage)==null?void 0:p.call(r,{...c,operation:o})}})||"No summary generated.":await ds(n,a,void 0,{signal:r==null?void 0:r.signal,operation:o,onUsage:u=>{var d;return(d=r==null?void 0:r.onUsage)==null?void 0:d.call(r,{...u,operation:o})}})}catch(a){return console.error("Error generating summary:",a),"Failed to generate AI summary."}},wG=async(t,e,n,r)=>{if(!(n.provider==="google"&&!!n.geminiApiKey||n.provider==="openai"&&!!n.openAIApiKey)||t.length===0)return"Could not generate an initial analysis summary.";try{const a=U5(t,e,n.language),o="summary.core_analysis";if(n.provider==="openai"){const d=[{role:"system",content:`You are a senior data analyst. After performing an initial automated analysis of a dataset, your task is to create a concise "Core Analysis Briefing". This briefing will be shown to the user and will serve as the shared foundation of understanding for your conversation.
Your briefing should cover:
1.  **Primary Subject**: What is this data fundamentally about? (e.g., "This dataset appears to be about online sales transactions...")
2.  **Key Metrics**: What are the most important numerical columns? (e.g., "...where the key metrics are 'Sale_Amount' and 'Profit'.")
3.  **Core Dimensions**: What are the main categorical columns used for analysis? (e.g., "The data is primarily broken down by 'Region' and 'Product_Category'.")
4.  **Suggested Focus**: Based on the initial charts, what should be the focus of further analysis? (e.g., "Future analysis should focus on identifying the most profitable regions and product categories.")
Produce a single, concise paragraph in ${n.language}. This is your initial assessment that you will share with your human counterpart.`},{role:"user",content:a}];return await cs(n,d,!1,{signal:r==null?void 0:r.signal,operation:o,onUsage:c=>{var p;return(p=r==null?void 0:r.onUsage)==null?void 0:p.call(r,{...c,operation:o})}})||"No summary generated."}else return await ds(n,a,void 0,{signal:r==null?void 0:r.signal,operation:o,onUsage:u=>{var d;return(d=r==null?void 0:r.onUsage)==null?void 0:d.call(r,{...u,operation:o})}})}catch(a){return console.error("Error generating core analysis summary:",a),"An error occurred while the AI was forming its initial analysis."}},bG=async(t,e,n)=>{if(!(e.provider==="google"&&!!e.geminiApiKey||e.provider==="openai"&&!!e.openAIApiKey)||t.length===0)return null;try{let s;const a=F5(t,e.language),o="summary.proactive_insight";return e.provider==="openai"?s=await cs(e,[{role:"system",content:"You are a proactive data analyst. Review the following summaries of data visualizations. Your task is to identify the single most commercially significant or surprising insight. This could be a major trend, a key outlier, or a dominant category that has clear business implications. Your response must be a single JSON object with 'insight' and 'cardId' keys."},{role:"user",content:a}],{name:"ProactiveInsight",schema:N5,strict:!0},{signal:n==null?void 0:n.signal,operation:o,onUsage:c=>{var p;return(p=n==null?void 0:n.onUsage)==null?void 0:p.call(n,{...c,operation:o})}}):s=await ds(e,a,z1,{signal:n==null?void 0:n.signal,operation:o,onUsage:u=>{var d;return(d=n==null?void 0:n.onUsage)==null?void 0:d.call(n,{...u,operation:o})}}),uv(s)}catch(s){return console.error("Error generating proactive insight:",s),null}},RE=async(t,e,n)=>{if(!(e.provider==="google"&&!!e.geminiApiKey||e.provider==="openai"&&!!e.openAIApiKey))return"AI Summaries are disabled. No API Key provided.";const s=t.map(a=>{const o=a.summary.split("---")[0];return`Chart Title: ${a.plan.title}
Summary: ${o}`}).join(`

`);try{const a=B5(s,e.language),o="summary.final";if(e.provider==="openai"){const d=[{role:"system",content:`You are a senior business strategist. You have been provided with several automated data analyses.
Your task is to synthesize these individual findings into a single, high-level executive summary in ${e.language}.
Please provide a concise, overarching summary that connects the dots between these analyses. 
Identify the most critical business insights, potential opportunities, or risks revealed by the data as a whole.
Do not just repeat the individual summaries. Create a new, synthesized narrative.
Your response should be a single paragraph of insightful business analysis.`},{role:"user",content:a}];return await cs(e,d,!1,{signal:n==null?void 0:n.signal,operation:o,onUsage:c=>{var p;return(p=n==null?void 0:n.onUsage)==null?void 0:p.call(n,{...c,operation:o})}})||"No final summary generated."}else return await ds(e,a,void 0,{signal:n==null?void 0:n.signal,operation:o,onUsage:u=>{var d;return(d=n==null?void 0:n.onUsage)==null?void 0:d.call(n,{...u,operation:o})}})}catch(a){return console.error("Error generating final summary:",a),"Failed to generate the final AI summary."}},Yd=t=>t.slice(-6).map(n=>`${n.sender==="ai"?"AI":"User"}: ${n.text}`).join(`
`),SG=async(t,e,n)=>{if(t.length===0)return"";const r=q5(t,e.language),s="memory.conversation_summary";if(!(e.provider==="google"&&!!e.geminiApiKey||e.provider==="openai"&&!!e.openAIApiKey))return Yd(t);try{if(e.provider==="openai"){const d=[{role:"system",content:`You compress conversations between a user and an AI analyst into concise memory notes.
Each response must:
- Contain 23 bullet points summarizing the decisions or insights.
- List outstanding questions or promised follow-ups.
- Mention roughly when in the conversation this occurred (e.g., "Early discussion").
Return plain text in ${e.language}.`},{role:"user",content:r}];return await cs(e,d,!1,{signal:n==null?void 0:n.signal,operation:s,onUsage:p=>{var m;return(m=n==null?void 0:n.onUsage)==null?void 0:m.call(n,{...p,operation:s})}})||""||Yd(t)}return await ds(e,r,void 0,{signal:n==null?void 0:n.signal,operation:s,onUsage:u=>{var d;return(d=n==null?void 0:n.onUsage)==null?void 0:d.call(n,{...u,operation:s})}})||Yd(t)}catch(o){return console.error("Failed to generate conversation memory summary:",o),Yd(t)}},M_=(t,e)=>e.some(n=>t instanceof n);let NE,PE;function xG(){return NE||(NE=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function TG(){return PE||(PE=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const k_=new WeakMap,wg=new WeakMap,bp=new WeakMap;function AG(t){const e=new Promise((n,r)=>{const s=()=>{t.removeEventListener("success",a),t.removeEventListener("error",o)},a=()=>{n(Ci(t.result)),s()},o=()=>{r(t.error),s()};t.addEventListener("success",a),t.addEventListener("error",o)});return bp.set(e,t),e}function EG(t){if(k_.has(t))return;const e=new Promise((n,r)=>{const s=()=>{t.removeEventListener("complete",a),t.removeEventListener("error",o),t.removeEventListener("abort",o)},a=()=>{n(),s()},o=()=>{r(t.error||new DOMException("AbortError","AbortError")),s()};t.addEventListener("complete",a),t.addEventListener("error",o),t.addEventListener("abort",o)});k_.set(t,e)}let O_={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return k_.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Ci(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function rP(t){O_=t(O_)}function CG(t){return TG().includes(t)?function(...e){return t.apply(D_(this),e),Ci(this.request)}:function(...e){return Ci(t.apply(D_(this),e))}}function IG(t){return typeof t=="function"?CG(t):(t instanceof IDBTransaction&&EG(t),M_(t,xG())?new Proxy(t,O_):t)}function Ci(t){if(t instanceof IDBRequest)return AG(t);if(wg.has(t))return wg.get(t);const e=IG(t);return e!==t&&(wg.set(t,e),bp.set(e,t)),e}const D_=t=>bp.get(t);function dv(t,e,{blocked:n,upgrade:r,blocking:s,terminated:a}={}){const o=indexedDB.open(t,e),u=Ci(o);return r&&o.addEventListener("upgradeneeded",d=>{r(Ci(o.result),d.oldVersion,d.newVersion,Ci(o.transaction),d)}),n&&o.addEventListener("blocked",d=>n(d.oldVersion,d.newVersion,d)),u.then(d=>{a&&d.addEventListener("close",()=>a()),s&&d.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),u}const RG=["get","getKey","getAll","getAllKeys","count"],NG=["put","add","delete","clear"],bg=new Map;function ME(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(bg.get(e))return bg.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,s=NG.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||RG.includes(n)))return;const a=async function(o,...u){const d=this.transaction(o,s?"readwrite":"readonly");let c=d.store;return r&&(c=c.index(u.shift())),(await Promise.all([c[n](...u),s&&d.done]))[0]};return bg.set(e,a),a}rP(t=>({...t,get:(e,n,r)=>ME(e,n)||t.get(e,n,r),has:(e,n)=>!!ME(e,n)||t.has(e,n)}));const PG=["continue","continuePrimaryKey","advance"],kE={},L_=new WeakMap,sP=new WeakMap,MG={get(t,e){if(!PG.includes(e))return t[e];let n=kE[e];return n||(n=kE[e]=function(...r){L_.set(this,sP.get(this)[e](...r))}),n}};async function*kG(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,MG);for(sP.set(n,e),bp.set(n,D_(e));e;)yield n,e=await(L_.get(n)||e.continue()),L_.delete(n)}function OE(t,e){return e===Symbol.asyncIterator&&M_(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&M_(t,[IDBIndex,IDBObjectStore])}rP(t=>({...t,get(e,n,r){return OE(e,n)?kG:t.get(e,n,r)},has(e,n){return OE(e,n)||t.has(e,n)}}));const OG={showNewButton:!0,showSettingsButton:!0},Sg=t=>{if(typeof t!="string")return;const e=t.trim();return e.length?e:void 0},DG=t=>{if(typeof t!="string")return;const e=t.trim().toLowerCase();if(e==="google")return"google";if(e==="openai")return"openai"},LG=t=>{if(typeof t!="string")return;switch(t.trim().toLowerCase()){case"english":return"English";case"mandarin":return"Mandarin";case"spanish":return"Spanish";case"japanese":return"Japanese";case"french":return"French";default:return}},DE=t=>{if(typeof t=="boolean")return t;if(typeof t!="string")return;const e=t.trim().toLowerCase();if(["y","yes","true","1"].includes(e))return!0;if(["n","no","false","0"].includes(e))return!1},aP=()=>typeof window>"u"?{}:window.__CSV_AGENT_DEFAULTS__??{},$G=()=>{if(typeof window>"u")return{};const t={},e=Sg(window.tempGeminiApiKey??window.tempgeminiapikey);e&&(t.geminiApiKey=e);const n=Sg(window.tempOpenAIApiKey??window.tempopenaiapikey);n&&(t.openAIApiKey=n);const r=DG(window.tempProvider??window.tempprovider);r&&(t.provider=r);const s=Sg(window.tempModel??window.tempmodel);s&&(t.model=s);const a=LG(window.tempLanguage??window.templanguage);return a&&(t.language=a),t},UG=()=>{if(typeof window>"u")return{};const t={},e=DE(window.tempShowNewButton??window.tempshownewbutton);typeof e=="boolean"&&(t.showNewButton=e);const n=DE(window.tempShowSettingsButton??window.tempshowsettingsbutton);return typeof n=="boolean"&&(t.showSettingsButton=n),t},FG=()=>({...aP().defaultSettings??{},...$G()}),iP=()=>{const t=aP().ui??{};return{...OG,...t,...UG()}},oP="csv-ai-assistant-db",BG=3,Ii="reports",lP="csv-ai-assistant-settings",Ma="current_session";let xg=null;const qG=()=>new Promise((t,e)=>{const n=indexedDB.deleteDatabase(oP);n.onsuccess=()=>t(),n.onerror=()=>e(n.error),n.onblocked=()=>{console.warn("IndexedDB delete is blocked. Close other tabs to complete reset.")}}),LE=()=>dv(oP,BG,{upgrade(t,e){if(!t.objectStoreNames.contains(Ii)){t.createObjectStore(Ii,{keyPath:"id"}).createIndex("updatedAt","updatedAt");return}const n=t.transaction.objectStore(Ii);e<2&&!n.indexNames.contains("updatedAt")&&n.createIndex("updatedAt","updatedAt")}}),Sp=()=>(xg||(xg=LE().catch(async t=>{if(t instanceof DOMException&&t.name==="VersionError")return console.warn("IndexedDB version mismatch detected. Resetting local database...",t),await qG(),LE();throw t})),xg),$_=async t=>{await(await Sp()).put(Ii,t)},Gu=async t=>{try{return await(await Sp()).get(Ii,t)}catch(e){console.error("Failed to get report from IndexedDB:",e);return}},GG=async()=>{try{return(await(await Sp()).getAllFromIndex(Ii,"updatedAt")).sort((n,r)=>r.updatedAt.getTime()-n.updatedAt.getTime()).map(({id:n,filename:r,createdAt:s,updatedAt:a})=>({id:n,filename:r,createdAt:s,updatedAt:a}))}catch(t){return console.error("Failed to get reports list from IndexedDB:",t),[]}},U_=async t=>{try{await(await Sp()).delete(Ii,t)}catch(e){console.error("Failed to delete report from IndexedDB:",e)}},HG={provider:"google",geminiApiKey:"",openAIApiKey:"",model:"gemini-2.5-pro",language:"English",autoSaveEnabled:!0,autoSaveIntervalSeconds:15},$E=()=>({...HG,...FG()}),zG=t=>{try{localStorage.setItem(lP,JSON.stringify(t))}catch(e){console.error("Failed to save settings to localStorage:",e)}},UE=()=>{try{const t=localStorage.getItem(lP);if(t){const e=JSON.parse(t);return e.apiKey&&delete e.apiKey,{...$E(),...e}}}catch(t){console.error("Failed to get settings from localStorage:",t)}return $E()};let Tg=null;const jG=async()=>(Tg||(Tg=(async()=>{const t="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1/dist/transformers.min.js";try{return await import(t)}catch(e){throw console.error("Failed to load @xenova/transformers from CDN.",e),e}})()),Tg);class Uo{constructor(){this.embedder=null,this.documents=[],this.isInitializing=!1,this.isInitialized=!1}static getInstance(){return Uo.instance||(Uo.instance=new Uo),Uo.instance}getIsInitialized(){return this.isInitialized}async init(e){if(!(this.isInitialized||this.isInitializing))try{this.isInitializing=!0;const{pipeline:n,env:r}=await jG();r.allowRemoteModels=!0,r.allowLocalModels=!0,r.useBrowserCache=!0,r.cacheDir=r.cacheDir||"indexeddb://ai-memory-models",r.localModelPath=r.localModelPath||"indexeddb://ai-memory-models",e==null||e("Loading AI memory model (~34MB). We'll cache it locally after the first download."),this.embedder=await n("feature-extraction","Xenova/all-MiniLM-L6-v2",{progress_callback:s=>{if(s.status==="progress"&&s.total>0){const a=(s.loaded/1024/1024).toFixed(2),o=(s.total/1024/1024).toFixed(2);e==null||e(`Downloading AI memory model: ${a}MB / ${o}MB`)}}}),e==null||e("AI memory model ready (cached locally for future sessions)."),this.isInitialized=!0}catch(n){console.error("Failed to initialize vector store:",n),e==null||e(`Error loading AI memory model: ${n instanceof Error?n.message:String(n)}`),this.isInitialized=!1}finally{this.isInitializing=!1}}rehydrate(e){this.documents=e}async addDocument(e){if(!this.embedder){console.warn("Vector store not initialized. Skipping document add/update.");return}try{const n=await this.embedder(e.text,{pooling:"mean",normalize:!0}),r={...e,embedding:Array.from(n.data)},s=this.documents.findIndex(a=>a.id===e.id);s>-1?this.documents[s]=r:this.documents.push(r)}catch(n){console.error(`Failed to create embedding for document ${e.id}:`,n)}}deleteDocument(e){const n=this.documents.length;return this.documents=this.documents.filter(r=>r.id!==e),this.documents.length<n}getDocumentCount(){return this.documents.length}getDocuments(){return[...this.documents]}clear(){this.documents=[]}async withAbort(e,n){if(!n)return e;if(n.aborted)throw new DOMException("Aborted","AbortError");return new Promise((r,s)=>{const a=()=>{n.removeEventListener("abort",a),s(new DOMException("Aborted","AbortError"))};n.addEventListener("abort",a),e.then(o=>{n.removeEventListener("abort",a),r(o)},o=>{n.removeEventListener("abort",a),s(o)})})}async search(e,n=5,r){if(!this.embedder||this.documents.length===0)return[];try{const s=await this.withAbort(this.embedder(e,{pooling:"mean",normalize:!0}),r==null?void 0:r.signal),a=Array.from(s.data);return this.documents.map(u=>{const d=this.cosineSimilarity(a,u.embedding);return{id:u.id,text:u.text,score:d}}).filter(u=>u.score>.5).sort((u,d)=>d.score-u.score).slice(0,n)}catch(s){return console.error("Failed to perform vector search:",s),[]}}cosineSimilarity(e,n){let r=0,s=0,a=0;for(let o=0;o<e.length;o++)r+=e[o]*n[o],s+=e[o]*e[o],a+=n[o]*n[o];return s===0||a===0?0:r/(Math.sqrt(s)*Math.sqrt(a))}}const wt=Uo.getInstance(),F_=async(t,e,n,r={})=>{const s=!!r.runId,a=r.runId??t.beginBusy(e,{cancellable:r.cancellable});try{return await n(a)}finally{s||t.endBusy(a)}},FE=["categorical","date","time"],VG=(t,e,n=500)=>{if(!t.length)return 0;const r=new Set,s=Math.min(t.length,n);for(let a=0;a<s;a++){const o=t[a][e];if(o==null)continue;const u=String(o).trim();if(u&&(r.add(u),r.size>200))break}return r.size},fv=(t,e)=>{if(!t.length)return[];const n=t.map(s=>({profile:s,uniqueValues:typeof s.uniqueValues=="number"?s.uniqueValues:VG(e,s.name)})),r=n.filter(({profile:s,uniqueValues:a})=>a>1&&(FE.includes(s.type)||a<=50)).sort((s,a)=>{const o=y=>FE.includes(y)?0:1,u=o(s.profile.type),d=o(a.profile.type);if(u!==d)return u-d;const c=12,p=Math.abs((s.uniqueValues||100)-c),m=Math.abs((a.uniqueValues||100)-c);return p-m});return r.length>0?r:n.filter(s=>(s.uniqueValues||0)>1)},uP=(t,e)=>{const n=fv(t,e);return n.length?{column:n[0].profile.name,inferred:!0}:{column:null,inferred:!1}},JG=["sum","count","avg"],YG=25,cP=t=>t.toLowerCase().replace(/[^a-z0-9]+/g,""),BE=(t,e,n)=>{if(!e)return;const r=t.get(e)??[];r.includes(n)||(r.push(n),t.set(e,r))},KG=(t,e)=>{const n=new Set;t.forEach(a=>{a!=null&&a.name&&n.add(a.name)});for(let a=0;a<Math.min(e.length,YG);a++)Object.keys(e[a]??{}).forEach(o=>n.add(o));const r=new Map,s=new Map;return n.forEach(a=>{BE(r,a.toLowerCase(),a),BE(s,cP(a),a)}),{exact:n,caseInsensitive:r,normalized:s}},dP=(t,e)=>{if(!t)return{};if(e.exact.has(t))return{resolved:t};const n=e.caseInsensitive.get(t.toLowerCase());if(n&&n.length===1)return{resolved:n[0]};const r=cP(t);if(r){const s=e.normalized.get(r);if(s&&s.length===1)return{resolved:s[0]};if(s&&s.length>1)return{ambiguous:s}}return{}},WG=(t,e)=>{if(t){const r=t.toLowerCase();if(JG.includes(r))return{value:r,inferred:!1}}return{value:e?"sum":"count",inferred:!0}},cu=(t,e,n,r)=>{const s=t[e];if(!s||typeof s!="string")return{success:!0};const a=dP(s,n);return a.ambiguous&&a.ambiguous.length>1?{success:!1,errorMessage:`Column "${s}" is ambiguous. Choose one of: ${a.ambiguous.join(", ")}.`}:a.resolved?(a.resolved!==s&&(t[e]=a.resolved,r.push(`Normalized column "${s}" to "${a.resolved}".`)),{success:!0}):{success:!1,errorMessage:`Column "${s}" was not found in this dataset.`}},ZG=(t,e,n)=>{const r={...t},s=[],a=KG(e,n);if(r.chartType==="scatter"){if(!r.xValueColumn||!r.yValueColumn)return{plan:r,warnings:s,isValid:!1,errorMessage:"Scatter plot plan is missing xValueColumn or yValueColumn."};const p=cu(r,"xValueColumn",a,s);if(!p.success)return{plan:r,warnings:s,isValid:!1,errorMessage:p.errorMessage};const m=cu(r,"yValueColumn",a,s);return m.success?{plan:r,warnings:s,isValid:!0}:{plan:r,warnings:s,isValid:!1,errorMessage:m.errorMessage}}if(!n.length)return{plan:r,warnings:s,isValid:!1,errorMessage:"Dataset appears empty for analysis."};const o=WG(r.aggregation,!!r.valueColumn);if(o.inferred?(r.aggregation=o.value,s.push(`AI plan missing aggregation; defaulting to ${o.value}.`)):r.aggregation=o.value,r.aggregation!=="count"&&!r.valueColumn&&(r.aggregation="count",s.push("Value column missing for sum/avg; using count aggregation instead.")),r.chartType==="combo"){if(!r.valueColumn||!r.secondaryValueColumn)return{plan:r,warnings:s,isValid:!1,errorMessage:"Combo chart requires both valueColumn and secondaryValueColumn."};r.secondaryAggregation||(r.secondaryAggregation=r.aggregation??"sum",s.push("Secondary aggregation missing; mirroring primary aggregation."))}const u=!r.valueColumn||r.aggregation==="count"?"count":r.valueColumn;if(!r.groupByColumn){const p=uP(e,n);if(p.column)r.groupByColumn=p.column,s.push(`AI plan missing grouping; defaulting to "${p.column}".`);else return{plan:r,warnings:s,isValid:!1,errorMessage:"Unable to infer a grouping column for this chart."}}const d=cu(r,"groupByColumn",a,s);if(!d.success)return{plan:r,warnings:s,isValid:!1,errorMessage:d.errorMessage};const c=cu(r,"valueColumn",a,s);if(!c.success)return{plan:r,warnings:s,isValid:!1,errorMessage:c.errorMessage};if(r.chartType==="combo"){const p=cu(r,"secondaryValueColumn",a,s);if(!p.success)return{plan:r,warnings:s,isValid:!1,errorMessage:p.errorMessage}}if(!Array.isArray(r.orderBy)||r.orderBy.length===0?r.chartType==="line"&&r.groupByColumn?r.orderBy=[{column:r.groupByColumn,direction:"asc"}]:r.orderBy=[{column:u,direction:"desc"}]:r.orderBy=r.orderBy.map(p=>({column:p.column,direction:p.direction??(r.chartType==="line"?"asc":"desc")})),typeof r.limit!="number"&&typeof r.defaultTopN=="number"&&(r.limit=r.defaultTopN),r.rowFilter){const p=r.rowFilter.column;let m=p??null;if(p){const x=dP(p,a);if(x.ambiguous&&x.ambiguous.length>1)return{plan:r,warnings:s,isValid:!1,errorMessage:`Row filter column "${p}" is ambiguous. Options: ${x.ambiguous.join(", ")}.`};x.resolved?x.resolved!==p&&(m=x.resolved,s.push(`Row filter column "${p}" normalized to "${m}".`)):m=null}const y=m?a.exact.has(m):!1,w=Array.isArray(r.rowFilter.values)&&r.rowFilter.values.length>0;if(!p||!y||!w){const x=[];p?y||x.push(`column "${p}" not found`):x.push("missing column"),w||x.push("no filter values provided");const A=x.length?` (${x.join(", ")})`:"";s.push(`Row filter invalid${A}; removing filter.`),delete r.rowFilter}else m&&r.rowFilter.column!==m&&(r.rowFilter.column=m)}return{plan:r,warnings:s,isValid:!0}},XG=t=>t.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,""),QG=t=>{const e=new Set,n=XG(t);n&&n!==t&&e.add(n);const r=n.match(/^[a-z]\d?_(.+)$/);return r&&r[1]&&e.add(r[1]),n.includes("__")&&e.add(n.replace(/_+/g,"_")),n.startsWith("column_")&&e.add(n.replace(/^column_/,"")),Array.from(e).filter(Boolean)},Hu=t=>{const e={};return t.forEach(n=>{QG(n).forEach(s=>{e[s]||(e[s]=n)})}),e},eH=(t,e)=>{const n=Object.entries(e);return n.length===0?t:t.map(r=>{const s={...r};for(const[a,o]of n)!(a in s)&&s[o]!==void 0&&(s[a]=s[o]);return s})},tH=(t,e)=>{const n=Object.entries(e);return n.length===0?t:t.map(r=>{const s={...r};for(const[a,o]of n)Object.prototype.hasOwnProperty.call(s,a)&&(Object.prototype.hasOwnProperty.call(s,o)||(s[o]=s[a]),delete s[a]);return s})},qE=t=>t.toLowerCase().replace(/[_-]+/g," ").replace(/[^a-z0-9 ]/g," ").replace(/\s+/g," ").trim(),zu=["groupByColumn","valueColumn","xValueColumn","yValueColumn","secondaryValueColumn"],Gf=(t,e,n=1,r=1/0)=>{if(!e||e.length===0)return!1;const s=e.map(o=>o[t]).filter(o=>o!=null&&String(o).trim()!=="");if(s.length===0)return!1;const a=new Set(s.map(o=>String(o))).size;return a>=n&&a<=r},fP=(t,e,n)=>{if(!zu.includes(e))return t.value;const r=n.find(o=>o===t.value);if(r)return r;const s=n.find(o=>o.toLowerCase()===t.value.toLowerCase());if(s)return s;const a=qE(t.label);return n.find(o=>a.includes(qE(o)))},nH=(t,e,n,r)=>{var d;if(!zu.includes(t.targetProperty)||!e||e.length===0)return t;const s=((d=r==null?void 0:r.preferredColumns)==null?void 0:d.filter(c=>typeof c=="string"&&c.trim().length>0))??[],a=Array.from(new Set([...n,...s])),o=new Set(t.columnHints??[]),u=t.options.map(c=>{const p=fP(c,t.targetProperty,a);if(!p)return null;o.add(p);const m=s.includes(p);if(t.targetProperty==="groupByColumn"){if(!Gf(p,e,2,m?1/0:50))return null}else if(!Gf(p,e))return null;return{...c,value:p}}).filter(c=>c!==null);return u.length===0?null:{...t,options:u,columnHints:Array.from(o)}},GE=(t,e)=>{if(!t)return null;const n=e.find(r=>r.name===t);return n?n.name:t},rH=(t,e)=>{const n=GE(t.valueColumn,e)||(t.aggregation==="count"?"Records":"Value"),r=GE(t.groupByColumn,e)||(t.chartType==="scatter"?"X Axis":"Category"),s={"[metric]":n,"[value]":n,"[dimension]":r,"[group]":r},a=c=>{if(!c)return!1;const p=c.replace(/\s+/g,"");return/(.{3,20})\1{3,}/i.test(p)},o=(c,p)=>{if(!c||c.trim()==="")return p;let m=c;for(const y of Object.keys(s)){const w=new RegExp(y,"gi");m=m.replace(w,s[y])}return/\[.*\]/.test(m)||m.length>150||a(m)?p:m.trim()},u=`${n} by ${r}`,d=`A chart showing ${n} grouped by ${r}.`;return{...t,title:o(t.title,u),description:o(t.description,d)}},sH="",aH="",iH="",oH="",lH=t=>{let e=t.trim();return e=e.replace(/^\*\*(.+)\*\*$/,"$1").trim(),e=e.replace(/^\*+/,"").replace(/\*+$/,"").trim(),e=e.replace(/^["']+/,"").replace(/["']+$/,"").trim(),e=e.replace(/\s*\(\s*(?:optional|default)\s*\)\s*$/i,"").trim(),e=e.replace(/[:;]+$/,"").trim(),e},uH=[/^([0-9]+|[A-Za-z])[\.\)\]]\s+(.+)$/,/^([0-9]+|[A-Za-z])[]\s+(.+)$/,/^[(\[]?(?:option|choice)?\s*([0-9]+|[A-Za-z])[\)\]\.:-]\s+(.+)$/i,/^([0-9]+|[A-Za-z])\s*[-]\s+(.+)$/,/^[-]\s*(?:option|choice)?\s*([0-9]+|[A-Za-z])?[:\.\-\)]?\s+(.+)$/i],cH=new RegExp(String.raw`(?:^|\n)\s*(?:[\(\\[]?\s*(?:option|choice)?\s*)?([0-9]+|[A-Za-z])[\)\]\.:-]\s+([^\n]+?)(?=\n|$)`,"gi"),pP=t=>{const e=t.replace(/\r/g,"").replace(new RegExp(sH,"g"),".").replace(new RegExp(aH,"g"),"(").replace(new RegExp(iH,"g"),")").replace(new RegExp(oH,"g"),""),n=e.split(/\n+/).map(a=>a.trim()),r=new Set,s=a=>{if(!a)return;const o=lH(a);!o||o.length<2||o.length>140||r.add(o)};for(const a of n)if(a)for(const o of uH){const u=a.match(o);if(u&&u[2]){s(u[2]);break}}if(r.size===0){let a;for(;(a=cH.exec(e))!==null&&(s(a[2]),!(r.size>=5)););}return Array.from(r).slice(0,5)},hP=["context_ready","needs_clarification","transform_drafted","transform_ready","analysis_shared","awaiting_data","error_retrying","awaiting_clarification"],dH=/(remove|delete)\s+card/i,fH=/(filter|show|find)\s+(all\s+)?(rows|entries|records|data)/i,pH=/(clean|transform|restructure|normalize|standardize|add\s+column|create\s+column|calculate)/i,hH=/(which|what)\s+(column|field|value)/i,mH=/^(hi|hello|hey|hola|ciao|salut|+|||||||)([!.?\s]|$)/i,gH=/(how\s+are\s+you||thanks|thank\s+you|||what'?s\s+up|)/i,yH=/^\s*(?:option|choice)?\s*(?:[1-3]|[abc])(?:[\s.:,-].*)?$/i,_H=(t,e)=>{var r,s;const n=(t||"").trim();if(!n)return{intent:"unknown",confidence:.1};if(mH.test(n))return{intent:"greeting",confidence:.9};if(gH.test(n))return{intent:"smalltalk",confidence:.75};if(yH.test(n))return{intent:"ask_user_choice",confidence:.8};if(dH.test(n)){const a=Array.isArray(e.analysisCards)?e.analysisCards:[],o=n.toLowerCase(),u=a.find(d=>{var p;const c=(p=d==null?void 0:d.plan)==null?void 0:p.title;return typeof c=="string"&&o.includes(c.toLowerCase())});return u?{intent:"remove_card",confidence:.95,requiredTool:{responseType:"dom_action",domToolName:"removeCard",payloadHints:{cardId:u.id,cardTitle:(r=u.plan)==null?void 0:r.title}},payloadHints:(s=u.plan)!=null&&s.title?{cardTitle:u.plan.title}:void 0}:{intent:"remove_card",confidence:.8,requiredTool:null}}return fH.test(n)?{intent:"data_filter",confidence:.75,requiredTool:{responseType:"filter_spreadsheet"},payloadHints:{query:n}}:pH.test(n)?{intent:"data_transform",confidence:.7,requiredTool:{responseType:"execute_js_code"}}:hH.test(n)||n.endsWith("?")?{intent:"clarification",confidence:.6}:{intent:"chart_request",confidence:.4}},mP=[{name:"plan_state_update",description:"Update the shared plan tracker before any other action.",tags:["plan","safe","low_latency"],costEstimate:1,latencyClass:"short",risk:"low"},{name:"text_response",description:"Send a conversational reply to the user and suggest next actions.",tags:["conversation","starter","safe","low_latency"],quickActionLabel:" (Ask anything)",costEstimate:1,latencyClass:"short",risk:"low"},{name:"dom_action",description:"Modify an existing insight card (highlight, toggle legend, etc.).",tags:["dom","ui"],costEstimate:3,latencyClass:"medium",risk:"medium"},{name:"dom_action.removeCard",description:"Remove an existing chart card by id or title.",tags:["dom","destructive"],costEstimate:4,latencyClass:"medium",risk:"medium",applicableIf:{intentsAny:["remove_card"]}},{name:"filter_spreadsheet",description:"Apply a natural-language filter to the raw data explorer.",tags:["data","tool","safe","starter"],quickActionLabel:" rows",costEstimate:2,latencyClass:"short",risk:"low",applicableIf:{intentsAny:["data_filter"]}},{name:"execute_js_code",description:"Run a JavaScript transform to reshape the dataset.",tags:["data","transform"],costEstimate:5,latencyClass:"long",risk:"high",applicableIf:{intentsAny:["data_transform"]}},{name:"clarification_request",description:"Ask the user to choose between concrete options.",tags:["conversation","safe","low_latency"],quickActionLabel:"",costEstimate:2,latencyClass:"short",risk:"low"},{name:"plan_creation",description:"Create a batch of chart plans for later execution.",tags:["plan","analysis"],costEstimate:4,latencyClass:"medium",risk:"medium"},{name:"proceed_to_analysis",description:"Signal that the AI is ready to summarize results.",tags:["conversation"],costEstimate:1,latencyClass:"short",risk:"low"}],HE=new Map(mP.map(t=>[t.name,t])),vH=t=>{var n;const e=(t.type??t.responseType??"").trim();if(!e)return"unknown";if(e==="dom_action"){const r=(n=t.domAction)==null?void 0:n.toolName;return r?`${e}.${r}`:e}return e},wH=t=>{const e=vH(t);return HE.get(e)??HE.get(e.split(".")[0])},bH=[{id:"greeting_minimal",intent:"greeting",success_criteria:["user_follow_up"],ui:{message_template:`{{greeting}}I am ready to explore your CSV now. 
{{quick_choice_list}}
()`,quick_action_rules:[{source:"tools",filter:{tags_any:["starter","safe","low_latency"],context:["idle"]},top_k:5}]},governance:{max_tokens:80,deny_tools_if:{latency_class:["long"],risk:["high"]}}},{id:"remove_card_flow",intent:"remove_card",success_criteria:["card_removed"],ui:{message_template:'Removing the card "{{cardTitle}}" from the dashboard now.'},governance:{deny_tools_if:{risk:["high"]}}}],SH=t=>{if(t)return bH.find(e=>e.intent===t)},Hf="ad_hoc_response",zE=()=>`prompt-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,xH=["text_response","await_user","plan_creation","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request","plan_state_update"],TH={plan_update:"plan_state_update",planstateupdate:"plan_state_update",domaction:"dom_action",agent_action:"text_response",agentaction:"text_response",respond:"text_response"},AH={plan_state_update:"Auto-initialized plan tracker to keep progress visible.",text_response:"Auto-generated acknowledgement to keep the chat responsive.",await_user:"Pausing to gather your clarification before continuing.",plan_creation:"Creating the requested analysis plan.",dom_action:"Executing the requested UI adjustment.",execute_js_code:"Running the requested data transformation.",proceed_to_analysis:"Proceeding with the pending analysis step.",filter_spreadsheet:"Applying the requested data filter.",clarification_request:"Need an answer to continue with the plan."},jE=t=>{if(!t)return null;const e=t.trim().toLowerCase();return e?TH[e]??xH.find(r=>r===e)??null:null},EH=t=>{var e;return t.domAction?"dom_action":t.code?"execute_js_code":t.plan?"plan_creation":t.args?"filter_spreadsheet":t.clarification?"clarification_request":(e=t.meta)!=null&&e.awaitUser?"await_user":"text_response"},CH=t=>{const n=jE(t.responseType)??jE(t.type)??EH(t);return t.type=n,t.responseType=n,n},IH=(t,e)=>{if(t!=null&&t.currentStepId&&B_(t.currentStepId))return t.currentStepId.trim();const n=e.find(r=>B_(r==null?void 0:r.id));return n?n.id.trim():Hf},pv=()=>({id:Hf,label:"Respond directly to the latest request.",intent:"conversation",status:"ready"}),B_=t=>typeof t=="string"&&t.trim().length>=3,VE=t=>{if(!Array.isArray(t))return[];const e=new Set,n=[];for(const r of t){const s=typeof(r==null?void 0:r.id)=="string"?r.id.trim():"",a=typeof(r==null?void 0:r.label)=="string"?r.label.trim():"";if(s.length<3||a.length<3||e.has(s))continue;const o=typeof(r==null?void 0:r.intent)=="string"&&r.intent.trim().length>0?r.intent.trim():r==null?void 0:r.intent,u=(r==null?void 0:r.status)??"ready";n.push({id:s,label:a,intent:o,status:u}),e.add(s)}return n},gP=(t,e)=>{var r;const n=pv();return{planId:`plan-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,goal:(r=t.detectedIntent)!=null&&r.intent?`Address user intent: ${t.detectedIntent.intent}`:"Acknowledge the user and clarify analysis goals.",contextSummary:t.userMessage.slice(0,200),progress:"Initialized plan scaffold automatically.",nextSteps:[n],steps:[n],currentStepId:n.id,blockedBy:null,observationIds:[],confidence:.6,updatedAt:new Date(t.now).toISOString(),stateTag:e()}},yP=(t,e,n)=>{const r=t??gP(e,n);let s=VE(r.steps),a=VE(r.nextSteps);a.length===0&&(a=s.length>0?s:[pv()]),s.length===0&&(s=a);let o=B_(r.currentStepId)?r.currentStepId.trim():a[0].id;s.some(p=>p.id===o)||(s=[{...a[0],id:o,status:a[0].status??"ready"},...s]),a.some(p=>p.id===o)||(a=[{...s[0],id:o,status:s[0].status??"ready"},...a]);const u=typeof e.userMessage=="string"?e.userMessage.slice(0,200):"",d=typeof r.contextSummary=="string"&&r.contextSummary.trim().length>0?r.contextSummary:u||"User intent pending clarification.",c=typeof r.updatedAt=="string"&&r.updatedAt.trim().length>0?r.updatedAt:new Date().toISOString();return{...r,planId:r.planId??`plan-${Date.now().toString(36)}`,currentStepId:o,nextSteps:a,steps:s,contextSummary:d,updatedAt:c,stateTag:r.stateTag??n()}},RH=t=>{t.intentContract===void 0&&(t.intentContract=null),t.meta===void 0&&(t.meta={awaitUser:!1,haltAfter:!1,resumePlanner:!1,promptId:""}),t.planState===void 0&&(t.planState=null),t.text===void 0&&(t.text=null),t.cardId===void 0&&(t.cardId=null),t.awaitUserPayload===void 0&&(t.awaitUserPayload=null),t.plan===void 0&&(t.plan=null),t.domAction===void 0&&(t.domAction=null),t.code===void 0&&(t.code=null),t.args===void 0&&(t.args=null),t.clarification===void 0&&(t.clarification=null)},JE=(t,e,n,r,s)=>{var o;if(t.responseType!=="plan_state_update")return;const a=!!t.planState;t.planState=yP(t.planState,e,()=>n("plan")),a||s.push("plan_state_update missing planState; auto-generated scaffold."),(!t.planState.nextSteps||t.planState.nextSteps.length===0)&&(t.planState.nextSteps=(o=t.planState.steps)!=null&&o.length?t.planState.steps:[pv()],r.push("Backfilled nextSteps for plan_state_update."))},NH=(t,e,n)=>{if(t.responseType!=="dom_action"||!t.domAction)return;const r=t.domAction.args??(t.domAction.args={}),s=t.domAction.target??(t.domAction.target={});!s.byId&&typeof r.cardId=="string"&&(s.byId=r.cardId),!s.byTitle&&typeof r.cardTitle=="string"&&(s.byTitle=r.cardTitle),!s.byId&&!s.byTitle&&!s.selector&&(n.push("DOM payload missing target; downgraded to text response."),t.domAction=void 0,t.responseType="text_response",t.type="text_response",t.text="Target not found, please select.")},PH=(t,e,n,r)=>{const s=[...t],a=[],o=[];let u=!1;const d=!!(r!=null&&r.stampOnly),c=w=>{w.stateTag||(w.stateTag=n(w.responseType??"plan_state_update"),u=!0,a.push(`Stamped stateTag for ${w.responseType??"action"}.`)),w.responseType==="plan_state_update"&&JE(w,e,n,a,o)};if((()=>{var A;if(d){s.forEach(c);return}let w=s.findIndex(E=>(E.type??E.responseType)==="plan_state_update");if(w===-1&&(s.unshift({type:"plan_state_update",responseType:"plan_state_update",stepId:Hf,stateTag:n("plan"),reason:"Seeding plan tracker automatically.",planState:gP(e,()=>n("plan"))}),u=!0,a.push("Inserted plan_state_update because no active plan was found."),w=0),w>0){const[E]=s.splice(w,1);s.unshift(E),u=!0,a.push("Moved plan_state_update to the beginning of the turn.")}const x=s[0];x.planState=yP(x.planState,e,()=>n("plan")),x.stepId=x.stepId??((A=x.planState)==null?void 0:A.currentStepId)??Hf,x.stateTag||(x.stateTag=n("plan"))})(),d)return{actions:s,report:{mutated:u,notes:a,warnings:o}};const m=IH(e.planState,e.pendingSteps),y=(w,x)=>{x==="await_user"&&(w.meta=w.meta??{awaitUser:!0,haltAfter:!0,resumePlanner:!1,promptId:zE()},w.meta.promptId||(w.meta.promptId=zE()))};return s.forEach(w=>{var E;const x=CH(w);RH(w);const A=typeof w.reason=="string"?w.reason.trim():"";A?w.reason=A:(w.reason=AH[x]??`Auto-filled rationale for ${x}.`,u=!0,a.push(`Filled missing reason for ${x}.`)),x==="plan_state_update"?(JE(w,e,n,a,o),w.stepId=w.stepId??((E=w.planState)==null?void 0:E.currentStepId)??m):((!w.stepId||w.stepId.trim().length<3)&&(w.stepId=m,u=!0,a.push(`Attached stepId=${m} to ${x}.`)),y(w,x)),w.stateTag||(w.stateTag=n(x),u=!0),NH(w,a,o)}),{actions:s,report:{mutated:u,notes:a,warnings:o}}},q_={low:.1,medium:.4,high:.9},G_={short:.1,medium:.3,long:.7},YE=[" Profile CSV / (auto profile)"," KPI Salesperson  (top/bottom)",""],MH=t=>t.map((e,n)=>`${n+1}) ${e}`).join(`
`),kH=(t,e)=>{var n,r,s;if((n=e.filter)!=null&&n.tags_any&&!e.filter.tags_any.some(a=>t.tags.includes(a)))return!1;if((r=e.filter)!=null&&r.context&&e.filter.context.length>0){const a=(s=t.applicableIf)==null?void 0:s.context;if(a&&!e.filter.context.some(o=>a.includes(o)))return!1}return!0},OH=t=>{if(!(t!=null&&t.ui.quick_action_rules)||t.ui.quick_action_rules.length===0)return YE;const e=[];for(const s of t.ui.quick_action_rules){if(s.source!=="tools")continue;const a=Math.max(1,s.top_k??3);for(const o of mP){if(!kH(o,s))continue;const u=o.quickActionLabel??o.description??o.name;if(!(!u||e.includes(u))&&(e.push(u),e.length>=a))break}}const n=e.length>=2?e:[...e,...YE];return Array.from(new Set(n)).slice(0,4)},DH=(t,e)=>{var n;return t?t==="remove_card"?e.responseType==="dom_action"&&((n=e.domAction)==null?void 0:n.toolName)==="removeCard":t==="data_filter"?e.responseType==="filter_spreadsheet":t==="data_transform"?e.responseType==="execute_js_code":t==="clarification"?e.responseType==="clarification_request":t==="greeting"||t==="smalltalk"||t==="ask_user_choice"?e.responseType==="text_response":!1:!1},LH=(t,e,n={})=>{var a,o;const r=((o=(a=e.detectedIntent)==null?void 0:a.payloadHints)==null?void 0:o.cardTitle)??"the selected card",s={greeting:" hi",quick_actions:n.quick_actions??"[Filter Data, Create Chart, Clean Data]",quick_choice_list:n.quick_choice_list??"",cardTitle:r,userMessage:e.userMessage??""};return Object.entries(s).reduce((u,[d,c])=>{const p=new RegExp(`{{\\s*${d}\\s*}}`,"gi");return u.replace(p,()=>c??"")},t)},_P=(t,e)=>{var o;const n=t.ui.message_template.includes("{{quick_choice_list}}"),r=n?OH(t):[],s=n?MH(r):"",a=n?{quick_actions:r.join(", "),quick_choice_list:s}:void 0;return{type:"text_response",responseType:"text_response",stepId:((o=e.planState)==null?void 0:o.currentStepId)??"ad_hoc_response",reason:`Applying playbook ${t.id} for intent ${t.intent}.`,text:LH(t.ui.message_template,e,a)}},vP=new Set(["greeting","smalltalk","ask_user_choice"]),Fs={id:"acknowledge_user_greeting",label:"Acknowledge the greeting and ask what to analyze next.",intent:"conversation",status:"in_progress"},$H=()=>({planId:null,goal:"Acknowledge the user and gather their request.",contextSummary:"User greeted the assistant; no task has been specified yet.",progress:"Greeting acknowledged.",nextSteps:[Fs],steps:[Fs],currentStepId:Fs.id,blockedBy:null,observationIds:[],confidence:.5,updatedAt:new Date().toISOString(),stateTag:"context_ready"}),UH=t=>{var n,r,s,a,o,u;const e={...t.planState??$H(),goal:((n=t.planState)==null?void 0:n.goal)||"Acknowledge the user and gather their request.",contextSummary:((r=t.planState)==null?void 0:r.contextSummary)??"User greeted the assistant; awaiting instructions.",progress:((s=t.planState)==null?void 0:s.progress)||"Greeting acknowledged.",nextSteps:(a=t.planState)!=null&&a.nextSteps&&t.planState.nextSteps.length>0?t.planState.nextSteps:[Fs],steps:(o=t.planState)!=null&&o.steps&&t.planState.steps.length>0?t.planState.steps:[Fs],currentStepId:((u=t.planState)==null?void 0:u.currentStepId)??Fs.id,stateTag:"context_ready",updatedAt:new Date().toISOString()};return{...t,planState:e,stateTag:"context_ready"}},FH=(t,e)=>t?{...t,type:"text_response",responseType:"text_response",stepId:t.stepId??e,meta:t.meta?{...t.meta,awaitUser:!1,haltAfter:!1}:void 0}:null,BH=(t,e,n)=>{var u,d;if(!vP.has(((u=e.detectedIntent)==null?void 0:u.intent)??""))return t;const r=t.find(c=>c.responseType==="plan_state_update")??{type:"plan_state_update",responseType:"plan_state_update",reason:"Auto-initialized greeting plan tracker.",stepId:((d=e.planState)==null?void 0:d.currentStepId)??Fs.id},s=n?_P(n,e):{type:"text_response",responseType:"text_response",stepId:r.stepId??Fs.id,reason:"Auto-generated greeting response.",text:" CSV "},o=FH(t.find(c=>c.responseType==="text_response"),s.stepId??Fs.id)??s;return[UH(r),o]},Ag=(t,e,n,r)=>{var m,y;const s=wH(t),a=t.responseType==="plan_state_update"?1.2:.8,o=DH((m=e.detectedIntent)==null?void 0:m.intent,t)?.4:0,u=(y=t.reason)!=null&&y.trim()?Math.min(1,.5+t.reason.trim().length/200):.4,d=(s==null?void 0:s.costEstimate)??3,c=q_[(s==null?void 0:s.risk)??"medium"]??.4,p=G_[(s==null?void 0:s.latencyClass)??"medium"]??.3;return{action:t,source:n,playbookId:r==null?void 0:r.id,utility:a+o,confidence:u,cost:d,risk:c,latency:p}},qH=t=>t.utility+t.confidence-t.cost*.1-t.risk-t.latency,GH=(t,e)=>{var s;if(!((s=e==null?void 0:e.governance)!=null&&s.deny_tools_if))return t;const{latency_class:n,risk:r}=e.governance.deny_tools_if;return t.filter(a=>{const o=a.risk,u=a.latency,d=r==null?void 0:r.some(p=>p==="high"&&o>=q_.high||p==="medium"&&o>=q_.medium),c=n==null?void 0:n.some(p=>p==="long"&&u>=G_.long||p==="medium"&&u>=G_.medium);return!d&&!c})},HH=(t,e)=>{if(t.length===0)return[];const n=t.map(o=>({...o,score:qH(o)})).sort((o,u)=>(u.score??0)-(o.score??0)),r=n.filter(o=>o.action.responseType==="plan_state_update"),s=n.filter(o=>o.action.responseType!=="plan_state_update"),a=[];return r.length>0&&(!e.planState||r[0].source!=="model")||r.length>0?a.push(r[0].action):!e.planState&&s.length>0&&a.push({type:"plan_state_update",responseType:"plan_state_update",reason:"Auto-initializing plan because model skipped it.",stepId:"ad_hoc_response"}),s.length>0&&a.push(s[0].action),a.slice(0,2)},KE=(t,e)=>{var n;return t.length>0?t:[{type:"text_response",responseType:"text_response",stepId:((n=e.planState)==null?void 0:n.currentStepId)??"ad_hoc_response",reason:"Fallback explanation: no valid actions after governance.",text:"I am ready to helpplease let me know what to analyze or adjust."}]};class zH{constructor(){this.stateTagFactory=new cv}run(e,n){var p,m,y;const r=n.promptMode==="plan_only",s=Array.isArray(e.actions)?e.actions:[],a=SH((p=n.detectedIntent)==null?void 0:p.intent);let o=s.map(w=>Ag(w,n,"model"));if(o.length===0&&a){const w=_P(a,n);o.push(Ag(w,n,"playbook",a))}if(a&&o.every(w=>w.action.responseType!=="plan_state_update")){const w={type:"plan_state_update",responseType:"plan_state_update",stepId:((m=n.planState)==null?void 0:m.currentStepId)??"ad_hoc_response",reason:`Playbook ${a.id} requires a plan snapshot.`,planState:n.planState??void 0};o.unshift(Ag(w,n,"playbook",a))}o=GH(o,a);let u=HH(o,n);vP.has(((y=n.detectedIntent)==null?void 0:y.intent)??"")?(u=BH(u,n,a),u=KE(u,n)):r||(u=KE(u,n));const c=PH(u,n,w=>this.stateTagFactory.mint(n.now,w),{stampOnly:r});return{...e,actions:c.actions}}}const jH=()=>new zH,wP=2e3,VH=1e3,bP=3e3,SP=3e3,JH=5e3,YH="<NULL>",WE=(t,e)=>typeof t=="number"&&t>0?Math.min(e,t):e,fc=t=>({trimWhitespace:(t==null?void 0:t.trimWhitespace)??!0,caseStrategy:(t==null?void 0:t.caseStrategy)??"lower",nullReplacement:(t==null?void 0:t.nullReplacement)??YH}),KH=(t,e)=>{const n=e==null?void 0:e.rowCountHint,r=(e==null?void 0:e.preferredMode)==="full"||(e==null?void 0:e.preferredMode)===void 0,s=new Date().toISOString();return{datasetId:t,mode:r?"full":"sample",allowFullScan:r,sampleSize:WE(n,bP),profileSampleSize:WE(n,wP),timeoutMs:SP,updatedAt:s,stringStrategy:fc()}},H_=(t,e)=>({...t,...e,datasetId:t.datasetId,updatedAt:new Date().toISOString(),stringStrategy:fc({...t.stringStrategy,...e.stringStrategy})}),WH=t=>t?{...t,stringStrategy:fc(t.stringStrategy)}:null,xP=t=>({strategy:t,pipeline:[t.trimWhitespace?"trim":"preserve-whitespace","toString",t.caseStrategy==="lower"?"toLowerCase":"case-as-is",`nullCoalesce(${t.nullReplacement})`]}),hv="csv_agent_db",ZE=5,Di="provenance",Bs="clean_rows",Tr="columns",os="views",Yo="preparation_log",qs="memory_snapshots",Gs="dataset_runtime_config",ju="system_meta",XE="csv_agent_db is in read-only fallback because the last migration failed. Close other tabs or clear site data, then reload.",ZH=32;let bi=null,_f=null,z_=!1,Ru=null;const Nu=[],XH=t=>{if(!(t!=null&&t.stringStrategy))return!0;const{caseStrategy:e,trimWhitespace:n,nullReplacement:r}=t.stringStrategy;return typeof n!="boolean"||e!=="as-is"&&e!=="lower"||typeof r!="string"||r.length===0},QH=async t=>{const e=WH(t??null);return t&&e&&XH(t)&&await yv(e),e},xp=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,ez=[{version:1,description:"Initialize core CSV Agent object stores.",up:t=>{[Di,Bs,Tr,os,Yo,qs,Gs].forEach(n=>tC(t,n))}},{version:5,description:"Add system meta store for migration logging.",up:t=>{tC(t,ju)}}],tz=t=>{var e;if((e=t==null?void 0:t.db)!=null&&e.objectStoreNames.contains(ju))try{const n=t.objectStore(ju);for(;Nu.length>0;){const r=Nu[0];n.put(r),Nu.shift()}}catch(n){console.warn("Failed to persist migration log entry.",n)}},QE=(t,e)=>{const n={id:`migration-${e.version}-${xp()}`,type:"migration",version:e.version,description:e.description,status:e.status,error:e.error??null,createdAt:new Date().toISOString()};Nu.push(n),tz(t)},nz=(t,e,n,r)=>{if(!r)return;const s=ez.filter(a=>a.version>n&&a.version<=r).sort((a,o)=>a.version-o.version);for(const a of s)try{a.up(t,e),QE(e,{version:a.version,description:a.description,status:"succeeded"})}catch(o){throw Ru=a.version,QE(e,{version:a.version,description:a.description,status:"failed",error:o instanceof Error?o.message:String(o)}),o}},rz=(t,e)=>{const n=e.filter(r=>!t.objectStoreNames.contains(r));if(n.length>0)throw new Error(`Missing object stores: ${n.join(", ")}`)},eC=async()=>(_f||(_f=dv(hv,void 0,{blocked:()=>console.warn("csv_agent_db read-only open is blocked by another tab.")})),_f),TP=async()=>{await new Promise((t,e)=>{const n=indexedDB.deleteDatabase(hv);n.onsuccess=()=>t(),n.onerror=()=>e(n.error),n.onblocked=()=>console.warn("IndexedDB delete blocked. Close other tabs to proceed.")}),bi=null,_f=null,z_=!1,Ru=null,Nu.length=0},tC=(t,e)=>{if(!t.objectStoreNames.contains(e)){if(e===Bs){t.createObjectStore(e,{keyPath:"chunkId"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(e===Tr){t.createObjectStore(e,{keyPath:"datasetId"});return}if(e===os){t.createObjectStore(e,{keyPath:"id"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(e===Di){t.createObjectStore(e,{keyPath:"datasetId"});return}if(e===Yo){t.createObjectStore(e,{keyPath:"id"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(e===qs){const n=t.createObjectStore(e,{keyPath:"id"});n.createIndex("by_dataset","datasetId",{unique:!1}),n.createIndex("by_view","viewId",{unique:!1});return}if(e===Gs){t.createObjectStore(e,{keyPath:"datasetId"});return}if(e===ju){const n=t.createObjectStore(e,{keyPath:"id"});n.createIndex("by_type","type",{unique:!1}),n.createIndex("by_version","version",{unique:!1});return}throw new Error(`Unsupported store name: ${e}`)}},sz=async t=>{try{return await t()}catch(e){if(e instanceof DOMException&&e.name==="VersionError")return console.warn("IndexedDB version mismatch detected. Resetting csv_agent_db...",e),await TP(),t();throw e}},az=[Di,Bs,Tr,os,Yo,qs,Gs,ju],Er=async(t=[],e)=>{const n=(e==null?void 0:e.mode)??"readonly",r=Array.from(new Set([...az,...t]));if(z_){if(n==="readwrite")throw new Error(XE);return eC()}bi||(Ru=null,bi=sz(()=>dv(hv,ZE,{upgrade(s,a,o,u){nz(s,u,a,o??ZE)},blocked:()=>console.warn("csv_agent_db upgrade is blocked by another tab."),blocking:()=>console.warn("csv_agent_db upgrade is blocking existing tabs. Reload others to proceed."),terminated:()=>{bi=null}})));try{const s=await bi;return rz(s,r),s}catch(s){if(Ru!==null){if(console.error(`csv_agent_db migration to version ${Ru} failed; entering read-only fallback.`,s),z_=!0,bi=null,n==="readwrite")throw new Error(XE);return eC()}throw bi=null,s}},iz=(t,e)=>{const n=[];for(let r=0;r<t.length;r+=e)n.push(t.slice(r,r+e));return n},oz=async t=>{const{datasetId:e,rows:n,columns:r,provenance:s,chunkSize:a=2e4}=t;if(!e)throw new Error("persistCleanDataset requires datasetId.");const o=async d=>{const p=(await Er([Bs,Tr,os],{mode:"readwrite"})).transaction([Bs,Tr,Di],"readwrite"),m=p.objectStore(Bs),y=p.objectStore(Tr),w=p.objectStore(Di),x=iz(n,a),A=new Date().toISOString();try{let C=await m.index("by_dataset").openCursor(e);for(;C;)await C.delete(),C=await C.continue();for(let T=0;T<x.length;T+=1){const I=x[T],M={chunkId:`${e}-chunk-${T}`,datasetId:e,rowCount:I.length,startRow:T*a,endRow:T*a+I.length-1,rows:I,createdAt:A};await m.put(M)}const D={datasetId:e,columnCount:r.length,columns:r,rowCount:n.length,updatedAt:A};await y.put(D);const O={datasetId:e,fileName:s.fileName,bytes:s.bytes,checksum:s.checksum,cleanedAt:s.cleanedAt,normalization:xP(d.stringStrategy)};return await w.put(O),await p.done,{chunkCount:x.length,rowCount:n.length}}catch(E){try{p.abort()}catch{}throw await p.done.catch(()=>{}),E}},u=async()=>{const d=await _v(e,{rowCountHint:n.length});return o(d)};try{return await u()}catch(d){if(d instanceof DOMException&&d.name==="NotFoundError")return console.warn("IndexedDB store missing detected. Resetting and retrying persist...",d),await TP(),u();throw d}},AP=async t=>{const{datasetId:e,title:n,kind:r,queryHash:s,explainer:a,dataRef:o}=t,d=(await Er([os],{mode:"readwrite"})).transaction(os,"readwrite"),c=d.objectStore(os),p=`${e}-view-${xp()}`,m={id:p,datasetId:e,title:n,kind:r,queryHash:s,explainer:a,dataRef:o,createdAt:new Date().toISOString()};return await c.put(m),await d.done,p},lz=async t=>{const e=await Er([os]);try{const n=e.transaction(os,"readonly"),a=await n.objectStore(os).index("by_dataset").getAll(t);return await n.done,a}catch(n){return console.warn(`Failed to read card results for ${t}`,n),[]}},EP=async t=>{const n=(await Er()).transaction(Di,"readonly"),s=await n.objectStore(Di).get(t);return await n.done,s??void 0},mv=async t=>{const n=(await Er([Tr])).transaction(Tr,"readonly"),s=await n.objectStore(Tr).get(t);return await n.done,s??null},gv=async(t,e)=>{const r=(await Er([Bs])).transaction(Bs,"readonly"),a=r.objectStore(Bs).index("by_dataset");let o=!1;const u=()=>{o=!0};let d=await a.openCursor(t);for(;d&&!o;){const c=d.value;if(await e(c,u),o)break;d=await d.continue()}await r.done},uz=async t=>{let e=0;return await gv(t,n=>{const r=typeof n.rowCount=="number"?n.rowCount:n.rows.length;e+=r}),e};async function CP(t){const n=(await Er([Gs])).transaction(Gs,"readonly"),s=await n.objectStore(Gs).get(t);return await n.done,QH(s)}async function yv(t){const n=(await Er([Gs],{mode:"readwrite"})).transaction(Gs,"readwrite");await n.objectStore(Gs).put(t),await n.done}async function _v(t,e){const n=await CP(t);if(n)return n;const r=KH(t,{rowCountHint:e==null?void 0:e.rowCountHint,preferredMode:e==null?void 0:e.preferredMode});return await yv(r),r}async function cz(t,e,n){const r=await _v(t,{rowCountHint:n==null?void 0:n.rowCountHint}),s=H_(r,e);return await yv(s),s}const IP=async(t,e)=>{const n=[];return await gv(t,(r,s)=>{for(const a of r.rows)if(n.push(a),n.length>=e){s();break}}),n},RP=async t=>{const e=[];return await gv(t,n=>{e.push(...n.rows)}),e},dz=(t,e)=>{const n=new Date().toISOString();return e.map((r,s)=>({...r,datasetId:t,id:r.id??`${t}-prep-${xp()}`,stepOrder:typeof r.stepOrder=="number"?r.stepOrder:s,scope:r.scope??"dataset",columnName:r.columnName??null,source:r.source??"ai_plan",tags:r.tags??[],createdAt:r.createdAt??n}))},nC=async(t,e=[])=>{if(!t)throw new Error("replacePreparationLog requires datasetId.");const r=(await Er([Yo],{mode:"readwrite"})).transaction(Yo,"readwrite"),s=r.objectStore(Yo);let o=await s.index("by_dataset").openCursor(t);for(;o;)await o.delete(),o=await o.continue();if(e.length>0){const u=dz(t,e).sort((d,c)=>d.stepOrder-c.stepOrder||new Date(d.createdAt).getTime()-new Date(c.createdAt).getTime());for(const d of u)await s.put(d)}await r.done},fz=async(t,e,n=ZH)=>{const r=await t.index("by_dataset").getAll(e);if(r.length<=n)return;const s=r.sort((u,d)=>{const c=(d.qualityScore??0)-(u.qualityScore??0);return c!==0?c:new Date(d.createdAt).getTime()-new Date(u.createdAt).getTime()}).slice(0,n),a=new Set(s.map(u=>u.id)),o=r.filter(u=>!a.has(u.id));for(const u of o)await t.delete(u.id)},pz=async t=>{var a,o;if(!t.datasetId)throw new Error("saveMemorySnapshot requires datasetId.");const n=(await Er([qs],{mode:"readwrite"})).transaction(qs,"readwrite"),r=n.objectStore(qs),s={...t,id:t.id??t.viewId??t.cardId??`${t.datasetId}-memo-${xp()}`,createdAt:t.createdAt??new Date().toISOString(),plan:t.plan??null,viewId:t.viewId??null,cardId:t.cardId??null,summary:t.summary??"",title:t.title??"Untitled View",sampleRows:t.sampleRows??[],tags:t.tags??[],chartType:t.chartType??((a=t.plan)==null?void 0:a.chartType),queryHash:t.queryHash??null,rowCount:typeof t.rowCount=="number"?t.rowCount:((o=t.sampleRows)==null?void 0:o.length)??0,sampled:t.sampled??!1,expiresAt:t.expiresAt??null};return await r.put(s),await fz(r,s.datasetId),await n.done,s.id},hz=async(t,e)=>{if(!t)return[];const n=await Er([qs]);try{const r=n.transaction(qs,"readonly"),o=await r.objectStore(qs).index("by_dataset").getAll(t);await r.done;const u=o.filter(c=>e!=null&&e.minScore?(c.qualityScore??0)>=e.minScore:!0).filter(c=>{var p;return e!=null&&e.tag?(p=c.tags)==null?void 0:p.includes(e.tag):!0}).sort((c,p)=>{const m=(p.qualityScore??0)-(c.qualityScore??0);return m!==0?m:new Date(p.createdAt).getTime()-new Date(c.createdAt).getTime()}),d=(e==null?void 0:e.limit)??u.length;return u.slice(0,d)}catch(r){return console.warn(`Failed to read memory snapshots for ${t}`,r),[]}},mz=2e3,gz=async t=>{try{const[e,n]=await Promise.all([IP(t,mz),uz(t)]);if(n===0||e.length===0)return console.warn(`CSV Agent: unable to rebuild column metadata for ${t} because the dataset has no cached rows.`),null;const r=$u(e),s={datasetId:t,columnCount:r.length,columns:r,rowCount:n,updatedAt:new Date().toISOString()},o=(await Er([Tr],{mode:"readwrite"})).transaction(Tr,"readwrite");return await o.objectStore(Tr).put(s),await o.done,console.info(`CSV Agent: rebuilt missing column metadata for dataset ${t}.`),s}catch(e){return console.error(`CSV Agent: failed to rebuild column metadata for dataset ${t}.`,e),null}},yz=async t=>{const e=await mv(t);return e||gz(t)},_z=t=>{if(!(!t||t.length===0))for(const e of t){const n=typeof e.column=="string"&&e.column.trim().length>0?e.column.trim():null;if(n){if(e.op==="in"&&Array.isArray(e.value)){const r=e.value.filter(s=>typeof s=="string"||typeof s=="number");if(r.length>0)return{column:n,values:r};continue}if(!e.op||e.op==="="){const r=e.value;if(typeof r=="string"||typeof r=="number")return{column:n,values:[r]}}}}},vz=t=>{var d;if(t.tool!=="csv.aggregate")return null;const e=t.args.valueColumn??t.args.column;if(!e)return null;const n=((d=t.args.groupBy)==null?void 0:d[0])??void 0,r=t.args.aggregation??"sum",s=t.args.viewTitle??(n?`${r.toUpperCase()} of ${e} by ${n}`:`${r.toUpperCase()} of ${e}`),a=t.message??(n?`Aggregate ${e} by ${n} using ${r}.`:`Aggregate ${e} using ${r}.`),o=_z(t.args.filters),u=typeof t.args.topN=="number"?t.args.topN:n?8:void 0;return{chartType:"bar",title:s,description:a,aggregation:r,groupByColumn:n,valueColumn:e,defaultTopN:u,rowFilter:o,limit:t.args.limit??t.args.topN??void 0}},wz=t=>{if(!t||t.length===0)return[];const e=t[0];return Object.keys(e).map(n=>{const s=typeof e[n];return{name:n,type:s==="number"?"number":s==="boolean"?"boolean":s==="string"?"string":"unknown"}})};var bz=Object.defineProperty,Ft=(t,e)=>{for(var n in e)bz(t,n,{get:e[n],enumerable:!0})},Eg,rC;function Sz(){return rC||(rC=1,Eg=function(t,e){if(typeof t!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,t.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),Eg}var xz=Sz();const Tz=Ga(xz);var Kd={exports:{}},sC;function Az(){if(sC)return Kd.exports;sC=1;const t=/[\p{Lu}]/u,e=/[\p{Ll}]/u,n=/^[\p{Lu}](?![\p{Lu}])/gu,r=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,a=new RegExp("^"+s.source),o=new RegExp(s.source+r.source,"gu"),u=new RegExp("\\d+"+r.source,"gu"),d=(y,w,x)=>{let A=!1,E=!1,C=!1;for(let D=0;D<y.length;D++){const O=y[D];A&&t.test(O)?(y=y.slice(0,D)+"-"+y.slice(D),A=!1,C=E,E=!0,D++):E&&C&&e.test(O)?(y=y.slice(0,D-1)+"-"+y.slice(D-1),C=E,E=!1,A=!0):(A=w(O)===O&&x(O)!==O,C=E,E=x(O)===O&&w(O)!==O)}return y},c=(y,w)=>(n.lastIndex=0,y.replace(n,x=>w(x))),p=(y,w)=>(o.lastIndex=0,u.lastIndex=0,y.replace(o,(x,A)=>w(A)).replace(u,x=>w(x))),m=(y,w)=>{if(!(typeof y=="string"||Array.isArray(y)))throw new TypeError("Expected the input to be `string | string[]`");if(w={pascalCase:!1,preserveConsecutiveUppercase:!1,...w},Array.isArray(y)?y=y.map(C=>C.trim()).filter(C=>C.length).join("-"):y=y.trim(),y.length===0)return"";const x=w.locale===!1?C=>C.toLowerCase():C=>C.toLocaleLowerCase(w.locale),A=w.locale===!1?C=>C.toUpperCase():C=>C.toLocaleUpperCase(w.locale);return y.length===1?w.pascalCase?A(y):x(y):(y!==x(y)&&(y=d(y,x,A)),y=y.replace(a,""),w.preserveConsecutiveUppercase?y=c(y,x):y=x(y),w.pascalCase&&(y=A(y.charAt(0))+y.slice(1)),p(y,A))};return Kd.exports=m,Kd.exports.default=m,Kd.exports}Az();function Ez(t,e){return(e==null?void 0:e[t])||Tz(t)}function Cz(t,e,n){const r={};for(const s in t)Object.hasOwn(t,s)&&(r[e(s,n)]=t[s]);return r}var Iz={};Ft(Iz,{Serializable:()=>nl,get_lc_unique_name:()=>vv});function aC(t){return Array.isArray(t)?[...t]:{...t}}function Rz(t,e){const n=aC(t);for(const[r,s]of Object.entries(e)){const[a,...o]=r.split(".").reverse();let u=n;for(const d of o.reverse()){if(u[d]===void 0)break;u[d]=aC(u[d]),u=u[d]}u[a]!==void 0&&(u[a]={lc:1,type:"secret",id:[s]})}return n}function vv(t){const e=Object.getPrototypeOf(t);return typeof t.lc_name=="function"&&(typeof e.lc_name!="function"||t.lc_name()!==e.lc_name())?t.lc_name():t.name}var nl=class NP{constructor(e,...n){z(this,"lc_serializable",!1);z(this,"lc_kwargs");this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([r])=>{var s;return(s=this.lc_serializable_keys)==null?void 0:s.includes(r)})):this.lc_kwargs=e??{}}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vv(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof NP||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},n={},r=Object.keys(this.lc_kwargs).reduce((s,a)=>(s[a]=a in this?this[a]:this.lc_kwargs[a],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(n,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(n).forEach(s=>{let a=this,o=r;const[u,...d]=s.split(".").reverse();for(const c of d.reverse()){if(!(c in a)||a[c]===void 0)return;(!(c in o)||o[c]===void 0)&&(typeof a[c]=="object"&&a[c]!=null?o[c]={}:Array.isArray(a[c])&&(o[c]=[])),a=a[c],o=o[c]}u in a&&a[u]!==void 0&&(o[u]=o[u]||a[u])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Cz(Object.keys(n).length?Rz(r,n):r,Ez,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Li(t){return typeof t=="object"&&t!==null&&"type"in t&&typeof t.type=="string"&&"source_type"in t&&(t.source_type==="url"||t.source_type==="base64"||t.source_type==="text"||t.source_type==="id")}function Nz(t){return Li(t)&&t.source_type==="url"&&"url"in t&&typeof t.url=="string"}function Pz(t){return Li(t)&&t.source_type==="base64"&&"data"in t&&typeof t.data=="string"}function OX(t){return Li(t)&&t.source_type==="text"&&"text"in t&&typeof t.text=="string"}function Mz(t){return Li(t)&&t.source_type==="id"&&"id"in t&&typeof t.id=="string"}function DX(t){if(Li(t)){if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url}};if(t.source_type==="base64"){if(!t.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${t.mime_type};base64,${t.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function LX(t){const e=t.split(";")[0].split("/");if(e.length!==2)throw new Error(`Invalid mime type: "${t}" - does not match type/subtype format.`);const n=e[0].trim(),r=e[1].trim();if(n===""||r==="")throw new Error(`Invalid mime type: "${t}" - type or subtype is empty.`);const s={};for(const a of t.split(";").slice(1)){const o=a.split("=");if(o.length!==2)throw new Error(`Invalid parameter syntax in mime type: "${t}".`);const u=o[0].trim(),d=o[1].trim();if(u==="")throw new Error(`Invalid parameter syntax in mime type: "${t}".`);s[u]=d}return{type:n,subtype:r,parameters:s}}function iC({dataUrl:t,asTypedArray:e=!1}){const n=t.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let r;if(n){r=n[1].toLowerCase();const s=e?Uint8Array.from(atob(n[2]),a=>a.charCodeAt(0)):n[2];return{mime_type:r,data:s}}}function $X(t,e){if(t.type==="text"){if(!e.fromStandardTextBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardTextBlock\` method.`);return e.fromStandardTextBlock(t)}if(t.type==="image"){if(!e.fromStandardImageBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardImageBlock\` method.`);return e.fromStandardImageBlock(t)}if(t.type==="audio"){if(!e.fromStandardAudioBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardAudioBlock\` method.`);return e.fromStandardAudioBlock(t)}if(t.type==="file"){if(!e.fromStandardFileBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardFileBlock\` method.`);return e.fromStandardFileBlock(t)}throw new Error(`Unable to convert content block type '${t.type}' to provider-specific format: not recognized.`)}function Fe(t,e){return Ke(t)&&t.type===e}function Ke(t){return typeof t=="object"&&t!==null}function ls(t){return Array.isArray(t)}function Se(t){return typeof t=="string"}function $r(t){return typeof t=="number"}function wv(t){return t instanceof Uint8Array}function oC(t){try{return JSON.parse(t)}catch{return}}const Vu=t=>t();function kz(t){if(t.type==="char_location"&&Se(t.document_title)&&$r(t.start_char_index)&&$r(t.end_char_index)&&Se(t.cited_text)){const{document_title:e,start_char_index:n,end_char_index:r,cited_text:s,...a}=t;return{...a,type:"citation",source:"char",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="page_location"&&Se(t.document_title)&&$r(t.start_page_number)&&$r(t.end_page_number)&&Se(t.cited_text)){const{document_title:e,start_page_number:n,end_page_number:r,cited_text:s,...a}=t;return{...a,type:"citation",source:"page",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="content_block_location"&&Se(t.document_title)&&$r(t.start_block_index)&&$r(t.end_block_index)&&Se(t.cited_text)){const{document_title:e,start_block_index:n,end_block_index:r,cited_text:s,...a}=t;return{...a,type:"citation",source:"block",title:e??void 0,startIndex:n,endIndex:r,citedText:s}}if(t.type==="web_search_result_location"&&Se(t.url)&&Se(t.title)&&Se(t.encrypted_index)&&Se(t.cited_text)){const{url:e,title:n,encrypted_index:r,cited_text:s,...a}=t;return{...a,type:"citation",source:"url",url:e,title:n,startIndex:Number(r),endIndex:Number(r),citedText:s}}if(t.type==="search_result_location"&&Se(t.source)&&Se(t.title)&&$r(t.start_block_index)&&$r(t.end_block_index)&&Se(t.cited_text)){const{source:e,title:n,start_block_index:r,end_block_index:s,cited_text:a,...o}=t;return{...o,type:"citation",source:"search",url:e,title:n??void 0,startIndex:r,endIndex:s,citedText:a}}}function PP(t){if(Fe(t,"document")&&Ke(t.source)&&"type"in t.source){if(t.source.type==="base64"&&Se(t.source.media_type)&&Se(t.source.data))return{type:"file",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&Se(t.source.url))return{type:"file",url:t.source.url};if(t.source.type==="file"&&Se(t.source.file_id))return{type:"file",fileId:t.source.file_id};if(t.source.type==="text"&&Se(t.source.data))return{type:"file",mimeType:String(t.source.media_type??"text/plain"),data:t.source.data}}else if(Fe(t,"image")&&Ke(t.source)&&"type"in t.source){if(t.source.type==="base64"&&Se(t.source.media_type)&&Se(t.source.data))return{type:"image",mimeType:t.source.media_type,data:t.source.data};if(t.source.type==="url"&&Se(t.source.url))return{type:"image",url:t.source.url};if(t.source.type==="file"&&Se(t.source.file_id))return{type:"image",fileId:t.source.file_id}}}function Oz(t){function*e(){for(const n of t){const r=PP(n);r?yield r:yield n}}return Array.from(e())}function lC(t){function*e(){var r;const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of n){if(Fe(s,"text")&&Se(s.text)){const{text:a,citations:o,...u}=s;if(ls(o)&&o.length){const d=o.reduce((c,p)=>{const m=kz(p);return m?[...c,m]:c},[]);yield{...u,type:"text",text:a,annotations:d};continue}else{yield{...u,type:"text",text:a};continue}}else if(Fe(s,"thinking")&&Se(s.thinking)){const{thinking:a,signature:o,...u}=s;yield{...u,type:"reasoning",reasoning:a,signature:o};continue}else if(Fe(s,"redacted_thinking")){yield{type:"non_standard",value:s};continue}else if(Fe(s,"tool_use")&&Se(s.name)&&Se(s.id)){yield{type:"tool_call",id:s.id,name:s.name,args:s.input};continue}else if(Fe(s,"input_json_delta")){if(Lz(t)&&((r=t.tool_call_chunks)!=null&&r.length)){const a=t.tool_call_chunks[0];yield{type:"tool_call_chunk",id:a.id,name:a.name,args:a.args,index:a.index};continue}}else if(Fe(s,"server_tool_use")&&Se(s.name)&&Se(s.id)){const{name:a,id:o}=s;if(a==="web_search"){const u=Vu(()=>{if(typeof s.input=="string")return s.input;if(Ke(s.input)&&Se(s.input.query))return s.input.query;if(Se(s.partial_json)){const d=oC(s.partial_json);if(d!=null&&d.query)return d.query}return""});yield{id:o,type:"server_tool_call",name:"web_search",args:{query:u}};continue}else if(s.name==="code_execution"){const u=Vu(()=>{if(typeof s.input=="string")return s.input;if(Ke(s.input)&&Se(s.input.code))return s.input.code;if(Se(s.partial_json)){const d=oC(s.partial_json);if(d!=null&&d.code)return d.code}return""});yield{id:o,type:"server_tool_call",name:"code_execution",args:{code:u}};continue}}else if(Fe(s,"web_search_tool_result")&&Se(s.tool_use_id)&&ls(s.content)){const{content:a,tool_use_id:o}=s,u=a.reduce((d,c)=>Fe(c,"web_search_result")?[...d,c.url]:d,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:o,status:"success",output:{urls:u}};continue}else if(Fe(s,"code_execution_tool_result")&&Se(s.tool_use_id)&&Ke(s.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(Fe(s,"mcp_tool_use")){yield{id:s.id,type:"server_tool_call",name:"mcp_tool_use",args:s.input};continue}else if(Fe(s,"mcp_tool_result")&&Se(s.tool_use_id)&&Ke(s.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(Fe(s,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:s.input};continue}else if(Fe(s,"search_result")){yield{id:s.id,type:"non_standard",value:s};continue}else if(Fe(s,"tool_result")){yield{id:s.id,type:"non_standard",value:s};continue}else{const a=PP(s);if(a){yield a;continue}}yield{type:"non_standard",value:s}}}return Array.from(e())}const Dz={translateContent:lC,translateContentChunk:lC};function Lz(t){return typeof(t==null?void 0:t._getType)=="function"&&typeof t.concat=="function"&&t._getType()==="ai"}function $z(t){return Nz(t)?{type:t.type,mimeType:t.mime_type,url:t.url,metadata:t.metadata}:Pz(t)?{type:t.type,mimeType:t.mime_type??"application/octet-stream",data:t.data,metadata:t.metadata}:Mz(t)?{type:t.type,mimeType:t.mime_type,fileId:t.id,metadata:t.metadata}:t}function Uz(t){return t.map($z)}function Fz(t){return!!(Fe(t,"image_url")&&Ke(t.image_url)||Fe(t,"input_audio")&&Ke(t.input_audio)||Fe(t,"file")&&Ke(t.file))}function Bz(t){if(Fe(t,"image_url")&&Ke(t.image_url)&&Se(t.image_url.url)){const e=iC({dataUrl:t.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:t.image_url.url}}else{if(Fe(t,"input_audio")&&Ke(t.input_audio)&&Se(t.input_audio.data)&&Se(t.input_audio.format))return{type:"audio",data:t.input_audio.data,mimeType:`audio/${t.input_audio.format}`};if(Fe(t,"file")&&Ke(t.file)&&Se(t.file.data)){const e=iC({dataUrl:t.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(Se(t.file.file_id))return{type:"file",fileId:t.file.file_id}}}return t}function qz(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...bv(t.content));for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}function Gz(t){const e=[];typeof t.content=="string"?e.push({type:"text",text:t.content}):e.push(...bv(t.content));for(const n of t.tool_calls??[])e.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return e}function bv(t){const e=[];for(const n of t)Fz(n)?e.push(Bz(n)):e.push(n);return e}function Hz(t){if(t.type==="url_citation"){const{url:e,title:n,start_index:r,end_index:s}=t;return{type:"citation",url:e,title:n,startIndex:r,endIndex:s}}if(t.type==="file_citation"){const{file_id:e,filename:n,index:r}=t;return{type:"citation",title:n,startIndex:r,endIndex:r,fileId:e}}return t}function MP(t){function*e(){var r;Ke((r=t.additional_kwargs)==null?void 0:r.reasoning)&&ls(t.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:t.additional_kwargs.reasoning.summary.reduce((a,o)=>Ke(o)&&Se(o.text)?`${a}${o.text}`:a,"")});const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const s of n)if(Fe(s,"text")){const{text:a,annotations:o,...u}=s;Array.isArray(o)?yield{...u,type:"text",text:String(a),annotations:o.map(Hz)}:yield{...u,type:"text",text:String(a)}}for(const s of t.tool_calls??[])yield{type:"tool_call",id:s.id,name:s.name,args:s.args};if(Ke(t.additional_kwargs)&&ls(t.additional_kwargs.tool_outputs))for(const s of t.additional_kwargs.tool_outputs){if(Fe(s,"web_search_call")){yield{id:s.id,type:"server_tool_call",name:"web_search",args:{query:s.query}};continue}else if(Fe(s,"file_search_call")){yield{id:s.id,type:"server_tool_call",name:"file_search",args:{query:s.query}};continue}else if(Fe(s,"computer_call")){yield{type:"non_standard",value:s};continue}else if(Fe(s,"code_interpreter_call")){if(Se(s.code)&&(yield{id:s.id,type:"server_tool_call",name:"code_interpreter",args:{code:s.code}}),ls(s.outputs)){const a=Vu(()=>{if(s.status!=="in_progress"){if(s.status==="completed")return 0;if(s.status==="incomplete")return 127;if(s.status!=="interpreting"&&s.status==="failed")return 1}});for(const o of s.outputs)if(Fe(o,"logs")){yield{type:"server_tool_call_result",toolCallId:s.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:a??0,stderr:[0,void 0].includes(a)?void 0:String(o.logs),stdout:[0,void 0].includes(a)?String(o.logs):void 0}};continue}}continue}else if(Fe(s,"mcp_call")){yield{id:s.id,type:"server_tool_call",name:"mcp_call",args:s.input};continue}else if(Fe(s,"mcp_list_tools")){yield{id:s.id,type:"server_tool_call",name:"mcp_list_tools",args:s.input};continue}else if(Fe(s,"mcp_approval_request")){yield{type:"non_standard",value:s};continue}else if(Fe(s,"image_generation_call")){yield{type:"non_standard",value:s};continue}Ke(s)&&(yield{type:"non_standard",value:s})}}return Array.from(e())}function zz(t){function*e(){yield*MP(t);for(const n of t.tool_call_chunks??[])yield{type:"tool_call_chunk",id:n.id,name:n.name,args:n.args}}return Array.from(e())}const jz={translateContent:t=>typeof t.content=="string"?qz(t):MP(t),translateContentChunk:t=>typeof t.content=="string"?Gz(t):zz(t)};function Vz(t){return typeof t=="object"&&t!==null&&"type"in t&&"content"in t&&(typeof t.content=="string"||Array.isArray(t.content))}function Jz(t,e="pretty"){return e==="pretty"?Yz(t):JSON.stringify(t)}function Yz(t){const e=[],n=` ${t.type.charAt(0).toUpperCase()+t.type.slice(1)} Message `,r=Math.floor((80-n.length)/2),s="=".repeat(r),a=n.length%2===0?s:`${s}=`;if(e.push(`${s}${n}${a}`),t.type==="ai"){const o=t;if(o.tool_calls&&o.tool_calls.length>0){e.push("Tool Calls:");for(const u of o.tool_calls){e.push(`  ${u.name} (${u.id})`),e.push(` Call ID: ${u.id}`),e.push("  Args:");for(const[d,c]of Object.entries(u.args))e.push(`    ${d}: ${c}`)}}}if(t.type==="tool"){const o=t;o.name&&e.push(`Name: ${o.name}`)}return typeof t.content=="string"&&t.content.trim()&&(e.length>1&&e.push(""),e.push(t.content)),e.join(`
`)}const Cg=Symbol.for("langchain.message");function dl(t,e){return typeof t=="string"?t===""?e:typeof e=="string"?t+e:Array.isArray(e)&&e.some(n=>Li(n))?[{type:"text",source_type:"text",text:t},...e]:[{type:"text",text:t},...e]:Array.isArray(e)?Tp(t,e)??[...t,...e]:e===""?t:Array.isArray(t)&&t.some(n=>Li(n))?[...t,{type:"file",source_type:"text",text:e}]:[...t,{type:"text",text:e}]}function Kz(t,e){return t==="error"||e==="error"?"error":"success"}function Wz(t,e){function n(r,s){if(typeof r!="object"||r===null||r===void 0)return r;if(s>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(o=>n(o,s+1));const a={};for(const o of Object.keys(r))a[o]=n(r[o],s+1);return a}return JSON.stringify(n(t,0),null,2)}var RR,Va=class extends nl{constructor(e){const n=typeof e=="string"||Array.isArray(e)?{content:e}:e;n.additional_kwargs||(n.additional_kwargs={}),n.response_metadata||(n.response_metadata={});super(n);z(this,"lc_namespace",["langchain_core","messages"]);z(this,"lc_serializable",!0);z(this,RR,!0);z(this,"id");z(this,"name");z(this,"content");z(this,"additional_kwargs");z(this,"response_metadata");this.name=n.name,n.content===void 0&&n.contentBlocks!==void 0?(this.content=n.contentBlocks,this.response_metadata={output_version:"v1",...n.response_metadata}):n.content!==void 0?(this.content=n.content??[],this.response_metadata=n.response_metadata):(this.content=[],this.response_metadata=n.response_metadata),this.additional_kwargs=n.additional_kwargs,this.id=n.id}get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}_getType(){return this.type}getType(){return this._getType()}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[Uz,bv,Oz].reduce((s,a)=>a(s),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Cg in e&&e[Cg]===!0&&Vz(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[(RR=Cg,Symbol.toStringTag)](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const n=Wz(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${n}`}toFormattedString(e="pretty"){return Jz(this,e)}};function UX(t){return Array.isArray(t)&&t.every(e=>typeof e.index=="number")}function Ln(t={},e={}){const n={...t};for(const[r,s]of Object.entries(e))if(n[r]==null)n[r]=s;else{if(s==null)continue;if(typeof n[r]!=typeof s||Array.isArray(n[r])!==Array.isArray(s))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof n[r]=="string"){if(r==="type")continue;["id","name","output_version","model_provider"].includes(r)?n[r]=s:n[r]+=s}else if(typeof n[r]=="object"&&!Array.isArray(n[r]))n[r]=Ln(n[r],s);else if(Array.isArray(n[r]))n[r]=Tp(n[r],s);else{if(n[r]===s)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return n}function Tp(t,e){if(!(t===void 0&&e===void 0)){if(t===void 0||e===void 0)return t||e;{const n=[...t];for(const r of e)if(typeof r=="object"&&r!==null&&"index"in r&&typeof r.index=="number"){const s=n.findIndex(a=>{const o=typeof a=="object",u="index"in a&&a.index===r.index,d="id"in a&&"id"in r&&(a==null?void 0:a.id)===(r==null?void 0:r.id),c=!("id"in a)||!(a!=null&&a.id)||!("id"in r)||!(r!=null&&r.id);return o&&u&&(d||c)});s!==-1&&typeof n[s]=="object"&&n[s]!==null?n[s]=Ln(n[s],r):n.push(r)}else{if(typeof r=="object"&&r!==null&&"text"in r&&r.text==="")continue;n.push(r)}return n}}}function Zz(t,e){if(!t&&!e)throw new Error("Cannot merge two undefined objects.");if(!t||!e)return t||e;if(typeof t!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof t}
Right ${typeof e}`);if(typeof t=="string"&&typeof e=="string")return t+e;if(Array.isArray(t)&&Array.isArray(e))return Tp(t,e);if(typeof t=="object"&&typeof e=="object")return Ln(t,e);if(t===e)return t;throw new Error(`Can not merge objects of different types.
Left ${t}
Right ${e}`)}var fl=class extends Va{static isInstance(t){return super.isInstance(t)&&"concat"in t&&typeof t.concat=="function"}};function Xz(t){return typeof t.role=="string"}function kP(t){return typeof(t==null?void 0:t._getType)=="function"}function FX(t){return kP(t)&&typeof t.concat=="function"}var Qz={};Ft(Qz,{ToolMessage:()=>Ju,ToolMessageChunk:()=>ej,defaultToolCallParser:()=>DP,isDirectToolOutput:()=>OP,isToolMessage:()=>tj,isToolMessageChunk:()=>nj});function OP(t){return t!=null&&typeof t=="object"&&"lc_direct_tool_output"in t&&t.lc_direct_tool_output===!0}var Ju=class extends Va{constructor(e,n,r){const s=typeof e=="string"||Array.isArray(e)?{content:e,name:r,tool_call_id:n}:e;super(s);z(this,"lc_direct_tool_output",!0);z(this,"type","tool");z(this,"status");z(this,"tool_call_id");z(this,"metadata");z(this,"artifact");this.tool_call_id=s.tool_call_id,this.artifact=s.artifact,this.status=s.status,this.metadata=s.metadata}static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},ej=class extends fl{constructor(e){super(e);z(this,"type","tool");z(this,"tool_call_id");z(this,"status");z(this,"artifact");this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const n=this.constructor;return new n({content:dl(this.content,e.content),additional_kwargs:Ln(this.additional_kwargs,e.additional_kwargs),response_metadata:Ln(this.response_metadata,e.response_metadata),artifact:Zz(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Kz(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function DP(t){const e=[],n=[];for(const r of t)if(r.function){const s=r.function.name;try{const a=JSON.parse(r.function.arguments);e.push({name:s||"",args:a||{},id:r.id})}catch{n.push({name:s,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,n]}function tj(t){return typeof t=="object"&&t!==null&&"getType"in t&&typeof t.getType=="function"&&t.getType()==="tool"}function nj(t){return t._getType()==="tool"}function Pu(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="tool_call")}function rj(t){return!!(t&&typeof t=="object"&&"toolCall"in t&&t.toolCall!=null&&typeof t.toolCall=="object"&&"id"in t.toolCall&&typeof t.toolCall.id=="string")}var zf=class extends Error{constructor(e,n){super(e);z(this,"output");this.output=n}};function sj(t){if(typeof t>"u")return null;try{return JSON.parse(t)}catch{}let e="";const n=[];let r=!1,s=!1;for(let a of t){if(r)a==='"'&&!s?r=!1:a===`
`&&!s?a="\\n":a==="\\"?s=!s:s=!1;else if(a==='"')r=!0,s=!1;else if(a==="{")n.push("}");else if(a==="[")n.push("]");else if(a==="}"||a==="]")if(n&&n[n.length-1]===a)n.pop();else return null;e+=a}r&&(e+='"');for(let a=n.length-1;a>=0;a-=1)e+=n[a];try{return JSON.parse(e)}catch{return null}}function Sv(t){switch(t){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function aj(t){if(Ke(t.document)&&Ke(t.document.source)){const e=Ke(t.document)&&Se(t.document.format)?t.document.format:"",n=Sv(e);if(Ke(t.document.source)){if(Ke(t.document.source.s3Location)&&Se(t.document.source.s3Location.uri))return{type:"file",mimeType:n,fileId:t.document.source.s3Location.uri};if(wv(t.document.source.bytes))return{type:"file",mimeType:n,data:t.document.source.bytes};if(Se(t.document.source.text))return{type:"file",mimeType:n,data:Buffer.from(t.document.source.text).toString("base64")};if(ls(t.document.source.content)){const r=t.document.source.content.reduce((s,a)=>Ke(a)&&Se(a.text)?s+a.text:s,"");return{type:"file",mimeType:n,data:r}}}}return{type:"non_standard",value:t}}function ij(t){if(Fe(t,"image")&&Ke(t.image)){const e=Ke(t.image)&&Se(t.image.format)?t.image.format:"",n=Sv(e);if(Ke(t.image.source)){if(Ke(t.image.source.s3Location)&&Se(t.image.source.s3Location.uri))return{type:"image",mimeType:n,fileId:t.image.source.s3Location.uri};if(wv(t.image.source.bytes))return{type:"image",mimeType:n,data:t.image.source.bytes}}}return{type:"non_standard",value:t}}function oj(t){if(Fe(t,"video")&&Ke(t.video)){const e=Ke(t.video)&&Se(t.video.format)?t.video.format:"",n=Sv(e);if(Ke(t.video.source)){if(Ke(t.video.source.s3Location)&&Se(t.video.source.s3Location.uri))return{type:"video",mimeType:n,fileId:t.video.source.s3Location.uri};if(wv(t.video.source.bytes))return{type:"video",mimeType:n,data:t.video.source.bytes}}}return{type:"non_standard",value:t}}function uC(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(Fe(r,"cache_point")){yield{type:"non_standard",value:r};continue}else if(Fe(r,"citations_content")&&Ke(r.citationsContent)){const s=ls(r.citationsContent.content)?r.citationsContent.content.reduce((o,u)=>Ke(u)&&Se(u.text)?o+u.text:o,""):"",a=ls(r.citationsContent.citations)?r.citationsContent.citations.reduce((o,u)=>{if(Ke(u)){const d=ls(u.sourceContent)?u.sourceContent.reduce((p,m)=>Ke(m)&&Se(m.text)?p+m.text:p,""):"",c=Vu(()=>{if(Ke(u.location)){const p=u.location.documentChar||u.location.documentPage||u.location.documentChunk;if(Ke(p))return{source:$r(p.documentIndex)?p.documentIndex.toString():void 0,startIndex:$r(p.start)?p.start:void 0,endIndex:$r(p.end)?p.end:void 0}}return{}});o.push({type:"citation",citedText:d,...c})}return o},[]):[];yield{type:"text",text:s,annotations:a};continue}else if(Fe(r,"document")&&Ke(r.document)){yield aj(r);continue}else if(Fe(r,"guard_content")){yield{type:"non_standard",value:r};continue}else if(Fe(r,"image")&&Ke(r.image)){yield ij(r);continue}else if(Fe(r,"reasoning_content")&&Se(r.reasoningText)){yield{type:"reasoning",reasoning:r.reasoningText};continue}else if(Fe(r,"text")&&Se(r.text)){yield{type:"text",text:r.text};continue}else if(Fe(r,"tool_result")){yield{type:"non_standard",value:r};continue}else{if(Fe(r,"tool_call"))continue;if(Fe(r,"video")&&Ke(r.video)){yield oj(r);continue}}yield{type:"non_standard",value:r}}}return Array.from(e())}const lj={translateContent:uC,translateContentChunk:uC};function cC(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(Fe(r,"text")&&Se(r.text)){yield{type:"text",text:r.text};continue}else if(Fe(r,"inlineData")&&Ke(r.inlineData)&&Se(r.inlineData.mimeType)&&Se(r.inlineData.data)){yield{type:"file",mimeType:r.inlineData.mimeType,data:r.inlineData.data};continue}else if(Fe(r,"functionCall")&&Ke(r.functionCall)&&Se(r.functionCall.name)&&Ke(r.functionCall.args)){yield{type:"tool_call",id:t.id,name:r.functionCall.name,args:r.functionCall.args};continue}else if(Fe(r,"functionResponse")){yield{type:"non_standard",value:r};continue}else if(Fe(r,"fileData")&&Ke(r.fileData)&&Se(r.fileData.mimeType)&&Se(r.fileData.fileUri)){yield{type:"file",mimeType:r.fileData.mimeType,fileId:r.fileData.fileUri};continue}else if(Fe(r,"executableCode")){yield{type:"non_standard",value:r};continue}else if(Fe(r,"codeExecutionResult")){yield{type:"non_standard",value:r};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const uj={translateContent:cC,translateContentChunk:cC};function dC(t){function*e(){const n=typeof t.content=="string"?[{type:"text",text:t.content}]:t.content;for(const r of n){if(Fe(r,"reasoning")&&Se(r.reasoning)){const s=Vu(()=>{var o;const a=n.indexOf(r);if(ls((o=t.additional_kwargs)==null?void 0:o.signatures)&&a>=0)return t.additional_kwargs.signatures.at(a)});Se(s)?yield{type:"reasoning",reasoning:r.reasoning,signature:s}:yield{type:"reasoning",reasoning:r.reasoning};continue}else if(Fe(r,"text")&&Se(r.text)){yield{type:"text",text:r.text};continue}else if(Fe(r,"image_url")){if(Se(r.image_url))if(r.image_url.startsWith("data:")){const s=/^data:([^;]+);base64,(.+)$/,a=r.image_url.match(s);a?yield{type:"image",data:a[2],mimeType:a[1]}:yield{type:"image",url:r.image_url}}else yield{type:"image",url:r.image_url};continue}else if(Fe(r,"media")&&Se(r.mimeType)&&Se(r.data)){yield{type:"file",mimeType:r.mimeType,data:r.data};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const cj={translateContent:dC,translateContentChunk:dC};globalThis.lc_block_translators_registry??(globalThis.lc_block_translators_registry=new Map([["anthropic",Dz],["bedrock-converse",lj],["google-genai",uj],["google-vertexai",cj],["openai",jz]]));function LP(t){return globalThis.lc_block_translators_registry.get(t)}function dj(t,e){return Ln(t??{},e??{})}function $P(t,e){const n={};return((t==null?void 0:t.audio)!==void 0||(e==null?void 0:e.audio)!==void 0)&&(n.audio=((t==null?void 0:t.audio)??0)+((e==null?void 0:e.audio)??0)),((t==null?void 0:t.image)!==void 0||(e==null?void 0:e.image)!==void 0)&&(n.image=((t==null?void 0:t.image)??0)+((e==null?void 0:e.image)??0)),((t==null?void 0:t.video)!==void 0||(e==null?void 0:e.video)!==void 0)&&(n.video=((t==null?void 0:t.video)??0)+((e==null?void 0:e.video)??0)),((t==null?void 0:t.document)!==void 0||(e==null?void 0:e.document)!==void 0)&&(n.document=((t==null?void 0:t.document)??0)+((e==null?void 0:e.document)??0)),((t==null?void 0:t.text)!==void 0||(e==null?void 0:e.text)!==void 0)&&(n.text=((t==null?void 0:t.text)??0)+((e==null?void 0:e.text)??0)),n}function fj(t,e){const n={...$P(t,e)};return((t==null?void 0:t.cache_read)!==void 0||(e==null?void 0:e.cache_read)!==void 0)&&(n.cache_read=((t==null?void 0:t.cache_read)??0)+((e==null?void 0:e.cache_read)??0)),((t==null?void 0:t.cache_creation)!==void 0||(e==null?void 0:e.cache_creation)!==void 0)&&(n.cache_creation=((t==null?void 0:t.cache_creation)??0)+((e==null?void 0:e.cache_creation)??0)),n}function pj(t,e){const n={...$P(t,e)};return((t==null?void 0:t.reasoning)!==void 0||(e==null?void 0:e.reasoning)!==void 0)&&(n.reasoning=((t==null?void 0:t.reasoning)??0)+((e==null?void 0:e.reasoning)??0)),n}function hj(t,e){return{input_tokens:((t==null?void 0:t.input_tokens)??0)+((e==null?void 0:e.input_tokens)??0),output_tokens:((t==null?void 0:t.output_tokens)??0)+((e==null?void 0:e.output_tokens)??0),total_tokens:((t==null?void 0:t.total_tokens)??0)+((e==null?void 0:e.total_tokens)??0),input_token_details:fj(t==null?void 0:t.input_token_details,e==null?void 0:e.input_token_details),output_token_details:pj(t==null?void 0:t.output_token_details,e==null?void 0:e.output_token_details)}}var j_=class extends Va{constructor(e){var r;let n;if(typeof e=="string"||Array.isArray(e))n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{n=e;const s=(r=n.additional_kwargs)==null?void 0:r.tool_calls,a=n.tool_calls;s!=null&&s.length>0&&(a===void 0||a.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(s!=null&&a===void 0){const[o,u]=DP(s);n.tool_calls=o??[],n.invalid_tool_calls=u??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch{n.tool_calls=[],n.invalid_tool_calls=[]}if(n.response_metadata!==void 0&&"output_version"in n.response_metadata&&n.response_metadata.output_version==="v1"&&(n.contentBlocks=n.content,n.content=void 0),n.contentBlocks!==void 0){n.contentBlocks.push(...n.tool_calls.map(u=>({type:"tool_call",id:u.id,name:u.name,args:u.args})));const o=n.contentBlocks.filter(u=>u.type==="tool_call").filter(u=>{var d;return!((d=n.tool_calls)!=null&&d.some(c=>c.id===u.id&&c.name===u.name))});o.length>0&&(n.tool_calls=o.map(u=>({type:"tool_call",id:u.id,name:u.name,args:u.args})))}}super(n);z(this,"type","ai");z(this,"tool_calls",[]);z(this,"invalid_tool_calls",[]);z(this,"usage_metadata");typeof n!="string"&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const n=LP(this.response_metadata.model_provider);if(n)return n.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const n=this.tool_calls.filter(r=>!e.some(s=>s.id===r.id&&s.name===r.name));e.push(...n.map(r=>({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function BX(t){return t._getType()==="ai"}function qX(t){return t._getType()==="ai"}var xv=class extends fl{constructor(e){var r,s;let n;if(typeof e=="string"||Array.isArray(e))n={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0||e.tool_call_chunks.length===0)n={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const o=(e.tool_call_chunks??[]).reduce((c,p)=>{const m=c.findIndex(([y])=>"id"in p&&p.id&&"index"in p&&p.index!==void 0?p.id===y.id&&p.index===y.index:"id"in p&&p.id?p.id===y.id:"index"in p&&p.index!==void 0?p.index===y.index:!1);return m!==-1?c[m].push(p):c.push([p]),c},[]),u=[],d=[];for(const c of o){let p=null;const m=((r=c[0])==null?void 0:r.name)??"",y=c.map(A=>A.args||"").join(""),w=y.length?y:"{}",x=(s=c[0])==null?void 0:s.id;try{if(p=sj(w),!x||p===null||typeof p!="object"||Array.isArray(p))throw new Error("Malformed tool call chunk args.");u.push({name:m,args:p,id:x,type:"tool_call"})}catch{d.push({name:m,args:w,id:x,error:"Malformed args.",type:"invalid_tool_call"})}}n={...e,tool_calls:u,invalid_tool_calls:d,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(n);z(this,"type","ai");z(this,"tool_calls",[]);z(this,"invalid_tool_calls",[]);z(this,"tool_call_chunks",[]);z(this,"usage_metadata");this.tool_call_chunks=n.tool_call_chunks??this.tool_call_chunks,this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=n.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const n=LP(this.response_metadata.model_provider);if(n)return n.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const n=this.content.filter(r=>r.type==="tool_call").map(r=>r.id);for(const r of this.tool_calls)r.id&&!n.includes(r.id)&&e.push({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const n={content:dl(this.content,e.content),additional_kwargs:Ln(this.additional_kwargs,e.additional_kwargs),response_metadata:dj(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const s=Tp(this.tool_call_chunks,e.tool_call_chunks);s!==void 0&&s.length>0&&(n.tool_call_chunks=s)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(n.usage_metadata=hj(this.usage_metadata,e.usage_metadata));const r=this.constructor;return new r(n)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}},UP=class FP extends Va{constructor(n,r){(typeof n=="string"||Array.isArray(n))&&(n={content:n,role:r});super(n);z(this,"type","generic");z(this,"role");this.role=n.role}static lc_name(){return"ChatMessage"}static _chatMessageClass(){return FP}static isInstance(n){return super.isInstance(n)&&n.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},mj=class extends fl{constructor(e,n){(typeof e=="string"||Array.isArray(e))&&(e={content:e,role:n});super(e);z(this,"type","generic");z(this,"role");this.role=e.role}static lc_name(){return"ChatMessageChunk"}concat(e){const n=this.constructor;return new n({content:dl(this.content,e.content),additional_kwargs:Ln(this.additional_kwargs,e.additional_kwargs),response_metadata:Ln(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};function GX(t){return t._getType()==="generic"}function HX(t){return t._getType()==="generic"}var gj=class extends Va{constructor(e){super(e);z(this,"type","function");z(this,"name");this.name=e.name}static lc_name(){return"FunctionMessage"}},yj=class extends fl{constructor(){super(...arguments);z(this,"type","function")}static lc_name(){return"FunctionMessageChunk"}concat(e){const n=this.constructor;return new n({content:dl(this.content,e.content),additional_kwargs:Ln(this.additional_kwargs,e.additional_kwargs),response_metadata:Ln(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function zX(t){return t._getType()==="function"}function jX(t){return t._getType()==="function"}var pc=class extends Va{constructor(e){super(e);z(this,"type","human")}static lc_name(){return"HumanMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="human"}},_j=class extends fl{constructor(e){super(e);z(this,"type","human")}static lc_name(){return"HumanMessageChunk"}concat(e){const n=this.constructor;return new n({content:dl(this.content,e.content),additional_kwargs:Ln(this.additional_kwargs,e.additional_kwargs),response_metadata:Ln(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="human"}};function VX(t){return t.getType()==="human"}function JX(t){return t.getType()==="human"}var V_=class extends Va{constructor(e){super(e);z(this,"type","system")}static lc_name(){return"SystemMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="system"}},vj=class extends fl{constructor(e){super(e);z(this,"type","system")}static lc_name(){return"SystemMessageChunk"}concat(e){const n=this.constructor;return new n({content:dl(this.content,e.content),additional_kwargs:Ln(this.additional_kwargs,e.additional_kwargs),response_metadata:Ln(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="system"}};function YX(t){return t._getType()==="system"}function KX(t){return t._getType()==="system"}function wj(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${e}/
`,t}var bj=class extends Va{constructor(e){super({...e,content:[]});z(this,"type","remove");z(this,"id");this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&e.type==="remove"}};const WX=t=>t();function Sj(t){return Pu(t)?t:typeof t.id=="string"&&t.type==="function"&&typeof t.function=="object"&&t.function!==null&&"arguments"in t.function&&typeof t.function.arguments=="string"&&"name"in t.function&&typeof t.function.name=="string"?{id:t.id,args:JSON.parse(t.function.arguments),name:t.function.name,type:"tool_call"}:t}function xj(t){return typeof t=="object"&&t!=null&&t.lc===1&&Array.isArray(t.id)&&t.kwargs!=null&&typeof t.kwargs=="object"}function Ig(t){let e,n;if(xj(t)){const r=t.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?e="function":r==="ToolMessage"||r==="ToolMessageChunk"?e="tool":e="unknown",n=t.kwargs}else{const{type:r,...s}=t;e=r,n=s}if(e==="human"||e==="user")return new pc(n);if(e==="ai"||e==="assistant"){const{tool_calls:r,...s}=n;if(!Array.isArray(r))return new j_(n);const a=r.map(Sj);return new j_({...s,tool_calls:a})}else{if(e==="system")return new V_(n);if(e==="developer")return new V_({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in n)return new Ju({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});if(e==="remove"&&"id"in n&&typeof n.id=="string")return new bj({...n,id:n.id});throw wj(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(t,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Tj(t){if(typeof t=="string")return new pc(t);if(kP(t))return t;if(Array.isArray(t)){const[e,n]=t;return Ig({type:e,content:n})}else if(Xz(t)){const{role:e,...n}=t;return Ig({...n,type:e})}else return Ig(t)}function BP(t,e="Human",n="AI"){const r=[];for(const s of t){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=n;else if(s._getType()==="system")a="System";else if(s._getType()==="tool")a="Tool";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const o=s.name?`${s.name}, `:"",u=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);r.push(`${a}: ${o}${u}`)}return r.join(`
`)}function Aj(t){if(t.data!==void 0)return t;{const e=t;return{type:e.type,data:{content:e.text,role:e.role,name:void 0,tool_call_id:void 0}}}}function qP(t){const e=Aj(t);switch(e.type){case"human":return new pc(e.data);case"ai":return new j_(e.data);case"system":return new V_(e.data);case"function":if(e.data.name===void 0)throw new Error("Name must be defined for function messages");return new gj(e.data);case"tool":if(e.data.tool_call_id===void 0)throw new Error("Tool call ID must be defined for tool messages");return new Ju(e.data);case"generic":if(e.data.role===void 0)throw new Error("Role must be defined for chat messages");return new UP(e.data);default:throw new Error(`Got unexpected type: ${e.type}`)}}function ZX(t){return t.map(qP)}function XX(t){return t.map(e=>e.toDict())}function QX(t){var n;const e=t._getType();if(e==="human")return new _j({...t});if(e==="ai"){let r={...t};return"tool_calls"in r&&(r={...r,tool_call_chunks:(n=r.tool_calls)==null?void 0:n.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new xv({...r})}else{if(e==="system")return new vj({...t});if(e==="function")return new yj({...t});if(UP.isInstance(t))return new mj({...t});throw new Error("Unknown message type.")}}var Rg={},Ej={};Ft(Ej,{getEnv:()=>VP,getEnvironmentVariable:()=>Ri,getRuntimeEnvironment:()=>JP,isBrowser:()=>GP,isDeno:()=>Ap,isJsDom:()=>zP,isNode:()=>jP,isWebWorker:()=>HP});const GP=()=>typeof window<"u"&&typeof window.document<"u",HP=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",zP=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Ap=()=>typeof Deno<"u",jP=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Ap(),VP=()=>{let t;return GP()?t="browser":jP()?t="node":HP()?t="webworker":zP()?t="jsdom":Ap()?t="deno":t="other",t};let Ng;function JP(){return Ng===void 0&&(Ng={library:"langchain-js",runtime:VP()}),Ng}function Ri(t){try{return typeof process<"u"?Rg==null?void 0:Rg[t]:Ap()?Deno==null?void 0:Deno.env.get(t):void 0}catch{return}}const Cj=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Mu(t){return typeof t=="string"&&Cj.test(t)}function Ij(t){if(!Mu(t))throw TypeError("Invalid UUID");var e,n=new Uint8Array(16);return n[0]=(e=parseInt(t.slice(0,8),16))>>>24,n[1]=e>>>16&255,n[2]=e>>>8&255,n[3]=e&255,n[4]=(e=parseInt(t.slice(9,13),16))>>>8,n[5]=e&255,n[6]=(e=parseInt(t.slice(14,18),16))>>>8,n[7]=e&255,n[8]=(e=parseInt(t.slice(19,23),16))>>>8,n[9]=e&255,n[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,n[11]=e/4294967296&255,n[12]=e>>>24&255,n[13]=e>>>16&255,n[14]=e>>>8&255,n[15]=e&255,n}var xn=[];for(var Pg=0;Pg<256;++Pg)xn.push((Pg+256).toString(16).slice(1));function YP(t,e=0){return(xn[t[e+0]]+xn[t[e+1]]+xn[t[e+2]]+xn[t[e+3]]+"-"+xn[t[e+4]]+xn[t[e+5]]+"-"+xn[t[e+6]]+xn[t[e+7]]+"-"+xn[t[e+8]]+xn[t[e+9]]+"-"+xn[t[e+10]]+xn[t[e+11]]+xn[t[e+12]]+xn[t[e+13]]+xn[t[e+14]]+xn[t[e+15]]).toLowerCase()}var Wd,Rj=new Uint8Array(16);function Nj(){if(!Wd&&(Wd=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Wd))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Wd(Rj)}function Pj(t){t=unescape(encodeURIComponent(t));for(var e=[],n=0;n<t.length;++n)e.push(t.charCodeAt(n));return e}var Mj="6ba7b810-9dad-11d1-80b4-00c04fd430c8",kj="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Oj(t,e,n){function r(s,a,o,u){var d;if(typeof s=="string"&&(s=Pj(s)),typeof a=="string"&&(a=Ij(a)),((d=a)===null||d===void 0?void 0:d.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var c=new Uint8Array(16+s.length);if(c.set(a),c.set(s,a.length),c=n(c),c[6]=c[6]&15|e,c[8]=c[8]&63|128,o){u=u||0;for(var p=0;p<16;++p)o[u+p]=c[p];return o}return YP(c)}try{r.name=t}catch{}return r.DNS=Mj,r.URL=kj,r}var Dj=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const fC={randomUUID:Dj};function Dn(t,e,n){if(fC.randomUUID&&!t)return fC.randomUUID();t=t||{};var r=t.random||(t.rng||Nj)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,YP(r)}function Lj(t,e,n,r){switch(t){case 0:return e&n^~e&r;case 1:return e^n^r;case 2:return e&n^e&r^n&r;case 3:return e^n^r}}function Mg(t,e){return t<<e|t>>>32-e}function $j(t){var e=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof t=="string"){var r=unescape(encodeURIComponent(t));t=[];for(var s=0;s<r.length;++s)t.push(r.charCodeAt(s))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var a=t.length/4+2,o=Math.ceil(a/16),u=new Array(o),d=0;d<o;++d){for(var c=new Uint32Array(16),p=0;p<16;++p)c[p]=t[d*64+p*4]<<24|t[d*64+p*4+1]<<16|t[d*64+p*4+2]<<8|t[d*64+p*4+3];u[d]=c}u[o-1][14]=(t.length-1)*8/Math.pow(2,32),u[o-1][14]=Math.floor(u[o-1][14]),u[o-1][15]=(t.length-1)*8&4294967295;for(var m=0;m<o;++m){for(var y=new Uint32Array(80),w=0;w<16;++w)y[w]=u[m][w];for(var x=16;x<80;++x)y[x]=Mg(y[x-3]^y[x-8]^y[x-14]^y[x-16],1);for(var A=n[0],E=n[1],C=n[2],D=n[3],O=n[4],T=0;T<80;++T){var I=Math.floor(T/20),M=Mg(A,5)+Lj(I,E,C,D)+O+e[I]+y[T]>>>0;O=D,D=C,C=Mg(E,30)>>>0,E=A,A=M}n[0]=n[0]+A>>>0,n[1]=n[1]+E>>>0,n[2]=n[2]+C>>>0,n[3]=n[3]+D>>>0,n[4]=n[4]+O>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,n[0]&255,n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,n[1]&255,n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,n[2]&255,n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,n[3]&255,n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,n[4]&255]}var pC=Oj("v5",80,$j),Uj={};Ft(Uj,{BaseCallbackHandler:()=>hc,callbackHandlerPrefersStreaming:()=>Bj,isBaseCallbackHandler:()=>KP});var Fj=class{};function Bj(t){return"lc_prefer_streaming"in t&&t.lc_prefer_streaming}var hc=class extends Fj{constructor(e){super();z(this,"lc_serializable",!1);z(this,"lc_kwargs");z(this,"ignoreLLM",!1);z(this,"ignoreChain",!1);z(this,"ignoreAgent",!1);z(this,"ignoreRetriever",!1);z(this,"ignoreCustomEvent",!1);z(this,"raiseError",!1);z(this,"awaitHandlers",Ri("LANGCHAIN_CALLBACKS_BACKGROUND")==="false");this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vv(this.constructor)]}copy(){return new this.constructor(this)}toJSON(){return nl.prototype.toJSON.call(this)}toJSONNotImplemented(){return nl.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class n extends hc{constructor(){super();z(this,"name",Dn());Object.assign(this,e)}}return new n}};const KP=t=>{const e=t;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},qj="gen_ai.operation.name",Gj="gen_ai.system",hC="gen_ai.request.model",Hj="gen_ai.response.model",mC="gen_ai.usage.input_tokens",gC="gen_ai.usage.output_tokens",yC="gen_ai.usage.total_tokens",zj="gen_ai.request.max_tokens",jj="gen_ai.request.temperature",Vj="gen_ai.request.top_p",Jj="gen_ai.request.frequency_penalty",Yj="gen_ai.request.presence_penalty",Kj="gen_ai.response.finish_reasons",Wj="gen_ai.prompt",Zj="gen_ai.completion",Xj="gen_ai.request.extra_query",Qj="gen_ai.request.extra_body",eV="gen_ai.serialized.name",tV="gen_ai.serialized.signature",nV="gen_ai.serialized.doc",rV="gen_ai.response.id",sV="gen_ai.response.service_tier",aV="gen_ai.response.system_fingerprint",iV="gen_ai.usage.input_token_details",oV="gen_ai.usage.output_token_details",lV="langsmith.trace.session_id",uV="langsmith.trace.session_name",cV="langsmith.span.kind",dV="langsmith.trace.name",fV="langsmith.metadata",_C="langsmith.span.tags",pV="langsmith.request.streaming",hV="langsmith.request.headers",mV=(...t)=>fetch(...t),WP=Symbol.for("ls:fetch_implementation"),gV=()=>{const t=globalThis[WP];return t?typeof t=="function"&&"Headers"in t&&"Request"in t&&"Response"in t:!1},yV=t=>async(...e)=>{if(t||Jn("DEBUG")==="true"){const[r,s]=e;console.log(` ${(s==null?void 0:s.method)||"GET"} ${r}`)}const n=await(globalThis[WP]??mV)(...e);return(t||Jn("DEBUG")==="true")&&console.log(` ${n.status} ${n.statusText} ${n.url}`),n},ZP=()=>Jn("PROJECT")??us("LANGCHAIN_SESSION")??"default",XP="0.3.79";var ku={};let Qr;const _V=()=>typeof window<"u"&&typeof window.document<"u",vV=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",wV=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),QP=()=>typeof Deno<"u",bV=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!QP(),eM=()=>Qr||(typeof Bun<"u"?Qr="bun":_V()?Qr="browser":bV()?Qr="node":vV()?Qr="webworker":wV()?Qr="jsdom":QP()?Qr="deno":Qr="other",Qr);let kg;function tM(){if(kg===void 0){const t=eM(),e=xV();kg={library:"langsmith",runtime:t,sdk:"langsmith-js",sdk_version:XP,...e}}return kg}function nM(){const t=SV(),e={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(t))typeof s=="string"&&!n.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function SV(){const t={};try{if(typeof process<"u"&&ku)for(const[e,n]of Object.entries(ku))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&n!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof n=="string"?t[e]=n.slice(0,2)+"*".repeat(n.length-4)+n.slice(-2):t[e]=n)}catch{}return t}function us(t){try{return typeof process<"u"?ku==null?void 0:ku[t]:void 0}catch{return}}function Jn(t){return us(`LANGSMITH_${t}`)||us(`LANGCHAIN_${t}`)}let Og;function xV(){if(Og!==void 0)return Og;const t=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const n of t){const r=us(n);r!==void 0&&(e[n]=r)}return Og=e,e}function rM(){return us("OTEL_ENABLED")==="true"||Jn("OTEL_ENABLED")==="true"}class TV{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...n){!this.hasWarned&&rM()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let r;if(n.length===1&&typeof n[0]=="function"?r=n[0]:n.length===2&&typeof n[1]=="function"?r=n[1]:n.length===3&&typeof n[2]=="function"&&(r=n[2]),typeof r=="function")return r()}}class AV{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new TV})}getTracer(e,n){return this.mockTracer}getActiveSpan(){}setSpan(e,n){return e}getSpan(e){}setSpanContext(e,n){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class EV{active(){return{}}with(e,n){return n()}}const Dg=Symbol.for("ls:otel_trace"),Lg=Symbol.for("ls:otel_context"),vC=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),CV=new AV,IV=new EV;class RV{getTraceInstance(){return globalThis[Dg]??CV}getContextInstance(){return globalThis[Lg]??IV}initializeGlobalInstances(e){globalThis[Dg]===void 0&&(globalThis[Dg]=e.trace),globalThis[Lg]===void 0&&(globalThis[Lg]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[vC]=e}getDefaultOTLPTracerComponents(){return globalThis[vC]??void 0}}const Tv=new RV;function sM(){return Tv.getTraceInstance()}function NV(){return Tv.getContextInstance()}function PV(){return Tv.getDefaultOTLPTracerComponents()}const MV={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function kV(t){return MV[t]||t}class OV{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,n){for(const r of e)try{if(!r.run)continue;if(r.operation==="post"){const s=this.createSpanForRun(r,r.run,n.get(r.id));s&&!r.run.end_time&&this.spans.set(r.id,s)}else this.updateSpanForRun(r,r.run)}catch(s){console.error(`Error processing operation ${r.id}:`,s)}}createSpanForRun(e,n,r){const s=r&&sM().getSpan(r);if(s)try{return this.finishSpanSetup(s,n,e)}catch(a){console.error(`Failed to create span for run ${e.id}:`,a);return}}finishSpanSetup(e,n,r){return this.setSpanAttributes(e,n,r),n.error?(e.setStatus({code:2}),e.recordException(new Error(n.error))):e.setStatus({code:1}),n.end_time&&e.end(new Date(n.end_time)),e}updateSpanForRun(e,n){try{const r=this.spans.get(e.id);if(!r){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(r,n,e),n.error?(r.setStatus({code:2}),r.recordException(new Error(n.error))):r.setStatus({code:1});const s=n.end_time;s&&(r.end(new Date(s)),this.spans.delete(e.id))}catch(r){console.error(`Failed to update span for run ${e.id}:`,r)}}extractModelName(e){var n;if((n=e.extra)!=null&&n.metadata){const r=e.extra.metadata;if(r.ls_model_name)return r.ls_model_name;if(r.invocation_params){const s=r.invocation_params;if(s.model)return s.model;if(s.model_name)return s.model_name}}}setSpanAttributes(e,n,r){var u;if("run_type"in n&&n.run_type){e.setAttribute(cV,n.run_type);const d=kV(n.run_type||"chain");e.setAttribute(qj,d)}"name"in n&&n.name&&e.setAttribute(dV,n.name),"session_id"in n&&n.session_id&&e.setAttribute(lV,n.session_id),"session_name"in n&&n.session_name&&e.setAttribute(uV,n.session_name),this.setGenAiSystem(e,n);const s=this.extractModelName(n);s&&e.setAttribute(hC,s),"prompt_tokens"in n&&typeof n.prompt_tokens=="number"&&e.setAttribute(mC,n.prompt_tokens),"completion_tokens"in n&&typeof n.completion_tokens=="number"&&e.setAttribute(gC,n.completion_tokens),"total_tokens"in n&&typeof n.total_tokens=="number"&&e.setAttribute(yC,n.total_tokens),this.setInvocationParameters(e,n);const a=((u=n.extra)==null?void 0:u.metadata)||{};for(const[d,c]of Object.entries(a))c!=null&&e.setAttribute(`${fV}.${d}`,String(c));const o=n.tags;if(o&&Array.isArray(o)?e.setAttribute(_C,o.join(", ")):o&&e.setAttribute(_C,String(o)),"serialized"in n&&typeof n.serialized=="object"){const d=n.serialized;d.name&&e.setAttribute(eV,String(d.name)),d.signature&&e.setAttribute(tV,String(d.signature)),d.doc&&e.setAttribute(nV,String(d.doc))}this.setIOAttributes(e,r)}setGenAiSystem(e,n){let r="langchain";const s=this.extractModelName(n);if(s){const a=s.toLowerCase();a.includes("anthropic")||a.startsWith("claude")?r="anthropic":a.includes("bedrock")?r="aws.bedrock":a.includes("azure")&&a.includes("openai")?r="az.ai.openai":a.includes("azure")&&a.includes("inference")?r="az.ai.inference":a.includes("cohere")?r="cohere":a.includes("deepseek")?r="deepseek":a.includes("gemini")?r="gemini":a.includes("groq")?r="groq":a.includes("watson")||a.includes("ibm")?r="ibm.watsonx.ai":a.includes("mistral")?r="mistral_ai":a.includes("gpt")||a.includes("openai")?r="openai":a.includes("perplexity")||a.includes("sonar")?r="perplexity":a.includes("vertex")?r="vertex_ai":(a.includes("xai")||a.includes("grok"))&&(r="xai")}e.setAttribute(Gj,r)}setInvocationParameters(e,n){var s,a;if(!((a=(s=n.extra)==null?void 0:s.metadata)!=null&&a.invocation_params))return;const r=n.extra.metadata.invocation_params;r.max_tokens!==void 0&&e.setAttribute(zj,r.max_tokens),r.temperature!==void 0&&e.setAttribute(jj,r.temperature),r.top_p!==void 0&&e.setAttribute(Vj,r.top_p),r.frequency_penalty!==void 0&&e.setAttribute(Jj,r.frequency_penalty),r.presence_penalty!==void 0&&e.setAttribute(Yj,r.presence_penalty)}setIOAttributes(e,n){if(n.run.inputs)try{const r=n.run.inputs;typeof r=="object"&&r!==null&&(r.model&&Array.isArray(r.messages)&&e.setAttribute(hC,r.model),r.stream!==void 0&&e.setAttribute(pV,r.stream),r.extra_headers&&e.setAttribute(hV,JSON.stringify(r.extra_headers)),r.extra_query&&e.setAttribute(Xj,JSON.stringify(r.extra_query)),r.extra_body&&e.setAttribute(Qj,JSON.stringify(r.extra_body))),e.setAttribute(Wj,JSON.stringify(r))}catch(r){console.debug(`Failed to process inputs for run ${n.id}`,r)}if(n.run.outputs)try{const r=n.run.outputs,s=this.getUnifiedRunTokens(r);if(s&&(e.setAttribute(mC,s[0]),e.setAttribute(gC,s[1]),e.setAttribute(yC,s[0]+s[1])),r&&typeof r=="object"){if(r.model&&e.setAttribute(Hj,String(r.model)),r.id&&e.setAttribute(rV,r.id),r.choices&&Array.isArray(r.choices)){const a=r.choices.map(o=>o.finish_reason).filter(o=>o).map(String);a.length>0&&e.setAttribute(Kj,a.join(", "))}if(r.service_tier&&e.setAttribute(sV,r.service_tier),r.system_fingerprint&&e.setAttribute(aV,r.system_fingerprint),r.usage_metadata&&typeof r.usage_metadata=="object"){const a=r.usage_metadata;a.input_token_details&&e.setAttribute(iV,JSON.stringify(a.input_token_details)),a.output_token_details&&e.setAttribute(oV,JSON.stringify(a.output_token_details))}}e.setAttribute(Zj,JSON.stringify(r))}catch(r){console.debug(`Failed to process outputs for run ${n.id}`,r)}}getUnifiedRunTokens(e){if(!e)return null;let n=this.extractUnifiedRunTokens(e.usage_metadata);if(n)return n;const r=Object.keys(e);for(const o of r){const u=e[o];if(!(!u||typeof u!="object")&&(n=this.extractUnifiedRunTokens(u.usage_metadata),n||u.lc===1&&u.kwargs&&typeof u.kwargs=="object"&&(n=this.extractUnifiedRunTokens(u.kwargs.usage_metadata),n)))return n}const s=e.generations||[];if(!Array.isArray(s))return null;const a=Array.isArray(s[0])?s.flat():s;for(const o of a)if(typeof o=="object"&&o.message&&typeof o.message=="object"&&o.message.kwargs&&typeof o.message.kwargs=="object"&&(n=this.extractUnifiedRunTokens(o.message.kwargs.usage_metadata),n))return n;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}var du={exports:{}},$g={},Ug,wC;function DV(){if(wC)return Ug;wC=1;function t(e,n){typeof n=="boolean"&&(n={forever:n}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=n||{},this._maxRetryTime=n&&n.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Ug=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var n=new Date().getTime();if(e&&n-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,n){this._fn=e,n&&(n.timeout&&(this._operationTimeout=n.timeout),n.cb&&(this._operationTimeoutCb=n.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},n=null,r=0,s=0;s<this._errors.length;s++){var a=this._errors[s],o=a.message,u=(e[o]||0)+1;e[o]=u,u>=r&&(n=a,r=u)}return n},Ug}var bC;function LV(){return bC||(bC=1,(function(t){var e=DV();t.operation=function(n){var r=t.timeouts(n);return new e(r,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})},t.timeouts=function(n){if(n instanceof Array)return[].concat(n);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in n)r[s]=n[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],o=0;o<r.retries;o++)a.push(this.createTimeout(o,r));return n&&n.forever&&!a.length&&a.push(this.createTimeout(o,r)),a.sort(function(u,d){return u-d}),a},t.createTimeout=function(n,r){var s=r.randomize?Math.random()+1:1,a=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,n));return a=Math.min(a,r.maxTimeout),a},t.wrap=function(n,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var a in n)typeof n[a]=="function"&&s.push(a)}for(var o=0;o<s.length;o++){var u=s[o],d=n[u];n[u]=(function(p){var m=t.operation(r),y=Array.prototype.slice.call(arguments,1),w=y.pop();y.push(function(x){m.retry(x)||(x&&(arguments[0]=m.mainError()),w.apply(this,arguments))}),m.attempt(function(){p.apply(n,y)})}).bind(n,d),n[u].options=r}}})($g)),$g}var Fg,SC;function $V(){return SC||(SC=1,Fg=LV()),Fg}var xC;function UV(){if(xC)return du.exports;xC=1;const t=$V(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class n extends Error{constructor(u){super(),u instanceof Error?(this.originalError=u,{message:u}=u):(this.originalError=new Error(u),this.originalError.stack=this.stack),this.name="AbortError",this.message=u}}const r=(o,u,d)=>{const c=d.retries-(u-1);return o.attemptNumber=u,o.retriesLeft=c,o},s=o=>e.includes(o),a=(o,u)=>new Promise((d,c)=>{u={onFailedAttempt:()=>{},retries:10,...u};const p=t.operation(u);p.attempt(async m=>{try{d(await o(m))}catch(y){if(!(y instanceof Error)){c(new TypeError(`Non-error was thrown: "${y}". You should only throw errors.`));return}if(y instanceof n)p.stop(),c(y.originalError);else if(y instanceof TypeError&&!s(y.message))p.stop(),c(y);else{r(y,m,u);try{await u.onFailedAttempt(y)}catch(w){c(w);return}p.retry(y)||c(p.mainError())}}})});return du.exports=a,du.exports.default=a,du.exports.AbortError=n,du.exports}var FV=UV();const jf=Ga(FV);var Zd={},Bg={exports:{}},TC;function BV(){return TC||(TC=1,(function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function s(d,c,p){this.fn=d,this.context=c,this.once=p||!1}function a(d,c,p,m,y){if(typeof p!="function")throw new TypeError("The listener must be a function");var w=new s(p,m||d,y),x=n?n+c:c;return d._events[x]?d._events[x].fn?d._events[x]=[d._events[x],w]:d._events[x].push(w):(d._events[x]=w,d._eventsCount++),d}function o(d,c){--d._eventsCount===0?d._events=new r:delete d._events[c]}function u(){this._events=new r,this._eventsCount=0}u.prototype.eventNames=function(){var c=[],p,m;if(this._eventsCount===0)return c;for(m in p=this._events)e.call(p,m)&&c.push(n?m.slice(1):m);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(p)):c},u.prototype.listeners=function(c){var p=n?n+c:c,m=this._events[p];if(!m)return[];if(m.fn)return[m.fn];for(var y=0,w=m.length,x=new Array(w);y<w;y++)x[y]=m[y].fn;return x},u.prototype.listenerCount=function(c){var p=n?n+c:c,m=this._events[p];return m?m.fn?1:m.length:0},u.prototype.emit=function(c,p,m,y,w,x){var A=n?n+c:c;if(!this._events[A])return!1;var E=this._events[A],C=arguments.length,D,O;if(E.fn){switch(E.once&&this.removeListener(c,E.fn,void 0,!0),C){case 1:return E.fn.call(E.context),!0;case 2:return E.fn.call(E.context,p),!0;case 3:return E.fn.call(E.context,p,m),!0;case 4:return E.fn.call(E.context,p,m,y),!0;case 5:return E.fn.call(E.context,p,m,y,w),!0;case 6:return E.fn.call(E.context,p,m,y,w,x),!0}for(O=1,D=new Array(C-1);O<C;O++)D[O-1]=arguments[O];E.fn.apply(E.context,D)}else{var T=E.length,I;for(O=0;O<T;O++)switch(E[O].once&&this.removeListener(c,E[O].fn,void 0,!0),C){case 1:E[O].fn.call(E[O].context);break;case 2:E[O].fn.call(E[O].context,p);break;case 3:E[O].fn.call(E[O].context,p,m);break;case 4:E[O].fn.call(E[O].context,p,m,y);break;default:if(!D)for(I=1,D=new Array(C-1);I<C;I++)D[I-1]=arguments[I];E[O].fn.apply(E[O].context,D)}}return!0},u.prototype.on=function(c,p,m){return a(this,c,p,m,!1)},u.prototype.once=function(c,p,m){return a(this,c,p,m,!0)},u.prototype.removeListener=function(c,p,m,y){var w=n?n+c:c;if(!this._events[w])return this;if(!p)return o(this,w),this;var x=this._events[w];if(x.fn)x.fn===p&&(!y||x.once)&&(!m||x.context===m)&&o(this,w);else{for(var A=0,E=[],C=x.length;A<C;A++)(x[A].fn!==p||y&&!x[A].once||m&&x[A].context!==m)&&E.push(x[A]);E.length?this._events[w]=E.length===1?E[0]:E:o(this,w)}return this},u.prototype.removeAllListeners=function(c){var p;return c?(p=n?n+c:c,this._events[p]&&o(this,p)):(this._events=new r,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=n,u.EventEmitter=u,t.exports=u})(Bg)),Bg.exports}var fu={exports:{}},qg,AC;function qV(){return AC||(AC=1,qg=(t,e)=>(e=e||(()=>{}),t.then(n=>new Promise(r=>{r(e())}).then(()=>n),n=>new Promise(r=>{r(e())}).then(()=>{throw n})))),qg}var EC;function GV(){if(EC)return fu.exports;EC=1;const t=qV();class e extends Error{constructor(s){super(s),this.name="TimeoutError"}}const n=(r,s,a)=>new Promise((o,u)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){o(r);return}const d=setTimeout(()=>{if(typeof a=="function"){try{o(a())}catch(m){u(m)}return}const c=typeof a=="string"?a:`Promise timed out after ${s} milliseconds`,p=a instanceof Error?a:new e(c);typeof r.cancel=="function"&&r.cancel(),u(p)},s);t(r.then(o,u),()=>{clearTimeout(d)})});return fu.exports=n,fu.exports.default=n,fu.exports.TimeoutError=e,fu.exports}var Xd={},Qd={},CC;function HV(){if(CC)return Qd;CC=1,Object.defineProperty(Qd,"__esModule",{value:!0});function t(e,n,r){let s=0,a=e.length;for(;a>0;){const o=a/2|0;let u=s+o;r(e[u],n)<=0?(s=++u,a-=o+1):a=o}return s}return Qd.default=t,Qd}var IC;function zV(){if(IC)return Xd;IC=1,Object.defineProperty(Xd,"__esModule",{value:!0});const t=HV();class e{constructor(){this._queue=[]}enqueue(r,s){s=Object.assign({priority:0},s);const a={priority:s.priority,run:r};if(this.size&&this._queue[this.size-1].priority>=s.priority){this._queue.push(a);return}const o=t.default(this._queue,a,(u,d)=>d.priority-u.priority);this._queue.splice(o,0,a)}dequeue(){const r=this._queue.shift();return r==null?void 0:r.run}filter(r){return this._queue.filter(s=>s.priority===r.priority).map(s=>s.run)}get size(){return this._queue.length}}return Xd.default=e,Xd}var RC;function jV(){if(RC)return Zd;RC=1,Object.defineProperty(Zd,"__esModule",{value:!0});const t=BV(),e=GV(),n=zV(),r=()=>{},s=new e.TimeoutError;class a extends t{constructor(u){var d,c,p,m;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=r,this._resolveIdle=r,u=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:n.default},u),!(typeof u.intervalCap=="number"&&u.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(c=(d=u.intervalCap)===null||d===void 0?void 0:d.toString())!==null&&c!==void 0?c:""}\` (${typeof u.intervalCap})`);if(u.interval===void 0||!(Number.isFinite(u.interval)&&u.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(m=(p=u.interval)===null||p===void 0?void 0:p.toString())!==null&&m!==void 0?m:""}\` (${typeof u.interval})`);this._carryoverConcurrencyCount=u.carryoverConcurrencyCount,this._isIntervalIgnored=u.intervalCap===1/0||u.interval===0,this._intervalCap=u.intervalCap,this._interval=u.interval,this._queue=new u.queueClass,this._queueClass=u.queueClass,this.concurrency=u.concurrency,this._timeout=u.timeout,this._throwOnTimeout=u.throwOnTimeout===!0,this._isPaused=u.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=r,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=r,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const u=Date.now();if(this._intervalId===void 0){const d=this._intervalEnd-u;if(d<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},d)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const u=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const d=this._queue.dequeue();return d?(this.emit("active"),d(),u&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(u){if(!(typeof u=="number"&&u>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${u}\` (${typeof u})`);this._concurrency=u,this._processQueue()}async add(u,d={}){return new Promise((c,p)=>{const m=async()=>{this._pendingCount++,this._intervalCount++;try{const y=this._timeout===void 0&&d.timeout===void 0?u():e.default(Promise.resolve(u()),d.timeout===void 0?this._timeout:d.timeout,()=>{(d.throwOnTimeout===void 0?this._throwOnTimeout:d.throwOnTimeout)&&p(s)});c(await y)}catch(y){p(y)}this._next()};this._queue.enqueue(m,d),this._tryToStartAnother(),this.emit("add")})}async addAll(u,d){return Promise.all(u.map(async c=>this.add(c,d)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(u=>{const d=this._resolveEmpty;this._resolveEmpty=()=>{d(),u()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(u=>{const d=this._resolveIdle;this._resolveIdle=()=>{d(),u()}})}get size(){return this._queue.size}sizeBy(u){return this._queue.filter(u).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(u){this._timeout=u}}return Zd.default=a,Zd}var VV=jV();const Hs=Ga(VV),JV=[429,500,502,503,504];let NC=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Hs?this.queue=new Hs.default({concurrency:this.maxConcurrency}):this.queue=new Hs({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...n){const r=this.onFailedResponseHook;return this.queue.add(()=>jf(()=>e(...n).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.name==="TimeoutError"||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const a=s==null?void 0:s.response;if(r&&await r(a))return;const o=(a==null?void 0:a.status)??(s==null?void 0:s.status);if(o&&!JV.includes(+o))throw s},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,n,...r){return e.signal?Promise.race([this.call(n,...r),new Promise((s,a)=>{var o;(o=e.signal)==null||o.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(n,...r)}};function PC(t){return typeof(t==null?void 0:t._getType)=="function"}function MC(t){const e={type:t._getType(),data:{content:t.content}};return t!=null&&t.additional_kwargs&&Object.keys(t.additional_kwargs).length>0&&(e.data.additional_kwargs={...t.additional_kwargs}),e}const YV=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Xe(t,e){if(!YV.test(t)){const n=e!==void 0?`Invalid UUID for ${e}: ${t}`:`Invalid UUID: ${t}`;throw new Error(n)}return t}const kC={};function J_(t){kC[t]||(console.warn(t),kC[t]=!0)}var ef={exports:{}},Gg,OC;function Ep(){if(OC)return Gg;OC=1;const t="2.0.0",e=256,n=Number.MAX_SAFE_INTEGER||9007199254740991,r=16,s=e-6;return Gg={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:s,MAX_SAFE_INTEGER:n,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:t,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},Gg}var Hg,DC;function Cp(){if(DC)return Hg;DC=1;var t={};return Hg=typeof process=="object"&&t&&t.NODE_DEBUG&&/\bsemver\b/i.test(t.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{},Hg}var LC;function mc(){return LC||(LC=1,(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=Ep(),a=Cp();e=t.exports={};const o=e.re=[],u=e.safeRe=[],d=e.src=[],c=e.safeSrc=[],p=e.t={};let m=0;const y="[a-zA-Z0-9-]",w=[["\\s",1],["\\d",s],[y,r]],x=E=>{for(const[C,D]of w)E=E.split(`${C}*`).join(`${C}{0,${D}}`).split(`${C}+`).join(`${C}{1,${D}}`);return E},A=(E,C,D)=>{const O=x(C),T=m++;a(E,T,C),p[E]=T,d[T]=C,c[T]=O,o[T]=new RegExp(C,D?"g":void 0),u[T]=new RegExp(O,D?"g":void 0)};A("NUMERICIDENTIFIER","0|[1-9]\\d*"),A("NUMERICIDENTIFIERLOOSE","\\d+"),A("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${y}*`),A("MAINVERSION",`(${d[p.NUMERICIDENTIFIER]})\\.(${d[p.NUMERICIDENTIFIER]})\\.(${d[p.NUMERICIDENTIFIER]})`),A("MAINVERSIONLOOSE",`(${d[p.NUMERICIDENTIFIERLOOSE]})\\.(${d[p.NUMERICIDENTIFIERLOOSE]})\\.(${d[p.NUMERICIDENTIFIERLOOSE]})`),A("PRERELEASEIDENTIFIER",`(?:${d[p.NONNUMERICIDENTIFIER]}|${d[p.NUMERICIDENTIFIER]})`),A("PRERELEASEIDENTIFIERLOOSE",`(?:${d[p.NONNUMERICIDENTIFIER]}|${d[p.NUMERICIDENTIFIERLOOSE]})`),A("PRERELEASE",`(?:-(${d[p.PRERELEASEIDENTIFIER]}(?:\\.${d[p.PRERELEASEIDENTIFIER]})*))`),A("PRERELEASELOOSE",`(?:-?(${d[p.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${d[p.PRERELEASEIDENTIFIERLOOSE]})*))`),A("BUILDIDENTIFIER",`${y}+`),A("BUILD",`(?:\\+(${d[p.BUILDIDENTIFIER]}(?:\\.${d[p.BUILDIDENTIFIER]})*))`),A("FULLPLAIN",`v?${d[p.MAINVERSION]}${d[p.PRERELEASE]}?${d[p.BUILD]}?`),A("FULL",`^${d[p.FULLPLAIN]}$`),A("LOOSEPLAIN",`[v=\\s]*${d[p.MAINVERSIONLOOSE]}${d[p.PRERELEASELOOSE]}?${d[p.BUILD]}?`),A("LOOSE",`^${d[p.LOOSEPLAIN]}$`),A("GTLT","((?:<|>)?=?)"),A("XRANGEIDENTIFIERLOOSE",`${d[p.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),A("XRANGEIDENTIFIER",`${d[p.NUMERICIDENTIFIER]}|x|X|\\*`),A("XRANGEPLAIN",`[v=\\s]*(${d[p.XRANGEIDENTIFIER]})(?:\\.(${d[p.XRANGEIDENTIFIER]})(?:\\.(${d[p.XRANGEIDENTIFIER]})(?:${d[p.PRERELEASE]})?${d[p.BUILD]}?)?)?`),A("XRANGEPLAINLOOSE",`[v=\\s]*(${d[p.XRANGEIDENTIFIERLOOSE]})(?:\\.(${d[p.XRANGEIDENTIFIERLOOSE]})(?:\\.(${d[p.XRANGEIDENTIFIERLOOSE]})(?:${d[p.PRERELEASELOOSE]})?${d[p.BUILD]}?)?)?`),A("XRANGE",`^${d[p.GTLT]}\\s*${d[p.XRANGEPLAIN]}$`),A("XRANGELOOSE",`^${d[p.GTLT]}\\s*${d[p.XRANGEPLAINLOOSE]}$`),A("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),A("COERCE",`${d[p.COERCEPLAIN]}(?:$|[^\\d])`),A("COERCEFULL",d[p.COERCEPLAIN]+`(?:${d[p.PRERELEASE]})?(?:${d[p.BUILD]})?(?:$|[^\\d])`),A("COERCERTL",d[p.COERCE],!0),A("COERCERTLFULL",d[p.COERCEFULL],!0),A("LONETILDE","(?:~>?)"),A("TILDETRIM",`(\\s*)${d[p.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",A("TILDE",`^${d[p.LONETILDE]}${d[p.XRANGEPLAIN]}$`),A("TILDELOOSE",`^${d[p.LONETILDE]}${d[p.XRANGEPLAINLOOSE]}$`),A("LONECARET","(?:\\^)"),A("CARETTRIM",`(\\s*)${d[p.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",A("CARET",`^${d[p.LONECARET]}${d[p.XRANGEPLAIN]}$`),A("CARETLOOSE",`^${d[p.LONECARET]}${d[p.XRANGEPLAINLOOSE]}$`),A("COMPARATORLOOSE",`^${d[p.GTLT]}\\s*(${d[p.LOOSEPLAIN]})$|^$`),A("COMPARATOR",`^${d[p.GTLT]}\\s*(${d[p.FULLPLAIN]})$|^$`),A("COMPARATORTRIM",`(\\s*)${d[p.GTLT]}\\s*(${d[p.LOOSEPLAIN]}|${d[p.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",A("HYPHENRANGE",`^\\s*(${d[p.XRANGEPLAIN]})\\s+-\\s+(${d[p.XRANGEPLAIN]})\\s*$`),A("HYPHENRANGELOOSE",`^\\s*(${d[p.XRANGEPLAINLOOSE]})\\s+-\\s+(${d[p.XRANGEPLAINLOOSE]})\\s*$`),A("STAR","(<|>)?=?\\s*\\*"),A("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),A("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(ef,ef.exports)),ef.exports}var zg,$C;function Av(){if($C)return zg;$C=1;const t=Object.freeze({loose:!0}),e=Object.freeze({});return zg=r=>r?typeof r!="object"?t:r:e,zg}var jg,UC;function aM(){if(UC)return jg;UC=1;const t=/^[0-9]+$/,e=(r,s)=>{if(typeof r=="number"&&typeof s=="number")return r===s?0:r<s?-1:1;const a=t.test(r),o=t.test(s);return a&&o&&(r=+r,s=+s),r===s?0:a&&!o?-1:o&&!a?1:r<s?-1:1};return jg={compareIdentifiers:e,rcompareIdentifiers:(r,s)=>e(s,r)},jg}var Vg,FC;function $n(){if(FC)return Vg;FC=1;const t=Cp(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:n}=Ep(),{safeRe:r,t:s}=mc(),a=Av(),{compareIdentifiers:o}=aM();class u{constructor(c,p){if(p=a(p),c instanceof u){if(c.loose===!!p.loose&&c.includePrerelease===!!p.includePrerelease)return c;c=c.version}else if(typeof c!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof c}".`);if(c.length>e)throw new TypeError(`version is longer than ${e} characters`);t("SemVer",c,p),this.options=p,this.loose=!!p.loose,this.includePrerelease=!!p.includePrerelease;const m=c.trim().match(p.loose?r[s.LOOSE]:r[s.FULL]);if(!m)throw new TypeError(`Invalid Version: ${c}`);if(this.raw=c,this.major=+m[1],this.minor=+m[2],this.patch=+m[3],this.major>n||this.major<0)throw new TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw new TypeError("Invalid patch version");m[4]?this.prerelease=m[4].split(".").map(y=>{if(/^[0-9]+$/.test(y)){const w=+y;if(w>=0&&w<n)return w}return y}):this.prerelease=[],this.build=m[5]?m[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(c){if(t("SemVer.compare",this.version,this.options,c),!(c instanceof u)){if(typeof c=="string"&&c===this.version)return 0;c=new u(c,this.options)}return c.version===this.version?0:this.compareMain(c)||this.comparePre(c)}compareMain(c){return c instanceof u||(c=new u(c,this.options)),this.major<c.major?-1:this.major>c.major?1:this.minor<c.minor?-1:this.minor>c.minor?1:this.patch<c.patch?-1:this.patch>c.patch?1:0}comparePre(c){if(c instanceof u||(c=new u(c,this.options)),this.prerelease.length&&!c.prerelease.length)return-1;if(!this.prerelease.length&&c.prerelease.length)return 1;if(!this.prerelease.length&&!c.prerelease.length)return 0;let p=0;do{const m=this.prerelease[p],y=c.prerelease[p];if(t("prerelease compare",p,m,y),m===void 0&&y===void 0)return 0;if(y===void 0)return 1;if(m===void 0)return-1;if(m===y)continue;return o(m,y)}while(++p)}compareBuild(c){c instanceof u||(c=new u(c,this.options));let p=0;do{const m=this.build[p],y=c.build[p];if(t("build compare",p,m,y),m===void 0&&y===void 0)return 0;if(y===void 0)return 1;if(m===void 0)return-1;if(m===y)continue;return o(m,y)}while(++p)}inc(c,p,m){if(c.startsWith("pre")){if(!p&&m===!1)throw new Error("invalid increment argument: identifier is empty");if(p){const y=`-${p}`.match(this.options.loose?r[s.PRERELEASELOOSE]:r[s.PRERELEASE]);if(!y||y[1]!==p)throw new Error(`invalid identifier: ${p}`)}}switch(c){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",p,m);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",p,m);break;case"prepatch":this.prerelease.length=0,this.inc("patch",p,m),this.inc("pre",p,m);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",p,m),this.inc("pre",p,m);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const y=Number(m)?1:0;if(this.prerelease.length===0)this.prerelease=[y];else{let w=this.prerelease.length;for(;--w>=0;)typeof this.prerelease[w]=="number"&&(this.prerelease[w]++,w=-2);if(w===-1){if(p===this.prerelease.join(".")&&m===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(y)}}if(p){let w=[p,y];m===!1&&(w=[p]),o(this.prerelease[0],p)===0?isNaN(this.prerelease[1])&&(this.prerelease=w):this.prerelease=w}break}default:throw new Error(`invalid increment argument: ${c}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return Vg=u,Vg}var Jg,BC;function pl(){if(BC)return Jg;BC=1;const t=$n();return Jg=(n,r,s=!1)=>{if(n instanceof t)return n;try{return new t(n,r)}catch(a){if(!s)return null;throw a}},Jg}var Yg,qC;function KV(){if(qC)return Yg;qC=1;const t=pl();return Yg=(n,r)=>{const s=t(n,r);return s?s.version:null},Yg}var Kg,GC;function WV(){if(GC)return Kg;GC=1;const t=pl();return Kg=(n,r)=>{const s=t(n.trim().replace(/^[=v]+/,""),r);return s?s.version:null},Kg}var Wg,HC;function ZV(){if(HC)return Wg;HC=1;const t=$n();return Wg=(n,r,s,a,o)=>{typeof s=="string"&&(o=a,a=s,s=void 0);try{return new t(n instanceof t?n.version:n,s).inc(r,a,o).version}catch{return null}},Wg}var Zg,zC;function XV(){if(zC)return Zg;zC=1;const t=pl();return Zg=(n,r)=>{const s=t(n,null,!0),a=t(r,null,!0),o=s.compare(a);if(o===0)return null;const u=o>0,d=u?s:a,c=u?a:s,p=!!d.prerelease.length;if(!!c.prerelease.length&&!p){if(!c.patch&&!c.minor)return"major";if(c.compareMain(d)===0)return c.minor&&!c.patch?"minor":"patch"}const y=p?"pre":"";return s.major!==a.major?y+"major":s.minor!==a.minor?y+"minor":s.patch!==a.patch?y+"patch":"prerelease"},Zg}var Xg,jC;function QV(){if(jC)return Xg;jC=1;const t=$n();return Xg=(n,r)=>new t(n,r).major,Xg}var Qg,VC;function e6(){if(VC)return Qg;VC=1;const t=$n();return Qg=(n,r)=>new t(n,r).minor,Qg}var ey,JC;function t6(){if(JC)return ey;JC=1;const t=$n();return ey=(n,r)=>new t(n,r).patch,ey}var ty,YC;function n6(){if(YC)return ty;YC=1;const t=pl();return ty=(n,r)=>{const s=t(n,r);return s&&s.prerelease.length?s.prerelease:null},ty}var ny,KC;function jr(){if(KC)return ny;KC=1;const t=$n();return ny=(n,r,s)=>new t(n,s).compare(new t(r,s)),ny}var ry,WC;function r6(){if(WC)return ry;WC=1;const t=jr();return ry=(n,r,s)=>t(r,n,s),ry}var sy,ZC;function s6(){if(ZC)return sy;ZC=1;const t=jr();return sy=(n,r)=>t(n,r,!0),sy}var ay,XC;function Ev(){if(XC)return ay;XC=1;const t=$n();return ay=(n,r,s)=>{const a=new t(n,s),o=new t(r,s);return a.compare(o)||a.compareBuild(o)},ay}var iy,QC;function a6(){if(QC)return iy;QC=1;const t=Ev();return iy=(n,r)=>n.sort((s,a)=>t(s,a,r)),iy}var oy,eI;function i6(){if(eI)return oy;eI=1;const t=Ev();return oy=(n,r)=>n.sort((s,a)=>t(a,s,r)),oy}var ly,tI;function Ip(){if(tI)return ly;tI=1;const t=jr();return ly=(n,r,s)=>t(n,r,s)>0,ly}var uy,nI;function Cv(){if(nI)return uy;nI=1;const t=jr();return uy=(n,r,s)=>t(n,r,s)<0,uy}var cy,rI;function iM(){if(rI)return cy;rI=1;const t=jr();return cy=(n,r,s)=>t(n,r,s)===0,cy}var dy,sI;function oM(){if(sI)return dy;sI=1;const t=jr();return dy=(n,r,s)=>t(n,r,s)!==0,dy}var fy,aI;function Iv(){if(aI)return fy;aI=1;const t=jr();return fy=(n,r,s)=>t(n,r,s)>=0,fy}var py,iI;function Rv(){if(iI)return py;iI=1;const t=jr();return py=(n,r,s)=>t(n,r,s)<=0,py}var hy,oI;function lM(){if(oI)return hy;oI=1;const t=iM(),e=oM(),n=Ip(),r=Iv(),s=Cv(),a=Rv();return hy=(u,d,c,p)=>{switch(d){case"===":return typeof u=="object"&&(u=u.version),typeof c=="object"&&(c=c.version),u===c;case"!==":return typeof u=="object"&&(u=u.version),typeof c=="object"&&(c=c.version),u!==c;case"":case"=":case"==":return t(u,c,p);case"!=":return e(u,c,p);case">":return n(u,c,p);case">=":return r(u,c,p);case"<":return s(u,c,p);case"<=":return a(u,c,p);default:throw new TypeError(`Invalid operator: ${d}`)}},hy}var my,lI;function o6(){if(lI)return my;lI=1;const t=$n(),e=pl(),{safeRe:n,t:r}=mc();return my=(a,o)=>{if(a instanceof t)return a;if(typeof a=="number"&&(a=String(a)),typeof a!="string")return null;o=o||{};let u=null;if(!o.rtl)u=a.match(o.includePrerelease?n[r.COERCEFULL]:n[r.COERCE]);else{const w=o.includePrerelease?n[r.COERCERTLFULL]:n[r.COERCERTL];let x;for(;(x=w.exec(a))&&(!u||u.index+u[0].length!==a.length);)(!u||x.index+x[0].length!==u.index+u[0].length)&&(u=x),w.lastIndex=x.index+x[1].length+x[2].length;w.lastIndex=-1}if(u===null)return null;const d=u[2],c=u[3]||"0",p=u[4]||"0",m=o.includePrerelease&&u[5]?`-${u[5]}`:"",y=o.includePrerelease&&u[6]?`+${u[6]}`:"";return e(`${d}.${c}.${p}${m}${y}`,o)},my}var gy,uI;function l6(){if(uI)return gy;uI=1;class t{constructor(){this.max=1e3,this.map=new Map}get(n){const r=this.map.get(n);if(r!==void 0)return this.map.delete(n),this.map.set(n,r),r}delete(n){return this.map.delete(n)}set(n,r){if(!this.delete(n)&&r!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(n,r)}return this}}return gy=t,gy}var yy,cI;function Vr(){if(cI)return yy;cI=1;const t=/\s+/g;class e{constructor(V,B){if(B=s(B),V instanceof e)return V.loose===!!B.loose&&V.includePrerelease===!!B.includePrerelease?V:new e(V.raw,B);if(V instanceof a)return this.raw=V.value,this.set=[[V]],this.formatted=void 0,this;if(this.options=B,this.loose=!!B.loose,this.includePrerelease=!!B.includePrerelease,this.raw=V.trim().replace(t," "),this.set=this.raw.split("||").map(G=>this.parseRange(G.trim())).filter(G=>G.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const G=this.set[0];if(this.set=this.set.filter(Z=>!A(Z[0])),this.set.length===0)this.set=[G];else if(this.set.length>1){for(const Z of this.set)if(Z.length===1&&E(Z[0])){this.set=[Z];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let V=0;V<this.set.length;V++){V>0&&(this.formatted+="||");const B=this.set[V];for(let G=0;G<B.length;G++)G>0&&(this.formatted+=" "),this.formatted+=B[G].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(V){const G=((this.options.includePrerelease&&w)|(this.options.loose&&x))+":"+V,Z=r.get(G);if(Z)return Z;const se=this.options.loose,le=se?d[c.HYPHENRANGELOOSE]:d[c.HYPHENRANGE];V=V.replace(le,F(this.options.includePrerelease)),o("hyphen replace",V),V=V.replace(d[c.COMPARATORTRIM],p),o("comparator trim",V),V=V.replace(d[c.TILDETRIM],m),o("tilde trim",V),V=V.replace(d[c.CARETTRIM],y),o("caret trim",V);let q=V.split(" ").map(ie=>D(ie,this.options)).join(" ").split(/\s+/).map(ie=>U(ie,this.options));se&&(q=q.filter(ie=>(o("loose invalid filter",ie,this.options),!!ie.match(d[c.COMPARATORLOOSE])))),o("range list",q);const W=new Map,ee=q.map(ie=>new a(ie,this.options));for(const ie of ee){if(A(ie))return[ie];W.set(ie.value,ie)}W.size>1&&W.has("")&&W.delete("");const ce=[...W.values()];return r.set(G,ce),ce}intersects(V,B){if(!(V instanceof e))throw new TypeError("a Range is required");return this.set.some(G=>C(G,B)&&V.set.some(Z=>C(Z,B)&&G.every(se=>Z.every(le=>se.intersects(le,B)))))}test(V){if(!V)return!1;if(typeof V=="string")try{V=new u(V,this.options)}catch{return!1}for(let B=0;B<this.set.length;B++)if(K(this.set[B],V,this.options))return!0;return!1}}yy=e;const n=l6(),r=new n,s=Av(),a=Rp(),o=Cp(),u=$n(),{safeRe:d,t:c,comparatorTrimReplace:p,tildeTrimReplace:m,caretTrimReplace:y}=mc(),{FLAG_INCLUDE_PRERELEASE:w,FLAG_LOOSE:x}=Ep(),A=j=>j.value==="<0.0.0-0",E=j=>j.value==="",C=(j,V)=>{let B=!0;const G=j.slice();let Z=G.pop();for(;B&&G.length;)B=G.every(se=>Z.intersects(se,V)),Z=G.pop();return B},D=(j,V)=>(j=j.replace(d[c.BUILD],""),o("comp",j,V),j=M(j,V),o("caret",j),j=T(j,V),o("tildes",j),j=P(j,V),o("xrange",j),j=$(j,V),o("stars",j),j),O=j=>!j||j.toLowerCase()==="x"||j==="*",T=(j,V)=>j.trim().split(/\s+/).map(B=>I(B,V)).join(" "),I=(j,V)=>{const B=V.loose?d[c.TILDELOOSE]:d[c.TILDE];return j.replace(B,(G,Z,se,le,q)=>{o("tilde",j,G,Z,se,le,q);let W;return O(Z)?W="":O(se)?W=`>=${Z}.0.0 <${+Z+1}.0.0-0`:O(le)?W=`>=${Z}.${se}.0 <${Z}.${+se+1}.0-0`:q?(o("replaceTilde pr",q),W=`>=${Z}.${se}.${le}-${q} <${Z}.${+se+1}.0-0`):W=`>=${Z}.${se}.${le} <${Z}.${+se+1}.0-0`,o("tilde return",W),W})},M=(j,V)=>j.trim().split(/\s+/).map(B=>N(B,V)).join(" "),N=(j,V)=>{o("caret",j,V);const B=V.loose?d[c.CARETLOOSE]:d[c.CARET],G=V.includePrerelease?"-0":"";return j.replace(B,(Z,se,le,q,W)=>{o("caret",j,Z,se,le,q,W);let ee;return O(se)?ee="":O(le)?ee=`>=${se}.0.0${G} <${+se+1}.0.0-0`:O(q)?se==="0"?ee=`>=${se}.${le}.0${G} <${se}.${+le+1}.0-0`:ee=`>=${se}.${le}.0${G} <${+se+1}.0.0-0`:W?(o("replaceCaret pr",W),se==="0"?le==="0"?ee=`>=${se}.${le}.${q}-${W} <${se}.${le}.${+q+1}-0`:ee=`>=${se}.${le}.${q}-${W} <${se}.${+le+1}.0-0`:ee=`>=${se}.${le}.${q}-${W} <${+se+1}.0.0-0`):(o("no pr"),se==="0"?le==="0"?ee=`>=${se}.${le}.${q}${G} <${se}.${le}.${+q+1}-0`:ee=`>=${se}.${le}.${q}${G} <${se}.${+le+1}.0-0`:ee=`>=${se}.${le}.${q} <${+se+1}.0.0-0`),o("caret return",ee),ee})},P=(j,V)=>(o("replaceXRanges",j,V),j.split(/\s+/).map(B=>k(B,V)).join(" ")),k=(j,V)=>{j=j.trim();const B=V.loose?d[c.XRANGELOOSE]:d[c.XRANGE];return j.replace(B,(G,Z,se,le,q,W)=>{o("xRange",j,G,Z,se,le,q,W);const ee=O(se),ce=ee||O(le),ie=ce||O(q),fe=ie;return Z==="="&&fe&&(Z=""),W=V.includePrerelease?"-0":"",ee?Z===">"||Z==="<"?G="<0.0.0-0":G="*":Z&&fe?(ce&&(le=0),q=0,Z===">"?(Z=">=",ce?(se=+se+1,le=0,q=0):(le=+le+1,q=0)):Z==="<="&&(Z="<",ce?se=+se+1:le=+le+1),Z==="<"&&(W="-0"),G=`${Z+se}.${le}.${q}${W}`):ce?G=`>=${se}.0.0${W} <${+se+1}.0.0-0`:ie&&(G=`>=${se}.${le}.0${W} <${se}.${+le+1}.0-0`),o("xRange return",G),G})},$=(j,V)=>(o("replaceStars",j,V),j.trim().replace(d[c.STAR],"")),U=(j,V)=>(o("replaceGTE0",j,V),j.trim().replace(d[V.includePrerelease?c.GTE0PRE:c.GTE0],"")),F=j=>(V,B,G,Z,se,le,q,W,ee,ce,ie,fe)=>(O(G)?B="":O(Z)?B=`>=${G}.0.0${j?"-0":""}`:O(se)?B=`>=${G}.${Z}.0${j?"-0":""}`:le?B=`>=${B}`:B=`>=${B}${j?"-0":""}`,O(ee)?W="":O(ce)?W=`<${+ee+1}.0.0-0`:O(ie)?W=`<${ee}.${+ce+1}.0-0`:fe?W=`<=${ee}.${ce}.${ie}-${fe}`:j?W=`<${ee}.${ce}.${+ie+1}-0`:W=`<=${W}`,`${B} ${W}`.trim()),K=(j,V,B)=>{for(let G=0;G<j.length;G++)if(!j[G].test(V))return!1;if(V.prerelease.length&&!B.includePrerelease){for(let G=0;G<j.length;G++)if(o(j[G].semver),j[G].semver!==a.ANY&&j[G].semver.prerelease.length>0){const Z=j[G].semver;if(Z.major===V.major&&Z.minor===V.minor&&Z.patch===V.patch)return!0}return!1}return!0};return yy}var _y,dI;function Rp(){if(dI)return _y;dI=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(p,m){if(m=n(m),p instanceof e){if(p.loose===!!m.loose)return p;p=p.value}p=p.trim().split(/\s+/).join(" "),o("comparator",p,m),this.options=m,this.loose=!!m.loose,this.parse(p),this.semver===t?this.value="":this.value=this.operator+this.semver.version,o("comp",this)}parse(p){const m=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],y=p.match(m);if(!y)throw new TypeError(`Invalid comparator: ${p}`);this.operator=y[1]!==void 0?y[1]:"",this.operator==="="&&(this.operator=""),y[2]?this.semver=new u(y[2],this.options.loose):this.semver=t}toString(){return this.value}test(p){if(o("Comparator.test",p,this.options.loose),this.semver===t||p===t)return!0;if(typeof p=="string")try{p=new u(p,this.options)}catch{return!1}return a(p,this.operator,this.semver,this.options)}intersects(p,m){if(!(p instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new d(p.value,m).test(this.value):p.operator===""?p.value===""?!0:new d(this.value,m).test(p.semver):(m=n(m),m.includePrerelease&&(this.value==="<0.0.0-0"||p.value==="<0.0.0-0")||!m.includePrerelease&&(this.value.startsWith("<0.0.0")||p.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&p.operator.startsWith(">")||this.operator.startsWith("<")&&p.operator.startsWith("<")||this.semver.version===p.semver.version&&this.operator.includes("=")&&p.operator.includes("=")||a(this.semver,"<",p.semver,m)&&this.operator.startsWith(">")&&p.operator.startsWith("<")||a(this.semver,">",p.semver,m)&&this.operator.startsWith("<")&&p.operator.startsWith(">")))}}_y=e;const n=Av(),{safeRe:r,t:s}=mc(),a=lM(),o=Cp(),u=$n(),d=Vr();return _y}var vy,fI;function Np(){if(fI)return vy;fI=1;const t=Vr();return vy=(n,r,s)=>{try{r=new t(r,s)}catch{return!1}return r.test(n)},vy}var wy,pI;function u6(){if(pI)return wy;pI=1;const t=Vr();return wy=(n,r)=>new t(n,r).set.map(s=>s.map(a=>a.value).join(" ").trim().split(" ")),wy}var by,hI;function c6(){if(hI)return by;hI=1;const t=$n(),e=Vr();return by=(r,s,a)=>{let o=null,u=null,d=null;try{d=new e(s,a)}catch{return null}return r.forEach(c=>{d.test(c)&&(!o||u.compare(c)===-1)&&(o=c,u=new t(o,a))}),o},by}var Sy,mI;function d6(){if(mI)return Sy;mI=1;const t=$n(),e=Vr();return Sy=(r,s,a)=>{let o=null,u=null,d=null;try{d=new e(s,a)}catch{return null}return r.forEach(c=>{d.test(c)&&(!o||u.compare(c)===1)&&(o=c,u=new t(o,a))}),o},Sy}var xy,gI;function f6(){if(gI)return xy;gI=1;const t=$n(),e=Vr(),n=Ip();return xy=(s,a)=>{s=new e(s,a);let o=new t("0.0.0");if(s.test(o)||(o=new t("0.0.0-0"),s.test(o)))return o;o=null;for(let u=0;u<s.set.length;++u){const d=s.set[u];let c=null;d.forEach(p=>{const m=new t(p.semver.version);switch(p.operator){case">":m.prerelease.length===0?m.patch++:m.prerelease.push(0),m.raw=m.format();case"":case">=":(!c||n(m,c))&&(c=m);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${p.operator}`)}}),c&&(!o||n(o,c))&&(o=c)}return o&&s.test(o)?o:null},xy}var Ty,yI;function p6(){if(yI)return Ty;yI=1;const t=Vr();return Ty=(n,r)=>{try{return new t(n,r).range||"*"}catch{return null}},Ty}var Ay,_I;function Nv(){if(_I)return Ay;_I=1;const t=$n(),e=Rp(),{ANY:n}=e,r=Vr(),s=Np(),a=Ip(),o=Cv(),u=Rv(),d=Iv();return Ay=(p,m,y,w)=>{p=new t(p,w),m=new r(m,w);let x,A,E,C,D;switch(y){case">":x=a,A=u,E=o,C=">",D=">=";break;case"<":x=o,A=d,E=a,C="<",D="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(p,m,w))return!1;for(let O=0;O<m.set.length;++O){const T=m.set[O];let I=null,M=null;if(T.forEach(N=>{N.semver===n&&(N=new e(">=0.0.0")),I=I||N,M=M||N,x(N.semver,I.semver,w)?I=N:E(N.semver,M.semver,w)&&(M=N)}),I.operator===C||I.operator===D||(!M.operator||M.operator===C)&&A(p,M.semver))return!1;if(M.operator===D&&E(p,M.semver))return!1}return!0},Ay}var Ey,vI;function h6(){if(vI)return Ey;vI=1;const t=Nv();return Ey=(n,r,s)=>t(n,r,">",s),Ey}var Cy,wI;function m6(){if(wI)return Cy;wI=1;const t=Nv();return Cy=(n,r,s)=>t(n,r,"<",s),Cy}var Iy,bI;function g6(){if(bI)return Iy;bI=1;const t=Vr();return Iy=(n,r,s)=>(n=new t(n,s),r=new t(r,s),n.intersects(r,s)),Iy}var Ry,SI;function y6(){if(SI)return Ry;SI=1;const t=Np(),e=jr();return Ry=(n,r,s)=>{const a=[];let o=null,u=null;const d=n.sort((y,w)=>e(y,w,s));for(const y of d)t(y,r,s)?(u=y,o||(o=y)):(u&&a.push([o,u]),u=null,o=null);o&&a.push([o,null]);const c=[];for(const[y,w]of a)y===w?c.push(y):!w&&y===d[0]?c.push("*"):w?y===d[0]?c.push(`<=${w}`):c.push(`${y} - ${w}`):c.push(`>=${y}`);const p=c.join(" || "),m=typeof r.raw=="string"?r.raw:String(r);return p.length<m.length?p:r},Ry}var Ny,xI;function _6(){if(xI)return Ny;xI=1;const t=Vr(),e=Rp(),{ANY:n}=e,r=Np(),s=jr(),a=(m,y,w={})=>{if(m===y)return!0;m=new t(m,w),y=new t(y,w);let x=!1;e:for(const A of m.set){for(const E of y.set){const C=d(A,E,w);if(x=x||C!==null,C)continue e}if(x)return!1}return!0},o=[new e(">=0.0.0-0")],u=[new e(">=0.0.0")],d=(m,y,w)=>{if(m===y)return!0;if(m.length===1&&m[0].semver===n){if(y.length===1&&y[0].semver===n)return!0;w.includePrerelease?m=o:m=u}if(y.length===1&&y[0].semver===n){if(w.includePrerelease)return!0;y=u}const x=new Set;let A,E;for(const P of m)P.operator===">"||P.operator===">="?A=c(A,P,w):P.operator==="<"||P.operator==="<="?E=p(E,P,w):x.add(P.semver);if(x.size>1)return null;let C;if(A&&E){if(C=s(A.semver,E.semver,w),C>0)return null;if(C===0&&(A.operator!==">="||E.operator!=="<="))return null}for(const P of x){if(A&&!r(P,String(A),w)||E&&!r(P,String(E),w))return null;for(const k of y)if(!r(P,String(k),w))return!1;return!0}let D,O,T,I,M=E&&!w.includePrerelease&&E.semver.prerelease.length?E.semver:!1,N=A&&!w.includePrerelease&&A.semver.prerelease.length?A.semver:!1;M&&M.prerelease.length===1&&E.operator==="<"&&M.prerelease[0]===0&&(M=!1);for(const P of y){if(I=I||P.operator===">"||P.operator===">=",T=T||P.operator==="<"||P.operator==="<=",A){if(N&&P.semver.prerelease&&P.semver.prerelease.length&&P.semver.major===N.major&&P.semver.minor===N.minor&&P.semver.patch===N.patch&&(N=!1),P.operator===">"||P.operator===">="){if(D=c(A,P,w),D===P&&D!==A)return!1}else if(A.operator===">="&&!r(A.semver,String(P),w))return!1}if(E){if(M&&P.semver.prerelease&&P.semver.prerelease.length&&P.semver.major===M.major&&P.semver.minor===M.minor&&P.semver.patch===M.patch&&(M=!1),P.operator==="<"||P.operator==="<="){if(O=p(E,P,w),O===P&&O!==E)return!1}else if(E.operator==="<="&&!r(E.semver,String(P),w))return!1}if(!P.operator&&(E||A)&&C!==0)return!1}return!(A&&T&&!E&&C!==0||E&&I&&!A&&C!==0||N||M)},c=(m,y,w)=>{if(!m)return y;const x=s(m.semver,y.semver,w);return x>0?m:x<0||y.operator===">"&&m.operator===">="?y:m},p=(m,y,w)=>{if(!m)return y;const x=s(m.semver,y.semver,w);return x<0?m:x>0||y.operator==="<"&&m.operator==="<="?y:m};return Ny=a,Ny}var Py,TI;function v6(){if(TI)return Py;TI=1;const t=mc(),e=Ep(),n=$n(),r=aM(),s=pl(),a=KV(),o=WV(),u=ZV(),d=XV(),c=QV(),p=e6(),m=t6(),y=n6(),w=jr(),x=r6(),A=s6(),E=Ev(),C=a6(),D=i6(),O=Ip(),T=Cv(),I=iM(),M=oM(),N=Iv(),P=Rv(),k=lM(),$=o6(),U=Rp(),F=Vr(),K=Np(),j=u6(),V=c6(),B=d6(),G=f6(),Z=p6(),se=Nv(),le=h6(),q=m6(),W=g6(),ee=y6(),ce=_6();return Py={parse:s,valid:a,clean:o,inc:u,diff:d,major:c,minor:p,patch:m,prerelease:y,compare:w,rcompare:x,compareLoose:A,compareBuild:E,sort:C,rsort:D,gt:O,lt:T,eq:I,neq:M,gte:N,lte:P,cmp:k,coerce:$,Comparator:U,Range:F,satisfies:K,toComparators:j,maxSatisfying:V,minSatisfying:B,minVersion:G,validRange:Z,outside:se,gtr:le,ltr:q,intersects:W,simplifyRange:ee,subset:ce,SemVer:n,re:t.re,src:t.src,tokens:t.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:r.compareIdentifiers,rcompareIdentifiers:r.rcompareIdentifiers},Py}v6();function Ia(t){if(!t||t.split("/").length>2||t.startsWith("/")||t.endsWith("/")||t.split(":").length>2)throw new Error(`Invalid identifier format: ${t}`);const[e,n]=t.split(":"),r=n||"latest";if(e.includes("/")){const[s,a]=e.split("/",2);if(!s||!a)throw new Error(`Invalid identifier format: ${t}`);return[s,a,r]}else{if(!e)throw new Error(`Invalid identifier format: ${t}`);return["-",e,r]}}class w6 extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function Le(t,e,n){let r;if(t.ok){n&&(r=await t.text());return}if(t.status===403)try{const o=await t.json();(o==null?void 0:o.error)==="org_scoped_key_requires_workspace"&&(r="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const u=new Error(`${t.status} ${t.statusText}`);throw u.status=t==null?void 0:t.status,u}if(r===void 0)try{r=await t.text()}catch{r=""}const s=`Failed to ${e}. Received status [${t.status}]: ${t.statusText}. Message: ${r}`;if(t.status===409)throw new w6(s);const a=new Error(s);throw a.status=t.status,a}const uM="ERR_CONFLICTING_ENDPOINTS";class b6 extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:uM}),this.name="ConflictingEndpointsError"}}function S6(t){return typeof t=="object"&&t!==null&&t.code===uM}var AI="[...]",x6={result:"[Circular]"},Vf=[],Fo=[];const T6=new TextEncoder;function A6(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function tf(t){return T6.encode(t)}function cM(t){if(t&&typeof t=="object"&&t!==null){if(t instanceof Map)return Object.fromEntries(t);if(t instanceof Set)return Array.from(t);if(t instanceof Date)return t.toISOString();if(t instanceof RegExp)return t.toString();if(t instanceof Error)return{name:t.name,message:t.message}}else if(typeof t=="bigint")return t.toString();return t}function E6(t){return function(e,n){return cM(n)}}function sr(t,e,n,r,s){var a;try{const o=JSON.stringify(t,E6(n),r);return tf(o)}catch(o){if(!((a=o.message)!=null&&a.includes("Converting circular structure to JSON")))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),tf("[Unserializable]");Jn("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=A6()),Y_(t,"",0,[],void 0,0,s);let u;try{Fo.length===0?u=JSON.stringify(t,n,r):u=JSON.stringify(t,C6(n),r)}catch{return tf("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Vf.length!==0;){const d=Vf.pop();d.length===4?Object.defineProperty(d[0],d[1],d[3]):d[0][d[1]]=d[2]}}return tf(u)}}function My(t,e,n,r){var s=Object.getOwnPropertyDescriptor(r,n);s.get!==void 0?s.configurable?(Object.defineProperty(r,n,{value:t}),Vf.push([r,n,e,s])):Fo.push([e,n,t]):(r[n]=t,Vf.push([r,n,e]))}function Y_(t,e,n,r,s,a,o){a+=1;var u;if(typeof t=="object"&&t!==null){for(u=0;u<r.length;u++)if(r[u]===t){My(x6,t,e,s);return}if(typeof o.depthLimit<"u"&&a>o.depthLimit){My(AI,t,e,s);return}if(typeof o.edgesLimit<"u"&&n+1>o.edgesLimit){My(AI,t,e,s);return}if(r.push(t),Array.isArray(t))for(u=0;u<t.length;u++)Y_(t[u],u,u,r,t,a,o);else{t=cM(t);var d=Object.keys(t);for(u=0;u<d.length;u++){var c=d[u];Y_(t[c],c,u,r,t,a,o)}}r.pop()}}function C6(t){return t=typeof t<"u"?t:function(e,n){return n},function(e,n){if(Fo.length>0)for(var r=0;r<Fo.length;r++){var s=Fo[r];if(s[1]===e&&s[0]===n){n=s[2],Fo.splice(r,1);break}}return t.call(this,e,n)}}function EI(t,e){const n=tM(),r=e??nM(),s=t.extra??{},a=s.metadata;return t.extra={...s,runtime:{...n,...s==null?void 0:s.runtime},metadata:{...r,...r.revision_id||"revision_id"in t&&t.revision_id?{revision_id:("revision_id"in t?t.revision_id:void 0)??r.revision_id}:{},...a}},t}const I6=t=>{const e=(t==null?void 0:t.toString())??Jn("TRACING_SAMPLING_RATE");if(e===void 0)return;const n=parseFloat(e);if(n<0||n>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${n}`);return n},R6=t=>{const n=t.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return n==="localhost"||n==="127.0.0.1"||n==="::1"};async function N6(t){const e=[];for await(const n of t)e.push(n);return e}function nf(t){if(t!==void 0)return t.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const P6=async t=>{if((t==null?void 0:t.status)===429){const e=parseInt(t.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(n=>setTimeout(n,e)),!0}return!1};function CI(t){return typeof t=="number"?Number(t.toFixed(4)):t}class M6{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let n;const r=new Promise(a=>{n=a}),s=sr(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:n,itemPromise:r,size:s}),this.sizeBytes+=s,r}pop({upToSizeBytes:e,upToSize:n}){var a;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const r=[];let s=0;for(;s+(((a=this.peek())==null?void 0:a.size)??0)<e&&this.items.length>0&&r.length<n;){const o=this.items.shift();o&&(r.push(o),s+=o.size,this.sizeBytes-=o.size)}if(r.length===0&&this.items.length>0){const o=this.items.shift();r.push(o),s+=o.size,this.sizeBytes-=o.size}return[r.map(o=>({action:o.action,item:o.payload,otelContext:o.otelContext,apiKey:o.apiKey,apiUrl:o.apiUrl})),()=>r.forEach(o=>o.itemPromiseResolve())]}}const k6=24*1024*1024,O6=1e4,D6=100,II="https://api.smith.langchain.com";class Yu{get _fetch(){return this.fetchImplementation||yV(this.debug)}constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new M6}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:us("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:us("LANGSMITH_DEBUG")==="true"});const n=Yu.getDefaultClientConfig();if(this.tracingSampleRate=I6(e.tracingSamplingRate),this.apiUrl=nf(e.apiUrl??n.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=nf(e.apiKey??n.apiKey),this.webUrl=nf(e.webUrl??n.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=nf(e.workspaceId??Jn("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new NC({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new NC({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:P6,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??n.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??n.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,rM()&&(this.langSmithToOTELTranslator=new OV),this.cachedLSEnvVarsForMetadata=nM()}static getDefaultClientConfig(){const e=Jn("API_KEY"),n=Jn("ENDPOINT")??II,r=Jn("HIDE_INPUTS")==="true",s=Jn("HIDE_OUTPUTS")==="true";return{apiUrl:n,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:R6(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${XP}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const n={...e};return n.inputs!==void 0&&(n.inputs=await this.processInputs(n.inputs)),n.outputs!==void 0&&(n.outputs=await this.processOutputs(n.outputs)),n}async _getResponse(e,n){const r=(n==null?void 0:n.toString())??"",s=`${this.apiUrl}${e}?${r}`;return await this.caller.call(async()=>{const o=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(o,`fetch ${e}`),o})}async _get(e,n){return(await this._getResponse(e,n)).json()}async*_getPaginated(e,n=new URLSearchParams,r){let s=Number(n.get("offset"))||0;const a=Number(n.get("limit"))||100;for(;;){n.set("offset",String(s)),n.set("limit",String(a));const o=`${this.apiUrl}${e}?${n}`,u=await this.caller.call(async()=>{const c=await this._fetch(o,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(c,`fetch ${e}`),c}),d=r?r(await u.json()):await u.json();if(d.length===0||(yield d,d.length<a))break;s+=d.length}}async*_getCursorPaginatedList(e,n=null,r="POST",s="runs"){const a=n?{...n}:{};for(;;){const o=JSON.stringify(a),d=await(await this.caller.call(async()=>{const p=await this._fetch(`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(p,`fetch ${e}`),p})).json();if(!d||!d[s])break;yield d[s];const c=d.cursors;if(!c||!c.next)break;a.cursor=c.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,n=!1){if(this.tracingSampleRate===void 0)return e;if(n){const r=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):r.push(s);return r}else{const r=[];for(const s of e){const a=s.trace_id??s.id;this.filteredPostUuids.has(a)||(s.id===a?this._shouldSample()?r.push(s):this.filteredPostUuids.add(a):r.push(s))}return r}}async _getBatchSizeLimitBytes(){var n;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((n=e.batch_ingest_config)==null?void 0:n.size_limit_bytes)??k6}async _getBatchSizeLimit(){var n;const e=await this._ensureServerInfo();return this.batchSizeLimit??((n=e.batch_ingest_config)==null?void 0:n.size_limit)??D6}async _getDatasetExamplesMultiPartSupport(){var n;return((n=(await this._ensureServerInfo()).instance_flags)==null?void 0:n.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:n}){const r=[];for(;this.autoBatchQueue.items.length>0;){const[s,a]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:n});if(!s.length){a();break}const o=s.reduce((c,p)=>{const m=p.apiUrl??this.apiUrl,y=p.apiKey??this.apiKey,x=p.apiKey===this.apiKey&&p.apiUrl===this.apiUrl?"default":`${m}|${y}`;return c[x]||(c[x]=[]),c[x].push(p),c},{}),u=[];for(const[c,p]of Object.entries(o)){const m=this._processBatch(p,{apiUrl:c==="default"?void 0:c.split("|")[0],apiKey:c==="default"?void 0:c.split("|")[1]});u.push(m)}const d=Promise.all(u).finally(a);r.push(d)}return Promise.all(r)}async _processBatch(e,n){var r,s;if(e.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const a={runCreates:e.filter(u=>u.action==="create").map(u=>u.item),runUpdates:e.filter(u=>u.action==="update").map(u=>u.item)},o=await this._ensureServerInfo();if((r=o==null?void 0:o.batch_ingest_config)!=null&&r.use_multipart_endpoint){const u=(s=o==null?void 0:o.instance_flags)==null?void 0:s.gzip_body_enabled;await this.multipartIngestRuns(a,{...n,useGzip:u})}else await this.batchIngestRuns(a,n)}}catch(a){console.error("Error exporting batch:",a)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const n=new Map,r=[];for(const s of e)s.item.id&&s.otelContext&&(n.set(s.item.id,s.otelContext),s.action==="create"?r.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):r.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(r,n)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=EI(e.item,this.cachedLSEnvVarsForMetadata);const n=this.autoBatchQueue.push(e);if(this.manualFlushMode)return n;const r=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>r||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),n}async _getServerInfo(){const n=await(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(O6),...this.fetchOptions});return await Le(r,"get server info"),r})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(n,null,2)+`
`),n}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),n=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:n})}_cloneCurrentOTELContext(){const e=sM(),n=NV();if(this.langSmithToOTELTranslator!==void 0){const r=e.getActiveSpan();if(r)return e.setSpan(n.active(),r)}}async createRun(e,n){if(!this._filterForSampling([e]).length)return;const r={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const a=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){const d=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:a,otelContext:d,apiKey:n==null?void 0:n.apiKey,apiUrl:n==null?void 0:n.apiUrl}).catch(console.error);return}const o=EI(a,this.cachedLSEnvVarsForMetadata);(n==null?void 0:n.apiKey)!==void 0&&(r["x-api-key"]=n.apiKey),(n==null?void 0:n.workspaceId)!==void 0&&(r["x-tenant-id"]=n.workspaceId);const u=sr(o,`Creating run with id: ${o.id}`);await this.caller.call(async()=>{const d=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Le(d,"create run",!0),d})}async batchIngestRuns({runCreates:e,runUpdates:n},r){if(e===void 0&&n===void 0)return;let s=await Promise.all((e==null?void 0:e.map(d=>this.prepareRunCreateOrUpdateInputs(d)))??[]),a=await Promise.all((n==null?void 0:n.map(d=>this.prepareRunCreateOrUpdateInputs(d)))??[]);if(s.length>0&&a.length>0){const d=s.reduce((p,m)=>(m.id&&(p[m.id]=m),p),{}),c=[];for(const p of a)p.id!==void 0&&d[p.id]?d[p.id]={...d[p.id],...p}:c.push(p);s=Object.values(d),a=c}const o={post:s,patch:a};if(!o.post.length&&!o.patch.length)return;const u={post:[],patch:[]};for(const d of["post","patch"]){const c=d,p=o[c].reverse();let m=p.pop();for(;m!==void 0;)u[c].push(m),m=p.pop()}if(u.post.length>0||u.patch.length>0){const d=u.post.map(c=>c.id).concat(u.patch.map(c=>c.id)).join(",");await this._postBatchIngestRuns(sr(u,`Ingesting runs with ids: ${d}`),r)}}async _postBatchIngestRuns(e,n){const r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};(n==null?void 0:n.apiKey)!==void 0&&(r["x-api-key"]=n.apiKey),await this.batchIngestCaller.call(async()=>{const s=await this._fetch(`${(n==null?void 0:n.apiUrl)??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await Le(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:n},r){if(e===void 0&&n===void 0)return;const s={};let a=[];for(const m of e??[]){const y=await this.prepareRunCreateOrUpdateInputs(m);y.id!==void 0&&y.attachments!==void 0&&(s[y.id]=y.attachments),delete y.attachments,a.push(y)}let o=[];for(const m of n??[])o.push(await this.prepareRunCreateOrUpdateInputs(m));if(a.find(m=>m.trace_id===void 0||m.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(o.find(m=>m.trace_id===void 0||m.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&o.length>0){const m=a.reduce((w,x)=>(x.id&&(w[x.id]=x),w),{}),y=[];for(const w of o)w.id!==void 0&&m[w.id]?m[w.id]={...m[w.id],...w}:y.push(w);a=Object.values(m),o=y}if(a.length===0&&o.length===0)return;const c=[],p=[];for(const[m,y]of[["post",a],["patch",o]])for(const w of y){const{inputs:x,outputs:A,events:E,extra:C,error:D,serialized:O,attachments:T,...I}=w,M={inputs:x,outputs:A,events:E,extra:C,error:D,serialized:O},N=sr(I,`Serializing for multipart ingestion of run with id: ${I.id}`);p.push({name:`${m}.${I.id}`,payload:new Blob([N],{type:`application/json; length=${N.length}`})});for(const[P,k]of Object.entries(M)){if(k===void 0)continue;const $=sr(k,`Serializing ${P} for multipart ingestion of run with id: ${I.id}`);p.push({name:`${m}.${I.id}.${P}`,payload:new Blob([$],{type:`application/json; length=${$.length}`})})}if(I.id!==void 0){const P=s[I.id];if(P){delete s[I.id];for(const[k,$]of Object.entries(P)){let U,F;if(Array.isArray($)?[U,F]=$:(U=$.mimeType,F=$.data),k.includes(".")){console.warn(`Skipping attachment '${k}' for run ${I.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}p.push({name:`attachment.${I.id}.${k}`,payload:new Blob([F],{type:`${U}; length=${F.byteLength}`})})}}}c.push(`trace=${I.trace_id},id=${I.id}`)}await this._sendMultipartRequest(p,c.join("; "),r)}async _createNodeFetchBody(e,n){const r=[];for(const o of e)r.push(new Blob([`--${n}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${o.name}"\r
`,`Content-Type: ${o.payload.type}\r
\r
`])),r.push(o.payload),r.push(new Blob([`\r
`]));return r.push(new Blob([`--${n}--\r
`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(e,n){const r=new TextEncoder;return new ReadableStream({async start(a){const o=async u=>{typeof u=="string"?a.enqueue(r.encode(u)):a.enqueue(u)};for(const u of e){await o(`--${n}\r
`),await o(`Content-Disposition: form-data; name="${u.name}"\r
`),await o(`Content-Type: ${u.payload.type}\r
\r
`);const c=u.payload.stream().getReader();try{let p;for(;!(p=await c.read()).done;)a.enqueue(p.value)}finally{c.releaseLock()}await o(`\r
`)}await o(`--${n}--\r
`),a.close()}})}async _sendMultipartRequest(e,n,r){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=gV(),o=()=>this._createNodeFetchBody(e,s),u=()=>this._createMultipartStream(e,s),d=async c=>this.batchIngestCaller.call(async()=>{const p=await c(),m={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};(r==null?void 0:r.apiKey)!==void 0&&(m["x-api-key"]=r.apiKey);let y=p;r!=null&&r.useGzip&&typeof p=="object"&&"pipeThrough"in p&&(y=p.pipeThrough(new CompressionStream("gzip")),m["Content-Encoding"]="gzip");const w=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart`,{method:"POST",headers:m,body:y,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(w,"Failed to send multipart request",!0),w});try{let c,p=!1;!a&&!this.multipartStreamingDisabled&&eM()!=="bun"?(p=!0,c=await d(u)):c=await d(o),(!this.multipartStreamingDisabled||p)&&c.status===422&&((r==null?void 0:r.apiUrl)??this.apiUrl)!==II&&(console.warn(`Streaming multipart upload to ${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${n}".`),this.multipartStreamingDisabled=!0,c=await d(o))}catch(c){console.warn(`${c.message.trim()}

Context: ${n}`)}}async updateRun(e,n,r){Xe(e),n.inputs&&(n.inputs=await this.processInputs(n.inputs)),n.outputs&&(n.outputs=await this.processOutputs(n.outputs));const s={...n,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const u=this._cloneCurrentOTELContext();if(n.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:u,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:u,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"};(r==null?void 0:r.apiKey)!==void 0&&(a["x-api-key"]=r.apiKey),(r==null?void 0:r.workspaceId)!==void 0&&(a["x-tenant-id"]=r.workspaceId);const o=sr(n,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const u=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(u,"update run",!0),u})}async readRun(e,{loadChildRuns:n}={loadChildRuns:!1}){Xe(e);let r=await this._get(`/runs/${e}`);return n&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:n,projectOpts:r}){if(n!==void 0){let s;n.session_id?s=n.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:Jn("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${s}/r/${n.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){var a;const n=await N6(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},s={};n.sort((o,u)=>((o==null?void 0:o.dotted_order)??"").localeCompare((u==null?void 0:u.dotted_order)??""));for(const o of n){if(o.parent_run_id===null||o.parent_run_id===void 0)throw new Error(`Child run ${o.id} has no parent`);(a=o.dotted_order)!=null&&a.startsWith(e.dotted_order??"")&&o.id!==e.id&&(o.parent_run_id in r||(r[o.parent_run_id]=[]),r[o.parent_run_id].push(o),s[o.id]=o)}e.child_runs=r[e.id]||[];for(const o in r)o!==e.id&&(s[o].child_runs=r[o]);return e}async*listRuns(e){const{projectId:n,projectName:r,parentRunId:s,traceId:a,referenceExampleId:o,startTime:u,executionOrder:d,isRoot:c,runType:p,error:m,id:y,query:w,filter:x,traceFilter:A,treeFilter:E,limit:C,select:D,order:O}=e;let T=[];if(n&&(T=Array.isArray(n)?n:[n]),r){const P=Array.isArray(r)?r:[r],k=await Promise.all(P.map($=>this.readProject({projectName:$}).then(U=>U.id)));T.push(...k)}const I=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],M={session:T.length?T:null,run_type:p,reference_example:o,query:w,filter:x,trace_filter:A,tree_filter:E,execution_order:d,parent_run:s,start_time:u?u.toISOString():null,error:m,id:y,limit:C,trace:a,select:D||I,is_root:c,order:O};M.select.includes("child_run_ids")&&J_("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let N=0;for await(const P of this._getCursorPaginatedList("/runs/query",M))if(C){if(N>=C)break;if(P.length+N>C){yield*P.slice(0,C-N);break}N+=P.length,yield*P}else yield*P}async*listGroupRuns(e){const{projectId:n,projectName:r,groupBy:s,filter:a,startTime:o,endTime:u,limit:d,offset:c}=e,m={session_id:n||(await this.readProject({projectName:r})).id,group_by:s,filter:a,start_time:o?o.toISOString():null,end_time:u?u.toISOString():null,limit:Number(d)||100};let y=Number(c)||0;const w="/runs/group",x=`${this.apiUrl}${w}`;for(;;){const A={...m,offset:y},E=Object.fromEntries(Object.entries(A).filter(([M,N])=>N!==void 0)),C=JSON.stringify(E),O=await(await this.caller.call(async()=>{const M=await this._fetch(x,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:C});return await Le(M,`Failed to fetch ${w}`),M})).json(),{groups:T,total:I}=O;if(T.length===0)break;for(const M of T)yield M;if(y+=T.length,y>=I)break}}async getRunStats({id:e,trace:n,parentRun:r,runType:s,projectNames:a,projectIds:o,referenceExampleIds:u,startTime:d,endTime:c,error:p,query:m,filter:y,traceFilter:w,treeFilter:x,isRoot:A,dataSourceType:E}){let C=o||[];a&&(C=[...o||[],...await Promise.all(a.map(N=>this.readProject({projectName:N}).then(P=>P.id)))]);const O=Object.fromEntries(Object.entries({id:e,trace:n,parent_run:r,run_type:s,session:C,reference_example:u,start_time:d,end_time:c,error:p,query:m,filter:y,trace_filter:w,tree_filter:x,is_root:A,data_source_type:E}).filter(([N,P])=>P!==void 0)),T=JSON.stringify(O);return await(await this.caller.call(async()=>{const N=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:T});return await Le(N,"get run stats"),N})).json()}async shareRun(e,{shareId:n}={}){const r={run_id:e,share_token:n||Dn()};Xe(e);const s=JSON.stringify(r),o=await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Le(u,"share run"),u})).json();if(o===null||!("share_token"in o))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${o.share_token}/r`}async unshareRun(e){Xe(e),await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(n,"unshare run",!0),n})}async readRunSharedLink(e){Xe(e);const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(s,"read run shared link"),s})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:n}={}){const r=new URLSearchParams({share_token:e});if(n!==void 0)for(const o of n)r.append("id",o);return Xe(e),await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(o,"list shared runs"),o})).json()}async readDatasetSharedSchema(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id),Xe(e);const s=await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(a,"read dataset shared schema"),a})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,n){if(!e&&!n)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:n})).id);const r={dataset_id:e};Xe(e);const s=JSON.stringify(r),o=await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Le(u,"share dataset"),u})).json();return o.url=`${this.getHostUrl()}/public/${o.share_token}/d`,o}async unshareDataset(e){Xe(e),await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(n,"unshare dataset",!0),n})}async readSharedDataset(e){return Xe(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(s,"read shared dataset"),s})).json()}async listSharedExamples(e,n){const r={};n!=null&&n.exampleIds&&(r.id=n.exampleIds);const s=new URLSearchParams;Object.entries(r).forEach(([u,d])=>{Array.isArray(d)?d.forEach(c=>s.append(u,c)):s.append(u,d)});const a=await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(u,"list shared examples"),u}),o=await a.json();if(!a.ok)throw"detail"in o?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${Array.isArray(o.detail)?o.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return o.map(u=>({...u,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:n=null,metadata:r=null,upsert:s=!1,projectExtra:a=null,referenceDatasetId:o=null}){const u=s?"?upsert=true":"",d=`${this.apiUrl}/sessions${u}`,c=a||{};r&&(c.metadata=r);const p={name:e,extra:c,description:n};o!==null&&(p.reference_dataset_id=o);const m=JSON.stringify(p);return await(await this.caller.call(async()=>{const x=await this._fetch(d,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:m});return await Le(x,"create project"),x})).json()}async updateProject(e,{name:n=null,description:r=null,metadata:s=null,projectExtra:a=null,endTime:o=null}){const u=`${this.apiUrl}/sessions/${e}`;let d=a;s&&(d={...d||{},metadata:s});const c=JSON.stringify({name:n,extra:d,description:r,end_time:o?new Date(o).toISOString():null});return await(await this.caller.call(async()=>{const y=await this._fetch(u,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await Le(y,"update project"),y})).json()}async hasProject({projectId:e,projectName:n}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Xe(e),r+=`/${e}`;else if(n!==void 0)s.append("name",n);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(o,"has project"),o});try{const o=await a.json();return a.ok?Array.isArray(o)?o.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:n,includeStats:r}){let s="/sessions";const a=new URLSearchParams;if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Xe(e),s+=`/${e}`;else if(n!==void 0)a.append("name",n);else throw new Error("Must provide projectName or projectId");r!==void 0&&a.append("include_stats",r.toString());const o=await this._get(s,a);let u;if(Array.isArray(o)){if(o.length===0)throw new Error(`Project[id=${e}, name=${n}] not found`);u=o[0]}else u=o;return u}async getProjectUrl({projectId:e,projectName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:n}){if(e===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:n}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const n of this._getPaginated("/sessions",e))return this._tenantId=n[0].tenant_id,n[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:n,nameContains:r,referenceDatasetId:s,referenceDatasetName:a,includeStats:o,datasetVersion:u,referenceFree:d,metadata:c}={}){const p=new URLSearchParams;if(e!==void 0)for(const m of e)p.append("id",m);if(n!==void 0&&p.append("name",n),r!==void 0&&p.append("name_contains",r),s!==void 0)p.append("reference_dataset",s);else if(a!==void 0){const m=await this.readDataset({datasetName:a});p.append("reference_dataset",m.id)}o!==void 0&&p.append("include_stats",o.toString()),u!==void 0&&p.append("dataset_version",u),d!==void 0&&p.append("reference_free",d.toString()),c!==void 0&&p.append("metadata",JSON.stringify(c));for await(const m of this._getPaginated("/sessions",p))yield*m}async deleteProject({projectId:e,projectName:n}){let r;if(e===void 0&&n===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&n!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:n})).id:r=e,Xe(r),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(s,`delete session ${r} (${n})`,!0),s})}async uploadCsv({csvFile:e,fileName:n,inputKeys:r,outputKeys:s,description:a,dataType:o,name:u}){const d=`${this.apiUrl}/datasets/upload`,c=new FormData;return c.append("file",e,n),r.forEach(y=>{c.append("input_keys",y)}),s.forEach(y=>{c.append("output_keys",y)}),a&&c.append("description",a),o&&c.append("data_type",o),u&&c.append("name",u),await(await this.caller.call(async()=>{const y=await this._fetch(d,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await Le(y,"upload CSV"),y})).json()}async createDataset(e,{description:n,dataType:r,inputsSchema:s,outputsSchema:a,metadata:o}={}){const u={name:e,description:n,extra:o?{metadata:o}:void 0};r&&(u.data_type=r),s&&(u.inputs_schema_definition=s),a&&(u.outputs_schema_definition=a);const d=JSON.stringify(u);return await(await this.caller.call(async()=>{const m=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await Le(m,"create dataset"),m})).json()}async readDataset({datasetId:e,datasetName:n}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&n)throw new Error("Must provide either datasetName or datasetId, not both");if(e)Xe(e),r+=`/${e}`;else if(n)s.append("name",n);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(r,s);let o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${n}] not found`);o=a[0]}else o=a;return o}async hasDataset({datasetId:e,datasetName:n}){try{return await this.readDataset({datasetId:e,datasetName:n}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:n,fromVersion:r,toVersion:s}){let a=e;if(a===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:n})).id);const o=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,o)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:n}){const r="/datasets";if(e===void 0)if(n!==void 0)e=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(u=>JSON.parse(u))}async*listDatasets({limit:e=100,offset:n=0,datasetIds:r,datasetName:s,datasetNameContains:a,metadata:o}={}){const u="/datasets",d=new URLSearchParams({limit:e.toString(),offset:n.toString()});if(r!==void 0)for(const c of r)d.append("id",c);s!==void 0&&d.append("name",s),a!==void 0&&d.append("name_contains",a),o!==void 0&&d.append("metadata",JSON.stringify(o));for await(const c of this._getPaginated(u,d))yield*c}async updateDataset(e){const{datasetId:n,datasetName:r,...s}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const a=n??(await this.readDataset({datasetName:r})).id;Xe(a);const o=JSON.stringify(s);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(d,"update dataset"),d})).json()}async updateDatasetTag(e){const{datasetId:n,datasetName:r,asOf:s,tag:a}=e;if(!n&&!r)throw new Error("Must provide either datasetName or datasetId");const o=n??(await this.readDataset({datasetName:r})).id;Xe(o);const u=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:a});await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets/${o}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Le(d,"update dataset tags",!0),d})}async deleteDataset({datasetId:e,datasetName:n}){let r="/datasets",s=e;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(n!==void 0&&(s=(await this.readDataset({datasetName:n})).id),s!==void 0)Xe(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const a=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(a,`delete ${r}`,!0),a})}async indexDataset({datasetId:e,datasetName:n,tag:r}){let s=e;if(!s&&!n)throw new Error("Must provide either datasetName or datasetId");if(s&&n)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:n})).id),Xe(s);const o=JSON.stringify({tag:r});await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(d,"index dataset"),d})).json()}async similarExamples(e,n,r,{filter:s}={}){const a={limit:r,inputs:e};s!==void 0&&(a.filter=s),Xe(n);const o=JSON.stringify(a);return(await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${n}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:o});return await Le(c,"fetch similar examples"),c})).json()).examples}async createExample(e,n,r){var p;if(RI(e)&&(n!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=n?r==null?void 0:r.datasetId:e.dataset_id;const a=n?r==null?void 0:r.datasetName:e.dataset_name;if(s===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:a})).id);const o=(n?r==null?void 0:r.createdAt:e.created_at)||new Date;let u;RI(e)?u=e:u={inputs:e,outputs:n,created_at:o==null?void 0:o.toISOString(),id:r==null?void 0:r.exampleId,metadata:r==null?void 0:r.metadata,split:r==null?void 0:r.split,source_run_id:r==null?void 0:r.sourceRunId,use_source_run_io:r==null?void 0:r.useSourceRunIO,use_source_run_attachments:r==null?void 0:r.useSourceRunAttachments,attachments:r==null?void 0:r.attachments};const d=await this._uploadExamplesMultipart(s,[u]);return await this.readExample(((p=d.example_ids)==null?void 0:p[0])??Dn())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const D=e;let O=D[0].dataset_id;const T=D[0].dataset_name;if(O===void 0&&T===void 0)throw new Error("Must provide either datasetName or datasetId");if(O!==void 0&&T!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");O===void 0&&(O=(await this.readDataset({datasetName:T})).id);const I=await this._uploadExamplesMultipart(O,D);return await Promise.all(I.example_ids.map(N=>this.readExample(N)))}const{inputs:n,outputs:r,metadata:s,splits:a,sourceRunIds:o,useSourceRunIOs:u,useSourceRunAttachments:d,attachments:c,exampleIds:p,datasetId:m,datasetName:y}=e;if(n===void 0)throw new Error("Must provide inputs when using legacy parameters");let w=m;const x=y;if(w===void 0&&x===void 0)throw new Error("Must provide either datasetName or datasetId");if(w!==void 0&&x!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");w===void 0&&(w=(await this.readDataset({datasetName:x})).id);const A=n.map((D,O)=>({dataset_id:w,inputs:D,outputs:r==null?void 0:r[O],metadata:s==null?void 0:s[O],split:a==null?void 0:a[O],id:p==null?void 0:p[O],attachments:c==null?void 0:c[O],source_run_id:o==null?void 0:o[O],use_source_run_io:u==null?void 0:u[O],use_source_run_attachments:d==null?void 0:d[O]})),E=await this._uploadExamplesMultipart(w,A);return await Promise.all(E.example_ids.map(D=>this.readExample(D)))}async createLLMExample(e,n,r){return this.createExample({input:e},{output:n},r)}async createChatExample(e,n,r){const s=e.map(o=>PC(o)?MC(o):o),a=PC(n)?MC(n):n;return this.createExample({input:s},{output:a},r)}async readExample(e){Xe(e);const n=`/examples/${e}`,r=await this._get(n),{attachment_urls:s,...a}=r,o=a;return s&&(o.attachments=Object.entries(s).reduce((u,[d,c])=>(u[d.slice(11)]={presigned_url:c.presigned_url,mime_type:c.mime_type},u),{})),o}async*listExamples({datasetId:e,datasetName:n,exampleIds:r,asOf:s,splits:a,inlineS3Urls:o,metadata:u,limit:d,offset:c,filter:p,includeAttachments:m}={}){let y;if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)y=e;else if(n!==void 0)y=(await this.readDataset({datasetName:n})).id;else throw new Error("Must provide a datasetName or datasetId");const w=new URLSearchParams({dataset:y}),x=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;x&&w.append("as_of",x);const A=o??!0;if(w.append("inline_s3_urls",A.toString()),r!==void 0)for(const C of r)w.append("id",C);if(a!==void 0)for(const C of a)w.append("splits",C);if(u!==void 0){const C=JSON.stringify(u);w.append("metadata",C)}d!==void 0&&w.append("limit",d.toString()),c!==void 0&&w.append("offset",c.toString()),p!==void 0&&w.append("filter",p),m===!0&&["attachment_urls","outputs","metadata"].forEach(C=>w.append("select",C));let E=0;for await(const C of this._getPaginated("/examples",w)){for(const D of C){const{attachment_urls:O,...T}=D,I=T;O&&(I.attachments=Object.entries(O).reduce((M,[N,P])=>(M[N.slice(11)]={presigned_url:P.presigned_url,mime_type:P.mime_type||void 0},M),{})),yield I,E++}if(d!==void 0&&E>=d)break}}async deleteExample(e){Xe(e);const n=`/examples/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(r,`delete ${n}`,!0),r})}async updateExample(e,n){let r;n?r=e:r=e.id,Xe(r);let s;n?s={id:r,...n}:s=e;let a;return s.dataset_id!==void 0?a=s.dataset_id:a=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(a,[s])}async updateExamples(e){let n;return e[0].dataset_id===void 0?n=(await this.readExample(e[0].id)).dataset_id:n=e[0].dataset_id,this._updateExamplesMultipart(n,e)}async readDatasetVersion({datasetId:e,datasetName:n,asOf:r,tag:s}){let a;if(e?a=e:a=(await this.readDataset({datasetName:n})).id,Xe(a),r&&s||!r&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const o=new URLSearchParams;return r!==void 0&&o.append("as_of",typeof r=="string"?r:r.toISOString()),s!==void 0&&o.append("tag",s),await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets/${a}/version?${o.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(d,"read dataset version"),d})).json()}async listDatasetSplits({datasetId:e,datasetName:n,asOf:r}){let s;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:n})).id:s=e,Xe(s);const a=new URLSearchParams,o=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return o&&a.append("as_of",o),await this._get(`/datasets/${s}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:n,splitName:r,exampleIds:s,remove:a=!1}){let o;if(e===void 0&&n===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?o=(await this.readDataset({datasetName:n})).id:o=e,Xe(o);const u={split_name:r,examples:s.map(c=>(Xe(c),c)),remove:a},d=JSON.stringify(u);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${o}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await Le(c,"update dataset splits",!0),c})}async evaluateRun(e,n,{sourceInfo:r,loadChildRuns:s,referenceExample:a}={loadChildRuns:!1}){J_("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let o;if(typeof e=="string")o=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)o=e;else throw new Error(`Invalid run type: ${typeof e}`);o.reference_example_id!==null&&o.reference_example_id!==void 0&&(a=await this.readExample(o.reference_example_id));const u=await n.evaluateRun(o,a),[d,c]=await this._logEvaluationFeedback(u,o,r);return c[0]}async createFeedback(e,n,{score:r,value:s,correction:a,comment:o,sourceInfo:u,feedbackSourceType:d="api",sourceRunId:c,feedbackId:p,feedbackConfig:m,projectId:y,comparativeExperimentId:w}){var D;if(!e&&!y)throw new Error("One of runId or projectId must be provided");if(e&&y)throw new Error("Only one of runId or projectId can be provided");const x={type:d??"api",metadata:u??{}};c!==void 0&&(x==null?void 0:x.metadata)!==void 0&&!x.metadata.__run&&(x.metadata.__run={run_id:c}),(x==null?void 0:x.metadata)!==void 0&&((D=x.metadata.__run)==null?void 0:D.run_id)!==void 0&&Xe(x.metadata.__run.run_id);const A={id:p??Dn(),run_id:e,key:n,score:CI(r),value:s,correction:a,comment:o,feedback_source:x,comparative_experiment_id:w,feedbackConfig:m,session_id:y},E=JSON.stringify(A),C=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const O=await this._fetch(C,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:E});return await Le(O,"create feedback",!0),O}),A}async updateFeedback(e,{score:n,value:r,correction:s,comment:a}){const o={};n!=null&&(o.score=CI(n)),r!=null&&(o.value=r),s!=null&&(o.correction=s),a!=null&&(o.comment=a),Xe(e);const u=JSON.stringify(o);await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Le(d,"update feedback",!0),d})}async readFeedback(e){Xe(e);const n=`/feedback/${e}`;return await this._get(n)}async deleteFeedback(e){Xe(e);const n=`/feedback/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(r,`delete ${n}`,!0),r})}async*listFeedback({runIds:e,feedbackKeys:n,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e)for(const a of e)Xe(a),s.append("run",a);if(n)for(const a of n)s.append("key",a);if(r)for(const a of r)s.append("source",a);for await(const a of this._getPaginated("/feedback",s))yield*a}async createPresignedFeedbackToken(e,n,{expiration:r,feedbackConfig:s}={}){const a={run_id:e,feedback_key:n,feedback_config:s};r?typeof r=="string"?a.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(a.expires_in=r):a.expires_in={hours:3};const o=JSON.stringify(a);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(d,"create presigned feedback token"),d})).json()}async createComparativeExperiment({name:e,experimentIds:n,referenceDatasetId:r,createdAt:s,description:a,metadata:o,id:u}){var m;if(n.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:n[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const d={id:u,name:e,experiment_ids:n,reference_dataset_id:r,description:a,created_at:(m=s??new Date)==null?void 0:m.toISOString(),extra:{}};o&&(d.extra.metadata=o);const c=JSON.stringify(d);return(await this.caller.call(async()=>{const y=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await Le(y,"create comparative experiment"),y})).json()}async*listPresignedFeedbackTokens(e){Xe(e);const n=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",n))yield*r}_selectEvalResults(e){let n;return"results"in e?n=e.results:Array.isArray(e)?n=e:n=[e],n}async _logEvaluationFeedback(e,n,r){const s=this._selectEvalResults(e),a=[];for(const o of s){let u=r||{};o.evaluatorInfo&&(u={...o.evaluatorInfo,...u});let d=null;o.targetRunId?d=o.targetRunId:n&&(d=n.id),a.push(await this.createFeedback(d,o.key,{score:o.score,value:o.value,comment:o.comment,correction:o.correction,sourceInfo:u,sourceRunId:o.sourceRunId,feedbackConfig:o.feedbackConfig,feedbackSourceType:"model"}))}return[s,a]}async logEvaluationFeedback(e,n,r){const[s]=await this._logEvaluationFeedback(e,n,r);return s}async*listAnnotationQueues(e={}){const{queueIds:n,name:r,nameContains:s,limit:a}=e,o=new URLSearchParams;n&&n.forEach((d,c)=>{Xe(d,`queueIds[${c}]`),o.append("ids",d)}),r&&o.append("name",r),s&&o.append("name_contains",s),o.append("limit",(a!==void 0?Math.min(a,100):100).toString());let u=0;for await(const d of this._getPaginated("/annotation-queues",o))if(yield*d,u++,a!==void 0&&u>=a)break}async createAnnotationQueue(e){const{name:n,description:r,queueId:s,rubricInstructions:a}=e,o={name:n,description:r,id:s||Dn(),rubric_instructions:a},u=JSON.stringify(Object.fromEntries(Object.entries(o).filter(([c,p])=>p!==void 0)));return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Le(c,"create annotation queue"),c})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Xe(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(r,"read annotation queue"),r})).json()}async updateAnnotationQueue(e,n){const{name:r,description:s,rubricInstructions:a}=n,o=JSON.stringify({name:r,description:s,rubric_instructions:a});await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/annotation-queues/${Xe(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(u,"update annotation queue",!0),u})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Xe(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(n,"delete annotation queue",!0),n})}async addRunsToAnnotationQueue(e,n){const r=JSON.stringify(n.map((s,a)=>Xe(s,`runIds[${a}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${Xe(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await Le(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,n){const r=`/annotation-queues/${Xe(e,"queueId")}/run`;return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(a,"get run from annotation queue"),a})).json()}async deleteRunFromAnnotationQueue(e,n){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Xe(e,"queueId")}/runs/${Xe(n,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Xe(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(r,"get size from annotation queue"),r})).json()}async _currentTenantIsOwner(e){const n=await this._getSettings();return e=="-"||n.tenant_handle===e}async _ownerConflictError(e,n){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${n}`)}async _getLatestCommitHash(e){const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(s,"get latest commit hash"),s})).json();if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,n){const[r,s,a]=Ia(e),o=JSON.stringify({like:n});return(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/likes/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(d,`${n?"like":"unlike"} prompt`),d})).json()}async _getPromptUrl(e){const[n,r,s]=Ia(e);if(await this._currentTenantIsOwner(n)){const a=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${r}/${s.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${a.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${n}/${r}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${n}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const n of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*n}async*listPrompts(e){const n=new URLSearchParams;n.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),n.append("sort_direction","desc"),n.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&n.append("is_public",e.isPublic.toString()),e!=null&&e.query&&n.append("query",e.query);for await(const r of this._getPaginated("/repos",n,s=>s.repos))yield*r}async getPrompt(e){const[n,r,s]=Ia(e),a=await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return(u==null?void 0:u.status)===404?null:(await Le(u,"get prompt"),u)}),o=await(a==null?void 0:a.json());return o!=null&&o.repo?o.repo:null}async createPrompt(e,n){const r=await this._getSettings();if(n!=null&&n.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,a,o]=Ia(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const u={repo_handle:a,...(n==null?void 0:n.description)&&{description:n.description},...(n==null?void 0:n.readme)&&{readme:n.readme},...(n==null?void 0:n.tags)&&{tags:n.tags},is_public:!!(n!=null&&n.isPublic)},d=JSON.stringify(u),c=await this.caller.call(async()=>{const m=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await Le(m,"create prompt"),m}),{repo:p}=await c.json();return p}async createCommit(e,n,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,a,o]=Ia(e),u=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${s}/${a}`):r==null?void 0:r.parentCommitHash,d={manifest:JSON.parse(JSON.stringify(n)),parent_commit:u},c=JSON.stringify(d),m=await(await this.caller.call(async()=>{const y=await this._fetch(`${this.apiUrl}/commits/${s}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await Le(y,"create commit"),y})).json();return this._getPromptUrl(`${s}/${a}${m.commit_hash?`:${m.commit_hash}`:""}`)}async updateExamplesMultipart(e,n=[]){return this._updateExamplesMultipart(e,n)}async _updateExamplesMultipart(e,n=[]){var o;if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const u of n){const d=u.id,c={...u.metadata&&{metadata:u.metadata},...u.split&&{split:u.split}},p=sr(c,`Serializing body for example with id: ${d}`),m=new Blob([p],{type:"application/json"});if(r.append(d,m),u.inputs){const y=sr(u.inputs,`Serializing inputs for example with id: ${d}`),w=new Blob([y],{type:"application/json"});r.append(`${d}.inputs`,w)}if(u.outputs){const y=sr(u.outputs,`Serializing outputs whle updating example with id: ${d}`),w=new Blob([y],{type:"application/json"});r.append(`${d}.outputs`,w)}if(u.attachments)for(const[y,w]of Object.entries(u.attachments)){let x,A;Array.isArray(w)?[x,A]=w:(x=w.mimeType,A=w.data);const E=new Blob([A],{type:`${x}; length=${A.byteLength}`});r.append(`${d}.attachment.${y}`,E)}if(u.attachments_operations){const y=sr(u.attachments_operations,`Serializing attachments while updating example with id: ${d}`),w=new Blob([y],{type:"application/json"});r.append(`${d}.attachments_operations`,w)}}const s=e??((o=n[0])==null?void 0:o.dataset_id);return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await Le(u,"update examples"),u})).json()}async uploadExamplesMultipart(e,n=[]){return this._uploadExamplesMultipart(e,n)}async _uploadExamplesMultipart(e,n=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const a of n){const o=(a.id??Dn()).toString(),u={created_at:a.created_at,...a.metadata&&{metadata:a.metadata},...a.split&&{split:a.split},...a.source_run_id&&{source_run_id:a.source_run_id},...a.use_source_run_io&&{use_source_run_io:a.use_source_run_io},...a.use_source_run_attachments&&{use_source_run_attachments:a.use_source_run_attachments}},d=sr(u,`Serializing body for uploaded example with id: ${o}`),c=new Blob([d],{type:"application/json"});if(r.append(o,c),a.inputs){const p=sr(a.inputs,`Serializing inputs for uploaded example with id: ${o}`),m=new Blob([p],{type:"application/json"});r.append(`${o}.inputs`,m)}if(a.outputs){const p=sr(a.outputs,`Serializing outputs for uploaded example with id: ${o}`),m=new Blob([p],{type:"application/json"});r.append(`${o}.outputs`,m)}if(a.attachments)for(const[p,m]of Object.entries(a.attachments)){let y,w;Array.isArray(m)?[y,w]=m:(y=m.mimeType,w=m.data);const x=new Blob([w],{type:`${y}; length=${w.byteLength}`});r.append(`${o}.attachment.${p}`,x)}}return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await Le(a,"upload examples"),a})).json()}async updatePrompt(e,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s]=Ia(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if((n==null?void 0:n.description)!==void 0&&(a.description=n.description),(n==null?void 0:n.readme)!==void 0&&(a.readme=n.readme),(n==null?void 0:n.tags)!==void 0&&(a.tags=n.tags),(n==null?void 0:n.isPublic)!==void 0&&(a.is_public=n.isPublic),(n==null?void 0:n.isArchived)!==void 0&&(a.is_archived=n.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const o=JSON.stringify(a);return(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/${r}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Le(d,"update prompt"),d})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r,s]=Ia(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("delete a prompt",n);return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(o,"delete prompt"),o})).json()}async pullPromptCommit(e,n){const[r,s,a]=Ia(e),u=await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/commits/${r}/${s}/${a}${n!=null&&n.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Le(d,"pull prompt commit"),d})).json();return{owner:r,repo:s,commit_hash:u.commit_hash,manifest:u.manifest,examples:u.examples}}async _pullPrompt(e,n){const r=await this.pullPromptCommit(e,{includeModel:n==null?void 0:n.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,n){return await this.promptExists(e)?n&&Object.keys(n).some(s=>s!=="object")&&await this.updatePrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}):await this.createPrompt(e,{description:n==null?void 0:n.description,readme:n==null?void 0:n.readme,tags:n==null?void 0:n.tags,isPublic:n==null?void 0:n.isPublic}),n!=null&&n.object?await this.createCommit(e,n==null?void 0:n.object,{parentCommitHash:n==null?void 0:n.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,n={}){const{sourceApiUrl:r=this.apiUrl,datasetName:s}=n,[a,o]=this.parseTokenOrUrl(e,r),u=new Yu({apiUrl:a,apiKey:"placeholder"}),d=await u.readSharedDataset(o),c=s||d.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}const p=await u.listSharedExamples(o),m=await this.createDataset(c,{description:d.description,dataType:d.data_type||"kv",inputsSchema:d.inputs_schema_definition??void 0,outputsSchema:d.outputs_schema_definition??void 0});try{await this.createExamples({inputs:p.map(y=>y.inputs),outputs:p.flatMap(y=>y.outputs?[y.outputs]:[]),datasetId:m.id})}catch(y){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),y}}parseTokenOrUrl(e,n,r=2,s="dataset"){try{return Xe(e),[n,e]}catch{}try{const o=new URL(e).pathname.split("/").filter(u=>u!=="");if(o.length>=r){const u=o[o.length-r];return[n,u]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){var e,n;if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:r})=>r),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await((n=(e=PV())==null?void 0:e.DEFAULT_LANGSMITH_SPAN_PROCESSOR)==null?void 0:n.forceFlush())}}function RI(t){return"dataset_id"in t||"dataset_name"in t}const L6=t=>!!["TRACING_V2","TRACING"].find(n=>Jn(n)==="true"),ky=Symbol.for("lc:context_variables");function $6(t){return t.replace(/[-:.]/g,"")}function dM(t,e,n=1){const r=n.toFixed(0).slice(0,3).padStart(3,"0"),s=`${new Date(t).toISOString().slice(0,-1)}${r}Z`;return{dottedOrder:$6(s)+e,microsecondPrecisionDatestring:s}}class Jf{constructor(e,n,r,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=n,this.project_name=r,this.replicas=s}static fromHeader(e){const n=e.split(",");let r={},s=[],a,o;for(const u of n){const[d,c]=u.split("="),p=decodeURIComponent(c);d==="langsmith-metadata"?r=JSON.parse(p):d==="langsmith-tags"?s=p.split(","):d==="langsmith-project"?a=p:d==="langsmith-replicas"&&(o=JSON.parse(p))}return new Jf(r,s,a,o)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class Vn{constructor(e){var u;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),U6(e)){Object.assign(this,{...e});return}const n=Vn.getDefaultConfig(),{metadata:r,...s}=e,a=s.client??Vn.getSharedClient(),o={...r,...(u=s==null?void 0:s.extra)==null?void 0:u.metadata};if(s.extra={...s.extra,metadata:o},"id"in s&&s.id==null&&delete s.id,Object.assign(this,{...n,...s,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=H6(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const{dottedOrder:d,microsecondPrecisionDatestring:c}=dM(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+d:this.dotted_order=d,this._serialized_start_time=c}}set metadata(e){var n;this.extra={...this.extra,metadata:{...(n=this.extra)==null?void 0:n.metadata,...e}}}get metadata(){var e;return(e=this.extra)==null?void 0:e.metadata}static getDefaultConfig(){return{id:Dn(),run_type:"chain",project_name:ZP(),child_runs:[],api_url:us("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:us("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return Vn.sharedClient||(Vn.sharedClient=new Yu),Vn.sharedClient}createChild(e){var d,c,p,m,y,w;const n=this.child_execution_order+1,r=new Vn({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:n,child_execution_order:n});ky in this&&(r[ky]=this[ky]);const s=Symbol.for("lc:child_config"),a=((d=e.extra)==null?void 0:d[s])??this.extra[s];if(B6(a)){const x={...a},A=F6(x.callbacks)?(p=(c=x.callbacks).copy)==null?void 0:p.call(c):void 0;A&&(Object.assign(A,{_parentRunId:r.id}),(w=(y=(m=A.handlers)==null?void 0:m.find(fM))==null?void 0:y.updateFromRunTree)==null||w.call(y,r),x.callbacks=A),r.extra[s]=x}const o=new Set;let u=this;for(;u!=null&&!o.has(u.id);)o.add(u.id),u.child_execution_order=Math.max(u.child_execution_order,n),u=u.parent_run;return this.child_runs.push(r),r}async end(e,n,r=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??n,this.end_time=this.end_time??r,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,n,r=!0){var u,d;const s=e.extra??{};if(((u=s==null?void 0:s.runtime)==null?void 0:u.library)===void 0&&(s.runtime||(s.runtime={}),n))for(const[c,p]of Object.entries(n))s.runtime[c]||(s.runtime[c]=p);let a,o;return r?(o=((d=e.parent_run)==null?void 0:d.id)??e.parent_run_id,a=[]):(a=e.child_runs.map(c=>this._convertToCreate(c,n,r)),o=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:o,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,n,r=!0){const s=this._convertToCreate(this,n,r);if(e===this.project_name)return s;const a=m=>pC(`${m}:${e}`,pC.DNS),o=a(s.id),u=s.trace_id?a(s.trace_id):void 0,d=s.parent_run_id?a(s.parent_run_id):void 0;let c;if(s.dotted_order){const m=q6(s.dotted_order),y=[];for(let x=0;x<m.length-1;x++){const[A,E]=m[x],C=a(E);y.push(A.toISOString().replace(/[-:]/g,"").replace(".","")+C)}const[w]=m[m.length-1];y.push(w.toISOString().replace(/[-:]/g,"").replace(".","")+o),c=y.join(".")}else c=void 0;return{...s,id:o,trace_id:u,parent_run_id:d,dotted_order:c,session_name:e}}async postRun(e=!0){try{const n=tM();if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:a,workspaceId:o}of this.replicas){const u=this._remapForProject(r??this.project_name,n,!0);await this.client.createRun(u,{apiKey:s,apiUrl:a,workspaceId:o})}else{const r=this._convertToCreate(this,n,e);await this.client.createRun(r)}if(!e){J_("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const r of this.child_runs)await r.postRun(!1)}}catch(n){console.error(`Error in postRun for run ${this.id}:`,n)}}async patchRun(e){var n;if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:a,workspaceId:o,updates:u}of this.replicas){const d=this._remapForProject(r??this.project_name),c={id:d.id,outputs:d.outputs,error:d.error,parent_run_id:d.parent_run_id,session_name:d.session_name,reference_example_id:d.reference_example_id,end_time:d.end_time,dotted_order:d.dotted_order,trace_id:d.trace_id,events:d.events,tags:d.tags,extra:d.extra,attachments:this.attachments,...u};e!=null&&e.excludeInputs||(c.inputs=d.inputs),await this.client.updateRun(d.id,c,{apiKey:s,apiUrl:a,workspaceId:o})}else try{const r={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:((n=this.parent_run)==null?void 0:n.id)??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e!=null&&e.excludeInputs||(r.inputs=this.inputs),await this.client.updateRun(this.id,r)}catch(r){console.error(`Error in patchRun for run ${this.id}`,r)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,n){var c,p,m,y;const r=e==null?void 0:e.callbacks;let s,a,o,u=L6();if(r){const w=((c=r==null?void 0:r.getParentRunId)==null?void 0:c.call(r))??"",x=(p=r==null?void 0:r.handlers)==null?void 0:p.find(A=>(A==null?void 0:A.name)=="langchain_tracer");s=(m=x==null?void 0:x.getRun)==null?void 0:m.call(x,w),a=x==null?void 0:x.projectName,o=x==null?void 0:x.client,u=u||!!x}return s?new Vn({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:o,tracingEnabled:u,project_name:a,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(y=s==null?void 0:s.extra)==null?void 0:y.metadata,...e==null?void 0:e.metadata}}}).createChild(n):new Vn({...n,client:o,tracingEnabled:u,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,n){var c;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=r["langsmith-trace"];if(!s||typeof s!="string")return;const a=s.trim(),o=a.split(".").map(p=>{const[m,y]=p.split("Z");return{strTime:m,time:Date.parse(m+"Z"),uuid:y}}),u=o[0].uuid,d={...n,name:(n==null?void 0:n.name)??"parent",run_type:(n==null?void 0:n.run_type)??"chain",start_time:(n==null?void 0:n.start_time)??Date.now(),id:(c=o.at(-1))==null?void 0:c.uuid,trace_id:u,dotted_order:a};if(r.baggage&&typeof r.baggage=="string"){const p=Jf.fromHeader(r.baggage);d.metadata=p.metadata,d.tags=p.tags,d.project_name=p.project_name,d.replicas=p.replicas}return new Vn(d)}toHeaders(e){var r;const n={"langsmith-trace":this.dotted_order,baggage:new Jf((r=this.extra)==null?void 0:r.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[s,a]of Object.entries(n))e.set(s,a);return n}}Object.defineProperty(Vn,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function U6(t){return t!=null&&typeof t.createChild=="function"&&typeof t.postRun=="function"}function fM(t){return typeof t=="object"&&t!=null&&typeof t.name=="string"&&t.name==="langchain_tracer"}function NI(t){return Array.isArray(t)&&t.some(e=>fM(e))}function F6(t){return typeof t=="object"&&t!=null&&Array.isArray(t.handlers)}function B6(t){var e;return t!=null&&typeof t.callbacks=="object"&&(NI((e=t.callbacks)==null?void 0:e.handlers)||NI(t.callbacks))}function q6(t){return t.split(".").map(n=>{const r=n.slice(0,-36),s=n.slice(-36),a=parseInt(r.slice(0,4)),o=parseInt(r.slice(4,6))-1,u=parseInt(r.slice(6,8)),d=parseInt(r.slice(9,11)),c=parseInt(r.slice(11,13)),p=parseInt(r.slice(13,15)),m=parseInt(r.slice(15,21));return[new Date(a,o,u,d,c,p,m/1e3),s]})}function G6(){const t=us("LANGSMITH_RUNS_ENDPOINTS");if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e)){const n=[];for(const r of e){if(typeof r!="object"||r===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof r}`);continue}if(typeof r.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_url}`);continue}if(typeof r.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_key}`);continue}n.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key})}return n}else if(typeof e=="object"&&e!==null){z6(e);const n=[];for(const[r,s]of Object.entries(e)){const a=r.replace(/\/$/,"");if(typeof s=="string")n.push({apiUrl:a,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got ${typeof s}`);continue}}return n}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(S6(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function H6(t){return t?t.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):G6()}function z6(t){if(Object.keys(t).length>0&&Jn("ENDPOINT"))throw new b6}var j6={};Ft(j6,{BaseTracer:()=>hl,isBaseTracer:()=>ko});const V6=t=>{if(t)return t.events=t.events??[],t.child_runs=t.child_runs??[],t};function K_(t,e){if(t)return new Vn({...t,start_time:t._serialized_start_time??t.start_time,parent_run:K_(e),child_runs:t.child_runs.map(n=>K_(n)).filter(n=>n!==void 0),extra:{...t.extra,runtime:JP()},tracingEnabled:!1})}function Oy(t,e){return t&&!Array.isArray(t)&&typeof t=="object"?t:{[e]:t}}function ko(t){return typeof t._addRunToRunMap=="function"}var hl=class extends hc{constructor(e){super(...arguments);z(this,"runMap",new Map);z(this,"runTreeMap",new Map);z(this,"usesRunTreeMap",!1)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?V6(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,n){e.child_runs.push(n)}_addRunToRunMap(e){const{dottedOrder:n,microsecondPrecisionDatestring:r}=dM(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},a=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?a&&(this._addChildRun(a,s),a.child_execution_order=Math.max(a.child_execution_order,s.child_execution_order),s.trace_id=a.trace_id,a.dotted_order!==void 0&&(s.dotted_order=[a.dotted_order,n].join("."),s._serialized_start_time=r)):(s.trace_id=s.id,s.dotted_order=n,s._serialized_start_time=r),this.usesRunTreeMap){const o=K_(s,a);o!==void 0&&this.runTreeMap.set(s.id,o)}else this.runMap.set(s.id,s);return s}async _endTrace(e){var r;const n=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);n?n.child_execution_order=Math.max(n.child_execution_order,e.child_execution_order):await this.persistRun(e),await((r=this.onRunUpdate)==null?void 0:r.call(this,e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const n=e!==void 0&&this.getRunById(e);return n?n.child_execution_order+1:1}_createRunForLLMStart(e,n,r,s,a,o,u,d){const c=this._getExecutionOrder(s),p=Date.now(),m=u?{...a,metadata:u}:a,y={id:r,name:d??e.id[e.id.length-1],parent_run_id:s,start_time:p,serialized:e,events:[{name:"start",time:new Date(p).toISOString()}],inputs:{prompts:n},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:m??{},tags:o||[]};return this._addRunToRunMap(y)}async handleLLMStart(e,n,r,s,a,o,u,d){var p,m;const c=this.getRunById(r)??this._createRunForLLMStart(e,n,r,s,a,o,u,d);return await((p=this.onRunCreate)==null?void 0:p.call(this,c)),await((m=this.onLLMStart)==null?void 0:m.call(this,c)),c}_createRunForChatModelStart(e,n,r,s,a,o,u,d){const c=this._getExecutionOrder(s),p=Date.now(),m=u?{...a,metadata:u}:a,y={id:r,name:d??e.id[e.id.length-1],parent_run_id:s,start_time:p,serialized:e,events:[{name:"start",time:new Date(p).toISOString()}],inputs:{messages:n},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:m??{},tags:o||[]};return this._addRunToRunMap(y)}async handleChatModelStart(e,n,r,s,a,o,u,d){var p,m;const c=this.getRunById(r)??this._createRunForChatModelStart(e,n,r,s,a,o,u,d);return await((p=this.onRunCreate)==null?void 0:p.call(this,c)),await((m=this.onLLMStart)==null?void 0:m.call(this,c)),c}async handleLLMEnd(e,n,r,s,a){var u;const o=this.getRunById(n);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error("No LLM run to end.");return o.end_time=Date.now(),o.outputs=e,o.events.push({name:"end",time:new Date(o.end_time).toISOString()}),o.extra={...o.extra,...a},await((u=this.onLLMEnd)==null?void 0:u.call(this,o)),await this._endTrace(o),o}async handleLLMError(e,n,r,s,a){var u;const o=this.getRunById(n);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error("No LLM run to end.");return o.end_time=Date.now(),o.error=this.stringifyError(e),o.events.push({name:"error",time:new Date(o.end_time).toISOString()}),o.extra={...o.extra,...a},await((u=this.onLLMError)==null?void 0:u.call(this,o)),await this._endTrace(o),o}_createRunForChainStart(e,n,r,s,a,o,u,d){const c=this._getExecutionOrder(s),p=Date.now(),m={id:r,name:d??e.id[e.id.length-1],parent_run_id:s,start_time:p,serialized:e,events:[{name:"start",time:new Date(p).toISOString()}],inputs:n,execution_order:c,child_execution_order:c,run_type:u??"chain",child_runs:[],extra:o?{metadata:o}:{},tags:a||[]};return this._addRunToRunMap(m)}async handleChainStart(e,n,r,s,a,o,u,d){var p,m;const c=this.getRunById(r)??this._createRunForChainStart(e,n,r,s,a,o,u,d);return await((p=this.onRunCreate)==null?void 0:p.call(this,c)),await((m=this.onChainStart)==null?void 0:m.call(this,c)),c}async handleChainEnd(e,n,r,s,a){var u;const o=this.getRunById(n);if(!o)throw new Error("No chain run to end.");return o.end_time=Date.now(),o.outputs=Oy(e,"output"),o.events.push({name:"end",time:new Date(o.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(o.inputs=Oy(a.inputs,"input")),await((u=this.onChainEnd)==null?void 0:u.call(this,o)),await this._endTrace(o),o}async handleChainError(e,n,r,s,a){var u;const o=this.getRunById(n);if(!o)throw new Error("No chain run to end.");return o.end_time=Date.now(),o.error=this.stringifyError(e),o.events.push({name:"error",time:new Date(o.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(o.inputs=Oy(a.inputs,"input")),await((u=this.onChainError)==null?void 0:u.call(this,o)),await this._endTrace(o),o}_createRunForToolStart(e,n,r,s,a,o,u){const d=this._getExecutionOrder(s),c=Date.now(),p={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:n},execution_order:d,child_execution_order:d,run_type:"tool",child_runs:[],extra:o?{metadata:o}:{},tags:a||[]};return this._addRunToRunMap(p)}async handleToolStart(e,n,r,s,a,o,u){var c,p;const d=this.getRunById(r)??this._createRunForToolStart(e,n,r,s,a,o,u);return await((c=this.onRunCreate)==null?void 0:c.call(this,d)),await((p=this.onToolStart)==null?void 0:p.call(this,d)),d}async handleToolEnd(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,n){var a;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,r))}async handleAgentEnd(e,n){var s;const r=this.getRunById(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}_createRunForRetrieverStart(e,n,r,s,a,o,u){const d=this._getExecutionOrder(s),c=Date.now(),p={id:r,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:n},execution_order:d,child_execution_order:d,run_type:"retriever",child_runs:[],extra:o?{metadata:o}:{},tags:a||[]};return this._addRunToRunMap(p)}async handleRetrieverStart(e,n,r,s,a,o,u){var c,p;const d=this.getRunById(r)??this._createRunForRetrieverStart(e,n,r,s,a,o,u);return await((c=this.onRunCreate)==null?void 0:c.call(this,d)),await((p=this.onRetrieverStart)==null?void 0:p.call(this,d)),d}async handleRetrieverEnd(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,n){var s;const r=this.getRunById(n);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,n){var s;const r=this.getRunById(n);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,n,r,s,a,o){var d;const u=this.getRunById(r);if(!u||(u==null?void 0:u.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return u.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:n,chunk:o==null?void 0:o.chunk}}),await((d=this.onLLMNewToken)==null?void 0:d.call(this,u,e,{chunk:o==null?void 0:o.chunk})),u}},vf={exports:{}};vf.exports;var PI;function J6(){return PI||(PI=1,(function(t){const n=(a=0)=>o=>`\x1B[${38+a};5;${o}m`,r=(a=0)=>(o,u,d)=>`\x1B[${38+a};2;${o};${u};${d}m`;function s(){const a=new Map,o={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};o.color.gray=o.color.blackBright,o.bgColor.bgGray=o.bgColor.bgBlackBright,o.color.grey=o.color.blackBright,o.bgColor.bgGrey=o.bgColor.bgBlackBright;for(const[u,d]of Object.entries(o)){for(const[c,p]of Object.entries(d))o[c]={open:`\x1B[${p[0]}m`,close:`\x1B[${p[1]}m`},d[c]=o[c],a.set(p[0],p[1]);Object.defineProperty(o,u,{value:d,enumerable:!1})}return Object.defineProperty(o,"codes",{value:a,enumerable:!1}),o.color.close="\x1B[39m",o.bgColor.close="\x1B[49m",o.color.ansi256=n(),o.color.ansi16m=r(),o.bgColor.ansi256=n(10),o.bgColor.ansi16m=r(10),Object.defineProperties(o,{rgbToAnsi256:{value:(u,d,c)=>u===d&&d===c?u<8?16:u>248?231:Math.round((u-8)/247*24)+232:16+36*Math.round(u/255*5)+6*Math.round(d/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:u=>{const d=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(u.toString(16));if(!d)return[0,0,0];let{colorString:c}=d.groups;c.length===3&&(c=c.split("").map(m=>m+m).join(""));const p=Number.parseInt(c,16);return[p>>16&255,p>>8&255,p&255]},enumerable:!1},hexToAnsi256:{value:u=>o.rgbToAnsi256(...o.hexToRgb(u)),enumerable:!1}}),o}Object.defineProperty(t,"exports",{enumerable:!0,get:s})})(vf)),vf.exports}var Y6=J6();const pM=Ga(Y6);var K6={};Ft(K6,{ConsoleCallbackHandler:()=>W_});function kn(t,e){return`${t.open}${e}${t.close}`}function wr(t,e){try{return JSON.stringify(t,null,2)}catch{return e}}function MI(t){return typeof t=="string"?t.trim():t==null?t:wr(t,t.toString())}function Ra(t){if(!t.end_time)return"";const e=t.end_time-t.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:zn}=pM;var W_=class extends hl{constructor(){super(...arguments);z(this,"name","console_callback_handler")}persistRun(e){return Promise.resolve()}getParents(e){const n=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)n.push(s),r=s;else break}return n}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,a,o)=>{const u=`${s.execution_order}:${s.run_type}:${s.name}`;return a===o.length-1?kn(pM.bold,u):u}).join(" > ");return kn(zn.grey,r)}onChainStart(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.green,"[chain/start]")} [${n}] Entering Chain run with input: ${wr(e.inputs,"[inputs]")}`)}onChainEnd(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.cyan,"[chain/end]")} [${n}] [${Ra(e)}] Exiting Chain run with output: ${wr(e.outputs,"[outputs]")}`)}onChainError(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.red,"[chain/error]")} [${n}] [${Ra(e)}] Chain run errored with error: ${wr(e.error,"[error]")}`)}onLLMStart(e){const n=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${kn(zn.green,"[llm/start]")} [${n}] Entering LLM run with input: ${wr(r,"[inputs]")}`)}onLLMEnd(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.cyan,"[llm/end]")} [${n}] [${Ra(e)}] Exiting LLM run with output: ${wr(e.outputs,"[response]")}`)}onLLMError(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.red,"[llm/error]")} [${n}] [${Ra(e)}] LLM run errored with error: ${wr(e.error,"[error]")}`)}onToolStart(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.green,"[tool/start]")} [${n}] Entering Tool run with input: "${MI(e.inputs.input)}"`)}onToolEnd(e){var r;const n=this.getBreadcrumbs(e);console.log(`${kn(zn.cyan,"[tool/end]")} [${n}] [${Ra(e)}] Exiting Tool run with output: "${MI((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.red,"[tool/error]")} [${n}] [${Ra(e)}] Tool run errored with error: ${wr(e.error,"[error]")}`)}onRetrieverStart(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.green,"[retriever/start]")} [${n}] Entering Retriever run with input: ${wr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.cyan,"[retriever/end]")} [${n}] [${Ra(e)}] Exiting Retriever run with output: ${wr(e.outputs,"[outputs]")}`)}onRetrieverError(e){const n=this.getBreadcrumbs(e);console.log(`${kn(zn.red,"[retriever/error]")} [${n}] [${Ra(e)}] Retriever run errored with error: ${wr(e.error,"[error]")}`)}onAgentAction(e){const n=e,r=this.getBreadcrumbs(e);console.log(`${kn(zn.blue,"[agent/action]")} [${r}] Agent selected action: ${wr(n.actions[n.actions.length-1],"[action]")}`)}};let Dy;const hM=()=>{if(Dy===void 0){const t=Ri("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Dy=new Yu(t)}return Dy};let W6=class{getStore(){}run(e,n){return n()}};const Ly=Symbol.for("ls:tracing_async_local_storage"),Z6=new W6;let X6=class{getInstance(){return globalThis[Ly]??Z6}initializeGlobalInstance(e){globalThis[Ly]===void 0&&(globalThis[Ly]=e)}};const Q6=new X6;function e9(t=!1){const e=Q6.getInstance().getStore();if(!t&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function Pv(t){return typeof t=="function"&&"langsmith:traceable"in t}var t9={};Ft(t9,{LangChainTracer:()=>wf});var wf=class mM extends hl{constructor(n={}){super(n);z(this,"name","langchain_tracer");z(this,"projectName");z(this,"exampleId");z(this,"client");z(this,"replicas");z(this,"usesRunTreeMap",!0);const{exampleId:r,projectName:s,client:a,replicas:o}=n;this.projectName=s??ZP(),this.replicas=o,this.exampleId=r,this.client=a??hM();const u=mM.getTraceableRunTree();u&&this.updateFromRunTree(u)}async persistRun(n){}async onRunCreate(n){const r=this.getRunTreeWithTracingConfig(n.id);await(r==null?void 0:r.postRun())}async onRunUpdate(n){const r=this.getRunTreeWithTracingConfig(n.id);await(r==null?void 0:r.patchRun())}getRun(n){return this.runTreeMap.get(n)}updateFromRunTree(n){this.runTreeMap.set(n.id,n);let r=n;const s=new Set;for(;r.parent_run&&!(s.has(r.id)||(s.add(r.id),!r.parent_run));)r=r.parent_run;s.clear();const a=[r];for(;a.length>0;){const o=a.shift();!o||s.has(o.id)||(s.add(o.id),this.runTreeMap.set(o.id,o),o.child_runs&&a.push(...o.child_runs))}this.client=n.client??this.client,this.replicas=n.replicas??this.replicas,this.projectName=n.project_name??this.projectName,this.exampleId=n.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(n){const r=this.runTreeMap.get(n);if(r)return new Vn({...r,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return e9(!0)}catch{return}}};const gM=Symbol.for("ls:tracing_async_local_storage"),Ou=Symbol.for("lc:context_variables"),n9=t=>{globalThis[gM]=t},Ku=()=>globalThis[gM];let Ni;function r9(){const t="default"in Hs?Hs.default:Hs;return new t({autoStart:!0,concurrency:1})}function s9(){return typeof Ni>"u"&&(Ni=r9()),Ni}async function tn(t,e){if(e===!0){const n=Ku();n!==void 0?await n.run(void 0,async()=>t()):await t()}else Ni=s9(),Ni.add(async()=>{const n=Ku();n!==void 0?await n.run(void 0,async()=>t()):await t()})}async function a9(){const t=hM();await Promise.allSettled([typeof Ni<"u"?Ni.onIdle():Promise.resolve(),t.awaitPendingTraceBatches()])}var i9={};Ft(i9,{awaitAllCallbacks:()=>a9,consumeCallback:()=>tn});const o9=t=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(n=>Ri(n)==="true");function yM(t){var r;const e=Ku();if(e===void 0)return;const n=e.getStore();return(r=n==null?void 0:n[Ou])==null?void 0:r[t]}const l9=Symbol("lc:configure_hooks"),u9=()=>yM(l9)||[];var c9={};Ft(c9,{BaseCallbackManager:()=>_M,BaseRunManager:()=>gc,CallbackManager:()=>Ja,CallbackManagerForChainRun:()=>wM,CallbackManagerForLLMRun:()=>Z_,CallbackManagerForRetrieverRun:()=>vM,CallbackManagerForToolRun:()=>bM,ensureHandler:()=>Wu,parseCallbackConfigArg:()=>Pp});function Pp(t){return t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{}}var _M=class{setHandler(t){return this.setHandlers([t])}},gc=class{constructor(t,e,n,r,s,a,o,u){this.runId=t,this.handlers=e,this.inheritableHandlers=n,this.tags=r,this.inheritableTags=s,this.metadata=a,this.inheritableMetadata=o,this._parentRunId=u}get parentRunId(){return this._parentRunId}async handleText(t){await Promise.all(this.handlers.map(e=>tn(async()=>{var n;try{await((n=e.handleText)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleCustomEvent(t,e,n,r,s){await Promise.all(this.handlers.map(a=>tn(async()=>{var o;try{await((o=a.handleCustomEvent)==null?void 0:o.call(a,t,e,this.runId,this.tags,this.metadata))}catch(u){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${u}`),a.raiseError)throw u}},a.awaitHandlers)))}},vM=class extends gc{getChild(t){const e=new Ja(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleRetrieverEnd(t){await Promise.all(this.handlers.map(e=>tn(async()=>{var n;if(!e.ignoreRetriever)try{await((n=e.handleRetrieverEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw r}},e.awaitHandlers)))}async handleRetrieverError(t){await Promise.all(this.handlers.map(e=>tn(async()=>{var n;if(!e.ignoreRetriever)try{await((n=e.handleRetrieverError)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${r}`),e.raiseError)throw t}},e.awaitHandlers)))}},Z_=class extends gc{async handleLLMNewToken(t,e,n,r,s,a){await Promise.all(this.handlers.map(o=>tn(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,t,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(d){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${d}`),o.raiseError)throw d}},o.awaitHandlers)))}async handleLLMError(t,e,n,r,s){await Promise.all(this.handlers.map(a=>tn(async()=>{var o;if(!a.ignoreLLM)try{await((o=a.handleLLMError)==null?void 0:o.call(a,t,this.runId,this._parentRunId,this.tags,s))}catch(u){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMError: ${u}`),a.raiseError)throw u}},a.awaitHandlers)))}async handleLLMEnd(t,e,n,r,s){await Promise.all(this.handlers.map(a=>tn(async()=>{var o;if(!a.ignoreLLM)try{await((o=a.handleLLMEnd)==null?void 0:o.call(a,t,this.runId,this._parentRunId,this.tags,s))}catch(u){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMEnd: ${u}`),a.raiseError)throw u}},a.awaitHandlers)))}},wM=class extends gc{getChild(t){const e=new Ja(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleChainError(t,e,n,r,s){await Promise.all(this.handlers.map(a=>tn(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainError)==null?void 0:o.call(a,t,this.runId,this._parentRunId,this.tags,s))}catch(u){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainError: ${u}`),a.raiseError)throw u}},a.awaitHandlers)))}async handleChainEnd(t,e,n,r,s){await Promise.all(this.handlers.map(a=>tn(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainEnd)==null?void 0:o.call(a,t,this.runId,this._parentRunId,this.tags,s))}catch(u){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainEnd: ${u}`),a.raiseError)throw u}},a.awaitHandlers)))}async handleAgentAction(t){await Promise.all(this.handlers.map(e=>tn(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleAgentAction)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleAgentEnd(t){await Promise.all(this.handlers.map(e=>tn(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleAgentEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},bM=class extends gc{getChild(t){const e=new Ja(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),t&&e.addTags([t],!1),e}async handleToolError(t){await Promise.all(this.handlers.map(e=>tn(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleToolError)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleToolEnd(t){await Promise.all(this.handlers.map(e=>tn(async()=>{var n;if(!e.ignoreAgent)try{await((n=e.handleToolEnd)==null?void 0:n.call(e,t,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},Ja=class xu extends _M{constructor(n,r){super();z(this,"handlers",[]);z(this,"inheritableHandlers",[]);z(this,"tags",[]);z(this,"inheritableTags",[]);z(this,"metadata",{});z(this,"inheritableMetadata",{});z(this,"name","callback_manager");z(this,"_parentRunId");this.handlers=(r==null?void 0:r.handlers)??this.handlers,this.inheritableHandlers=(r==null?void 0:r.inheritableHandlers)??this.inheritableHandlers,this.tags=(r==null?void 0:r.tags)??this.tags,this.inheritableTags=(r==null?void 0:r.inheritableTags)??this.inheritableTags,this.metadata=(r==null?void 0:r.metadata)??this.metadata,this.inheritableMetadata=(r==null?void 0:r.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=n}getParentRunId(){return this._parentRunId}async handleLLMStart(n,r,s=void 0,a=void 0,o=void 0,u=void 0,d=void 0,c=void 0){return Promise.all(r.map(async(p,m)=>{const y=m===0&&s?s:Dn();return await Promise.all(this.handlers.map(w=>{if(!w.ignoreLLM)return ko(w)&&w._createRunForLLMStart(n,[p],y,this._parentRunId,o,this.tags,this.metadata,c),tn(async()=>{var x;try{await((x=w.handleLLMStart)==null?void 0:x.call(w,n,[p],y,this._parentRunId,o,this.tags,this.metadata,c))}catch(A){if((w.raiseError?console.error:console.warn)(`Error in handler ${w.constructor.name}, handleLLMStart: ${A}`),w.raiseError)throw A}},w.awaitHandlers)})),new Z_(y,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(n,r,s=void 0,a=void 0,o=void 0,u=void 0,d=void 0,c=void 0){return Promise.all(r.map(async(p,m)=>{const y=m===0&&s?s:Dn();return await Promise.all(this.handlers.map(w=>{if(!w.ignoreLLM)return ko(w)&&w._createRunForChatModelStart(n,[p],y,this._parentRunId,o,this.tags,this.metadata,c),tn(async()=>{var x,A;try{if(w.handleChatModelStart)await((x=w.handleChatModelStart)==null?void 0:x.call(w,n,[p],y,this._parentRunId,o,this.tags,this.metadata,c));else if(w.handleLLMStart){const E=BP(p);await((A=w.handleLLMStart)==null?void 0:A.call(w,n,[E],y,this._parentRunId,o,this.tags,this.metadata,c))}}catch(E){if((w.raiseError?console.error:console.warn)(`Error in handler ${w.constructor.name}, handleLLMStart: ${E}`),w.raiseError)throw E}},w.awaitHandlers)})),new Z_(y,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(n,r,s=Dn(),a=void 0,o=void 0,u=void 0,d=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreChain)return ko(c)&&c._createRunForChainStart(n,r,s,this._parentRunId,this.tags,this.metadata,a,d),tn(async()=>{var p;try{await((p=c.handleChainStart)==null?void 0:p.call(c,n,r,s,this._parentRunId,this.tags,this.metadata,a,d))}catch(m){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleChainStart: ${m}`),c.raiseError)throw m}},c.awaitHandlers)})),new wM(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(n,r,s=Dn(),a=void 0,o=void 0,u=void 0,d=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreAgent)return ko(c)&&c._createRunForToolStart(n,r,s,this._parentRunId,this.tags,this.metadata,d),tn(async()=>{var p;try{await((p=c.handleToolStart)==null?void 0:p.call(c,n,r,s,this._parentRunId,this.tags,this.metadata,d))}catch(m){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleToolStart: ${m}`),c.raiseError)throw m}},c.awaitHandlers)})),new bM(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(n,r,s=Dn(),a=void 0,o=void 0,u=void 0,d=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreRetriever)return ko(c)&&c._createRunForRetrieverStart(n,r,s,this._parentRunId,this.tags,this.metadata,d),tn(async()=>{var p;try{await((p=c.handleRetrieverStart)==null?void 0:p.call(c,n,r,s,this._parentRunId,this.tags,this.metadata,d))}catch(m){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${m}`),c.raiseError)throw m}},c.awaitHandlers)})),new vM(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(n,r,s,a,o){await Promise.all(this.handlers.map(u=>tn(async()=>{var d;if(!u.ignoreCustomEvent)try{await((d=u.handleCustomEvent)==null?void 0:d.call(u,n,r,s,this.tags,this.metadata))}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleCustomEvent: ${c}`),u.raiseError)throw c}},u.awaitHandlers)))}addHandler(n,r=!0){this.handlers.push(n),r&&this.inheritableHandlers.push(n)}removeHandler(n){this.handlers=this.handlers.filter(r=>r!==n),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==n)}setHandlers(n,r=!0){this.handlers=[],this.inheritableHandlers=[];for(const s of n)this.addHandler(s,r)}addTags(n,r=!0){this.removeTags(n),this.tags.push(...n),r&&this.inheritableTags.push(...n)}removeTags(n){this.tags=this.tags.filter(r=>!n.includes(r)),this.inheritableTags=this.inheritableTags.filter(r=>!n.includes(r))}addMetadata(n,r=!0){this.metadata={...this.metadata,...n},r&&(this.inheritableMetadata={...this.inheritableMetadata,...n})}removeMetadata(n){for(const r of Object.keys(n))delete this.metadata[r],delete this.inheritableMetadata[r]}copy(n=[],r=!0){const s=new xu(this._parentRunId);for(const a of this.handlers){const o=this.inheritableHandlers.includes(a);s.addHandler(a,o)}for(const a of this.tags){const o=this.inheritableTags.includes(a);s.addTags([a],o)}for(const a of Object.keys(this.metadata)){const o=Object.keys(this.inheritableMetadata).includes(a);s.addMetadata({[a]:this.metadata[a]},o)}for(const a of n)s.handlers.filter(o=>o.name==="console_callback_handler").some(o=>o.name===a.name)||s.addHandler(a,r);return s}static fromHandlers(n){class r extends hc{constructor(){super();z(this,"name",Dn());Object.assign(this,n)}}const s=new this;return s.addHandler(new r),s}static configure(n,r,s,a,o,u,d){return this._configureSync(n,r,s,a,o,u,d)}static _configureSync(n,r,s,a,o,u,d){var w;let c;(n||r)&&(Array.isArray(n)||!n?(c=new xu,c.setHandlers((n==null?void 0:n.map(Wu))??[],!0)):c=n,c=c.copy(Array.isArray(r)?r.map(Wu):r==null?void 0:r.handlers,!1));const p=Ri("LANGCHAIN_VERBOSE")==="true"||(d==null?void 0:d.verbose),m=((w=wf.getTraceableRunTree())==null?void 0:w.tracingEnabled)||o9(),y=m||(Ri("LANGCHAIN_TRACING")??!1);if(p||y){if(c||(c=new xu),p&&!c.handlers.some(x=>x.name===W_.prototype.name)){const x=new W_;c.addHandler(x,!0)}if(y&&!c.handlers.some(x=>x.name==="langchain_tracer")&&m){const x=new wf;c.addHandler(x,!0)}if(m){const x=wf.getTraceableRunTree();if(x&&c._parentRunId===void 0){c._parentRunId=x.id;const A=c.handlers.find(E=>E.name==="langchain_tracer");A==null||A.updateFromRunTree(x)}}}for(const{contextVar:x,inheritable:A=!0,handlerClass:E,envVar:C}of u9()){const D=C&&Ri(C)==="true"&&E;let O;const T=x!==void 0?yM(x):void 0;T&&KP(T)?O=T:D&&(O=new E({})),O!==void 0&&(c||(c=new xu),c.handlers.some(I=>I.name===O.name)||c.addHandler(O,A))}return(s||a)&&c&&(c.addTags(s??[]),c.addTags(a??[],!1)),(o||u)&&c&&(c.addMetadata(o??{}),c.addMetadata(u??{},!1)),c}};function Wu(t){return"name"in t?t:hc.fromMethods(t)}var SM=class{getStore(){}run(t,e){return e()}enterWith(t){}};const d9=new SM,kI=Symbol.for("lc:child_config");var f9=class{getInstance(){return Ku()??d9}getRunnableConfig(){var e,n;return(n=(e=this.getInstance().getStore())==null?void 0:e.extra)==null?void 0:n[kI]}runWithConfig(t,e,n){var c;const r=Ja._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=this.getInstance(),a=s.getStore(),o=r==null?void 0:r.getParentRunId(),u=(c=r==null?void 0:r.handlers)==null?void 0:c.find(p=>(p==null?void 0:p.name)==="langchain_tracer");let d;return u&&o?d=u.getRunTreeWithTracingConfig(o):n||(d=new Vn({name:"<runnable_lambda>",tracingEnabled:!1})),d&&(d.extra={...d.extra,[kI]:t}),a!==void 0&&a[Ou]!==void 0&&(d===void 0&&(d={}),d[Ou]=a[Ou]),s.run(d,e)}initializeGlobalInstance(t){Ku()===void 0&&n9(t)}};const qr=new f9;var p9={};Ft(p9,{AsyncLocalStorageProviderSingleton:()=>qr,MockAsyncLocalStorage:()=>SM,_CONTEXT_VARIABLES_KEY:()=>Ou});const $y=25;async function Br(t){return Ja._configureSync(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata)}function X_(...t){const e={};for(const n of t.filter(r=>!!r))for(const r of Object.keys(n))if(r==="metadata")e[r]={...e[r],...n[r]};else if(r==="tags"){const s=e[r]??[];e[r]=[...new Set(s.concat(n[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...n[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=n.timeout:n.timeout!==void 0&&(e.timeout=Math.min(e.timeout,n.timeout));else if(r==="signal")e.signal===void 0?e.signal=n.signal:n.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,n.signal]):e.signal=n.signal);else if(r==="callbacks"){const s=e.callbacks,a=n.callbacks;if(Array.isArray(a))if(!s)e.callbacks=a;else if(Array.isArray(s))e.callbacks=s.concat(a);else{const o=s.copy();for(const u of a)o.addHandler(Wu(u),!0);e.callbacks=o}else if(a)if(!s)e.callbacks=a;else if(Array.isArray(s)){const o=a.copy();for(const u of s)o.addHandler(Wu(u),!0);e.callbacks=o}else e.callbacks=new Ja(a._parentRunId,{handlers:s.handlers.concat(a.handlers),inheritableHandlers:s.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(a.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(a.inheritableTags))),metadata:{...s.metadata,...a.metadata}})}else{const s=r;e[s]=n[s]??e[s]}return e}const h9=new Set(["string","number","boolean"]);function Et(t){var r;const e=qr.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:a,...o}=e;n=Object.entries(o).reduce((u,[d,c])=>(c!==void 0&&(u[d]=c),u),n)}if(t&&(n=Object.entries(t).reduce((s,[a,o])=>(o!==void 0&&(s[a]=o),s),n)),n!=null&&n.configurable)for(const s of Object.keys(n.configurable))h9.has(typeof n.configurable[s])&&!((r=n.metadata)!=null&&r[s])&&(n.metadata||(n.metadata={}),n.metadata[s]=n.configurable[s]);if(n.timeout!==void 0){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(n.timeout);n.signal!==void 0?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,s])):n.signal=s,delete n.timeout}return n}function yn(t={},{callbacks:e,maxConcurrency:n,recursionLimit:r,runName:s,configurable:a,runId:o}={}){const u=Et(t);return e!==void 0&&(delete u.runName,u.callbacks=e),r!==void 0&&(u.recursionLimit=r),n!==void 0&&(u.maxConcurrency=n),s!==void 0&&(u.runName=s),a!==void 0&&(u.configurable={...u.configurable,...a}),o!==void 0&&delete u.runId,u}function Ba(t){return t?{configurable:t.configurable,recursionLimit:t.recursionLimit,callbacks:t.callbacks,tags:t.tags,metadata:t.metadata,maxConcurrency:t.maxConcurrency,timeout:t.timeout,signal:t.signal}:void 0}async function qa(t,e){if(e===void 0)return t;let n;return Promise.race([t.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,s)=>{n=()=>{s(Zu(e))},e.addEventListener("abort",n),e.aborted&&s(Zu(e))})]).finally(()=>e.removeEventListener("abort",n))}function Zu(t){return(t==null?void 0:t.reason)instanceof Error?t.reason:typeof(t==null?void 0:t.reason)=="string"?new Error(t.reason):new Error("Aborted")}function Mp(t,e,n){function r(u,d){var c;Object.defineProperty(u,"_zod",{value:u._zod??{},enumerable:!1}),(c=u._zod).traits??(c.traits=new Set),u._zod.traits.add(t),e(u,d);for(const p in o.prototype)p in u||Object.defineProperty(u,p,{value:o.prototype[p].bind(u)});u._zod.constr=o,u._zod.def=d}const s=(n==null?void 0:n.Parent)??Object;class a extends s{}Object.defineProperty(a,"name",{value:t});function o(u){var d;const c=n!=null&&n.Parent?new a:this;r(c,u),(d=c._zod).deferred??(d.deferred=[]);for(const p of c._zod.deferred)p();return c}return Object.defineProperty(o,"init",{value:r}),Object.defineProperty(o,Symbol.hasInstance,{value:u=>{var d,c;return n!=null&&n.Parent&&u instanceof n.Parent?!0:(c=(d=u==null?void 0:u._zod)==null?void 0:d.traits)==null?void 0:c.has(t)}}),Object.defineProperty(o,"name",{value:t}),o}class Q_ extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const m9={};function Mv(t){return m9}function g9(t){const e=Object.values(t).filter(r=>typeof r=="number");return Object.entries(t).filter(([r,s])=>e.indexOf(+r)===-1).map(([r,s])=>s)}function y9(t,e){return typeof e=="bigint"?e.toString():e}const _9=Error.captureStackTrace?Error.captureStackTrace:(...t)=>{};function Yf(t,e,n){const r=new t._zod.constr(e??t._zod.def);return(!e||n!=null&&n.parent)&&(r._zod.parent=t),r}function v9(t){return{}}function Uy(t,e=0){var n;for(let r=e;r<t.issues.length;r++)if(((n=t.issues[r])==null?void 0:n.continue)!==!0)return!0;return!1}function rf(t){return typeof t=="string"?t:t==null?void 0:t.message}function kv(t,e,n){var s,a,o,u,d,c;const r={...t,path:t.path??[]};if(!t.message){const p=rf((o=(a=(s=t.inst)==null?void 0:s._zod.def)==null?void 0:a.error)==null?void 0:o.call(a,t))??rf((u=e==null?void 0:e.error)==null?void 0:u.call(e,t))??rf((d=n.customError)==null?void 0:d.call(n,t))??rf((c=n.localeError)==null?void 0:c.call(n,t))??"Invalid input";r.message=p}return delete r.inst,delete r.continue,e!=null&&e.reportInput||delete r.input,r}const xM=(t,e)=>{t.name="$ZodError",Object.defineProperty(t,"_zod",{value:t._zod,enumerable:!1}),Object.defineProperty(t,"issues",{value:e,enumerable:!1}),Object.defineProperty(t,"message",{get(){return JSON.stringify(e,y9,2)},enumerable:!0}),Object.defineProperty(t,"toString",{value:()=>t.message,enumerable:!1})},w9=Mp("$ZodError",xM),Ov=Mp("$ZodError",xM,{Parent:Error});function b9(t){const e=[];for(const n of t)typeof n=="number"?e.push(`[${n}]`):typeof n=="symbol"?e.push(`[${JSON.stringify(String(n))}]`):/[^\w$]/.test(n)?e.push(`[${JSON.stringify(n)}]`):(e.length&&e.push("."),e.push(n));return e.join("")}function S9(t){var r;const e=[],n=[...t.issues].sort((s,a)=>s.path.length-a.path.length);for(const s of n)e.push(` ${s.message}`),(r=s.path)!=null&&r.length&&e.push(`   at ${b9(s.path)}`);return e.join(`
`)}const x9=t=>async(e,n,r,s)=>{const a=r?Object.assign(r,{async:!0}):{async:!0};let o=e._zod.run({value:n,issues:[]},a);if(o instanceof Promise&&(o=await o),o.issues.length){const u=new((s==null?void 0:s.Err)??t)(o.issues.map(d=>kv(d,a,Mv())));throw _9(u,s==null?void 0:s.callee),u}return o.value},T9=x9(Ov),A9=t=>(e,n,r)=>{const s=r?{...r,async:!1}:{async:!1},a=e._zod.run({value:n,issues:[]},s);if(a instanceof Promise)throw new Q_;return a.issues.length?{success:!1,error:new(t??w9)(a.issues.map(o=>kv(o,s,Mv())))}:{success:!0,data:a.value}},E9=A9(Ov),C9=t=>async(e,n,r)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let a=e._zod.run({value:n,issues:[]},s);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new t(a.issues.map(o=>kv(o,s,Mv())))}:{success:!0,data:a.value}},I9=C9(Ov),R9={major:4,minor:0,patch:0},N9=Mp("$ZodType",(t,e)=>{var s;var n;t??(t={}),t._zod.def=e,t._zod.bag=t._zod.bag||{},t._zod.version=R9;const r=[...t._zod.def.checks??[]];t._zod.traits.has("$ZodCheck")&&r.unshift(t);for(const a of r)for(const o of a._zod.onattach)o(t);if(r.length===0)(n=t._zod).deferred??(n.deferred=[]),(s=t._zod.deferred)==null||s.push(()=>{t._zod.run=t._zod.parse});else{const a=(o,u,d)=>{let c=Uy(o),p;for(const m of u){if(m._zod.def.when){if(!m._zod.def.when(o))continue}else if(c)continue;const y=o.issues.length,w=m._zod.check(o);if(w instanceof Promise&&(d==null?void 0:d.async)===!1)throw new Q_;if(p||w instanceof Promise)p=(p??Promise.resolve()).then(async()=>{await w,o.issues.length!==y&&(c||(c=Uy(o,y)))});else{if(o.issues.length===y)continue;c||(c=Uy(o,y))}}return p?p.then(()=>o):o};t._zod.run=(o,u)=>{const d=t._zod.parse(o,u);if(d instanceof Promise){if(u.async===!1)throw new Q_;return d.then(c=>a(c,r,u))}return a(d,r,u)}}t["~standard"]={validate:a=>{var o;try{const u=E9(t,a);return u.success?{value:u.data}:{issues:(o=u.error)==null?void 0:o.issues}}catch{return I9(t,a).then(d=>{var c;return d.success?{value:d.data}:{issues:(c=d.error)==null?void 0:c.issues}})}},vendor:"zod",version:1}}),P9=Mp("$ZodNever",(t,e)=>{N9.init(t,e),t._zod.parse=(n,r)=>(n.issues.push({expected:"never",code:"invalid_type",input:n.value,inst:t}),n)});class TM{constructor(){this._map=new Map,this._idmap=new Map}add(e,...n){const r=n[0];if(this._map.set(e,r),r&&typeof r=="object"&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const n=this._map.get(e);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(e),this}get(e){const n=e._zod.parent;if(n){const r={...this.get(n)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function M9(){return new TM}const ka=M9();function k9(t,e){return new t({type:"never",...v9()})}class OI{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??ka,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,n={path:[],schemaPath:[]}){var m,y,w;var r;const s=e._zod.def,a={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},o=this.seen.get(e);if(o)return o.count++,n.schemaPath.includes(e)&&(o.cycle=n.path),o.schema;const u={schema:{},count:1,cycle:void 0,path:n.path};this.seen.set(e,u);const d=(y=(m=e._zod).toJSONSchema)==null?void 0:y.call(m);if(d)u.schema=d;else{const x={...n,schemaPath:[...n.schemaPath,e],path:n.path},A=e._zod.parent;if(A)u.ref=A,this.process(A,x),this.seen.get(A).isParent=!0;else{const E=u.schema;switch(s.type){case"string":{const C=E;C.type="string";const{minimum:D,maximum:O,format:T,patterns:I,contentEncoding:M}=e._zod.bag;if(typeof D=="number"&&(C.minLength=D),typeof O=="number"&&(C.maxLength=O),T&&(C.format=a[T]??T,C.format===""&&delete C.format),M&&(C.contentEncoding=M),I&&I.size>0){const N=[...I];N.length===1?C.pattern=N[0].source:N.length>1&&(u.schema.allOf=[...N.map(P=>({...this.target==="draft-7"?{type:"string"}:{},pattern:P.source}))])}break}case"number":{const C=E,{minimum:D,maximum:O,format:T,multipleOf:I,exclusiveMaximum:M,exclusiveMinimum:N}=e._zod.bag;typeof T=="string"&&T.includes("int")?C.type="integer":C.type="number",typeof N=="number"&&(C.exclusiveMinimum=N),typeof D=="number"&&(C.minimum=D,typeof N=="number"&&(N>=D?delete C.minimum:delete C.exclusiveMinimum)),typeof M=="number"&&(C.exclusiveMaximum=M),typeof O=="number"&&(C.maximum=O,typeof M=="number"&&(M<=O?delete C.maximum:delete C.exclusiveMaximum)),typeof I=="number"&&(C.multipleOf=I);break}case"boolean":{const C=E;C.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{E.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{E.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const C=E,{minimum:D,maximum:O}=e._zod.bag;typeof D=="number"&&(C.minItems=D),typeof O=="number"&&(C.maxItems=O),C.type="array",C.items=this.process(s.element,{...x,path:[...x.path,"items"]});break}case"object":{const C=E;C.type="object",C.properties={};const D=s.shape;for(const I in D)C.properties[I]=this.process(D[I],{...x,path:[...x.path,"properties",I]});const O=new Set(Object.keys(D)),T=new Set([...O].filter(I=>{const M=s.shape[I]._zod;return this.io==="input"?M.optin===void 0:M.optout===void 0}));T.size>0&&(C.required=Array.from(T)),((w=s.catchall)==null?void 0:w._zod.def.type)==="never"?C.additionalProperties=!1:s.catchall?s.catchall&&(C.additionalProperties=this.process(s.catchall,{...x,path:[...x.path,"additionalProperties"]})):this.io==="output"&&(C.additionalProperties=!1);break}case"union":{const C=E;C.anyOf=s.options.map((D,O)=>this.process(D,{...x,path:[...x.path,"anyOf",O]}));break}case"intersection":{const C=E,D=this.process(s.left,{...x,path:[...x.path,"allOf",0]}),O=this.process(s.right,{...x,path:[...x.path,"allOf",1]}),T=M=>"allOf"in M&&Object.keys(M).length===1,I=[...T(D)?D.allOf:[D],...T(O)?O.allOf:[O]];C.allOf=I;break}case"tuple":{const C=E;C.type="array";const D=s.items.map((I,M)=>this.process(I,{...x,path:[...x.path,"prefixItems",M]}));if(this.target==="draft-2020-12"?C.prefixItems=D:C.items=D,s.rest){const I=this.process(s.rest,{...x,path:[...x.path,"items"]});this.target==="draft-2020-12"?C.items=I:C.additionalItems=I}s.rest&&(C.items=this.process(s.rest,{...x,path:[...x.path,"items"]}));const{minimum:O,maximum:T}=e._zod.bag;typeof O=="number"&&(C.minItems=O),typeof T=="number"&&(C.maxItems=T);break}case"record":{const C=E;C.type="object",C.propertyNames=this.process(s.keyType,{...x,path:[...x.path,"propertyNames"]}),C.additionalProperties=this.process(s.valueType,{...x,path:[...x.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const C=E,D=g9(s.entries);D.every(O=>typeof O=="number")&&(C.type="number"),D.every(O=>typeof O=="string")&&(C.type="string"),C.enum=D;break}case"literal":{const C=E,D=[];for(const O of s.values)if(O===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof O=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");D.push(Number(O))}else D.push(O);if(D.length!==0)if(D.length===1){const O=D[0];C.type=O===null?"null":typeof O,C.const=O}else D.every(O=>typeof O=="number")&&(C.type="number"),D.every(O=>typeof O=="string")&&(C.type="string"),D.every(O=>typeof O=="boolean")&&(C.type="string"),D.every(O=>O===null)&&(C.type="null"),C.enum=D;break}case"file":{const C=E,D={type:"string",format:"binary",contentEncoding:"binary"},{minimum:O,maximum:T,mime:I}=e._zod.bag;O!==void 0&&(D.minLength=O),T!==void 0&&(D.maxLength=T),I?I.length===1?(D.contentMediaType=I[0],Object.assign(C,D)):C.anyOf=I.map(M=>({...D,contentMediaType:M})):Object.assign(C,D);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const C=this.process(s.innerType,x);E.anyOf=[C,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,x),u.ref=s.innerType;break}case"success":{const C=E;C.type="boolean";break}case"default":{this.process(s.innerType,x),u.ref=s.innerType,E.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,x),u.ref=s.innerType,this.io==="input"&&(E._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,x),u.ref=s.innerType;let C;try{C=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}E.default=C;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const C=E,D=e._zod.pattern;if(!D)throw new Error("Pattern not found in template literal");C.type="string",C.pattern=D.source;break}case"pipe":{const C=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(C,x),u.ref=C;break}case"readonly":{this.process(s.innerType,x),u.ref=s.innerType,E.readOnly=!0;break}case"promise":{this.process(s.innerType,x),u.ref=s.innerType;break}case"optional":{this.process(s.innerType,x),u.ref=s.innerType;break}case"lazy":{const C=e._zod.innerType;this.process(C,x),u.ref=C;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const c=this.metadataRegistry.get(e);return c&&Object.assign(u.schema,c),this.io==="input"&&ln(e)&&(delete u.schema.examples,delete u.schema.default),this.io==="input"&&u.schema._prefault&&((r=u.schema).default??(r.default=u.schema._prefault)),delete u.schema._prefault,this.seen.get(e).schema}emit(e,n){var p,m,y,w,x,A;const r={cycles:(n==null?void 0:n.cycles)??"ref",reused:(n==null?void 0:n.reused)??"inline",external:(n==null?void 0:n.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const a=E=>{var I;const C=this.target==="draft-2020-12"?"$defs":"definitions";if(r.external){const M=(I=r.external.registry.get(E[0]))==null?void 0:I.id,N=r.external.uri??(k=>k);if(M)return{ref:N(M)};const P=E[1].defId??E[1].schema.id??`schema${this.counter++}`;return E[1].defId=P,{defId:P,ref:`${N("__shared")}#/${C}/${P}`}}if(E[1]===s)return{ref:"#"};const O=`#/${C}/`,T=E[1].schema.id??`__schema${this.counter++}`;return{defId:T,ref:O+T}},o=E=>{if(E[1].schema.$ref)return;const C=E[1],{ref:D,defId:O}=a(E);C.def={...C.schema},O&&(C.defId=O);const T=C.schema;for(const I in T)delete T[I];T.$ref=D};if(r.cycles==="throw")for(const E of this.seen.entries()){const C=E[1];if(C.cycle)throw new Error(`Cycle detected: #/${(p=C.cycle)==null?void 0:p.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const E of this.seen.entries()){const C=E[1];if(e===E[0]){o(E);continue}if(r.external){const O=(m=r.external.registry.get(E[0]))==null?void 0:m.id;if(e!==E[0]&&O){o(E);continue}}if((y=this.metadataRegistry.get(E[0]))==null?void 0:y.id){o(E);continue}if(C.cycle){o(E);continue}if(C.count>1&&r.reused==="ref"){o(E);continue}}const u=(E,C)=>{const D=this.seen.get(E),O=D.def??D.schema,T={...O};if(D.ref===null)return;const I=D.ref;if(D.ref=null,I){u(I,C);const M=this.seen.get(I).schema;M.$ref&&C.target==="draft-7"?(O.allOf=O.allOf??[],O.allOf.push(M)):(Object.assign(O,M),Object.assign(O,T))}D.isParent||this.override({zodSchema:E,jsonSchema:O,path:D.path??[]})};for(const E of[...this.seen.entries()].reverse())u(E[0],{target:this.target});const d={};if(this.target==="draft-2020-12"?d.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?d.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),(w=r.external)!=null&&w.uri){const E=(x=r.external.registry.get(e))==null?void 0:x.id;if(!E)throw new Error("Schema is missing an `id` property");d.$id=r.external.uri(E)}Object.assign(d,s.def);const c=((A=r.external)==null?void 0:A.defs)??{};for(const E of this.seen.entries()){const C=E[1];C.def&&C.defId&&(c[C.defId]=C.def)}r.external||Object.keys(c).length>0&&(this.target==="draft-2020-12"?d.$defs=c:d.definitions=c);try{return JSON.parse(JSON.stringify(d))}catch{throw new Error("Error converting schema to JSON.")}}}function DI(t,e){if(t instanceof TM){const r=new OI(e),s={};for(const u of t._idmap.entries()){const[d,c]=u;r.process(c)}const a={},o={registry:t,uri:e==null?void 0:e.uri,defs:s};for(const u of t._idmap.entries()){const[d,c]=u;a[d]=r.emit(c,{...e,external:o})}if(Object.keys(s).length>0){const u=r.target==="draft-2020-12"?"$defs":"definitions";a.__shared={[u]:s}}return{schemas:a}}const n=new OI(e);return n.process(t),n.emit(t,e)}function ln(t,e){const n=e??{seen:new Set};if(n.seen.has(t))return!1;n.seen.add(t);const s=t._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return ln(s.element,n);case"object":{for(const a in s.shape)if(ln(s.shape[a],n))return!0;return!1}case"union":{for(const a of s.options)if(ln(a,n))return!0;return!1}case"intersection":return ln(s.left,n)||ln(s.right,n);case"tuple":{for(const a of s.items)if(ln(a,n))return!0;return!!(s.rest&&ln(s.rest,n))}case"record":return ln(s.keyType,n)||ln(s.valueType,n);case"map":return ln(s.keyType,n)||ln(s.valueType,n);case"set":return ln(s.valueType,n);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return ln(s.innerType,n);case"lazy":return ln(s.getter(),n);case"default":return ln(s.innerType,n);case"prefault":return ln(s.innerType,n);case"custom":return!1;case"transform":return!0;case"pipe":return ln(s.in,n)||ln(s.out,n);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${s.type}`)}function Ys(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_zod"in e))return!1;const n=e._zod;return typeof n=="object"&&n!==null&&"def"in n}function Ya(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!("_def"in e)||"_zod"in e)return!1;const n=e._def;return typeof n=="object"&&n!=null&&"typeName"in n}function Dv(t){return!t||typeof t!="object"||Array.isArray(t)?!1:!!(Ys(t)||Ya(t))}async function AM(t,e){if(Ys(t))return await T9(t,e);if(Ya(t))return await t.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function O9(t){var e;if(Ys(t))return(e=ka.get(t))==null?void 0:e.description;if(Ya(t)||"description"in t&&typeof t.description=="string")return t.description}function EM(t){return Dv(t)?Ya(t)?t._def.typeName==="ZodString":Ys(t)?t._zod.def.type==="string":!1:!1}function Du(t){return Ys(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="object":!1}function CM(t){return Ys(t)?typeof t=="object"&&t!==null&&"_zod"in t&&typeof t._zod=="object"&&t._zod!==null&&"def"in t._zod&&typeof t._zod.def=="object"&&t._zod.def!==null&&"type"in t._zod.def&&t._zod.def.type==="array":!1}function e0(t,e=!1){if(Ya(t))return t.strict();if(Du(t)){const n=t._zod.def.shape;if(e)for(const[a,o]of Object.entries(t._zod.def.shape)){if(Du(o)){const d=e0(o,e);n[a]=d}else if(CM(o)){let d=o._zod.def.element;Du(d)&&(d=e0(d,e)),n[a]=Yf(o,{...o._zod.def,element:d})}else n[a]=o;const u=ka.get(o);u&&ka.add(n[a],u)}const r=Yf(t,{...t._zod.def,shape:n,catchall:k9(P9)}),s=ka.get(t);return s&&ka.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function D9(t){return Ya(t)&&"typeName"in t._def&&t._def.typeName==="ZodEffects"}function L9(t){return Ys(t)&&t._zod.def.type==="pipe"}function Tu(t,e=!1){if(Ya(t))return D9(t)?Tu(t._def.schema,e):t;if(Ys(t)){let n=t;if(L9(t)&&(n=Tu(t._zod.def.in,e)),e){if(Du(n)){const s=n._zod.def.shape;for(const[a,o]of Object.entries(n._zod.def.shape))s[a]=Tu(o,e);n=Yf(n,{...n._zod.def,shape:s})}else if(CM(n)){const s=Tu(n._zod.def.element,e);n=Yf(n,{...n._zod.def,element:s})}}const r=ka.get(t);return r&&ka.add(n,r),n}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}const $9=Symbol("Let zodToJsonSchema decide on which parser to use"),U9={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},F9=t=>({...U9,...t}),B9=t=>{const e=F9(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}},IM=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")};function ur(t){if(t.target!=="openAi")return{};const e=[...t.basePath,t.definitionPath,t.openAiAnyTypeName];return t.flags.hasReferencedOpenAiAnyType=!0,{$ref:t.$refStrategy==="relative"?IM(e,t.currentPath):e.join("/")}}function RM(t,e,n,r){r!=null&&r.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function bt(t,e,n,r,s){t[e]=n,RM(t,e,r,s)}function q9(t,e){var r,s,a;const n={type:"array"};return(r=t.type)!=null&&r._def&&((a=(s=t.type)==null?void 0:s._def)==null?void 0:a.typeName)!==me.ZodAny&&(n.items=yt(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&bt(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&bt(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(bt(n,"minItems",t.exactLength.value,t.exactLength.message,e),bt(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function G9(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?bt(n,"minimum",r.value,r.message,e):bt(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),bt(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?bt(n,"maximum",r.value,r.message,e):bt(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),bt(n,"maximum",r.value,r.message,e));break;case"multipleOf":bt(n,"multipleOf",r.value,r.message,e);break}return n}function H9(){return{type:"boolean"}}function NM(t,e){return yt(t.type._def,e)}const z9=(t,e)=>yt(t.innerType._def,e);function PM(t,e,n){const r=n??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(s=>PM(t,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return j9(t,e)}}const j9=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const r of t.checks)switch(r.kind){case"min":bt(n,"minimum",r.value,r.message,e);break;case"max":bt(n,"maximum",r.value,r.message,e);break}return n};function V9(t,e){return{...yt(t.innerType._def,e),default:t.defaultValue()}}function J9(t,e){return e.effectStrategy==="input"?yt(t.schema._def,e):ur(e)}function Y9(t){return{type:"string",enum:Array.from(t.values)}}const K9=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function W9(t,e){const n=[yt(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),yt(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(a=>{if(K9(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let o=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:u,...d}=a;o=d}else r=void 0;s.push(o)}}),s.length?{allOf:s,...r}:void 0}function Z9(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let Fy;const Pr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Fy===void 0&&(Fy=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Fy),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function MM(t,e){const n={type:"string"};if(t.checks)for(const r of t.checks)switch(r.kind){case"min":bt(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e);break;case"max":bt(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Mr(n,"email",r.message,e);break;case"format:idn-email":Mr(n,"idn-email",r.message,e);break;case"pattern:zod":On(n,Pr.email,r.message,e);break}break;case"url":Mr(n,"uri",r.message,e);break;case"uuid":Mr(n,"uuid",r.message,e);break;case"regex":On(n,r.regex,r.message,e);break;case"cuid":On(n,Pr.cuid,r.message,e);break;case"cuid2":On(n,Pr.cuid2,r.message,e);break;case"startsWith":On(n,RegExp(`^${By(r.value,e)}`),r.message,e);break;case"endsWith":On(n,RegExp(`${By(r.value,e)}$`),r.message,e);break;case"datetime":Mr(n,"date-time",r.message,e);break;case"date":Mr(n,"date",r.message,e);break;case"time":Mr(n,"time",r.message,e);break;case"duration":Mr(n,"duration",r.message,e);break;case"length":bt(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e),bt(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"includes":On(n,RegExp(By(r.value,e)),r.message,e);break;case"ip":r.version!=="v6"&&Mr(n,"ipv4",r.message,e),r.version!=="v4"&&Mr(n,"ipv6",r.message,e);break;case"base64url":On(n,Pr.base64url,r.message,e);break;case"jwt":On(n,Pr.jwt,r.message,e);break;case"cidr":r.version!=="v6"&&On(n,Pr.ipv4Cidr,r.message,e),r.version!=="v4"&&On(n,Pr.ipv6Cidr,r.message,e);break;case"emoji":On(n,Pr.emoji(),r.message,e);break;case"ulid":On(n,Pr.ulid,r.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":Mr(n,"binary",r.message,e);break;case"contentEncoding:base64":bt(n,"contentEncoding","base64",r.message,e);break;case"pattern:zod":On(n,Pr.base64,r.message,e);break}break;case"nanoid":On(n,Pr.nanoid,r.message,e);break}return n}function By(t,e){return e.patternStrategy==="escape"?Q9(t):t}const X9=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Q9(t){let e="";for(let n=0;n<t.length;n++)X9.has(t[n])||(e+="\\"),e+=t[n];return e}function Mr(t,e,n,r){var s;t.format||(s=t.anyOf)!=null&&s.some(a=>a.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&r.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&r.errorMessages&&{errorMessage:{format:n}}})):bt(t,"format",e,n,r)}function On(t,e,n,r){var s;t.pattern||(s=t.allOf)!=null&&s.some(a=>a.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&r.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:LI(e,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):bt(t,"pattern",LI(e,r),n,r)}function LI(t,e){var d;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},r=n.i?t.source.toLowerCase():t.source;let s="",a=!1,o=!1,u=!1;for(let c=0;c<r.length;c++){if(a){s+=r[c],a=!1;continue}if(n.i){if(o){if(r[c].match(/[a-z]/)){u?(s+=r[c],s+=`${r[c-2]}-${r[c]}`.toUpperCase(),u=!1):r[c+1]==="-"&&((d=r[c+2])!=null&&d.match(/[a-z]/))?(s+=r[c],u=!0):s+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){s+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(n.m){if(r[c]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){s+=`($|(?=[\r
]))`;continue}}if(n.s&&r[c]==="."){s+=o?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}s+=r[c],r[c]==="\\"?a=!0:o&&r[c]==="]"?o=!1:!o&&r[c]==="["&&(o=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s}function kM(t,e){var r,s,a,o,u,d;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=t.keyType)==null?void 0:r._def.typeName)===me.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((c,p)=>({...c,[p]:yt(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",p]})??ur(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const n={type:"object",additionalProperties:yt(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return n;if(((s=t.keyType)==null?void 0:s._def.typeName)===me.ZodString&&((a=t.keyType._def.checks)!=null&&a.length)){const{type:c,...p}=MM(t.keyType._def,e);return{...n,propertyNames:p}}else{if(((o=t.keyType)==null?void 0:o._def.typeName)===me.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};if(((u=t.keyType)==null?void 0:u._def.typeName)===me.ZodBranded&&t.keyType._def.type._def.typeName===me.ZodString&&((d=t.keyType._def.type._def.checks)!=null&&d.length)){const{type:c,...p}=NM(t.keyType._def,e);return{...n,propertyNames:p}}}return n}function e8(t,e){if(e.mapStrategy==="record")return kM(t,e);const n=yt(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||ur(e),r=yt(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||ur(e);return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function t8(t){const e=t.values,r=Object.keys(t.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function n8(t){return t.target==="openAi"?void 0:{not:ur({...t,currentPath:[...t.currentPath,"not"]})}}function r8(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Kf={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function s8(t,e){if(e.target==="openApi3")return $I(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(r=>r._def.typeName in Kf&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((s,a)=>{const o=Kf[a._def.typeName];return o&&!s.includes(o)?[...s,o]:s},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((s,a)=>{const o=typeof a._def.value;switch(o){case"string":case"number":case"boolean":return[...s,o];case"bigint":return[...s,"integer"];case"object":return a._def.value===null?[...s,"null"]:s;case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===n.length){const s=r.filter((a,o,u)=>u.indexOf(a)===o);return{type:s.length>1?s:s[0],enum:n.reduce((a,o)=>a.includes(o._def.value)?a:[...a,o._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return $I(t,e)}const $I=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((r,s)=>yt(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function a8(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"?{type:Kf[t.innerType._def.typeName],nullable:!0}:{type:[Kf[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=yt(t.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=yt(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function i8(t,e){const n={type:"number"};if(!t.checks)return n;for(const r of t.checks)switch(r.kind){case"int":n.type="integer",RM(n,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?bt(n,"minimum",r.value,r.message,e):bt(n,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(n.exclusiveMinimum=!0),bt(n,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?bt(n,"maximum",r.value,r.message,e):bt(n,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(n.exclusiveMaximum=!0),bt(n,"maximum",r.value,r.message,e));break;case"multipleOf":bt(n,"multipleOf",r.value,r.message,e);break}return n}function o8(t,e){const n=e.target==="openAi",r={type:"object",properties:{}},s=[],a=t.shape();for(const u in a){let d=a[u];if(d===void 0||d._def===void 0)continue;let c=u8(d);c&&n&&(d._def.typeName==="ZodOptional"&&(d=d._def.innerType),d.isNullable()||(d=d.nullable()),c=!1);const p=yt(d._def,{...e,currentPath:[...e.currentPath,"properties",u],propertyPath:[...e.currentPath,"properties",u]});p!==void 0&&(r.properties[u]=p,c||s.push(u))}s.length&&(r.required=s);const o=l8(t,e);return o!==void 0&&(r.additionalProperties=o),r}function l8(t,e){if(t.catchall._def.typeName!=="ZodNever")return yt(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(t.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function u8(t){try{return t.isOptional()}catch{return!0}}const c8=(t,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return yt(t.innerType._def,e);const n=yt(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:ur(e)},n]}:ur(e)},d8=(t,e)=>{if(e.pipeStrategy==="input")return yt(t.in._def,e);if(e.pipeStrategy==="output")return yt(t.out._def,e);const n=yt(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=yt(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(s=>s!==void 0)}};function f8(t,e){return yt(t.type._def,e)}function p8(t,e){const r={type:"array",uniqueItems:!0,items:yt(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&bt(r,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&bt(r,"maxItems",t.maxSize.value,t.maxSize.message,e),r}function h8(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,r)=>yt(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:yt(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,r)=>yt(n._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function m8(t){return{not:ur(t)}}function g8(t){return ur(t)}const y8=(t,e)=>yt(t.innerType._def,e),_8=(t,e,n)=>{switch(e){case me.ZodString:return MM(t,n);case me.ZodNumber:return i8(t,n);case me.ZodObject:return o8(t,n);case me.ZodBigInt:return G9(t,n);case me.ZodBoolean:return H9();case me.ZodDate:return PM(t,n);case me.ZodUndefined:return m8(n);case me.ZodNull:return r8(n);case me.ZodArray:return q9(t,n);case me.ZodUnion:case me.ZodDiscriminatedUnion:return s8(t,n);case me.ZodIntersection:return W9(t,n);case me.ZodTuple:return h8(t,n);case me.ZodRecord:return kM(t,n);case me.ZodLiteral:return Z9(t,n);case me.ZodEnum:return Y9(t);case me.ZodNativeEnum:return t8(t);case me.ZodNullable:return a8(t,n);case me.ZodOptional:return c8(t,n);case me.ZodMap:return e8(t,n);case me.ZodSet:return p8(t,n);case me.ZodLazy:return()=>t.getter()._def;case me.ZodPromise:return f8(t,n);case me.ZodNaN:case me.ZodNever:return n8(n);case me.ZodEffects:return J9(t,n);case me.ZodAny:return ur(n);case me.ZodUnknown:return g8(n);case me.ZodDefault:return V9(t,n);case me.ZodBranded:return NM(t,n);case me.ZodReadonly:return y8(t,n);case me.ZodCatch:return z9(t,n);case me.ZodPipeline:return d8(t,n);case me.ZodFunction:case me.ZodVoid:case me.ZodSymbol:return;default:return(r=>{})()}};function yt(t,e,n=!1){var u;const r=e.seen.get(t);if(e.override){const d=(u=e.override)==null?void 0:u.call(e,t,e,r,n);if(d!==$9)return d}if(r&&!n){const d=v8(r,e);if(d!==void 0)return d}const s={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,s);const a=_8(t,t.typeName,e),o=typeof a=="function"?yt(a(),e):a;if(o&&w8(t,e,o),e.postProcess){const d=e.postProcess(o,t,e);return s.jsonSchema=o,d}return s.jsonSchema=o,o}const v8=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"relative":return{$ref:IM(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((n,r)=>e.currentPath[r]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),ur(e)):e.$refStrategy==="seen"?ur(e):void 0}},w8=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),b8=(t,e)=>{const n=B9(e);let r;const s=yt(t._def,n,!1)??ur(n);n.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[n.openAiAnyTypeName]||(r[n.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:n.$refStrategy==="relative"?"1":[...n.basePath,n.definitionPath,n.openAiAnyTypeName].join("/")}}));const a=r?{...s,[n.definitionPath]:r}:s;return n.target==="jsonSchema7"?a.$schema="http://json-schema.org/draft-07/schema#":(n.target==="jsonSchema2019-09"||n.target==="openAi")&&(a.$schema="https://json-schema.org/draft/2019-09/schema#"),n.target==="openAi"&&("anyOf"in a||"oneOf"in a||"allOf"in a||"type"in a&&Array.isArray(a.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),a};function Ko(t,e){const n=typeof t;if(n!==typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e))return!1;const r=t.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!Ko(t[s],e[s]))return!1;return!0}if(n==="object"){if(!t||!e)return t===e;const r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return!1;for(const o of r)if(!Ko(t[o],e[o]))return!1;return!0}return t===e}function Dr(t){return encodeURI(S8(t))}function S8(t){return t.replace(/~/g,"~0").replace(/\//g,"~1")}const x8={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},T8={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},A8={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let E8=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Oa(t,e=Object.create(null),n=E8,r=""){if(t&&typeof t=="object"&&!Array.isArray(t)){const a=t.$id||t.id;if(a){const o=new URL(a,n.href);o.hash.length>1?e[o.href]=t:(o.hash="",r===""?n=o:Oa(t,e,n))}}else if(t!==!0&&t!==!1)return e;const s=n.href+(r?"#"+r:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=t,t===!0||t===!1)return e;if(t.__absolute_uri__===void 0&&Object.defineProperty(t,"__absolute_uri__",{enumerable:!1,value:s}),t.$ref&&t.__absolute_ref__===void 0){const a=new URL(t.$ref,n.href);a.hash=a.hash,Object.defineProperty(t,"__absolute_ref__",{enumerable:!1,value:a.href})}if(t.$recursiveRef&&t.__absolute_recursive_ref__===void 0){const a=new URL(t.$recursiveRef,n.href);a.hash=a.hash,Object.defineProperty(t,"__absolute_recursive_ref__",{enumerable:!1,value:a.href})}if(t.$anchor){const a=new URL("#"+t.$anchor,n.href);e[a.href]=t}for(let a in t){if(A8[a])continue;const o=`${r}/${Dr(a)}`,u=t[a];if(Array.isArray(u)){if(x8[a]){const d=u.length;for(let c=0;c<d;c++)Oa(u[c],e,n,`${o}/${c}`)}}else if(T8[a])for(let d in u)Oa(u[d],e,n,`${o}/${Dr(d)}`);else Oa(u,e,n,o)}return e}const C8=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,I8=[0,31,28,31,30,31,30,31,31,30,31,30,31],R8=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,N8=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,P8=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,M8=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,k8=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,O8=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,D8=/^(?:\/(?:[^~/]|~0|~1)*)*$/,L8=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,$8=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,U8=t=>{if(t[0]==='"')return!1;const[e,n,...r]=t.split("@");return!e||!n||r.length!==0||e.length>64||n.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(n)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:n.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},F8=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,B8=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,q8=t=>t.length>1&&t.length<80&&(/^P\d+([.,]\d+)?W$/.test(t)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(t)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(t));function es(t){return t.test.bind(t)}const UI={date:OM,time:DM.bind(void 0,!1),"date-time":z8,duration:q8,uri:J8,"uri-reference":es(P8),"uri-template":es(M8),url:es(k8),email:U8,hostname:es(N8),ipv4:es(F8),ipv6:es(B8),regex:K8,uuid:es(O8),"json-pointer":es(D8),"json-pointer-uri-fragment":es(L8),"relative-json-pointer":es($8)};function G8(t){return t%4===0&&(t%100!==0||t%400===0)}function OM(t){const e=t.match(C8);if(!e)return!1;const n=+e[1],r=+e[2],s=+e[3];return r>=1&&r<=12&&s>=1&&s<=(r==2&&G8(n)?29:I8[r])}function DM(t,e){const n=e.match(R8);if(!n)return!1;const r=+n[1],s=+n[2],a=+n[3],o=!!n[5];return(r<=23&&s<=59&&a<=59||r==23&&s==59&&a==60)&&(!t||o)}const H8=/t|\s/i;function z8(t){const e=t.split(H8);return e.length==2&&OM(e[0])&&DM(!0,e[1])}const j8=/\/|:/,V8=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function J8(t){return j8.test(t)&&V8.test(t)}const Y8=/[^\\]\\Z/;function K8(t){if(Y8.test(t))return!1;try{return new RegExp(t,"u"),!0}catch{return!1}}function W8(t){let e=0,n=t.length,r=0,s;for(;r<n;)e++,s=t.charCodeAt(r++),s>=55296&&s<=56319&&r<n&&(s=t.charCodeAt(r),(s&64512)==56320&&r++);return e}function Dt(t,e,n="2019-09",r=Oa(e),s=!0,a=null,o="#",u="#",d=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:o,keyword:"false",keywordLocation:o,error:"False boolean schema."}]};const c=typeof t;let p;switch(c){case"boolean":case"number":case"string":p=c;break;case"object":t===null?p="null":Array.isArray(t)?p="array":p="object";break;default:throw new Error(`Instances of "${c}" type are not supported.`)}const{$ref:m,$recursiveRef:y,$recursiveAnchor:w,type:x,const:A,enum:E,required:C,not:D,anyOf:O,allOf:T,oneOf:I,if:M,then:N,else:P,format:k,properties:$,patternProperties:U,additionalProperties:F,unevaluatedProperties:K,minProperties:j,maxProperties:V,propertyNames:B,dependentRequired:G,dependentSchemas:Z,dependencies:se,prefixItems:le,items:q,additionalItems:W,unevaluatedItems:ee,contains:ce,minContains:ie,maxContains:fe,minItems:Re,maxItems:Ge,uniqueItems:ze,minimum:Ae,maximum:Rt,exclusiveMinimum:je,exclusiveMaximum:dn,multipleOf:ct,minLength:nn,maxLength:rn,pattern:Oe,__absolute_ref__:lt,__absolute_recursive_ref__:Nn}=e,ge=[];if(w===!0&&a===null&&(a=e),y==="#"){const Ee=a===null?r[Nn]:a,Ce=`${u}/$recursiveRef`,_e=Dt(t,a===null?e:a,n,r,s,Ee,o,Ce,d);_e.valid||ge.push({instanceLocation:o,keyword:"$recursiveRef",keywordLocation:Ce,error:"A subschema had errors."},..._e.errors)}if(m!==void 0){const Ce=r[lt||m];if(Ce===void 0){let ye=`Unresolved $ref "${m}".`;throw lt&&lt!==m&&(ye+=`  Absolute URI "${lt}".`),ye+=`
Known schemas:
- ${Object.keys(r).join(`
- `)}`,new Error(ye)}const _e=`${u}/$ref`,ve=Dt(t,Ce,n,r,s,a,o,_e,d);if(ve.valid||ge.push({instanceLocation:o,keyword:"$ref",keywordLocation:_e,error:"A subschema had errors."},...ve.errors),n==="4"||n==="7")return{valid:ge.length===0,errors:ge}}if(Array.isArray(x)){let Ee=x.length,Ce=!1;for(let _e=0;_e<Ee;_e++)if(p===x[_e]||x[_e]==="integer"&&p==="number"&&t%1===0&&t===t){Ce=!0;break}Ce||ge.push({instanceLocation:o,keyword:"type",keywordLocation:`${u}/type`,error:`Instance type "${p}" is invalid. Expected "${x.join('", "')}".`})}else x==="integer"?(p!=="number"||t%1||t!==t)&&ge.push({instanceLocation:o,keyword:"type",keywordLocation:`${u}/type`,error:`Instance type "${p}" is invalid. Expected "${x}".`}):x!==void 0&&p!==x&&ge.push({instanceLocation:o,keyword:"type",keywordLocation:`${u}/type`,error:`Instance type "${p}" is invalid. Expected "${x}".`});if(A!==void 0&&(p==="object"||p==="array"?Ko(t,A)||ge.push({instanceLocation:o,keyword:"const",keywordLocation:`${u}/const`,error:`Instance does not match ${JSON.stringify(A)}.`}):t!==A&&ge.push({instanceLocation:o,keyword:"const",keywordLocation:`${u}/const`,error:`Instance does not match ${JSON.stringify(A)}.`})),E!==void 0&&(p==="object"||p==="array"?E.some(Ee=>Ko(t,Ee))||ge.push({instanceLocation:o,keyword:"enum",keywordLocation:`${u}/enum`,error:`Instance does not match any of ${JSON.stringify(E)}.`}):E.some(Ee=>t===Ee)||ge.push({instanceLocation:o,keyword:"enum",keywordLocation:`${u}/enum`,error:`Instance does not match any of ${JSON.stringify(E)}.`})),D!==void 0){const Ee=`${u}/not`;Dt(t,D,n,r,s,a,o,Ee).valid&&ge.push({instanceLocation:o,keyword:"not",keywordLocation:Ee,error:'Instance matched "not" schema.'})}let Ct=[];if(O!==void 0){const Ee=`${u}/anyOf`,Ce=ge.length;let _e=!1;for(let ve=0;ve<O.length;ve++){const ye=O[ve],Be=Object.create(d),De=Dt(t,ye,n,r,s,w===!0?a:null,o,`${Ee}/${ve}`,Be);ge.push(...De.errors),_e=_e||De.valid,De.valid&&Ct.push(Be)}_e?ge.length=Ce:ge.splice(Ce,0,{instanceLocation:o,keyword:"anyOf",keywordLocation:Ee,error:"Instance does not match any subschemas."})}if(T!==void 0){const Ee=`${u}/allOf`,Ce=ge.length;let _e=!0;for(let ve=0;ve<T.length;ve++){const ye=T[ve],Be=Object.create(d),De=Dt(t,ye,n,r,s,w===!0?a:null,o,`${Ee}/${ve}`,Be);ge.push(...De.errors),_e=_e&&De.valid,De.valid&&Ct.push(Be)}_e?ge.length=Ce:ge.splice(Ce,0,{instanceLocation:o,keyword:"allOf",keywordLocation:Ee,error:"Instance does not match every subschema."})}if(I!==void 0){const Ee=`${u}/oneOf`,Ce=ge.length,_e=I.filter((ve,ye)=>{const Be=Object.create(d),De=Dt(t,ve,n,r,s,w===!0?a:null,o,`${Ee}/${ye}`,Be);return ge.push(...De.errors),De.valid&&Ct.push(Be),De.valid}).length;_e===1?ge.length=Ce:ge.splice(Ce,0,{instanceLocation:o,keyword:"oneOf",keywordLocation:Ee,error:`Instance does not match exactly one subschema (${_e} matches).`})}if((p==="object"||p==="array")&&Object.assign(d,...Ct),M!==void 0){const Ee=`${u}/if`;if(Dt(t,M,n,r,s,a,o,Ee,d).valid){if(N!==void 0){const _e=Dt(t,N,n,r,s,a,o,`${u}/then`,d);_e.valid||ge.push({instanceLocation:o,keyword:"if",keywordLocation:Ee,error:'Instance does not match "then" schema.'},..._e.errors)}}else if(P!==void 0){const _e=Dt(t,P,n,r,s,a,o,`${u}/else`,d);_e.valid||ge.push({instanceLocation:o,keyword:"if",keywordLocation:Ee,error:'Instance does not match "else" schema.'},..._e.errors)}}if(p==="object"){if(C!==void 0)for(const ve of C)ve in t||ge.push({instanceLocation:o,keyword:"required",keywordLocation:`${u}/required`,error:`Instance does not have required property "${ve}".`});const Ee=Object.keys(t);if(j!==void 0&&Ee.length<j&&ge.push({instanceLocation:o,keyword:"minProperties",keywordLocation:`${u}/minProperties`,error:`Instance does not have at least ${j} properties.`}),V!==void 0&&Ee.length>V&&ge.push({instanceLocation:o,keyword:"maxProperties",keywordLocation:`${u}/maxProperties`,error:`Instance does not have at least ${V} properties.`}),B!==void 0){const ve=`${u}/propertyNames`;for(const ye in t){const Be=`${o}/${Dr(ye)}`,De=Dt(ye,B,n,r,s,a,Be,ve);De.valid||ge.push({instanceLocation:o,keyword:"propertyNames",keywordLocation:ve,error:`Property name "${ye}" does not match schema.`},...De.errors)}}if(G!==void 0){const ve=`${u}/dependantRequired`;for(const ye in G)if(ye in t){const Be=G[ye];for(const De of Be)De in t||ge.push({instanceLocation:o,keyword:"dependentRequired",keywordLocation:ve,error:`Instance has "${ye}" but does not have "${De}".`})}}if(Z!==void 0)for(const ve in Z){const ye=`${u}/dependentSchemas`;if(ve in t){const Be=Dt(t,Z[ve],n,r,s,a,o,`${ye}/${Dr(ve)}`,d);Be.valid||ge.push({instanceLocation:o,keyword:"dependentSchemas",keywordLocation:ye,error:`Instance has "${ve}" but does not match dependant schema.`},...Be.errors)}}if(se!==void 0){const ve=`${u}/dependencies`;for(const ye in se)if(ye in t){const Be=se[ye];if(Array.isArray(Be))for(const De of Be)De in t||ge.push({instanceLocation:o,keyword:"dependencies",keywordLocation:ve,error:`Instance has "${ye}" but does not have "${De}".`});else{const De=Dt(t,Be,n,r,s,a,o,`${ve}/${Dr(ye)}`);De.valid||ge.push({instanceLocation:o,keyword:"dependencies",keywordLocation:ve,error:`Instance has "${ye}" but does not match dependant schema.`},...De.errors)}}}const Ce=Object.create(null);let _e=!1;if($!==void 0){const ve=`${u}/properties`;for(const ye in $){if(!(ye in t))continue;const Be=`${o}/${Dr(ye)}`,De=Dt(t[ye],$[ye],n,r,s,a,Be,`${ve}/${Dr(ye)}`);if(De.valid)d[ye]=Ce[ye]=!0;else if(_e=s,ge.push({instanceLocation:o,keyword:"properties",keywordLocation:ve,error:`Property "${ye}" does not match schema.`},...De.errors),_e)break}}if(!_e&&U!==void 0){const ve=`${u}/patternProperties`;for(const ye in U){const Be=new RegExp(ye,"u"),De=U[ye];for(const fn in t){if(!Be.test(fn))continue;const fs=`${o}/${Dr(fn)}`,Ka=Dt(t[fn],De,n,r,s,a,fs,`${ve}/${Dr(ye)}`);Ka.valid?d[fn]=Ce[fn]=!0:(_e=s,ge.push({instanceLocation:o,keyword:"patternProperties",keywordLocation:ve,error:`Property "${fn}" matches pattern "${ye}" but does not match associated schema.`},...Ka.errors))}}}if(!_e&&F!==void 0){const ve=`${u}/additionalProperties`;for(const ye in t){if(Ce[ye])continue;const Be=`${o}/${Dr(ye)}`,De=Dt(t[ye],F,n,r,s,a,Be,ve);De.valid?d[ye]=!0:(_e=s,ge.push({instanceLocation:o,keyword:"additionalProperties",keywordLocation:ve,error:`Property "${ye}" does not match additional properties schema.`},...De.errors))}}else if(!_e&&K!==void 0){const ve=`${u}/unevaluatedProperties`;for(const ye in t)if(!d[ye]){const Be=`${o}/${Dr(ye)}`,De=Dt(t[ye],K,n,r,s,a,Be,ve);De.valid?d[ye]=!0:ge.push({instanceLocation:o,keyword:"unevaluatedProperties",keywordLocation:ve,error:`Property "${ye}" does not match unevaluated properties schema.`},...De.errors)}}}else if(p==="array"){Ge!==void 0&&t.length>Ge&&ge.push({instanceLocation:o,keyword:"maxItems",keywordLocation:`${u}/maxItems`,error:`Array has too many items (${t.length} > ${Ge}).`}),Re!==void 0&&t.length<Re&&ge.push({instanceLocation:o,keyword:"minItems",keywordLocation:`${u}/minItems`,error:`Array has too few items (${t.length} < ${Re}).`});const Ee=t.length;let Ce=0,_e=!1;if(le!==void 0){const ve=`${u}/prefixItems`,ye=Math.min(le.length,Ee);for(;Ce<ye;Ce++){const Be=Dt(t[Ce],le[Ce],n,r,s,a,`${o}/${Ce}`,`${ve}/${Ce}`);if(d[Ce]=!0,!Be.valid&&(_e=s,ge.push({instanceLocation:o,keyword:"prefixItems",keywordLocation:ve,error:"Items did not match schema."},...Be.errors),_e))break}}if(q!==void 0){const ve=`${u}/items`;if(Array.isArray(q)){const ye=Math.min(q.length,Ee);for(;Ce<ye;Ce++){const Be=Dt(t[Ce],q[Ce],n,r,s,a,`${o}/${Ce}`,`${ve}/${Ce}`);if(d[Ce]=!0,!Be.valid&&(_e=s,ge.push({instanceLocation:o,keyword:"items",keywordLocation:ve,error:"Items did not match schema."},...Be.errors),_e))break}}else for(;Ce<Ee;Ce++){const ye=Dt(t[Ce],q,n,r,s,a,`${o}/${Ce}`,ve);if(d[Ce]=!0,!ye.valid&&(_e=s,ge.push({instanceLocation:o,keyword:"items",keywordLocation:ve,error:"Items did not match schema."},...ye.errors),_e))break}if(!_e&&W!==void 0){const ye=`${u}/additionalItems`;for(;Ce<Ee;Ce++){const Be=Dt(t[Ce],W,n,r,s,a,`${o}/${Ce}`,ye);d[Ce]=!0,Be.valid||(_e=s,ge.push({instanceLocation:o,keyword:"additionalItems",keywordLocation:ye,error:"Items did not match additional items schema."},...Be.errors))}}}if(ce!==void 0)if(Ee===0&&ie===void 0)ge.push({instanceLocation:o,keyword:"contains",keywordLocation:`${u}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(ie!==void 0&&Ee<ie)ge.push({instanceLocation:o,keyword:"minContains",keywordLocation:`${u}/minContains`,error:`Array has less items (${Ee}) than minContains (${ie}).`});else{const ve=`${u}/contains`,ye=ge.length;let Be=0;for(let De=0;De<Ee;De++){const fn=Dt(t[De],ce,n,r,s,a,`${o}/${De}`,ve);fn.valid?(d[De]=!0,Be++):ge.push(...fn.errors)}Be>=(ie||0)&&(ge.length=ye),ie===void 0&&fe===void 0&&Be===0?ge.splice(ye,0,{instanceLocation:o,keyword:"contains",keywordLocation:ve,error:"Array does not contain item matching schema."}):ie!==void 0&&Be<ie?ge.push({instanceLocation:o,keyword:"minContains",keywordLocation:`${u}/minContains`,error:`Array must contain at least ${ie} items matching schema. Only ${Be} items were found.`}):fe!==void 0&&Be>fe&&ge.push({instanceLocation:o,keyword:"maxContains",keywordLocation:`${u}/maxContains`,error:`Array may contain at most ${fe} items matching schema. ${Be} items were found.`})}if(!_e&&ee!==void 0){const ve=`${u}/unevaluatedItems`;for(Ce;Ce<Ee;Ce++){if(d[Ce])continue;const ye=Dt(t[Ce],ee,n,r,s,a,`${o}/${Ce}`,ve);d[Ce]=!0,ye.valid||ge.push({instanceLocation:o,keyword:"unevaluatedItems",keywordLocation:ve,error:"Items did not match unevaluated items schema."},...ye.errors)}}if(ze)for(let ve=0;ve<Ee;ve++){const ye=t[ve],Be=typeof ye=="object"&&ye!==null;for(let De=0;De<Ee;De++){if(ve===De)continue;const fn=t[De];(ye===fn||Be&&(typeof fn=="object"&&fn!==null)&&Ko(ye,fn))&&(ge.push({instanceLocation:o,keyword:"uniqueItems",keywordLocation:`${u}/uniqueItems`,error:`Duplicate items at indexes ${ve} and ${De}.`}),ve=Number.MAX_SAFE_INTEGER,De=Number.MAX_SAFE_INTEGER)}}}else if(p==="number"){if(n==="4"?(Ae!==void 0&&(je===!0&&t<=Ae||t<Ae)&&ge.push({instanceLocation:o,keyword:"minimum",keywordLocation:`${u}/minimum`,error:`${t} is less than ${je?"or equal to ":""} ${Ae}.`}),Rt!==void 0&&(dn===!0&&t>=Rt||t>Rt)&&ge.push({instanceLocation:o,keyword:"maximum",keywordLocation:`${u}/maximum`,error:`${t} is greater than ${dn?"or equal to ":""} ${Rt}.`})):(Ae!==void 0&&t<Ae&&ge.push({instanceLocation:o,keyword:"minimum",keywordLocation:`${u}/minimum`,error:`${t} is less than ${Ae}.`}),Rt!==void 0&&t>Rt&&ge.push({instanceLocation:o,keyword:"maximum",keywordLocation:`${u}/maximum`,error:`${t} is greater than ${Rt}.`}),je!==void 0&&t<=je&&ge.push({instanceLocation:o,keyword:"exclusiveMinimum",keywordLocation:`${u}/exclusiveMinimum`,error:`${t} is less than ${je}.`}),dn!==void 0&&t>=dn&&ge.push({instanceLocation:o,keyword:"exclusiveMaximum",keywordLocation:`${u}/exclusiveMaximum`,error:`${t} is greater than or equal to ${dn}.`})),ct!==void 0){const Ee=t%ct;Math.abs(0-Ee)>=11920929e-14&&Math.abs(ct-Ee)>=11920929e-14&&ge.push({instanceLocation:o,keyword:"multipleOf",keywordLocation:`${u}/multipleOf`,error:`${t} is not a multiple of ${ct}.`})}}else if(p==="string"){const Ee=nn===void 0&&rn===void 0?0:W8(t);nn!==void 0&&Ee<nn&&ge.push({instanceLocation:o,keyword:"minLength",keywordLocation:`${u}/minLength`,error:`String is too short (${Ee} < ${nn}).`}),rn!==void 0&&Ee>rn&&ge.push({instanceLocation:o,keyword:"maxLength",keywordLocation:`${u}/maxLength`,error:`String is too long (${Ee} > ${rn}).`}),Oe!==void 0&&!new RegExp(Oe,"u").test(t)&&ge.push({instanceLocation:o,keyword:"pattern",keywordLocation:`${u}/pattern`,error:"String does not match pattern."}),k!==void 0&&UI[k]&&!UI[k](t)&&ge.push({instanceLocation:o,keyword:"format",keywordLocation:`${u}/format`,error:`String does not match format "${k}".`})}return{valid:ge.length===0,errors:ge}}class Z8{constructor(e,n="2019-09",r=!0){z(this,"schema");z(this,"draft");z(this,"shortCircuit");z(this,"lookup");this.schema=e,this.draft=n,this.shortCircuit=r,this.lookup=Oa(e)}validate(e){return Dt(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,n){n&&(e={...e,$id:n}),Oa(e,this.lookup)}}var X8={};Ft(X8,{Validator:()=>Z8,deepCompareStrict:()=>Ko,toJsonSchema:()=>LM,validatesOnlyStrings:()=>Lu});function LM(t){if(Ys(t)){const e=Tu(t,!0);if(Du(e)){const n=e0(e,!0);return DI(n)}else return DI(t)}return Ya(t)?b8(t):t}function Lu(t){if(!t||typeof t!="object"||Object.keys(t).length===0||Array.isArray(t))return!1;if("type"in t)return typeof t.type=="string"?t.type==="string":Array.isArray(t.type)?t.type.every(e=>e==="string"):!1;if("enum"in t)return Array.isArray(t.enum)&&t.enum.length>0&&t.enum.every(e=>typeof e=="string");if("const"in t)return typeof t.const=="string";if("allOf"in t&&Array.isArray(t.allOf))return t.allOf.some(e=>Lu(e));if("anyOf"in t&&Array.isArray(t.anyOf)||"oneOf"in t&&Array.isArray(t.oneOf)){const e="anyOf"in t?t.anyOf:t.oneOf;return e.length>0&&e.every(n=>Lu(n))}if("not"in t)return!1;if("$ref"in t&&typeof t.$ref=="string"){const e=t.$ref,n=Oa(t);return n[e]?Lu(n[e]):!1}return!1}var Q8={};Ft(Q8,{AsyncCaller:()=>kp});const e7=[400,401,402,403,404,405,406,407,409],t7=t=>{var n,r;if(t.message.startsWith("Cancel")||t.message.startsWith("AbortError")||t.name==="AbortError"||(t==null?void 0:t.code)==="ECONNABORTED")throw t;const e=((n=t==null?void 0:t.response)==null?void 0:n.status)??(t==null?void 0:t.status);if(e&&e7.includes(+e))throw t;if(((r=t==null?void 0:t.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(t==null?void 0:t.message);throw s.name="InsufficientQuotaError",s}};var kp=class{constructor(t){z(this,"maxConcurrency");z(this,"maxRetries");z(this,"onFailedAttempt");z(this,"queue");this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,this.onFailedAttempt=t.onFailedAttempt??t7;const e="default"in Hs?Hs.default:Hs;this.queue=new e({concurrency:this.maxConcurrency})}call(t,...e){return this.queue.add(()=>jf(()=>t(...e).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,e,...n){if(t.signal){let r;return Promise.race([this.call(e,...n),new Promise((s,a)=>{var o;r=()=>{a(Zu(t.signal))},(o=t.signal)==null||o.addEventListener("abort",r)})]).finally(()=>{t.signal&&r&&t.signal.removeEventListener("abort",r)})}return this.call(e,...n)}fetch(...t){return this.call(()=>fetch(...t).then(e=>e.ok?e:Promise.reject(e)))}},n7={};Ft(n7,{AsyncGeneratorWithSetup:()=>Fi,IterableReadableStream:()=>Gr,atee:()=>Lv,concat:()=>$v,pipeGeneratorWithSetup:()=>$M});var Gr=class t0 extends ReadableStream{constructor(){super(...arguments);z(this,"reader")}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const n=await this.reader.read();return n.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:n.value}}catch(n){throw this.reader.releaseLock(),n}}async return(){if(this.ensureReader(),this.locked){const n=this.reader.cancel();this.reader.releaseLock(),await n}return{done:!0,value:void 0}}async throw(n){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}throw n}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(n){const r=n.getReader();return new t0({start(s){return a();function a(){return r.read().then(({done:o,value:u})=>{if(o){s.close();return}return s.enqueue(u),a()})}},cancel(){r.releaseLock()}})}static fromAsyncGenerator(n){return new t0({async pull(r){const{value:s,done:a}=await n.next();a&&r.close(),r.enqueue(s)},async cancel(r){await n.return(r)}})}};function Lv(t,e=2){const n=Array.from({length:e},()=>[]);return n.map(async function*(s){for(;;)if(s.length===0){const a=await t.next();for(const o of n)o.push(a)}else{if(s[0].done)return;yield s.shift().value}})}function $v(t,e){if(Array.isArray(t)&&Array.isArray(e))return t.concat(e);if(typeof t=="string"&&typeof e=="string")return t+e;if(typeof t=="number"&&typeof e=="number")return t+e;if("concat"in t&&typeof t.concat=="function")return t.concat(e);if(typeof t=="object"&&typeof e=="object"){const n={...t};for(const[r,s]of Object.entries(e))r in n&&!Array.isArray(n[r])?n[r]=$v(n[r],s):n[r]=s;return n}else throw new Error(`Cannot concat ${typeof t} and ${typeof e}`)}var Fi=class{constructor(t){z(this,"generator");z(this,"setup");z(this,"config");z(this,"signal");z(this,"firstResult");z(this,"firstResultUsed",!1);var e;this.generator=t.generator,this.config=t.config,this.signal=t.signal??((e=this.config)==null?void 0:e.signal),this.setup=new Promise((n,r)=>{qr.runWithConfig(Ba(t.config),async()=>{this.firstResult=t.generator.next(),t.startSetup?this.firstResult.then(t.startSetup).then(n,r):this.firstResult.then(s=>n(void 0),r)},!0)})}async next(...t){var e;return(e=this.signal)==null||e.throwIfAborted(),this.firstResultUsed?qr.runWithConfig(Ba(this.config),this.signal?async()=>qa(this.generator.next(...t),this.signal):async()=>this.generator.next(...t),!0):(this.firstResultUsed=!0,this.firstResult)}async return(t){return this.generator.return(t)}async throw(t){return this.generator.throw(t)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function $M(t,e,n,r,...s){const a=new Fi({generator:e,startSetup:n,signal:r}),o=await a.setup;return{output:t(a,o,...s),setup:o}}/*!
* https://github.com/Starcounter-Jack/JSON-Patch
* (c) 2017-2022 Joachim Wester
* MIT licensed
*/const r7=Object.prototype.hasOwnProperty;function s7(t,e){return r7.call(t,e)}function a7(t){if(Array.isArray(t)){const n=new Array(t.length);for(let r=0;r<n.length;r++)n[r]=""+r;return n}if(Object.keys)return Object.keys(t);let e=[];for(let n in t)s7(t,n)&&e.push(n);return e}function $i(t){switch(typeof t){case"object":return JSON.parse(JSON.stringify(t));case"undefined":return null;default:return t}}function n0(t){let e=0;const n=t.length;let r;for(;e<n;){if(r=t.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function i7(t){return t.replace(/~1/g,"/").replace(/~0/g,"~")}function r0(t){if(t===void 0)return!0;if(t){if(Array.isArray(t)){for(let n=0,r=t.length;n<r;n++)if(r0(t[n]))return!0}else if(typeof t=="object"){const n=a7(t),r=n.length;for(var e=0;e<r;e++)if(r0(t[n[e]]))return!0}}return!1}function FI(t,e){const n=[t];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&n.push(`${r}: ${s}`)}return n.join(`
`)}var o7=class extends Error{constructor(t,e,n,r,s){super(FI(t,{name:e,index:n,operation:r,tree:s})),this.name=e,this.index=n,this.operation=r,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=FI(t,{name:e,index:n,operation:r,tree:s})}},UM={};Ft(UM,{JsonPatchError:()=>Ht,_areEquals:()=>Qu,applyOperation:()=>Pi,applyPatch:()=>Xu,applyReducer:()=>c7,deepClone:()=>l7,getValueByPointer:()=>Wf,validate:()=>FM,validator:()=>Zf});const Ht=o7,l7=$i,Bo={add:function(t,e,n){return t[e]=this.value,{newDocument:n}},remove:function(t,e,n){var r=t[e];return delete t[e],{newDocument:n,removed:r}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:function(t,e,n){let r=Wf(n,this.path);r&&(r=$i(r));const s=Pi(n,{op:"remove",path:this.from}).removed;return Pi(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(t,e,n){const r=Wf(n,this.from);return Pi(n,{op:"add",path:this.path,value:$i(r)}),{newDocument:n}},test:function(t,e,n){return{newDocument:n,test:Qu(t[e],this.value)}},_get:function(t,e,n){return this.value=t[e],{newDocument:n}}};var u7={add:function(t,e,n){return n0(e)?t.splice(e,0,this.value):t[e]=this.value,{newDocument:n,index:e}},remove:function(t,e,n){var r=t.splice(e,1);return{newDocument:n,removed:r[0]}},replace:function(t,e,n){var r=t[e];return t[e]=this.value,{newDocument:n,removed:r}},move:Bo.move,copy:Bo.copy,test:Bo.test,_get:Bo._get};function Wf(t,e){if(e=="")return t;var n={op:"_get",path:e};return Pi(t,n),n.value}function Pi(t,e,n=!1,r=!0,s=!0,a=0){if(n&&(typeof n=="function"?n(e,0,t,e.path):Zf(e,0)),e.path===""){let o={newDocument:t};if(e.op==="add")return o.newDocument=e.value,o;if(e.op==="replace")return o.newDocument=e.value,o.removed=t,o;if(e.op==="move"||e.op==="copy")return o.newDocument=Wf(t,e.from),e.op==="move"&&(o.removed=t),o;if(e.op==="test"){if(o.test=Qu(t,e.value),o.test===!1)throw new Ht("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return o.newDocument=t,o}else{if(e.op==="remove")return o.removed=t,o.newDocument=null,o;if(e.op==="_get")return e.value=t,o;if(n)throw new Ht("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,t);return o}}else{r||(t=$i(t));const u=(e.path||"").split("/");let d=t,c=1,p=u.length,m,y,w;for(typeof n=="function"?w=n:w=Zf;;){if(y=u[c],y&&y.indexOf("~")!=-1&&(y=i7(y)),s&&(y=="__proto__"||y=="prototype"&&c>0&&u[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&m===void 0&&(d[y]===void 0?m=u.slice(0,c).join("/"):c==p-1&&(m=e.path),m!==void 0&&w(e,0,t,m)),c++,Array.isArray(d)){if(y==="-")y=d.length;else{if(n&&!n0(y))throw new Ht("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,t);n0(y)&&(y=~~y)}if(c>=p){if(n&&e.op==="add"&&y>d.length)throw new Ht("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,t);const x=u7[e.op].call(e,d,y,t);if(x.test===!1)throw new Ht("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return x}}else if(c>=p){const x=Bo[e.op].call(e,d,y,t);if(x.test===!1)throw new Ht("Test operation failed","TEST_OPERATION_FAILED",a,e,t);return x}if(d=d[y],n&&c<p&&(!d||typeof d!="object"))throw new Ht("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,t)}}}function Xu(t,e,n,r=!0,s=!0){if(n&&!Array.isArray(e))throw new Ht("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(t=$i(t));const a=new Array(e.length);for(let o=0,u=e.length;o<u;o++)a[o]=Pi(t,e[o],n,!0,s,o),t=a[o].newDocument;return a.newDocument=t,a}function c7(t,e,n){const r=Pi(t,e);if(r.test===!1)throw new Ht("Test operation failed","TEST_OPERATION_FAILED",n,e,t);return r.newDocument}function Zf(t,e,n,r){if(typeof t!="object"||t===null||Array.isArray(t))throw new Ht("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,t,n);if(Bo[t.op]){if(typeof t.path!="string")throw new Ht("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,t,n);if(t.path.indexOf("/")!==0&&t.path.length>0)throw new Ht('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,t,n);if((t.op==="move"||t.op==="copy")&&typeof t.from!="string")throw new Ht("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&t.value===void 0)throw new Ht("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,t,n);if((t.op==="add"||t.op==="replace"||t.op==="test")&&r0(t.value))throw new Ht("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,t,n);if(n){if(t.op=="add"){var s=t.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new Ht("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,t,n)}else if(t.op==="replace"||t.op==="remove"||t.op==="_get"){if(t.path!==r)throw new Ht("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,t,n)}else if(t.op==="move"||t.op==="copy"){var o={op:"_get",path:t.from,value:void 0},u=FM([o],n);if(u&&u.name==="OPERATION_PATH_UNRESOLVABLE")throw new Ht("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,t,n)}}}else throw new Ht("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,t,n)}function FM(t,e,n){try{if(!Array.isArray(t))throw new Ht("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Xu($i(e),$i(t),n||!0);else{n=n||Zf;for(var r=0;r<t.length;r++)n(t[r],r,e,void 0)}}catch(s){if(s instanceof Ht)return s;throw s}}function Qu(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var n=Array.isArray(t),r=Array.isArray(e),s,a,o;if(n&&r){if(a=t.length,a!=e.length)return!1;for(s=a;s--!==0;)if(!Qu(t[s],e[s]))return!1;return!0}if(n!=r)return!1;var u=Object.keys(t);if(a=u.length,a!==Object.keys(e).length)return!1;for(s=a;s--!==0;)if(!e.hasOwnProperty(u[s]))return!1;for(s=a;s--!==0;)if(o=u[s],!Qu(t[o],e[o]))return!1;return!0}return t!==t&&e!==e}({...UM});var d7={};Ft(d7,{LogStreamCallbackHandler:()=>a0,RunLog:()=>Uv,RunLogPatch:()=>Ds,isLogStreamHandler:()=>BM});var Ds=class{constructor(t){z(this,"ops");this.ops=t.ops??[]}concat(t){const e=this.ops.concat(t.ops),n=Xu({},e);return new Uv({ops:e,state:n[n.length-1].newDocument})}},Uv=class s0 extends Ds{constructor(n){super(n);z(this,"state");this.state=n.state}concat(n){const r=this.ops.concat(n.ops),s=Xu(this.state,n.ops);return new s0({ops:r,state:s[s.length-1].newDocument})}static fromRunLogPatch(n){const r=Xu({},n.ops);return new s0({ops:n.ops,state:r[r.length-1].newDocument})}};const BM=t=>t.name==="log_stream_tracer";async function BI(t,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=t;if(["retriever","llm","prompt"].includes(t.run_type))return n;if(!(Object.keys(n).length===1&&(n==null?void 0:n.input)===""))return n.input}async function qI(t,e){const{outputs:n}=t;return e==="original"||["retriever","llm","prompt"].includes(t.run_type)?n:n!==void 0&&Object.keys(n).length===1&&(n==null?void 0:n.output)!==void 0?n.output:n}function f7(t){return t!==void 0&&t.message!==void 0}var a0=class extends hl{constructor(e){super({_awaitHandler:!0,...e});z(this,"autoClose",!0);z(this,"includeNames");z(this,"includeTypes");z(this,"includeTags");z(this,"excludeNames");z(this,"excludeTypes");z(this,"excludeTags");z(this,"_schemaFormat","original");z(this,"rootId");z(this,"keyMapByRunId",{});z(this,"counterMapByRunName",{});z(this,"transformStream");z(this,"writer");z(this,"receiveStream");z(this,"name","log_stream_tracer");z(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Gr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||n.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,n){for await(const r of n){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new Ds({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Ds({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const n=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=n===1?e.name:`${e.name}:${n}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await BI(e,this._schemaFormat)),await this.writer.write(new Ds({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const n=this.keyMapByRunId[e.id];if(n===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${n}/inputs`,value:await BI(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${n}/final_output`,value:await qI(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${n}/end_time`,value:new Date(e.end_time).toISOString()});const s=new Ds({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const n=new Ds({ops:[{op:"replace",path:"/final_output",value:await qI(e,this._schemaFormat)}]});await this.writer.write(n),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,n,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const a=e.inputs.messages!==void 0;let o;a?f7(r==null?void 0:r.chunk)?o=r==null?void 0:r.chunk:o=new xv({id:`run-${e.id}`,content:n}):o=n;const u=new Ds({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:n},{op:"add",path:`/logs/${s}/streamed_output/-`,value:o}]});await this.writer.write(u)}},p7={};Ft(p7,{ChatGenerationChunk:()=>m7,GenerationChunk:()=>Xf,RUN_KEY:()=>h7});const h7="__run";var Xf=class qM{constructor(e){z(this,"text");z(this,"generationInfo");this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new qM({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},m7=class GM extends Xf{constructor(n){super(n);z(this,"message");this.message=n.message}concat(n){return new GM({text:this.text+n.text,generationInfo:{...this.generationInfo,...n.generationInfo},message:this.message.concat(n.message)})}};function sf({name:t,serialized:e}){return t!==void 0?t:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const g7=t=>t.name==="event_stream_tracer";var y7=class extends hl{constructor(e){super({_awaitHandler:!0,...e});z(this,"autoClose",!0);z(this,"includeNames");z(this,"includeTypes");z(this,"includeTags");z(this,"excludeNames");z(this,"excludeTypes");z(this,"excludeTags");z(this,"runInfoMap",new Map);z(this,"tappedPromises",new Map);z(this,"transformStream");z(this,"writer");z(this,"receiveStream");z(this,"name","event_stream_tracer");z(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Gr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const n=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||n.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&n.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,n){const r=await n.next();if(r.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield r.value;return}function a(u,d){return u==="llm"&&typeof d=="string"?new Xf({text:d}):d}let o=this.tappedPromises.get(e);if(o===void 0){let u;o=new Promise(d=>{u=d}),this.tappedPromises.set(e,o);try{const d={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...d,data:{chunk:a(s.runType,r.value)}},s),yield r.value;for await(const c of n)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...d,data:{chunk:a(s.runType,c)}},s),yield c}finally{u==null||u()}}else{yield r.value;for await(const u of n)yield u}}async send(e,n){this._includeRun(n)&&await this.writer.write(e)}async sendEndEvent(e,n){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,n)}):await this.send(e,n)}async onLLMStart(e){var o,u;const n=sf(e),r=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((o=e.extra)==null?void 0:o.metadata)??{},name:n,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,s);const a=`on_${r}_start`;await this.send({event:a,data:{input:e.inputs},name:n,tags:e.tags??[],run_id:e.id,metadata:((u=e.extra)==null?void 0:u.metadata)??{}},s)}async onLLMNewToken(e,n,r){const s=this.runInfoMap.get(e.id);let a,o;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")o="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?a=new xv({content:n,id:`run-${e.id}`}):a=r.chunk.message;else if(s.runType==="llm")o="on_llm_stream",(r==null?void 0:r.chunk)===void 0?a=new Xf({text:n}):a=r.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:o,data:{chunk:a},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var o,u,d;const n=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(n===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(o=e.outputs)==null?void 0:o.generations;let a;if(n.runType==="chat_model"){for(const c of s??[]){if(a!==void 0)break;a=(u=c[0])==null?void 0:u.message}r="on_chat_model_end"}else if(n.runType==="llm")a={generations:s==null?void 0:s.map(c=>c.map(p=>({text:p.text,generationInfo:p.generationInfo}))),llmOutput:((d=e.outputs)==null?void 0:d.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${n.runType}`);await this.sendEndEvent({event:r,data:{output:a,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onChainStart(e){var o,u;const n=sf(e),r=e.run_type??"chain",s={tags:e.tags??[],metadata:((o=e.extra)==null?void 0:o.metadata)??{},name:n,runType:e.run_type};let a={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(a={},s.inputs={}):e.inputs.input!==void 0?(a.input=e.inputs.input,s.inputs=e.inputs.input):(a.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${r}_start`,data:a,name:n,tags:e.tags??[],run_id:e.id,metadata:((u=e.extra)==null?void 0:u.metadata)??{}},s)}async onChainEnd(e){var u;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,s=e.inputs??n.inputs??{},o={output:((u=e.outputs)==null?void 0:u.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(o.input=s.input,n.inputs=s.input),await this.sendEndEvent({event:r,data:o,run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata??{}},n)}async onToolStart(e){var s,a;const n=sf(e),r={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:n,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:n,run_id:e.id,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{}},r)}async onToolEnd(e){var s;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(n.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async onRetrieverStart(e){var a,o;const n=sf(e),s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:n,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:n,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onRetrieverEnd(e){var r;const n=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),n===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:n.inputs},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}async handleCustomEvent(e,n,r){const s=this.runInfoMap.get(r);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:s.tags,metadata:s.metadata,data:n},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}},HM=class extends hl{constructor({config:e,onStart:n,onEnd:r,onError:s}){super({_awaitHandler:!0});z(this,"name","RootListenersTracer");z(this,"rootId");z(this,"config");z(this,"argOnStart");z(this,"argOnEnd");z(this,"argOnError");this.config=e,this.argOnStart=n,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function Fv(t){return t?t.lc_runnable:!1}var _7=class{constructor(t){z(this,"includeNames");z(this,"includeTypes");z(this,"includeTags");z(this,"excludeNames");z(this,"excludeTypes");z(this,"excludeTags");this.includeNames=t.includeNames,this.includeTypes=t.includeTypes,this.includeTags=t.includeTags,this.excludeNames=t.excludeNames,this.excludeTypes=t.excludeTypes,this.excludeTags=t.excludeTags}includeEvent(t,e){let n=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const r=t.tags??[];return this.includeNames!==void 0&&(n=n||this.includeNames.includes(t.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e)),this.includeTags!==void 0&&(n=n||r.some(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(t.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(n=n&&r.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),n}};function qy(t){return t.replace(/[^a-zA-Z-_0-9]/g,"_")}const v7=["*","_","`"];function w7(t){let e="";for(const[n,r]of Object.entries(t))e+=`	classDef ${n} ${r};
`;return e}function b7(t,e,n){const{firstNode:r,lastNode:s,nodeColors:a,withStyles:o=!0,curveStyle:u="linear",wrapLabelNWords:d=9}=n??{};let c=o?`%%{init: {'flowchart': {'curve': '${u}'}}}%%
graph TD;
`:`graph TD;
`;if(o){const w="default",x={[w]:"{0}({1})"};r!==void 0&&(x[r]="{0}([{1}]):::first"),s!==void 0&&(x[s]="{0}([{1}]):::last");for(const[A,E]of Object.entries(t)){const C=E.name.split(":").pop()??"";let O=v7.some(I=>C.startsWith(I)&&C.endsWith(I))?`<p>${C}</p>`:C;Object.keys(E.metadata??{}).length&&(O+=`<hr/><small><em>${Object.entries(E.metadata??{}).map(([I,M])=>`${I} = ${M}`).join(`
`)}</em></small>`);const T=(x[A]??x[w]).replace("{0}",qy(A)).replace("{1}",O);c+=`	${T}
`}}const p={};for(const w of e){const x=w.source.split(":"),A=w.target.split(":"),E=x.filter((C,D)=>C===A[D]).join(":");p[E]||(p[E]=[]),p[E].push(w)}const m=new Set;function y(w,x){const A=w.length===1&&w[0].source===w[0].target;if(x&&!A){const E=x.split(":").pop();if(m.has(E))throw new Error(`Found duplicate subgraph '${E}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);m.add(E),c+=`	subgraph ${E}
`}for(const E of w){const{source:C,target:D,data:O,conditional:T}=E;let I="";if(O!==void 0){let M=O;const N=M.split(" ");N.length>d&&(M=Array.from({length:Math.ceil(N.length/d)},(P,k)=>N.slice(k*d,(k+1)*d).join(" ")).join("&nbsp;<br>&nbsp;")),I=T?` -. &nbsp;${M}&nbsp; .-> `:` -- &nbsp;${M}&nbsp; --> `}else I=T?" -.-> ":" --> ";c+=`	${qy(C)}${I}${qy(D)};
`}for(const E in p)E.startsWith(`${x}:`)&&E!==x&&y(p[E],E);x&&!A&&(c+=`	end
`)}y(p[""]??[],"");for(const w in p)!w.includes(":")&&w!==""&&y(p[w],w);return o&&(c+=w7(a??{})),c}async function S7(t,e){let n=(e==null?void 0:e.backgroundColor)??"white";const r=(e==null?void 0:e.imageType)??"png",s=btoa(t);n!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const a=`https://mermaid.ink/img/${s}?bgColor=${n}&type=${r}`,o=await fetch(a);if(!o.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${o.status}`,`Status text: ${o.statusText}`].join(`
`));return await o.blob()}var x7={};Ft(x7,{Graph:()=>Bv});function T7(t,e){if(t!==void 0&&!Mu(t))return t;if(Fv(e))try{let n=e.getName();return n=n.startsWith("Runnable")?n.slice(8):n,n}catch{return e.getName()}else return e.name??"UnknownSchema"}function A7(t){return Fv(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...LM(t.data.schema),title:t.data.name}}}var Bv=class zM{constructor(e){z(this,"nodes",{});z(this,"edges",[]);this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((n,r)=>{e[n.id]=Mu(n.id)?r:n.id}),{nodes:Object.values(this.nodes).map(n=>({id:e[n.id],...A7(n)})),edges:this.edges.map(n=>{const r={source:e[n.source],target:e[n.target]};return typeof n.data<"u"&&(r.data=n.data),typeof n.conditional<"u"&&(r.conditional=n.conditional),r})}}addNode(e,n,r){if(n!==void 0&&this.nodes[n]!==void 0)throw new Error(`Node with id ${n} already exists`);const s=n??Dn(),a={id:s,data:e,name:T7(n,e),metadata:r};return this.nodes[s]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(n=>n.source!==e.id&&n.target!==e.id)}addEdge(e,n,r,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[n.id]===void 0)throw new Error(`Target node ${n.id} not in graph`);const a={source:e.id,target:n.id,data:r,conditional:s};return this.edges.push(a),a}firstNode(){return GI(this)}lastNode(){return HI(this)}extend(e,n=""){let r=n;Object.values(e.nodes).map(c=>c.id).every(Mu)&&(r="");const a=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,p])=>{this.nodes[a(c)]={...p,id:a(c)}});const o=e.edges.map(c=>({...c,source:a(c.source),target:a(c.target)}));this.edges=[...this.edges,...o];const u=e.firstNode(),d=e.lastNode();return[u?{id:a(u.id),data:u.data}:void 0,d?{id:a(d.id),data:d.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&GI(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&HI(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),n=new Map;Object.values(e).forEach(s=>{n.set(s,(n.get(s)||0)+1)});const r=s=>{const a=e[s];return Mu(s)&&n.get(a)===1?a:s};return new zM({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,a])=>[r(s),{...a,id:r(s)}])),edges:this.edges.map(s=>({...s,source:r(s.source),target:r(s.target)}))})}drawMermaid(e){const{withStyles:n,curveStyle:r,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},o=this.reid(),u=o.firstNode(),d=o.lastNode();return b7(o.nodes,o.edges,{firstNode:u==null?void 0:u.id,lastNode:d==null?void 0:d.id,withStyles:n,curveStyle:r,nodeColors:s,wrapLabelNWords:a})}async drawMermaidPng(e){const n=this.drawMermaid(e);return S7(n,{backgroundColor:e==null?void 0:e.backgroundColor})}};function GI(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function HI(t,e=[]){const n=new Set(t.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),r=[];for(const s of Object.values(t.nodes))!e.includes(s.id)&&!n.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function E7(t){const e=new TextEncoder,n=new ReadableStream({async start(r){for await(const s of t)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return Gr.fromReadableStream(n)}function zI(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.iterator]=="function"&&typeof t.next=="function"}const C7=t=>t!=null&&typeof t=="object"&&"next"in t&&typeof t.next=="function";function i0(t){return typeof t=="object"&&t!==null&&typeof t[Symbol.asyncIterator]=="function"}function*jI(t,e){for(;;){const{value:n,done:r}=qr.runWithConfig(Ba(t),e.next.bind(e),!0);if(r)break;yield n}}async function*o0(t,e){const n=e[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await qr.runWithConfig(Ba(t),n.next.bind(e),!0);if(s)break;yield r}}function gn(t,e){return t&&!Array.isArray(t)&&!(t instanceof Date)&&typeof t=="object"?t:{[e]:t}}var Rn=class extends nl{constructor(){super(...arguments);z(this,"lc_runnable",!0);z(this,"name")}getName(e){const n=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${n}${e}`:n}withRetry(e){return new JM({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Qf({bound:this,config:e,kwargs:{}})}withFallbacks(e){const n=Array.isArray(e)?e:e.fallbacks;return new N7({runnable:this,fallbacks:n})}_getOptionsList(e,n=0){if(Array.isArray(e)&&e.length!==n)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${n} inputs`);if(Array.isArray(e))return e.map(Et);if(n>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:n},(s,a)=>Et(a===0?e:r))}return Array.from({length:n},()=>Et(e))}async batch(e,n,r){var d;const s=this._getOptionsList(n??{},e.length),a=((d=s[0])==null?void 0:d.maxConcurrency)??(r==null?void 0:r.maxConcurrency),o=new kp({maxConcurrency:a,onFailedAttempt:c=>{throw c}}),u=e.map((c,p)=>o.call(async()=>{try{return await this.invoke(c,s[p])}catch(m){if(r!=null&&r.returnExceptions)return m;throw m}}));return Promise.all(u)}async*_streamIterator(e,n){yield this.invoke(e,n)}async stream(e,n){const r=Et(n),s=new Fi({generator:this._streamIterator(e,r),config:r});return await s.setup,Gr.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let n;e===void 0?n=Et(e):n=Et({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[n,r]}async _callWithConfig(e,n,r){const s=Et(r),a=await Br(s),o=await(a==null?void 0:a.handleChainStart(this.toJSON(),gn(n,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let u;try{const d=e.call(this,n,s,o);u=await qa(d,r==null?void 0:r.signal)}catch(d){throw await(o==null?void 0:o.handleChainError(d)),d}return await(o==null?void 0:o.handleChainEnd(gn(u,"output"))),u}async _batchWithConfig(e,n,r,s){var c;const a=this._getOptionsList(r??{},n.length),o=await Promise.all(a.map(Br)),u=await Promise.all(o.map(async(p,m)=>{const y=await(p==null?void 0:p.handleChainStart(this.toJSON(),gn(n[m],"input"),a[m].runId,a[m].runType,void 0,void 0,a[m].runName??this.getName()));return delete a[m].runId,y}));let d;try{const p=e.call(this,n,a,u,s);d=await qa(p,(c=a==null?void 0:a[0])==null?void 0:c.signal)}catch(p){throw await Promise.all(u.map(m=>m==null?void 0:m.handleChainError(p))),p}return await Promise.all(u.map(p=>p==null?void 0:p.handleChainEnd(gn(d,"output")))),d}_concatOutputChunks(e,n){return $v(e,n)}async*_transformStreamWithConfig(e,n,r){let s,a=!0,o,u=!0;const d=Et(r),c=await Br(d),p=this;async function*m(){for await(const w of e){if(a)if(s===void 0)s=w;else try{s=p._concatOutputChunks(s,w)}catch{s=void 0,a=!1}yield w}}let y;try{const w=await $M(n.bind(this),m(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},d.runId,d.runType,void 0,void 0,d.runName??this.getName()),r==null?void 0:r.signal,d);delete d.runId,y=w.setup;const x=y==null?void 0:y.handlers.find(g7);let A=w.output;x!==void 0&&y!==void 0&&(A=x.tapOutputIterable(y.runId,A));const E=y==null?void 0:y.handlers.find(BM);E!==void 0&&y!==void 0&&(A=E.tapOutputIterable(y.runId,A));for await(const C of A)if(yield C,u)if(o===void 0)o=C;else try{o=this._concatOutputChunks(o,C)}catch{o=void 0,u=!1}}catch(w){throw await(y==null?void 0:y.handleChainError(w,void 0,void 0,void 0,{inputs:gn(s,"input")})),w}await(y==null?void 0:y.handleChainEnd(o??{},void 0,void 0,void 0,{inputs:gn(s,"input")}))}getGraph(e){const n=new Bv,r=n.addNode({name:`${this.getName()}Input`,schema:vE()}),s=n.addNode(this),a=n.addNode({name:`${this.getName()}Output`,schema:vE()});return n.addEdge(r,s),n.addEdge(s,a),n}pipe(e){return new YM({first:this,last:Ai(e)})}pick(e){return this.pipe(new M7(e))}assign(e){return this.pipe(new P7(new Op({steps:e})))}async*transform(e,n){let r;for await(const s of e)r===void 0?r=s:r=this._concatOutputChunks(r,s);yield*this._streamIterator(r,Et(n))}async*streamLog(e,n,r){const s=new a0({...r,autoClose:!1,_schemaFormat:"original"}),a=Et(n);yield*this._streamLog(e,s,a)}async*_streamLog(e,n,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[n];else if(Array.isArray(s))r.callbacks=s.concat([n]);else{const d=s.copy();d.addHandler(n,!0),r.callbacks=d}const a=this.stream(e,r);async function o(){try{const d=await a;for await(const c of d){const p=new Ds({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await n.writer.write(p)}}finally{await n.writer.close()}}const u=o();try{for await(const d of n)yield d}finally{await u}}streamEvents(e,n,r){let s;if(n.version==="v1")s=this._streamEventsV1(e,n,r);else if(n.version==="v2")s=this._streamEventsV2(e,n,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return n.encoding==="text/event-stream"?E7(s):Gr.fromAsyncGenerator(s)}async*_streamEventsV2(e,n,r){var x;const s=new y7({...r,autoClose:!1}),a=Et(n),o=a.runId??Dn();a.runId=o;const u=a.callbacks;if(u===void 0)a.callbacks=[s];else if(Array.isArray(u))a.callbacks=u.concat(s);else{const A=u.copy();A.addHandler(s,!0),a.callbacks=A}const d=new AbortController,c=this;async function p(){let A,E=null;try{n!=null&&n.signal?"any"in AbortSignal?A=AbortSignal.any([d.signal,n.signal]):(A=n.signal,E=()=>{d.abort()},n.signal.addEventListener("abort",E,{once:!0})):A=d.signal;const C=await c.stream(e,{...a,signal:A}),D=s.tapOutputIterable(o,C);for await(const O of D)if(d.signal.aborted)break}finally{await s.finish(),A&&E&&A.removeEventListener("abort",E)}}const m=p();let y=!1,w;try{for await(const A of s){if(!y){A.data.input=e,y=!0,w=A.run_id,yield A;continue}A.run_id===w&&A.event.endsWith("_end")&&(x=A.data)!=null&&x.input&&delete A.data.input,yield A}}finally{d.abort(),await m}}async*_streamEventsV1(e,n,r){let s,a=!1;const o=Et(n),u=o.tags??[],d=o.metadata??{},c=o.runName??this.getName(),p=new a0({...r,autoClose:!1,_schemaFormat:"streaming_events"}),m=new _7({...r}),y=this._streamLog(e,p,o);for await(const x of y){if(s?s=s.concat(x):s=Uv.fromRunLogPatch(x),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const D={...s.state},O={run_id:D.id,event:`on_${D.type}_start`,name:c,tags:u,metadata:d,data:{input:e}};m.includeEvent(O,D.type)&&(yield O)}const A=x.ops.filter(D=>D.path.startsWith("/logs/")).map(D=>D.path.split("/")[2]),E=[...new Set(A)];for(const D of E){let O,T={};const I=s.state.logs[D];if(I.end_time===void 0?I.streamed_output.length>0?O="stream":O="start":O="end",O==="start")I.inputs!==void 0&&(T.input=I.inputs);else if(O==="end")I.inputs!==void 0&&(T.input=I.inputs),T.output=I.final_output;else if(O==="stream"){const M=I.streamed_output.length;if(M!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${M} instead. Encountered in: "${I.name}"`);T={chunk:I.streamed_output[0]},I.streamed_output=[]}yield{event:`on_${I.type}_${O}`,name:I.name,run_id:I.id,tags:I.tags,metadata:I.metadata,data:T}}const{state:C}=s;if(C.streamed_output.length>0){const D=C.streamed_output.length;if(D!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${D} instead. Encountered in: "${C.name}"`);const O={chunk:C.streamed_output[0]};C.streamed_output=[];const T={event:`on_${C.type}_stream`,run_id:C.id,tags:u,metadata:d,name:c,data:O};m.includeEvent(T,C.type)&&(yield T)}}const w=s==null?void 0:s.state;if(w!==void 0){const x={event:`on_${w.type}_end`,name:c,run_id:w.id,tags:u,metadata:d,data:{output:w.final_output}};m.includeEvent(x,w.type)&&(yield x)}}static isRunnable(e){return Fv(e)}withListeners({onStart:e,onEnd:n,onError:r}){return new Qf({bound:this,config:{},configFactories:[s=>({callbacks:[new HM({config:s,onStart:e,onEnd:n,onError:r})]})]})}asTool(e){return k7(this,e)}},Qf=class jM extends Rn{constructor(n){super(n);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"lc_serializable",!0);z(this,"bound");z(this,"config");z(this,"kwargs");z(this,"configFactories");this.bound=n.bound,this.kwargs=n.kwargs,this.config=n.config,this.configFactories=n.configFactories}static lc_name(){return"RunnableBinding"}getName(n){return this.bound.getName(n)}async _mergeConfig(...n){const r=X_(this.config,...n);return X_(r,...this.configFactories?await Promise.all(this.configFactories.map(async s=>await s(r))):[])}withConfig(n){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...n}})}withRetry(n){return new JM({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:n==null?void 0:n.stopAfterAttempt,...n})}async invoke(n,r){return this.bound.invoke(n,await this._mergeConfig(r,this.kwargs))}async batch(n,r,s){const a=Array.isArray(r)?await Promise.all(r.map(async o=>this._mergeConfig(Et(o),this.kwargs))):await this._mergeConfig(Et(r),this.kwargs);return this.bound.batch(n,a,s)}_concatOutputChunks(n,r){return this.bound._concatOutputChunks(n,r)}async*_streamIterator(n,r){yield*this.bound._streamIterator(n,await this._mergeConfig(Et(r),this.kwargs))}async stream(n,r){return this.bound.stream(n,await this._mergeConfig(Et(r),this.kwargs))}async*transform(n,r){yield*this.bound.transform(n,await this._mergeConfig(Et(r),this.kwargs))}streamEvents(n,r,s){const a=this,o=async function*(){yield*a.bound.streamEvents(n,{...await a._mergeConfig(Et(r),a.kwargs),version:r.version},s)};return Gr.fromAsyncGenerator(o())}static isRunnableBinding(n){return n.bound&&Rn.isRunnable(n.bound)}withListeners({onStart:n,onEnd:r,onError:s}){return new jM({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new HM({config:a,onStart:n,onEnd:r,onError:s})]})]})}},rQ=class VM extends Rn{constructor(n){super(n);z(this,"lc_serializable",!0);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"bound");this.bound=n.bound}static lc_name(){return"RunnableEach"}async invoke(n,r){return this._callWithConfig(this._invoke.bind(this),n,r)}async _invoke(n,r,s){return this.bound.batch(n,yn(r,{callbacks:s==null?void 0:s.getChild()}))}withListeners({onStart:n,onEnd:r,onError:s}){return new VM({bound:this.bound.withListeners({onStart:n,onEnd:r,onError:s})})}},JM=class extends Qf{constructor(e){super(e);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"maxAttemptNumber",3);z(this,"onFailedAttempt",()=>{});this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}static lc_name(){return"RunnableRetry"}_patchConfigForRetry(e,n,r){const s=e>1?`retry:attempt:${e}`:void 0;return yn(n,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,n,r){return jf(s=>super.invoke(e,this._patchConfigForRetry(s,n,r)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,n){return this._callWithConfig(this._invoke.bind(this),e,n)}async _batch(e,n,r,s){const a={};try{await jf(async o=>{const u=e.map((y,w)=>w).filter(y=>a[y.toString()]===void 0||a[y.toString()]instanceof Error),d=u.map(y=>e[y]),c=u.map(y=>this._patchConfigForRetry(o,n==null?void 0:n[y],r==null?void 0:r[y])),p=await super.batch(d,c,{...s,returnExceptions:!0});let m;for(let y=0;y<p.length;y+=1){const w=p[y],x=u[y];w instanceof Error&&m===void 0&&(m=w,m.input=d[y]),a[x.toString()]=w}if(m)throw m;return p},{onFailedAttempt:o=>this.onFailedAttempt(o,o.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(o){if((s==null?void 0:s.returnExceptions)!==!0)throw o}return Object.keys(a).sort((o,u)=>parseInt(o,10)-parseInt(u,10)).map(o=>a[parseInt(o,10)])}async batch(e,n,r){return this._batchWithConfig(this._batch.bind(this),e,n,r)}},YM=class Au extends Rn{constructor(n){super(n);z(this,"first");z(this,"middle",[]);z(this,"last");z(this,"omitSequenceTags",!1);z(this,"lc_serializable",!0);z(this,"lc_namespace",["langchain_core","runnables"]);this.first=n.first,this.middle=n.middle??this.middle,this.last=n.last,this.name=n.name,this.omitSequenceTags=n.omitSequenceTags??this.omitSequenceTags}static lc_name(){return"RunnableSequence"}get steps(){return[this.first,...this.middle,this.last]}async invoke(n,r){var c;const s=Et(r),a=await Br(s),o=await(a==null?void 0:a.handleChainStart(this.toJSON(),gn(n,"input"),s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;let u=n,d;try{const p=[this.first,...this.middle];for(let m=0;m<p.length;m+=1){const w=p[m].invoke(u,yn(s,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${m+1}`)}));u=await qa(w,r==null?void 0:r.signal)}if((c=r==null?void 0:r.signal)!=null&&c.aborted)throw Zu(r.signal);d=await this.last.invoke(u,yn(s,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(p){throw await(o==null?void 0:o.handleChainError(p)),p}return await(o==null?void 0:o.handleChainEnd(gn(d,"output"))),d}async batch(n,r,s){var c;const a=this._getOptionsList(r??{},n.length),o=await Promise.all(a.map(Br)),u=await Promise.all(o.map(async(p,m)=>{const y=await(p==null?void 0:p.handleChainStart(this.toJSON(),gn(n[m],"input"),a[m].runId,void 0,void 0,void 0,a[m].runName));return delete a[m].runId,y}));let d=n;try{for(let p=0;p<this.steps.length;p+=1){const y=this.steps[p].batch(d,u.map((w,x)=>{const A=w==null?void 0:w.getChild(this.omitSequenceTags?void 0:`seq:step:${p+1}`);return yn(a[x],{callbacks:A})}),s);d=await qa(y,(c=a[0])==null?void 0:c.signal)}}catch(p){throw await Promise.all(u.map(m=>m==null?void 0:m.handleChainError(p))),p}return await Promise.all(u.map(p=>p==null?void 0:p.handleChainEnd(gn(d,"output")))),d}_concatOutputChunks(n,r){return this.last._concatOutputChunks(n,r)}async*_streamIterator(n,r){var y;const s=await Br(r),{runId:a,...o}=r??{},u=await(s==null?void 0:s.handleChainStart(this.toJSON(),gn(n,"input"),a,void 0,void 0,void 0,o==null?void 0:o.runName)),d=[this.first,...this.middle,this.last];let c=!0,p;async function*m(){yield n}try{let w=d[0].transform(m(),yn(o,{callbacks:u==null?void 0:u.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let x=1;x<d.length;x+=1)w=await d[x].transform(w,yn(o,{callbacks:u==null?void 0:u.getChild(this.omitSequenceTags?void 0:`seq:step:${x+1}`)}));for await(const x of w)if((y=r==null?void 0:r.signal)==null||y.throwIfAborted(),yield x,c)if(p===void 0)p=x;else try{p=this._concatOutputChunks(p,x)}catch{p=void 0,c=!1}}catch(w){throw await(u==null?void 0:u.handleChainError(w)),w}await(u==null?void 0:u.handleChainEnd(gn(p,"output")))}getGraph(n){const r=new Bv;let s=null;return this.steps.forEach((a,o)=>{const u=a.getGraph(n);o!==0&&u.trimFirstNode(),o!==this.steps.length-1&&u.trimLastNode(),r.extend(u);const d=u.firstNode();if(!d)throw new Error(`Runnable ${a} has no first node`);s&&r.addEdge(s,d),s=u.lastNode()}),r}pipe(n){return Au.isRunnableSequence(n)?new Au({first:this.first,middle:this.middle.concat([this.last,n.first,...n.middle]),last:n.last,name:this.name??n.name}):new Au({first:this.first,middle:[...this.middle,this.last],last:Ai(n),name:this.name})}static isRunnableSequence(n){return Array.isArray(n.middle)&&Rn.isRunnable(n)}static from([n,...r],s){let a={};return typeof s=="string"?a.name=s:s!==void 0&&(a=s),new Au({...a,first:Ai(n),middle:r.slice(0,-1).map(Ai),last:Ai(r[r.length-1])})}},Op=class KM extends Rn{constructor(n){super(n);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"lc_serializable",!0);z(this,"steps");this.steps={};for(const[r,s]of Object.entries(n.steps))this.steps[r]=Ai(s)}static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}static from(n){return new KM({steps:n})}async invoke(n,r){const s=Et(r),a=await Br(s),o=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:n},s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;const u={};try{const d=Object.entries(this.steps).map(async([c,p])=>{u[c]=await p.invoke(n,yn(s,{callbacks:o==null?void 0:o.getChild(`map:key:${c}`)}))});await qa(Promise.all(d),r==null?void 0:r.signal)}catch(d){throw await(o==null?void 0:o.handleChainError(d)),d}return await(o==null?void 0:o.handleChainEnd(u)),u}async*_transform(n,r,s){const a={...this.steps},o=Lv(n,Object.keys(a).length),u=new Map(Object.entries(a).map(([d,c],p)=>{const m=c.transform(o[p],yn(s,{callbacks:r==null?void 0:r.getChild(`map:key:${d}`)}));return[d,m.next().then(y=>({key:d,gen:m,result:y}))]}));for(;u.size;){const d=Promise.race(u.values()),{key:c,result:p,gen:m}=await qa(d,s==null?void 0:s.signal);u.delete(c),p.done||(yield{[c]:p.value},u.set(c,m.next().then(y=>({key:c,gen:m,result:y}))))}}transform(n,r){return this._transformStreamWithConfig(n,this._transform.bind(this),r)}async stream(n,r){async function*s(){yield n}const a=Et(r),o=new Fi({generator:this.transform(s(),a),config:a});return await o.setup,Gr.fromAsyncGenerator(o)}},I7=class WM extends Rn{constructor(n){super(n);z(this,"lc_serializable",!1);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"func");if(!Pv(n.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=n.func}async invoke(n,r){const[s]=this._getOptionsList(r??{},1),a=await Br(s),o=this.func(yn(s,{callbacks:a}),n);return qa(o,s==null?void 0:s.signal)}async*_streamIterator(n,r){var o,u;const[s]=this._getOptionsList(r??{},1),a=await this.invoke(n,r);if(i0(a)){for await(const d of a)(o=s==null?void 0:s.signal)==null||o.throwIfAborted(),yield d;return}if(C7(a)){for(;;){(u=s==null?void 0:s.signal)==null||u.throwIfAborted();const d=a.next();if(d.done)break;yield d.value}return}yield a}static from(n){return new WM({func:n})}};function R7(t){if(Pv(t))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var ZM=class XM extends Rn{constructor(n){if(Pv(n.func))return I7.from(n.func);super(n);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"func");R7(n.func),this.func=n.func}static lc_name(){return"RunnableLambda"}static from(n){return new XM({func:n})}async _invoke(n,r,s){return new Promise((a,o)=>{const u=yn(r,{callbacks:s==null?void 0:s.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??$y)-1});qr.runWithConfig(Ba(u),async()=>{var d,c;try{let p=await this.func(n,{...u});if(p&&Rn.isRunnable(p)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");p=await p.invoke(n,{...u,recursionLimit:(u.recursionLimit??$y)-1})}else if(i0(p)){let m;for await(const y of o0(u,p))if((d=r==null?void 0:r.signal)==null||d.throwIfAborted(),m===void 0)m=y;else try{m=this._concatOutputChunks(m,y)}catch{m=y}p=m}else if(zI(p)){let m;for(const y of jI(u,p))if((c=r==null?void 0:r.signal)==null||c.throwIfAborted(),m===void 0)m=y;else try{m=this._concatOutputChunks(m,y)}catch{m=y}p=m}a(p)}catch(p){o(p)}})})}async invoke(n,r){return this._callWithConfig(this._invoke.bind(this),n,r)}async*_transform(n,r,s){var d,c;let a;for await(const p of n)if(a===void 0)a=p;else try{a=this._concatOutputChunks(a,p)}catch{a=p}const o=yn(s,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((s==null?void 0:s.recursionLimit)??$y)-1}),u=await new Promise((p,m)=>{qr.runWithConfig(Ba(o),async()=>{try{const y=await this.func(a,{...o,config:o});p(y)}catch(y){m(y)}})});if(u&&Rn.isRunnable(u)){if((s==null?void 0:s.recursionLimit)===0)throw new Error("Recursion limit reached.");const p=await u.stream(a,o);for await(const m of p)yield m}else if(i0(u))for await(const p of o0(o,u))(d=s==null?void 0:s.signal)==null||d.throwIfAborted(),yield p;else if(zI(u))for(const p of jI(o,u))(c=s==null?void 0:s.signal)==null||c.throwIfAborted(),yield p;else yield u}transform(n,r){return this._transformStreamWithConfig(n,this._transform.bind(this),r)}async stream(n,r){async function*s(){yield n}const a=Et(r),o=new Fi({generator:this.transform(s(),a),config:a});return await o.setup,Gr.fromAsyncGenerator(o)}},sQ=class extends Op{},N7=class extends Rn{constructor(e){super(e);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"lc_serializable",!0);z(this,"runnable");z(this,"fallbacks");this.runnable=e.runnable,this.fallbacks=e.fallbacks}static lc_name(){return"RunnableWithFallbacks"}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,n){const r=Et(n),s=await Br(r),{runId:a,...o}=r,u=await(s==null?void 0:s.handleChainStart(this.toJSON(),gn(e,"input"),a,void 0,void 0,void 0,o==null?void 0:o.runName)),d=yn(o,{callbacks:u==null?void 0:u.getChild()});return await qr.runWithConfig(d,async()=>{var m;let p;for(const y of this.runnables()){(m=r==null?void 0:r.signal)==null||m.throwIfAborted();try{const w=await y.invoke(e,d);return await(u==null?void 0:u.handleChainEnd(gn(w,"output"))),w}catch(w){p===void 0&&(p=w)}}throw p===void 0?new Error("No error stored at end of fallback."):(await(u==null?void 0:u.handleChainError(p)),p)})}async*_streamIterator(e,n){var m;const r=Et(n),s=await Br(r),{runId:a,...o}=r,u=await(s==null?void 0:s.handleChainStart(this.toJSON(),gn(e,"input"),a,void 0,void 0,void 0,o==null?void 0:o.runName));let d,c;for(const y of this.runnables()){(m=r==null?void 0:r.signal)==null||m.throwIfAborted();const w=yn(o,{callbacks:u==null?void 0:u.getChild()});try{const x=await y.stream(e,w);c=o0(w,x);break}catch(x){d===void 0&&(d=x)}}if(c===void 0){const y=d??new Error("No error stored at end of fallback.");throw await(u==null?void 0:u.handleChainError(y)),y}let p;try{for await(const y of c){yield y;try{p=p===void 0?p:this._concatOutputChunks(p,y)}catch{p=void 0}}}catch(y){throw await(u==null?void 0:u.handleChainError(y)),y}await(u==null?void 0:u.handleChainEnd(gn(p,"output")))}async batch(e,n,r){var d;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(n??{},e.length),a=await Promise.all(s.map(c=>Br(c))),o=await Promise.all(a.map(async(c,p)=>{const m=await(c==null?void 0:c.handleChainStart(this.toJSON(),gn(e[p],"input"),s[p].runId,void 0,void 0,void 0,s[p].runName));return delete s[p].runId,m}));let u;for(const c of this.runnables()){(d=s[0].signal)==null||d.throwIfAborted();try{const p=await c.batch(e,o.map((m,y)=>yn(s[y],{callbacks:m==null?void 0:m.getChild()})),r);return await Promise.all(o.map((m,y)=>m==null?void 0:m.handleChainEnd(gn(p[y],"output")))),p}catch(p){u===void 0&&(u=p)}}throw u?(await Promise.all(o.map(c=>c==null?void 0:c.handleChainError(u))),u):new Error("No error stored at end of fallbacks.")}};function Ai(t){if(typeof t=="function")return new ZM({func:t});if(Rn.isRunnable(t))return t;if(!Array.isArray(t)&&typeof t=="object"){const e={};for(const[n,r]of Object.entries(t))e[n]=Ai(r);return new Op({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var P7=class extends Rn{constructor(e){e instanceof Op&&(e={mapper:e});super(e);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"lc_serializable",!0);z(this,"mapper");this.mapper=e.mapper}static lc_name(){return"RunnableAssign"}async invoke(e,n){const r=await this.mapper.invoke(e,n);return{...e,...r}}async*_transform(e,n,r){const s=this.mapper.getStepsKeys(),[a,o]=Lv(e),u=this.mapper.transform(o,yn(r,{callbacks:n==null?void 0:n.getChild()})),d=u.next();for await(const c of a){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const p=Object.fromEntries(Object.entries(c).filter(([m])=>!s.includes(m)));Object.keys(p).length>0&&(yield p)}yield(await d).value;for await(const c of u)yield c}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Et(n),a=new Fi({generator:this.transform(r(),s),config:s});return await a.setup,Gr.fromAsyncGenerator(a)}},M7=class extends Rn{constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e});super(e);z(this,"lc_namespace",["langchain_core","runnables"]);z(this,"lc_serializable",!0);z(this,"keys");this.keys=e.keys}static lc_name(){return"RunnablePick"}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const n=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return n.length===0?void 0:Object.fromEntries(n)}}async invoke(e,n){return this._callWithConfig(this._pick.bind(this),e,n)}async*_transform(e){for await(const n of e){const r=await this._pick(n);r!==void 0&&(yield r)}}transform(e,n){return this._transformStreamWithConfig(e,this._transform.bind(this),n)}async stream(e,n){async function*r(){yield e}const s=Et(n),a=new Fi({generator:this.transform(r(),s),config:s});return await a.setup,Gr.fromAsyncGenerator(a)}},VI=class extends Qf{constructor(e){const n=YM.from([ZM.from(async r=>{let s;if(Pu(r))try{s=await AM(this.schema,r.args)}catch{throw new zf("Received tool input did not match expected schema",JSON.stringify(r.args))}else s=r;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:n,config:e.config??{}});z(this,"name");z(this,"description");z(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function k7(t,e){const n=e.name??t.getName(),r=e.description??O9(e.schema);return EM(e.schema)?new VI({name:n,description:r,schema:ss({input:Lt()}).transform(s=>s.input),bound:t}):new VI({name:n,description:r,schema:e.schema,bound:t})}var O7={};Ft(O7,{BasePromptValue:()=>Dp,ChatPromptValue:()=>ek,ImagePromptValue:()=>D7,StringPromptValue:()=>QM});var Dp=class extends nl{},QM=class extends Dp{constructor(e){super({value:e});z(this,"lc_namespace",["langchain_core","prompt_values"]);z(this,"lc_serializable",!0);z(this,"value");this.value=e}static lc_name(){return"StringPromptValue"}toString(){return this.value}toChatMessages(){return[new pc(this.value)]}},ek=class extends Dp{constructor(e){Array.isArray(e)&&(e={messages:e});super(e);z(this,"lc_namespace",["langchain_core","prompt_values"]);z(this,"lc_serializable",!0);z(this,"messages");this.messages=e.messages}static lc_name(){return"ChatPromptValue"}toString(){return BP(this.messages)}toChatMessages(){return this.messages}},D7=class extends Dp{constructor(e){"imageUrl"in e||(e={imageUrl:e});super(e);z(this,"lc_namespace",["langchain_core","prompt_values"]);z(this,"lc_serializable",!0);z(this,"imageUrl");z(this,"value");this.imageUrl=e.imageUrl}static lc_name(){return"ImagePromptValue"}toString(){return this.imageUrl.url}toChatMessages(){return[new pc({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},Te="0123456789abcdef".split(""),L7=[-2147483648,8388608,32768,128],kr=[24,16,8,0],af=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],hn=[];function Hr(t,e){e?(hn[0]=hn[16]=hn[1]=hn[2]=hn[3]=hn[4]=hn[5]=hn[6]=hn[7]=hn[8]=hn[9]=hn[10]=hn[11]=hn[12]=hn[13]=hn[14]=hn[15]=0,this.blocks=hn):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=t}Hr.prototype.update=function(t){if(!this.finalized){var e,n=typeof t;if(n!=="string"){if(n==="object"){if(t===null)throw new Error(ERROR);if(ARRAY_BUFFER&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(t)))throw new Error(ERROR)}else throw new Error(ERROR);e=!0}for(var r,s=0,a,o=t.length,u=this.blocks;s<o;){if(this.hashed&&(this.hashed=!1,u[0]=this.block,this.block=u[16]=u[1]=u[2]=u[3]=u[4]=u[5]=u[6]=u[7]=u[8]=u[9]=u[10]=u[11]=u[12]=u[13]=u[14]=u[15]=0),e)for(a=this.start;s<o&&a<64;++s)u[a>>>2]|=t[s]<<kr[a++&3];else for(a=this.start;s<o&&a<64;++s)r=t.charCodeAt(s),r<128?u[a>>>2]|=r<<kr[a++&3]:r<2048?(u[a>>>2]|=(192|r>>>6)<<kr[a++&3],u[a>>>2]|=(128|r&63)<<kr[a++&3]):r<55296||r>=57344?(u[a>>>2]|=(224|r>>>12)<<kr[a++&3],u[a>>>2]|=(128|r>>>6&63)<<kr[a++&3],u[a>>>2]|=(128|r&63)<<kr[a++&3]):(r=65536+((r&1023)<<10|t.charCodeAt(++s)&1023),u[a>>>2]|=(240|r>>>18)<<kr[a++&3],u[a>>>2]|=(128|r>>>12&63)<<kr[a++&3],u[a>>>2]|=(128|r>>>6&63)<<kr[a++&3],u[a>>>2]|=(128|r&63)<<kr[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=u[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Hr.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>>2]|=L7[e&3],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}};Hr.prototype.hash=function(){var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,a=this.h5,o=this.h6,u=this.h7,d=this.blocks,c,p,m,y,w,x,A,E,C,D,O;for(c=16;c<64;++c)w=d[c-15],p=(w>>>7|w<<25)^(w>>>18|w<<14)^w>>>3,w=d[c-2],m=(w>>>17|w<<15)^(w>>>19|w<<13)^w>>>10,d[c]=d[c-16]+p+d[c-7]+m<<0;for(O=e&n,c=0;c<64;c+=4)this.first?(this.is224?(E=300032,w=d[0]-1413257819,u=w-150054599<<0,r=w+24177077<<0):(E=704751109,w=d[0]-210244248,u=w-1521486534<<0,r=w+143694565<<0),this.first=!1):(p=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),m=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),E=t&e,y=E^t&n^O,A=s&a^~s&o,w=u+m+A+af[c]+d[c],x=p+y,u=r+w<<0,r=w+x<<0),p=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),m=(u>>>6|u<<26)^(u>>>11|u<<21)^(u>>>25|u<<7),C=r&t,y=C^r&e^E,A=o&u^~o&s,w=a+m+A+af[c+1]+d[c+1],x=p+y,o=n+w<<0,n=w+x<<0,p=(n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10),m=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),D=n&r,y=D^n&t^C,A=a&o^~a&u,w=s+m+A+af[c+2]+d[c+2],x=p+y,a=e+w<<0,e=w+x<<0,p=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),m=(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7),O=e&n,y=O^e&r^D,A=a&o^~a&u,w=s+m+A+af[c+3]+d[c+3],x=p+y,s=t+w<<0,t=w+x<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+n<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0,this.h5=this.h5+a<<0,this.h6=this.h6+o<<0,this.h7=this.h7+u<<0};Hr.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,a=this.h5,o=this.h6,u=this.h7,d=Te[t>>>28&15]+Te[t>>>24&15]+Te[t>>>20&15]+Te[t>>>16&15]+Te[t>>>12&15]+Te[t>>>8&15]+Te[t>>>4&15]+Te[t&15]+Te[e>>>28&15]+Te[e>>>24&15]+Te[e>>>20&15]+Te[e>>>16&15]+Te[e>>>12&15]+Te[e>>>8&15]+Te[e>>>4&15]+Te[e&15]+Te[n>>>28&15]+Te[n>>>24&15]+Te[n>>>20&15]+Te[n>>>16&15]+Te[n>>>12&15]+Te[n>>>8&15]+Te[n>>>4&15]+Te[n&15]+Te[r>>>28&15]+Te[r>>>24&15]+Te[r>>>20&15]+Te[r>>>16&15]+Te[r>>>12&15]+Te[r>>>8&15]+Te[r>>>4&15]+Te[r&15]+Te[s>>>28&15]+Te[s>>>24&15]+Te[s>>>20&15]+Te[s>>>16&15]+Te[s>>>12&15]+Te[s>>>8&15]+Te[s>>>4&15]+Te[s&15]+Te[a>>>28&15]+Te[a>>>24&15]+Te[a>>>20&15]+Te[a>>>16&15]+Te[a>>>12&15]+Te[a>>>8&15]+Te[a>>>4&15]+Te[a&15]+Te[o>>>28&15]+Te[o>>>24&15]+Te[o>>>20&15]+Te[o>>>16&15]+Te[o>>>12&15]+Te[o>>>8&15]+Te[o>>>4&15]+Te[o&15];return this.is224||(d+=Te[u>>>28&15]+Te[u>>>24&15]+Te[u>>>20&15]+Te[u>>>16&15]+Te[u>>>12&15]+Te[u>>>8&15]+Te[u>>>4&15]+Te[u&15]),d};Hr.prototype.toString=Hr.prototype.hex;Hr.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,n=this.h2,r=this.h3,s=this.h4,a=this.h5,o=this.h6,u=this.h7,d=[t>>>24&255,t>>>16&255,t>>>8&255,t&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255,o>>>24&255,o>>>16&255,o>>>8&255,o&255];return this.is224||d.push(u>>>24&255,u>>>16&255,u>>>8&255,u&255),d};Hr.prototype.array=Hr.prototype.digest;Hr.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),t};const tk=(...t)=>new Hr(!1,!0).update(t.join("")).hex();var $7={};Ft($7,{sha256:()=>tk});var U7={};Ft(U7,{BaseCache:()=>rk,InMemoryCache:()=>sk,defaultHashKeyEncoder:()=>nk,deserializeStoredGeneration:()=>F7,serializeGeneration:()=>B7});const nk=(...t)=>tk(t.join("_"));function F7(t){return t.message!==void 0?{text:t.text,message:qP(t.message)}:{text:t.text}}function B7(t){const e={text:t.text};return t.message!==void 0&&(e.message=t.message.toDict()),e}var rk=class{constructor(){z(this,"keyEncoder",nk)}makeDefaultKeyEncoder(t){this.keyEncoder=t}};const q7=new Map;var sk=class ak extends rk{constructor(n){super();z(this,"cache");this.cache=n??new Map}lookup(n,r){return Promise.resolve(this.cache.get(this.keyEncoder(n,r))??null)}async update(n,r,s){this.cache.set(this.keyEncoder(n,r),s)}static global(){return new ak(q7)}},pu={},JI;function G7(){if(JI)return pu;JI=1,pu.byteLength=u,pu.toByteArray=c,pu.fromByteArray=y;for(var t=[],e=[],n=typeof Uint8Array<"u"?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,a=r.length;s<a;++s)t[s]=r[s],e[r.charCodeAt(s)]=s;e[45]=62,e[95]=63;function o(w){var x=w.length;if(x%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var A=w.indexOf("=");A===-1&&(A=x);var E=A===x?0:4-A%4;return[A,E]}function u(w){var x=o(w),A=x[0],E=x[1];return(A+E)*3/4-E}function d(w,x,A){return(x+A)*3/4-A}function c(w){var x,A=o(w),E=A[0],C=A[1],D=new n(d(w,E,C)),O=0,T=C>0?E-4:E,I;for(I=0;I<T;I+=4)x=e[w.charCodeAt(I)]<<18|e[w.charCodeAt(I+1)]<<12|e[w.charCodeAt(I+2)]<<6|e[w.charCodeAt(I+3)],D[O++]=x>>16&255,D[O++]=x>>8&255,D[O++]=x&255;return C===2&&(x=e[w.charCodeAt(I)]<<2|e[w.charCodeAt(I+1)]>>4,D[O++]=x&255),C===1&&(x=e[w.charCodeAt(I)]<<10|e[w.charCodeAt(I+1)]<<4|e[w.charCodeAt(I+2)]>>2,D[O++]=x>>8&255,D[O++]=x&255),D}function p(w){return t[w>>18&63]+t[w>>12&63]+t[w>>6&63]+t[w&63]}function m(w,x,A){for(var E,C=[],D=x;D<A;D+=3)E=(w[D]<<16&16711680)+(w[D+1]<<8&65280)+(w[D+2]&255),C.push(p(E));return C.join("")}function y(w){for(var x,A=w.length,E=A%3,C=[],D=16383,O=0,T=A-E;O<T;O+=D)C.push(m(w,O,O+D>T?T:O+D));return E===1?(x=w[A-1],C.push(t[x>>2]+t[x<<4&63]+"==")):E===2&&(x=(w[A-2]<<8)+w[A-1],C.push(t[x>>10]+t[x>>4&63]+t[x<<2&63]+"=")),C.join("")}return pu}var H7=G7();const z7=Ga(H7);var j7=Object.defineProperty,V7=(t,e,n)=>e in t?j7(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,J7=(t,e,n)=>(V7(t,e+"",n),n);function Y7(t,e){let n=Array.from({length:t.length},(r,s)=>({start:s,end:s+1}));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const a=t.slice(n[s].start,n[s+1].end),o=e.get(a.join(","));o!=null&&(r==null||o<r[0])&&(r=[o,s])}if(r!=null){const s=r[1];n[s]={start:n[s].start,end:n[s+1].end},n.splice(s+1,1)}else break}return n}function K7(t,e){return t.length===1?[e.get(t.join(","))]:Y7(t,e).map(n=>e.get(t.slice(n.start,n.end).join(","))).filter(n=>n!=null)}function W7(t){return t.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var l0=class{constructor(t,e){z(this,"specialTokens");z(this,"inverseSpecialTokens");z(this,"patStr");z(this,"textEncoder",new TextEncoder);z(this,"textDecoder",new TextDecoder("utf-8"));z(this,"rankMap",new Map);z(this,"textMap",new Map);this.patStr=t.pat_str;const n=t.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[a,o,...u]=s.split(" "),d=Number.parseInt(o,10);return u.forEach((c,p)=>r[c]=d+p),r},{});for(const[r,s]of Object.entries(n)){const a=z7.toByteArray(r);this.rankMap.set(a.join(","),s),this.textMap.set(s,a)}this.specialTokens={...t.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,a])=>(r[a]=this.textEncoder.encode(s),r),{})}encode(t,e=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=l0.specialTokenRegex(Object.keys(this.specialTokens)),a=[],o=new Set(e==="all"?Object.keys(this.specialTokens):e),u=new Set(n==="all"?Object.keys(this.specialTokens).filter(c=>!o.has(c)):n);if(u.size>0){const c=l0.specialTokenRegex([...u]),p=t.match(c);if(p!=null)throw new Error(`The text contains a special token that is not allowed: ${p[0]}`)}let d=0;for(;;){let c=null,p=d;for(;s.lastIndex=p,c=s.exec(t),!(c==null||o.has(c[0]));)p=c.index+1;const m=(c==null?void 0:c.index)??t.length;for(const w of t.substring(d,m).matchAll(r)){const x=this.textEncoder.encode(w[0]),A=this.rankMap.get(x.join(","));if(A!=null){a.push(A);continue}a.push(...K7(x,this.rankMap))}if(c==null)break;let y=this.specialTokens[c[0]];a.push(y),d=c.index+c[0].length}return a}decode(t){const e=[];let n=0;for(let a=0;a<t.length;++a){const o=t[a],u=this.textMap.get(o)??this.inverseSpecialTokens[o];u!=null&&(e.push(u),n+=u.length)}const r=new Uint8Array(n);let s=0;for(const a of e)r.set(a,s),s+=a.length;return this.textDecoder.decode(r)}},ik=l0;J7(ik,"specialTokenRegex",t=>new RegExp(t.map(e=>W7(e)).join("|"),"g"));function Z7(t){switch(t){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var X7={};Ft(X7,{encodingForModel:()=>qv,getEncoding:()=>ok});const of={},Q7=new kp({});async function ok(t){return t in of||(of[t]=Q7.fetch(`https://tiktoken.pages.dev/js/${t}.json`).then(e=>e.json()).then(e=>new ik(e)).catch(e=>{throw delete of[t],e})),await of[t]}async function qv(t){return ok(Z7(t))}var eJ={};Ft(eJ,{BaseLangChain:()=>Gv,BaseLanguageModel:()=>aJ,calculateMaxTokens:()=>rJ,getEmbeddingContextSize:()=>tJ,getModelContextSize:()=>lk,getModelNameForTiktoken:()=>Lp,isOpenAITool:()=>nJ});const Lp=t=>t.startsWith("gpt-5")?"gpt-5":t.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":t.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":t.startsWith("gpt-4-32k")?"gpt-4-32k":t.startsWith("gpt-4-")?"gpt-4":t.startsWith("gpt-4o")?"gpt-4o":t,tJ=t=>{switch(t){case"text-embedding-ada-002":return 8191;default:return 2046}},lk=t=>{switch(Lp(t)){case"gpt-5":case"gpt-5-turbo":case"gpt-5-turbo-preview":return 4e5;case"gpt-4o":case"gpt-4o-mini":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":return 128e3;case"gpt-4-turbo":case"gpt-4-turbo-preview":case"gpt-4-turbo-2024-04-09":case"gpt-4-0125-preview":case"gpt-4-1106-preview":return 128e3;case"gpt-4-32k":case"gpt-4-32k-0314":case"gpt-4-32k-0613":return 32768;case"gpt-4":case"gpt-4-0314":case"gpt-4-0613":return 8192;case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-16k-0613":return 16384;case"gpt-3.5-turbo":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-1106":case"gpt-3.5-turbo-0125":return 4096;case"text-davinci-003":case"text-davinci-002":return 4097;case"text-davinci-001":return 2049;case"text-curie-001":case"text-babbage-001":case"text-ada-001":return 2048;case"code-davinci-002":case"code-davinci-001":return 8e3;case"code-cushman-001":return 2048;case"claude-3-5-sonnet-20241022":case"claude-3-5-sonnet-20240620":case"claude-3-opus-20240229":case"claude-3-sonnet-20240229":case"claude-3-haiku-20240307":case"claude-2.1":return 2e5;case"claude-2.0":case"claude-instant-1.2":return 1e5;case"gemini-1.5-pro":case"gemini-1.5-pro-latest":case"gemini-1.5-flash":case"gemini-1.5-flash-latest":return 1e6;case"gemini-pro":case"gemini-pro-vision":return 32768;default:return 4097}};function nJ(t){return typeof t!="object"||!t?!1:!!("type"in t&&t.type==="function"&&"function"in t&&typeof t.function=="object"&&t.function&&"name"in t.function&&"parameters"in t.function)}const rJ=async({prompt:t,modelName:e})=>{let n;try{n=(await qv(Lp(e))).encode(t).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count"),n=Math.ceil(t.length/4)}return lk(e)-n},sJ=()=>!1;var Gv=class extends Rn{constructor(e){super(e);z(this,"verbose");z(this,"callbacks");z(this,"tags");z(this,"metadata");this.verbose=e.verbose??sJ(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}get lc_attributes(){return{callbacks:void 0,verbose:void 0}}},aJ=class extends Gv{constructor({callbacks:e,callbackManager:n,...r}){const{cache:s,...a}=r;super({callbacks:e??n,...a});z(this,"caller");z(this,"cache");z(this,"_encoding");typeof s=="object"?this.cache=s:s?this.cache=sk.global():this.cache=void 0,this.caller=new kp(r??{})}get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}async getNumTokens(e){let n;typeof e=="string"?n=e:n=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let r=Math.ceil(n.length/4);if(!this._encoding)try{this._encoding=await qv("modelName"in this?Lp(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{r=this._encoding.encode(n).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return r}static _convertInputToPromptValue(e){return typeof e=="string"?new QM(e):Array.isArray(e)?new ek(e.map(Tj)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...n}){const r={...this._identifyingParams(),...n,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([o,u])=>u!==void 0).map(([o,u])=>`${o}:${JSON.stringify(u)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};function uk(t){return t!==void 0&&Array.isArray(t.lc_namespace)}function ck(t){return t!==void 0&&Rn.isRunnable(t)&&"lc_name"in t.constructor&&typeof t.constructor.lc_name=="function"&&t.constructor.lc_name()==="RunnableToolLike"}function dk(t){return!!t&&typeof t=="object"&&"name"in t&&"schema"in t&&(Dv(t.schema)||t.schema!=null&&typeof t.schema=="object"&&"type"in t.schema&&typeof t.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(t.schema.type))}function iJ(t){return dk(t)||ck(t)||uk(t)}var oJ={};Ft(oJ,{BaseToolkit:()=>lJ,DynamicStructuredTool:()=>hk,DynamicTool:()=>pk,StructuredTool:()=>Ei,Tool:()=>fk,ToolInputParsingException:()=>zf,isLangChainTool:()=>iJ,isRunnableToolLike:()=>ck,isStructuredTool:()=>uk,isStructuredToolParams:()=>dk,tool:()=>uJ});var Ei=class extends Gv{constructor(e){super(e??{});z(this,"returnDirect",!1);z(this,"verboseParsingErrors",!1);z(this,"responseFormat","content");z(this,"defaultConfig");this.verboseParsingErrors=(e==null?void 0:e.verboseParsingErrors)??this.verboseParsingErrors,this.responseFormat=(e==null?void 0:e.responseFormat)??this.responseFormat,this.defaultConfig=(e==null?void 0:e.defaultConfig)??this.defaultConfig,this.metadata=(e==null?void 0:e.metadata)??this.metadata}get lc_namespace(){return["langchain","tools"]}async invoke(e,n){let r,s=Et(X_(this.defaultConfig,n));return Pu(e)?(r=e.args,s={...s,toolCall:e}):r=e,this.call(r,s)}async call(e,n,r){const s=Pu(e)?e.args:e;let a;if(Dv(this.schema))try{a=await AM(this.schema,s)}catch(x){let A="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(A=`${A}
Details: ${x.message}`),x instanceof Error&&x.constructor.name==="ZodError"&&(A=`${A}

${S9(x)}`),new zf(A,JSON.stringify(e))}else{const x=Dt(s,this.schema);if(!x.valid){let A="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(A=`${A}
Details: ${x.errors.map(E=>`${E.keywordLocation}: ${E.error}`).join(`
`)}`),new zf(A,JSON.stringify(e))}a=s}const o=Pp(n),u=Ja.configure(o.callbacks,this.callbacks,o.tags||r,this.tags,o.metadata,this.metadata,{verbose:this.verbose}),d=await(u==null?void 0:u.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),o.runId,void 0,void 0,void 0,o.runName));delete o.runId;let c;try{c=await this._call(a,d,o)}catch(x){throw await(d==null?void 0:d.handleToolError(x)),x}let p,m;if(this.responseFormat==="content_and_artifact")if(Array.isArray(c)&&c.length===2)[p,m]=c;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(c)}`);else p=c;let y;Pu(e)&&(y=e.id),!y&&rj(o)&&(y=o.toolCall.id);const w=cJ({content:p,artifact:m,toolCallId:y,name:this.name,metadata:this.metadata});return await(d==null?void 0:d.handleToolEnd(w)),w}},fk=class extends Ei{constructor(e){super(e);z(this,"schema",ss({input:Lt().optional()}).transform(e=>e.input))}call(e,n){const r=typeof e=="string"||e==null?{input:e}:e;return super.call(r,n)}},pk=class extends fk{constructor(e){super(e);z(this,"name");z(this,"description");z(this,"func");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}static lc_name(){return"DynamicTool"}async call(e,n){const r=Pp(n);return r.runName===void 0&&(r.runName=this.name),super.call(e,r)}async _call(e,n,r){return this.func(e,n,r)}},hk=class extends Ei{constructor(e){super(e);z(this,"name");z(this,"description");z(this,"func");z(this,"schema");this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}static lc_name(){return"DynamicStructuredTool"}async call(e,n,r){const s=Pp(n);return s.runName===void 0&&(s.runName=this.name),super.call(e,s,r)}_call(e,n,r){return this.func(e,n,r)}},lJ=class{getTools(){return this.tools}};function uJ(t,e){var o;const n=EM(e.schema),r=Lu(e.schema);if(!e.schema||n||r)return new pk({...e,description:e.description??((o=e.schema)==null?void 0:o.description)??`${e.name} tool`,func:async(u,d,c)=>new Promise((p,m)=>{const y=yn(c,{callbacks:d==null?void 0:d.getChild()});qr.runWithConfig(Ba(y),async()=>{try{p(t(u,y))}catch(w){m(w)}})})});const s=e.schema,a=e.description??e.schema.description??`${e.name} tool`;return new hk({...e,description:a,schema:s,func:async(u,d,c)=>new Promise((p,m)=>{let y;const w=()=>{c!=null&&c.signal&&y&&c.signal.removeEventListener("abort",y)};c!=null&&c.signal&&(y=()=>{w(),m(Zu(c.signal))},c.signal.addEventListener("abort",y));const x=yn(c,{callbacks:d==null?void 0:d.getChild()});qr.runWithConfig(Ba(x),async()=>{var A;try{const E=await t(u,x);if((A=c==null?void 0:c.signal)!=null&&A.aborted){w();return}w(),p(E)}catch(E){w(),m(E)}})})})}function cJ(t){const{content:e,artifact:n,toolCallId:r,metadata:s}=t;return r&&!OP(e)?typeof e=="string"||Array.isArray(e)&&e.every(a=>typeof a=="object")?new Ju({status:"success",content:e,artifact:n,tool_call_id:r,name:t.name,metadata:s}):new Ju({status:"success",content:dJ(e),artifact:n,tool_call_id:r,name:t.name,metadata:s}):e}function dJ(t){try{return JSON.stringify(t,null,2)??""}catch{return`${t}`}}const Yt={FULL_SCAN_BLOCKED:"FULL_SCAN_BLOCKED",AGG_TIMEOUT:"AGG_TIMEOUT",COLUMN_METADATA_MISSING:"COLUMN_METADATA_MISSING",VERSION_ERROR:"VERSION_ERROR",ORIGIN_BLOCKED:"ORIGIN_BLOCKED",DATASET_UNCHANGED:"DATASET_UNCHANGED",INDEXEDDB_UNAVAILABLE:"INDEXEDDB_UNAVAILABLE",UNKNOWN:"UNKNOWN"},fJ="COLUMN_METADATA_MISSING",Hv=()=>{throw Object.assign(new Error(Yt.COLUMN_METADATA_MISSING),{code:Yt.COLUMN_METADATA_MISSING})},pJ=t=>{let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e).toString(36)},mk=t=>{const e=t.caseStrategy==="lower"?n=>n.toLowerCase():n=>n;return n=>{if(n==null)return t.nullReplacement;let r=typeof n=="string"?n:String(n);return t.trimWhitespace&&(r=r.trim()),r.length===0?t.nullReplacement:e(r)}},hJ=mk(fc()),mJ=(t,e=hJ)=>e(t),gJ=(t,e,n=3)=>{const r=[];for(const s of t){const a=s[e];if(a==null||a==="")continue;const o=mJ(a);if(o&&(r.includes(o)||r.push(o),r.length>=n))break}return r},yJ=async(t,e)=>{const{datasetId:n,sampleSize:r=wP}=e;if(!n)throw new Error("datasetId is required for profiling.");const[s,a]=await Promise.all([t.readColumnStoreRecord(n),t.readSampledRows(n,r)]);if(s||Hv(),a.length===0)throw new Error("No rows available to profile.");const u=$u(a).map(c=>({name:c.name,type:c.type,distinct:c.uniqueValues??new Set(a.map(p=>p[c.name])).size,emptyPercentage:c.missingPercentage??0,examples:gJ(a,c.name)})),d=[];return s.rowCount>a.length&&d.push(`Profiled ${a.length.toLocaleString()} rows (sample) out of ${s.rowCount.toLocaleString()}.`),{rowCount:s.rowCount,sampledRows:a.length,columns:u,warnings:d}},_J=(t,e,n)=>!e||e.length===0?!0:e.every(r=>{const s=t[r.column],a=n(s),o=n(r.value??""),u=d=>r.caseInsensitive?d.toLowerCase():d;switch(r.op){case"eq":return u(a)===u(o);case"neq":return u(a)!==u(o);case"gt":return Number(a)>Number(o);case"gte":return Number(a)>=Number(o);case"lt":return Number(a)<Number(o);case"lte":return Number(a)<=Number(o);case"contains":{const d=a.toLowerCase(),c=o.toLowerCase();return d.includes(c)}case"in":{if(!Array.isArray(r.values))return!1;const d=r.values.map(m=>n(m)),c=new Set(d.map(m=>r.caseInsensitive?m.toLowerCase():m)),p=r.caseInsensitive?a.toLowerCase():a;return c.has(p)}default:return!0}}),YI=(t,e,n,r,s)=>{var T;const a=e.mode??"full";if(!Array.isArray(e.metrics)||e.metrics.length===0)throw new Error("metrics[] is required for aggregation.");if(a==="full"&&!e.allowFullScan)throw Object.assign(new Error(Yt.FULL_SCAN_BLOCKED),{code:Yt.FULL_SCAN_BLOCKED});const o=e.by??[],u=new Map,d=((T=e.filter)==null?void 0:T.length)??0,c=e.timeoutMs??SP,p=(typeof performance<"u"?performance.now():Date.now())+c,m=fc(s),y=mk(m);for(const I of t){if(!_J(I,e.filter,y))continue;if((typeof performance<"u"?performance.now():Date.now())>p){if(a==="full")throw new Error("AGG_TIMEOUT");break}const N=o.map($=>y(I[$])),P=N.length>0?N.join("||"):"__total__";if(!u.has(P)){const $={};o.forEach((F,K)=>{$[F]=N[K]});const U={};e.metrics.forEach(F=>{const K=F.as??`${F.fn}_${F.column??"rows"}`;U[K]={sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}}),u.set(P,{keys:$,accumulators:U})}const k=u.get(P);e.metrics.forEach($=>{const U=$.as??`${$.fn}_${$.column??"rows"}`,F=k.accumulators[U];if($.fn==="count"){F.count+=1,F.sum+=1;return}if(!$.column)throw new Error(`Metric ${$.fn} requires a column.`);const K=or(I[$.column]);K!==null&&(F.count+=1,F.sum+=K,F.min=Math.min(F.min,K),F.max=Math.max(F.max,K))})}const w=I=>{if(!I||!r)return"number";const M=r.find(N=>N.name===I);return!M||M.type==="numerical"?"number":M.type},x=[...o.map(I=>{var M;return{name:I,type:((M=r==null?void 0:r.find(N=>N.name===I))==null?void 0:M.type)??"string"}}),...e.metrics.map(I=>({name:I.as??`${I.fn}_${I.column??"rows"}`,type:I.fn==="count"?"number":w(I.column)}))],A=[];for(const I of u.values()){const M={...I.keys};e.metrics.forEach(N=>{const P=N.as??`${N.fn}_${N.column??"rows"}`,k=I.accumulators[P];let $=null;switch(N.fn){case"sum":$=k.sum;break;case"avg":$=k.count>0?k.sum/k.count:null;break;case"count":$=k.count;break;case"min":$=k.min===Number.POSITIVE_INFINITY?null:k.min;break;case"max":$=k.max===Number.NEGATIVE_INFINITY?null:k.max;break}M[P]=$??0}),A.push(M)}e.orderBy&&e.orderBy.length>0&&A.sort((I,M)=>{for(const N of e.orderBy){const P=(N.direction??"desc").toLowerCase()==="asc"?1:-1,k=I[N.column],$=M[N.column];if(k===$)continue;if(k==null)return 1;if($==null)return-1;if(typeof k=="number"&&typeof $=="number")return k>$?P:-P;const U=String(k).localeCompare(String($));if(U!==0)return U*P}return 0});const E=typeof e.limit=="number"?A.slice(0,e.limit):A,C=t.length,D=a!=="full"&&C<n,O=[];return D&&O.push("Aggregated on sampled rows. Retry with allowFullScan for full coverage."),{schema:x,rows:E,provenance:{datasetId:e.datasetId,sampled:D,mode:a,processedRows:C,totalRows:n,queryHash:pJ(JSON.stringify({by:o,metrics:e.metrics,filter:e.filter,orderBy:e.orderBy,limit:e.limit,mode:a})),filterCount:d,warnings:O,normalization:xP(m)}}},vJ=async(t,e)=>{const[n,r]=await Promise.all([t.readColumnStoreRecord(e.datasetId),t.readDatasetRuntimeConfig(e.datasetId)]);n||Hv();const s=e.mode??"full",a=s;e.mode=a;const o=e.sampleSize??bP;try{const u=a==="full"?await t.readAllRows(e.datasetId):await t.readSampledRows(e.datasetId,o);if(u.length===0)throw new Error("No rows available for aggregation.");const d=YI(u,e,n.rowCount,n.columns,r==null?void 0:r.stringStrategy);return d.provenance.requestedMode=s,d}catch(u){if(u instanceof Error&&(u.code===Yt.FULL_SCAN_BLOCKED||u.message===Yt.FULL_SCAN_BLOCKED))throw Object.assign(new Error("Full scan requires confirmation."),{code:Yt.FULL_SCAN_BLOCKED});if(u instanceof Error&&u.message==="AGG_TIMEOUT"&&a==="full"){const d=await t.readSampledRows(e.datasetId,o),c=YI(d,{...e,mode:"sample"},n.rowCount,n.columns,r==null?void 0:r.stringStrategy);return c.provenance.warnings.push("Full scan timed out. "),c.provenance.requestedMode=s,c.provenance.downgradedFrom=s,c.provenance.downgradeReason="timeout",c}throw u instanceof Error&&u.message==="AGG_TIMEOUT"?Object.assign(u,{code:Yt.AGG_TIMEOUT}):u}},wJ=async(t,e)=>{const{datasetId:n,n:r=VH,withColumns:s=!1}=e;if(!n)throw new Error("datasetId is required for sampling.");const[a,o]=await Promise.all([t.readSampledRows(n,r),s?t.readColumnStoreRecord(n):Promise.resolve(null)]);if(s&&!o&&Hv(),a.length===0)throw new Error("No rows available to sample.");return{rows:a,sampled:!0,columns:o==null?void 0:o.columns}};let Mi=null;const qo=new Map;let bf=null;const bJ=()=>{if(typeof window>"u"||typeof Worker>"u")throw new Error("Web Workers are not supported in this environment.");const t=new Worker(new URL("/agent_csv_dataWorker-sxes9h5U.js",import.meta.url),{type:"module"});return t.onmessage=e=>{const n=e.data;if(!n||typeof n.id!="string")return;const r=qo.get(n.id);r&&(qo.delete(n.id),r(n))},t.onerror=e=>{console.error("dataWorker runtime error:",e);const n=e!=null&&e.message&&typeof e.message=="string"?`Data worker crashed: ${e.message}`:"Data worker crashed.";qo.forEach(r=>r({id:"error",ok:!1,reason:n,hint:"Reload and retry your action."})),qo.clear(),t.terminate(),Mi=null},t},SJ=()=>(Mi=Mi??bJ(),Mi),xJ=async(t,e)=>{try{const n=SJ(),r=`${t}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;return await new Promise(s=>{qo.set(r,a=>{a.ok&&a.result?s({ok:!0,data:a.result,durationMs:a.durationMs??0}):s({ok:!1,reason:a.reason??"Worker failed to respond.",hint:a.hint,durationMs:a.durationMs,code:a.code})}),n.postMessage({id:r,action:t,payload:e})})}catch(n){return{ok:!1,reason:n instanceof Error?n.message:"Failed to start worker.",hint:"This browser may not support Web Workers. Try a modern Chromium-based browser."}}},TJ=t=>{bf||(bf=t??"Data worker disabled due to browser limitations.",Mi&&(Mi.terminate(),Mi=null),qo.clear(),console.warn(`[dataTools] Worker disabled: ${bf}`))},AJ=(t,e)=>{const n=`${t??""} ${e??""}`.toLowerCase();return n.includes("indexeddb")||n.includes("falling back to main thread")},rl=()=>typeof performance<"u"?performance.now():Date.now(),zv=t=>t instanceof Error?t.message:String(t??"Unknown error"),KI=t=>typeof t!="string"?!1:t.toUpperCase().includes(fJ),EJ=async t=>{try{return await yz(t)?(console.info(`[dataTools] Rebuilt column metadata for dataset ${t}.`),!0):(console.warn(`[dataTools] Unable to rebuild column metadata for dataset ${t}.`),!1)}catch(e){return console.error(`[dataTools] Failed to recover column metadata for dataset ${t}.`,e),!1}},Gy=async(t,e)=>{let n=await e();if(!t||n.ok||!KI(n.reason))return n;if(!await EJ(t))return{ok:!1,reason:"Cached column metadata is unavailable and auto-recovery failed. Please re-upload your CSV.",hint:n.hint,durationMs:n.durationMs};const s=await e();return!s.ok&&KI(s.reason)?{ok:!1,reason:"Cached column metadata is still missing. Please re-upload your CSV.",hint:s.hint,durationMs:s.durationMs}:s},jv={readColumnStoreRecord:mv,readSampledRows:IP,readAllRows:RP,readDatasetRuntimeConfig:CP},CJ=async(t,e)=>{try{const n=rl();return{ok:!0,data:await yJ(jv,{datasetId:t,sampleSize:e}),durationMs:rl()-n}}catch(n){return{ok:!1,reason:zv(n)}}},IJ=async(t,e)=>{try{const n=rl();return{ok:!0,data:await wJ(jv,{datasetId:t,...e}),durationMs:rl()-n}}catch(n){return{ok:!1,reason:zv(n)}}},RJ=async t=>{try{const e=rl();return{ok:!0,data:await vJ(jv,t),durationMs:rl()-e}}catch(e){return{ok:!1,reason:zv(e)}}},Hy=async(t,e,n)=>{if(bf)return n();const r=await xJ(t,e);return!r.ok&&AJ(r.reason,r.hint)?(TJ(r.reason??r.hint),n()):r},Ls={profile:(t,e)=>Gy(t,()=>Hy("profile",{datasetId:t,sampleSize:e},()=>CJ(t,e))),sample:(t,e)=>Gy(t,()=>Hy("sample",{datasetId:t,...e??{}},()=>IJ(t,e??{}))),aggregate:t=>Gy(t.datasetId,()=>Hy("aggregate",t,()=>RJ(t))),createCardFromResult:async({datasetId:t,title:e,kind:n,explainer:r,result:s,plan:a})=>{try{const o={schema:s.schema,rows:s.rows,sampled:s.provenance.sampled,source:"aggregate",planSnapshot:a};return{ok:!0,data:{cardId:await AP({datasetId:t,title:e,kind:n,queryHash:s.provenance.queryHash,explainer:r,dataRef:o})},durationMs:0}}catch(o){return{ok:!1,reason:o instanceof Error?o.message:"Failed to store card.",hint:"Retry after checking IndexedDB permissions."}}}},u0=(t,e,n,r,s)=>{var E;if(!e||t.chartType==="scatter"||t.chartType==="combo"||!t.groupByColumn||!t.aggregation||t.aggregation!=="count"&&!t.valueColumn)return null;const a=t.valueColumn??"count",o=t.chartType==="line"?[{column:t.groupByColumn,direction:"asc"}]:[{column:a,direction:"desc"}],u=t.orderBy&&t.orderBy.length>0?t.orderBy.map(C=>({column:C.column,direction:C.direction??(t.chartType==="line"?"asc":"desc")})):o,d=(s==null?void 0:s.runtimeConfig)??null,c=r??((E=n==null?void 0:n.data)==null?void 0:E.length)??0,p=c>0?Math.min(5e3,c):5e3,m=(d==null?void 0:d.sampleSize)??p,y=c>0&&c<=JH,w=typeof t.limit=="number"?t.limit:t.defaultTopN,x={datasetId:e,by:[t.groupByColumn],metrics:[{fn:t.aggregation,column:t.aggregation==="count"?void 0:t.valueColumn,as:a}],filter:t.rowFilter?[{column:t.rowFilter.column,op:"in",values:t.rowFilter.values}]:void 0,limit:typeof w=="number"?w:void 0,mode:y?"full":"sample",sampleSize:m,orderBy:u,allowFullScan:(d==null?void 0:d.allowFullScan)??y,timeoutMs:d==null?void 0:d.timeoutMs},A=(s==null?void 0:s.preferredMode)??(d==null?void 0:d.mode);return y||A==="full"?(x.mode="full",x.allowFullScan=!0):(x.mode="sample",x.allowFullScan=(d==null?void 0:d.allowFullScan)??!1),x};class Ur extends Error{constructor(e,n){super(e),this.name="GraphToolExecutionError",this.code=n==null?void 0:n.code,this.suggestion=n==null?void 0:n.suggestion}}const NJ=t=>{if(typeof t=="string"){const e=t.match(/(\d{4})[-/.](\d{1,2})/);if(e){const n=String(e[2]).padStart(2,"0");return`${e[1]}-${n}`}}return null},PJ=async t=>{const{plan:e,datasetId:n,csvData:r,rowCountHint:s,options:a}=t,o=u0(e,n,r,s,a);if(!o)throw new Ur("Plan is not eligible for aggregate tool.");const u=await Ls.aggregate(o);if(!u.ok)throw new Ur(u.reason??"Aggregate tool failed.",{code:u.code,suggestion:u.hint});const d=u.data,c={source:d.provenance.mode,rows:d.rows.length,warnings:d.provenance.warnings??[],processedRows:d.provenance.processedRows,totalRows:d.provenance.totalRows,durationMs:u.durationMs??0},p=` ${e.title??"analysis"}: ${c.rows} ${c.source} ${c.warnings.length}`,m={kind:"aggregate_plan",planTitle:e.title??"analysis",rows:c.rows,viewId:d.provenance.queryHash};return{summary:p,meta:c,payload:m,rows:d.rows,schema:d.schema,viewId:d.provenance.queryHash}},MJ=async(t,e)=>{if(!t)throw new Ur("Dataset unavailable for profiling.");const n=await Ls.profile(t,e);if(!n.ok)throw new Ur(n.reason??"Profile tool failed.",{code:n.code,suggestion:n.hint});const r=`${n.data.columns.length}   ${n.data.rowCount.toLocaleString()}  ${n.data.sampledRows.toLocaleString()}`,s={source:n.data.sampledRows===n.data.rowCount?"full":"sample",rows:n.data.rowCount,warnings:n.data.warnings??[],processedRows:n.data.sampledRows,totalRows:n.data.rowCount,durationMs:n.durationMs??0},a={kind:"profile_dataset",columns:n.data.columns.length,rowCount:n.data.rowCount,sampledRows:n.data.sampledRows};return{summary:r,meta:s,payload:a,context:n.data}},kJ=(t,e="InvoiceMonth")=>{if(!t)throw new Ur("Dataset unavailable for normalization.");let n=0,r=0;const s=new Set;for(const c of t.data){const p=NJ(c[e]);p?(n++,s.size<6&&s.add(p)):r++}const a=n+r,o=` ${e} ${n.toLocaleString()} ${r.toLocaleString()}`,u={source:"full",rows:n,warnings:r?[`Skipped ${r} rows`]:[],processedRows:a,totalRows:a,durationMs:0},d={kind:"normalize_invoice_month",column:e,normalizedCount:n,skippedCount:r,sampleValues:Array.from(s)};return{summary:o,meta:u,payload:d}},OJ=(t,e,n=2)=>{if(!t)throw new Ur("Dataset unavailable for outlier detection.");const r=t.data.map(y=>Number(y[e])).filter(y=>Number.isFinite(y));if(r.length===0)return{summary:` ${e}`,meta:{source:"full",rows:0,warnings:["No numeric values detected."],processedRows:t.data.length,totalRows:t.data.length,durationMs:0},payload:{kind:"detect_outliers",column:e,threshold:0,count:0,rows:[]}};const s=r.reduce((y,w)=>y+w,0)/r.length,a=r.reduce((y,w)=>y+Math.pow(w-s,2),0)/r.length,o=Math.sqrt(a),u=s+n*o,d=t.data.filter(y=>Number(y[e])>u).map(y=>{var w;return{label:y.id??((w=y[e])==null?void 0:w.toString())??"row",value:Number(y[e])}}).sort((y,w)=>w.value-y.value).slice(0,5),c=` ${e} ${d.length.toLocaleString()}  ${u.toFixed(2)}`,p={source:"full",rows:d.length,warnings:[],processedRows:t.data.length,totalRows:t.data.length,durationMs:0},m={kind:"detect_outliers",column:e,threshold:Number(u.toFixed(2)),count:d.length,rows:d};return{summary:c,meta:p,payload:m}},$s={aggregatePlan:PJ,profileDataset:MJ,normalizeInvoiceMonth:kJ,detectOutliers:OJ},DJ=t=>{const e=()=>{const d=t.getDatasetId();if(!d)throw new Error("Dataset is not loaded.");return d},n=()=>{const d=t.getCsvData();if(!d||d.data.length===0)throw new Error("CSV data is not available.");return d},r=new Ei({name:"csv_profile_dataset",description:"Profile the current dataset to understand columns, row count, and sample distribution.",schema:ss({sampleSize:rs().int().positive().max(1e4).optional().describe("Optional sample size override.")}),func:async({sampleSize:d})=>{const c=e();return $s.profileDataset(c,d)}}),s=new Ei({name:"csv_clean_invoice_month",description:"Normalize an Invoice month column to YYYY-MM format.",schema:ss({column:Lt().default("InvoiceMonth")}),func:async({column:d})=>{const c=n();return $s.normalizeInvoiceMonth(c,d)}}),a=new Ei({name:"csv_detect_outliers",description:"Detect top outliers for a numeric column using mean + std multiplier.",schema:ss({valueColumn:Lt(),thresholdMultiplier:rs().positive().default(2)}),func:async({valueColumn:d,thresholdMultiplier:c})=>{const p=n();return $s.detectOutliers(p,d,c)}}),o=ss({chartType:Lt(),title:Lt(),description:Lt().default(""),aggregation:Lt().optional(),groupByColumn:Lt().optional(),valueColumn:Lt().optional(),xValueColumn:Lt().optional(),yValueColumn:Lt().optional(),secondaryValueColumn:Lt().optional(),secondaryAggregation:Lt().optional(),defaultTopN:rs().optional(),defaultHideOthers:Bf().optional(),limit:rs().int().positive().nullable().optional()}),u=new Ei({name:"csv_aggregate_plan",description:"Execute the current analysis plan against the dataset and return aggregate rows.",schema:ss({plan:o.partial().optional(),rowCountHint:rs().int().positive().optional()}),func:async({plan:d,rowCountHint:c})=>{const p=e(),m=t.getCsvData(),y=d??t.getCurrentPlan();if(!y||!m)throw new Error("Analysis plan is not available.");return $s.aggregatePlan({plan:y,datasetId:p,csvData:m,rowCountHint:c})}});return{profileDatasetTool:r,normalizeInvoiceMonthTool:s,detectOutliersTool:a,aggregatePlanTool:u}},LJ={allowLooseSteps:!1},$J=["seed","conversation","context","action"],UJ={observe:["seed","conversation"],plan:["conversation","context"],act:["context","action"],verify:["action"],idle:["seed","conversation"]},WI={seed:"Seed",conversation:"Conversation",context:"Context",action:"Action"},FJ=t=>[...UJ[t??"observe"]??[],...$J].filter((s,a,o)=>o.indexOf(s)===a),BJ=new Set(hP),gk=/^(\d{5,})-(\d+)(?:-[\w-]+)?$/,qJ=5e3,GJ=8e3,yk="Begin every response with a plan_state_update that lists your goal, context, progress, next steps, blockers (or null), referenced observations, confidence, and updatedAt before any other action. Immediately after the plan_state_update, include a short text_response (in Mandarin) that restates the users latest question or intent in your own words so they know you understood it.",ZI=3,_k=2,HJ=2,zJ=1,jJ=new Set(["awaiting_clarification","blocked"]),yc="ad_hoc_response",VJ={id:"acknowledge_user_greeting"},JJ={title:" / Quick start",helperText:"",actions:[{id:"profile_dataset",label:" ",helperText:""},{id:"open_raw_preview",label:" ",helperText:" Raw Data Explorer"},{id:"topn_quick_chart",label:" Top-N ",helperText:" Top-N"}]},vk="show entire table",YJ=["reset plan","start over","","","",""],wk=/^(hi|hello|hey|hola|ciao|salut|+|||||||)([!.?\s]|$)/i,KJ="Requesting simplified plan outline...",WJ=jH(),XI=400,ZJ=25;let c0=!1,bk=0;const QI=t=>{const e=t.match(gk);return e?{epochMs:Number(e[1]),seq:Number(e[2]),raw:t}:null},Sf=()=>Ek(),XJ=t=>{const e=t.trim().toLowerCase();return e?!!YJ.some(n=>e.includes(n)):!1},QJ=["text_response","await_user","plan_creation","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request","plan_state_update"],eY={plan_update:"plan_state_update",planstateupdate:"plan_state_update",planstep:"plan_state_update",domaction:"dom_action",agent_action:"text_response",agentmessage:"text_response",respond:"text_response",awaituser:"await_user",await_user:"await_user",awaiting_user:"await_user"},Sk=new Set(["greeting","smalltalk","ask_user_choice"]),tY=new Set(["greeting","clarification","clarification_request","ask_user_choice"]),nY=/(^|\n)\s*(?:\d+[\.\)]|[A-Z][\.\)]|[-]\s*(?:option|choice)\s*\d+)/i,rY=/\b(option|choice|||Type a custom answer|please\s+(?:choose|select|pick)|would\s+you\s+like|should\s+i|need\s+your\s+choice|||||)\b/i,sY=/prompt[-\s]*([A-Za-z0-9_-]+)/i,xk=t=>{if(!t)return!1;const e=t.trim();return e?!!(nY.test(e)||/[?]/.test(e)||rY.test(e)||/Type a custom answer/i.test(e)):!1},sl=t=>{const e=t.meta??(t.meta={awaitUser:!1,haltAfter:!1,resumePlanner:!1,promptId:""});return e.awaitUser=!!e.awaitUser,e.haltAfter=!!e.haltAfter,e.resumePlanner=!!e.resumePlanner,e.promptId=typeof e.promptId=="string"?e.promptId:"",e},Vv=t=>{const e=t.find(n=>n.responseType==="plan_state_update");return e?(e.stateTag="awaiting_clarification",$a(e)&&(e.planState.stateTag="awaiting_clarification"),!0):!1},aY=t=>{t.type="await_user",t.responseType="await_user";const e=sl(t);if(e.awaitUser=!0,e.haltAfter=!0,!e.promptId){const n=(t.text??"").match(sY);e.promptId=(n==null?void 0:n[1])??ec()}},iY=t=>{if(!Array.isArray(t)||t.length===0)return!1;const e=[...t].reverse().find(n=>(n.responseType==="text_response"||n.responseType==="await_user")&&typeof n.text=="string"&&n.text.trim().length>0);return!e||e.responseType!=="await_user"&&!xk(e.text)?!1:(aY(e),Vv(t),!0)},oY=(t,e)=>{if(!Array.isArray(t)||t.length===0)return;const n=t.find(a=>a.responseType==="plan_state_update"),r=a=>{if(!n)return;const o=sl(n);if(o.awaitUser=!0,o.haltAfter=!0,o.promptId=o.promptId||a||ec(),$a(n))n.planState={...n.planState,blockedBy:"awaiting_user_choice"};else{const u=nc(e,e.get().plannerSession.planState??void 0);u.blockedBy="awaiting_user_choice",n.planState=u,e.get().updatePlannerPlanState(u)}};let s=!1;t.forEach(a=>{if(a.responseType!=="clarification_request")return;s=!0;const o=sl(a);o.awaitUser=!0,o.haltAfter=!0,o.promptId||(o.promptId=ec()),r(o.promptId)}),s&&Vv(t)},lY={maxValidationRetries:_k,allowPlanFallbackPrompt:!0,allowAutoContinuation:!1},uY=new Set(["chart_request","data_filter","data_transform"]),cY=new Set(["plan_creation","execute_js_code","filter_spreadsheet","proceed_to_analysis"]),dY=t=>t&&Sk.has(t.intent)?{maxValidationRetries:0,allowPlanFallbackPrompt:!1,allowAutoContinuation:!1}:t&&uY.has(t.intent)?{maxValidationRetries:_k,allowPlanFallbackPrompt:!0,allowAutoContinuation:!0}:lY,eR=t=>{if(!t)return null;const e=t.trim().toLowerCase();return e?QJ.includes(e)?e:eY[e]??null:null},fY=t=>{if(!Array.isArray(t)||t.length===0)return[];const e=t.filter(Boolean),n=e.find(a=>a.responseType==="plan_state_update"),r=e.find(a=>a.responseType!=="plan_state_update"),s=[];return n&&s.push(n),r&&s.push(r),s.length===0&&s.push(e[0]),s},pY=(t,e,n)=>{if(!t.length)return;const r=t.findIndex(s=>s.responseType==="plan_state_update");if(r===-1){const s=e.get().plannerSession.planState,a=nc(e,s??void 0),o=Ok(a,"Auto-inserted plan tracker for this turn.");t.unshift(o),e.get().updatePlannerPlanState(a),n("Inserted missing plan_state_update as first action.");return}if(r>0){const[s]=t.splice(r,1);t.unshift(s),n("Moved plan_state_update to the first position.")}},hY=(t,e)=>{var p,m;if(!Array.isArray(t.actions)){t.actions=[];return}const n=e.get().agentAwaitingUserInput,r=()=>Ek(),s=[],a=new Set,o=y=>a.add(y);for(const y of t.actions){if(!y)continue;const w=y.type,x=y.responseType,A=eR(y.type)??eR(y.responseType)??(y.domAction?"dom_action":y.plan?"plan_creation":y.text?"text_response":null);if(!A)continue;const E={...y,type:A,responseType:A};(w&&w!==A||x&&x!==A)&&o(`Normalized action type to ${A}`);const C=$p(E.stateTag);if(C?E.stateTag=C:(E.stateTag=r(),o(`Minted stateTag for ${A}`)),typeof E.stepId!="string"||E.stepId.trim().length<3?(E.stepId=d0(e),o(`Attached default stepId (${E.stepId}) for ${A}`)):E.stepId=E.stepId.trim(),typeof E.timestamp=="string"&&!Number.isNaN(Date.parse(E.timestamp))||(E.timestamp=new Date().toISOString(),o(`Stamped timestamp for ${A}`)),sl(E),E.responseType==="plan_state_update"&&!$a(E)){const O=e.get().plannerSession.planState,T=nc(e,E.planState??O??void 0);E.planState=T,e.get().updatePlannerPlanState(T),o("Auto-filled plan_state_update payload.")}s.push(E)}if(s.length===0){t.actions=[];return}n?o("Skipped plan_state_update primer because planner is waiting for user input."):pY(s,e,o);const u=fY(s);u.length<s.length&&e.get().addProgress("Trimmed extra actions to keep this turn atomic.","system");const d=iY(u);oY(u,e);const c=(p=e.detectedIntent)!=null&&p.intent?Sk.has(e.detectedIntent.intent):!1;if(c&&!u.some(y=>y.responseType==="text_response")&&(u.push({type:"text_response",responseType:"text_response",stepId:((m=u[0])==null?void 0:m.stepId)??d0(e),reason:"Auto-generated greeting reply so the assistant can acknowledge the user.",text:" hi",timestamp:new Date().toISOString(),meta:{awaitUser:!1,haltAfter:!1,resumePlanner:!1,promptId:""}}),o("Inserted greeting text_response for low-intent turn")),c){const y=u.find(w=>w.responseType==="text_response");if(y){const w=sl(y);d||(w.awaitUser=!0,w.haltAfter=!0,w.promptId=w.promptId??ec(),Vv(u))}}a.size>0&&e.get().addProgress(`Auto-heal corrections applied: ${Array.from(a).join(" | ")}`,"system"),t.actions=u},tR={awaitUser:!1,haltAfter:!1,resumePlanner:!1,promptId:null,blockedReason:null,stateTagOverride:null},mY=t=>!Array.isArray(t)||t.length===0?{...tR}:t.reduce((e,n)=>{if(!n)return e;const r=sl(n),s=!!r.awaitUser;return{awaitUser:e.awaitUser||s,haltAfter:e.haltAfter||!!r.haltAfter,resumePlanner:e.resumePlanner||!!r.resumePlanner,promptId:r.promptId||e.promptId,stateTagOverride:s?e.stateTagOverride??"awaiting_clarification":e.stateTagOverride}},{...tR}),Jv=(t,e)=>{t.set(()=>({agentAwaitingUserInput:!0,agentAwaitingPromptId:e??null}));const n=t.get();n.addProgress(" Waiting for your choice to continue.");const r={sender:"ai",text:" ",timestamp:new Date,type:"ai_message"};t.set(s=>({chatHistory:[...s.chatHistory,r]})),typeof n.setAgentPhase=="function"&&n.setAgentPhase("idle","Waiting for your choice...")},gY=t=>{t.set(()=>({agentAwaitingUserInput:!1,agentAwaitingPromptId:null}))},Tk=t=>{var n;if(t.get().agentAwaitingUserInput)return!0;const e=(n=t.detectedIntent)==null?void 0:n.intent;return e?tY.has(e):!1},Yv=(t,e)=>{var d;Jv(t,e.promptId);const n=t.get(),r=n.plannerSession.planState;if(!r)return;const s=Array.isArray(r.steps)&&r.steps.length>0?r.steps:r.nextSteps,a=s==null?void 0:s.map(c=>c.id===r.currentStepId?{...c,status:"waiting_user"}:c),o=((d=e.blockedReason)==null?void 0:d.trim())||r.blockedBy||"Waiting for your choice",u=e.stateTagOverride??"awaiting_clarification";n.updatePlannerPlanState({...r,steps:a??r.steps,nextSteps:[],blockedBy:o,stateTag:u})},yY=(t,e)=>{if(e.actions.some(u=>u.responseType==="text_response"||u.responseType==="await_user"))return!0;const r=e.actions.find(u=>u.responseType==="plan_state_update"),s=r&&$a(r)?r.planState:t.get().plannerSession.planState;if(!s)return!1;const a=[];if(s.progress&&a.push(`Progress: ${s.progress}`),s.nextSteps&&s.nextSteps.length>0&&a.push(`Next: ${s.nextSteps[0].label}`),s.blockedBy&&a.push(`Blocked by: ${s.blockedBy}`),a.length===0)return!1;const o={sender:"ai",text:`Status update:
${a.join(`
`)}`,timestamp:new Date,type:"ai_message"};return t.set(u=>({chatHistory:[...u.chatHistory,o]})),!0},_Y=(t,e)=>{var n,r,s;if(!t)return[];switch(t.intent){case"remove_card":{const a=(n=t.payloadHints)==null?void 0:n.cardTitle,o=(s=(r=t.requiredTool)==null?void 0:r.payloadHints)==null?void 0:s.cardId;return o&&a?[`USER INTENT: Remove the chart titled "${a}" (cardId: ${o}). ACTION REQUIREMENT: Emit a dom_action removeCard with cardId=${o} (or cardTitle matching that text). Do not use other dom_action tools for this request.`]:[`USER INTENT: Remove a chart but no exact title match was found. Ask the user which chart to remove before proceeding. Available charts: ${(e.analysisCards??[]).map(d=>{var c;return(c=d==null?void 0:d.plan)==null?void 0:c.title}).filter(Boolean).join(", ")}.`]}case"data_filter":return["USER INTENT: Filter the raw data view. ACTION REQUIREMENT: Use filter_spreadsheet immediately with args.query echoing their request before creating new charts."];case"data_transform":return["USER INTENT: Permanently transform the dataset. ACTION REQUIREMENT: Use execute_js_code with valid transformation code before continuing."];case"clarification":return["USER INTENT: Needs clarification. ACTION REQUIREMENT: Ask a clarification_request that lists concrete options or explicitly states the missing detail."];case"smalltalk":return["USER INTENT: Casual smalltalk. Keep the reply lightweight and do not run tools until the user asks for a concrete analysis."];case"ask_user_choice":return["USER INTENT: Responding to a multiple-choice prompt. Acknowledge the selection, restate what it maps to, and resume the pending step without rebuilding the entire plan."];default:return[]}};let nR=0,rR=0;const ir=(t,e,n)=>{const r=t.get();typeof r.setAgentPhase=="function"&&r.setAgentPhase(e,n??null)},vY=t=>{const e=t.get();typeof e.setAgentPhase=="function"&&e.setAgentPhase("idle",null)},wY=t=>{var e;return(e=t.get().pendingClarifications)==null?void 0:e.some(n=>n.status==="pending"||n.status==="resolving")},sR=()=>typeof performance<"u"?performance.now():Date.now(),aR=t=>new Promise(e=>setTimeout(e,t)),bY=async()=>{for(;c0;)await aR(ZJ);c0=!0;const t=Date.now()-bk;t<XI&&await aR(XI-t)},SY=()=>{c0=!1,bk=Date.now()},ke={MISSING_TEXT:"MISSING_TEXT",MISSING_PLAN_PAYLOAD:"MISSING_PLAN_PAYLOAD",DOM_PAYLOAD_MISSING:"DOM_PAYLOAD_MISSING",DATASET_UNAVAILABLE:"DATASET_UNAVAILABLE",MISSING_JS_CODE:"MISSING_JS_CODE",TRANSFORM_PENDING:"TRANSFORM_PENDING",TRANSFORM_FAILED:"TRANSFORM_FAILED",FILTER_QUERY_MISSING:"FILTER_QUERY_MISSING",CLARIFICATION_PAYLOAD_MISSING:"CLARIFICATION_PAYLOAD_MISSING",CLARIFICATION_NO_OPTIONS:"CLARIFICATION_NO_OPTIONS",REASON_MISSING:"REASON_MISSING",UNSUPPORTED_ACTION:"UNSUPPORTED_ACTION",PLAN_STATE_PAYLOAD_MISSING:"PLAN_STATE_PAYLOAD_MISSING",VALIDATION_FAILED:"VALIDATION_FAILED",PLAN_STEP_OUT_OF_ORDER:"PLAN_STEP_OUT_OF_ORDER",INTENT_CONTRACT_FAILED:"INTENT_CONTRACT_FAILED"},Ak=()=>`obs-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,ec=()=>`prompt-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,xY=new cv,Ek=()=>xY.mint(),TY=new Set(["dom_action","execute_js_code","filter_spreadsheet","proceed_to_analysis"]),AY=t=>{switch(t.chartType){case"line":return"trend";case"bar":case"pie":case"doughnut":case"combo":return"topn";default:return"kpi"}},EY=t=>{if(!t)return null;try{return P_(t)}catch(e){return console.warn("[AgentWorker] Failed to normalize intent contract.",e),null}},CY=async({contract:t,runtime:e,markTrace:n})=>{var o,u;const r=e.get();let s=null;const a=()=>s??(s=DJ({getDatasetId:()=>e.get().datasetHash??null,getCsvData:()=>e.get().csvData,getCurrentPlan:()=>e.get().langChainLastPlan}));switch(t.tool){case"csv.profile":try{const d=await a().profileDatasetTool.invoke({sampleSize:t.args.limit});return r.addProgress(d.summary),n("succeeded","Profiled dataset via LangChain tool."),{type:"continue",observation:{status:"success",outputs:{intent:t.intent,tool:t.tool,payload:d.payload,meta:d.meta}}}}catch(d){const c=d instanceof Error?d.message:String(d);return r.addProgress(`${c}`,"error"),n("failed",c,{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED,outputs:{message:c}}}}case"csv.clean_invoice_month":{const d=t.args.column??"InvoiceMonth";try{const c=await a().normalizeInvoiceMonthTool.invoke({column:d});return r.addProgress(c.summary),n("succeeded",`Normalized ${d} via LangChain tool.`),{type:"continue",observation:{status:"success",outputs:{intent:t.intent,tool:t.tool,payload:c.payload,meta:c.meta}}}}catch(c){const p=c instanceof Error?c.message:String(c);return r.addProgress(` ${d} ${p}`,"error"),n("failed",p,{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED,outputs:{message:p}}}}}case"csv.detect_outliers":{const d=t.args.valueColumn??t.args.column??null;if(!d)return r.addProgress(" valueColumn","error"),n("failed","Detect outliers intent missing valueColumn.",{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED}};const c=t.args.thresholdMultiplier??2;try{const p=await a().detectOutliersTool.invoke({valueColumn:d,thresholdMultiplier:c});return r.addProgress(p.summary),n("succeeded",`Detected outliers for ${d}.`),{type:"continue",observation:{status:"success",outputs:{intent:t.intent,tool:t.tool,payload:p.payload,meta:p.meta}}}}catch(p){const m=p instanceof Error?p.message:String(p);return r.addProgress(`${m}`,"error"),n("failed",m,{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED,outputs:{message:m}}}}}case"csv.aggregate":{const d=r.csvData;if(!d)return r.addProgress("","error"),n("failed","Dataset unavailable for aggregate intent.",{errorCode:ke.DATASET_UNAVAILABLE}),{type:"continue",observation:{status:"error",errorCode:ke.DATASET_UNAVAILABLE}};const c=vz(t);if(!c)return r.addProgress("","error"),n("failed","Aggregate intent missing required columns.",{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED}};const p=await e.deps.runPlanWithChatLifecycle(c,d,e.runId);return!p||p.length===0?(r.addProgress(` "${c.title}" `,"error"),n("failed","Aggregate intent returned no cards.",{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED}}):(r.addProgress(` "${c.title}" `),n("succeeded",`Executed aggregate intent for "${c.title}".`),e.intentRequirementSatisfied=!0,{type:"continue",observation:{status:"success",outputs:{intent:t.intent,tool:t.tool,planTitle:c.title}}})}case"ui.remove_card":{const d=t.args.cardId??null;if(!d)return r.addProgress("contract  cardId","error"),n("failed","Remove card intent missing cardId.",{errorCode:ke.DOM_PAYLOAD_MISSING}),{type:"continue",observation:{status:"error",errorCode:ke.DOM_PAYLOAD_MISSING}};const c={toolName:"removeCard",target:{byId:d},args:{cardId:d}};return r.executeDomAction(c),r.addProgress(` ${d}`),n("succeeded",`Removed card ${d} via intentContract.`),{type:"continue",observation:{status:"success",outputs:{intent:t.intent,tool:t.tool,cardId:d},uiDelta:"removeCard"}}}case"idb.save_view":{const d=r.datasetHash,c=t.args.cardId??null;if(!d)return r.addProgress("","error"),n("failed","Save view intent missing dataset.",{errorCode:ke.DATASET_UNAVAILABLE}),{type:"continue",observation:{status:"error",errorCode:ke.DATASET_UNAVAILABLE}};if(!c)return r.addProgress("contract  cardId","error"),n("failed","Save view intent missing cardId.",{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED}};const p=(o=r.analysisCards)==null?void 0:o.find(A=>A.id===c);if(!p)return r.addProgress(` ${c}`,"error"),n("failed","Save view intent card not found.",{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED}};if(!p.aggregatedData||p.aggregatedData.length===0)return r.addProgress(` "${p.plan.title}"`,"error"),n("failed","Save view intent missing card data.",{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED}};if(p.dataRefId)return r.addProgress(` "${p.plan.title}" `),n("succeeded",`View "${p.plan.title}" already saved (id=${p.dataRefId}).`),{type:"continue",observation:{status:"success",outputs:{intent:t.intent,tool:t.tool,viewId:p.dataRefId}}};const y={schema:p.valueSchema??wz(p.aggregatedData),rows:p.aggregatedData,sampled:p.isSampledResult??((u=p.aggregationMeta)==null?void 0:u.sampled)??!1,source:"aggregate",planSnapshot:p.plan},w=t.args.viewTitle??p.plan.title??"Saved view",x=p.queryHash??`manual-${Date.now().toString(36)}`;try{const A=await AP({datasetId:d,title:w,kind:AY(p.plan),queryHash:x,explainer:p.summary,dataRef:y});return e.set(E=>({analysisCards:E.analysisCards.map(C=>C.id===c?{...C,dataRefId:A,queryHash:x}:C)})),r.addProgress(` "${w}" `),n("succeeded",`Saved view "${w}" (id=${A}).`),{type:"continue",observation:{status:"success",outputs:{intent:t.intent,tool:t.tool,viewId:A}}}}catch(A){const E=A instanceof Error?A.message:String(A);return r.addProgress(`${E}`,"error"),n("failed",E,{errorCode:ke.INTENT_CONTRACT_FAILED}),{type:"continue",observation:{status:"error",errorCode:ke.INTENT_CONTRACT_FAILED,outputs:{message:E}}}}}default:return null}},IY=t=>{const e=JSON.stringify(t);let n=0;for(let r=0;r<e.length;r++)n=(n<<5)-n+e.charCodeAt(r),n|=0;return Math.abs(n).toString(36)},RY=t=>{if(t==null)return"";const e=String(t),n=/[",\n]/.test(e),r=e.replace(/"/g,'""');return n?`"${r}"`:r},Ck=t=>{const{csvData:e,spreadsheetFilterFunction:n,aiFilterExplanation:r,interactiveSelectionFilter:s}=t,a=(e==null?void 0:e.data)??[];if(a.length===0)return{summary:"No dataset loaded; Raw Data Explorer summary unavailable.",metadata:{totalRows:0,filteredRows:0,snippetHash:null,drilldownLabel:null,drilldownValueCount:0}};let o=a;const u=[];let d=null,c=null,p=0;if(s&&s.column){const{label:A,column:E,values:C}=s,D=new Set(C.map(I=>String(I)));o=o.filter(I=>D.has(String(I[E]??"")));const O=C.slice(0,4).map(I=>`"${String(I)}"`).join(", "),T=C.length>4?` +${C.length-4}`:"";u.push(`Chart drilldown "${A}" (${E})  ${O}${T}.`),c=A,p=C.length}if(n)try{o=BR(o,n),r!=null&&r.trim()?u.push(`AI filter active: ${r.trim()}`):u.push("AI filter active via natural-language query (no explanation available).")}catch(A){const E=A instanceof Error?A.message:String(A);u.push(`AI filter active but preview failed: ${E}`)}const m=o.length,y=a.length,x=(()=>{if(o.length===0)return"No rows available.";if(o.length>1e3){const C=Object.keys(o[0]),D=C.join(","),O=5,T=o.slice(0,O).map(N=>C.map(P=>RY(N[P])).join(",")),I=Math.ceil(o.length/O),M=IY(o.slice(0,O));return d=M,`CSV snippet page 1/${I} (hash ${M}):
${[D,...T].join(`
`)}`}const A=o.slice(0,3),E=A.length>0?JSON.stringify(A,null,2):"[]";return E.length>600?`${E.slice(0,600)}`:E})();return u.push(`Filtered rows: ${m}/${y}. Preview sample: ${x}`),{summary:u.join(" "),metadata:{totalRows:y,filteredRows:m,snippetHash:d,drilldownLabel:c,drilldownValueCount:p}}},NY=t=>t.observation?t.observation:t.type==="retry"?{status:"error",outputs:{reason:t.reason}}:{status:"success"},PY=6,MY=t=>{if(!t)return null;const e=t.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(Boolean).slice(0,PY).join(" ").trim();return e.length>=3?e:null},tc=t=>{if(!Array.isArray(t))return[];const e=[],n=new Set;for(const r of t){const s=typeof(r==null?void 0:r.id)=="string"?r.id.trim():"",a=typeof(r==null?void 0:r.label)=="string"?r.label.trim():"";if(s.length>=3&&a.length>=3&&!n.has(s)){const o=typeof(r==null?void 0:r.intent)=="string"&&r.intent.trim()||void 0,u=typeof(r==null?void 0:r.status)=="string"?r.status:void 0;e.push({id:s,label:a,intent:o,status:u}),n.add(s)}}return e},kY=(t,e,n)=>{var d,c;if(t.responseType==="plan_state_update")return!1;const r=e.get(),s=r.plannerPendingSteps??[],a=s.find(p=>typeof(p==null?void 0:p.id)=="string"&&p.id.trim().length>=3);if(t.responseType==="text_response"&&((d=e.detectedIntent)==null?void 0:d.intent)==="greeting"&&s.length===1&&(a==null?void 0:a.id)===VJ.id)return t.stepId=a.id,r.addProgress(`Auto-tagged greeting reply to step "${a.id}" so it can proceed.`,"system"),typeof r.recordAgentValidationEvent=="function"&&r.recordAgentValidationEvent({actionType:"text_response",reason:"auto_step_id_greeting_ack",actionIndex:n,runId:e.runId,retryInstruction:"stepId was auto-filled with the greeting acknowledgement step so you can keep chatting."}),!0;const o=typeof((c=r.plannerSession.planState)==null?void 0:c.currentStepId)=="string"?r.plannerSession.planState.currentStepId.trim():"",u=o&&o.length>=3&&o||((a==null?void 0:a.id)??yc);return t.stepId=u,r.addProgress(`Auto-assigned stepId "${u}" to ${t.responseType} so it can continue.`,"system"),typeof r.recordAgentValidationEvent=="function"&&r.recordAgentValidationEvent({actionType:t.responseType,reason:"auto_step_id_assigned",actionIndex:n,runId:e.runId,retryInstruction:`stepId was auto-filled with "${u}" because it was missing.`}),!0},d0=t=>{var n,r;const e=t.get().plannerPendingSteps;if(Array.isArray(e)&&e.length>0){const s=(r=(n=e[0])==null?void 0:n.id)==null?void 0:r.trim();if(s&&s.length>=3)return s}return yc},OY=(t,e)=>e?t?t.toLowerCase().includes(e):!1:!0,DY=(t,e,n)=>({id:Ak(),actionId:e,responseType:t.responseType,status:n.status,timestamp:new Date().toISOString(),outputs:n.outputs??null,errorCode:n.errorCode??null,uiDelta:n.uiDelta??null}),LY=t=>{var e,n,r,s;switch(t.responseType){case"text_response":case"await_user":return t.text?t.text.slice(0,120):"AI text response";case"plan_creation":return(e=t.plan)!=null&&e.title?`Create analysis "${t.plan.title}"`:"Create new analysis card";case"dom_action":return t.domAction?`DOM action: ${t.domAction.toolName}`:"DOM action";case"execute_js_code":return((n=t.code)==null?void 0:n.explanation)||"Execute data transformation";case"filter_spreadsheet":return(r=t.args)!=null&&r.query?`Filter spreadsheet by "${t.args.query}"`:"Filter spreadsheet";case"clarification_request":return((s=t.clarification)==null?void 0:s.question)||"Ask user for clarification";case"proceed_to_analysis":return"Proceed to analysis pipeline";default:return"Agent action"}},Ik=t=>typeof t.text=="string"&&t.text.trim().length>0,Rk=t=>!!t.plan,Nk=t=>!!t.domAction,Pk=t=>!!t.code&&typeof t.code.jsFunctionBody=="string"&&t.code.jsFunctionBody.trim().length>0,$Y=t=>typeof t.args=="object",Mk=t=>!!t.clarification,$a=t=>{const e=t.planState;if(!e)return!1;const n=typeof e.goal=="string"&&e.goal.trim().length>0,r=typeof e.progress=="string"&&e.progress.trim().length>0,s=Array.isArray(e.nextSteps)&&e.nextSteps.length>0,a=typeof e.planId=="string"&&e.planId.trim().length>0,o=typeof e.currentStepId=="string"&&e.currentStepId.trim().length>=3,d=tc(e.steps??e.nextSteps).length>0;return n&&r&&s&&a&&o&&d},UY=t=>t?zu.map(e=>t==null?void 0:t[e]).filter(e=>typeof e=="string"&&e.trim().length>0):[],FY=t=>{const e=t.get().plannerSession.planState;return{hasPendingSteps:!!(e&&Array.isArray(e.nextSteps)&&e.nextSteps.some(r=>typeof(r==null?void 0:r.id)=="string"&&r.id.trim().length>0&&typeof(r==null?void 0:r.label)=="string")),stateTag:e==null?void 0:e.stateTag,hasBlocker:!!(e!=null&&e.blockedBy&&e.blockedBy.trim().length>0)}},BY=t=>!t||!Array.isArray(t.nextSteps)||t.nextSteps.length===0?"No pending steps were captured previously.":t.nextSteps.map(e=>`- [${e.id}] ${e.label}`).join(`
`),qY=t=>{const e=t.get().plannerSession.planState,n=e?`LAST_KNOWN_PLAN:
Goal: ${e.goal}
Progress: ${e.progress}
Next Steps:
${BY(e)}`:"No previous plan was captured; establish a brand new plan.";return`
${t.userMessage}

SYSTEM NOTE: The UI failed to parse your plan. Respond with ONLY a plan_state_update (plus an optional short text_response) that restates or refines the current goal tracker. Do not execute tools yet.

${yk}

${n}
    `.trim()},iR=(t,e)=>{if(!e||e.length===0)return t;const n=e.map(r=>`- ${r}`).join(`
`);return`${t}

SYSTEM INTENT NOTES:
${n}`},Kv=(t,e)=>{var p,m,y,w,x;if(!e||e.toolName!=="removeCard")return;const n=t.get(),r=e.args??(e.args={});if(typeof r.cardId=="string"&&r.cardId.trim().length>0)return;const s=n.analysisCards??[];if(!Array.isArray(s)||s.length===0)return;const a=((m=(p=t.detectedIntent)==null?void 0:p.requiredTool)==null?void 0:m.payloadHints)??{},o=[r.cardId,a.cardId].filter(A=>typeof A=="string"&&A.trim().length>0);for(const A of o){const E=s.find(C=>(C==null?void 0:C.id)===A);if(E){r.cardId=E.id,!r.cardTitle&&((y=E.plan)!=null&&y.title)&&(r.cardTitle=E.plan.title),n.addProgress(`Auto-selected cardId ${E.id} for removeCard using intent hints.`,"system");return}}const u=A=>(A??"").toLowerCase().replace(/\s+/g," ").trim(),d=[typeof r.cardTitle=="string"?r.cardTitle:"",typeof a.cardTitle=="string"?a.cardTitle:""].map(u).filter(A=>A.length>=3);if(d.length===0)return;const c=s.filter(A=>{var C;const E=u((C=A==null?void 0:A.plan)==null?void 0:C.title);return E?d.some(D=>E.includes(D)||D.includes(E)):!1});if(c.length===1){const A=c[0];r.cardId=A.id,r.cardTitle=((w=A.plan)==null?void 0:w.title)??r.cardTitle,n.addProgress(`Auto-selected cardId ${A.id} for removeCard using title "${((x=A.plan)==null?void 0:x.title)??""}".`,"system");return}c.length>1&&n.addProgress(`Multiple charts matched "${d[0]}". Please clarify which card to remove.`,"error")},GY=["numerical","currency","percentage"],HY=(t,e)=>{var A;const n=(e.aggregation??"").toLowerCase();if(!(n&&n!=="count"))return null;const s=(A=e.valueColumn)==null?void 0:A.trim(),a=t.get(),o=a.columnProfiles??[],u=o.filter(E=>GY.includes(E.type));if(!!s&&u.some(E=>E.name===s))return null;if(!s&&u.length===0)return a.addProgress("Need a numeric column for this aggregation, but none are available.","error"),null;const c=e.title&&e.title.trim().length>0?`Which metric column should I use for "${e.title}"?`:"Which metric column should I use for this chart?",m=(u.length>0?u:o).slice(0,8).map(E=>({label:`${E.name} (${E.type})`,value:E.name}));if(m.length===0)return a.addProgress("No suitable metric column options were found. Please upload data with numeric metrics.","error"),null;const y={question:c,options:m,pendingPlan:{...e},targetProperty:"valueColumn",contextType:"plan"},w=t.deps.registerClarification(y),x={sender:"ai",text:w.question,timestamp:new Date,type:"ai_clarification",clarificationRequest:w};return t.set(E=>({chatHistory:[...E.chatHistory,x]})),t.set({activeClarificationId:w.id}),Jv(t,w.id),a.addProgress("Need your help picking the metric column before I can build that chart."),w.id},zY=(t,e)=>{const n=t.get(),r=n.analysisCards??[];if(!Array.isArray(r)||r.length===0){const d="There are no charts available yet. Create one before using this action.";n.addProgress(d,"error");const c={sender:"ai",text:d,timestamp:new Date,type:"ai_message",isError:!0};return t.set(p=>({chatHistory:[...p.chatHistory,c]})),null}const a={question:e.toolName==="removeCard"?"Which chart should I remove?":"Which chart should I update?",options:r.slice(0,9).map((d,c)=>{var p,m;return{label:((m=(p=d==null?void 0:d.plan)==null?void 0:p.title)==null?void 0:m.trim())||`Chart ${c+1}`,value:d.id}}),pendingPlan:{domActionContext:{toolName:e.toolName,args:{...e.args??{}}}},targetProperty:"title",contextType:"dom_action"},o=t.deps.registerClarification(a),u={sender:"ai",text:o.question,timestamp:new Date,type:"ai_clarification",clarificationRequest:o};return t.set(d=>({chatHistory:[...d.chatHistory,u]})),t.set({activeClarificationId:o.id}),ir(t,"clarifying","Need your input to keep going..."),t.get().endBusy(t.runId),Jv(t,o.id),o.id},jY=t=>{const e=t.trim();return e.length<3||wk.test(e)?!1:/[\p{L}\p{N}]/u.test(e)},Wv=(t,e,n)=>{var o,u;const r=typeof e=="string"?e.trim():"";if(r)return{query:r,source:"payload"};const s=typeof((o=n==null?void 0:n.payloadHints)==null?void 0:o.query)=="string"?n.payloadHints.query.trim():"";if(s)return{query:s,source:"intent_hint"};const a=((u=t.userMessage)==null?void 0:u.trim())??"";return jY(a)?{query:a,source:"user_message"}:{query:vk,source:"default"}},oR=(t,e,n)=>{var d,c,p,m,y;if(Tk(e)||t.responseType!=="filter_spreadsheet")return!1;const r=((d=e.detectedIntent)==null?void 0:d.intent)==="data_filter"?e.detectedIntent.requiredTool:void 0;if(!r&&((c=t.args)!=null&&c.query))return!1;const s=typeof((p=t.args)==null?void 0:p.query)=="string"?t.args.query:"",{query:a,source:o}=Wv(e,s,r);if((s==null?void 0:s.trim())===a)return!1;t.args={...t.args??{},query:a};const u=o==="default"?'Auto-filled filter query with "show entire table" to keep the conversation moving.':"Auto-filled filter query using your latest request so the filter tool can run.";return e.get().addProgress(u,"system"),(y=(m=e.get()).recordAgentValidationEvent)==null||y.call(m,{actionType:"filter_spreadsheet",reason:"auto_filter_query_filled",actionIndex:n,runId:e.runId,retryInstruction:"Filter query was auto-filled using the user intent/context."}),!0},VY=(t,e,n)=>{var d,c,p,m,y;if(Tk(e)||t.responseType!=="dom_action"||!t.domAction)return!1;const r=(d=e.detectedIntent)==null?void 0:d.requiredTool;if(!r||r.responseType!=="dom_action"||r.domToolName&&t.domAction.toolName!==r.domToolName)return!1;const s=t.domAction.args??(t.domAction.args={});let a=!1;const o=typeof((c=r.payloadHints)==null?void 0:c.cardId)=="string"?r.payloadHints.cardId.trim():"",u=typeof((p=r.payloadHints)==null?void 0:p.cardTitle)=="string"?r.payloadHints.cardTitle.trim():"";return!s.cardId&&o&&(s.cardId=o,a=!0),!s.cardTitle&&u&&(s.cardTitle=u,a=!0),a&&(e.get().addProgress("Auto-filled DOM action payload using intent hints.","system"),(y=(m=e.get()).recordAgentValidationEvent)==null||y.call(m,{actionType:"dom_action",reason:"auto_dom_payload_filled",actionIndex:n,runId:e.runId,retryInstruction:"DOM payload fields were auto-filled using the user intent hints."})),a},JY=(t,e)=>{var r,s,a,o,u,d,c;const n=d0(t);switch(e.responseType){case"dom_action":{if(!e.domToolName)return null;const p={};(r=e.payloadHints)!=null&&r.cardId&&(p.cardId=e.payloadHints.cardId),(s=e.payloadHints)!=null&&s.cardTitle&&(p.cardTitle=e.payloadHints.cardTitle);const m={toolName:e.domToolName,args:p};return Kv(t,m),(a=m.args)!=null&&a.cardId?{type:"dom_action",responseType:"dom_action",reason:"Auto-inserted DOM action to satisfy the user intent.",stepId:n,stateTag:Sf(),domAction:m}:null}case"filter_spreadsheet":{const{query:p}=Wv(t,((o=e.payloadHints)==null?void 0:o.query)??null,e);return{type:"filter_spreadsheet",responseType:"filter_spreadsheet",reason:"Auto-inserted filter to satisfy the user intent.",stepId:n,stateTag:Sf(),args:{query:p}}}case"execute_js_code":{const p=t.get(),m=((u=t.userMessage)==null?void 0:u.toLowerCase())??"",y=p.columnProfiles??[],w=((d=e.payloadHints)==null?void 0:d.column)??((c=y.find(E=>m.includes(E.name.toLowerCase())))==null?void 0:c.name)??null;if(!w)return null;const A=`
const result = data.map(row => {
    const next = { ...row };
    delete next["${w.replace(/"/g,'\\"')}"];
    return next;
});
return result;
            `.trim();return{type:"execute_js_code",responseType:"execute_js_code",reason:`Auto-inserted data transform to remove the column "${w}".`,stepId:n,stateTag:Sf(),code:{explanation:`Removes the column "${w}" from every row of the dataset.`,jsFunctionBody:A}}}default:return null}},YY=async(t,e,n,r)=>{const s=e().analysisCards.map(m=>({id:m.id,title:m.plan.title,aggregatedDataSample:m.aggregatedData.slice(0,100)}));let o=(()=>{const{chatMemoryPreview:m,chatMemoryExclusions:y}=e();return m.filter(w=>!y.includes(w.id))})();if(o.length===0&&wt.getDocumentCount()>0)try{o=await wt.search(t,3,{signal:n.getRunSignal(r)})}catch(m){m instanceof DOMException&&m.name==="AbortError"||console.error("Fallback memory search failed:",m)}const u=o,d=u.map(m=>m.text),c=()=>Ck(e()).summary;return{memorySnapshot:u,requestAiResponse:(m,y)=>yG(e().columnProfiles,e().chatHistory,m,s,e().settings,e().aiCoreAnalysisSummary,e().currentView,d,e().plannerSession.observations,e().plannerSession.planState,e().dataPreparationPlan,e().agentActionTraces.slice(-10),c(),{signal:(y==null?void 0:y.signal)??n.getRunSignal(r),mode:y==null?void 0:y.mode,phase:y==null?void 0:y.phase,onPromptProfile:w=>{var A;const x=e().recordPromptMetric;if(typeof x=="function"){const E={id:`prompt-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,mode:w.mode,charCount:w.charCount,estimatedTokens:w.estimatedTokens,promptLabel:w.promptLabel,createdAt:new Date().toISOString(),runId:r};x(E)}(A=y==null?void 0:y.onPromptProfile)==null||A.call(y,w)},onUsage:w=>{var A;const x=e().recordLlmUsage;x&&x({provider:w.provider,model:w.model,promptTokens:w.promptTokens,completionTokens:w.completionTokens,totalTokens:w.totalTokens,context:w.operation??"chat.response"}),(A=y==null?void 0:y.onUsage)==null||A.call(y,w)}})}},KY=t=>{var n;const e=t.get();return{planState:e.plannerSession.planState,pendingSteps:e.plannerPendingSteps??[],detectedIntent:t.detectedIntent,userMessage:t.userMessage,runId:t.runId,now:Date.now(),lastStateTag:((n=e.plannerSession.planState)==null?void 0:n.stateTag)??null,promptMode:xi(t)}},WY=async(t,e)=>{var r;return((r=t.action.reason)==null?void 0:r.trim())?e():(t.runtime.get().addProgress("AI response missing reasoning; action skipped.","error"),NK(t.runtime),t.markTrace("failed","Action blocked because no reasoning was provided.",{errorCode:ke.REASON_MISSING}),{type:"continue",observation:{status:"error",errorCode:ke.REASON_MISSING,outputs:{note:"Action skipped because reason field was empty."}}})},ZY=(t,e)=>!e||t.responseType!=="plan_creation"||!t.plan?!1:[t.plan.title,t.plan.description,t.plan.groupByColumn,t.plan.valueColumn,t.plan.secondaryValueColumn].filter(Boolean).map(r=>String(r).toLowerCase()).some(r=>r.includes(e)),kk=(t,e)=>{var n;return t.responseType!==e.responseType?!1:e.responseType==="dom_action"&&e.domToolName?((n=t.domAction)==null?void 0:n.toolName)===e.domToolName:!0},vi=Object.create(null),XY=3,QY=t=>{if(!t)return"latest user request";const e=t.trim();return e?e.length>120?`${e.slice(0,117)}`:e:"latest user request"},nc=(t,e)=>{var d,c,p,m,y,w,x,A,E,C,D,O;const n=t.get(),r=new Date().toISOString(),s=tc((e==null?void 0:e.steps)??(e==null?void 0:e.nextSteps)),a=s[0]??{id:e!=null&&e.currentStepId&&e.currentStepId.trim().length>=3?e.currentStepId.trim():yc,label:(d=e==null?void 0:e.goal)!=null&&d.trim()?`Advance: ${e.goal.trim().slice(0,60)}`:"Handle the latest user request",intent:((p=(c=e==null?void 0:e.steps)==null?void 0:c[0])==null?void 0:p.intent)??"conversation",status:((y=(m=e==null?void 0:e.steps)==null?void 0:m[0])==null?void 0:y.status)??"ready"},o=s.length>0?s:[a],u=(e!=null&&e.steps?tc(e.steps):null)??o;return{planId:((w=e==null?void 0:e.planId)==null?void 0:w.trim())||((x=n.plannerSession.planState)==null?void 0:x.planId)||`plan-${Date.now().toString(36)}`,goal:((A=e==null?void 0:e.goal)==null?void 0:A.trim())||((E=n.plannerSession.planState)==null?void 0:E.goal)||`Clarify and fulfill: ${QY(t.userMessage)}`,contextSummary:(e==null?void 0:e.contextSummary)??((C=n.plannerSession.planState)==null?void 0:C.contextSummary)??"Awaiting concrete instructions.",progress:((D=e==null?void 0:e.progress)==null?void 0:D.trim())||"Initialized plan tracker.",nextSteps:o,steps:u,currentStepId:e!=null&&e.currentStepId&&e.currentStepId.trim().length>=3?e.currentStepId.trim():a.id,blockedBy:typeof(e==null?void 0:e.blockedBy)=="string"?e.blockedBy:(e==null?void 0:e.blockedBy)??null,observationIds:(e==null?void 0:e.observationIds)??[],confidence:typeof(e==null?void 0:e.confidence)=="number"?e.confidence:((O=n.plannerSession.planState)==null?void 0:O.confidence)??.5,updatedAt:(e==null?void 0:e.updatedAt)??r,stateTag:(e==null?void 0:e.stateTag)??"context_ready"}},Ok=(t,e)=>({type:"plan_state_update",responseType:"plan_state_update",reason:e??"Auto-initializing plan tracker before continuing.",stateTag:Sf(),stepId:t.currentStepId??yc,timestamp:new Date().toISOString(),text:"Plan tracker synchronized.",cardId:null,meta:{awaitUser:!1,haltAfter:!1,resumePlanner:!1,promptId:""},planState:t}),eK=new Set(["greeting","smalltalk","ask_user_choice"]),tK=t=>{var r,s,a;if(t.starterActionsShared||!eK.has(((r=t.detectedIntent)==null?void 0:r.intent)??"")||!!!(t.get().csvData&&((a=(s=t.get().csvData)==null?void 0:s.data)!=null&&a.length)))return;t.starterActionsShared=!0;const n={sender:"ai",text:"",timestamp:new Date,type:"ai_message",quickActions:JJ};t.set(o=>({chatHistory:[...o.chatHistory,n]}))},nK=async(t,e)=>{const n=t.runtime.runId;if(t.action.responseType==="plan_state_update"||t.action.responseType==="text_response"||t.runtime.policy.allowLooseSteps)return vi[n]=0,e();const a=(t.runtime.get().plannerPendingSteps||[])[0];if(!a)return vi[n]=0,e();const o=typeof t.action.stepId=="string"?t.action.stepId.trim():"",u=o.length>0&&o===a.id,d=MY(a.label),c=!!d&&(OY(t.action.reason,d)||ZY(t.action,d));if(!u&&!c){const m=(vi[n]??0)+1;if(vi[n]=m,m>=XY)return t.runtime.get().addProgress("Relaxing plan-step enforcement after repeated attempts. Proceed carefully and build the pending chart immediately."),vi[n]=0,typeof t.runtime.get().completePlannerPendingStep=="function"&&t.runtime.get().completePlannerPendingStep(),e();const y=`"${a.label}" [${a.id}]`;t.runtime.get().addProgress(`State consistency check failed. Next planned step is ${y}. Reference it explicitly and set stepId="${a.id}" before taking other actions.`,"error"),t.markTrace("failed","Plan step order violation.",{errorCode:ke.PLAN_STEP_OUT_OF_ORDER,metadata:{expectedStepId:a.id,expectedStepLabel:a.label}});const w=`SYSTEM NOTE: You attempted to skip the plan step ${y}. Reference it explicitly and set stepId="${a.id}" before taking other actions.`;return{type:"retry",reason:`Plan step enforcement triggered for ${y}.`,retryPrompt:w,userFacingMessage:`Plan step enforcement triggered for ${y}. I'll restate the pending step and try again.`,progressMessage:`Refocusing on pending step ${y}...`,phaseMessage:"Reordering plan execution after a failed attempt...",statusMessage:"Refocusing on the pending step...",promptMode:"full",observation:{status:"error",errorCode:ke.PLAN_STEP_OUT_OF_ORDER,outputs:{expectedStepId:a.id,expectedStepLabel:a.label}}}}const p=t.markTrace;t.markTrace=(m,y,w)=>{m==="succeeded"&&(vi[n]=0,a&&(u||c)&&(u||t.runtime.get().addProgress(`Step ${a.id} completed via fallback inference. Future actions must include stepId="${a.id}" to avoid guard warnings.`,"error"),typeof t.runtime.get().completePlannerPendingStep=="function"&&t.runtime.get().completePlannerPendingStep())),p(m,y,w)};try{return await e()}finally{t.markTrace=p}},rK=async(t,e)=>(t.action.reason&&t.runtime.get().addProgress(`AI Thought: ${t.action.reason}`),e()),sK=async(t,e)=>{const n=sR(),r=t.markTrace;t.markTrace=(s,a,o)=>{const d=s==="succeeded"||s==="failed"?{...o??{},durationMs:Math.max(0,sR()-n)}:o;r(s,a,d)};try{return await e()}finally{t.markTrace=r}},aK=[],iK=[WY,nK,rK,sK],oK=()=>[...iK,...aK],lK=(t,e)=>t.reduceRight((n,r)=>async s=>r(s,()=>n(s)),e),uK=async(t,e,n,r)=>{t.responseType==="dom_action"&&t.domAction&&Kv(e,t.domAction);const s=RK[t.responseType];if(!s)return r("failed","Unsupported action type.",{errorCode:ke.UNSUPPORTED_ACTION}),{type:"continue",observation:{status:"error",errorCode:ke.UNSUPPORTED_ACTION}};const a={action:t,runtime:e,remainingAutoRetries:n,markTrace:r};return lK(oK(),s)(a)},Jt=(t,e,n,r)=>({isValid:!1,userMessage:t?`AI ${t.responseType} action is invalid: ${n}. Asking it to correct the payload...`:n,retryInstruction:r,details:t?{actionType:t.responseType,actionIndex:e,reason:n}:void 0}),cK=t=>{var r;const e=t.clarification;return(r=e.question)!=null&&r.trim()?!Array.isArray(e.options)||e.options.length===0?"Clarification options are missing.":e.options.find(s=>!s||typeof s.label!="string"||typeof s.value!="string")?"Clarification option missing label or value.":e.targetProperty?null:"Clarification targetProperty is missing.":"Clarification question is empty."},dK=t=>{const e=t.args??{},n=typeof e.cardId=="string"?e.cardId.trim():"",r=typeof e.cardTitle=="string"?e.cardTitle.trim():"";if(t.toolName!=="removeCard"&&!n)return"DOM action missing cardId.";switch(t.toolName){case"changeCardChartType":if(!e.newType)return"changeCardChartType requires newType.";break;case"filterCard":if(!e.column||typeof e.column!="string")return"filterCard requires a column.";if(!Array.isArray(e.values)||e.values.length===0)return"filterCard requires at least one value.";if(e.values.some(a=>typeof a!="string"&&typeof a!="number"))return"filterCard values must be strings or numbers.";break;case"setTopN":if(e.topN===void 0||e.topN===null)return"setTopN requires the topN value.";if(e.topN!=="all"&&(!Number.isFinite(Number(e.topN))||Number(e.topN)<=0||!Number.isInteger(Number(e.topN))))return'setTopN must be a positive integer or "all".';break;case"toggleLegendLabel":if(!e.label||typeof e.label!="string")return"toggleLegendLabel requires a label.";break;case"exportCard":if(!e.format||typeof e.format!="string")return"exportCard requires a format.";break;case"removeCard":if(!n&&!r)return"removeCard requires a cardId (or cardTitle that uniquely identifies the card).";break}return null},fK=(t,e)=>{var u;const n=e.args??{},r=typeof n.cardId=="string"?n.cardId.trim():"";if(!r)return null;const a=(Array.isArray(t.get().analysisCards)?t.get().analysisCards:[]).find(d=>d.id===r);if(!a)return null;const o=((u=a.plan)==null?void 0:u.title)??"this card";switch(e.toolName){case"changeCardChartType":{const d=typeof n.newType=="string"?n.newType:null,c=a.displayChartType??a.plan.chartType;if(d&&d===c)return`Skipped chart switch because "${o}" is already a ${d} chart.`;break}case"showCardData":{if(typeof n.visible!="boolean")break;if(a.isDataVisible===n.visible)return n.visible?`Raw data for "${o}" is already visible.`:`Raw data for "${o}" is already hidden.`;break}case"setTopN":{if(n.topN===void 0)break;const d=n.topN==="all"?null:Number(n.topN);if(d!==null&&!Number.isFinite(d))break;if((typeof a.topN=="number"?a.topN:null)===d){const p=d===null?"all categories":`Top ${d}`;return`Skipped Top N change because "${o}" already shows ${p}.`}break}case"toggleHideOthers":{if(typeof n.hide!="boolean")break;if(a.hideOthers===n.hide)return n.hide?`"${o}" already hides the "Others" bucket.`:`"${o}" is already showing the "Others" bucket.`;break}}return null},lR=t=>{if(typeof t!="string")return null;const e=t.trim();return e.length===0?null:e.length<3?"Filter query must be at least 3 characters.":e.length>200?"Filter query is too long (max 200 characters).":null},pK=t=>{var r;if((((r=t.code.explanation)==null?void 0:r.trim())??"").length<10)return"Code explanation must be at least 10 characters.";const n=t.code.jsFunctionBody.trim();return/return\s+/i.test(n)?null:"JavaScript transform must include a return statement."},hK=(t,e,n)=>{if(!e)return;const r=`Validation failed at step ${e.actionIndex+1}`,s=t.get().beginAgentActionTrace(e.actionType,r,"system");t.get().updateAgentActionTrace(s,"failed",e.reason,{errorCode:ke.VALIDATION_FAILED,metadata:{actionIndex:e.actionIndex}}),t.get().recordAgentValidationEvent({actionType:e.actionType,reason:e.reason,actionIndex:e.actionIndex,runId:t.runId,retryInstruction:n})},mK=(t,e)=>{var p,m,y,w,x,A;if(!Array.isArray(t.actions)||t.actions.length===0)return{isValid:!1,userMessage:"AI response was empty; requesting it to restate the plan...",retryInstruction:"You must return at least one action. Begin with a plan_state_update that satisfies the required schema before any other steps."};if(t.actions.length>HJ){const E=t.actions[1]??t.actions[0];return Jt(E,Math.min(1,t.actions.length-1),"Too many actions returned in a single response.","Limit every response to a plan_state_update followed by exactly one atomic action (text_response, dom_action, execute_js_code, etc.).")}let n=t.actions[0],r=e.get().plannerSession.planState;(p=e.detectedIntent)==null||p.intent;let s=null;const a=(E,C)=>{const D=typeof E.type=="string"?E.type.trim():"";if(!D)return Jt(E,C,"Action type is missing.","Every action must include the type field (matching responseType) along with stepId and stateTag.");if(E.responseType!==D)return Jt(E,C,"Action type must match responseType.","Keep the type field identical to responseType for every action.");E.type=D;const O=typeof E.stateTag=="string"?E.stateTag.trim():"";if(!O)return Jt(E,C,"stateTag is missing.",'Every action must include a monotonic stateTag formatted as "<epochMs>-<seq>" (or a known label like "awaiting_clarification").');const T=$p(O);if(!T)return Jt(E,C,"stateTag format is invalid.",'Mint stateTag tokens as "<epochMs>-<seq>" (optionally with a suffix) or use one of the known labels.');const I=QI(T);if(I){if(s&&(I.epochMs<s.epochMs||I.epochMs===s.epochMs&&I.seq<=s.seq))return Jt(E,C,"stateTag must strictly increase with each action.","Ensure every new action increments the numeric portion of the stateTag so it remains monotonic.");s=I}return E.stateTag=T,null},o=()=>{if(r=e.get().plannerSession.planState,n=t.actions[0],!n)return{isValid:!1,userMessage:"AI response was empty; requesting it to restate the plan...",retryInstruction:"You must return at least one action. Begin with a plan_state_update that satisfies the required schema before any other steps."};if(!r){if(n.responseType!=="plan_state_update"){const E=nc(e,n.planState??void 0),C=Ok(E,"Auto-inserted plan tracker before executing pending actions.");t.actions.unshift(C),e.get().updatePlannerPlanState(E),e.get().addProgress("Auto-inserted plan_state_update to bootstrap the planner.","system"),n=C,r=E}if($a(n))e.get().updatePlannerPlanState(n.planState),r=n.planState;else{const E=nc(e,n.planState??void 0);n.planState=E,e.get().updatePlannerPlanState(E),e.get().addProgress("Auto-filled missing plan tracker fields.","system"),r=E}return null}if(n.responseType!=="plan_state_update")return Jt(n,0,"First action must be plan_state_update when a plan tracker is active.",yk);if(!$a(n)){const E={...r,updatedAt:new Date().toISOString()};n.planState=E,e.get().updatePlannerPlanState(E),e.get().addProgress("Reused previous plan tracker snapshot for validation.","system")}return null};if(e.get().agentAwaitingUserInput){for(let E=0;E<t.actions.length;E++){const C=t.actions[E],D=a(C,E);if(D)return D;if(C.responseType!=="text_response")return Jt(C,E,"Planner is waiting for the user response, so only text_response actions are allowed.","Hold all plan_state_update or continue actions until awaitUser is cleared (resumePlanner:true after the user replies).")}return{isValid:!0}}const d=o();if(d)return d;n=t.actions[0],r=e.get().plannerSession.planState;for(let E=0;E<t.actions.length;E++){const C=t.actions[E],D=a(C,E);if(D)return D;const O=typeof C.stepId=="string"?C.stepId.trim():"";if(O.length<3){if(!kY(C,e,E))return Jt(C,E,"stepId is missing or invalid.","Every action must include stepId matching the pending plan step id (>=3 characters, typically kebab-case).")}else C.stepId=O;switch(C.responseType){case"plan_state_update":if(!$a(C))return Jt(C,E,"Plan tracker update missing required fields.","Ensure every plan_state_update includes goal, progress, nextSteps, blockedBy, observationIds, confidence, and updatedAt.");break;case"plan_creation":if(!Rk(C))return Jt(C,E,"Plan payload is missing.","Provide a full analysis plan object with chart type, title, description, and column selections.");break;case"dom_action":if(!Nk(C))return Jt(C,E,"DOM action payload is missing.","Include domAction with the toolName and args for card interactions.");VY(C,e,E);{const T=dK(C.domAction);if(T)return Jt(C,E,T,"Provide the required DOM tool arguments, including cardId and any tool-specific fields.")}break;case"execute_js_code":if(!Pk(C))return Jt(C,E,"Executable code payload is missing.","Every execute_js_code action must include explanation and a non-empty jsFunctionBody.");{const T=pK(C);if(T)return Jt(C,E,T,"Ensure your data transform includes a clear explanation and a return statement.")}break;case"filter_spreadsheet":if(!$Y(C)&&!oR(C,e,E))return Jt(C,E,"Filter query is missing.","Provide args.query describing how to filter the spreadsheet.");{let T=lR(((m=C.args)==null?void 0:m.query)??null);if(T&&oR(C,e,E)&&(T=lR(((y=C.args)==null?void 0:y.query)??null)),T)return Jt(C,E,T,"Provide a natural-language filter query between 3 and 200 characters.")}break;case"clarification_request":if(!Mk(C))return Jt(C,E,"Clarification payload is missing.","Include question, options, pendingPlan, and targetProperty fields.");{const T=cK(C);if(T)return Jt(C,E,T,"Clarification requests must include a question, at least one option, and a targetProperty.")}break;case"text_response":case"await_user":if(!Ik(C))return Jt(C,E,"Text response missing text payload.","Every text_response or await_user action must include a non-empty text field.");break}}const c=(w=e.detectedIntent)==null?void 0:w.requiredTool;if(c&&!e.intentRequirementSatisfied&&!t.actions.some(C=>kk(C,c))){const C=JY(e,c);if(C){const D=t.actions[0];t.actions=[D,C],s=QI((D==null?void 0:D.stateTag)??"")??null;const O=a(C,1);if(O)return O;const T=c.domToolName??c.responseType??"the required tool";e.get().addProgress(`Auto-inserted ${T} to satisfy the user's request.`,"system"),(A=(x=e.get()).recordAgentValidationEvent)==null||A.call(x,{actionType:C.responseType,reason:"auto_insert_required_tool",actionIndex:t.actions.length-1,runId:e.runId,retryInstruction:`Inserted ${T} automatically because it was required by the user intent.`})}else{const D=c.domToolName??c.responseType??"the required tool";return Jt(t.actions[0]??null,0,`Required tool ${D} missing.`,`The user's intent requires using ${D}. Include that action (with the correct payload) in your response before other tools.`)}}return{isValid:!0}},gK=async(t,e,n,r,s)=>{n.get().updateBusyStatus(r);const a=await e.requestAiResponse(t,s);return WJ.run(a,KY(n))},xi=t=>t.get().plannerSession.planState?"full":"plan_only",yK=t=>{if(xi(t)==="plan_only")return"plan";switch(t.get().graphPhase??"plan"){case"act":return"act";case"plan":case"observe":return"plan";default:return"talk"}},_K=async(t,e,n)=>{var P;const s="Requesting corrected plan outline...";let a=0,o=0,u=!1,d=!1,c=0,p=0,m=!1;const y=k=>iR(k,n.intentNotes),w=dY(n.detectedIntent),x=w.maxValidationRetries,A=w.allowPlanFallbackPrompt,E=w.allowAutoContinuation,C=async(k,$,U)=>{const F=yK(n);n.get().setActiveSchemaPhase(F);const K={...U??{},phase:F},j=await gK(k,e,n,$,K);hY(j,n);const V=mY(j.actions);return V.resumePlanner&&gY(n),{response:j,meta:V}},D=y(t),O=n.get().graphPhase??"observe",T=FJ(O);let I=0;const M=()=>{if(!(xi(n)!=="full"||T.length===0))return T[Math.min(I,T.length-1)]},N=()=>{if(I<T.length-1)return I+=1,T[I]};ir(n,"observing","Reviewing the current dataset and prior context...");try{ir(n,"planning","Thinking through your question...");let{response:k,meta:$}=await C(D,"Thinking through your question...",{mode:xi(n),promptStage:M()});for(;k;){if(n.get().isRunCancellationRequested(n.runId)){n.get().addProgress("Stopped processing request.");return}const U=mK(k,n);if(!U.isValid){o++,hK(n,U.details,U.retryInstruction),n.get().addProgress(U.userMessage,"error");const ee=xi(n),ce=ee==="full"?N():void 0;if(ce){o=Math.max(0,o-1),n.get().addProgress(`Adding ${WI[ce]} context to assist the planner.`),{response:k,meta:$}=await C(D,`Adding ${WI[ce]} context...`,{mode:ee,promptStage:ce});continue}if(o>=x){if(!d){d=!0,o=0,n.get().addProgress("Plan validation failed; asking the AI to restate your request and try again.","system"),ir(n,"planning","Restating your request before continuing..."),{response:k,meta:$}=await C(y(`${n.userMessage}

SYSTEM NOTE: Restate the user's latest request in your own words to confirm understanding, then provide a valid plan_state_update that follows the shared schema exactly.`),"Restating your request...",{mode:xi(n)});continue}if(!u&&A){u=!0,o=0,n.get().addProgress("Plan validation failed twice; requesting a simplified plan snapshot...","system"),ir(n,"planning","Rebuilding the plan outline..."),{response:k,meta:$}=await C(iR(qY(n),n.intentNotes),KJ,{mode:"plan_only"});continue}n.get().addProgress("Unable to obtain a valid plan update after multiple attempts.","error");const ie={sender:"ai",text:"Sorry, I could not establish a valid plan_state_update. Please try again or rephrase your question.",timestamp:new Date,type:"ai_message",isError:!0};n.set(fe=>({chatHistory:[...fe.chatHistory,ie]}));return}ir(n,"planning","Revising the plan outline based on validation feedback..."),{response:k,meta:$}=await C(y(`${n.userMessage}

SYSTEM NOTE: ${U.retryInstruction}`),s,{mode:xi(n)});continue}const F=1-a,K=k.actions.some(ee=>!["plan_state_update","text_response","await_user"].includes(ee.responseType)),j=k.actions.some(ee=>cY.has(ee.responseType));ir(n,"acting",K?"Executing the next step of the plan...":"Delivering the latest reasoning step...");const V=await bK(k,n,F),B=k.actions.filter(ee=>ee.responseType!=="plan_state_update").length;V.type!=="retry"&&(p+=B);let G=k.actions.some(ee=>ee.responseType==="text_response"||ee.responseType==="await_user");if(V.type==="complete"&&!G&&(G=yY(n,k)),V.type==="halt")return;if(V.type==="retry"){const ee=a+2;a++;const ce=`attempt ${ee}`,ie=V.phaseMessage??"Retrying the last action automatically...";ir(n,"retrying",ie);const Re={sender:"ai",text:` ${V.userFacingMessage??`The previous action failed (${V.reason}). I'll try again automatically (${ce}).`}`,timestamp:new Date,type:"ai_message",isError:!0};n.set(je=>({chatHistory:[...je.chatHistory,Re]}));const Ge=V.progressMessage??` Auto-retrying last action (${ce})...`;n.get().addProgress(Ge);const ze=V.statusMessage??"Adjusting the plan after a failed attempt...";ir(n,"planning",ze);const Ae=V.retryPrompt??`SYSTEM NOTE: Previous action failed because ${V.reason}. Please adjust and try again.`,Rt=V.promptMode??"full";({response:k,meta:$}=await C(y(`${n.userMessage}

${Ae}`),ze,{mode:Rt}));continue}if($.awaitUser){Yv(n,$);return}if($.haltAfter){n.get().addProgress("Stopped auto-continue per AI instruction.");return}ir(n,"verifying","Reviewing what just happened before continuing...");const{hasPendingSteps:Z,stateTag:se,hasBlocker:le}=FY(n),q=se?jJ.has(se):!1,W=p>=zJ;if(V.type==="complete"&&G&&E&&j&&c<ZI&&Z&&!q&&!le&&!n.get().isRunCancellationRequested(n.runId)&&!K&&!W){c++;const ee=n.get().plannerSession.planState,ce=[n.userMessage,"",`SYSTEM NOTE: Continue executing your plan. Current goal: ${(ee==null?void 0:ee.goal)??"N/A"}.`,(P=ee==null?void 0:ee.nextSteps)!=null&&P.length?`Remaining steps: ${ee.nextSteps.map(fe=>`[${fe.id}] ${fe.label}`).join(" | ")}`:null,ee!=null&&ee.blockedBy?`Known blockers: ${ee.blockedBy}`:null].filter(Boolean).join(`
`),ie=c===1?"Continuing plan":`Continuing plan (cycle ${c}/${ZI})`;n.get().addProgress(ie),ir(n,"planning","Continuing with the remaining plan steps..."),{response:k,meta:$}=await C(y(ce),c===1?"Continuing plan...":`Continuing plan (cycle ${c})...`,{mode:"full"});continue}W&&!m&&(n.get().addProgress("Step budget reached (plan tracker + 1 atomic action). Waiting for your next input before continuing.","system"),m=!0);break}ir(n,"reporting","Summarizing the latest findings...")}finally{wY(n)||vY(n)}},vK=t=>t.responseType==="filter_spreadsheet"||t.responseType==="execute_js_code"?!0:t.responseType==="dom_action"&&t.domAction?["filterCard","setTopN","toggleHideOthers","toggleLegendLabel","highlightCard","showCardData","removeCard"].includes(t.domAction.toolName):!1,wK=(t,e,n,r)=>{if(r.status!=="success"||!vK(e))return;const s=Ck(t.get()),a={rawDataExplorerSummary:s.summary,filteredRows:s.metadata.filteredRows,totalRows:s.metadata.totalRows,snippetHash:s.metadata.snippetHash,drilldownLabel:s.metadata.drilldownLabel,drilldownValueCount:s.metadata.drilldownValueCount};t.get().appendPlannerObservation({id:Ak(),actionId:n,responseType:e.responseType,status:"success",timestamp:new Date().toISOString(),outputs:a,errorCode:null,uiDelta:null}),typeof t.get().annotateAgentActionTrace=="function"&&t.get().annotateAgentActionTrace(n,a)},bK=async(t,e,n)=>{var r,s,a;await bY();try{for(const o of t.actions){if(e.get().isRunCancellationRequested(e.runId))return e.get().addProgress("Cancelled remaining actions."),{type:"halt"};const u=LY(o),d=e.get().beginAgentActionTrace(o.responseType,u,"chat"),c=(C,D,O)=>{e.get().updateAgentActionTrace(d,C,D,O)},p=$p(o.stateTag),m={};p&&(m.stateTag=p),typeof o.stepId=="string"&&o.stepId.trim().length>0&&(m.stepId=o.stepId.trim());const y=Object.keys(m).length>0?{metadata:m}:void 0;c("executing",void 0,y),o.responseType==="dom_action"&&o.domAction&&Kv(e,o.domAction);const w=await uK(o,e,n,c),x=NY(w),A=DY(o,d,x);if(e.get().appendPlannerObservation(A),wK(e,o,d,A),((r=e.detectedIntent)==null?void 0:r.requiredTool)&&!e.intentRequirementSatisfied&&kk(o,e.detectedIntent.requiredTool)&&A.status==="success"&&(e.intentRequirementSatisfied=!0,e.get().addProgress(`Intent requirement satisfied via ${e.detectedIntent.requiredTool.domToolName??e.detectedIntent.requiredTool.responseType}.`),e.get().annotateAgentActionTrace(d,{intentSatisfied:!0,intent:e.detectedIntent.intent})),w.type==="retry"){const C=((s=w.observation)==null?void 0:s.status)??null,D=!!((a=w.observation)!=null&&a.outputs&&"awaitUser"in w.observation.outputs&&w.observation.outputs.awaitUser);return TY.has(o.responseType)&&C==="error"&&!D?{type:"retry",reason:w.reason,retryPrompt:w.retryPrompt,userFacingMessage:w.userFacingMessage,progressMessage:w.progressMessage,phaseMessage:w.phaseMessage,statusMessage:w.statusMessage,promptMode:w.promptMode}:(e.get().addProgress("Skip auto-heal retry because this action is not eligible.","system"),{type:"halt"})}if(w.type==="halt")return{type:"halt"}}return{type:"complete"}}finally{SY()}},uR=async({action:t,runtime:e,markTrace:n})=>{var p,m,y,w;if(!Ik(t))return n("failed","No AI text response provided.",{errorCode:ke.MISSING_TEXT}),{type:"continue",observation:{status:"error",errorCode:ke.MISSING_TEXT}};const r=pP(t.text??""),s=xk(t.text),a=t.responseType==="await_user",o=!!((p=t.meta)!=null&&p.awaitUser)||a;if(o&&r.length===0){const x='SYSTEM NOTE: Your previous message asked the user for a choice but did not include explicit options. Restate the question and list at least two options using a numbered format (e.g., "1)  2) ").';return e.get().addProgress("Await-user question lacked explicit options. Asking the AI to restate it with numbered choices...","error"),n("failed","Await-user prompt missing options.",{errorCode:ke.VALIDATION_FAILED}),{type:"retry",reason:"Await-user prompt missing selectable options.",retryPrompt:x,userFacingMessage:"The assistant needed to restate the question with concrete options. Retrying...",progressMessage:"Requesting a multiple-choice restatement from the assistant...",phaseMessage:"Rephrasing question to include explicit options...",statusMessage:"Rebuilding prompt with options...",promptMode:"full",observation:{status:"error",errorCode:ke.VALIDATION_FAILED,outputs:{issue:"missing_options"}}}}const u=o||r.length>0||s;if(u){const x=t.meta??(t.meta={});x.awaitUser=!0,x.haltAfter=!0,x.promptId||(x.promptId=ec())}const d=!e.memoryTagAttached&&e.memorySnapshot.length>0,c={sender:"ai",text:t.text,timestamp:new Date,type:"ai_message",cardId:t.cardId,usedMemories:d?e.memorySnapshot:void 0,meta:t.meta};return e.set(x=>({chatHistory:[...x.chatHistory,c]})),tK(e),d&&(e.memoryTagAttached=!0),n("succeeded","Shared response with user."),u?(Yv(e,{promptId:((m=t.meta)==null?void 0:m.promptId)??null,blockedReason:((y=t.text)==null?void 0:y.trim())||null,stateTagOverride:"awaiting_clarification"}),{type:"halt",observation:{status:"pending",outputs:{awaitUser:!0,promptId:((w=t.meta)==null?void 0:w.promptId)??null,quickChoices:r}}}):{type:"continue",observation:{status:"success",outputs:{textPreview:t.text.slice(0,200),cardId:t.cardId??null}}}},SK=async({action:t,runtime:e,markTrace:n})=>{var p,m,y,w,x,A;if(!$a(t))return n("failed","Missing plan state payload.",{errorCode:ke.PLAN_STATE_PAYLOAD_MISSING}),{type:"continue",observation:{status:"error",errorCode:ke.PLAN_STATE_PAYLOAD_MISSING}};const r=t.planState,s=tc(r.nextSteps),a=tc(r.steps),o=((p=s[0])==null?void 0:p.id)??((m=a[0])==null?void 0:m.id)??((y=e.get().plannerPendingSteps[0])==null?void 0:y.id)??yc,u=typeof r.planId=="string"&&r.planId.trim().length>0?r.planId.trim():((w=e.get().plannerSession.planState)==null?void 0:w.planId)??`plan-${Date.now().toString(36)}`,d=typeof r.currentStepId=="string"&&r.currentStepId.trim().length>=3?r.currentStepId.trim():o,c={planId:u,goal:r.goal.trim(),progress:r.progress.trim(),nextSteps:s,steps:a.length>0?a:s,currentStepId:d,blockedBy:((x=r.blockedBy)==null?void 0:x.trim())||null,contextSummary:((A=r.contextSummary)==null?void 0:A.trim())||null,observationIds:Array.isArray(r.observationIds)?r.observationIds.filter(E=>typeof E=="string"&&E.trim().length>0):[],confidence:typeof r.confidence=="number"?Math.min(1,Math.max(0,r.confidence)):r.confidence??null,updatedAt:r.updatedAt||new Date().toISOString(),stateTag:$p(r.stateTag)??null};return e.get().updatePlannerPlanState(c),e.get().addProgress(`Plan goal updated: ${c.goal}`),n("succeeded","Plan state captured."),{type:"continue",observation:{status:"success",outputs:{goal:c.goal,nextSteps:c.nextSteps,blockedBy:c.blockedBy}}}},xK=async({action:t,runtime:e,markTrace:n})=>{const r=e.get().csvData;if(!Rk(t)||!r)return n("failed","Missing plan payload or dataset.",{errorCode:ke.MISSING_PLAN_PAYLOAD}),{type:"continue",observation:{status:"error",errorCode:ke.MISSING_PLAN_PAYLOAD}};const s=HY(e,t.plan);if(s)return n("succeeded","Requested metric column clarification before executing plan.",{metadata:{clarificationId:s}}),{type:"halt",observation:{status:"pending",outputs:{clarificationId:s,targetProperty:"valueColumn"}}};const a=await e.deps.runPlanWithChatLifecycle(t.plan,r,e.runId);return n("succeeded",`Executed plan for "${t.plan.title??"analysis"}".`),{type:"continue",observation:{status:"success",outputs:{planTitle:t.plan.title??"analysis",cardsCreated:a.length}}}},TK=async({action:t,runtime:e,markTrace:n})=>{var o,u,d,c,p;if(!Nk(t))return n("failed","Missing DOM action payload.",{errorCode:ke.DOM_PAYLOAD_MISSING}),{type:"continue",observation:{status:"error",errorCode:ke.DOM_PAYLOAD_MISSING}};if(!(typeof((o=t.domAction.target)==null?void 0:o.byId)=="string"||typeof((u=t.domAction.target)==null?void 0:u.byTitle)=="string"||typeof((d=t.domAction.target)==null?void 0:d.selector)=="string"||typeof((c=t.domAction.args)==null?void 0:c.cardId)=="string"||typeof((p=t.domAction.args)==null?void 0:p.cardTitle)=="string")){const m="I need you to pick a specific chart before I can perform that action.";e.get().addProgress(m,"error");const y={sender:"ai",text:`${m} Please tap the chart or tell me its title so I can continue.`,timestamp:new Date,type:"ai_message",isError:!0};return e.set(w=>({chatHistory:[...w.chatHistory,y]})),n("succeeded","DOM action skipped due to missing target.",{metadata:{downgraded:!0}}),{type:"continue",observation:{status:"success",outputs:{downgraded:!0}}}}const s=fK(e,t.domAction);if(s){e.get().addProgress(s);const m={sender:"ai",text:s,timestamp:new Date,type:"ai_message"};return e.set(y=>({chatHistory:[...y.chatHistory,m]})),n("succeeded","DOM action skipped (already satisfied).",{metadata:{skipped:!0,toolName:t.domAction.toolName}}),{type:"continue",observation:{status:"success",outputs:{skipped:!0,reason:s}}}}const a=t.domAction.args??(t.domAction.args={});if(typeof a.cardId!="string"||a.cardId.trim().length===0){const m=zY(e,t.domAction);return n("succeeded","Requested card selection before executing DOM action.",{metadata:{clarificationId:m}}),m?{type:"halt",observation:{status:"pending",outputs:{clarificationId:m,awaitingCardSelection:!0}}}:{type:"halt",observation:{status:"error",errorCode:ke.DOM_PAYLOAD_MISSING}}}return e.get().executeDomAction(t.domAction),n("succeeded",`DOM action ${t.domAction.toolName} completed.`),{type:"continue",observation:{status:"success",outputs:{toolName:t.domAction.toolName,args:t.domAction.args??null},uiDelta:t.domAction.toolName}}},AK=async({action:t,runtime:e,remainingAutoRetries:n,markTrace:r})=>{var o;const s=EY(t.intentContract??null);if(s){const u=await CY({contract:s,runtime:e,markTrace:r});if(u)return u}const a=e.get().csvData;if(!a){const u="Dataset unavailable for transformation.";e.get().addProgress(u,"error");const d={sender:"ai",text:`${u} I could not run the requested update.`,timestamp:new Date,type:"ai_message",isError:!0};return e.set(c=>({chatHistory:[...c.chatHistory,d]})),r("failed",u,{errorCode:ke.DATASET_UNAVAILABLE}),{type:"continue",observation:{status:"error",errorCode:ke.DATASET_UNAVAILABLE}}}if(!Pk(t)){const u="AI requested a data transformation but did not include executable code, so no changes were applied.";e.get().addProgress(u,"error");const d={sender:"ai",text:u,timestamp:new Date,type:"ai_message",isError:!0};return e.set(c=>({chatHistory:[...c.chatHistory,d]})),r("failed","Missing jsFunctionBody in execute_js_code payload.",{errorCode:ke.MISSING_JS_CODE}),{type:"continue",observation:{status:"error",errorCode:ke.MISSING_JS_CODE}}}if(e.get().pendingDataTransform){const u="A previous AI transformation is still awaiting your approval. Please confirm or discard it before running another one.";e.get().addProgress(u,"error");const d={sender:"ai",text:`${u} You can review it in the Data Change banner above the dashboard.`,timestamp:new Date,type:"ai_message",isError:!0};return e.set(c=>({chatHistory:[...c.chatHistory,d]})),r("failed",u,{errorCode:ke.TRANSFORM_PENDING}),{type:"continue",observation:{status:"error",errorCode:ke.TRANSFORM_PENDING}}}try{const u=(j,V)=>{if(Array.isArray(j)&&j.length>0)return j.map(G=>G.name);const B=V.find(G=>G&&typeof G=="object");return B?Object.keys(B):[]},d=j=>{if(!j||j.length===0)return"(none)";const V=j.slice(0,8).join(", ");return j.length>8?`${V}, `:V},c=e.get().columnAliasMap,p=eH(a.data,c),m=FR(p,t.code.jsFunctionBody.trim());if((o=m.meta)!=null&&o.noOp){const j="AI data transformation produced no observable changes.";e.get().addProgress(j,"error"),r("failed",j,{errorCode:ke.TRANSFORM_FAILED});const V={status:"error",errorCode:ke.TRANSFORM_FAILED,outputs:{message:j}};return n>0?{type:"retry",reason:j,observation:V}:{type:"halt",observation:V}}const y=tH(m.data,c),w={...a,data:y},x=$u(w.data),A=Hu(x.map(j=>j.name)),E=u(e.get().columnProfiles,a.data),C=u(x,y),D=E.filter(j=>!C.includes(j)),O=C.filter(j=>!E.includes(j)),T=[`Before (${E.length}): ${d(E)}`,`After (${C.length}): ${d(C)}`,D.length?`Removed: ${d(D)}`:null,O.length?`Added: ${d(O)}`:null].filter(Boolean).join(`
`),{rowsBefore:I,rowsAfter:M,removedRows:N,addedRows:P,modifiedRows:k}=m.meta,$=[`${I}  ${M} rows`,N?`${N} removed`:null,P?`${P} added`:null,k?`${k} modified`:null].filter(Boolean),U=$.length>0?$.join(", "):"changes detected",F=`transform-${Date.now()}`;e.get().queuePendingDataTransform({id:F,summary:U,explanation:t.code.explanation,meta:m.meta,previewRows:y.slice(0,5),nextData:w,nextColumnProfiles:x,nextAliasMap:A,sourceCode:t.code.jsFunctionBody.trim(),createdAt:new Date().toISOString(),beforeColumns:E,afterColumns:C});const K={sender:"ai",text:`I drafted a data transformation (${U}). Please review the banner above the dashboard to confirm or discard it.

${T}`,timestamp:new Date,type:"ai_message",cardId:t.cardId};return e.set(j=>({chatHistory:[...j.chatHistory,K]})),r("succeeded",`${U} (awaiting confirmation)`),{type:"continue",observation:{status:"success",outputs:{summary:U,rowsBefore:I,rowsAfter:M,pendingTransformId:F}}}}catch(u){const d=u instanceof Error?u.message:String(u);e.get().addProgress(`AI data transformation failed: ${d}`,"error");const c={sender:"ai",text:`I couldn't apply that data transformation: ${d}`,timestamp:new Date,type:"ai_message",isError:!0};e.set(m=>({chatHistory:[...m.chatHistory,c]})),r("failed",d,{errorCode:ke.TRANSFORM_FAILED});const p={status:"error",errorCode:ke.TRANSFORM_FAILED,outputs:{message:d}};return n>0?{type:"retry",reason:d,observation:p}:{type:"halt",observation:p}}},EK=async({action:t,runtime:e,markTrace:n})=>{var o,u;const{query:r,source:s}=Wv(e,((o=t.args)==null?void 0:o.query)??null,((u=e.detectedIntent)==null?void 0:u.intent)==="data_filter"?e.detectedIntent.requiredTool:void 0),a=r===vk;return t.args?t.args.query=r:t.args={query:r},s==="user_message"?e.get().addProgress("No filter payload provided; inferring filter from your latest message."):s==="default"&&e.get().addProgress("No useful filter found; showing the entire dataset so you can refine it."),e.get().addProgress(a?"Showing the full raw dataset for you. Apply a natural-language filter any time.":"AI is filtering the data explorer based on your request."),await e.get().handleNaturalLanguageQuery(r),e.set({isSpreadsheetVisible:!0}),setTimeout(()=>{var d;(d=document.getElementById("raw-data-explorer"))==null||d.scrollIntoView({behavior:"smooth",block:"center"})},100),n("succeeded",`Filter query: ${r}`),{type:"continue",observation:{status:"success",outputs:{query:r,showAll:a},uiDelta:"filter_spreadsheet"}}},CK=async({action:t,runtime:e,markTrace:n})=>{var u,d;if(!Mk(t))return n("failed","Clarification payload missing.",{errorCode:ke.CLARIFICATION_PAYLOAD_MISSING}),{type:"continue",observation:{status:"error",errorCode:ke.CLARIFICATION_PAYLOAD_MISSING}};const r=nH(t.clarification,(u=e.get().csvData)==null?void 0:u.data,e.get().columnProfiles.map(c=>c.name),{preferredColumns:UY(t.clarification.pendingPlan)});if(!r){const c="I could not find any usable columns for that question. Try inspecting the data preview to pick a different column.";e.get().addProgress(c,"error");const p={sender:"ai",text:`${c}
You can also open the Data Preview to double-check column names.`,timestamp:new Date,type:"ai_message",isError:!0,cta:{type:"open_data_preview",label:"Open Data Preview",helperText:"Review the raw columns before asking again."}};return e.set(m=>({chatHistory:[...m.chatHistory,p]})),n("failed","Unable to find usable clarification options.",{errorCode:ke.CLARIFICATION_NO_OPTIONS}),{type:"continue",observation:{status:"error",errorCode:ke.CLARIFICATION_NO_OPTIONS}}}if(!r.options||r.options.length===0){const c="SYSTEM NOTE: Clarification requests must include at least two concrete options the user can pick. Please restate the clarification with enumerated options (e.g., Option A, Option B).";return n("failed","Clarification request missing options.",{errorCode:ke.CLARIFICATION_NO_OPTIONS}),e.get().addProgress("Clarification request missing options. Asking the AI to restate with explicit choices...","error"),{type:"retry",reason:"Clarification request missing options.",retryPrompt:c,userFacingMessage:"Clarification was missing explicit options, so I asked the AI to restate it.",progressMessage:"Requesting a clarification with explicit options...",phaseMessage:"Retrying clarification step...",statusMessage:"Rebuilding clarification request...",promptMode:"full"}}const s=((d=t.reason)==null?void 0:d.trim())||"Need your preference before I can finalize this step.",a=e.deps.registerClarification({...r,reasonHint:s});if(a.options.length===1){const c=a.options[0];return e.get().addProgress(`AI inferred you meant "${c.label}" (${c.value}).`),await e.get().handleClarificationResponse(a.id,c),n("succeeded","Auto-resolved clarification based on single option."),{type:"continue",observation:{status:"success",outputs:{clarificationId:a.id,autoResolved:!0}}}}const o={sender:"ai",text:a.columnHints&&a.columnHints.length>0?`${a.question}

(Column context: ${a.columnHints.join(", ")})`:a.question,timestamp:new Date,type:"ai_clarification",clarificationRequest:a};return e.set(c=>({chatHistory:[...c.chatHistory,o]})),e.set({activeClarificationId:a.id}),ir(e,"clarifying","Need your input to keep going..."),e.get().endBusy(e.runId),Yv(e,{promptId:a.id,blockedReason:a.question,stateTagOverride:"awaiting_clarification"}),n("succeeded","Requested user clarification."),{type:"halt",observation:{status:"pending",outputs:{clarificationId:a.id,optionCount:a.options.length}}}},IK=async({markTrace:t})=>(t("succeeded","Proceed to analysis acknowledged."),{type:"continue",observation:{status:"success"}}),RK={text_response:uR,await_user:uR,plan_creation:xK,plan_state_update:SK,dom_action:TK,execute_js_code:AK,filter_spreadsheet:EK,clarification_request:CK,proceed_to_analysis:IK},$p=t=>{if(!t)return;const e=t.trim();if(!e)return;if(BJ.has(e)||gk.test(e))return e;const n=Date.now();n-nR>qJ&&(console.warn(`Unknown agent stateTag "${e}". Allowed values: ${hP.join(", ")} or minted "<epoch>-<seq>" tokens.`),nR=n)},NK=t=>{const e=Date.now();e-rR<GJ||(rR=e,t.get().addToast("AI ","info"))};class PK{constructor(e){this.set=e.set,this.get=e.get,this.deps=e.deps,this.policy=e.policy??LJ}async handleMessage(e){var w,x;const n=e.trim(),r={sender:"user",text:e,timestamp:new Date,type:"user_message"},s=this.get(),a=s.datasetHash??null,o=s.plannerDatasetHash??null,u=!!(o&&a&&o!==a),d=XJ(e),c=wk.test(n),p=_H(e,s);if(p.intent!=="unknown"){const A=((w=p.requiredTool)==null?void 0:w.domToolName)??((x=p.requiredTool)==null?void 0:x.responseType)??"n/a";s.addProgress(`[IntentRouter] Detected intent=${p.intent} (conf=${p.confidence.toFixed(2)}) tool=${A}`)}const m=_Y(p,s);(u||d||c&&s.plannerSession.planState)&&(s.resetPlannerObservations(),s.clearPlannerPlanState(),u?s.addProgress("Detected new dataset; resetting the analysis plan tracker."):d?s.addProgress("Resetting the analysis plan as requested."):c&&s.addProgress("Greeting detected; starting a fresh plan for this interaction.")),this.set({agentAwaitingUserInput:!1,agentAwaitingPromptId:null});const y=this.get().beginBusy("Working on your request...",{cancellable:!0});this.set(A=>({chatHistory:[...A.chatHistory,r]}));try{const A=await YY(e,this.get,this.deps,y);if(this.get().isRunCancellationRequested(y)){this.get().addProgress("Stopped processing request.");return}await _K(e,A,{set:this.set,get:this.get,deps:this.deps,runId:y,userMessage:e,memorySnapshot:A.memorySnapshot,memoryTagAttached:!1,starterActionsShared:!1,policy:this.policy,intentNotes:m,detectedIntent:p,intentRequirementSatisfied:!(p!=null&&p.requiredTool)})}catch(A){if(!this.get().isRunCancellationRequested(y)){const E=A instanceof Error?A.message:String(A);this.get().addProgress(`Error: ${E}`,"error");const C={sender:"ai",text:`Sorry, an error occurred: ${E}`,timestamp:new Date,type:"ai_message",isError:!0};this.set(D=>({chatHistory:[...D.chatHistory,C]}))}}finally{this.get().pendingClarifications.some(A=>A.status==="pending"||A.status==="resolving")||this.get().endBusy(y),this.get().clearChatMemoryPreview()}}}const MK=(t,e,n,r)=>{const s=Date.now(),a=r??`plan-${s.toString(36)}`,o=`clarified-${s.toString(36)}`,u={id:o,label:t.title??"Clarified analysis",intent:"analysis",status:"ready"},d={planId:a,goal:t.description??t.title??"Execute clarified analysis",contextSummary:e,progress:`Clarification answered: ${n}`,nextSteps:[u],steps:[u],currentStepId:o,blockedBy:null,observationIds:[],confidence:.75,updatedAt:new Date(s).toISOString(),stateTag:"context_ready"};return{source:"langchain",planId:a,stepId:o,summary:`Clarification resolved: ${t.title??"analysis"}`,plan:t,planState:d,telemetry:{latencyMs:0,startedAt:s,finishedAt:s}}},kK=(t,e,n)=>{const r=new PK({set:t,get:e,deps:n});return{chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1,handleChatMessage:async s=>{if(!e().isApiKeySet){e().addProgress("API Key not set.","error"),e().setIsSettingsModalOpen(!0);return}await r.handleMessage(s)},previewChatMemories:async s=>{const a=s.trim();if(!a){t({chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1});return}if(!wt.getIsInitialized()||wt.getDocumentCount()===0){t({chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:a,isMemoryPreviewLoading:!1});return}t({chatMemoryPreviewQuery:a,isMemoryPreviewLoading:!0});try{const o=await wt.search(a,3);e().chatMemoryPreviewQuery===a&&t({chatMemoryPreview:o,chatMemoryExclusions:[],isMemoryPreviewLoading:!1})}catch(o){console.error("Preview memory search failed:",o),e().chatMemoryPreviewQuery===a&&t({isMemoryPreviewLoading:!1})}},toggleMemoryPreviewSelection:s=>{t(a=>({chatMemoryExclusions:a.chatMemoryExclusions.includes(s)?a.chatMemoryExclusions.filter(u=>u!==s):[...a.chatMemoryExclusions,s]}))},clearChatMemoryPreview:()=>{t({chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1})},handleClarificationResponse:async(s,a)=>{const{csvData:o,columnProfiles:u}=e(),d=e().pendingClarifications.find(p=>p.id===s&&p.status==="pending");if(!d||!o)return;const c={sender:"user",text:`Selected: ${a.label}`,timestamp:new Date,type:"user_message"};t(p=>({chatHistory:[...p.chatHistory,c]})),await F_({beginBusy:e().beginBusy,endBusy:e().endBusy},"Applying clarification...",async p=>{var m,y;try{n.updateClarificationStatus(s,"resolving");const{pendingPlan:w,targetProperty:x}=d,A=()=>{t(P=>({pendingClarifications:P.pendingClarifications.map(k=>k.id===s?{...k,status:"resolved"}:k),agentAwaitingUserInput:!1,agentAwaitingPromptId:P.agentAwaitingPromptId===s?null:P.agentAwaitingPromptId,activeClarificationId:P.activeClarificationId===s?null:P.activeClarificationId})),typeof e().completePlannerPendingStep=="function"&&e().completePlannerPendingStep()};if(d.contextType==="dom_action"&&(w!=null&&w.domActionContext)){const P=w.domActionContext,k={...P.args??{},cardId:a.value,cardTitle:a.label};e().executeDomAction({toolName:P.toolName,args:k}),n.updateClarificationStatus(s,"resolved"),t($=>({chatHistory:[...$.chatHistory,{sender:"ai",text:P.toolName==="removeCard"?`Removed the chart "${a.label}".`:`Updated the chart "${a.label}".`,timestamp:new Date,type:"ai_message"}]})),A(),e().addProgress(`Applied ${P.toolName} to "${a.label}".`);return}const E=u.map(P=>P.name),C=fP(a,x,E);if(zu.includes(x)&&(!C||!E.includes(C))){const P=`I couldn't find a column matching "${a.label}". Please pick another option so I know which column to use.`;e().addProgress(P,"error");const k={sender:"ai",text:P,timestamp:new Date,type:"ai_message",isError:!0};t($=>({chatHistory:[...$.chatHistory,k]})),n.updateClarificationStatus(s,"pending");return}const D=x==="groupByColumn",O=D?Gf(C,o.data,2,50):Gf(C,o.data);if(zu.includes(x)&&C&&!O){const P=D?`The column "${C}" doesn't look like a good grouping (not enough distinct categories). Please pick another option.`:`Looks like "${C}" does not contain data right now. Please pick another option or ask about a different metric.`;e().addProgress(P,"error");const k={sender:"ai",text:P,timestamp:new Date,type:"ai_message",isError:!0};t($=>({chatHistory:[...$.chatHistory,k]})),n.updateClarificationStatus(s,"pending");return}const T={...w,[x]:C??a.value},I=rH(T,u);if(I.aggregation||(I.aggregation=I.valueColumn?"sum":"count"),I.chartType||(I.chartType="bar"),I.chartType!=="scatter"&&(delete I.xValueColumn,delete I.yValueColumn),I.chartType!=="combo"&&(delete I.secondaryValueColumn,delete I.secondaryAggregation),!I.groupByColumn&&I.chartType!=="scatter"){const P=u.map(U=>U.name);let k=null;const $=[...P].sort((U,F)=>F.length-U.length);for(const U of $){const F=U.toLowerCase().replace(/_/g," ");if(a.label.toLowerCase().includes(F)){k=U;break}}if(k)I.groupByColumn=k,e().addProgress(`AI inferred grouping by "${k}" based on your selection.`);else{const{column:U}=uP(u,o.data);U&&(I.groupByColumn=U,e().addProgress(`AI inferred grouping by "${U}" based on your dataset.`))}}if(I.title||(I.title=`Analysis of ${a.label}`),I.description||(I.description=`A chart showing an analysis of ${a.label}.`),I.chartType!=="scatter"&&(!I.chartType||!I.groupByColumn||!I.aggregation)){const P=["chartType","groupByColumn","aggregation"].filter(k=>!I[k]);throw P.includes("groupByColumn")?new Error("/ grouping column (system could not infer the grouping column)."):new Error(`The clarified plan is still missing required fields like ${P.join(", ")}.`)}const M=((y=(m=e().plannerSession)==null?void 0:m.planState)==null?void 0:y.planId)??null,N=MK(I,d.question,a.label,M);e().addProgress(`Clarification resolved  building "${I.title??"analysis"}" via Graph.`),e().runGraphPipeline({reason:"clarification_plan",langChainPlan:N}),n.updateClarificationStatus(s,"resolved"),A()}catch(w){if(!e().isRunCancellationRequested(p)){const x=w instanceof Error?w.message:String(w);e().addProgress(`Error processing clarification: ${x}`,"error");const A={sender:"ai",text:`Sorry, an error occurred while creating the chart: ${x}`,timestamp:new Date,type:"ai_message",isError:!0};t(E=>({chatHistory:[...E.chatHistory,A]})),n.updateClarificationStatus(s,"pending")}}},{cancellable:!0})},skipClarification:s=>{const a=e().pendingClarifications.find(d=>d.id===s&&d.status==="pending");if(!a)return;const o={sender:"user",text:`Skipped: ${a.question}`,timestamp:new Date,type:"user_message"},u={sender:"ai",text:"No problemI cancelled that request. Ask me something else whenever you are ready.",timestamp:new Date,type:"ai_message"};n.updateClarificationStatus(s,"skipped"),t(d=>({chatHistory:[...d.chatHistory,o,u],pendingClarifications:d.pendingClarifications.map(c=>c.id===s?{...c,status:"skipped"}:c),agentAwaitingUserInput:!1,agentAwaitingPromptId:d.agentAwaitingPromptId===s?null:d.agentAwaitingPromptId,activeClarificationId:d.activeClarificationId===s?null:d.activeClarificationId})),e().endBusy()}}},OK=25,DK=t=>{let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e).toString(36)},ep=t=>{if(!t||!t.data)return null;const e=t.data.slice(0,OK),n=JSON.stringify({name:t.fileName??"unknown",rows:t.data.length,sample:e,columns:e[0]?Object.keys(e[0]):[]});return`ds_${DK(n)}`},Zv="csv_agent_last_dataset",Dk=t=>{try{t()}catch(e){console.warn("Dataset cache error:",e)}},Lk=t=>{Dk(()=>{typeof localStorage>"u"||localStorage.setItem(Zv,t)})},LK=()=>{Dk(()=>{typeof localStorage>"u"||localStorage.removeItem(Zv)})},$K=()=>{try{return typeof localStorage>"u"?null:localStorage.getItem(Zv)}catch(t){return console.warn("Dataset cache read error:",t),null}},UK=t=>{if(!t)return"AI transformation applied (row delta unknown).";const e=[`Rows ${t.rowsBefore.toLocaleString()}  ${t.rowsAfter.toLocaleString()}`];return t.removedRows>0&&e.push(`${t.removedRows.toLocaleString()} removed`),t.addedRows>0&&e.push(`${t.addedRows.toLocaleString()} added`),t.modifiedRows>0&&e.push(`${t.modifiedRows.toLocaleString()} modified`),t.noOp&&e.push("no row changes detected"),e.join(", ")},FK=(t,e,n,r)=>{if(!t)return[];const s=[],a=new Map(n.map(d=>[d.name,d])),o=new Map(r.map(d=>[d.name,d]));s.push({stepOrder:0,scope:"rows",columnName:null,rule:"ai_transformation",impactSummary:UK(e),impactMetrics:e?{...e,totalColumnsBefore:n.length,totalColumnsAfter:r.length}:{totalColumnsBefore:n.length,totalColumnsAfter:r.length},details:{explanation:t.explanation,beforeColumns:n.map(d=>({name:d.name,type:d.type})),afterColumns:r.map(d=>({name:d.name,type:d.type}))},source:"ai_plan",tags:["transformation"]});let u=1;return n.filter(d=>!o.has(d.name)).forEach(d=>{s.push({stepOrder:u++,scope:"column",columnName:d.name,rule:"column_removed",impactSummary:`Column "${d.name}" removed during AI cleanup.`,details:{previousType:d.type},source:"ai_plan",tags:["schema","removed"]})}),r.filter(d=>!a.has(d.name)).forEach(d=>{s.push({stepOrder:u++,scope:"column",columnName:d.name,rule:"column_added",impactSummary:`Column "${d.name}" added by AI transformation.`,details:{newType:d.type},source:"ai_plan",tags:["schema","added"]})}),r.filter(d=>{const c=a.get(d.name);return c&&c.type!==d.type}).forEach(d=>{const c=a.get(d.name);s.push({stepOrder:u++,scope:"column",columnName:d.name,rule:"column_type_change",impactSummary:`Column "${d.name}" type normalized from ${(c==null?void 0:c.type)??"unknown"} to ${d.type}.`,details:{previousType:c==null?void 0:c.type,newType:d.type},source:"ai_plan",tags:["schema","type_change"]})}),s},BK=(t,e,n)=>({handleFileUpload:async r=>{var o;const s=e();if(s.csvData&&s.csvData.data.length>0){const u=await Gu(Ma);if(u){const d=`report-${u.createdAt.getTime()}`,c={...u,id:d,updatedAt:new Date};try{await $_(c)}catch(p){console.error("Failed to archive current session before upload:",p)}}}wt.clear(),await U_(Ma),n.resetAutoSaveSession(),await e().loadReportsList(),t({...n.initialAppState,csvData:{fileName:r.name,data:[]},datasetHash:null,busyRunId:null,isCancellationRequested:!1,aiFilterRunId:null,abortControllers:{},toasts:[],chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1});const a=e().beginBusy(`Processing ${r.name}...`,{cancellable:!0});try{const u=async A=>{try{const E=await Ls.profile(A);E.ok?e().applyDatasetProfileSnapshot(E.data):e().addProgress(`Profiling failed: ${E.reason}`,"error")}catch(E){console.error("Failed to profile dataset via worker:",E),e().addProgress("Profiling worker failedretry later from chat.","error")}},d=async A=>{try{const E=await Ls.sample(A,{n:200});E.ok&&t({initialDataSample:E.data.rows})}catch(E){console.error("Failed to sample dataset via worker:",E)}},c=async(A,E)=>{try{const C=await EP(A);if(C!=null&&C.checksum&&C.checksum===A){if(!(typeof window>"u"?!0:window.confirm(""))){e().addProgress(" CSV ","system");return}e().addProgress("")}t(O=>({analysisTimeline:{...O.analysisTimeline,stage:"persisting",totalCards:0,completedCards:0}})),e().addProgress("Persisting cleaned dataset for offline reuse");const D=await oz({datasetId:A,rows:m.data,columns:E,provenance:{fileName:r.name,bytes:r.size,checksum:A,cleanedAt:new Date().toISOString()}});Lk(A),e().addProgress(`Cached ${D.rowCount} rows in ${D.chunkCount} chunks.`),t(O=>({analysisTimeline:{...O.analysisTimeline,stage:"profiling"}})),await Promise.all([u(A),d(A)])}catch(C){console.error("Failed to persist cleaned dataset:",C),e().addProgress("IndexedDB cache failedrefreshing may lose progress.","error"),t(D=>({analysisTimeline:{...D.analysisTimeline,stage:"idle"}}))}};e().updateBusyStatus("Parsing CSV file...");const p=await CL(r);if(e().addProgress(`Parsed ${p.data.length} rows.`),e().isRunCancellationRequested(a)){e().addProgress("Upload cancelled before analysis.");return}t({initialDataSample:p.data.slice(0,20)});let m=p,y,w=null,x=[];if(e().isApiKeySet){e().updateBusyStatus("Initializing AI memory..."),await wt.init(e().addProgress),e().addProgress("AI is analyzing data for cleaning and reshaping...");const A=$u(m.data);e().updateBusyStatus("Drafting data preparation plan...");const E=(o=e().createAbortController(a))==null?void 0:o.signal;if(w=await Y5(A,m.data.slice(0,20),e().settings,{signal:E,onUsage:T=>{e().recordLlmUsage({provider:T.provider,model:T.model,promptTokens:T.promptTokens,completionTokens:T.completionTokens,totalTokens:T.totalTokens,context:T.operation??"data_prep.plan"})}}),e().isRunCancellationRequested(a)){e().addProgress("Upload cancelled during preparation.");return}const C=typeof(w==null?void 0:w.jsFunctionBody)=="string"?w.jsFunctionBody.trim():null;if(w&&C){e().addProgress(`AI Plan: ${w.explanation}`),e().addProgress("Executing AI data transformation...");try{const T=FR(m.data,w.jsFunctionBody);m.data=T.data;const{rowsBefore:I,rowsAfter:M,removedRows:N,addedRows:P,modifiedRows:k}=T.meta,$=[`${I}  ${M} rows`];N&&$.push(`${N} removed`),P&&$.push(`${P} added`),k&&$.push(`${k} modified`),e().addProgress(`Transformation complete (${$.join(", ")}).`),x=FK(w,T.meta,A,w.outputColumns)}catch(T){const I=T instanceof Error?T.message:String(T);throw e().addProgress(`Data transformation failed: ${I}`,"error"),T}}else w&&e().addProgress(`AI Plan: ${w.explanation}`),e().addProgress("AI found no necessary data transformations.");if(y=w.outputColumns,m.data.length===0)throw new Error("Dataset empty after transformation.");const D=Hu(y.map(T=>T.name)),O=ep(m);if(!O)throw new Error(" fingerprint");await c(O,y);try{await nC(O,x)}catch(T){console.warn("Failed to persist preparation log entries:",T)}t({csvData:m,columnProfiles:y,columnAliasMap:D,datasetHash:O,datasetRuntimeConfig:null,dataPreparationPlan:w,currentView:"analysis_dashboard"}),await e().handleInitialAnalysis(m,{runId:a})}else{e().addProgress("API Key not set. Please add it in the settings.","error"),e().setIsSettingsModalOpen(!0),y=$u(m.data);const A=Hu(y.map(C=>C.name)),E=ep(m);if(!E)throw new Error("");await c(E,y);try{await nC(E,[])}catch(C){console.warn("Failed to clear preparation log for dataset:",C)}t({csvData:m,columnProfiles:y,columnAliasMap:A,datasetHash:E,datasetRuntimeConfig:null,currentView:"analysis_dashboard"})}}catch(u){if(!e().isRunCancellationRequested(a)){console.error("File processing error:",u);const d=u instanceof Error?u.message:String(u);e().addProgress(`File Processing Error: ${d}`,"error"),t({currentView:"file_upload"})}}finally{e().endBusy(a)}},handleNewSession:async()=>{if(e().csvData){const r=await Gu(Ma);if(r){const s=`report-${r.createdAt.getTime()}`;try{await $_({...r,id:s,updatedAt:new Date})}catch(a){console.error("Failed to archive session before starting new one:",a)}}}wt.clear(),await U_(Ma),n.resetAutoSaveSession(),LK(),t({...n.initialAppState,busyRunId:null,isCancellationRequested:!1,aiFilterRunId:null,abortControllers:{},toasts:[],chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1}),await e().loadReportsList()}}),qK=(t,e,n)=>({handleNaturalLanguageQuery:async r=>{var u;if(!e().isApiKeySet||!e().csvData){e().addProgress("Cannot perform AI query: API Key is not set or no data is loaded.","error");return}const s=e().aiFilterRunId;s&&e().abortRunControllers(s);const a=n.createRunId();t({isAiFiltering:!0,aiFilterRunId:a,spreadsheetFilterFunction:null,aiFilterExplanation:null}),e().addProgress(`AI is processing your data query: "${r}"...`);const o=(u=e().createAbortController(a))==null?void 0:u.signal;try{const d=await _G(r,e().columnProfiles,e().csvData.data.slice(0,5),e().settings,{signal:o,onUsage:c=>{e().recordLlmUsage({provider:c.provider,model:c.model,promptTokens:c.promptTokens,completionTokens:c.completionTokens,totalTokens:c.totalTokens,context:c.operation??"filter.generate"})}});t({spreadsheetFilterFunction:d.jsFunctionBody,aiFilterExplanation:d.explanation}),e().addProgress(`AI filter applied: ${d.explanation}`),e().addToast("AI filter applied successfully.","success")}catch(d){if(d instanceof DOMException&&d.name==="AbortError")e().addProgress("AI filter request cancelled."),e().addToast("AI filter cancelled.","info");else{const c=d instanceof Error?d.message:String(d);e().addProgress(`AI query failed: ${c}`,"error"),e().addToast(`AI filter failed: ${c}`,"error")}}finally{e().clearRunControllers(a),t(d=>d.aiFilterRunId===a?{isAiFiltering:!1,aiFilterRunId:null}:{})}},clearAiFilter:()=>{const r=e().aiFilterRunId;r&&e().abortRunControllers(r);const s=!!e().spreadsheetFilterFunction;if(t({spreadsheetFilterFunction:null,aiFilterExplanation:null,aiFilterRunId:null,isAiFiltering:!1}),s){const a={sender:"ai",text:"System note: Raw Data Explorer AI filter was cleared, so the table now shows all rows.",timestamp:new Date,type:"ai_message"};t(o=>({chatHistory:[...o.chatHistory,a]}))}e().addProgress("AI data filter cleared."),e().addToast("AI filter cleared.","info")},cancelAiFilterRequest:()=>{const{aiFilterRunId:r,isAiFiltering:s}=e();!r||!s||(e().abortRunControllers(r),t({isAiFiltering:!1,aiFilterRunId:null}),e().addProgress("AI data filter cancelled."),e().addToast("AI filter cancelled.","info"))}}),$k=5e3,cR=6e4;class GK{constructor(e){this.deps=e,this.timer=null,this.inFlight=!1,this.failureToastId=null,this.config={enabled:!0,intervalMs:15e3},this.backoffMs=0,this.lastCreatedAt=null}configure(e){const n={enabled:e.enabled,intervalMs:Math.max($k,e.intervalMs)};if(this.config=n,!e.enabled){this.stop(),this.clearFailureToast();return}this.restart()}triggerImmediateSave(e=!1){!this.config.enabled&&!e||this.schedule(0,e)}resetSessionMetadata(){this.lastCreatedAt=null}seedCreatedAt(e){this.lastCreatedAt=e}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)}restart(){this.stop(),this.schedule(this.config.intervalMs)}schedule(e,n=!1){this.stop(),this.timer=setTimeout(()=>{this.performSave(n).finally(()=>{if(this.config.enabled){const r=this.config.intervalMs+this.backoffMs;this.schedule(r)}})},Math.max(0,e))}async performSave(e=!1){var r;if(this.inFlight||!this.config.enabled&&!e)return;const n=this.deps.getStore();if(this.shouldSave(n)){this.inFlight=!0;try{const s=this.deps.buildSnapshot(n),a=await this.ensureCreatedAt(),o={id:Ma,filename:((r=n.csvData)==null?void 0:r.fileName)||"Current Session",createdAt:a,updatedAt:new Date,appState:s};await $_(o),this.backoffMs=0,this.clearFailureToast()}catch(s){console.error("Auto-save failed:",s),this.backoffMs=this.backoffMs===0?Math.min(this.config.intervalMs,cR):Math.min(this.backoffMs*2,cR),this.showFailureToast()}finally{this.inFlight=!1}}}async ensureCreatedAt(){if(this.lastCreatedAt)return this.lastCreatedAt;const e=await Gu(Ma);return this.lastCreatedAt=(e==null?void 0:e.createdAt)??new Date,this.lastCreatedAt}shouldSave(e){return!!(e.csvData&&e.csvData.data.length>0)}showFailureToast(){this.failureToastId||(this.failureToastId=this.deps.addToast("Auto-save failed. Click to retry now.","error",0,{label:"Retry now",onClick:()=>this.triggerImmediateSave(!0)}))}clearFailureToast(){this.failureToastId&&(this.deps.dismissToast(this.failureToastId),this.failureToastId=null)}}const HK=t=>({enabled:t.autoSaveEnabled,intervalMs:Math.max($k,t.autoSaveIntervalSeconds*1e3)}),Uk=t=>{if(!t||typeof t!="object")return!1;const e=t;return typeof e.type=="string"&&e.type.startsWith("graph/")};let zy=null;const zK=async()=>typeof window>"u"?null:(zy||(zy=np(()=>import("./agent_csv_runner-XkVOEHuQ.js"),[]).then(t=>t.default)),zy);class jK{constructor(){this.worker=null,this.listeners=new Set,this.pendingMessages=[],this.isReady=!1,this.isBooting=!1,this.handleWorkerMessage=e=>{Uk(e.data)&&(e.data.type==="graph/ready"&&!this.isReady&&(this.isReady=!0,this.flushQueue()),this.listeners.forEach(n=>n(e.data)))},this.handleWorkerError=e=>{const n={type:"graph/error",message:e.message||"Graph worker error",timestamp:Date.now()};this.listeners.forEach(r=>r(n)),this.isReady=!1},this.isSupported=typeof window<"u"&&typeof Worker<"u"}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}ensureWorker(){!this.isSupported||this.worker||this.isBooting||(this.isBooting=!0,zK().then(e=>{!e||this.worker||(this.worker=new Worker(e,{name:"csv-agent-graph-worker",type:"module"}),this.worker.addEventListener("message",this.handleWorkerMessage),this.worker.addEventListener("error",this.handleWorkerError))}).catch(e=>{console.error("Failed to initialize graph worker:",e),this.handleWorkerError(new ErrorEvent("error",{message:(e==null?void 0:e.message)??String(e)}))}).finally(()=>{this.isBooting=!1}))}post(e){if(this.isSupported){if(this.ensureWorker(),!this.worker){this.pendingMessages.push(e);return}if(e.type==="graph/init"||this.isReady){this.worker.postMessage(e);return}this.pendingMessages.push(e)}}flushQueue(){if(!(!this.worker||!this.isReady||this.pendingMessages.length===0))for(;this.pendingMessages.length>0;){const e=this.pendingMessages.shift();e&&this.worker.postMessage(e)}}}const VK=new jK;let jy=null;const JK=async()=>typeof window>"u"?null:(jy||(jy=np(()=>import("./agent_csv_worker-Dm1523IG.js"),[]).then(t=>t.default)),jy);class YK{constructor(){this.worker=null,this.listeners=new Set,this.pendingMessages=[],this.isReady=!1,this.isBooting=!1,this.handleWorkerMessage=e=>{Uk(e.data)&&(e.data.type==="graph/ready"&&!this.isReady&&(this.isReady=!0,this.flushQueue()),this.listeners.forEach(n=>n(e.data)))},this.handleWorkerError=e=>{const n={type:"graph/error",message:e.message||"LangGraph worker error",timestamp:Date.now()};this.listeners.forEach(r=>r(n)),this.isReady=!1},this.isSupported=typeof window<"u"&&typeof Worker<"u"}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}async ensureWorker(){if(!(!this.isSupported||this.worker||this.isBooting)){this.isBooting=!0;try{const e=await JK();if(!e||this.worker)return;this.worker=new Worker(e,{name:"csv-agent-langgraph-worker",type:"module"}),this.worker.addEventListener("message",this.handleWorkerMessage),this.worker.addEventListener("error",this.handleWorkerError)}catch(e){console.error("Failed to initialize LangGraph worker:",e),this.handleWorkerError(new ErrorEvent("error",{message:(e==null?void 0:e.message)??String(e)}))}finally{this.isBooting=!1}}}post(e){if(this.isSupported){if(this.ensureWorker(),!this.worker){this.pendingMessages.push(e);return}if(e.type==="graph/init"||this.isReady){this.worker.postMessage(e);return}this.pendingMessages.push(e)}}flushQueue(){if(!(!this.worker||!this.isReady||this.pendingMessages.length===0))for(;this.pendingMessages.length>0;){const e=this.pendingMessages.shift();e&&this.worker.postMessage(e)}}}const KK=new YK,WK={clean_month:{toolCall:{kind:"normalize_invoice_month",params:{column:"InvoiceMonth"}},stepId:"normalize-invoice-month",stepLabel:" InvoiceMonth ",stepIntent:"data_cleaning",planGoal:"",planProgress:" InvoiceMonth ",reason:" InvoiceMonth ",text:" InvoiceMonth YYYY-MM",intentContract:P_({intent:"clean",tool:"csv.clean_invoice_month",args:{column:"InvoiceMonth"}})},outlier:{toolCall:{kind:"detect_outliers",params:{valueColumn:"Amount",multiplier:3}},stepId:"detect-amount-outliers",stepLabel:"",stepIntent:"data_validation",planGoal:"",planProgress:" Amount ",reason:"",text:" Amount ",intentContract:P_({intent:"detect_anomaly",tool:"csv.detect_outliers",args:{valueColumn:"Amount",thresholdMultiplier:3}})}},ZK=t=>t?WK[t]:void 0,XK=t=>!!ZK(t),QK=t=>({source:t.source,planId:t.planId,stepId:t.stepId,summary:t.summary,plan:t.plan,planState:t.planState,telemetry:t.telemetry}),lf={[Yt.FULL_SCAN_BLOCKED]:{title:"Full scan needs confirmation",detail:"Please ask the user before scanning every cached row."},[Yt.AGG_TIMEOUT]:{title:"Full scan timed out",detail:"The analysis fell back to a sampled preview. Retry or limit the scope."},[Yt.COLUMN_METADATA_MISSING]:{title:"Dataset cache incomplete",detail:"The cached schema is missing. Re-upload or rebuild the dataset to continue."},[Yt.VERSION_ERROR]:{title:"Browser storage mismatch",detail:"Local IndexedDB version changed. Refresh or clear site data, then retry."},[Yt.ORIGIN_BLOCKED]:{title:"Source not allowed",detail:"The embedding origin is not on the allow list for CSV hand-off."},[Yt.DATASET_UNCHANGED]:{title:"Dataset unchanged",detail:"This CSV matches the cached dataset. You can skip the import or force a refresh."},[Yt.INDEXEDDB_UNAVAILABLE]:{title:"Browser blocked storage access",detail:"IndexedDB is unavailable in this context. Enable storage permissions and retry."},[Yt.UNKNOWN]:{title:"Action failed",detail:"The agent could not finish this step. Try again or adjust your request."}},eW=(t,e)=>t&&lf[t]?lf[t]:e?{title:lf[Yt.UNKNOWN].title,detail:e}:lf[Yt.UNKNOWN],tW=[{provider:"openai",pattern:/gpt-4o-mini/i,tier:{promptPerMillion:.15,completionPerMillion:.6}},{provider:"openai",pattern:/gpt-4o-?mini-?audio/i,tier:{promptPerMillion:.3,completionPerMillion:1.2}},{provider:"openai",pattern:/gpt-4o/i,tier:{promptPerMillion:5,completionPerMillion:15}},{provider:"openai",pattern:/gpt-4-turbo/i,tier:{promptPerMillion:10,completionPerMillion:30}},{provider:"openai",pattern:/gpt-3\.5-turbo/i,tier:{promptPerMillion:.5,completionPerMillion:1.5}},{provider:"gemini",pattern:/gemini-1\.5-pro/i,tier:{promptPerMillion:7,completionPerMillion:21}},{provider:"gemini",pattern:/gemini-1\.5-flash/i,tier:{promptPerMillion:.35,completionPerMillion:1.05}},{provider:"gemini",pattern:/gemini-1\.(0|1)-pro/i,tier:{promptPerMillion:3.5,completionPerMillion:10.5}}],nW={openai:{promptPerMillion:5,completionPerMillion:15},gemini:{promptPerMillion:3.5,completionPerMillion:10.5}},rW=(t,e)=>{const n=tW.find(r=>r.provider===t&&r.pattern.test(e));return(n==null?void 0:n.tier)??nW[t]},sW=t=>{if(t.promptTokens==null&&t.completionTokens==null)return null;const e=rW(t.provider,t.model);if(!e)return null;const n=t.promptTokens??0,r=t.completionTokens??0,s=n/1e6*e.promptPerMillion,a=r/1e6*e.completionPerMillion,o=s+a;return!Number.isFinite(o)||o===0?null:Number(o.toFixed(6))},aW=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`clar-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,iW=()=>`plan-warning-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,Vy=()=>`run-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,oW=()=>`toast-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,lW=()=>`val-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,Wo=[100,300,1e3,null],uW=t=>t===null?" (Full dataset)":`${t.toLocaleString()} `,dR=t=>{if(!t)return 0;if(t.mode==="full"||t.allowFullScan)return Wo.length-1;const e=t.sampleSize??Wo[0]??100;let n=0;return Wo.forEach((r,s)=>{r!==null&&e>=r&&(n=s)}),n},fR=(t,e,n)=>{if(!t)return null;if(e===null)return H_(t,{mode:"full",allowFullScan:!0});const r=n?Math.min(e,n):e;return H_(t,{mode:"sample",allowFullScan:!1,sampleSize:r,profileSampleSize:r})};let Yn=null,tp=null,Jy=!1,Yy=null,Ky=!1,ks=null;const Fk=t=>{tp=HK(t),Yn==null||Yn.configure(tp)},cW=()=>{Yn==null||Yn.resetSessionMetadata()},pR=t=>{Yn==null||Yn.seedCreatedAt(t)},hR=()=>{Yn==null||Yn.triggerImmediateSave(!0)},Wy=(t,e)=>eW(t,e).detail,dW=(t,e,n,r)=>({id:`obs-tool-${t}-${Date.now().toString(36)}`,actionId:t,responseType:"execute_js_code",status:"success",timestamp:new Date().toISOString(),outputs:{summary:e,meta:n,payload:r}}),fW=(t,e,n,r)=>({id:`obs-tool-${t}-err-${Date.now().toString(36)}`,actionId:t,responseType:"execute_js_code",status:"error",timestamp:new Date().toISOString(),outputs:{summary:e,...n??{}},errorCode:r??Yt.UNKNOWN}),mR=t=>typeof window>"u"?!0:window.confirm(`${t} 
`),Zy=6,pW=12,gR=2,hW=10,Bk=()=>({lastIndexedMessage:0,rawChunks:[],summaryChunks:[]}),mW=t=>({...t,id:`llm-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,timestamp:new Date().toISOString()}),gW=t=>{const e=[];return typeof t.promptTokens=="number"&&e.push(`in ${t.promptTokens}`),typeof t.completionTokens=="number"&&e.push(`out ${t.completionTokens}`),typeof t.totalTokens=="number"&&e.push(`total ${t.totalTokens}`),e.length>0?`tokens ${e.join(" / ")}`:"tokens n/a"},yW=t=>{const e=t.estimatedCostUsd!=null?`$${t.estimatedCostUsd.toFixed(4)}`:"cost n/a";return`${t.context}: ${t.provider}/${t.model}  ${gW(t)}, ${e}`},wi=(t,e)=>({provider:t.provider,model:t.model,promptTokens:t.promptTokens,completionTokens:t.completionTokens,totalTokens:t.totalTokens,context:t.operation??e}),_W=t=>{const e=t.timestamp instanceof Date&&!Number.isNaN(t.timestamp.getTime())?t.timestamp:new Date(t.timestamp),n=t.sender==="ai"?"AI":"User";return`[${Number.isNaN(e.getTime())?"Unknown time":e.toLocaleString(void 0,{hour12:!1})}] ${n}: ${t.text}`},vW=(t,e=0)=>t.map((n,r)=>`${e+r+1}. ${_W(n)}`).join(`
`),f0={langchain_plan:"LangChain Plan",aggregate_plan:"Plan Preview",profile_dataset:"Dataset Profile",normalize_invoice_month:"Invoice Month Cleanup",detect_outliers:"Outlier Detection",tool_result:"Tool Result"},wW=t=>{const e=t.payload??{},r=[`[Observation] ${f0[t.kind]??t.kind}`];typeof e.summary=="string"?r.push(e.summary):typeof e.description=="string"&&r.push(e.description);const s=e.meta??{};typeof s.rows=="number"&&r.push(`${s.rows} `),typeof s.source=="string"&&r.push(s.source==="full"?"":"");const a=e.telemetry??s.telemetry;if(a){const o=a.tokenUsage;if(o){const u=[];o.promptTokens!=null&&u.push(`in ${o.promptTokens}`),o.completionTokens!=null&&u.push(`out ${o.completionTokens}`),o.totalTokens!=null&&u.push(`total ${o.totalTokens}`),u.length&&r.push(`Tok ${u.join(" / ")}`)}a.estimatedCostUsd!=null?r.push(`$${a.estimatedCostUsd.toFixed(4)}`):a.latencyMs!=null&&r.push(`${Math.round(a.latencyMs)} ms`)}else typeof s.durationMs=="number"&&r.push(`${Math.round(s.durationMs)} ms`);return r.join("  ")},bW=t=>{if(!t)return"latency n/a, tokens n/a, cost n/a";const e=`${Math.round(t.latencyMs)} ms`,n=t.tokenUsage;let r="tokens n/a";if(n){const a=n.promptTokens,o=n.completionTokens,u=n.totalTokens??(a!=null||o!=null?(a??0)+(o??0):void 0);a!=null||o!=null?r=`tokens ${a??"?"} in / ${o??"?"} out${u!=null?` (${u} total)`:""}`:u!=null&&(r=`tokens ${u}`)}const s=t.estimatedCostUsd!=null?`$${t.estimatedCostUsd.toFixed(4)}`:"cost n/a";return`${e}, ${r}, cost ${s}`},SW=(t,e,n)=>!t.langChainPlannerEnabled||!t.isApiKeySet||XK(e)||!t.datasetHash||!t.csvData||t.csvData.data.length===0||!t.columnProfiles.length?!1:!!(e||n&&n.length>0),xW=async t=>{if(!t.datasetHash||!t.csvData)throw new Error("Dataset unavailable for LangChain planner.");const{generateLangChainPlanEnvelope:e}=await np(async()=>{const{generateLangChainPlanEnvelope:n}=await import("./agent_csv_planBridge-DdMBp1-m.js");return{generateLangChainPlanEnvelope:n}},[]);return e({datasetId:t.datasetHash,columns:t.columnProfiles,rows:t.csvData.data,settings:t.settings,addProgress:t.addProgress})},TW=new Set(["numerical","currency","percentage"]),AW=new Set(["categorical","date","time"]),EW=t=>t.filter(e=>TW.has(e.type)).sort((e,n)=>{const r=e.numericSampleCount??e.nonNullCount??0;return(n.numericSampleCount??n.nonNullCount??0)-r})[0]??null,CW=(t,e)=>{var p;const n=fv(t.filter(m=>AW.has(m.type)),e);if(n.length===0)return null;const r=n.find(m=>{const y=m.uniqueValues??0;return y>=4&&y<=40})??n[0],s=(p=r==null?void 0:r.profile)==null?void 0:p.name;if(!s)return null;const a=EW(t),o=(a==null?void 0:a.name)??null,u=o?`Top ${s} by ${o}`:`Top ${s} by count`,d=o?`Summarize the largest ${s} values using ${o}.`:`Show the most frequent ${s} categories.`;return{chartType:"bar",title:u,description:d,aggregation:o?"sum":"count",groupByColumn:s,valueColumn:o??void 0,defaultTopN:8,defaultHideOthers:!0,limit:8,orderBy:[{column:o??"count",direction:"desc"}]}},IW=t=>{var e;return((e=t.find(n=>n.status==="pending"))==null?void 0:e.id)??null},yR=6,RW=(t,e,n)=>{if(e.promptId){const a=t.findIndex(o=>o.promptId===e.promptId);if(a>=0){const o=[...t];return o[a]={...o[a],question:e.question,optionsSnapshot:e.options,allowFreeText:e.allowFreeText,placeholder:e.placeholder,status:o[a].status==="answered"?"answered":"waiting"},o}}const r={promptId:e.promptId??null,question:e.question,optionsSnapshot:e.options,allowFreeText:e.allowFreeText,placeholder:e.placeholder,askedAt:n,status:"waiting"},s=[...t,r];return s.length>yR?s.slice(-yR):s},NW=(t,e,n,r)=>{if(!t.length)return t;let s=-1;if(e&&(s=t.findIndex(o=>o.promptId===e)),s===-1){for(let o=t.length-1;o>=0;o-=1)if(t[o].status==="waiting"){s=o;break}}if(s===-1)return t;const a=[...t];return a[s]={...a[s],status:"answered",respondedAt:n,responseLabel:r.label??r.value??null,responseValue:r.value,responseType:r.type},a},PW=t=>{postGraphClientEvent({type:"graph/tool_result",verification:t,timestamp:Date.now()})&&postGraphClientEvent({type:"graph/runPipeline",payload:{reason:"verification"},timestamp:Date.now()})},MW=t=>{var e,n;switch(t.kind){case"profile_dataset":return"";case"normalize_invoice_month":return` ${typeof((e=t.params)==null?void 0:e.column)=="string"?t.params.column:"InvoiceMonth"}`;case"detect_outliers":return` ${typeof((n=t.params)==null?void 0:n.valueColumn)=="string"?t.params.valueColumn:"Amount"} `;case"aggregate_plan":default:return""}},_R=t=>(t??[]).map(e=>({id:typeof(e==null?void 0:e.id)=="string"?e.id.trim():"",label:typeof(e==null?void 0:e.label)=="string"?e.label.trim():"",intent:typeof(e==null?void 0:e.intent)=="string"&&e.intent.trim()||void 0,status:typeof(e==null?void 0:e.status)=="string"?e.status:void 0})).filter(e=>e.id.length>=3&&e.label.length>=3),kW=t=>{if(!t)return"report";const e=t.split(/\r?\n/).map(r=>r.trim()).find(Boolean);return e&&e.replace(/[^a-z0-9-_]+/gi,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"report"},OW=t=>({currentView:t.currentView,isBusy:t.isBusy,busyMessage:t.busyMessage,canCancelBusy:t.canCancelBusy,progressMessages:t.progressMessages,csvData:t.csvData,columnProfiles:t.columnProfiles,analysisCards:t.analysisCards,chatHistory:t.chatHistory,finalSummary:t.finalSummary,aiCoreAnalysisSummary:t.aiCoreAnalysisSummary,dataPreparationPlan:t.dataPreparationPlan,initialDataSample:t.initialDataSample,datasetHash:t.datasetHash,vectorStoreDocuments:wt.getDocuments(),conversationMemoryState:t.conversationMemoryState,spreadsheetFilterFunction:t.spreadsheetFilterFunction,aiFilterExplanation:t.aiFilterExplanation,datasetProfile:t.datasetProfile,pendingClarifications:t.pendingClarifications,activeClarificationId:t.activeClarificationId,toasts:[],agentActionTraces:t.agentActionTraces,agentValidationEvents:t.agentValidationEvents,columnAliasMap:t.columnAliasMap,pendingDataTransform:t.pendingDataTransform,lastAppliedDataTransform:t.lastAppliedDataTransform,isLastAppliedDataTransformBannerDismissed:t.isLastAppliedDataTransformBannerDismissed,interactiveSelectionFilter:t.interactiveSelectionFilter,plannerSession:t.plannerSession,agentPhase:t.agentPhase,plannerPendingSteps:t.plannerPendingSteps,agentPromptMetrics:t.agentPromptMetrics,plannerDatasetHash:t.plannerDatasetHash,agentAwaitingUserInput:t.agentAwaitingUserInput,agentAwaitingPromptId:t.agentAwaitingPromptId,graphToolInFlight:t.graphToolInFlight,analysisTimeline:t.analysisTimeline,langChainLastPlan:t.langChainLastPlan,langChainPlannerEnabled:t.langChainPlannerEnabled,useLangGraphRuntime:t.useLangGraphRuntime,llmUsageLog:t.llmUsageLog,graphObservations:t.graphObservations,graphPhase:t.graphPhase,graphLoopBudget:t.graphLoopBudget}),DW=t=>{const e=new Date().toISOString().replace(/[:.]/g,"-");return`${kW(t)}-${e}.csv`},vR=async(t,e,n,r,s,a,o)=>{if(!t||t.length===0)return;let u=null;try{if(!(!!e&&!!n&&e===n)){wt.clear(),r("Skipped AI memory restore because the dataset changed since last session."),s("AI memory reset for this dataset.","info",5e3);return}if(!wt.getIsInitialized()&&(u=s("Preparing AI memory from history...","info",0),await wt.init(r)),!wt.getIsInitialized()){r("AI memory model failed to load; saved chat context is unavailable right now.","error"),u&&a(u);return}u&&a(u),wt.rehydrate(t),r(o),s("AI memory ready for this report.","success")}catch(d){u&&a(u),console.error("Failed to restore AI memory from saved session:",d),r("Restoring AI memory failed; chat recall may be incomplete this session.","error"),s("AI memory failed to load. Try reloading or re-importing the file.","error",6e3)}},Xy=320,LW=800,$W=600,UW=12,wR=(t=[])=>Hu(t.map(e=>e.name)),FW=(t,e,n)=>{const r=Math.min(t,60)/60,s=Math.max(.4,1-e*.15),a=n?.9:1;return Number(((.5+r*.5)*s*a).toFixed(3))},BW=t=>{const e=["auto-memory"];return t.chartType&&e.push(`chart:${t.chartType}`),t.groupByColumn&&e.push(`group:${t.groupByColumn}`),t.valueColumn&&e.push(`value:${t.valueColumn}`),t.aggregation&&e.push(`agg:${t.aggregation}`),e},p0=t=>({observations:(t==null?void 0:t.observations)??[],planState:(t==null?void 0:t.planState)??null}),qW=(t,e)=>t.length!==e.length?!1:t.every((n,r)=>n===e[r]),GW=t=>{switch(t.chartType){case"line":return"trend";case"bar":case"pie":case"doughnut":case"combo":return"topn";default:return"kpi"}},HW=t=>{const e=t.dataRef.planSnapshot??{},n=e.chartType??"bar",r={chartType:n,title:e.title??t.title,description:e.description??t.explainer??"",aggregation:e.aggregation,groupByColumn:e.groupByColumn,valueColumn:e.valueColumn,xValueColumn:e.xValueColumn,yValueColumn:e.yValueColumn,secondaryValueColumn:e.secondaryValueColumn,secondaryAggregation:e.secondaryAggregation,defaultTopN:e.defaultTopN,defaultHideOthers:e.defaultHideOthers,rowFilter:e.rowFilter,orderBy:e.orderBy,limit:e.limit??null};return{id:t.id,plan:r,aggregatedData:t.dataRef.rows,summary:t.explainer,displayChartType:n,isDataVisible:!1,topN:e.defaultTopN??null,hideOthers:e.defaultHideOthers??!1,disableAnimation:!0,hiddenLabels:[],dataRefId:t.id,queryHash:t.queryHash,isSampledResult:t.dataRef.sampled,aggregationMeta:{mode:t.dataRef.sampled?"sample":"full",sampled:t.dataRef.sampled,processedRows:t.dataRef.rows.length,totalRows:t.dataRef.rows.length,warnings:[],lastRunAt:t.createdAt??new Date().toISOString(),requestedMode:t.dataRef.sampled?"sample":"full"},valueSchema:t.dataRef.schema}},hu={currentView:"file_upload",isBusy:!1,busyMessage:null,canCancelBusy:!1,progressMessages:[],csvData:null,columnProfiles:[],analysisCards:[],chatHistory:[],finalSummary:null,aiCoreAnalysisSummary:null,dataPreparationPlan:null,initialDataSample:null,datasetHash:null,datasetRuntimeConfig:null,vectorStoreDocuments:[],conversationMemoryState:Bk(),spreadsheetFilterFunction:null,aiFilterExplanation:null,datasetProfile:null,pendingClarifications:[],activeClarificationId:null,toasts:[],agentActionTraces:[],agentValidationEvents:[],columnAliasMap:{},pendingDataTransform:null,lastAppliedDataTransform:null,isLastAppliedDataTransformBannerDismissed:!1,interactiveSelectionFilter:null,plannerSession:p0(),agentPhase:{phase:"idle",message:null,enteredAt:null},plannerPendingSteps:[],agentPromptMetrics:[],plannerDatasetHash:null,agentAwaitingUserInput:!1,agentAwaitingPromptId:null,analysisTimeline:{stage:"idle",totalCards:0,completedCards:0},aggregationModePreference:"full",graphStatus:"idle",graphStatusMessage:null,graphVersion:null,graphLastReadyAt:null,graphAwaitPrompt:null,graphAwaitPromptId:null,graphAwaitReason:null,graphAwaitHistory:[],graphSessionId:null,graphLastToolSummary:null,graphToolInFlight:null,langChainLastPlan:null,langChainPlannerEnabled:!0,useLangGraphRuntime:!0,llmUsageLog:[],graphObservations:[],graphPhase:"idle",graphLoopBudget:{maxActs:3,actsUsed:0,exceeded:!1},samplePolicy:{tiers:Wo,currentIndex:0,userConfirmedFullScan:!1,lastUpgradeReason:null},planValidationNotices:[],activeSchemaPhase:"plan"},tt=ZL((t,e)=>{const n=T=>{const I=T.reasonHint??"Need your choice before I can keep the plan moving.",M={...T,reasonHint:I,id:aW(),status:"pending",contextType:T.contextType??"plan"};return t(N=>({pendingClarifications:[...N.pendingClarifications,M],activeClarificationId:M.id})),M},r=()=>e().useLangGraphRuntime?KK:VK,s=T=>{const I=r();return I.isSupported?(I.post(T),!0):!1},a=(T,I)=>{e().pendingClarifications.some(N=>N.id===T)&&t(N=>{const P=N.pendingClarifications.map($=>$.id===T?{...$,status:I}:$),k=I==="pending"||I==="resolving"?T:IW(P);return{pendingClarifications:P,activeClarificationId:k}})},o=(T,I)=>{if(!I||I.length===0)return;const M=e().recordLlmUsage;I.forEach(N=>{M(wi(N,`${T}.${N.label}`))})},u=T=>{const I={kind:T.kind,label:MW(T),startedAt:new Date().toISOString()};t({graphToolInFlight:I})},d=()=>{t({graphToolInFlight:null})},c=(T,I)=>{const M=T.viewId?{...T.payload,viewId:T.viewId}:T.payload,N=(I==null?void 0:I.description)??f0[M.kind]??M.kind;t({graphLastToolSummary:T.summary}),e().addProgress(T.summary),PW({description:N,summary:T.summary,meta:T.meta,payload:M}),e().appendPlannerObservation(dW(M.kind,T.summary,T.meta,M))},p=(T,I,M,N)=>{const P=Wy(I,M),k=`${f0[T]??T} failed${P}`,$={suggestion:N??P,detail:M??null};return t({graphLastToolSummary:k}),e().addProgress(k,"error"),e().appendPlannerObservation(fW(T,P,$,I)),k},m=async T=>{var I,M,N,P;if(!T)return!1;switch(T.kind){case"profile_dataset":{const k=e().datasetHash;if(!k)return e().addProgress("Graph profile request skipped","error"),!1;u(T);try{const $=typeof((I=T.params)==null?void 0:I.sampleSize)=="number"?T.params.sampleSize:e().getSampleSizeHint("profile"),U=await $s.profileDataset(k,$);return c(U,{description:"Dataset profile"}),!0}catch($){const U=$ instanceof Ur?$:null;return p("profile_dataset",U==null?void 0:U.code,(U==null?void 0:U.message)??($ instanceof Error?$.message:String($)),U==null?void 0:U.suggestion),!1}finally{d()}}case"normalize_invoice_month":{const k=e().csvData;if(!k)return e().addProgress("Graph normalize request skipped CSV ","error"),!1;const $=typeof((M=T.params)==null?void 0:M.column)=="string"?T.params.column:"InvoiceMonth";u(T);try{const U=$s.normalizeInvoiceMonth(k,$);return c(U,{description:`Normalize ${$}`}),!0}catch(U){const F=U instanceof Ur?U:null;return p("normalize_invoice_month",F==null?void 0:F.code,(F==null?void 0:F.message)??(U instanceof Error?U.message:String(U)),F==null?void 0:F.suggestion),!1}finally{d()}}case"detect_outliers":{const k=e().csvData;if(!k)return e().addProgress("Graph outlier request skipped CSV ","error"),!1;const $=typeof((N=T.params)==null?void 0:N.valueColumn)=="string"?T.params.valueColumn:null;if(!$)return e().addProgress("Graph outlier request failed valueColumn","error"),!1;const U=typeof((P=T.params)==null?void 0:P.multiplier)=="number"?T.params.multiplier:2;u(T);try{const F=$s.detectOutliers(k,$,U);return c(F,{description:`Detect outliers (${$})`}),!0}catch(F){const K=F instanceof Ur?F:null;return p("detect_outliers",K==null?void 0:K.code,(K==null?void 0:K.message)??(F instanceof Error?F.message:String(F)),K==null?void 0:K.suggestion),!1}finally{d()}}default:return!1}},y=T=>{var I;return T?(I=e().createAbortController(T))==null?void 0:I.signal:void 0},w=async(T,I,M)=>{if(M&&e().isRunCancellationRequested(M))return[];const N=T.title??"your requested chart",P={sender:"ai",text:`Okay, creating a chart for "${N}".`,timestamp:new Date,type:"ai_plan_start"};t($=>({chatHistory:[...$.chatHistory,P]}));const k=await e().runAnalysisPipeline([T],I,{isChatRequest:!0,runId:M});if(k.length>0){const $=k[0].summary.split("---")[0].trim(),U={sender:"ai",text:`Created the chart for "${N}". Here's what I observed:
${$}`,timestamp:new Date,type:"ai_message",cardId:k[0].id};t(F=>({chatHistory:[...F.chatHistory,U]}))}return k},x=async(T,I)=>{if(!T)return null;try{const M=await _v(T,{rowCountHint:I});return t(N=>{const P=dR(M),k={...N.samplePolicy,currentIndex:P,userConfirmedFullScan:M.mode==="full"||M.allowFullScan,lastUpgradeReason:null};return{datasetRuntimeConfig:M,aggregationModePreference:M.mode,samplePolicy:k}}),M}catch(M){return console.error("Failed to sync dataset runtime config:",M),null}},A=async(T,I,M)=>{try{const N=await cz(T,I,M);return t(P=>{const k=dR(N),$={...P.samplePolicy,currentIndex:k,userConfirmedFullScan:N.mode==="full"||N.allowFullScan};return{datasetRuntimeConfig:N,aggregationModePreference:N.mode,samplePolicy:$}}),N}catch(N){return console.error("Failed to update dataset runtime config:",N),null}},E=kK(t,e,{registerClarification:n,updateClarificationStatus:a,getRunSignal:y,runPlanWithChatLifecycle:w}),C=async T=>{var I;e().addProgress("Restoring cached dataset from IndexedDB");try{const[M,N,P,k]=await Promise.all([EP(T),mv(T),RP(T),lz(T)]);if(!P||P.length===0)return e().addProgress("Cached dataset was empty. Please re-upload your CSV.","error"),!1;const $={fileName:(M==null?void 0:M.fileName)??"cached.csv",data:P},U=(N==null?void 0:N.columns)??[],F=Hu(U.map(B=>B.name)),K=k.map(HW);t({...hu,csvData:$,columnProfiles:U,columnAliasMap:F,analysisCards:K,datasetHash:T,currentView:"analysis_dashboard",analysisTimeline:K.length?{stage:"insight",totalCards:K.length,completedCards:K.length}:{stage:"profiling",totalCards:0,completedCards:0},initialDataSample:P.slice(0,50)}),await x(T,(N==null?void 0:N.rowCount)??P.length),Lk(T);const j=(I=e().datasetRuntimeConfig)==null?void 0:I.profileSampleSize,V=await Ls.profile(T,j);return V.ok?e().applyDatasetProfileSnapshot(V.data):addProgress(`Profiling worker failed: ${V.reason}`,"error"),!0}catch(M){return console.error("Failed to restore cached dataset:",M),e().addProgress("Cached dataset restore failed. Please re-upload.","error"),!1}},D=BK(t,e,{initialAppState:hu,resetAutoSaveSession:cW}),O=qK(t,e,{createRunId:Vy});return{...hu,...E,...D,...O,busyRunId:null,isCancellationRequested:!1,aiFilterRunId:null,abortControllers:{},isAsideVisible:!0,asideWidth:window.innerWidth/4>Xy?window.innerWidth/4:Xy,isSpreadsheetVisible:!0,isDataPrepDebugVisible:!1,isSettingsModalOpen:!1,isHistoryPanelOpen:!1,isMemoryPanelOpen:!1,isAiFiltering:!1,settings:UE(),reportsList:[],isResizing:!1,isApiKeySet:(()=>{const T=UE();return T.provider==="google"?!!T.geminiApiKey:!!T.openAIApiKey})(),beginBusy:(T,I)=>{const M=Vy();return t({isBusy:!0,busyMessage:T,canCancelBusy:!!(I!=null&&I.cancellable),busyRunId:M,isCancellationRequested:!1}),M},updateBusyStatus:T=>{e().isBusy&&t({busyMessage:T})},endBusy:T=>{const I=e().busyRunId;if(T&&I&&I!==T)return;t({isBusy:!1,busyMessage:null,canCancelBusy:!1,busyRunId:null,isCancellationRequested:!1});const M=T??I;M&&e().clearRunControllers(M)},requestBusyCancel:()=>{if(!e().busyRunId||e().isCancellationRequested)return;t({isCancellationRequested:!0,canCancelBusy:!1,busyMessage:"Cancelling wrapping up safely."}),e().addProgress("Cancelling current request...");const T=e().busyRunId;T&&e().abortRunControllers(T)},isBusyRunActive:T=>e().busyRunId===T,isRunCancellationRequested:T=>e().isCancellationRequested&&e().busyRunId===T,createAbortController:T=>{if(!T)return null;const I=new AbortController;return t(M=>({abortControllers:{...M.abortControllers,[T]:[...M.abortControllers[T]??[],I]}})),I},abortRunControllers:T=>{t(I=>{const M=I.abortControllers[T];if(M==null||M.forEach(P=>{P.signal.aborted||P.abort()}),!M)return{};const N={...I.abortControllers};return delete N[T],{abortControllers:N}})},clearRunControllers:T=>{t(I=>{if(!I.abortControllers[T])return{};const M={...I.abortControllers};return delete M[T],{abortControllers:M}})},addToast:(T,I="info",M=4e3,N)=>{const P=oW();return t(k=>({toasts:[...k.toasts,{id:P,message:T,type:I,actionLabel:N==null?void 0:N.label,onAction:N==null?void 0:N.onClick}]})),M>0&&setTimeout(()=>{e().dismissToast(P)},M),P},dismissToast:T=>{t(I=>({toasts:I.toasts.filter(M=>M.id!==T)}))},queuePendingDataTransform:T=>{if(e().pendingDataTransform){e().addProgress("An AI data transformation is already awaiting approval. Please confirm or discard it first.","error");return}t({pendingDataTransform:T}),e().addProgress("AI proposed a data transformation. Review it above the dashboard before applying."),e().addToast("AI data change pending confirmation.","info",5e3)},confirmPendingDataTransform:async()=>{const T=e().pendingDataTransform;if(!T){e().addProgress("No pending data transformation to confirm.","error");return}const I=e().csvData,M=e().columnProfiles,N=e().columnAliasMap,P=ep(T.nextData);t({csvData:T.nextData,columnProfiles:T.nextColumnProfiles,columnAliasMap:T.nextAliasMap,datasetHash:P,datasetRuntimeConfig:null,pendingDataTransform:null,isLastAppliedDataTransformBannerDismissed:!1,lastAppliedDataTransform:{id:T.id,summary:T.summary,explanation:T.explanation,meta:T.meta,previousData:I,previousColumnProfiles:M,previousAliasMap:N,appliedAt:new Date().toISOString()}}),e().addProgress("Applied the AI data transformation after confirmation."),await x(P,T.nextData.data.length),await e().regenerateAnalyses(T.nextData);const k=G=>{if(!G||G.length===0)return"(none)";const Z=G.slice(0,8).join(", ");return G.length>8?`${Z}, `:Z},$=(G,Z)=>{if(G&&G.length>0)return G.map(le=>le.name);const se=Z==null?void 0:Z.find(le=>le&&typeof le=="object");return se?Object.keys(se):[]},U=T.beforeColumns??$(M,(I==null?void 0:I.data)??void 0),F=T.afterColumns??T.nextColumnProfiles.map(G=>G.name),K=U.filter(G=>!F.includes(G)),j=F.filter(G=>!U.includes(G)),V=[`Before (${U.length}): ${k(U)}`,`After (${F.length}): ${k(F)}`,K.length?`Removed: ${k(K)}`:null,j.length?`Added: ${k(j)}`:null].filter(Boolean).join(`
`),B={sender:"ai",text:`Applied transform "${T.summary}".
${V}`,timestamp:new Date,type:"ai_message"};t(G=>({chatHistory:[...G.chatHistory,B]}))},discardPendingDataTransform:()=>{if(!e().pendingDataTransform){e().addProgress("No pending data transformation to discard.","error");return}t({pendingDataTransform:null}),e().addProgress("Discarded the pending AI data transformation.")},undoLastDataTransform:async()=>{if(e().pendingDataTransform){e().addProgress("Resolve the pending AI transformation before undoing.","error");return}const T=e().lastAppliedDataTransform;if(!T||!T.previousData){e().addProgress("No AI data transformation is available to undo.","error");return}const I=ep(T.previousData);t({csvData:T.previousData,columnProfiles:T.previousColumnProfiles,columnAliasMap:T.previousAliasMap,datasetHash:I,datasetRuntimeConfig:null,lastAppliedDataTransform:null,isLastAppliedDataTransformBannerDismissed:!1}),e().addProgress("Reverted the last AI data transformation."),await x(I,T.previousData.data.length),await e().regenerateAnalyses(T.previousData)},dismissLastAppliedDataTransformBanner:()=>{e().lastAppliedDataTransform&&t({isLastAppliedDataTransformBannerDismissed:!0})},linkChartSelectionToRawData:(T,I,M,N)=>{const P=!!I&&M.length>0,k=e().interactiveSelectionFilter;if(!P){k&&k.sourceCardId===T&&t({interactiveSelectionFilter:null});return}const $=M.map(U=>typeof U=="number"?U:String(U));k&&k.sourceCardId===T&&k.column===I&&qW(k.values,$)||(t({interactiveSelectionFilter:{sourceCardId:T,column:I,values:$,label:N,createdAt:new Date().toISOString()},isSpreadsheetVisible:!0}),setTimeout(()=>{var U;(U=document.getElementById("raw-data-explorer"))==null||U.scrollIntoView({behavior:"smooth",block:"center"})},150))},clearInteractiveSelectionFilter:()=>{const T=e().interactiveSelectionFilter;if(!T)return;const I={sender:"ai",text:`System note: Cleared chart drilldown "${T.label}" (${T.column}); Raw Data Explorer now shows all rows.`,timestamp:new Date,type:"ai_message"};t(N=>({interactiveSelectionFilter:null,chatHistory:[...N.chatHistory,I]})),e().addProgress("Cleared the linked chart selection filter.");const M=e().beginAgentActionTrace("dom_action","User cleared chart drilldown","system");e().updateAgentActionTrace(M,"succeeded","Chart drilldown reset via UI",{metadata:{drilldownLabel:T.label,drilldownColumn:T.column,valueCount:T.values.length}})},init:async()=>{const T=await Gu(Ma);if(T){const I=T.appState.useLangGraphRuntime===!1;t({...hu,...T.appState,useLangGraphRuntime:!0,isBusy:!1,busyMessage:null,canCancelBusy:!1,busyRunId:null,isCancellationRequested:!1,aiFilterRunId:null,abortControllers:{},toasts:[],currentView:T.appState.csvData?"analysis_dashboard":"file_upload",pendingClarifications:T.appState.pendingClarifications??[],activeClarificationId:T.appState.activeClarificationId??null,agentActionTraces:T.appState.agentActionTraces??[],agentValidationEvents:T.appState.agentValidationEvents??[],chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1,columnAliasMap:T.appState.columnAliasMap??wR(T.appState.columnProfiles??[]),pendingDataTransform:null,lastAppliedDataTransform:null,interactiveSelectionFilter:null,plannerSession:p0(T.appState.plannerSession),plannerDatasetHash:T.appState.plannerDatasetHash??T.appState.datasetHash??null,datasetProfile:T.appState.datasetProfile??null,analysisTimeline:T.appState.analysisTimeline??{...hu.analysisTimeline},graphObservations:T.appState.graphObservations??[]}),await vR(T.appState.vectorStoreDocuments,T.appState.datasetHash,e().datasetHash,e().addProgress,e().addToast,e().dismissToast,"Restored AI long-term memory from last session."),pR(T.createdAt),I&&hR()}else{const I=$K();I&&await C(I)}await e().loadReportsList()},connectGraphRuntime:()=>{const T=e().useLangGraphRuntime?"langgraph":"legacy",I=T==="langgraph"?"LangGraph":"Graph";if(Jy&&Yy===T)return;ks==null||ks(),ks=null,Jy=!0,Yy=T;const M=r();if(!M.isSupported){t({graphStatus:"error",graphStatusMessage:` ${I} Web Workerruntime `});return}t({graphStatus:"connecting",graphStatusMessage:`Spinning up ${I} runtime`}),ks=M.subscribe(N=>{var P,k;switch(N.type){case"graph/ready":{const $=new Date(N.timestamp).toISOString();t({graphStatus:"ready",graphStatusMessage:`Graph Ready (v${N.version})`,graphVersion:N.version,graphLastReadyAt:$}),e().addProgress(`Graph runtime ready (v${N.version}).`);return}case"graph/log":e().addProgress(`Graph: ${N.message}`,N.level==="error"?"error":"system");return;case"graph/error":t({graphStatus:"error",graphStatusMessage:N.message}),e().addProgress(`Graph error: ${N.message}`,"error");return;case"graph/pipeline":{const $=e().graphObservations??[],U=new Set($.map(se=>se.id)),K=(N.state.observations??[]).filter(se=>!U.has(se.id)),j=new Date(N.timestamp).toISOString(),V=N.state.awaitPrompt??null,B=Array.isArray(N.actions)?((k=(P=N.actions.find(se=>se.responseType==="await_user"))==null?void 0:P.reason)==null?void 0:k.trim())??null:null,G=N.phase??current.graphPhase??"idle",Z=N.loopBudget??current.graphLoopBudget;if(t(se=>({graphStatus:"ready",graphStatusMessage:`Pipeline node ${N.node} emitted ${N.actions.length} action(s).`,graphLastReadyAt:j,graphPhase:G,graphLoopBudget:Z,graphAwaitPrompt:V,graphAwaitPromptId:(V==null?void 0:V.promptId)??null,graphAwaitReason:V?B??se.graphAwaitReason??null:null,agentAwaitingUserInput:!!V,graphSessionId:N.state.sessionId??se.graphSessionId??null,graphAwaitHistory:V?RW(se.graphAwaitHistory,V,j):se.graphAwaitHistory,graphObservations:N.state.observations??se.graphObservations})),K.forEach(se=>{e().addProgress(wW(se))}),V)e().addProgress(`Graph awaiting your choice: ${V.question}`);else{const se=Z?`Loop ${Z.actsUsed}/${Z.maxActs}${Z.exceeded?" (max reached)":""}`:null,le=`Phase ${G}`,q=se?`${le}  ${se}`:le;e().addProgress(`Graph ${q}  node ${N.node} completed.`),Z!=null&&Z.exceeded&&e().addProgress("Loop budget reached  awaiting confirmation before further automation.","error"),t({agentAwaitingUserInput:!1})}e().processGraphActions(N.actions??[]);return}case"graph/pong":t({graphLastReadyAt:new Date(N.timestamp).toISOString()});return;default:return}}),M.ensureWorker(),M.post({type:"graph/init",origin:"ui",timestamp:Date.now()})},runGraphPipeline:T=>{s({type:"graph/runPipeline",payload:T,timestamp:Date.now()})},sendGraphUserReply:async(T,I)=>{var B;const M=r();if(!M.isSupported)return;const N=e().graphAwaitPrompt,P=new Date().toISOString(),k=typeof I=="string"?I.trim():void 0;if(!T&&!k)return;const $=T&&N?((B=N.options.find(G=>G.id===T))==null?void 0:B.label)??T:null,U=T?`${$??T}`:`${k??""}`,K={sender:"user",text:N?`${N.question}
${U}`:U,timestamp:new Date,type:"user_message"};t(G=>({chatHistory:[...G.chatHistory,K],graphAwaitHistory:N?NW(G.graphAwaitHistory,N.promptId??null,P,{label:$??k??null,value:T??k??null,type:T?"option":"free_text"}):G.graphAwaitHistory})),M.post({type:"graph/userReply",optionId:T,freeText:k,timestamp:Date.now()});const j=e();if(!SW(j,T,k)){M.post({type:"graph/runPipeline",payload:{reason:"user_reply"},timestamp:Date.now()});return}try{const G=await xW(j);e().setLangChainLastPlan(G.plan),e().appendPlannerObservation(G.observation),e().updatePlannerPlanState(G.planState),o("langchain_plan",G.usageLog);const Z=bW(G.telemetry);e().addProgress(` LangChain plan ready (${Z})  ${G.summary}`),M.post({type:"graph/runPipeline",payload:{reason:"langchain_plan",langChainPlan:QK(G)},timestamp:Date.now()})}catch(G){const Z=G instanceof Error?G.message:String(G);e().addProgress(`LangChain planner failed: ${Z} planner`,"error"),M.post({type:"graph/runPipeline",payload:{reason:"langchain_plan_fallback"},timestamp:Date.now()})}},processGraphActions:async T=>{var I,M,N,P;if(!(!Array.isArray(T)||T.length===0))for(const k of T){const $=resolveIntentContract(k.intentContract);switch(k.responseType){case"plan_state_update":k.planState&&e().updatePlannerPlanState(k.planState);break;case"plan_creation":if(k.plan){const U=e().csvData;if(!U){e().addProgress("Graph plan creation skipped: dataset unavailable.","error");break}const F=e().datasetHash,K=((I=e().datasetProfile)==null?void 0:I.rowCount)??U.data.length,j={kind:"aggregate_plan",params:{planTitle:k.plan.title??"analysis"}};u(j);try{const B=await $s.aggregatePlan({plan:k.plan,datasetId:F,csvData:U,rowCountHint:K,options:{preferredMode:e().aggregationModePreference,runtimeConfig:e().datasetRuntimeConfig}});c(B,{description:k.plan.title??"analysis"})}catch(B){const G=B instanceof Ur?B:null;p("aggregate_plan",G==null?void 0:G.code,(G==null?void 0:G.message)??(B instanceof Error?B.message:String(B)),G==null?void 0:G.suggestion)}finally{d()}e().addProgress(`Graph executing plan "${k.plan.title??"analysis"}" via data pipeline.`);const V=Vy();await w(k.plan,U,V)}break;case"execute_js_code":if($){if(await executeIntentSideEffects($))break;const F=buildToolCallFromIntent($);if(F){await m(F);break}}k.toolCall||(M=k.meta)!=null&&M.toolCall?await m(k.toolCall??((N=k.meta)==null?void 0:N.toolCall)):$&&e().addProgress(`Intent ${$.intent} tool=${$.tool??"n/a"}`,"error");break;case"text_response":case"await_user":{const U=(P=k.text)==null?void 0:P.trim();if(!U)break;const F={sender:"ai",text:U,timestamp:k.timestamp?new Date(k.timestamp):new Date,type:k.responseType==="await_user"?"ai_clarification":"ai_message",cardId:k.cardId,meta:k.meta};t(K=>({chatHistory:[...K.chatHistory,F]}));break}}}},addProgress:(T,I="system")=>{const M={text:T,type:I,timestamp:new Date};t(N=>({progressMessages:[...N.progressMessages,M]}))},loadReportsList:async()=>{const T=await GG();t({reportsList:T})},handleSaveSettings:T=>{zG(T);const I=T.provider==="google"?!!T.geminiApiKey:!!T.openAIApiKey;t({settings:T,isApiKeySet:I}),Fk(T)},handleAsideMouseDown:T=>{T.preventDefault(),e().setIsResizing(!0);const I=N=>{const P=window.innerWidth-$W;let k=window.innerWidth-N.clientX;k=Math.max(Xy,k),k=Math.min(LW,k,P),e().setAsideWidth(k)},M=()=>{e().setIsResizing(!1),document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",M)};document.addEventListener("mousemove",I),document.addEventListener("mouseup",M)},runAnalysisPipeline:async(T,I,M={})=>{var ce;const{isChatRequest:N=!1,runId:P}=M,k=e().addProgress,$=e().settings,U=()=>P?e().isRunCancellationRequested(P):!1,F=()=>y(P);let K=!0;const j=e().beginAgentActionTrace,V=e().updateAgentActionTrace,B=e().datasetHash,G=!N,Z=()=>{G&&t(ie=>{const fe=ie.analysisTimeline;if(!fe.totalCards)return{};const Re=Math.min(fe.totalCards,fe.completedCards+1),Ge=fe.stage==="profiling"&&Re>0?"insight":fe.stage;return{analysisTimeline:{...fe,completedCards:Re,stage:Ge}}})},se=((ce=e().datasetProfile)==null?void 0:ce.rowCount)??I.data.length,le=ie=>{var Re;const fe=e();return u0(ie,B,I,se,{preferredMode:((Re=fe.datasetRuntimeConfig)==null?void 0:Re.mode)??fe.aggregationModePreference,runtimeConfig:fe.datasetRuntimeConfig})},q=async(ie,fe)=>{const Re=le(ie);if(!Re)return null;fe!=null&&fe.mode&&(Re.mode=fe.mode),fe!=null&&fe.allowFullScan&&(Re.allowFullScan=!0);const Ge=await Ls.aggregate(Re);if(!Ge.ok){if(Ge.code===Yt.FULL_SCAN_BLOCKED&&!Re.allowFullScan)return mR(ie.title)?(k(`User enabled full scan for "${ie.title}".`,"system"),q(ie,{mode:"full",allowFullScan:!0})):(k(`Skipped "${ie.title}" because full scan was not approved.`,"error"),null);const ze=Wy(Ge.code,Ge.reason);return k(`Aggregation worker failed for "${ie.title}": ${ze}`,"error"),Ge.hint&&k(Ge.hint,"error"),null}return Ge.data.rows.length===0?(k(`Skipping "${ie.title}" due to empty aggregation result.`,"error"),null):{result:Ge.data,durationMs:Ge.durationMs??0}};G&&T.length>0&&t(ie=>({analysisTimeline:{stage:ie.analysisTimeline.stage==="persisting"?"profiling":ie.analysisTimeline.stage,totalCards:T.length,completedCards:0}}));const W=async ie=>{var Ge;const fe=j("proceed_to_analysis",`Run analysis "${ie.title}"`,"pipeline"),Re=(ze,Ae)=>V(fe,ze,Ae);if(U())return null;try{k(`Executing plan: ${ie.title}...`),P&&e().updateBusyStatus(`Executing "${ie.title}"...`);const ze=ZG(ie,e().columnProfiles,I.data);if(!ze.isValid)return k(`Skipping "${ie.title}" because ${ze.errorMessage??"the plan is invalid."}`,"error"),Re("failed",ze.errorMessage??"Plan invalid."),null;ze.warnings.forEach(_e=>{k(`${ie.title}: ${_e}`),e().recordPlanValidationNotice(ie.title,_e)});const Ae=ze.plan;let Rt=null,je=null,dn=0,ct=[];try{B&&(Rt=await q(Ae),Rt&&(je=Rt.result,dn=Rt.durationMs)),je?ct=je.rows:ct=qR(I,Ae)}catch(_e){if(_e instanceof PR&&_e.code==="no_rows"){const ve=Ae.rowFilter?`${Ae.rowFilter.column}  ${Ae.rowFilter.values.join(", ")}`:"the requested filter";return k(`Skipping "${ie.title}" because ${ve} returned no rows.`,"error"),Re("failed",_e.message),Z(),null}throw _e}if(ct.length===0)return k(`Skipping "${ie.title}" due to empty result.`,"error"),Re("failed","Aggregation returned 0 rows."),Z(),null;if(U())return null;k(`AI is summarizing: ${ie.title}...`),P&&e().updateBusyStatus(`Summarizing "${ie.title}"...`);const nn=await vG(Ae.title,ct,$,{signal:F(),onUsage:_e=>{e().recordLlmUsage(wi(_e,"summary.generate"))}});if(U())return null;let rn=null,Oe=(je==null?void 0:je.provenance.queryHash)??null;const lt=(je==null?void 0:je.provenance.sampled)??!1;if(je&&B){const _e=await Ls.createCardFromResult({datasetId:B,title:Ae.title,kind:GW(Ae),explainer:nn,result:je,plan:Ae});_e.ok?rn=_e.data.cardId:k(`View cache save failed for "${Ae.title}": ${_e.reason}`,"error")}const Nn=ct.length,ge=Ae.chartType!=="scatter"&&Nn>15,Ct=je?{mode:je.provenance.mode,sampled:je.provenance.sampled,processedRows:je.provenance.processedRows,totalRows:je.provenance.totalRows,warnings:je.provenance.warnings,durationMs:dn,lastRunAt:new Date().toISOString(),filterCount:je.provenance.filterCount,requestedMode:je.provenance.requestedMode??je.provenance.mode,downgradedFrom:je.provenance.downgradedFrom,downgradeReason:je.provenance.downgradeReason,normalization:je.provenance.normalization}:{mode:"full",sampled:!1,processedRows:ct.length,totalRows:ct.length,warnings:B?["Aggregated on main thread because the worker response was unavailable."]:[],durationMs:dn||void 0,lastRunAt:new Date().toISOString(),filterCount:Ae.rowFilter?1:0,requestedMode:e().aggregationModePreference??"full",normalization:je==null?void 0:je.provenance.normalization},Ee={id:`card-${Date.now()}-${Math.random()}`,plan:Ae,aggregatedData:ct,summary:nn,displayChartType:Ae.chartType,isDataVisible:!1,topN:ge?8:Ae.defaultTopN||null,hideOthers:ge?!0:Ae.defaultHideOthers||!1,disableAnimation:N||!K||e().analysisCards.length>0,hiddenLabels:[],dataRefId:rn,queryHash:Oe,isSampledResult:(Ct==null?void 0:Ct.sampled)??lt,aggregationMeta:Ct,valueSchema:je==null?void 0:je.schema};t(_e=>({analysisCards:[..._e.analysisCards,Ee]})),Z();const Ce=`[Chart: ${Ae.title}] Description: ${Ae.description}. AI Summary: ${nn.split("---")[0]}`;if(await wt.addDocument({id:Ee.id,text:Ce,metadata:{kind:"card",summaryLevel:"summary",cardId:Ee.id,createdAt:new Date().toISOString()}}),k(`View #${Ee.id.slice(-6)} indexed for long-term memory.`),B&&rn){const _e=((Ge=Ct==null?void 0:Ct.warnings)==null?void 0:Ge.length)??0,ve={datasetId:B,viewId:rn,cardId:Ee.id,title:Ae.title,summary:nn,plan:Ae,chartType:Ae.chartType,schema:je==null?void 0:je.schema,sampleRows:ct.slice(0,UW),rowCount:ct.length,sampled:(Ct==null?void 0:Ct.sampled)??lt??!1,queryHash:Oe,qualityScore:FW(ct.length,_e,(Ct==null?void 0:Ct.sampled)??lt??!1),tags:BW(Ae)};pz(ve).catch(ye=>console.warn("Failed to persist memory snapshot for dataset cache:",ye))}return K=!1,k(`Saved as View #${Ee.id.slice(-6)}`),Re("succeeded",`Created card with ${ct.length} rows.`),Ee}catch(ze){if(U())return k(`Cancelled "${ie.title}" before completion.`),V(fe,"failed","Cancelled before completion."),Z(),null;console.error("Error executing plan:",ie.title,ze);const Ae=ze instanceof Error?ze.message:String(ze);return k(`Error executing plan "${ie.title}": ${Ae}`,"error"),Re("failed",Ae),Z(),null}},ee=(await Promise.all(T.map(W))).filter(ie=>ie!==null);if(!N&&ee.length>0&&!U()){k("AI is forming its core understanding of the data..."),P&&e().updateBusyStatus("Forming core understanding...");const ie=ee.map(Ae=>({id:Ae.id,title:Ae.plan.title,aggregatedDataSample:Ae.aggregatedData.slice(0,10)})),fe=await wG(ie,e().columnProfiles,$,{signal:F(),onUsage:Ae=>{e().recordLlmUsage(wi(Ae,"summary.core_analysis"))}});if(U())return ee;const Re={sender:"ai",text:fe,timestamp:new Date,type:"ai_thinking"};if(t(Ae=>({aiCoreAnalysisSummary:fe,chatHistory:[...Ae.chatHistory,Re]})),k("Indexing core analysis for long-term memory..."),await wt.addDocument({id:"core-summary",text:`Core Analysis Summary: ${fe}`,metadata:{kind:"card",summaryLevel:"summary",createdAt:new Date().toISOString(),cardId:"core-summary"}}),k("Core analysis indexed."),U())return ee;k("AI is looking for key insights..."),P&&e().updateBusyStatus("Looking for key insights...");const Ge=await bG(ie,$,{signal:F(),onUsage:Ae=>{e().recordLlmUsage(wi(Ae,"summary.proactive_insight"))}});if(U())return ee;if(Ge){const Ae={sender:"ai",text:Ge.insight,timestamp:new Date,type:"ai_proactive_insight",cardId:Ge.cardId};t(Rt=>({chatHistory:[...Rt.chatHistory,Ae]})),k(`AI proactively identified an insight in View #${Ge.cardId.slice(-6)}.`)}if(U())return ee;const ze=await RE(ee,$,{signal:F(),onUsage:Ae=>{e().recordLlmUsage(wi(Ae,"summary.final"))}});if(U())return ee;t({finalSummary:ze}),k("Overall summary generated.")}return ee},handleInitialAnalysis:async(T,I={})=>{if(!T)return;t(N=>N.analysisTimeline.stage==="persisting"?{}:{analysisTimeline:{...N.analysisTimeline,stage:"profiling",totalCards:0,completedCards:0}});const{runId:M}=I;await F_({beginBusy:e().beginBusy,endBusy:e().endBusy},"Running analysis...",async N=>{e().addProgress("Starting main analysis...");try{e().addProgress("AI is generating analysis plans..."),e().updateBusyStatus("Drafting analysis plans...");const P=e().datasetHash;P&&await x(P,T.data.length);const k=P?await hz(P,{limit:6,minScore:.4}):[],$=await uG(e().columnProfiles,T.data.slice(0,50),e().settings,{signal:y(N),memorySnapshots:k});$.warnings.forEach(F=>{const K=`Plan generator warning: ${F.message}`;e().addProgress(K,"error"),e().addToast(F.message,"error",6e3)});const U=$.plans;if(o("analysis_plan",$.telemetry),N&&e().isRunCancellationRequested(N)){e().addProgress("Analysis cancelled before execution.");return}e().addProgress(`AI proposed ${U.length} plans.`),U.length>0?await e().runAnalysisPipeline(U,T,{runId:N}):(e().addProgress("AI did not propose any analysis plans.","error"),t(F=>({analysisTimeline:{...F.analysisTimeline,stage:"idle",totalCards:0,completedCards:0}})))}catch(P){if(P instanceof tP)P.warnings.forEach(k=>{e().addProgress(`Plan generator warning: ${k.message}`,"error"),e().addToast(k.message,"error",7e3)}),e().addProgress("Plan generation failed. Please retry analysis or adjust your prompt.","error"),e().addToast("Plan generation failed. Retry?","error",0,{label:"Retry analysis",onClick:()=>{const k=e().csvData;k&&e().handleInitialAnalysis(k)}}),t(k=>({analysisTimeline:{...k.analysisTimeline,stage:"idle"}}));else if(!(N&&e().isRunCancellationRequested(N))){console.error("Analysis pipeline error:",P);const k=P instanceof Error?P.message:String(P);e().addProgress(`Error during analysis: ${k}`,"error"),e().addToast("Analysis failed. Retry?","error",0,{label:"Retry",onClick:()=>{const $=e().csvData;$&&e().handleInitialAnalysis($)}})}}finally{N&&e().isRunCancellationRequested(N)?e().addProgress("Stopped current analysis."):e().addProgress("Analysis complete. Ready for chat.")}},{runId:M,cancellable:!0})},regenerateAnalyses:async T=>{e().addProgress("Data has changed. Regenerating all analysis cards...");const I=e().analysisCards.map(M=>M.plan);t({analysisCards:[],finalSummary:null}),await F_({beginBusy:e().beginBusy,endBusy:e().endBusy},"Regenerating insight cards...",async M=>{try{if(I.length>0){const N=await e().runAnalysisPipeline(I,T,{isChatRequest:!0,runId:M});if(N.length>0&&!(M&&e().isRunCancellationRequested(M))){const P=await RE(N,e().settings,{signal:y(M),onUsage:k=>{e().recordLlmUsage(wi(k,"summary.final"))}});M&&e().isRunCancellationRequested(M)||(t({finalSummary:P}),e().addProgress("All analysis cards have been updated."))}}else e().addProgress("No existing plans found to regenerate.","error")}catch(N){if(!(M&&e().isRunCancellationRequested(M))){console.error("Error regenerating analyses:",N);const P=N instanceof Error?N.message:String(N);e().addProgress(`Error updating analyses: ${P}`,"error")}}},{cancellable:!0})},executeQuickAction:async T=>{const I=()=>e().addToast(" CSV ","error",4e3);switch(T){case"profile_dataset":{const M=e().datasetHash;if(!M){I();return}e().addProgress("Running quick data profile");try{const N=await $s.profileDataset(M,e().getSampleSizeHint("profile")),P=N.context??null;P&&e().applyDatasetProfileSnapshot(P),c(N,{description:"Dataset profile (quick action)"});const k=N.summary,$={sender:"ai",text:`  ${N.payload.columns} ${N.payload.rowCount.toLocaleString()}  Data Profile `,timestamp:new Date,type:"ai_message"};t(U=>({chatHistory:[...U.chatHistory,$]}))}catch(N){const P=N instanceof Ur?N:null;p("profile_dataset",P==null?void 0:P.code,(P==null?void 0:P.message)??(N instanceof Error?N.message:String(N)),P==null?void 0:P.suggestion)}break}case"open_raw_preview":{e().focusDataPreview();const M={sender:"ai",text:" Raw Data Explorer ",timestamp:new Date,type:"ai_message"};t(N=>({chatHistory:[...N.chatHistory,M]}));break}case"topn_quick_chart":{const M=e().csvData;if(!M||M.data.length===0){I();return}const N=CW(e().columnProfiles,M.data.slice(0,200));if(!N){e().addProgress(" /  Top-N ","error");return}e().addProgress(`Running quick Top-N chart: ${N.title}`);const k=(await e().runAnalysisPipeline([N],M,{isChatRequest:!0}))[0];if(k){const $={sender:"ai",text:`  Top-N ${k.plan.title}`,timestamp:new Date,type:"ai_message",cardId:k.id};t(U=>({chatHistory:[...U.chatHistory,$]}))}else e().addProgress("Quick Top-N ","error");break}default:e().addProgress("Unknown quick action.","error")}},executeDomAction:T=>{e().addProgress(`AI is performing action: ${T.toolName}...`);const I=(P,k)=>{t($=>{const U=$.analysisCards.findIndex(j=>j.id===P);if(U===-1)return{};const F=k($.analysisCards[U]);if(!F)return{};const K=[...$.analysisCards];return K[U]=F,{analysisCards:K}})},M=P=>e().analysisCards.find(k=>k.id===P),N=P=>{const k=P.plan.groupByColumn||"",$=P.plan.valueColumn||"count";let U=P.aggregatedData;const F=P.filter;if(F!=null&&F.column&&F.values&&F.values.length>0&&(U=U.filter(K=>F.values.includes(K[F.column]))),P.plan.chartType!=="scatter"&&k&&P.topN&&(U=LR(U,k,$,P.topN)),P.topN&&P.hideOthers&&k&&(U=U.filter(K=>K[k]!=="Others")),k&&P.hiddenLabels&&P.hiddenLabels.length>0){const K=new Set(P.hiddenLabels.map(String));U=U.filter(j=>!K.has(String(j[k])))}return U};switch(T.toolName){case"highlightCard":{const P=T.args.cardId,k=document.getElementById(P);k&&(k.scrollIntoView({behavior:"smooth",block:"center"}),k.classList.add("ring-4","ring-blue-500","transition-all","duration-500"),setTimeout(()=>k.classList.remove("ring-4","ring-blue-500"),2500));break}case"changeCardChartType":{const{cardId:P,newType:k}=T.args;I(P,$=>({...$,displayChartType:k}));break}case"showCardData":{const{cardId:P,visible:k}=T.args,$=typeof k=="boolean"?k:!0;I(P,U=>({...U,isDataVisible:$}));break}case"filterCard":{const{cardId:P,column:k,values:$}=T.args;if(!k)break;const U=Array.isArray($)?$:[];I(P,F=>({...F,filter:U.length>0?{column:k,values:U}:void 0}));break}case"setTopN":{const{cardId:P,topN:k}=T.args,$=k==null||k==="all"?null:Number(k);if($!==null&&(!Number.isFinite($)||$<=0))break;I(P,U=>({...U,topN:$}));break}case"toggleHideOthers":{const{cardId:P,hide:k}=T.args;I(P,$=>({...$,hideOthers:typeof k=="boolean"?k:!$.hideOthers}));break}case"toggleLegendLabel":{const{cardId:P,label:k}=T.args;if(!k)break;I(P,$=>{const U=$.hiddenLabels||[],K=U.includes(k)?U.filter(j=>j!==k):[...U,k];return{...$,hiddenLabels:K}});break}case"exportCard":{const{cardId:P,format:k="png"}=T.args,$=M(P),U=document.getElementById(P);if(!$||!U){console.warn("exportCard: card or DOM node not found",P);break}const F=N($),K=typeof k=="string"?k.toLowerCase():"png";(async()=>{try{switch(K){case"csv":HR(F,$.plan.title);break;case"html":await zR(U,$.plan.title,F,$.summary);break;default:await GR(U,$.plan.title);break}e().addProgress(`Exported "${$.plan.title}" as ${K.toUpperCase()}.`)}catch(j){console.error("Failed to export card",j),e().addProgress("Export failed. Please try again.","error")}})();break}case"removeCard":{const{cardId:P}=T.args;if(!P||typeof P!="string")break;let k=null,$=!1;t(U=>{var j,V;const F=U.analysisCards.find(B=>B.id===P);if(!F)return{};$=!0,k=((j=F.plan)==null?void 0:j.title)??P;const K={analysisCards:U.analysisCards.filter(B=>B.id!==P)};return((V=U.interactiveSelectionFilter)==null?void 0:V.sourceCardId)===P&&(K.interactiveSelectionFilter=null),K}),$?e().addProgress(`Removed card "${k??P}" as requested.`):e().addProgress("Unable to remove the requested card because it was not found.","error");break}}},handleExternalCsvPayload:async T=>{var P;if(!T||typeof T.csv!="string"||!T.csv.trim()){e().addToast("Received empty CSV payload from source page.","error");return}const I=((P=T.fileName)==null?void 0:P.trim())||DW(T.header),M=new Blob([T.csv],{type:"text/csv"});let N;try{N=new File([M],I,{type:"text/csv"})}catch{N=Object.assign(M,{name:I,lastModified:Date.now()})}try{await e().handleFileUpload(N)}catch(k){console.error("Failed to import CSV payload from opener.",k),e().addToast("Failed to import CSV from report page.","error")}},applyDatasetProfileSnapshot:T=>{const I=`obs-profile-${Date.now().toString(36)}`,M=new Date().toISOString(),N={id:I,actionId:"dataset_profile",responseType:"plan_state_update",status:"success",timestamp:M,outputs:{rowCount:T.rowCount,sampledRows:T.sampledRows,sampleRatio:T.rowCount>0?Number((T.sampledRows/T.rowCount).toFixed(3)):1}};t(P=>{const k=P.plannerSession.planState;if(!k)return{datasetProfile:T};const $=k.observationIds??[];return $.includes(I)?{datasetProfile:T}:{datasetProfile:T,plannerSession:{...P.plannerSession,planState:{...k,observationIds:[...$,I]}}}}),e().appendPlannerObservation(N)},handleChartTypeChange:(T,I)=>{t(M=>({analysisCards:M.analysisCards.map(N=>N.id===T?{...N,displayChartType:I}:N)}))},handleToggleDataVisibility:T=>{t(I=>({analysisCards:I.analysisCards.map(M=>M.id===T?{...M,isDataVisible:!M.isDataVisible}:M)}))},handleTopNChange:(T,I)=>{t(M=>({analysisCards:M.analysisCards.map(N=>N.id===T?{...N,topN:I}:N)}))},handleHideOthersChange:(T,I)=>{t(M=>({analysisCards:M.analysisCards.map(N=>N.id===T?{...N,hideOthers:I}:N)}))},handleToggleLegendLabel:(T,I)=>{t(M=>({analysisCards:M.analysisCards.map(N=>{if(N.id===T){const P=N.hiddenLabels||[],k=P.includes(I)?P.filter($=>$!==I):[...P,I];return{...N,hiddenLabels:k}}return N})}))},setAggregationModePreference:T=>{if(e().aggregationModePreference===T)return;t({aggregationModePreference:T});const I=e().datasetHash;I&&A(I,{mode:T,allowFullScan:T==="full"});const M=T==="full"?"":"";e().addProgress(M)},resetConversationMemory:()=>{wt.clear(),t({conversationMemoryState:Bk(),vectorStoreDocuments:[],chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1}),e().addProgress("Conversation memory has been reset.")},maybeCompactConversationMemory:async()=>{if(Ky)return;const T=e();if(T.chatHistory.length!==0){Ky=!0;try{if(wt.getIsInitialized()||await wt.init(T.addProgress),!wt.getIsInitialized())return;let I={...T.conversationMemoryState};const{chatHistory:M}=T,N=new Date().toISOString(),P=Math.max(0,M.length-pW);for(;I.lastIndexedMessage+Zy<=P&&Zy>0;){const k=I.lastIndexedMessage,$=k+Zy-1,U=M.slice(k,$+1);if(U.length===0)break;const F=`conv-raw-${k}-${$}-${Date.now().toString(36)}`,K=vW(U,k);await wt.addDocument({id:F,text:`Conversation Memory (raw snippet)
${K}`,metadata:{kind:"conversation",summaryLevel:"raw",startIndex:k,endIndex:$,createdAt:N,messageCount:U.length}}),I={...I,lastIndexedMessage:$+1,rawChunks:[...I.rawChunks,{id:F,startIndex:k,endIndex:$,summaryLevel:"raw",createdAt:N}]}}if(I.rawChunks.length>gR){const k=I.rawChunks.length-gR,$=I.rawChunks.slice(0,k);if($.reduce((F,K)=>F+(K.endIndex-K.startIndex+1),0)>=hW){const F=$[0].startIndex,K=$[$.length-1].endIndex,j=M.slice(F,K+1),V=await SG(j,T.settings,{onUsage:G=>T.recordLlmUsage(wi(G,"memory.conversation"))}),B=`conv-summary-${F}-${K}-${Date.now().toString(36)}`;await wt.addDocument({id:B,text:`Compressed Memory (messages ${F+1}-${K+1})
${V}`,metadata:{kind:"conversation",summaryLevel:"summary",startIndex:F,endIndex:K,createdAt:new Date().toISOString(),sourceDocIds:$.map(G=>G.id),messageCount:j.length}}),$.forEach(G=>wt.deleteDocument(G.id)),I={...I,rawChunks:I.rawChunks.slice(k),summaryChunks:[...I.summaryChunks,{id:B,startIndex:F,endIndex:K,summaryLevel:"summary",createdAt:new Date().toISOString()}]}}}t({conversationMemoryState:I,vectorStoreDocuments:wt.getDocuments()})}catch(I){console.error("Conversation memory compaction failed:",I)}finally{Ky=!1}}},setActiveSchemaPhase:T=>{t(I=>I.activeSchemaPhase===T?{}:{activeSchemaPhase:T})},resetSamplePolicy:()=>{t(T=>{var N,P;const I={tiers:Wo,currentIndex:0,userConfirmedFullScan:!1,lastUpgradeReason:null},M=fR(T.datasetRuntimeConfig,I.tiers[I.currentIndex],((N=T.datasetProfile)==null?void 0:N.rowCount)??((P=T.csvData)==null?void 0:P.data.length));return{samplePolicy:I,datasetRuntimeConfig:M??T.datasetRuntimeConfig}})},requestSampleUpgrade:T=>{if(e().samplePolicy.currentIndex>=Wo.length-1)return;t(k=>{var j,V;const $=k.samplePolicy.currentIndex+1,U={...k.samplePolicy,currentIndex:$,userConfirmedFullScan:k.samplePolicy.userConfirmedFullScan||T==="user_confirm",lastUpgradeReason:T},F=U.tiers[$],K=fR(k.datasetRuntimeConfig,F,((j=k.datasetProfile)==null?void 0:j.rowCount)??((V=k.csvData)==null?void 0:V.data.length));return{samplePolicy:U,datasetRuntimeConfig:K??k.datasetRuntimeConfig}});const M=e().samplePolicy,N=M.tiers[M.currentIndex],P=T==="confidence"?"":"";e().addProgress(` ${uW(N)}${P}`,"system")},getSampleSizeHint:T=>{var P,k;const{samplePolicy:I}=e(),M=I.tiers[I.currentIndex];if(M===null)return;const N=((P=e().datasetProfile)==null?void 0:P.rowCount)??((k=e().csvData)==null?void 0:k.data.length)??void 0;return N?Math.min(M,N):M},recordPlanValidationNotice:(T,I)=>{const M={id:iW(),planTitle:T,message:I,at:new Date().toISOString()};t(N=>({planValidationNotices:[...N.planValidationNotices,M].slice(-4)}))},dismissPlanValidationNotice:T=>{t(I=>({planValidationNotices:I.planValidationNotices.filter(M=>M.id!==T)}))},recordLlmUsage:T=>{const I=T.estimatedCostUsd!=null?T.estimatedCostUsd:sW({provider:T.provider,model:T.model,promptTokens:T.promptTokens,completionTokens:T.completionTokens,totalTokens:T.totalTokens}),M=mW({...T,estimatedCostUsd:I??null});t(N=>({llmUsageLog:[...N.llmUsageLog,M].slice(-40)})),e().addProgress(`LLM ${yW(M)}`)},clearLlmUsage:()=>{t({llmUsageLog:[]})},toggleLangGraphRuntime:T=>{e().useLangGraphRuntime!==T&&(ks==null||ks(),ks=null,Jy=!1,Yy=null,t({useLangGraphRuntime:T,graphStatus:"idle",graphStatusMessage:"Graph runtime not connected.",graphVersion:null,graphLastReadyAt:null}))},setLangChainLastPlan:T=>{t({langChainLastPlan:T})},setLangChainPlannerEnabled:T=>{t({langChainPlannerEnabled:T})},rerunAggregationForCard:async(T,I={})=>{var V,B,G;const M=e().analysisCards.find(Z=>Z.id===T),N=e().datasetHash,P=e().csvData;if(!M||!N)return e().addProgress("Cannot refresh this chart because the dataset is unavailable.","error"),!1;const k=((V=e().datasetProfile)==null?void 0:V.rowCount)??((B=P==null?void 0:P.data)==null?void 0:B.length)??0,$=u0(M.plan,N,P,k,{preferredMode:((G=e().datasetRuntimeConfig)==null?void 0:G.mode)??e().aggregationModePreference,runtimeConfig:e().datasetRuntimeConfig});if(!$)return e().addProgress(`"${M.plan.title}" cannot be recalculated automatically.`,"error"),!1;I.mode&&($.mode=I.mode),I.allowFullScan&&($.allowFullScan=!0);const U=e().beginAgentActionTrace("proceed_to_analysis",`Manual aggregation rerun: ${M.plan.title}`,"system");e().updateAgentActionTrace(U,"executing",void 0,{metadata:{cardId:T,requestedMode:$.mode,allowFullScan:!!$.allowFullScan}});let F=await Ls.aggregate($);if(!F.ok&&F.code===Yt.FULL_SCAN_BLOCKED&&!$.allowFullScan)if(mR(M.plan.title))e().addProgress(`User enabled full scan for "${M.plan.title}".`,"system"),$.mode="full",$.allowFullScan=!0,F=await Ls.aggregate($);else return e().addProgress(`Skipped "${M.plan.title}" because full scan was not approved.`,"error"),e().updateAgentActionTrace(U,"failed","Full scan not approved.",{metadata:{cardId:T,requestedMode:$.mode,allowFullScan:!!$.allowFullScan}}),!1;if(!F.ok){const Z=Wy(F.code,F.reason);return e().addProgress(`Aggregation refresh failed for "${M.plan.title}": ${Z}`,"error"),e().addToast(Z,"error"),e().updateAgentActionTrace(U,"failed",Z??"Aggregation failed.",{metadata:{cardId:T,requestedMode:$.mode,allowFullScan:!!$.allowFullScan}}),!1}const K=F.data,j={mode:K.provenance.mode,sampled:K.provenance.sampled,processedRows:K.provenance.processedRows,totalRows:K.provenance.totalRows,warnings:K.provenance.warnings,durationMs:F.durationMs??0,lastRunAt:new Date().toISOString(),filterCount:K.provenance.filterCount,requestedMode:K.provenance.requestedMode??K.provenance.mode,downgradedFrom:K.provenance.downgradedFrom,downgradeReason:K.provenance.downgradeReason,normalization:K.provenance.normalization};return t(Z=>({analysisCards:Z.analysisCards.map(se=>se.id===T?{...se,aggregatedData:K.rows,isSampledResult:j.sampled,aggregationMeta:j,valueSchema:K.schema}:se)})),e().addProgress(`${M.plan.title} refreshed (${j.sampled?"sampled":"full scan"}).`),e().addToast(j.sampled?`"${M.plan.title}" refreshed on sampled rows.`:`"${M.plan.title}" full scan completed.`,"success"),e().updateAgentActionTrace(U,"succeeded","Aggregation refreshed.",{metadata:{cardId:T,mode:j.mode,processedRows:j.processedRows,totalRows:j.totalRows,durationMs:j.durationMs,warnings:j.warnings}}),!0},clearCardFilter:T=>{t(I=>({analysisCards:I.analysisCards.map(M=>M.id===T?{...M,filter:void 0}:M)}))},triggerAutoSaveNow:()=>{hR()},handleLoadReport:async T=>{var M,N;e().addProgress(`Loading report ${T}...`);const I=await Gu(T);I?(wt.clear(),t({...I.appState,useLangGraphRuntime:!0,agentAwaitingUserInput:I.appState.agentAwaitingUserInput??!1,agentAwaitingPromptId:I.appState.agentAwaitingPromptId??null,currentView:"analysis_dashboard",isHistoryPanelOpen:!1,chatMemoryPreview:[],chatMemoryExclusions:[],chatMemoryPreviewQuery:"",isMemoryPreviewLoading:!1,agentActionTraces:I.appState.agentActionTraces??[],agentValidationEvents:I.appState.agentValidationEvents??[],columnAliasMap:I.appState.columnAliasMap??wR(I.appState.columnProfiles??[]),plannerSession:p0(I.appState.plannerSession),plannerDatasetHash:I.appState.plannerDatasetHash??I.appState.datasetHash??null}),await x(I.appState.datasetHash??null,((M=I.appState.datasetProfile)==null?void 0:M.rowCount)??((N=I.appState.csvData)==null?void 0:N.data.length)),await vR(I.appState.vectorStoreDocuments,I.appState.datasetHash,e().datasetHash,e().addProgress,e().addToast,e().dismissToast,"Restored AI long-term memory from loaded report."),e().addProgress(`Report "${I.filename}" loaded.`),pR(I.createdAt)):e().addProgress(`Failed to load report ${T}.`,"error")},handleDeleteReport:async T=>{await U_(T),await e().loadReportsList()},handleShowCardFromChat:T=>{const I=document.getElementById(T);I&&(I.scrollIntoView({behavior:"smooth",block:"center"}),I.classList.add("ring-4","ring-blue-500","transition-all","duration-500"),setTimeout(()=>I.classList.remove("ring-4","ring-blue-500"),2500))},setAgentPhase:(T,I)=>t({agentPhase:{phase:T,message:I??null,enteredAt:new Date().toISOString()}}),setIsAsideVisible:T=>t({isAsideVisible:T}),setAsideWidth:T=>t({asideWidth:T}),setIsSpreadsheetVisible:T=>t({isSpreadsheetVisible:T}),setIsDataPrepDebugVisible:T=>t({isDataPrepDebugVisible:T}),setIsSettingsModalOpen:T=>t({isSettingsModalOpen:T}),setIsHistoryPanelOpen:T=>t({isHistoryPanelOpen:T}),setIsMemoryPanelOpen:T=>t({isMemoryPanelOpen:T}),setIsResizing:T=>t({isResizing:T}),recordAgentValidationEvent:({actionType:T,reason:I,actionIndex:M,runId:N,retryInstruction:P,timestamp:k})=>{const $={id:lW(),actionType:T,reason:I,actionIndex:M,runId:N??null,retryInstruction:P,timestamp:k??new Date().toISOString()};t(U=>({agentValidationEvents:[...U.agentValidationEvents,$].slice(-25)})),typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("agent-validation-event",{detail:$}))},dismissAgentValidationEvent:T=>{t(I=>({agentValidationEvents:I.agentValidationEvents.filter(M=>M.id!==T)}))},clearAgentValidationEvents:()=>t({agentValidationEvents:[]}),recordPromptMetric:T=>{t(I=>({agentPromptMetrics:[...I.agentPromptMetrics,T].slice(-20)}))},clearPromptMetrics:()=>t({agentPromptMetrics:[]}),beginAgentActionTrace:(T,I,M="chat")=>{const N=`trace-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,P={id:N,actionType:T,status:"observing",summary:I,timestamp:new Date,source:M};return t(k=>({agentActionTraces:[...k.agentActionTraces,P].slice(-40)})),N},updateAgentActionTrace:(T,I,M,N)=>{t(P=>({agentActionTraces:P.agentActionTraces.map(k=>{if(k.id!==T)return k;const $=N!=null&&N.metadata?{...k.metadata??{},...N.metadata}:k.metadata;return{...k,status:I,details:M,timestamp:new Date,durationMs:(N==null?void 0:N.durationMs)??k.durationMs,errorCode:(N==null?void 0:N.errorCode)??k.errorCode,metadata:$}})}))},annotateAgentActionTrace:(T,I)=>{!I||Object.keys(I).length===0||t(M=>({agentActionTraces:M.agentActionTraces.map(N=>N.id===T?{...N,metadata:{...N.metadata??{},...I}}:N)}))},appendPlannerObservation:T=>{t(I=>{const M=[...I.plannerSession.observations,T].slice(-12);return{plannerSession:{...I.plannerSession,observations:M}}})},resetPlannerObservations:()=>{t(T=>({plannerSession:{...T.plannerSession,observations:[]}}))},updatePlannerPlanState:T=>{const I=_R(T.nextSteps);t(M=>({plannerSession:{...M.plannerSession,planState:{...T,nextSteps:I}},plannerPendingSteps:I,plannerDatasetHash:M.datasetHash??null})),typeof T.confidence=="number"&&T.confidence<.6&&e().requestSampleUpgrade("confidence")},clearPlannerPlanState:()=>{t(T=>({plannerSession:{...T.plannerSession,planState:null},plannerPendingSteps:[],plannerDatasetHash:null}))},setPlannerPendingSteps:T=>{t({plannerPendingSteps:_R(T)})},completePlannerPendingStep:()=>{t(T=>{var $,U;if(T.plannerPendingSteps.length===0)return{};const[I,...M]=T.plannerPendingSteps,N=T.plannerSession.planState;if(!N)return{plannerPendingSteps:M};const P=(($=N.steps)==null?void 0:$.map(F=>F.id===I.id?{...F,status:"done"}:F))??N.steps,k=((U=M[0])==null?void 0:U.id)??N.currentStepId;return{plannerPendingSteps:M,plannerSession:{...T.plannerSession,planState:{...N,steps:P,nextSteps:M,currentStepId:k}}}})},focusDataPreview:()=>{t({isSpreadsheetVisible:!0}),setTimeout(()=>{var T;(T=document.getElementById("raw-data-explorer"))==null||T.scrollIntoView({behavior:"smooth",block:"center"})},100)}}});tt.subscribe(t=>t.chatHistory.length,(t,e)=>{t>e&&tt.getState().maybeCompactConversationMemory()});Fk(tt.getState().settings);Yn=new GK({getStore:()=>tt.getState(),buildSnapshot:OW,addToast:(t,e,n,r)=>tt.getState().addToast(t,e,n,r),dismissToast:t=>tt.getState().dismissToast(t)});tp&&Yn.configure(tp);const zW=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),jW=()=>S.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[S.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z",clipRule:"evenodd"}),S.jsx("path",{d:"M12.293 5.293a1 1 0 011.414 0l2 2a1 1 0 01-1.414 1.414L13 7.414V10a1 1 0 11-2 0V7.414l-1.293 1.293a1 1 0 01-1.414-1.414l2-2zM7.707 14.707a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L7 12.586V10a1 1 0 112 0v2.586l1.293-1.293a1 1 0 011.414 1.414l-2 2z"})]}),VW=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})}),bR=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-amber-600",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.721-1.36 3.486 0l6.518 11.59c.75 1.334-.213 2.987-1.743 2.987H3.482c-1.53 0-2.493-1.653-1.743-2.987l6.518-11.59zM10 7a1 1 0 00-1 1v3.25a1 1 0 002 0V8a1 1 0 00-1-1zm0 8a1.25 1.25 0 100-2.5A1.25 1.25 0 0010 15z",clipRule:"evenodd"})}),JW=t=>typeof t!="number"||Number.isNaN(t)?null:t<1e3?`${Math.round(t)} ms`:`${(t/1e3).toFixed(1)} s`,YW=t=>{if(!t)return null;const e=new Date(t);return Number.isNaN(e.getTime())?null:e.toLocaleTimeString()},KW=({meta:t,onRunFullScan:e,isRefreshing:n})=>{var x;if(!t)return null;const r=t.sampled,s=r?"bg-amber-100 text-amber-800 border-amber-200":"bg-emerald-100 text-emerald-700 border-emerald-200",a=r?"Sampled result":"Full scan",o=r?`${t.processedRows.toLocaleString()} of ${t.totalRows.toLocaleString()} rows`:`${t.totalRows.toLocaleString()} rows`,u=JW(t.durationMs),d=YW(t.lastRunAt),c=((x=t.warnings)==null?void 0:x.filter(Boolean))??[],m=(t.requestedMode??(r?"sample":"full"))==="full"&&t.mode!=="full",y=t.downgradeReason==="timeout"?"Full scan timed out":t.downgradeReason==="fallback"?"Full scan was not available":null,w=m?`${y??"Full scan fell back to a sample"} after processing ${t.processedRows.toLocaleString()} of ${t.totalRows.toLocaleString()} rows.`:null;return S.jsxs("div",{className:"mb-3 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600",children:[S.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[S.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-semibold border ${s}`,children:a}),S.jsx("span",{children:o}),u&&S.jsx("span",{className:"text-slate-400",children:""}),u&&S.jsx("span",{children:u}),d&&S.jsxs(S.Fragment,{children:[S.jsx("span",{className:"text-slate-400",children:""}),S.jsxs("span",{children:["Last run ",d]})]}),r&&S.jsxs(S.Fragment,{children:[S.jsx("span",{className:"text-slate-400",children:""}),S.jsx("span",{className:"text-xs text-slate-500",children:"Showing a quick preview. Full scan processes every row."})]}),r&&e&&!m&&S.jsx("button",{type:"button",onClick:()=>e(),disabled:n,className:"ml-auto inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-100 disabled:opacity-50",children:n?"Running":"Run full scan"})]}),w&&S.jsxs("div",{className:"mt-2 flex items-start gap-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800",children:[S.jsx(bR,{}),S.jsxs("span",{className:"flex-1",children:[w," ",e&&S.jsx("button",{type:"button",onClick:()=>e(),disabled:n,className:"ml-1 underline decoration-dotted hover:text-amber-900 disabled:opacity-50",children:n?"Retrying":"Retry full scan"})]})]}),c.length>0&&S.jsxs("div",{className:"mt-2 flex items-start gap-2 text-xs text-amber-700",children:[S.jsx(bR,{}),S.jsx("span",{className:"flex-1",children:c.join("  ")})]})]})},WW=({meta:t,plan:e})=>{if(!t)return null;const n=`${t.processedRows.toLocaleString()} / ${t.totalRows.toLocaleString()}`,r=t.filterCount&&t.filterCount>0?`${t.filterCount} ${t.filterCount===1?"filter":"filters"} applied`:"No filters applied",s=e.orderBy&&e.orderBy.length>0?e.orderBy.map(o=>`${o.column} ${(o.direction??"desc").toUpperCase()}`).join(", "):e.chartType==="line"&&e.groupByColumn?`${e.groupByColumn} ASC`:`${e.valueColumn??"count"} DESC`,a=typeof e.limit=="number"?`${e.limit.toLocaleString()} rows`:e.defaultTopN?`${e.defaultTopN.toLocaleString()} rows (default)`:"All rows";return S.jsx("div",{className:"mt-4 border-t border-slate-200 pt-3 text-xs text-slate-500",children:S.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-2",children:[S.jsxs("div",{children:[S.jsx("span",{className:"text-slate-400",children:"Rows processed"}),S.jsx("span",{className:"ml-1 font-semibold text-slate-700",children:n})]}),S.jsxs("div",{children:[S.jsx("span",{className:"text-slate-400",children:"Filters"}),S.jsx("span",{className:"ml-1 text-slate-700",children:r})]}),S.jsxs("div",{children:[S.jsx("span",{className:"text-slate-400",children:"Order"}),S.jsx("span",{className:"ml-1 text-slate-700",children:s})]}),S.jsxs("div",{children:[S.jsx("span",{className:"text-slate-400",children:"Limit"}),S.jsx("span",{className:"ml-1 text-slate-700",children:a})]})]})})},ZW=({filter:t})=>{const n=t.values.slice(0,3).map(o=>String(o)).join(", "),r=t.values.length-3,s=r>0?`${n} +${r}`:n,a=`Rows limited to ${t.column}  ${t.values.map(o=>String(o)).join(", ")}`;return S.jsxs("span",{className:"ml-2 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 border border-slate-200",title:a,children:["Filtered  ",t.column,": ",s]})},XW=({cardId:t})=>{var nn,rn;const e=tt(Oe=>Oe.analysisCards.find(lt=>lt.id===t)),{handleChartTypeChange:n,handleToggleDataVisibility:r,handleTopNChange:s,handleHideOthersChange:a,handleToggleLegendLabel:o,rerunAggregationForCard:u,linkChartSelectionToRawData:d,clearCardFilter:c}=tt(Oe=>({handleChartTypeChange:Oe.handleChartTypeChange,handleToggleDataVisibility:Oe.handleToggleDataVisibility,handleTopNChange:Oe.handleTopNChange,handleHideOthersChange:Oe.handleHideOthersChange,handleToggleLegendLabel:Oe.handleToggleLegendLabel,rerunAggregationForCard:Oe.rerunAggregationForCard,linkChartSelectionToRawData:Oe.linkChartSelectionToRawData,clearCardFilter:Oe.clearCardFilter})),p=de.useRef(null),m=de.useRef(null),[y,w]=de.useState(!1),[x,A]=de.useState([]),[E,C]=de.useState(!1),[D,O]=de.useState(!0),[T,I]=de.useState(!1);if(!e)return null;const{id:M,plan:N,aggregatedData:P,summary:k,displayChartType:$,isDataVisible:U,topN:F,hideOthers:K,disableAnimation:j,filter:V,hiddenLabels:B=[],aggregationMeta:G,valueSchema:Z}=e,se=k.split("---"),le=(nn=se[0])==null?void 0:nn.trim(),q=(rn=se[1])==null?void 0:rn.trim(),W=N.valueColumn||"count",ee=N.groupByColumn||"",ce=de.useMemo(()=>{let Oe=P;return V&&V.column&&V.values.length>0&&(Oe=Oe.filter(lt=>V.values.includes(lt[V.column]))),Oe},[P,V]),ie=de.useMemo(()=>N.chartType!=="scatter"&&ee&&F?LR(ce,ee,W,F):ce,[ce,N.chartType,ee,F,W]),fe=de.useMemo(()=>{let Oe=ie;return F&&K&&(Oe=Oe.filter(lt=>lt[ee]!=="Others")),ee&&(Oe=Oe.filter(lt=>!B.includes(String(lt[ee])))),Oe},[ie,F,K,ee,B]),Re=de.useMemo(()=>ce.reduce((Oe,lt)=>Oe+(Number(lt[W])||0),0),[ce,W]),Ge=async Oe=>{if(p.current){w(!0);try{switch(Oe){case"png":await GR(p.current,N.title);break;case"csv":HR(fe,N.title);break;case"html":await zR(p.current,N.title,fe,k);break;case"json":ML({plan:N,data:fe,aggregationMeta:G,schema:Z??[]});break}}finally{w(!1)}}},ze=(Oe,lt)=>{const Nn=lt.ctrlKey||lt.metaKey;A(ge=>Nn?(ge.includes(Oe)?ge.filter(Ee=>Ee!==Oe):[...ge,Oe]).sort((Ee,Ce)=>Ee-Ce):ge.includes(Oe)?[]:[Oe])},Ae=()=>{var Oe;return(Oe=m.current)==null?void 0:Oe.resetZoom()},Rt=()=>A([]),je=Oe=>{const lt=Oe.target.value==="all"?null:parseInt(Oe.target.value,10);s(M,lt)},dn=x.map(Oe=>fe[Oe]),ct=de.useCallback(async()=>{if(u){I(!0);try{await u(M,{mode:"full",allowFullScan:!0})}finally{I(!1)}}},[M,u]);return de.useEffect(()=>{if(!ee||x.length===0){d(M,null,[],N.title);return}const Oe=x.map(lt=>{var Nn;return(Nn=fe[lt])==null?void 0:Nn[ee]}).filter(lt=>lt!=null);if(Oe.length===0){d(M,null,[],N.title);return}return d(M,ee,Oe,N.title),()=>{d(M,null,[],N.title)}},[ee,x,fe,M,d,N.title]),S.jsxs("div",{ref:p,id:M,className:"bg-white rounded-lg shadow-lg p-4 flex flex-col transition-all duration-300 hover:shadow-blue-500/20 border border-slate-200 w-full",children:[S.jsxs("div",{className:"flex justify-between items-start gap-4 mb-2",children:[S.jsx("div",{className:"flex flex-col flex-1 min-w-0",children:S.jsxs("div",{className:"flex items-center flex-wrap",children:[S.jsx("h3",{className:"text-lg font-bold text-slate-900",children:N.title}),N.rowFilter&&S.jsx(ZW,{filter:N.rowFilter})]})}),S.jsxs("div",{className:"flex items-center bg-slate-100 rounded-md p-0.5 space-x-0.5 flex-shrink-0",children:[S.jsx(DL,{currentType:$,onChange:Oe=>n(M,Oe)}),S.jsxs("div",{className:"relative group",children:[S.jsx("button",{disabled:y,className:"p-1.5 text-slate-500 hover:text-slate-900 rounded-md transition-colors hover:bg-slate-200",children:S.jsx(zW,{})}),S.jsxs("div",{className:"absolute right-0 mt-2 w-36 bg-white border border-slate-200 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-none group-hover:pointer-events-auto",children:[S.jsx("a",{onClick:()=>Ge("png"),className:"block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 cursor-pointer rounded-t-md",children:"Export as PNG"}),S.jsx("a",{onClick:()=>Ge("csv"),className:"block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 cursor-pointer",children:"Export as CSV"}),S.jsx("a",{onClick:()=>Ge("html"),className:"block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 cursor-pointer",children:"Export as HTML"}),S.jsx("a",{onClick:()=>Ge("json"),className:"block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 cursor-pointer rounded-b-md",children:"Export as JSON"})]})]})]})]}),S.jsx("p",{className:"text-sm text-slate-500 mb-4",children:N.description}),S.jsx(KW,{meta:G,onRunFullScan:G!=null&&G.sampled?ct:void 0,isRefreshing:T}),S.jsxs("div",{className:"grid gap-4 flex-grow grid-cols-1",children:[S.jsxs("div",{className:"relative h-64",children:[S.jsx(wL,{ref:m,chartType:$,data:fe,plan:N,selectedIndices:x,onElementClick:ze,onZoomChange:C,disableAnimation:j}),S.jsxs("div",{className:"absolute top-1 right-1 flex items-center space-x-1",children:[x.length>0&&S.jsx("button",{onClick:Rt,title:"Clear selection",className:"p-1 bg-white/50 text-slate-600 rounded-full hover:bg-slate-100 hover:text-slate-800 transition-all backdrop-blur-sm",children:S.jsx(VW,{})}),E&&S.jsx("button",{onClick:Ae,title:"Reset zoom",className:"p-1 bg-white/50 text-slate-600 rounded-full hover:bg-slate-100 hover:text-slate-800 transition-all backdrop-blur-sm",children:S.jsx(jW,{})})]})]}),ee&&S.jsx("div",{className:"flex flex-col",children:S.jsx(LL,{data:ie,total:Re,groupByKey:ee,valueKey:W,hiddenLabels:B,onLabelClick:Oe=>o(M,Oe)})})]}),V&&S.jsx("div",{className:"text-xs text-yellow-800 bg-yellow-100 p-3 rounded-md my-3 border border-yellow-200",children:S.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[S.jsxs("span",{children:[S.jsx("b",{children:"AI Filter Active:"})," Showing where '",V.column,"' is '",V.values.join(", "),`'. Ask AI to "clear filter" or use the button to remove.`]}),S.jsx("button",{type:"button",onClick:()=>c(M),className:"px-3 py-1 text-xs font-semibold text-yellow-900 bg-white/70 border border-yellow-300 rounded-md hover:bg-white hover:border-yellow-400 transition",children:"Clear filter"})]})}),S.jsx("div",{className:"mt-4 border-t border-slate-200 pt-4",children:S.jsxs("div",{className:"bg-slate-50 p-3 rounded-md text-sm border border-slate-200",children:[S.jsxs("div",{className:"flex justify-between items-baseline mb-2",children:[S.jsx("p",{className:"font-semibold text-blue-600",children:"AI Summary"}),N.aggregation==="sum"&&S.jsxs("p",{className:"text-xs text-slate-500",children:["Total: ",S.jsx("span",{className:"font-bold text-base text-slate-800",children:Re.toLocaleString(void 0,{maximumFractionDigits:0})})]})]}),S.jsx("p",{className:"text-slate-700 text-xs",children:le}),q&&S.jsx("p",{className:"text-slate-500 mt-2 text-xs",children:q})]})}),S.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[S.jsx("div",{children:S.jsxs("button",{onClick:()=>r(M),className:"text-sm text-blue-600 hover:underline",children:[U?"Hide":"Show"," Full Data Table"]})}),N.chartType!=="scatter"&&P.length>5&&S.jsxs("div",{className:"flex items-center space-x-2",children:[S.jsx("label",{htmlFor:`top-n-${M}`,className:"text-xs text-slate-500",children:"Show"}),S.jsxs("select",{id:`top-n-${M}`,value:F||"all",onChange:je,className:"bg-white border border-slate-300 text-slate-800 text-xs rounded-md py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500",children:[S.jsx("option",{value:"all",children:"All"}),S.jsx("option",{value:"5",children:"Top 5"}),S.jsx("option",{value:"8",children:"Top 8"}),S.jsx("option",{value:"10",children:"Top 10"}),S.jsx("option",{value:"15",children:"Top 15"}),S.jsx("option",{value:"20",children:"Top 20"})]}),F&&S.jsx("div",{className:"flex items-center",children:S.jsxs("label",{htmlFor:`hide-others-${M}`,className:"flex items-center space-x-1.5 text-xs text-slate-500",children:[S.jsx("input",{type:"checkbox",id:`hide-others-${M}`,checked:K,onChange:Oe=>a(M,Oe.target.checked),className:"bg-slate-100 border-slate-300 rounded focus:ring-blue-500 text-blue-600 h-3.5 w-3.5"}),S.jsx("span",{children:'Hide "Others"'})]})})]})]}),x.length>0&&S.jsxs("div",{className:"mt-4 bg-slate-50 p-3 rounded-md text-sm border border-slate-200",children:[S.jsxs("button",{onClick:()=>O(!D),className:"w-full text-left font-semibold text-blue-600 mb-1",children:[D?"":""," Selection Details (",x.length," items)"]}),D&&S.jsx(Af,{data:dn,schema:Z})]}),U&&S.jsx("div",{className:"mt-2 max-h-48 overflow-y-auto border border-slate-200 rounded-md",children:S.jsx(Af,{data:fe,schema:Z})}),S.jsx(WW,{meta:G,plan:N})]})},QW=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 inline-block mr-2 text-blue-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:"2",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})}),eZ=({summary:t})=>S.jsxs("div",{className:"bg-white border border-slate-200 rounded-lg shadow-lg p-6 mb-6",children:[S.jsxs("h2",{className:"text-xl font-bold text-slate-900 mb-3 flex items-center",children:[S.jsx(QW,{}),"Overall Insights"]}),S.jsx("p",{className:"text-slate-700 whitespace-pre-wrap leading-relaxed",children:t})]}),h0=[1,2,3],tZ=({isManual:t,statusLabel:e,selectedCount:n,onToggleMode:r,onSelectManualCount:s})=>S.jsx("div",{className:"flex justify-end",children:S.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-2xl border border-slate-200 bg-white/80 px-4 py-3 shadow-sm",children:[S.jsxs("div",{className:"text-right",children:[S.jsx("p",{className:"text-sm font-semibold text-slate-600",children:"Cards per row"}),S.jsx("p",{className:"text-xs text-slate-400",children:e})]}),S.jsx("button",{type:"button",onClick:r,className:`rounded-full border px-3 py-1.5 text-xs font-semibold transition ${t?"border-amber-300 bg-amber-50 text-amber-700":"border-slate-200 bg-white text-slate-500 hover:bg-slate-50"}`,children:t?"Switch to Auto":"Manual override"}),S.jsx("div",{className:"inline-flex overflow-hidden rounded-xl border border-slate-200 bg-white shadow-inner",children:h0.map(a=>{const o=n===a;return S.jsx("button",{type:"button",onClick:()=>t&&s(a),disabled:!t,className:`px-4 py-1.5 text-sm font-semibold transition-colors ${o?"bg-slate-100 text-slate-900":"text-slate-500 hover:bg-slate-50"} ${t?"":"cursor-not-allowed opacity-60"}`,"aria-pressed":o,title:t?void 0:"Auto layout is active. Enable manual override to pick.",children:a},a)})})]})}),SR=t=>`${(t*100).toFixed(1)}%`,nZ=()=>{const t=tt(a=>a.datasetProfile),[e,n]=de.useState(!1);if(!t)return null;const r=t.rowCount>0?Math.min(1,t.sampledRows/t.rowCount):1,s=r===1;return S.jsxs("div",{className:"bg-white border border-slate-200 rounded-lg shadow-sm",children:[S.jsxs("button",{type:"button",onClick:()=>n(a=>!a),className:"w-full flex items-center justify-between px-4 py-3 text-left",children:[S.jsxs("div",{children:[S.jsxs("div",{className:"text-sm font-semibold text-slate-800 flex items-center gap-2",children:[S.jsx("span",{className:"text-base",children:""}),S.jsx("span",{children:"Data Profile"})]}),S.jsx("p",{className:"text-xs text-slate-500 mt-0.5",children:s?"Full dataset profiled.":`Sampled ${t.sampledRows.toLocaleString()} of ${t.rowCount.toLocaleString()} rows (${SR(r)}).`})]}),S.jsx("span",{className:"text-sm text-slate-500",children:e?"Hide":"Show"})]}),e&&S.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[S.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 text-xs",children:[S.jsxs("div",{className:"bg-slate-50 rounded-md p-3 border border-slate-100",children:[S.jsx("p",{className:"text-slate-500",children:"Total rows"}),S.jsx("p",{className:"text-lg font-semibold text-slate-900",children:t.rowCount.toLocaleString()})]}),S.jsxs("div",{className:"bg-slate-50 rounded-md p-3 border border-slate-100",children:[S.jsx("p",{className:"text-slate-500",children:"Sampled rows"}),S.jsx("p",{className:"text-lg font-semibold text-slate-900",children:t.sampledRows.toLocaleString()})]}),S.jsxs("div",{className:"bg-slate-50 rounded-md p-3 border border-slate-100",children:[S.jsx("p",{className:"text-slate-500",children:"Columns"}),S.jsx("p",{className:"text-lg font-semibold text-slate-900",children:t.columns.length})]}),S.jsxs("div",{className:"bg-slate-50 rounded-md p-3 border border-slate-100",children:[S.jsx("p",{className:"text-slate-500",children:"Profile Scope"}),S.jsx("p",{className:"text-lg font-semibold text-slate-900",children:s?"Full":"Sample"})]})]}),S.jsx("div",{className:"overflow-x-auto border border-slate-100 rounded-md",children:S.jsxs("table",{className:"min-w-full text-xs",children:[S.jsx("thead",{className:"bg-slate-100 text-slate-600",children:S.jsxs("tr",{children:[S.jsx("th",{className:"p-2 text-left font-semibold",children:"Column"}),S.jsx("th",{className:"p-2 text-left font-semibold",children:"Type"}),S.jsx("th",{className:"p-2 text-left font-semibold",children:"Distinct"}),S.jsx("th",{className:"p-2 text-left font-semibold",children:"Missing"}),S.jsx("th",{className:"p-2 text-left font-semibold",children:"Examples"})]})}),S.jsx("tbody",{children:t.columns.map(a=>{var o;return S.jsxs("tr",{className:"border-t border-slate-100",children:[S.jsx("td",{className:"p-2 font-medium text-slate-800",children:a.name}),S.jsx("td",{className:"p-2 text-slate-600 capitalize",children:a.type}),S.jsx("td",{className:"p-2 text-slate-600",children:((o=a.distinct)==null?void 0:o.toLocaleString())??""}),S.jsx("td",{className:"p-2 text-slate-600",children:typeof a.emptyPercentage=="number"?SR(a.emptyPercentage/100):""}),S.jsx("td",{className:"p-2 text-slate-600",children:a.examples&&a.examples.length>0?a.examples.slice(0,3).join(", "):""})]},a.name)})})]})}),t.warnings.length>0&&S.jsxs("div",{className:"text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-md p-3",children:[S.jsx("p",{className:"font-semibold mb-1",children:"Warnings"}),S.jsx("ul",{className:"list-disc list-inside space-y-1",children:t.warnings.map((a,o)=>S.jsx("li",{children:a},`warning-${o}`))})]})]})]})},rZ=h0[h0.length-1],sZ=[{minWidth:1280,columns:3},{minWidth:720,columns:2},{minWidth:0,columns:1}],aZ=t=>{if(!t)return 1;for(const e of sZ)if(t>=e.minWidth)return Math.min(rZ,e.columns);return 1},iZ=()=>{const t=tt(y=>y.analysisCards),e=tt(y=>y.finalSummary),n=de.useRef(null),r=de.useRef(null),[s,a]=de.useState(1),[o,u]=de.useState(2),[d,c]=de.useState(!1),p=d?o:s;de.useLayoutEffect(()=>{if(d)return;const y=n.current;if(!y)return;const w=A=>{r.current!==null&&cancelAnimationFrame(r.current),r.current=requestAnimationFrame(()=>{r.current=null,a(E=>{const C=aZ(A);return E===C?E:C})})};if(w(y.getBoundingClientRect().width),typeof ResizeObserver<"u"){const A=new ResizeObserver(E=>{var C;for(const D of E)if(D.target===y){const O=((C=D.contentRect)==null?void 0:C.width)??y.getBoundingClientRect().width;w(O)}});return A.observe(y),()=>{A.disconnect(),r.current!==null&&cancelAnimationFrame(r.current)}}const x=()=>{w(y.getBoundingClientRect().width)};return window.addEventListener("resize",x),()=>{window.removeEventListener("resize",x),r.current!==null&&cancelAnimationFrame(r.current)}},[d,t.length]);const m=()=>{c(y=>(y||u(p),!y))};return t.length===0?S.jsx("div",{className:"flex items-center justify-center h-full",children:S.jsxs("div",{className:"text-center p-4",children:[S.jsx("p",{className:"text-slate-500",children:"Your analysis results will appear here."}),S.jsx("p",{className:"text-slate-400 text-sm mt-2",children:"The AI is generating the initial analysis..."})]})}):S.jsxs("div",{className:"p-1",ref:n,children:[S.jsxs("div",{className:"mb-6 space-y-4",children:[S.jsx(nZ,{}),e&&S.jsx("div",{children:S.jsx(eZ,{summary:e})}),S.jsx(tZ,{isManual:d,statusLabel:d?"Manual control enabled":"Auto based on panel width",selectedCount:p,onToggleMode:m,onSelectManualCount:y=>u(y)})]}),S.jsx("div",{className:"mt-6",children:S.jsx(NR,{breakpointCols:p,className:"flex w-auto -ml-6",columnClassName:"pl-6 space-y-6",children:t.map(y=>S.jsx("div",{className:"analysis-card",children:S.jsx(XW,{cardId:y.id})},y.id))})})]})};function Up(t,e){if(Object.is(t,e))return!0;if(typeof t!="object"||t===null||typeof e!="object"||e===null)return!1;if(t instanceof Map&&e instanceof Map){if(t.size!==e.size)return!1;for(const[r,s]of t)if(!Object.is(s,e.get(r)))return!1;return!0}if(t instanceof Set&&e instanceof Set){if(t.size!==e.size)return!1;for(const r of t)if(!e.has(r))return!1;return!0}const n=Object.keys(t);if(n.length!==Object.keys(e).length)return!1;for(const r of n)if(!Object.prototype.hasOwnProperty.call(e,r)||!Object.is(t[r],e[r]))return!1;return!0}const oZ=240,lZ=(t,e,n)=>{const{maxHeight:r=oZ,minHeight:s=0}=n??{};de.useLayoutEffect(()=>{const a=t.current;if(!a)return;a.style.height="auto";const o=a.scrollHeight,u=Math.min(Math.max(o,s),r);a.style.height=`${u}px`,a.style.overflowY=o>r?"auto":"hidden"},[t,e,r,s])},uZ=({promptId:t,message:e,onSubmit:n,disabled:r=!1,isActive:s})=>{const a=de.useMemo(()=>pP(e),[e]),[o,u]=de.useState(""),[d,c]=de.useState(!1),p=r||d,m=w=>{const x=w.trim();x&&(c(!0),n(x))},y=w=>{w.preventDefault(),!(!o.trim()||p)&&(m(o),u(""))};return S.jsxs("div",{className:`rounded-md border px-3 py-2 ${s?"border-blue-300 bg-blue-50":"border-slate-200 bg-slate-50"} transition-colors`,children:[S.jsxs("div",{className:"flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-500 mb-2",children:[S.jsxs("span",{children:["Prompt ",t]}),d&&S.jsx("span",{className:"text-emerald-600 font-semibold",children:"Sent"})]}),a.length>0&&S.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:a.map(w=>S.jsx("button",{type:"button",onClick:()=>m(w),disabled:p,className:`text-xs px-3 py-1 rounded-full border ${p?"text-slate-400 border-slate-200 bg-white cursor-not-allowed":"text-blue-700 border-blue-200 bg-white hover:bg-blue-100"} transition-colors`,children:w},`${t}-${w}`))}),S.jsxs("form",{onSubmit:y,className:"flex items-center gap-2",children:[S.jsx("input",{type:"text",value:o,onChange:w=>u(w.target.value),placeholder:"Type a custom answer",disabled:p,className:"flex-grow rounded-md border border-slate-200 px-2 py-1 text-sm text-slate-700 placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-slate-100"}),S.jsx("button",{type:"submit",disabled:p||!o.trim(),className:"text-xs font-semibold px-3 py-1 rounded-md bg-blue-600 text-white disabled:bg-slate-300 disabled:text-slate-500 transition-colors",children:"Send"})]})]})},cZ=({prompt:t,onSelect:e,onSubmitFreeText:n,disabled:r,waitingHint:s,reasonText:a,latestObservation:o})=>{const[u,d]=de.useState(""),c=p=>{p.preventDefault(),!(!u.trim()||r)&&(n(u.trim()),d(""))};return S.jsxs("div",{className:"bg-white border border-amber-200 rounded-xl p-4 shadow-sm space-y-3",children:[S.jsxs("div",{className:"flex items-center gap-2 text-amber-800",children:[S.jsx("span",{className:"text-xl",children:""}),S.jsxs("div",{children:[S.jsx("p",{className:"text-sm font-semibold",children:""}),S.jsx("p",{className:"text-base font-bold",children:t.question}),a&&S.jsx("p",{className:"text-xs text-amber-600 mt-1",children:a})]})]}),o&&S.jsxs("div",{className:"border border-amber-100 bg-amber-50 rounded-lg p-3 text-xs text-amber-800 space-y-1",children:[S.jsxs("p",{className:"font-semibold flex items-center gap-1",children:[S.jsx("span",{children:""}),S.jsxs("span",{children:["",o.title]})]}),o.detail&&S.jsx("p",{className:"text-amber-700",children:o.detail}),o.meta&&S.jsx("p",{className:"text-[11px] text-amber-600",children:o.meta})]}),S.jsx("div",{className:"flex flex-wrap gap-2",children:t.options.map(p=>S.jsx("button",{type:"button",onClick:()=>e(p.id),disabled:r,className:"px-3 py-2 rounded-lg border border-amber-300 bg-amber-50 text-amber-800 text-sm font-semibold hover:bg-amber-100 disabled:opacity-50 disabled:cursor-not-allowed",children:p.label},p.id))}),t.allowFreeText&&S.jsxs("form",{onSubmit:c,className:"flex gap-2 items-center",children:[S.jsx("input",{value:u,onChange:p=>d(p.target.value),placeholder:t.placeholder??"",disabled:r,className:"flex-1 border border-amber-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-300 disabled:opacity-50"}),S.jsx("button",{type:"submit",disabled:!u.trim()||r,className:"px-3 py-2 rounded-lg bg-amber-500 text-white text-sm font-semibold hover:bg-amber-600 disabled:opacity-50 disabled:cursor-not-allowed",children:""})]}),s&&S.jsx("p",{className:"text-xs text-amber-600",children:s})]})},dZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),fZ=()=>S.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]}),pZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:S.jsx("path",{d:"M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"})}),hZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{d:"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"})}),mZ=()=>S.jsxs("svg",{className:"animate-spin h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[S.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),S.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),xR=(t,e=60)=>t.length>e?`${t.slice(0,e)}`:t,gZ=/card-\d+-[0-9.]+/g,yZ=t=>{if(!t)return[];const e=t.match(gZ);return e?Array.from(new Set(e)):[]},TR=240,_Z=iP(),vZ=1e4,wZ=[{id:"upload_csv",label:" CSV  Upload a CSV",intent:"conversation",status:"waiting_user"},{id:"describe_goal",label:"  Describe your KPI",intent:"conversation",status:"waiting_user"}],bZ=()=>tt(t=>{var e;return{progressMessages:t.progressMessages,chatHistory:t.chatHistory,isBusy:t.isBusy,handleChatMessage:t.handleChatMessage,isApiKeySet:t.isApiKeySet,setIsAsideVisible:t.setIsAsideVisible,setIsSettingsModalOpen:t.setIsSettingsModalOpen,setIsMemoryPanelOpen:t.setIsMemoryPanelOpen,handleShowCardFromChat:t.handleShowCardFromChat,currentView:t.currentView,pendingClarifications:t.pendingClarifications,activeClarificationId:t.activeClarificationId,handleClarificationResponse:t.handleClarificationResponse,skipClarification:t.skipClarification,columnProfiles:t.columnProfiles,csvData:t.csvData,focusDataPreview:t.focusDataPreview,isCancellationRequested:t.isCancellationRequested,chatMemoryPreview:t.chatMemoryPreview,chatMemoryExclusions:t.chatMemoryExclusions,previewChatMemories:t.previewChatMemories,toggleMemoryPreviewSelection:t.toggleMemoryPreviewSelection,isMemoryPreviewLoading:t.isMemoryPreviewLoading,agentAwaitingUserInput:t.agentAwaitingUserInput,agentAwaitingPromptId:t.agentAwaitingPromptId,executeQuickAction:t.executeQuickAction,graphAwaitPrompt:t.graphAwaitPrompt,graphAwaitPromptId:t.graphAwaitPromptId,graphAwaitReason:t.graphAwaitReason,graphAwaitHistory:t.graphAwaitHistory,graphToolInFlight:t.graphToolInFlight,sendGraphUserReply:t.sendGraphUserReply,runGraphPipeline:t.runGraphPipeline,addProgress:t.addProgress,graphObservations:t.graphObservations,planState:((e=t.plannerSession)==null?void 0:e.planState)??null,samplePolicy:t.samplePolicy,requestSampleUpgrade:t.requestSampleUpgrade,planValidationNotices:t.planValidationNotices,dismissPlanValidationNotice:t.dismissPlanValidationNotice,activeSchemaPhase:t.activeSchemaPhase}},Up),SZ=()=>{var Hi;const t=bZ(),{progressMessages:e,chatHistory:n,isBusy:r,handleChatMessage:s,isApiKeySet:a,setIsAsideVisible:o,setIsSettingsModalOpen:u,setIsMemoryPanelOpen:d,handleShowCardFromChat:c,currentView:p,pendingClarifications:m,activeClarificationId:y,handleClarificationResponse:w,skipClarification:x,columnProfiles:A,csvData:E,focusDataPreview:C,isCancellationRequested:D,chatMemoryPreview:O,chatMemoryExclusions:T,previewChatMemories:I,toggleMemoryPreviewSelection:M,isMemoryPreviewLoading:N,agentAwaitingUserInput:P,agentAwaitingPromptId:k,executeQuickAction:$,graphAwaitPrompt:U,graphAwaitPromptId:F,graphAwaitReason:K,graphAwaitHistory:j,graphToolInFlight:V,sendGraphUserReply:B,runGraphPipeline:G,addProgress:Z,graphObservations:se,planState:le,samplePolicy:q,requestSampleUpgrade:W,planValidationNotices:ee,dismissPlanValidationNotice:ce,activeSchemaPhase:ie}=t,[fe,Re]=de.useState(""),[Ge,ze]=de.useState(null),[Ae,Rt]=de.useState({}),[je,dn]=de.useState(null),ct=de.useRef(F),nn=de.useRef(null),rn=de.useRef(null);lZ(rn,fe,{maxHeight:TR});const Oe=de.useCallback(pe=>{if(!pe)return"";const Je=new Date(pe);return Number.isNaN(Je.getTime())?"":Je.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},[]),lt=r||!!V;de.useMemo(()=>F?j.find(pe=>pe.promptId===F)??null:null,[j,F]);const Nn=de.useMemo(()=>j.length?[...j].slice(-3).reverse():[],[j]);de.useMemo(()=>{for(let pe=j.length-1;pe>=0;pe-=1)if(j[pe].status==="answered")return j[pe];return null},[j]);const ge=V?` ${V.label} `:je,Ct=de.useMemo(()=>(le==null?void 0:le.nextSteps)??[],[le]),Ee=de.useMemo(()=>((le==null?void 0:le.steps)??[]).some(pe=>pe.status==="waiting_user"),[le]),Ce=de.useMemo(()=>le!=null&&le.currentStepId?le.currentStepId.startsWith("acknowledge_user"):!1,[le]),_e=de.useMemo(()=>typeof(le==null?void 0:le.blockedBy)=="string"&&le.blockedBy.includes("await"),[le]),ve=!!(le&&(P||Ee||Ce||_e)),ye=Ct.length>0?Ct:wZ,Be=ve&&le!=null&&Ct.length===0,De=de.useMemo(()=>!se||se.length===0?null:Hk(se[se.length-1]),[se]),fn=De?{title:De.title,detail:De.detail??void 0,meta:De.metaLine??void 0}:void 0,fs=m.some(pe=>pe.status==="pending"),Ka=de.useMemo(()=>[...n].sort((pe,Je)=>pe.timestamp.getTime()-Je.timestamp.getTime()),[n]),_c=(E==null?void 0:E.data)??[],Ks=de.useMemo(()=>{if(!A||A.length===0)return[];const pe=fv(A,_c);return pe.length>0?pe:A.filter(Je=>["categorical","date","time"].includes(Je.type)).map(Je=>({profile:Je,uniqueValues:typeof Je.uniqueValues=="number"?Je.uniqueValues:0}))},[A,_c]);de.useEffect(()=>{if(!F){dn(null),ct.current&&(Z(" "),G({reason:"auto_resume"})),ct.current=null;return}F!==ct.current&&(Z(" Graph "),ct.current=F),dn(null);const pe=window.setTimeout(()=>{dn("")},vZ);return()=>{window.clearTimeout(pe)}},[F,Z,G]);const _n=de.useCallback(pe=>{const Je=pe.trim();Je&&s(Je)},[s]),Jr=de.useCallback(pe=>{var Nt;const Je=((Nt=U==null?void 0:U.options.find(sn=>sn.id===pe))==null?void 0:Nt.label)??pe,zt=U!=null&&U.question?`${U.question}`:"";Z(` ${Je}${zt}`),B(pe,void 0)},[B,Z,U]),Pn=de.useCallback(pe=>{const Je=pe.trim();if(!Je)return;const zt=U!=null&&U.question?`${U.question}`:"";Z(` ${Je}${zt}`),B(void 0,Je)},[B,Z,U]),ml=!a||r,Fp=de.useMemo(()=>{switch(ie){case"plan":return"Step 1  Planner Schema";case"act":return"Step 3  Act Schema";default:return"Step 2  Talk Schema"}},[ie]),vc=q.tiers[q.currentIndex]??null,Bi=vc===null?"Full dataset":`${vc.toLocaleString()} `,qi=q.currentIndex<q.tiers.length-1&&!r&&a,Wa=de.useMemo(()=>[...ee].slice(-3).reverse(),[ee]),ps=de.useCallback(pe=>{if(ml)return;const Je=`[plan_step:${pe.id}] ${pe.label}`;Z(` ${pe.label} (stepId=${pe.id})`),_n(Je)},[ml,Z,_n]),Gi=de.useCallback((pe,Je)=>{const zt=Je.trim();if(!zt||r||!a)return;const Nt=pe?`[prompt:${pe}] ${zt}`:zt;s(Nt)},[s,r,a]),Za=O.filter(pe=>!T.includes(pe.id)).length,Bp=O.length>0;y??((Hi=m.find(pe=>pe.status==="pending"))==null||Hi.id);const wc=()=>{var pe;(pe=nn.current)==null||pe.scrollIntoView({behavior:"smooth"})},gl=(pe,Je)=>{Rt(zt=>({...zt,[pe]:Je}))},Xa=pe=>{const Je=Ae[pe];Je&&w(pe,{label:`Manual grouping: ${Je}`,value:Je})},qp=async pe=>{if(!Ge){ze(pe);try{await $(pe)}finally{ze(null)}}};de.useEffect(wc,[Ka]),de.useEffect(()=>{const pe=fe.trim();if(!pe){I("");return}const Je=window.setTimeout(()=>{I(pe)},400);return()=>window.clearTimeout(Je)},[fe,I]);const yl=pe=>{pe.preventDefault(),fe.trim()&&!r&&(_n(fe),Re(""))},bc=pe=>{pe.key==="Enter"&&!pe.shiftKey&&yl(pe)},Sc=()=>{if(!a)return"Set API Key in settings to chat";if(fs)return"Please resolve or skip the clarification above";if(P)return"Answer the AI question above to resume";switch(p){case"analysis_dashboard":return"New analysis or transformation?";case"file_upload":default:return"Upload a file to begin chatting"}},_l=(pe,Je)=>{var zt,Nt,sn;if("sender"in pe){const Ie=pe;if(Ie.type==="ai_clarification"&&Ie.clarificationRequest){const gt=m.find(Bt=>Bt.id===Ie.clarificationRequest.id),Cr=(gt==null?void 0:gt.status)??"resolved",Qa=Cr==="pending",Zs=Cr==="resolving",ei=(Qa||Zs)&&(gt==null?void 0:gt.id)===y,Xs=gt?Cr==="pending":!1,Qs=Ie.clarificationRequest.targetProperty==="groupByColumn",ea=Ae[Ie.clarificationRequest.id]??"",ta=Qs&&Ks.length>0,Kt={pending:ei?"bg-blue-100 text-blue-800 border-blue-200":"bg-slate-100 text-slate-600 border-slate-200",resolving:"bg-amber-100 text-amber-800 border-amber-200",resolved:"bg-emerald-100 text-emerald-800 border-emerald-200",skipped:"bg-slate-200 text-slate-500 border-slate-300"},xc=`clarification-${(gt==null?void 0:gt.id)??Ie.clarificationRequest.id}`,Tc=Cr==="pending"?ei?"Active":"Queued":Cr==="resolving"?"Working":Cr==="skipped"?"Skipped":"Answered";return S.jsxs("div",{id:xc,className:`my-2 p-3 bg-white border rounded-lg transition-colors ${ei?"border-blue-400 shadow shadow-blue-100":"border-blue-200"} ${Cr==="resolved"?"opacity-90":""} ${Cr==="skipped"?"opacity-60":""}`,children:[S.jsxs("div",{className:"flex items-center justify-between mb-2",children:[S.jsxs("div",{className:"flex items-center text-blue-700",children:[S.jsx("span",{className:"text-lg mr-2",children:""}),S.jsx("h4",{className:"font-semibold",children:"Clarification Needed"})]}),S.jsx("span",{className:`text-xs px-2 py-1 border rounded-full ${Kt[Cr]??"bg-slate-100 text-slate-600 border-slate-200"}`,children:Tc})]}),S.jsx("p",{className:"text-sm text-slate-700 mb-1",children:Ie.clarificationRequest.question}),Ie.clarificationRequest.reasonHint&&S.jsx("p",{className:"text-xs text-slate-500 mb-2",children:Ie.clarificationRequest.reasonHint}),Ie.clarificationRequest.columnHints&&Ie.clarificationRequest.columnHints.length>0&&S.jsxs("p",{className:"text-xs text-slate-500 mb-2",children:["Column context: ",Ie.clarificationRequest.columnHints.join(", ")]}),S.jsx("div",{className:"flex flex-col space-y-2",children:Ie.clarificationRequest.options.map(Bt=>S.jsxs("button",{onClick:()=>w(Ie.clarificationRequest.id,Bt),disabled:!Qa||r,className:"w-full text-left text-sm px-3 py-2 bg-slate-100 rounded-md hover:bg-blue-100 hover:border-blue-500 border border-slate-200 transition-colors disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:bg-slate-100",children:[S.jsx("span",{className:"font-medium text-slate-800",children:Bt.label}),S.jsxs("span",{className:"block text-xs text-slate-500",children:["Column: ",Bt.value]})]},`${Ie.clarificationRequest.id}-${Bt.value}`))}),ta&&S.jsxs("div",{className:"mt-3 border-t border-slate-200 pt-3",children:[S.jsx("p",{className:"text-xs text-slate-500 mb-2",children:"  / Pick a grouping column manually"}),S.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[S.jsxs("select",{className:"flex-1 border border-slate-200 rounded-md px-3 py-2 text-sm text-slate-700 bg-white",value:ea,onChange:Bt=>gl(Ie.clarificationRequest.id,Bt.target.value),disabled:!Qa||Zs,children:[S.jsx("option",{value:"",children:" / Choose a grouping column"}),Ks.map(Bt=>S.jsxs("option",{value:Bt.profile.name,children:[Bt.profile.name,Bt.uniqueValues?` (${Bt.uniqueValues} distinct)`:" (distinct unknown)"]},`${Ie.clarificationRequest.id}-${Bt.profile.name}`))]}),S.jsx("button",{onClick:()=>Xa(Ie.clarificationRequest.id),disabled:!Qa||r||!ea,className:"text-sm px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:" / Use column"})]})]}),S.jsx("div",{className:"flex justify-end mt-3",children:S.jsx("button",{onClick:()=>x(Ie.clarificationRequest.id),disabled:!Xs,className:"text-xs text-slate-500 hover:text-red-600 border border-slate-200 px-3 py-1 rounded-md transition-colors disabled:opacity-40 disabled:cursor-not-allowed",children:"Skip / Cancel"})})]},`chat-${Je}`)}if(Ie.type==="ai_plan_start")return S.jsxs("div",{className:"my-2 p-3 bg-slate-100 border border-slate-200 rounded-lg",children:[S.jsxs("div",{className:"flex items-center text-slate-700 mb-2",children:[S.jsx("span",{className:"text-lg mr-2",children:""}),S.jsx("h4",{className:"font-semibold",children:"Plan Execution"})]}),S.jsx("p",{className:"text-sm text-slate-700 whitespace-pre-wrap",children:Ie.text})]},`chat-${Je}`);if(Ie.type==="ai_thinking")return S.jsxs("div",{className:"my-2 p-3 bg-white border border-blue-200 rounded-lg",children:[S.jsxs("div",{className:"flex items-center text-blue-700 mb-2",children:[S.jsx("span",{className:"text-lg mr-2",children:""}),S.jsx("h4",{className:"font-semibold",children:"AI's Initial Analysis"})]}),S.jsx("p",{className:"text-sm text-slate-700 whitespace-pre-wrap",children:Ie.text})]},`chat-${Je}`);if(Ie.type==="ai_proactive_insight")return S.jsxs("div",{className:"my-2 p-3 bg-yellow-50 border border-yellow-300 rounded-lg",children:[S.jsxs("div",{className:"flex items-center text-yellow-800 mb-2",children:[S.jsx("span",{className:"text-lg mr-2",children:""}),S.jsx("h4",{className:"font-semibold",children:"Proactive Insight"})]}),S.jsx("p",{className:"text-sm text-slate-700 whitespace-pre-wrap",children:Ie.text}),Ie.cardId&&S.jsx("button",{onClick:()=>c(Ie.cardId),className:"mt-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-md hover:bg-yellow-200 transition-colors w-full text-left font-medium",children:" Show Related Card"})]},`chat-${Je}`);if(Ie.sender==="user")return S.jsx("div",{className:"flex justify-end",children:S.jsx("div",{className:"bg-blue-600 rounded-lg px-3 py-2 max-w-xs lg:max-w-md",children:S.jsx("p",{className:"text-sm text-white",style:{whiteSpace:"break-spaces"},children:Ie.text})})},`chat-${Je}`);const Ws=[];return Ie.isError||(Ie.cardId&&Ws.push(Ie.cardId),yZ(Ie.text).forEach(gt=>{Ws.includes(gt)||Ws.push(gt)})),S.jsx("div",{className:"flex",children:S.jsxs("div",{className:`rounded-lg px-3 py-2 max-w-xs lg:max-w-md ${Ie.isError?"bg-red-100":"bg-slate-200"}`,children:[S.jsx("p",{className:`text-sm ${Ie.isError?"text-red-800":"text-slate-800"}`,style:{whiteSpace:"break-spaces"},children:Ie.text}),!Ie.isError&&Ws.map(gt=>S.jsxs("button",{onClick:()=>c(gt),className:"mt-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-md hover:bg-blue-200 transition-colors w-full text-left font-medium",children:[" Show Related Card (",gt,")"]},`${gt}-${Je}`)),((zt=Ie.cta)==null?void 0:zt.type)==="open_data_preview"&&S.jsxs("button",{onClick:C,className:"mt-2 text-xs bg-white text-blue-700 border border-blue-200 px-2 py-1 rounded-md hover:bg-blue-50 transition-colors w-full text-left font-medium",children:[" ",Ie.cta.label,Ie.cta.helperText&&S.jsx("span",{className:"block text-[11px] text-slate-500 mt-0.5",children:Ie.cta.helperText})]}),Ie.quickActions&&S.jsxs("div",{className:"mt-3 border border-slate-300 rounded-lg bg-white p-3 space-y-2",children:[S.jsxs("div",{children:[S.jsx("p",{className:"text-xs font-semibold text-slate-700",children:Ie.quickActions.title??"Quick start actions"}),Ie.quickActions.helperText&&S.jsx("p",{className:"text-[11px] text-slate-500 mt-0.5",children:Ie.quickActions.helperText})]}),S.jsx("div",{className:"space-y-2",children:Ie.quickActions.actions.map(gt=>S.jsxs("button",{onClick:()=>qp(gt.id),disabled:!!Ge,className:"w-full text-left rounded-md border border-slate-200 bg-blue-50 px-3 py-2 text-sm text-blue-900 hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed",children:[S.jsx("span",{className:"font-semibold block",children:gt.label}),gt.helperText&&S.jsx("span",{className:"text-xs text-blue-700 block",children:gt.helperText})]},`${gt.id}-${Je}`))})]}),Ie.usedMemories&&Ie.usedMemories.length>0&&S.jsxs("div",{className:"mt-2 border border-blue-100 bg-white rounded-md p-2",children:[S.jsxs("p",{className:"text-[11px] font-semibold text-blue-700 mb-1",children:["Used memory (",Ie.usedMemories.length,")"]}),S.jsx("div",{className:"flex flex-wrap gap-1",children:Ie.usedMemories.map(gt=>S.jsx("span",{className:"text-[11px] text-slate-600 bg-blue-50 border border-blue-100 rounded-full px-2 py-0.5",children:xR(gt.text,48)},gt.id))})]}),((Nt=Ie.meta)==null?void 0:Nt.awaitUser)&&((sn=Ie.meta)==null?void 0:sn.promptId)&&S.jsx("div",{className:"mt-3",children:S.jsx(uZ,{promptId:Ie.meta.promptId,message:Ie.text,onSubmit:gt=>Gi(Ie.meta.promptId,gt),disabled:!a||r&&!P,isActive:!k||k===Ie.meta.promptId})})]})},`chat-${Je}`)}};return S.jsxs("div",{className:"flex flex-col h-full bg-slate-100 rounded-lg md:rounded-none",children:[S.jsxs("div",{className:"p-4 border-b border-slate-200 flex justify-between items-center relative",children:[S.jsx("h2",{className:"text-xl font-semibold text-slate-900",children:"Assistant"}),S.jsxs("div",{className:"flex items-center space-x-3",children:[S.jsx("button",{onClick:()=>d(!0),className:"p-1 text-slate-500 rounded-full hover:bg-slate-200 hover:text-slate-800 transition-colors",title:"View AI Memory","aria-label":"View AI Memory",children:S.jsx(pZ,{})}),_Z.showSettingsButton&&S.jsx("button",{onClick:()=>u(!0),className:"p-1 text-slate-500 rounded-full hover:bg-slate-200 hover:text-slate-800 transition-colors",title:"Settings","aria-label":"Open Settings",children:S.jsx(fZ,{})}),S.jsx("button",{onClick:()=>o(!1),className:"p-1 text-slate-500 rounded-full hover:bg-slate-200 hover:text-slate-800 transition-colors",title:"Hide Panel","aria-label":"Hide Assistant Panel",children:S.jsx(dZ,{})})]})]}),S.jsxs("div",{className:"flex-1 p-4 overflow-y-auto space-y-4",children:[S.jsxs("div",{className:"space-y-2",children:[S.jsxs("div",{className:"rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-sm text-blue-800",children:[S.jsx("div",{className:"font-semibold",children:Fp}),(le==null?void 0:le.goal)&&S.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["",le.goal]})]}),S.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700",children:[S.jsxs("div",{children:[S.jsx("div",{className:"font-semibold text-slate-900",children:""}),S.jsx("div",{className:"text-xs text-slate-500",children:Bi})]}),S.jsx("button",{type:"button",onClick:()=>W("user_confirm"),disabled:!qi,className:"rounded-md bg-blue-600 px-3 py-1 text-xs font-semibold text-white shadow-sm transition disabled:opacity-40 disabled:cursor-not-allowed",children:""})]}),Wa.length>0&&S.jsx("div",{className:"space-y-2",children:Wa.map(pe=>S.jsxs("div",{className:"flex items-start gap-2 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-900",children:[S.jsxs("div",{children:[S.jsxs("span",{className:"font-semibold",children:[pe.planTitle,""]}),pe.message]}),S.jsx("button",{type:"button",onClick:()=>ce(pe.id),className:"text-xs text-amber-500 hover:text-amber-800",children:""})]},pe.id))})]}),S.jsx(Gk,{}),ve&&S.jsxs("div",{className:"mb-4 rounded-xl border border-amber-200 bg-amber-50 p-4 shadow-sm","aria-live":"polite",children:[S.jsx("p",{className:"text-xs font-semibold text-amber-700 uppercase tracking-wide",children:"Awaiting your choice  "}),S.jsx("p",{className:"text-sm text-amber-900 mt-1",children:"Pick the next agent step to continue"}),S.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:ye.map(pe=>S.jsxs("button",{type:"button",onClick:()=>ps(pe),disabled:ml,className:"px-3 py-2 rounded-lg border border-amber-300 bg-white text-amber-900 text-sm font-semibold hover:bg-amber-100 disabled:opacity-50 disabled:cursor-not-allowed",children:[S.jsx("span",{children:pe.label}),S.jsx("span",{className:"block text-[11px] text-amber-500",children:pe.intent??"conversation"})]},pe.id))}),Be&&S.jsx("p",{className:"text-[11px] text-amber-600 mt-2",children:" nextSteps"})]}),S.jsx(zk,{}),Ka.map(_l),S.jsx("div",{ref:nn})]}),S.jsxs("div",{className:"p-4 border-t border-slate-200 bg-white",children:[Bp&&S.jsxs("div",{className:"mb-3",children:[S.jsxs("div",{className:"flex items-center gap-2 text-[11px] font-semibold text-slate-600 uppercase tracking-wide",children:["Used memory (",Za,"/",O.length,")",N&&S.jsx("span",{className:"text-slate-400 font-normal normal-case",children:"Updating"})]}),S.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:O.map(pe=>{const Je=T.includes(pe.id);return S.jsx("button",{type:"button",onClick:()=>M(pe.id),className:`text-[11px] px-2 py-1 rounded-full border transition-colors ${Je?"bg-white border-slate-300 text-slate-400 line-through":"bg-blue-50 border-blue-200 text-blue-700"}`,title:Je?"Click to include this memory":"Click to exclude this memory",children:xR(pe.text,42)},pe.id)})})]}),U&&S.jsxs("div",{className:"mb-4","aria-live":"polite",children:[S.jsx(cZ,{prompt:U,onSelect:Jr,onSubmitFreeText:Pn,disabled:lt,reasonText:K,waitingHint:ge,latestObservation:fn}),V&&S.jsxs("div",{className:"mt-2 rounded-md border border-indigo-200 bg-indigo-50 px-3 py-2 text-xs text-indigo-800",role:"status",children:[S.jsxs("p",{children:[" ",V.label," "]}),S.jsx("p",{className:"text-[11px] mt-1",children:V.startedAt?` ${Oe(V.startedAt)}`:""})]}),Nn.length>0&&S.jsxs("div",{className:"mt-3 rounded-lg border border-slate-200 bg-slate-50 p-3",children:[S.jsx("p",{className:"text-xs font-semibold text-slate-700",children:""}),S.jsx("ul",{className:"mt-2 space-y-1 text-[12px] text-slate-600",children:Nn.map(pe=>S.jsxs("li",{className:"flex flex-col",children:[S.jsx("span",{className:"text-slate-800 font-medium",children:pe.question}),S.jsx("span",{children:pe.status==="answered"?`${pe.responseLabel??pe.responseValue??""}  ${Oe(pe.respondedAt)}`:""})]},`${pe.promptId??pe.askedAt}`))})]})]}),S.jsxs("form",{onSubmit:yl,className:"flex items-start space-x-2",children:[S.jsxs("div",{className:"relative flex-grow",children:[S.jsx("textarea",{ref:rn,rows:1,value:fe,onChange:pe=>Re(pe.target.value),onKeyDown:bc,placeholder:Sc(),disabled:!a||p==="file_upload"||fs||P,"aria-describedby":"chat-input-char-count",className:"w-full bg-white border border-slate-300 rounded-md py-2 pl-3 pr-14 text-sm leading-5 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 resize-none",style:{minHeight:"40px",maxHeight:`${TR}px`,overflowY:"hidden"}}),S.jsxs("span",{id:"chat-input-char-count",className:"pointer-events-none absolute bottom-2 right-3 text-[11px] text-slate-400",children:[fe.length," chars"]})]}),S.jsxs("button",{type:"submit",disabled:r||!fe.trim()||!a||p==="file_upload"||fs||P,className:"flex-shrink-0 px-4 h-10 flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed","aria-label":r?D?"Cancelling request":"Sending message":"Send message",children:[r?S.jsx(mZ,{}):S.jsx(hZ,{}),S.jsx("span",{className:"text-sm",children:r?D?"Cancelling":"Sending":"Send"})]})]}),S.jsx("div",{className:"mt-3",children:S.jsx(qk,{className:"mt-0"})})]})]})},xZ=t=>{const e=[];let n=0,r=null;return t.forEach(s=>{if(s.text.startsWith("Continuing plan")){n+=1,r=s.timestamp;return}n>0&&(e.push({text:n===1?"Continuing plan":`Continuing plan retried ${n}`,type:"system",timestamp:r??s.timestamp}),n=0,r=null),e.push(s)}),n>0&&e.push({text:n===1?"Continuing plan":`Continuing plan retried ${n}`,type:"system",timestamp:r??new Date}),e.slice(-30)},TZ={observing:"bg-slate-400",executing:"bg-blue-500",succeeded:"bg-emerald-500",failed:"bg-red-500"},AZ={chat:"Chat",pipeline:"Analysis Pipeline",system:"System"},EZ=t=>(t instanceof Date?t:new Date(t)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),qk=Us.memo(({className:t})=>{const{progressMessages:e,agentActionTraces:n}=tt(c=>({progressMessages:c.progressMessages,agentActionTraces:c.agentActionTraces}),Up),[r,s]=de.useState(!0),a=de.useMemo(()=>xZ(e),[e]),o=de.useMemo(()=>n.slice(-20),[n]),u=de.useMemo(()=>{const c=a.map((m,y)=>({kind:"progress",id:`sys-${m.timestamp.getTime()}-${y}`,timestamp:m.timestamp,entry:m})),p=o.map(m=>({kind:"action",id:m.id,timestamp:m.timestamp instanceof Date?m.timestamp:new Date(m.timestamp),trace:m}));return[...c,...p].sort((m,y)=>y.timestamp.getTime()-m.timestamp.getTime()).slice(0,40)},[a,o]);if(u.length===0)return null;const d=`${t??"mb-4"} rounded-lg border border-slate-200 bg-white shadow-sm`.trim();return S.jsxs("div",{className:d,children:[S.jsxs("button",{type:"button",onClick:()=>s(c=>!c),className:"w-full flex items-center justify-between px-3 py-2 text-xs font-medium text-slate-600",children:[S.jsx("span",{className:"uppercase tracking-wide",children:"System log"}),S.jsxs("span",{className:"text-[11px] text-slate-400",children:[u.length," events  ",r?"Show":"Hide"]})]}),!r&&S.jsx("div",{className:"max-h-64 overflow-y-auto divide-y divide-slate-100 px-1",children:u.map(c=>{if(c.kind==="progress"){const{entry:w}=c;return S.jsxs("div",{className:`px-2 py-2 text-xs flex gap-2 ${w.type==="error"?"text-red-600":"text-slate-600"}`,children:[S.jsx("span",{className:"text-slate-400",children:w.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),S.jsx("span",{className:"leading-snug",children:w.text})]},c.id)}const p=c.trace,m=p.status??"observing",y=p.source??"chat";return S.jsxs("div",{className:"px-2 py-3 text-sm",children:[S.jsxs("div",{className:"flex items-center text-xs text-slate-500 gap-2",children:[S.jsx("span",{className:`w-2 h-2 rounded-full ${TZ[m]}`}),S.jsx("span",{className:"font-medium",children:EZ(p.timestamp)}),S.jsx("span",{children:""}),S.jsx("span",{children:AZ[y]??"AI"}),S.jsx("span",{children:""}),S.jsx("span",{className:"capitalize",children:m})]}),S.jsx("p",{className:"text-slate-800 mt-0.5 leading-snug whitespace-pre-line",children:p.summary}),p.details&&S.jsx("p",{className:"text-xs text-slate-500 mt-1 leading-snug whitespace-pre-line",children:p.details})]},c.id)})})]})});qk.displayName="SystemLogPanel";const Gk=Us.memo(()=>{const{planState:t,pendingClarifications:e,handleClarificationResponse:n,skipClarification:r,agentAwaitingUserInput:s,isBusy:a}=tt(P=>{var k;return{planState:((k=P.plannerSession)==null?void 0:k.planState)??null,pendingClarifications:P.pendingClarifications,handleClarificationResponse:P.handleClarificationResponse,skipClarification:P.skipClarification,agentAwaitingUserInput:P.agentAwaitingUserInput,isBusy:P.isBusy}},Up),[o,u]=de.useState(!0),[d,c]=de.useState({}),p=de.useMemo(()=>t?t.steps&&t.steps.length>0?t.steps:t.nextSteps??[]:[],[t]);if(!t)return null;const m=p.length,y=p.filter(P=>P.status==="done").length,w=t.currentStepId?p.findIndex(P=>P.id===t.currentStepId):-1,x=t.updatedAt?new Date(t.updatedAt):new Date,A=m>0?`${y} / ${m} completed`:t.progress??"Tracking",E=m>0&&w>=0?`Step ${Math.min(w+1,m)} of ${m}`:m>0?`Tracking ${m} steps`:null,C=e.find(P=>P.status==="pending"||P.status==="resolving")??null,D=t.currentStepId&&p.length>0?p.find(P=>P.id===t.currentStepId):null,O=!!D&&(D.status==="waiting_user"||s)&&!!C,T={done:"bg-emerald-500",in_progress:"bg-blue-500",ready:"bg-slate-400",waiting_user:"bg-amber-500"},I={done:"Done",in_progress:"In progress",ready:"Queued",waiting_user:"Awaiting you"},M=(P,k)=>{c($=>({...$,[P]:k}))},N=P=>{const k=(d[P]??"").trim();k&&(n(P,{label:k,value:k}),c($=>({...$,[P]:""})))};return S.jsxs("div",{className:"mb-4 rounded-xl border border-slate-200 bg-gradient-to-b from-white to-slate-50 shadow-sm",children:[S.jsxs("button",{type:"button",className:"w-full px-4 py-3 flex flex-col text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded-t-xl",onClick:()=>u(P=>!P),children:[S.jsxs("div",{className:"flex items-center justify-between",children:[S.jsxs("div",{children:[S.jsx("p",{className:"text-sm font-semibold text-slate-900",children:"Agent Working Status"}),S.jsx("p",{className:"text-xs text-slate-500",children:A})]}),S.jsxs("div",{className:"text-right",children:[E&&S.jsx("p",{className:"text-xs text-slate-500",children:E}),S.jsx("span",{className:"text-[11px] uppercase tracking-wide text-slate-400",children:o?"Show details":"Hide details"})]})]}),t.blockedBy&&S.jsxs("p",{className:"mt-1 text-xs text-amber-600",children:["Blocked: ",t.blockedBy]}),m>0&&S.jsx("div",{className:"mt-3 h-1.5 w-full bg-slate-200 rounded-full overflow-hidden",children:S.jsx("div",{className:"h-full bg-blue-500 transition-all",style:{width:`${Math.min(y/m*100,100)}%`}})}),S.jsxs("p",{className:"mt-1 text-[11px] text-slate-400",children:["Updated ",x.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]}),!o&&S.jsxs("div",{className:"px-4 pb-4 space-y-4 text-sm text-slate-700",children:[t.goal&&S.jsxs("p",{className:"text-sm",children:[S.jsx("span",{className:"font-medium text-slate-900",children:"Goal:"})," ",t.goal]}),t.contextSummary&&S.jsxs("p",{className:"text-xs text-slate-500",children:[S.jsx("span",{className:"font-semibold text-slate-600",children:"Context:"})," ",t.contextSummary]}),S.jsxs("ol",{className:"relative space-y-3",children:[p.map((P,k)=>{const $=P.status??"ready",U=P.id===t.currentStepId,F=O&&C&&U;return S.jsxs("li",{className:"relative pl-6",children:[S.jsx("span",{className:`absolute left-0 top-1.5 h-3 w-3 rounded-full ${T[$]??"bg-slate-300"}`,"aria-hidden":!0}),S.jsxs("div",{className:"flex items-start justify-between gap-3",children:[S.jsxs("div",{children:[S.jsx("p",{className:`font-medium ${U?"text-slate-900":"text-slate-700"}`,children:P.label}),P.intent&&S.jsx("p",{className:"text-xs text-slate-500",children:P.intent})]}),S.jsx("span",{className:"text-xs text-slate-500",children:I[$]??$})]}),F&&S.jsxs("div",{className:"mt-3 rounded-lg border border-blue-100 bg-blue-50 p-3",children:[S.jsxs("p",{className:"text-sm font-medium text-blue-900 flex items-center gap-2 mb-2",children:[S.jsx("span",{className:"text-base",children:""}),C.question]}),C.reasonHint&&S.jsx("p",{className:"text-xs text-blue-700 mb-2",children:C.reasonHint}),S.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:C.options.map(K=>S.jsx("button",{type:"button",onClick:()=>n(C.id,K),disabled:a,className:"text-xs px-3 py-1 rounded-full border border-blue-200 bg-white text-blue-700 hover:bg-blue-100 disabled:opacity-60 disabled:cursor-not-allowed",children:K.label},`${C.id}-${K.value}`))}),S.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[S.jsx("input",{type:"text",value:d[C.id]??"",onChange:K=>M(C.id,K.target.value),placeholder:"Type your answer",className:"flex-1 rounded-md border border-blue-100 bg-white px-3 py-2 text-sm text-slate-800 placeholder-slate-400 focus:border-blue-300 focus:ring-1 focus:ring-blue-300",disabled:a}),S.jsx("button",{type:"button",onClick:()=>N(C.id),disabled:a||!(d[C.id]??"").trim(),className:"px-4 py-2 rounded-md bg-blue-600 text-white text-xs font-semibold uppercase tracking-wide disabled:opacity-50 disabled:cursor-not-allowed",children:"Send"}),S.jsx("button",{type:"button",onClick:()=>r(C.id),disabled:a,className:"px-3 py-2 rounded-md border border-transparent text-xs text-slate-500 hover:text-red-600",children:"Skip"})]})]})]},P.id??k)}),p.length===0&&S.jsx("li",{className:"text-xs text-slate-500",children:"Waiting for the agent to draft a plan"})]})]})]})});Gk.displayName="PlannerGoalTracker";const CZ={langchain_plan:{icon:"",label:"LangChain Plan"},aggregate_plan:{icon:"",label:"Plan Preview"},profile_dataset:{icon:"",label:"Dataset Profile"},normalize_invoice_month:{icon:"",label:"Invoice Month Clean"},detect_outliers:{icon:"",label:"Outlier Detection"},tool_result:{icon:"",label:"Tool Result"}},IZ=t=>{const e=new Date(t);return Number.isNaN(e.getTime())?"":e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},RZ=t=>{if(!t)return null;const{promptTokens:e,completionTokens:n,totalTokens:r}=t;if(e==null&&n==null&&r==null)return null;const s=e!=null?`in ${e}`:null,a=n!=null?`out ${n}`:null,o=r!=null?`total ${r}`:e!=null||n!=null?`total ${(e??0)+(n??0)}`:null;return["Tok",s,a,o].filter(Boolean).join("  ")},Hk=t=>{const e=t.payload??{},n=CZ[t.kind]??{icon:"",label:t.kind.replace(/_/g," ")};let r=null;typeof e.summary=="string"?r=e.summary:typeof e.description=="string"?r=e.description:typeof e.text=="string"&&(r=e.text);const s=[],a=e.meta??{};typeof a.rows=="number"&&s.push(`${a.rows} `),typeof a.source=="string"&&s.push(a.source==="full"?"":""),typeof a.durationMs=="number"&&s.push(`${Math.round(a.durationMs)} ms`);const o=e.telemetry??a.telemetry;(o==null?void 0:o.latencyMs)!=null&&s.push(`Latency ${Math.round(o.latencyMs)} ms`);const u=RZ(o==null?void 0:o.tokenUsage);u&&s.push(u),(o==null?void 0:o.estimatedCostUsd)!=null&&s.push(`$${o.estimatedCostUsd.toFixed(4)}`);const d=s.length>0?s.join("  "):null;return{id:t.id,timestamp:t.at,icon:n.icon,title:n.label,detail:r,metaLine:d}},zk=Us.memo(()=>{const{observations:t,isBusy:e}=tt(r=>({observations:r.graphObservations,isBusy:r.isBusy}),Up),n=de.useMemo(()=>t.slice(-10).reverse(),[t]);return n.length===0?null:S.jsxs("div",{className:"bg-white border border-slate-200 rounded-lg p-3 shadow-sm",children:[S.jsxs("div",{className:"flex items-center justify-between mb-3",children:[S.jsxs("div",{className:"flex items-center gap-2",children:[S.jsx("span",{className:"text-lg",children:""}),S.jsxs("div",{children:[S.jsx("h3",{className:"text-sm font-semibold text-slate-900",children:"Realtime Observation Timeline"}),S.jsx("p",{className:"text-xs text-slate-500",children:"Newest events shown first"})]})]}),e&&S.jsx("span",{className:"text-xs uppercase tracking-wide text-blue-600 font-semibold",children:"Running"})]}),S.jsx("div",{className:"space-y-3 max-h-64 overflow-y-auto pr-1",children:n.map(r=>{const s=Hk(r);return S.jsxs("div",{className:"relative border-l-2 border-slate-100 pl-3",children:[S.jsx("span",{className:"absolute -left-[5px] top-2 text-sm",children:s.icon}),S.jsx("div",{className:"flex items-center justify-between text-[11px] text-slate-500",children:S.jsx("span",{className:"font-medium",children:IZ(s.timestamp)})}),S.jsx("p",{className:"text-sm font-semibold text-slate-800 mt-1",children:s.title}),s.detail&&S.jsx("p",{className:"text-xs text-slate-600 mt-1 whitespace-pre-line",children:s.detail}),s.metaLine&&S.jsx("p",{className:"text-[11px] text-slate-500 mt-1",children:s.metaLine})]},s.id)})})]})});zk.displayName="GraphObservationTimeline";const NZ=()=>{const{handleFileUpload:t,isBusy:e,isApiKeySet:n,progressMessages:r,fileName:s}=tt(m=>{var y;return{handleFileUpload:m.handleFileUpload,isBusy:m.isBusy,isApiKeySet:m.isApiKeySet,progressMessages:m.progressMessages,fileName:((y=m.csvData)==null?void 0:y.fileName)||null}}),[a,o]=de.useState(!1),u={id:"file-upload-panel"},d=de.useCallback(m=>{m.preventDefault(),m.stopPropagation(),n&&(m.type==="dragenter"||m.type==="dragover"?o(!0):m.type==="dragleave"&&o(!1))},[n]),c=de.useCallback(m=>{m.preventDefault(),m.stopPropagation(),o(!1),n&&m.dataTransfer.files&&m.dataTransfer.files[0]&&t(m.dataTransfer.files[0])},[t,n]),p=m=>{n&&m.target.files&&m.target.files[0]&&t(m.target.files[0])};return e&&s?S.jsxs("div",{...u,className:"flex flex-col items-center justify-center p-12 border-2 border-dashed rounded-lg border-blue-500 bg-slate-100 h-full",children:[S.jsxs("div",{className:"flex items-center text-xl text-slate-800 mb-4",children:[S.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-6 w-6",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[S.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),S.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),S.jsxs("span",{children:['Processing "',s,'"...']})]}),S.jsx("div",{className:"w-full max-w-lg bg-white rounded-md p-4 max-h-64 overflow-y-auto border border-slate-200",children:S.jsx("ul",{className:"space-y-1",children:r.map((m,y)=>S.jsxs("li",{className:`flex text-xs ${m.type==="error"?"text-red-600":"text-slate-500"}`,children:[S.jsx("span",{className:"mr-2 text-slate-400",children:m.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})}),S.jsx("span",{children:m.text})]},y))})}),S.jsx("p",{className:"mt-4 text-xs text-slate-500",children:"All processing is done locally in your browser. Your data stays private."})]}):n?S.jsxs("div",{...u,onDragEnter:d,onDragLeave:d,onDragOver:d,onDrop:c,className:`flex flex-col items-center justify-center p-12 border-2 border-dashed rounded-lg transition-colors duration-300 h-full ${a?"border-blue-500 bg-slate-100":"border-slate-300 hover:border-blue-500"}`,children:[S.jsx("svg",{className:"w-16 h-16 text-slate-400 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"1.5",d:"M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2z"})}),S.jsx("p",{className:"text-xl text-slate-500 mb-2",children:"Drag & drop your CSV file here"}),S.jsx("p",{className:"text-slate-400",children:"or"}),S.jsx("label",{htmlFor:"file-upload",className:"mt-4 cursor-pointer bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:"Select a file"}),S.jsx("input",{id:"file-upload",type:"file",accept:".csv",onChange:p,className:"hidden",disabled:e}),S.jsx("p",{className:"mt-4 text-xs text-slate-500",children:"All processing is done locally in your browser. Your data stays private."})]}):S.jsxs("div",{...u,className:"flex flex-col items-center justify-center p-12 border-2 border-dashed rounded-lg border-slate-300 h-full",children:[S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-16 h-16 text-slate-400 mb-4",fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"})}),S.jsx("h3",{className:"text-xl font-semibold text-slate-800",children:"API Key Required"}),S.jsx("p",{className:"mt-2 max-w-sm text-center text-slate-500",children:"To unlock the AI analysis features, please add your Google Gemini API key in the Assistant's settings panel."}),S.jsx("p",{className:"mt-6 text-xs text-slate-400",children:"Your data remains local and private even when using the AI."})]})},PZ=["English","Mandarin","Spanish","Japanese","French"],AR=["gemini-2.5-flash","gemini-2.5-pro"],ER=["gpt-5","gpt-5-mini"],MZ=[{label:"Every 15 seconds",value:15},{label:"Every 30 seconds",value:30},{label:"Every minute",value:60},{label:"Every 2 minutes",value:120}],kZ=()=>{const{isOpen:t,onClose:e,onSave:n,currentSettings:r,aggregationMode:s,setAggregationMode:a}=tt(y=>({isOpen:y.isSettingsModalOpen,onClose:()=>y.setIsSettingsModalOpen(!1),onSave:y.handleSaveSettings,currentSettings:y.settings,aggregationMode:y.aggregationModePreference,setAggregationMode:y.setAggregationModePreference})),[o,u]=de.useState(r);if(de.useEffect(()=>{u(r)},[r,t]),!t)return null;const d=()=>{n(o),e()},c=y=>{const{name:w,value:x}=y.target;u(w==="autoSaveIntervalSeconds"?A=>({...A,[w]:Number(x)}):A=>({...A,[w]:x}))},p=y=>{u(w=>{const x=AR.includes(w.model),A=ER.includes(w.model);let E=w.model;return y==="google"&&!x?E="gemini-2.5-pro":y==="openai"&&!A&&(E="gpt-5"),{...w,provider:y,model:E}})},m=y=>`px-3 py-1 text-xs font-semibold rounded-md transition ${s===y?"bg-blue-600 text-white shadow-sm":"bg-white text-slate-600 hover:bg-slate-100 border border-slate-200"}`;return S.jsx("div",{className:"fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50",onClick:e,children:S.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-md border border-slate-200 max-h-[80vh] flex flex-col overflow-hidden",onClick:y=>y.stopPropagation(),children:[S.jsxs("div",{className:"flex-1 overflow-y-auto pr-1",children:[S.jsx("h2",{className:"text-2xl font-bold text-slate-900 mb-6",children:"Settings"}),S.jsxs("div",{className:"space-y-6 pb-4",children:[S.jsxs("div",{children:[S.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"AI Provider"}),S.jsxs("div",{className:"flex space-x-2 rounded-lg bg-slate-200 p-1",children:[S.jsx("button",{onClick:()=>p("google"),className:`w-full rounded-md py-1.5 text-sm font-medium transition-colors ${o.provider==="google"?"bg-blue-600 text-white shadow":"text-slate-700 hover:bg-slate-300"}`,children:"Google Gemini"}),S.jsx("button",{onClick:()=>p("openai"),className:`w-full rounded-md py-1.5 text-sm font-medium transition-colors ${o.provider==="openai"?"bg-blue-600 text-white shadow":"text-slate-700 hover:bg-slate-300"}`,children:"OpenAI"})]})]}),o.provider==="google"&&S.jsxs("div",{children:[S.jsx("label",{htmlFor:"geminiApiKey",className:"block text-sm font-medium text-slate-700",children:"Gemini API Key"}),S.jsx("input",{type:"password",id:"geminiApiKey",name:"geminiApiKey",value:o.geminiApiKey,onChange:c,className:"mt-1 block w-full bg-white border border-slate-300 rounded-md py-2 px-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter your API key"}),S.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["Get your key from ",S.jsx("a",{href:"https://aistudio.google.com/app/apikey",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:"Google AI Studio"}),"."]})]}),o.provider==="openai"&&S.jsxs("div",{children:[S.jsx("label",{htmlFor:"openAIApiKey",className:"block text-sm font-medium text-slate-700",children:"OpenAI API Key"}),S.jsx("input",{type:"password",id:"openAIApiKey",name:"openAIApiKey",value:o.openAIApiKey,onChange:c,className:"mt-1 block w-full bg-white border border-slate-300 rounded-md py-2 px-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter your API key (sk-...)"}),S.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["Get your key from ",S.jsx("a",{href:"https://platform.openai.com/api-keys",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:"OpenAI Platform"}),"."]})]}),S.jsxs("div",{children:[S.jsx("label",{htmlFor:"model",className:"block text-sm font-medium text-slate-700",children:"AI Model"}),S.jsx("input",{type:"text",id:"model",name:"model",value:o.model,onChange:c,list:"model-list",className:"mt-1 block w-full bg-white border border-slate-300 rounded-md py-2 px-3 text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., gpt-5"}),S.jsx("datalist",{id:"model-list",children:(o.provider==="google"?AR:ER).map(y=>S.jsx("option",{value:y},y))}),S.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Select a suggested model or type a custom one."})]}),S.jsxs("div",{children:[S.jsx("label",{htmlFor:"language",className:"block text-sm font-medium text-slate-700",children:"Agent Language"}),S.jsx("select",{id:"language",name:"language",value:o.language,onChange:c,className:"mt-1 block w-full bg-white border border-slate-300 rounded-md py-2 px-3 text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500",children:PZ.map(y=>S.jsx("option",{value:y,children:y},y))}),S.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Primary language for AI summaries and chat responses."})]}),S.jsxs("div",{className:"border-t border-slate-200 pt-4",children:[S.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Aggregation Mode  "}),S.jsx("p",{className:"text-xs text-slate-500 mb-3 max-w-sm",children:" = DuckDB  =  5k "}),S.jsxs("div",{className:"inline-flex items-center gap-1 rounded-lg bg-slate-100 p-1",children:[S.jsx("button",{type:"button",className:m("full"),onClick:()=>a("full"),children:""}),S.jsx("button",{type:"button",className:m("sample"),onClick:()=>a("sample"),children:""})]})]}),S.jsxs("div",{className:"border-t border-slate-200 pt-4",children:[S.jsxs("div",{className:"flex items-center justify-between",children:[S.jsxs("div",{children:[S.jsx("label",{className:"block text-sm font-medium text-slate-700",children:"Auto-Save"}),S.jsx("p",{className:"text-xs text-slate-500",children:"Periodically store the current analysis so you can recover it later."})]}),S.jsx("button",{onClick:()=>u(y=>({...y,autoSaveEnabled:!y.autoSaveEnabled})),className:`px-3 py-1 rounded-full text-sm font-medium transition-colors ${o.autoSaveEnabled?"bg-blue-600 text-white":"bg-slate-200 text-slate-700"}`,children:o.autoSaveEnabled?"Enabled":"Paused"})]}),o.autoSaveEnabled&&S.jsxs("div",{className:"mt-4",children:[S.jsx("label",{htmlFor:"autoSaveIntervalSeconds",className:"block text-sm font-medium text-slate-700",children:"Auto-Save Frequency"}),S.jsx("select",{id:"autoSaveIntervalSeconds",name:"autoSaveIntervalSeconds",value:o.autoSaveIntervalSeconds,onChange:c,className:"mt-1 block w-full bg-white border border-slate-300 rounded-md py-2 px-3 text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500",children:MZ.map(y=>S.jsx("option",{value:y.value,children:y.label},y.value))})]})]})]})]}),S.jsxs("div",{className:"mt-6 flex justify-end space-x-3 border-t border-slate-200 pt-4 shrink-0 bg-white",children:[S.jsx("button",{onClick:e,className:"px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors",children:"Cancel"}),S.jsx("button",{onClick:d,className:"px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors",children:"Save Settings"})]})]})})},OZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),DZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),LZ=()=>{const{isOpen:t,onClose:e,reports:n,onLoadReport:r,onDeleteReport:s}=tt(o=>({isOpen:o.isHistoryPanelOpen,onClose:()=>o.setIsHistoryPanelOpen(!1),reports:o.reportsList,onLoadReport:o.handleLoadReport,onDeleteReport:o.handleDeleteReport}));if(!t)return null;const a=(o,u,d)=>{o.stopPropagation(),window.confirm(`Are you sure you want to delete the report for "${d}"? This cannot be undone.`)&&s(u)};return S.jsx("div",{className:"fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50",onClick:e,children:S.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl h-full max-h-[80vh] border border-slate-200 flex flex-col",onClick:o=>o.stopPropagation(),children:[S.jsxs("div",{className:"flex justify-between items-center mb-4",children:[S.jsx("h2",{className:"text-2xl font-bold text-slate-900",children:"Analysis History"}),S.jsx("button",{onClick:e,className:"p-1 text-slate-500 rounded-full hover:bg-slate-100 hover:text-slate-800 transition-colors",title:"Close History",children:S.jsx(OZ,{})})]}),S.jsx("div",{className:"flex-grow overflow-y-auto pr-2",children:n.length===0?S.jsx("div",{className:"flex items-center justify-center h-full",children:S.jsx("p",{className:"text-slate-500",children:"No past reports found. Upload a CSV to start."})}):S.jsx("ul",{className:"space-y-3",children:n.map(o=>{const u=o.id===Ma;return S.jsx("li",{children:S.jsx("div",{onClick:()=>!u&&r(o.id),className:`block p-4 bg-slate-50 rounded-lg transition-all ${u?"ring-2 ring-blue-500 cursor-default":"hover:bg-slate-100 hover:ring-2 hover:ring-blue-500 cursor-pointer"}`,children:S.jsxs("div",{className:"flex justify-between items-center",children:[S.jsxs("div",{children:[S.jsxs("p",{className:"font-semibold text-slate-800 truncate",children:[u?S.jsx("span",{className:"text-blue-600 font-bold",children:"[Current Session] "}):null,o.filename]}),S.jsxs("p",{className:"text-sm text-slate-500",children:["Last saved: ",new Date(o.updatedAt).toLocaleString()]})]}),!u&&S.jsx("button",{onClick:d=>a(d,o.id,o.filename),className:"p-2 text-slate-500 rounded-full hover:bg-red-100 hover:text-red-600 transition-colors flex-shrink-0 ml-4",title:"Delete Report",children:S.jsx(DZ,{})})]})})},o.id)})})}),S.jsx("p",{className:"text-xs text-slate-500 mt-4 text-center",children:"Your reports are saved securely in your browser's IndexedDB."})]})})},$Z=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),UZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),FZ=5*1024,BZ=()=>{const t=tt(P=>P.isMemoryPanelOpen),e=tt(P=>P.addToast),n=tt(P=>P.resetConversationMemory),r=()=>tt.getState().setIsMemoryPanelOpen(!1),[s,a]=de.useState([]),[o,u]=de.useState(""),[d,c]=de.useState([]),[p,m]=de.useState(!1),[y,w]=de.useState(null),x=de.useRef(null),A=wt.getIsInitialized(),E=de.useCallback(()=>{a(wt.getDocuments())},[]),C=de.useMemo(()=>{if(s.length===0)return 0;const P=s.reduce(($,U)=>$+U.text.length*2,0),k=s.length*384*4;return(P+k)/1024},[s]);de.useEffect(()=>{t?E():(u(""),c([]),w(null))},[t,E]),de.useEffect(()=>()=>{var P;(P=x.current)==null||P.abort()},[]);const D=async P=>{var $;if(P.preventDefault(),!o.trim()||!A)return;($=x.current)==null||$.abort();const k=new AbortController;x.current=k,m(!0),w(null);try{const U=await wt.search(o,5,{signal:k.signal});k.signal.aborted||c(U)}catch(U){U instanceof DOMException&&U.name==="AbortError"||console.error("Memory search failed:",U)}finally{x.current===k&&(x.current=null),m(!1)}},O=()=>{x.current&&(x.current.abort(),x.current=null,m(!1),e("Memory search cancelled.","info"))},T=P=>{window.confirm("Are you sure you want to delete this memory item?")&&(wt.deleteDocument(P),E())},I=()=>{window.confirm("Reset conversation memory? This clears the AIs long-term memory (including cards and summaries).")&&(n(),E(),c([]),e("Conversation memory reset.","info"))},M=P=>{w(P);const k=document.getElementById(`memory-doc-${P.substring(0,30)}`);k==null||k.scrollIntoView({behavior:"smooth",block:"center"})};if(!t)return null;const N=Math.min(C/FZ*100,100);return S.jsx("div",{className:"fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity",onClick:r,children:S.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl h-full max-h-[85vh] border border-slate-200 flex flex-col",onClick:P=>P.stopPropagation(),children:[S.jsxs("header",{className:"flex justify-between items-start mb-4 flex-shrink-0",children:[S.jsxs("div",{children:[S.jsxs("div",{className:"flex items-center space-x-3",children:[S.jsx("span",{className:"text-3xl",children:""}),S.jsx("h2",{className:"text-2xl font-bold text-slate-900",children:"AI Long-Term Memory"})]}),S.jsxs("div",{className:"mt-2 pl-12",children:[S.jsxs("div",{className:"flex items-baseline space-x-2 text-sm text-slate-500",children:[S.jsxs("span",{children:[s.length," items"]}),S.jsx("span",{className:"text-slate-300",children:"|"}),S.jsxs("span",{children:["Using ~",C.toFixed(2)," KB"]})]}),S.jsx("div",{className:"w-full bg-slate-200 rounded-full h-1.5 mt-1",children:S.jsx("div",{className:"bg-blue-600 h-1.5 rounded-full",style:{width:`${N}%`}})})]})]}),S.jsx("button",{onClick:r,className:"p-1 text-slate-500 rounded-full hover:bg-slate-100 hover:text-slate-800 transition-colors",title:"Close",children:S.jsx($Z,{})})]}),S.jsxs("div",{className:"flex-grow grid md:grid-cols-2 gap-6 min-h-0",children:[S.jsxs("div",{className:"flex flex-col min-h-0",children:[S.jsxs("div",{className:"mb-4 p-4 bg-slate-50 border border-slate-200 rounded-lg flex-shrink-0",children:[S.jsx("h3",{className:"font-semibold text-slate-800 mb-2",children:"Test Similarity Search"}),S.jsxs("form",{onSubmit:D,className:"flex items-center space-x-2",children:[S.jsx("input",{type:"text",value:o,onChange:P=>u(P.target.value),placeholder:A?"Enter query to find memories...":"Memory model is loading...",disabled:!A||p,className:"flex-grow bg-white border border-slate-300 rounded-md py-1.5 px-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:opacity-50"}),S.jsxs("div",{className:"flex items-center space-x-2",children:[S.jsx("button",{type:"submit",disabled:!A||p||!o.trim(),className:"px-4 py-1.5 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed",children:p?"Searching":"Search"}),p&&S.jsx("button",{type:"button",onClick:O,className:"px-3 py-1.5 border border-slate-300 rounded-md text-slate-600 hover:bg-slate-100 transition-colors",children:"Cancel"})]})]})]}),S.jsx("div",{className:"flex-grow overflow-y-auto pr-2",children:d.length>0&&S.jsxs("div",{className:"space-y-2",children:[S.jsx("h4",{className:"text-sm font-medium text-slate-600",children:"Top Results:"}),d.map(P=>S.jsxs("div",{onClick:()=>M(P.text),className:"bg-white p-2.5 border border-slate-200 rounded-lg text-xs cursor-pointer hover:border-blue-500 hover:ring-1 hover:ring-blue-500",children:[S.jsxs("div",{className:"flex justify-between items-center mb-1",children:[S.jsx("p",{className:"text-slate-700 font-semibold",children:"Match"}),S.jsxs("p",{className:"text-blue-600 font-bold",children:[(P.score*100).toFixed(1),"%"]})]}),S.jsx("div",{className:"w-full bg-slate-200 rounded-full h-1 mb-2",children:S.jsx("div",{className:"bg-blue-500 h-1 rounded-full",style:{width:`${P.score*100}%`}})}),S.jsxs("p",{className:"text-slate-600 italic",children:['"',P.text,'"']})]},P.id))]})})]}),S.jsxs("div",{className:"flex flex-col min-h-0",children:[S.jsxs("div",{className:"flex justify-between items-center mb-2 flex-shrink-0",children:[S.jsxs("h3",{className:"font-semibold text-slate-800",children:["All Stored Memories (",s.length,")"]}),s.length>0&&S.jsx("button",{onClick:I,className:"text-xs text-red-600 hover:underline",children:"Reset Conversation Memory"})]}),S.jsx("div",{className:"flex-grow overflow-y-auto pr-2 border-t border-slate-200 pt-2",children:s.length===0?S.jsx("div",{className:"flex items-center justify-center h-full text-slate-500 text-sm",children:S.jsx("p",{children:"The AI's memory is currently empty."})}):S.jsx("ul",{className:"space-y-2",children:s.map(P=>{const k=P.metadata??{},$=k.summaryLevel??"raw",U=k.kind??"general",F=k.startIndex!=null&&k.endIndex!=null?`Messages ${k.startIndex+1}-${k.endIndex+1}`:null;return S.jsxs("li",{id:`memory-doc-${P.text.substring(0,30)}`,className:`p-3 bg-slate-50 rounded-lg text-sm text-slate-800 border border-slate-200 flex justify-between items-start group transition-all duration-300 ${y===P.text?"border-blue-500 ring-2 ring-blue-500":""}`,children:[S.jsxs("div",{className:"flex-grow pr-4 break-words space-y-1",children:[S.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500",children:[S.jsx("span",{className:"px-2 py-0.5 border border-slate-300 rounded-full bg-white",children:U==="conversation"?"Conversation":"Card"}),S.jsx("span",{className:`px-2 py-0.5 rounded-full ${$==="summary"?"bg-indigo-100 text-indigo-700 border border-indigo-200":"bg-emerald-50 text-emerald-700 border border-emerald-200"}`,children:$==="summary"?"Compressed":"Raw"}),F&&S.jsx("span",{className:"text-slate-400",children:F})]}),S.jsx("p",{children:P.text})]}),S.jsx("button",{onClick:()=>T(P.id),className:"p-1 text-slate-400 rounded-full hover:bg-red-100 hover:text-red-600 transition-colors opacity-0 group-hover:opacity-100 flex-shrink-0",title:"Delete Memory",children:S.jsx(UZ,{})})]},P.id)})})})]})]})]})})},uf=50,qZ=({direction:t})=>t?t==="ascending"?S.jsx("span",{className:"text-slate-800",children:""}):S.jsx("span",{className:"text-slate-800",children:""}):S.jsx("span",{className:"text-slate-400",children:""}),GZ=({data:t,sortConfig:e,onSort:n,columnWidths:r,onColumnResizeStart:s})=>{const[a,o]=de.useState(0);if(!t||t.length===0)return S.jsx("p",{className:"text-slate-500 p-4 text-center",children:"No data matches your search."});const u=Object.keys(t[0]),d=Math.ceil(t.length/uf),c=a*uf,p=t.slice(c,c+uf),m=()=>o(x=>Math.max(0,x-1)),y=()=>o(x=>Math.min(d-1,x+1)),w=x=>{let A,E="";for(;x>=0;)A=x%26,E=String.fromCharCode(A+65)+E,x=Math.floor(x/26)-1;return E};return S.jsxs("div",{className:"w-full text-sm h-full flex flex-col",children:[S.jsx("div",{className:"flex-grow overflow-auto",children:S.jsxs("table",{className:"w-full text-left border-collapse",style:{tableLayout:"fixed"},children:[S.jsx("thead",{className:"bg-slate-100 text-slate-600 sticky top-0 z-10",children:S.jsxs("tr",{children:[S.jsx("th",{className:"p-2 font-semibold text-slate-500 text-center sticky left-0 z-20 bg-slate-100 border-r border-slate-200",style:{width:"60px"},children:"#"}),u.map((x,A)=>S.jsxs("th",{className:"p-2 font-semibold whitespace-nowrap border-r border-l border-slate-200 relative",style:{width:r[x]||150},children:[S.jsxs("button",{onClick:()=>n(x),className:"flex items-center justify-between w-full h-full",children:[S.jsxs("span",{className:"truncate",title:x,children:[w(A)," - ",x]}),S.jsx(qZ,{direction:(e==null?void 0:e.key)===x?e.direction:void 0})]}),S.jsx("div",{onMouseDown:E=>s(x,E),className:"absolute top-0 right-0 h-full w-2 cursor-col-resize z-30"})]},x))]})}),S.jsx("tbody",{className:"bg-white",children:p.map((x,A)=>S.jsxs("tr",{className:"border-b border-slate-200 last:border-b-0 hover:bg-slate-50",children:[S.jsx("td",{className:"p-2 text-slate-400 text-center sticky left-0 z-10 bg-white border-r border-slate-200",style:{width:"60px"},children:c+A+1}),u.map(E=>S.jsx("td",{className:"p-2 text-slate-700 whitespace-nowrap overflow-hidden text-ellipsis border-r border-l border-slate-200",children:Tf(x[E])},`${A}-${E}`))]},A))})]})}),d>1&&S.jsxs("div",{className:"flex justify-between items-center p-2 bg-slate-100 border-t border-slate-200 flex-shrink-0",children:[S.jsxs("span",{className:"text-xs text-slate-500",children:["Showing ",c+1," - ",Math.min(c+uf,t.length)," of ",t.length," rows"]}),S.jsxs("div",{className:"flex items-center space-x-2",children:[S.jsx("button",{onClick:m,disabled:a===0,className:"px-2 py-1 text-xs bg-slate-200 rounded disabled:opacity-50 hover:bg-slate-300",children:"Previous"}),S.jsxs("span",{className:"text-xs text-slate-500",children:["Page ",a+1," of ",d]}),S.jsx("button",{onClick:y,disabled:a===d-1,className:"px-2 py-1 text-xs bg-slate-200 rounded disabled:opacity-50 hover:bg-slate-300",children:"Next"})]})]})]})},HZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-slate-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),zZ=({isOpen:t})=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-6 w-6 transform transition-transform duration-200 ${t?"rotate-180":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),CR=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{d:"M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"})}),jZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})}),VZ=()=>S.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[S.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),S.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),JZ=t=>{const e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?"":e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})},YZ=({isVisible:t})=>{const{csvData:e,spreadsheetFilterFunction:n,aiFilterExplanation:r,isAiFiltering:s,handleNaturalLanguageQuery:a,clearAiFilter:o,cancelAiFilterRequest:u,interactiveSelectionFilter:d,chatHistory:c,datasetHash:p,addToast:m}=tt(F=>({csvData:F.csvData,spreadsheetFilterFunction:F.spreadsheetFilterFunction,aiFilterExplanation:F.aiFilterExplanation,isAiFiltering:F.isAiFiltering,handleNaturalLanguageQuery:F.handleNaturalLanguageQuery,clearAiFilter:F.clearAiFilter,cancelAiFilterRequest:F.cancelAiFilterRequest,interactiveSelectionFilter:F.interactiveSelectionFilter,chatHistory:F.chatHistory,datasetHash:F.datasetHash,addToast:F.addToast})),y=()=>tt.getState().setIsSpreadsheetVisible(!t),[w,x]=de.useState(null),[A,E]=de.useState(""),C=de.useMemo(()=>(e==null?void 0:e.data.length)>0?Object.keys(e.data[0]):[],[e==null?void 0:e.data]),[D,O]=de.useState({});de.useEffect(()=>{if(!e)return;const F={};C.forEach(K=>{var B;const j=K.length*8+30,V=String(((B=e.data[0])==null?void 0:B[K])||"").length*7;F[K]=Math.max(120,j,V)}),O(F)},[C,e]);const T=F=>{let K="ascending";w&&w.key===F&&w.direction==="ascending"&&(K="descending"),x({key:F,direction:K})},I=(F,K)=>{K.preventDefault();const j=K.clientX,V=D[F],B=Z=>{const se=V+(Z.clientX-j);se>60&&O(le=>({...le,[F]:se}))},G=()=>{document.removeEventListener("mousemove",B),document.removeEventListener("mouseup",G),document.body.style.cursor=""};document.body.style.cursor="col-resize",document.addEventListener("mousemove",B),document.addEventListener("mouseup",G)},M=()=>{if(!e||e.data.length===0||C.length===0)return;const F=G=>{const Z=G==null?"":String(G);return/[",\n]/.test(Z)?`"${Z.replace(/"/g,'""')}"`:Z},K=[C.join(","),...e.data.map(G=>C.map(Z=>F(G[Z])).join(","))],j=new Blob([K.join(`
`)],{type:"text/csv;charset=utf-8;"}),V=URL.createObjectURL(j),B=document.createElement("a");B.href=V,B.download=e.fileName||"dataset.csv",B.click(),URL.revokeObjectURL(V)},N=async()=>{if(p)try{await navigator.clipboard.writeText(p),m("Checksum copied.","success",2e3)}catch(F){console.error("Failed to copy checksum:",F),m("Copy failed. Please copy manually.","error",3e3)}},P=()=>{A.trim()&&a(A.trim())},k=F=>{F.key==="Enter"&&P()},$=de.useMemo(()=>{if(!e)return[];let F=[...e.data];if(d&&d.column){const K=d.values.map(j=>String(j));F=F.filter(j=>{const V=j[d.column];return K.includes(V==null?"":String(V))})}if(n)try{F=BR(F,n)}catch(K){console.error("AI filter execution failed:",K)}else if(A){const K=A.toLowerCase();F=F.filter(j=>Object.values(j).some(V=>String(V).toLowerCase().includes(K)))}return w!==null&&F.sort((K,j)=>{const V=K[w.key],B=j[w.key];if(V==null)return 1;if(B==null)return-1;const G=typeof V=="number"?V:parseFloat(String(V).replace(/[^0-9.-]+/g,"")),Z=typeof B=="number"?B:parseFloat(String(B).replace(/[^0-9.-]+/g,""));if(!isNaN(G)&&!isNaN(Z))return w.direction==="ascending"?G-Z:Z-G;const se=String(V).toLowerCase(),le=String(B).toLowerCase();return se<le?w.direction==="ascending"?-1:1:se>le?w.direction==="ascending"?1:-1:0}),F},[e,w,A,n,d]),U=de.useMemo(()=>c.filter(F=>typeof F.text=="string"&&F.text.startsWith("System note:")&&(F.text.includes("Raw Data Explorer")||F.text.includes("chart drilldown"))).slice(-5).reverse(),[c]);return e?S.jsxs("div",{id:"raw-data-explorer",className:"bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300 border border-slate-200",children:[S.jsxs("button",{onClick:y,className:"flex justify-between items-center p-4 cursor-pointer w-full text-left rounded-t-lg hover:bg-slate-50","aria-expanded":t,children:[S.jsxs("div",{children:[S.jsx("h3",{className:"text-lg font-bold text-slate-900",children:"Raw Data Explorer"}),S.jsxs("p",{className:"text-sm text-slate-500",children:["File: ",e.fileName]}),S.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-500",children:[S.jsx("button",{type:"button",onClick:M,className:"underline decoration-dotted hover:text-slate-700",children:"Download Original"}),S.jsx("span",{className:"text-slate-300",children:""}),S.jsx("button",{type:"button",onClick:N,disabled:!p,className:`underline decoration-dotted ${p?"hover:text-slate-700":"text-slate-300 cursor-not-allowed"}`,children:"Copy checksum"})]})]}),S.jsx(zZ,{isOpen:t})]}),t&&S.jsxs("div",{className:"flex flex-col h-full p-4 pt-0",children:[d&&S.jsxs("div",{className:"bg-amber-50 text-amber-900 border border-amber-200 rounded-md p-2 text-xs mb-2",children:[S.jsx("p",{className:"font-semibold",children:"Chart Drilldown Active"}),S.jsxs("p",{className:"mt-1",children:[d.label,"  ",d.column," "," ",d.values.map(F=>String(F)).join(", ")]}),S.jsx("p",{className:"mt-1 text-amber-800",children:"Adjust or clear the selection directly on the chart to remove this link."})]}),U.length>0&&S.jsxs("div",{className:"bg-slate-50 text-slate-700 border border-slate-200 rounded-md p-2 text-xs mb-2",children:[S.jsx("p",{className:"font-semibold mb-1",children:"Filter Provenance"}),S.jsx("ul",{className:"space-y-1",children:U.map((F,K)=>S.jsxs("li",{className:"flex justify-between items-start gap-2",children:[S.jsx("span",{className:"flex-1 text-slate-600",children:F.text}),S.jsx("span",{className:"text-slate-400 whitespace-nowrap",children:JZ(F.timestamp)})]},`${F.timestamp}-${K}`))})]}),S.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[S.jsxs("div",{className:"flex flex-col flex-grow space-y-1",children:[S.jsxs("div",{className:"relative",children:[S.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:S.jsx(HZ,{})}),S.jsx("input",{type:"text",placeholder:"Search table or ask AI (e.g., 'show rows where column_3 > 100')",value:A,onChange:F=>E(F.target.value),onKeyDown:k,className:"bg-white border border-slate-300 rounded-md py-1.5 pl-10 pr-4 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 w-full"})]}),S.jsxs("div",{className:"text-xs text-slate-500 flex items-center space-x-3 flex-wrap",children:[S.jsxs("span",{children:["Filtered rows: ",$.length,"/",e.data.length]}),n&&S.jsxs("button",{type:"button",onClick:o,className:"flex items-center space-x-1 text-blue-600 hover:text-blue-800 underline decoration-dotted",title:"Clear AI filter",children:[S.jsx(CR,{}),S.jsx("span",{children:"AI filter active (click to clear)"})]}),d&&S.jsxs("span",{className:"text-amber-700",children:['Drilldown from "',d.label,'"']})]})]}),S.jsxs("div",{className:"flex items-center space-x-2",children:[S.jsxs("button",{onClick:P,disabled:s||!A.trim(),className:"flex items-center space-x-2 px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed",title:"Use AI to filter data based on your query",children:[s?S.jsx(VZ,{}):S.jsx(CR,{}),S.jsx("span",{children:s?"Working":"Ask AI"})]}),s&&S.jsx("button",{type:"button",onClick:u,className:"px-3 py-1.5 border border-slate-300 rounded-md text-slate-600 hover:bg-slate-100 transition-colors",children:"Cancel"})]})]}),r&&S.jsxs("div",{className:"bg-blue-50 text-blue-800 border border-blue-200 rounded-md p-2 text-sm flex justify-between items-center mb-2",children:[S.jsxs("p",{children:[S.jsx("span",{className:"font-semibold",children:"AI Filter:"})," ",r]}),S.jsx("button",{onClick:o,className:"p-1 rounded-full hover:bg-blue-200",title:"Clear AI filter",children:S.jsx(jZ,{})})]}),S.jsx("div",{className:"flex-grow overflow-auto border border-slate-200 rounded-md",style:{maxHeight:"60vh"},children:S.jsx(GZ,{data:$,sortConfig:w,onSort:T,columnWidths:D,onColumnResizeStart:I})})]})]}):null},KZ=({isOpen:t})=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-6 w-6 transform transition-transform duration-200 ${t?"rotate-180":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),WZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:S.jsx("path",{fillRule:"evenodd",d:"M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z",clipRule:"evenodd"})}),ZZ=({isVisible:t})=>{const{plan:e,originalSample:n,transformedSample:r}=tt(a=>{var o;return{plan:a.dataPreparationPlan,originalSample:a.initialDataSample,transformedSample:((o=a.csvData)==null?void 0:o.data.slice(0,20))||[]}}),s=()=>tt.getState().setIsDataPrepDebugVisible(!t);return!e||!n?null:S.jsxs("div",{className:"bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300 border border-slate-200",children:[S.jsxs("button",{onClick:s,className:"flex justify-between items-center p-4 cursor-pointer w-full text-left rounded-t-lg hover:bg-slate-50","aria-expanded":t,children:[S.jsxs("div",{children:[S.jsxs("h3",{className:"text-lg font-bold text-slate-900 flex items-center",children:[S.jsx(WZ,{})," AI Data Transformation Log"]}),S.jsx("p",{className:"text-sm text-slate-500",children:"See how the AI cleaned and reshaped your data."})]}),S.jsx(KZ,{isOpen:t})]}),t&&S.jsxs("div",{className:"p-4 pt-0 space-y-6",children:[S.jsxs("div",{children:[S.jsx("h4",{className:"font-semibold text-slate-800 mb-2",children:"AI's Plan"}),S.jsxs("p",{className:"text-sm bg-slate-50 p-3 rounded-md border border-slate-200 text-slate-700 italic",children:['"',e.explanation,'"']})]}),S.jsxs("div",{children:[S.jsx("h4",{className:"font-semibold text-slate-800 mb-2",children:"Transformation Code"}),S.jsx("pre",{className:"bg-slate-900 text-slate-100 p-3 rounded-md text-xs overflow-x-auto",children:S.jsx("code",{children:`// AI-generated function to transform data
function transform(data, _util) {
${e.jsFunctionBody}
}`})})]}),S.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[S.jsxs("div",{children:[S.jsx("h4",{className:"font-semibold text-slate-800 mb-2",children:"Data Before (Raw Sample)"}),S.jsx("div",{className:"max-h-64 overflow-y-auto border border-slate-200 rounded-md",children:S.jsx(Af,{data:n})})]}),S.jsxs("div",{children:[S.jsx("h4",{className:"font-semibold text-slate-800 mb-2",children:"Data After (Transformed Sample)"}),S.jsx("div",{className:"max-h-64 overflow-y-auto border border-slate-200 rounded-md",children:S.jsx(Af,{data:r})})]})]})]})]})},XZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),QZ=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),eX=()=>S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:S.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2-2z"})}),tX=iP(),nX=()=>{const{onNewSession:t,onOpenHistory:e,isAsideVisible:n,onShowAssistant:r,graphStatus:s,graphStatusMessage:a,graphVersion:o,graphLastReadyAt:u}=tt(m=>({onNewSession:m.handleNewSession,onOpenHistory:()=>{m.loadReportsList(),m.setIsHistoryPanelOpen(!0)},isAsideVisible:m.isAsideVisible,onShowAssistant:()=>m.setIsAsideVisible(!0),graphStatus:m.graphStatus,graphStatusMessage:m.graphStatusMessage,graphVersion:m.graphVersion,graphLastReadyAt:m.graphLastReadyAt})),d=(()=>{switch(s){case"ready":return`Graph Ready (v${o??""})`;case"connecting":return"Graph Initializing";case"error":return a??"Graph Offline";default:return"Graph Idle"}})(),c={ready:"bg-emerald-100 text-emerald-700 border-emerald-200",connecting:"bg-amber-100 text-amber-700 border-amber-200",error:"bg-rose-100 text-rose-700 border-rose-200",idle:"bg-slate-100 text-slate-600 border-slate-200"},p=c[s]??c.idle;return S.jsxs("header",{className:"mb-6 flex justify-between items-start flex-shrink-0",children:[S.jsxs("div",{className:"max-w-xs",children:[S.jsx("h1",{className:"text-xl font-extrabold text-slate-900 leading-tight",children:"CSV Data Analysis Agent"}),S.jsxs("div",{className:"mt-2 flex flex-col gap-1",children:[S.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold ${p}`,children:["  ",d]}),u&&S.jsxs("span",{className:"text-[11px] text-slate-400",children:["Last heartbeat: ",new Date(u).toLocaleTimeString()]})]})]}),S.jsx("div",{className:"flex flex-col items-end gap-4 sm:flex-row sm:items-center sm:gap-6",children:S.jsxs("div",{className:"flex items-center space-x-2",children:[tX.showNewButton&&S.jsxs("button",{onClick:t,className:"flex items-center space-x-2 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",title:"Start a new analysis session",children:[S.jsx(eX,{}),S.jsx("span",{className:"hidden sm:inline",children:"New"})]}),S.jsxs("button",{onClick:e,className:"flex items-center space-x-2 px-3 py-2 bg-white border border-slate-300 text-slate-700 rounded-md hover:bg-slate-100 transition-colors",title:"View analysis history",children:[S.jsx(QZ,{}),S.jsx("span",{className:"hidden sm:inline",children:"History"})]}),!n&&S.jsx("button",{onClick:r,className:"p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors","aria-label":"Show Assistant Panel",title:"Show Assistant Panel",children:S.jsx(XZ,{})})]})})]})},rX=({className:t="h-4 w-4 text-blue-600 animate-spin",ariaLabel:e="Loading"})=>S.jsxs("svg",{className:t,viewBox:"0 0 24 24",fill:"none",role:"status","aria-label":e,children:[S.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),S.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),sX={observe:"Observe",plan:"Plan",act:"Act",verify:"Verify",idle:"Idle"},aX=({runtimeLabel:t,graphStatus:e,graphStatusMessage:n,graphToolInFlight:r,graphLastToolSummary:s,agentAwaitingUserInput:a,graphAwaitPrompt:o})=>r?{headline:`${t}  ${r.label}`,detail:n??""}:a?{headline:`${t} `,detail:(o==null?void 0:o.question)??n??""}:e==="connecting"?{headline:`${t} runtime `,detail:n??"Spinning up worker"}:e==="error"?{headline:`${t} runtime `,detail:n??" System Log"}:s?{headline:`${t} runtime `,detail:s}:{headline:`${t} runtime`,detail:n},iX=()=>{const{runtimeLabel:t,graphStatus:e,graphStatusMessage:n,graphToolInFlight:r,graphLastToolSummary:s,agentAwaitingUserInput:a,graphAwaitPrompt:o,graphPhase:u,graphLoopBudget:d}=tt(c=>({runtimeLabel:c.useLangGraphRuntime?"LangGraph":"Graph",graphStatus:c.graphStatus,graphStatusMessage:c.graphStatusMessage,graphToolInFlight:c.graphToolInFlight,graphLastToolSummary:c.graphLastToolSummary,agentAwaitingUserInput:c.agentAwaitingUserInput,graphAwaitPrompt:c.graphAwaitPrompt,graphPhase:c.graphPhase,graphLoopBudget:c.graphLoopBudget}));return de.useMemo(()=>{const w=!!r||a||e==="connecting"||e==="error"||!!s,{headline:x,detail:A}=aX({runtimeLabel:t,graphStatus:e,graphStatusMessage:n,graphToolInFlight:r,graphLastToolSummary:s,agentAwaitingUserInput:a,graphAwaitPrompt:o}),E=u?sX[u]??u:null,C=d?`${d.actsUsed}/${d.maxActs}${d.exceeded?" (max reached)":""}`:null;return{shouldRender:w,headline:x,detail:A,runtimeLabel:t,agentAwaitingUserInput:a,activeToolLabel:(r==null?void 0:r.label)??null,graphStatus:e,phaseLabel:E,loopSummary:C}},[t,e,n,r,s,a,o,u,d])},oX=()=>{const{isBusy:t,busyMessage:e,canCancelBusy:n,requestBusyCancel:r,isCancellationRequested:s}=tt(m=>({isBusy:m.isBusy,busyMessage:m.busyMessage,canCancelBusy:m.canCancelBusy,requestBusyCancel:m.requestBusyCancel,isCancellationRequested:m.isCancellationRequested})),a=iX(),o=t,u=!t&&a.shouldRender;if(!o&&!u)return null;const d=o?e||"Thinking through your question...":a.headline,c=a.phaseLabel||a.loopSummary?`Phase: ${a.phaseLabel??"Idle"}${a.loopSummary?`  Loop ${a.loopSummary}`:""}`:null,p=a.detail;return S.jsxs("div",{className:"mb-4 rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 shadow-sm flex flex-col gap-2 md:flex-row md:items-center md:justify-between",role:"status","aria-live":"polite",children:[S.jsxs("div",{className:"flex items-center gap-3 text-blue-900",children:[S.jsx(rX,{}),S.jsxs("div",{children:[S.jsx("p",{className:"text-sm font-semibold",children:d}),o&&s&&S.jsx("p",{className:"text-xs text-blue-700",children:"Cancelling wrapping up safely."}),p&&S.jsx("p",{className:"text-xs text-blue-700",children:p}),c&&S.jsx("p",{className:"text-xs text-blue-700",children:c})]})]}),o&&n?S.jsx("button",{type:"button",onClick:r,disabled:s,className:"text-sm font-semibold rounded-md border border-blue-300 px-3 py-1.5 text-blue-700 hover:bg-blue-100 disabled:opacity-60 disabled:cursor-not-allowed",children:s?"Cancelling":"Cancel"}):u&&S.jsxs("div",{className:"flex items-center gap-2",children:[S.jsxs("span",{className:"inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-semibold text-blue-700",children:[a.runtimeLabel," runtime"]}),a.phaseLabel&&S.jsx("span",{className:"inline-flex items-center rounded-full bg-slate-200 px-2 py-0.5 text-xs font-semibold text-slate-700",children:a.phaseLabel}),a.loopSummary&&S.jsxs("span",{className:"text-xs text-slate-600",children:["Loop ",a.loopSummary]}),a.agentAwaitingUserInput&&S.jsx("span",{className:"text-xs font-semibold text-orange-600",children:"Waiting for your input"}),a.activeToolLabel&&S.jsxs("span",{className:"text-xs text-blue-700",children:["",a.activeToolLabel]})]})]})},lX={info:"bg-slate-800 text-white",success:"bg-emerald-600 text-white",error:"bg-red-600 text-white"},uX=()=>{const{toasts:t,dismissToast:e}=tt(n=>({toasts:n.toasts,dismissToast:n.dismissToast}));return t.length===0?null:S.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-3 max-w-sm",children:t.map(n=>S.jsxs("div",{className:`flex items-start justify-between rounded-lg shadow-lg px-4 py-3 text-sm ${lX[n.type]}`,children:[S.jsxs("div",{className:"pr-4 space-y-2",children:[S.jsx("p",{children:n.message}),n.actionLabel&&n.onAction&&S.jsx("button",{className:"underline text-white/90 hover:text-white text-xs font-medium",onClick:()=>{var r;(r=n.onAction)==null||r.call(n),e(n.id)},children:n.actionLabel})]}),S.jsx("button",{onClick:()=>e(n.id),className:"text-white/70 hover:text-white text-lg leading-none","aria-label":"Dismiss notification",children:""})]},n.id))})},cX=(t,e,n,r,s)=>{const a=[`${t}  ${e} rows`];return n&&a.push(`${n} removed`),r&&a.push(`${r} added`),s&&a.push(`${s} modified`),a.join("  ")},dX=()=>{const{pendingDataTransform:t,lastAppliedDataTransform:e,isLastAppliedDataTransformBannerDismissed:n,confirmPendingDataTransform:r,discardPendingDataTransform:s,undoLastDataTransform:a,dismissLastAppliedDataTransformBanner:o}=tt(c=>({pendingDataTransform:c.pendingDataTransform,lastAppliedDataTransform:c.lastAppliedDataTransform,isLastAppliedDataTransformBannerDismissed:c.isLastAppliedDataTransformBannerDismissed,confirmPendingDataTransform:c.confirmPendingDataTransform,discardPendingDataTransform:c.discardPendingDataTransform,undoLastDataTransform:c.undoLastDataTransform,dismissLastAppliedDataTransformBanner:c.dismissLastAppliedDataTransformBanner})),u=n?null:e,d=!!u;return!t&&!d?null:S.jsxs("div",{className:"space-y-3 mt-4",children:[t&&S.jsxs("div",{className:"border border-amber-200 bg-amber-50 rounded-md p-4 shadow-sm",children:[S.jsx("p",{className:"text-sm font-semibold text-amber-900",children:"AI Data Change Pending Confirmation"}),S.jsx("p",{className:"text-xs text-amber-900 mt-1",children:t.explanation||"The AI prepared a dataset update."}),S.jsx("p",{className:"text-xs text-amber-800 mt-1",children:cX(t.meta.rowsBefore,t.meta.rowsAfter,t.meta.removedRows,t.meta.addedRows,t.meta.modifiedRows)}),t.previewRows.length>0&&S.jsx("pre",{className:"bg-white text-amber-900 text-xs rounded-md mt-2 p-2 overflow-auto max-h-40 border border-amber-200",children:JSON.stringify(t.previewRows.slice(0,2),null,2)}),S.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[S.jsx("button",{onClick:r,className:"px-3 py-1.5 bg-amber-600 text-white rounded-md text-sm hover:bg-amber-700 transition-colors",children:"Apply Change"}),S.jsx("button",{onClick:s,className:"px-3 py-1.5 border border-amber-400 text-amber-900 rounded-md text-sm hover:bg-amber-100 transition-colors",children:"Discard"})]})]}),d&&S.jsx("div",{className:"border border-emerald-200 bg-emerald-50 rounded-md p-3",children:S.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[S.jsxs("div",{children:[S.jsx("p",{className:"text-sm font-semibold text-emerald-900",children:"Last Applied AI Change"}),S.jsx("p",{className:"text-xs text-emerald-800 mt-1",children:u.summary})]}),S.jsxs("div",{className:"flex items-center gap-2 self-start sm:self-auto",children:[S.jsx("button",{onClick:a,className:"px-3 py-1.5 border border-emerald-400 text-emerald-900 rounded-md text-sm hover:bg-emerald-100 transition-colors",children:"Undo Change"}),S.jsx("button",{type:"button",onClick:o,"aria-label":"Dismiss last applied AI change",className:"p-1.5 rounded-full text-emerald-700 hover:text-emerald-900 hover:bg-emerald-100 transition-colors",children:S.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4","aria-hidden":"true",children:S.jsx("path",{fillRule:"evenodd",d:"M5.22 5.22a.75.75 0 0 1 1.06 0L10 8.94l3.72-3.72a.75.75 0 1 1 1.06 1.06L11.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06L10 11.06l-3.72 3.72a.75.75 0 1 1-1.06-1.06L8.94 10 5.22 6.28a.75.75 0 0 1 0-1.06Z",clipRule:"evenodd"})})})]})]})})]})},fX=()=>{const{datasetHash:t,langChainLastPlan:e,isBusy:n,addProgress:r,isApiKeySet:s}=tt(c=>({datasetHash:c.datasetHash,langChainLastPlan:c.langChainLastPlan,isBusy:c.isBusy,addProgress:c.addProgress,isApiKeySet:c.isApiKeySet})),[a,o]=de.useState(!1),u=!!(t&&s&&!n&&!a),d=async()=>{if(!t){r("LangChain PoC requires an uploaded dataset.","error");return}o(!0);try{const{runLangChainPrompt:c}=await np(async()=>{const{runLangChainPrompt:p}=await import("./agent_csv_promptRunner-PxCNeSoz.js");return{runLangChainPrompt:p}},__vite__mapDeps([0,1]));await c({datasetId:t,debug:!0})}catch(c){const p=c instanceof Error?c.message:String(c??"Unknown error");r(`LangChain PoC failed: ${p}`,"error")}finally{o(!1)}};return S.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl shadow-sm p-4 space-y-4",children:[S.jsxs("div",{className:"flex items-center justify-between",children:[S.jsxs("div",{children:[S.jsx("p",{className:"text-sm font-semibold text-slate-900",children:"LangChain PoC"}),S.jsx("p",{className:"text-xs text-slate-500",children:"Run promptplan pipeline via LangChain."})]}),S.jsx("button",{type:"button",onClick:d,disabled:!u,className:"px-3 py-1.5 text-xs font-semibold rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed",children:a?"Running":"Run LangChain Plan"})]}),e?S.jsxs("div",{className:"text-sm text-slate-700 space-y-1",children:[S.jsx("p",{className:"font-semibold",children:e.title}),S.jsx("p",{className:"text-xs text-slate-500",children:e.description}),S.jsxs("div",{className:"text-xs text-slate-600 mt-2",children:[S.jsxs("span",{className:"inline-flex items-center gap-1",children:[S.jsx("span",{className:"font-semibold",children:"Chart:"}),e.chartType]}),e.groupByColumn&&S.jsxs("span",{className:"inline-flex items-center gap-1 ml-4",children:[S.jsx("span",{className:"font-semibold",children:"Group by:"}),e.groupByColumn]}),e.valueColumn&&S.jsxs("span",{className:"inline-flex items-center gap-1 ml-4",children:[S.jsx("span",{className:"font-semibold",children:"Metric:"}),e.valueColumn]})]})]}):S.jsx("p",{className:"text-xs text-slate-500",children:" LangChain "})]})},Qy=new Intl.NumberFormat(void 0,{maximumFractionDigits:2}),IR=new Intl.NumberFormat(void 0,{style:"currency",currency:"USD",maximumFractionDigits:4}),pX=()=>{const{usageLog:t,clearUsage:e}=tt(r=>({usageLog:r.llmUsageLog,clearUsage:r.clearLlmUsage})),n=t.reduce((r,s)=>r+(s.estimatedCostUsd??0),0);return S.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl shadow-sm p-4 space-y-4",children:[S.jsxs("div",{className:"flex items-center justify-between",children:[S.jsxs("div",{children:[S.jsx("p",{className:"text-sm font-semibold text-slate-900",children:"LLM Usage"}),S.jsx("p",{className:"text-xs text-slate-500",children:" 40  LLM  tokens / cost "})]}),S.jsxs("div",{className:"flex items-center gap-2",children:[S.jsxs("span",{className:"text-xs text-slate-500",children:[" ",IR.format(n)]}),S.jsx("button",{type:"button",onClick:e,disabled:t.length===0,className:"px-2 py-1 text-xs font-semibold rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed",children:""})]})]}),t.length===0?S.jsx("p",{className:"text-xs text-slate-500",children:" LLM "}):S.jsx("div",{className:"max-h-64 overflow-y-auto",children:S.jsxs("table",{className:"min-w-full text-xs text-left",children:[S.jsx("thead",{className:"text-slate-500",children:S.jsxs("tr",{children:[S.jsx("th",{className:"pb-2 pr-4 font-medium",children:""}),S.jsx("th",{className:"pb-2 pr-4 font-medium",children:"Context"}),S.jsx("th",{className:"pb-2 pr-4 font-medium",children:"Provider  Model"}),S.jsx("th",{className:"pb-2 pr-4 font-medium",children:"Tokens (in/out/total)"}),S.jsx("th",{className:"pb-2 font-medium",children:"Cost"})]})}),S.jsx("tbody",{className:"text-slate-700",children:t.slice().reverse().map(r=>S.jsxs("tr",{className:"border-t border-slate-100",children:[S.jsx("td",{className:"py-2 pr-4 whitespace-nowrap",children:new Date(r.timestamp).toLocaleTimeString()}),S.jsx("td",{className:"py-2 pr-4",children:r.context}),S.jsxs("td",{className:"py-2 pr-4 whitespace-nowrap",children:[r.provider,"/",r.model]}),S.jsxs("td",{className:"py-2 pr-4 whitespace-nowrap",children:[Qy.format(r.promptTokens??0)," /"," ",Qy.format(r.completionTokens??0)," /"," ",Qy.format(r.totalTokens??(r.promptTokens??0)+(r.completionTokens??0))]}),S.jsx("td",{className:"py-2 whitespace-nowrap",children:r.estimatedCostUsd!=null?IR.format(r.estimatedCostUsd):""})]},r.id))})]})})]})},hX=()=>{const{init:t,currentView:e,csvData:n,isAsideVisible:r,asideWidth:s,isResizing:a,handleAsideMouseDown:o,isDataPrepDebugVisible:u,isSpreadsheetVisible:d,dataPreparationPlan:c,initialDataSample:p}=tt(E=>({init:E.init,currentView:E.currentView,csvData:E.csvData,isAsideVisible:E.isAsideVisible,asideWidth:E.asideWidth,isResizing:E.isResizing,handleAsideMouseDown:E.handleAsideMouseDown,isDataPrepDebugVisible:E.isDataPrepDebugVisible,isSpreadsheetVisible:E.isSpreadsheetVisible,dataPreparationPlan:E.dataPreparationPlan,initialDataSample:E.initialDataSample})),m=tt(E=>E.setIsAsideVisible),y=tt(E=>E.addToast),w=tt(E=>E.handleExternalCsvPayload),x=tt(E=>E.connectGraphRuntime);de.useEffect(()=>{t()},[t]),de.useEffect(()=>{x()},[x]),de.useEffect(()=>{const E=O=>{!O||typeof O.csv!="string"||w(O).catch(T=>{console.error("Failed to process external CSV payload.",T)})},C=()=>{if(typeof window>"u"||typeof window.__getNextCsvPayload!="function")return;let O;do O=window.__getNextCsvPayload(),O&&E(O);while(O)},D=O=>{E(O.detail||null)};return C(),window.addEventListener("ai-table-csv",D),()=>{window.removeEventListener("ai-table-csv",D)}},[w]),de.useEffect(()=>{if(typeof window>"u")return;const E=()=>{if(!Array.isArray(window.__CSV_AGENT_PENDING_NOTICES__))return;window.__CSV_AGENT_PENDING_NOTICES__.splice(0).forEach(O=>{y(O,"warning",6e3)})},C=D=>{var T;const O=D;(T=O.detail)!=null&&T.message&&y(O.detail.message,"warning",6e3)};return E(),window.addEventListener("ai-table-csv-notice",C),()=>{window.removeEventListener("ai-table-csv-notice",C)}},[y]);const A=()=>e==="file_upload"||!n?S.jsx("div",{className:"flex-grow min-h-0",children:S.jsx(NZ,{})}):S.jsxs("div",{className:"flex-grow min-h-0 overflow-y-auto",children:[S.jsx(iZ,{}),c&&c.jsFunctionBody&&p&&S.jsx("div",{className:"mt-8",children:S.jsx(ZZ,{isVisible:u})}),S.jsxs("div",{className:"mt-8 space-y-8",children:[S.jsx(fX,{}),S.jsx(pX,{})]}),S.jsx("div",{className:"mt-8",children:S.jsx(YZ,{isVisible:d})})]});return S.jsxs("div",{className:"flex flex-col md:flex-row h-screen bg-slate-50 text-slate-800 font-sans",children:[S.jsx(kZ,{}),S.jsx(LZ,{}),S.jsx(BZ,{}),S.jsx(uX,{}),S.jsxs("main",{className:"flex-1 overflow-hidden p-4 flex flex-col",children:[S.jsx(nX,{}),S.jsx(oX,{}),S.jsx(dX,{}),A()]}),r&&S.jsxs(S.Fragment,{children:[S.jsx("div",{onMouseDown:o,onDoubleClick:()=>m(!1),className:"hidden md:flex group items-center justify-center w-2.5 cursor-col-resize",title:"Drag to resize, double-click to hide",children:S.jsx("div",{className:`w-0.5 h-8 bg-slate-300 rounded-full transition-colors duration-200 group-hover:bg-brand-secondary ${a?"!bg-blue-600":""}`})}),S.jsx("aside",{className:"w-full md:w-auto bg-white flex flex-col h-full border-l border-slate-200",style:{width:s},children:S.jsx("div",{className:"flex-1 overflow-hidden flex flex-col",children:S.jsx(SZ,{})})})]})]})},jk=document.getElementById("root");if(!jk)throw new Error("Could not find root element to mount to");const mX=pL.createRoot(jk);mX.render(S.jsx(Us.StrictMode,{children:S.jsx(hX,{})}));export{DP as $,xv as A,OX as B,mj as C,UX as D,Vz as E,yj as F,Mz as G,_j as H,D7 as I,JX as J,VX as K,jX as L,zX as M,OP as N,Li as O,HX as P,GX as Q,Rn as R,QM as S,ej as T,kP as U,Pz as V,qX as W,BX as X,WX as Y,BP as Z,Ft as _,wj as a,$X as a0,DX as a1,Tj as a2,Kz as a3,Zz as a4,Tp as a5,Ln as a6,Xz as a7,fl as a8,Va as a9,ek as aa,Qf as ab,Et as ac,P7 as ad,Op as ae,$v as af,Ai as ag,yn as ah,Br as ai,gn as aj,Ba as ak,X_ as al,N7 as am,VI as an,YM as ao,JM as ap,M7 as aq,sQ as ar,rQ as as,ss as at,$s as au,uG as av,Lt as aw,sW as ax,ZM as b,QX as c,bj as d,UP as e,gj as f,Ju as g,vj as h,FX as i,V_ as j,j_ as k,pc as l,iC as m,hj as n,dj as o,LX as p,dl as q,ZX as r,qP as s,XX as t,tt as u,Nz as v,nj as w,tj as x,KX as y,YX as z};
