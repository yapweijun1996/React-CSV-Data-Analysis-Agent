const b=n=>{if(n==null)return null;let e=String(n).trim();if(e==="")return null;let t=!1;e.startsWith("(")&&e.endsWith(")")&&(e=e.substring(1,e.length-1),t=!0),e=e.replace(/[$\s€£¥%]/g,"");const r=e.lastIndexOf(","),i=e.lastIndexOf(".");r>i?e=e.replace(/\./g,"").replace(",","."):e=e.replace(/,/g,"");const o=parseFloat(e);return isNaN(o)?null:t?-o:o},P=n=>{if(!n||n.length===0)return[];const e=Object.keys(n[0]),t=[];for(const r of e){let i=!0;const o=n.map(s=>s[r]);let c=0;const a=n.length,m=o.filter(s=>s!==null&&String(s).trim()!=="").length;for(const s of o){const g=b(s);if(s!==null&&String(s).trim()!==""){if(g===null){i=!1;break}c++}}if(i&&c>0){const s=o.map(b).filter(p=>p!==null),g=a>0?s.length/a:0;t.push({name:r,type:"numerical",valueRange:[Math.min(...s),Math.max(...s)],missingPercentage:(1-g)*100,sampleSize:a,nonNullCount:m,numericSampleCount:s.length,numericSampleRatio:g})}else{const s=new Set(o.map(String));t.push({name:r,type:"categorical",uniqueValues:s.size,missingPercentage:a===0?0:o.filter(g=>g===null||String(g).trim()==="").length/a*100,sampleSize:a,nonNullCount:m})}}return t},E={FULL_SCAN_BLOCKED:"FULL_SCAN_BLOCKED",AGG_TIMEOUT:"AGG_TIMEOUT",COLUMN_METADATA_MISSING:"COLUMN_METADATA_MISSING",INDEXEDDB_UNAVAILABLE:"INDEXEDDB_UNAVAILABLE"},k=2e3,V=1e3,v=3e3,B=3e3,$="<NULL>",U=(n,e)=>typeof n=="number"&&n>0?Math.min(e,n):e,L=n=>({trimWhitespace:(n==null?void 0:n.trimWhitespace)??!0,caseStrategy:(n==null?void 0:n.caseStrategy)??"lower",nullReplacement:(n==null?void 0:n.nullReplacement)??$}),re=(n,e)=>{const t=e==null?void 0:e.rowCountHint,r=(e==null?void 0:e.preferredMode)==="full"||(e==null?void 0:e.preferredMode)===void 0,i=new Date().toISOString();return{datasetId:n,mode:r?"full":"sample",allowFullScan:r,sampleSize:U(t,v),profileSampleSize:U(t,k),timeoutMs:B,updatedAt:i,stringStrategy:L()}},oe=(n,e)=>({...n,...e,datasetId:n.datasetId,updatedAt:new Date().toISOString(),stringStrategy:L({...n.stringStrategy,...e.stringStrategy})}),se=n=>n?{...n,stringStrategy:L(n.stringStrategy)}:null,q=n=>({strategy:n,pipeline:[n.trimWhitespace?"trim":"preserve-whitespace","toString",n.caseStrategy==="lower"?"toLowerCase":"case-as-is",`nullCoalesce(${n.nullReplacement})`]}),C=()=>{throw Object.assign(new Error(E.COLUMN_METADATA_MISSING),{code:E.COLUMN_METADATA_MISSING})},K=n=>{let e=0;for(let t=0;t<n.length;t++)e=(e<<5)-e+n.charCodeAt(t),e|=0;return Math.abs(e).toString(36)},y=n=>{const e=n.caseStrategy==="lower"?t=>t.toLowerCase():t=>t;return t=>{if(t==null)return n.nullReplacement;let r=typeof t=="string"?t:String(t);return n.trimWhitespace&&(r=r.trim()),r.length===0?n.nullReplacement:e(r)}},j=y(L()),W=(n,e=j)=>e(n),H=(n,e,t=3)=>{const r=[];for(const i of n){const o=i[e];if(o==null||o==="")continue;const c=W(o);if(c&&(r.includes(c)||r.push(c),r.length>=t))break}return r},Y=async(n,e)=>{const{datasetId:t,sampleSize:r=k}=e;if(!t)throw new Error("datasetId is required for profiling.");const[i,o]=await Promise.all([n.readColumnStoreRecord(t),n.readSampledRows(t,r)]);if(i||C(),o.length===0)throw new Error("No rows available to profile.");const a=P(o).map(s=>({name:s.name,type:s.type,distinct:s.uniqueValues??new Set(o.map(g=>g[s.name])).size,emptyPercentage:s.missingPercentage??0,examples:H(o,s.name)})),m=[];return i.rowCount>o.length&&m.push(`Profiled ${o.length.toLocaleString()} rows (sample) out of ${i.rowCount.toLocaleString()}.`),{rowCount:i.rowCount,sampledRows:o.length,columns:a,warnings:m}},X=(n,e,t)=>!e||e.length===0?!0:e.every(r=>{const i=n[r.column],o=t(i),c=t(r.value??""),a=m=>r.caseInsensitive?m.toLowerCase():m;switch(r.op){case"eq":return a(o)===a(c);case"neq":return a(o)!==a(c);case"gt":return Number(o)>Number(c);case"gte":return Number(o)>=Number(c);case"lt":return Number(o)<Number(c);case"lte":return Number(o)<=Number(c);case"contains":{const m=o.toLowerCase(),s=c.toLowerCase();return m.includes(s)}case"in":{if(!Array.isArray(r.values))return!1;const m=r.values.map(p=>t(p)),s=new Set(m.map(p=>r.caseInsensitive?p.toLowerCase():p)),g=r.caseInsensitive?o.toLowerCase():o;return s.has(g)}default:return!0}}),F=(n,e,t,r,i)=>{var O;const o=e.mode??"full";if(!Array.isArray(e.metrics)||e.metrics.length===0)throw new Error("metrics[] is required for aggregation.");if(o==="full"&&!e.allowFullScan)throw Object.assign(new Error(E.FULL_SCAN_BLOCKED),{code:E.FULL_SCAN_BLOCKED});const c=e.by??[],a=new Map,m=((O=e.filter)==null?void 0:O.length)??0,s=e.timeoutMs??B,g=(typeof performance<"u"?performance.now():Date.now())+s,p=L(i),D=y(p);for(const u of n){if(!X(u,e.filter,D))continue;if((typeof performance<"u"?performance.now():Date.now())>g){if(o==="full")throw new Error("AGG_TIMEOUT");break}const d=c.map(l=>D(u[l])),S=d.length>0?d.join("||"):"__total__";if(!a.has(S)){const l={};c.forEach((w,I)=>{l[w]=d[I]});const A={};e.metrics.forEach(w=>{const I=w.as??`${w.fn}_${w.column??"rows"}`;A[I]={sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}}),a.set(S,{keys:l,accumulators:A})}const f=a.get(S);e.metrics.forEach(l=>{const A=l.as??`${l.fn}_${l.column??"rows"}`,w=f.accumulators[A];if(l.fn==="count"){w.count+=1,w.sum+=1;return}if(!l.column)throw new Error(`Metric ${l.fn} requires a column.`);const I=b(u[l.column]);I!==null&&(w.count+=1,w.sum+=I,w.min=Math.min(w.min,I),w.max=Math.max(w.max,I))})}const x=u=>{if(!u||!r)return"number";const h=r.find(d=>d.name===u);return!h||h.type==="numerical"?"number":h.type},G=[...c.map(u=>{var h;return{name:u,type:((h=r==null?void 0:r.find(d=>d.name===u))==null?void 0:h.type)??"string"}}),...e.metrics.map(u=>({name:u.as??`${u.fn}_${u.column??"rows"}`,type:u.fn==="count"?"number":x(u.column)}))],N=[];for(const u of a.values()){const h={...u.keys};e.metrics.forEach(d=>{const S=d.as??`${d.fn}_${d.column??"rows"}`,f=u.accumulators[S];let l=null;switch(d.fn){case"sum":l=f.sum;break;case"avg":l=f.count>0?f.sum/f.count:null;break;case"count":l=f.count;break;case"min":l=f.min===Number.POSITIVE_INFINITY?null:f.min;break;case"max":l=f.max===Number.NEGATIVE_INFINITY?null:f.max;break}h[S]=l??0}),N.push(h)}e.orderBy&&e.orderBy.length>0&&N.sort((u,h)=>{for(const d of e.orderBy){const S=(d.direction??"desc").toLowerCase()==="asc"?1:-1,f=u[d.column],l=h[d.column];if(f===l)continue;if(f==null)return 1;if(l==null)return-1;if(typeof f=="number"&&typeof l=="number")return f>l?S:-S;const A=String(f).localeCompare(String(l));if(A!==0)return A*S}return 0});const z=typeof e.limit=="number"?N.slice(0,e.limit):N,R=n.length,M=o!=="full"&&R<t,T=[];return M&&T.push("Aggregated on sampled rows. Retry with allowFullScan for full coverage."),{schema:G,rows:z,provenance:{datasetId:e.datasetId,sampled:M,mode:o,processedRows:R,totalRows:t,queryHash:K(JSON.stringify({by:c,metrics:e.metrics,filter:e.filter,orderBy:e.orderBy,limit:e.limit,mode:o})),filterCount:m,warnings:T,normalization:q(p)}}},Z=async(n,e)=>{const[t,r]=await Promise.all([n.readColumnStoreRecord(e.datasetId),n.readDatasetRuntimeConfig(e.datasetId)]);t||C();const i=e.mode??"full",o=i;e.mode=o;const c=e.sampleSize??v;try{const a=o==="full"?await n.readAllRows(e.datasetId):await n.readSampledRows(e.datasetId,c);if(a.length===0)throw new Error("No rows available for aggregation.");const m=F(a,e,t.rowCount,t.columns,r==null?void 0:r.stringStrategy);return m.provenance.requestedMode=i,m}catch(a){if(a instanceof Error&&(a.code===E.FULL_SCAN_BLOCKED||a.message===E.FULL_SCAN_BLOCKED))throw Object.assign(new Error("Full scan requires confirmation."),{code:E.FULL_SCAN_BLOCKED});if(a instanceof Error&&a.message==="AGG_TIMEOUT"&&o==="full"){const m=await n.readSampledRows(e.datasetId,c),s=F(m,{...e,mode:"sample"},t.rowCount,t.columns,r==null?void 0:r.stringStrategy);return s.provenance.warnings.push("Full scan timed out. 采样结果，建议允许全量。"),s.provenance.requestedMode=i,s.provenance.downgradedFrom=i,s.provenance.downgradeReason="timeout",s}throw a instanceof Error&&a.message==="AGG_TIMEOUT"?Object.assign(a,{code:E.AGG_TIMEOUT}):a}},J=async(n,e)=>{const{datasetId:t,n:r=V,withColumns:i=!1}=e;if(!t)throw new Error("datasetId is required for sampling.");const[o,c]=await Promise.all([n.readSampledRows(t,r),i?n.readColumnStoreRecord(t):Promise.resolve(null)]);if(i&&!c&&C(),o.length===0)throw new Error("No rows available to sample.");return{rows:o,sampled:!0,columns:c==null?void 0:c.columns}};let _=null;const Q=()=>typeof indexedDB<"u"&&"IDBDatabase"in self,ee=async()=>{if(!Q())throw new Error("IndexedDB is not available inside the worker context.");return _||(_=import("./agent_csv_csvAgentDb-2jlCE_Yc.js")),_},ne=async()=>{const n=await ee();return{readColumnStoreRecord:n.readColumnStoreRecord,readSampledRows:n.readSampledRows,readAllRows:n.readAllRows,readDatasetRuntimeConfig:n.readDatasetRuntimeConfig}},te=async n=>{const e=performance.now();try{let t;const r=await ne();switch(n.action){case"profile":t=await Y(r,n.payload);break;case"sample":t=await J(r,n.payload);break;case"aggregate":t=await Z(r,n.payload);break;default:throw new Error(`Unknown action: ${n.action}`)}return{id:n.id,ok:!0,result:t,durationMs:performance.now()-e}}catch(t){const r=t instanceof Error?t.message:"Unknown worker error";let i,o=t==null?void 0:t.code;return t instanceof Error&&t.code==="FULL_SCAN_BLOCKED"?i="Please confirm full scan with the user, then retry with allowFullScan=true.":r.includes("IndexedDB")?(i="Browser blocked IndexedDB in this worker; falling back to main thread.",o=o??E.INDEXEDDB_UNAVAILABLE):i="Retry with a smaller sample or adjust your query.",{id:n.id,ok:!1,reason:r,hint:i,code:o,durationMs:performance.now()-e}}};self.addEventListener("message",n=>{const e=n.data;!e||typeof e.id!="string"||te(e).then(t=>{self.postMessage(t)})});export{re as c,se as h,oe as m,P as p,q as s};
