const N=r=>{if(r==null)return null;let e=String(r).trim();if(e==="")return null;let n=!1;e.startsWith("(")&&e.endsWith(")")&&(e=e.substring(1,e.length-1),n=!0),e=e.replace(/[$\s€£¥%]/g,"");const s=e.lastIndexOf(","),o=e.lastIndexOf(".");s>o?e=e.replace(/\./g,"").replace(",","."):e=e.replace(/,/g,"");const t=parseFloat(e);return isNaN(t)?null:n?-t:t},B=r=>{if(!r||r.length===0)return[];const e=Object.keys(r[0]),n=[];for(const s of e){let o=!0;const t=r.map(i=>i[s]);let a=0;const f=r.length,w=t.filter(i=>i!==null&&String(i).trim()!=="").length;for(const i of t){const h=N(i);if(i!==null&&String(i).trim()!==""){if(h===null){o=!1;break}a++}}if(o&&a>0){const i=t.map(N).filter(b=>b!==null),h=f>0?i.length/f:0;n.push({name:s,type:"numerical",valueRange:[Math.min(...i),Math.max(...i)],missingPercentage:(1-h)*100,sampleSize:f,nonNullCount:w,numericSampleCount:i.length,numericSampleRatio:h})}else{const i=new Set(t.map(String));n.push({name:s,type:"categorical",uniqueValues:i.size,missingPercentage:f===0?0:t.filter(h=>h===null||String(h).trim()==="").length/f*100,sampleSize:f,nonNullCount:w})}}return n},S={FULL_SCAN_BLOCKED:"FULL_SCAN_BLOCKED",AGG_TIMEOUT:"AGG_TIMEOUT",COLUMN_METADATA_MISSING:"COLUMN_METADATA_MISSING",INDEXEDDB_UNAVAILABLE:"INDEXEDDB_UNAVAILABLE"},F=2e3,x=1e3,v=3e3,y=3e3,G=5e3,T=(r,e)=>typeof r=="number"&&r>0?Math.min(e,r):e,X=(r,e)=>{const n=e==null?void 0:e.rowCountHint,s=(e==null?void 0:e.preferredMode)==="full"||(e==null?void 0:e.preferredMode)===void 0&&typeof n=="number"&&n>0&&n<=G,o=new Date().toISOString();return{datasetId:r,mode:s?"full":"sample",allowFullScan:s,sampleSize:T(n,v),profileSampleSize:T(n,F),timeoutMs:y,updatedAt:o}},J=(r,e)=>({...r,...e,datasetId:r.datasetId,updatedAt:new Date().toISOString()}),C=()=>{throw Object.assign(new Error(S.COLUMN_METADATA_MISSING),{code:S.COLUMN_METADATA_MISSING})},P=r=>{let e=0;for(let n=0;n<r.length;n++)e=(e<<5)-e+r.charCodeAt(n),e|=0;return Math.abs(e).toString(36)},A=r=>r==null?"":typeof r=="string"?r.trim():String(r),V=(r,e,n=3)=>{const s=[];for(const o of r){const t=o[e];if(t==null||t==="")continue;const a=A(t);if(a&&(s.includes(a)||s.push(a),s.length>=n))break}return s},$=async(r,e)=>{const{datasetId:n,sampleSize:s=F}=e;if(!n)throw new Error("datasetId is required for profiling.");const[o,t]=await Promise.all([r.readColumnStoreRecord(n),r.readSampledRows(n,s)]);if(o||C(),t.length===0)throw new Error("No rows available to profile.");const f=B(t).map(i=>({name:i.name,type:i.type,distinct:i.uniqueValues??new Set(t.map(h=>h[i.name])).size,emptyPercentage:i.missingPercentage??0,examples:V(t,i.name)})),w=[];return o.rowCount>t.length&&w.push(`Profiled ${t.length.toLocaleString()} rows (sample) out of ${o.rowCount.toLocaleString()}.`),{rowCount:o.rowCount,sampledRows:t.length,columns:f,warnings:w}},z=(r,e)=>!e||e.length===0?!0:e.every(n=>{const s=r[n.column],o=A(s),t=A(n.value??"");switch(n.op){case"eq":return n.caseInsensitive?o.toLowerCase()===t.toLowerCase():o===t;case"neq":return n.caseInsensitive?o.toLowerCase()!==t.toLowerCase():o!==t;case"gt":return Number(o)>Number(t);case"gte":return Number(o)>=Number(t);case"lt":return Number(o)<Number(t);case"lte":return Number(o)<=Number(t);case"contains":return o.toLowerCase().includes(t.toLowerCase());case"in":return Array.isArray(n.values)?n.values.some(a=>A(a)===o):!1;default:return!0}}),U=(r,e,n,s)=>{var R;const o=e.mode??"sample";if(!Array.isArray(e.metrics)||e.metrics.length===0)throw new Error("metrics[] is required for aggregation.");if(o==="full"&&!e.allowFullScan)throw Object.assign(new Error(S.FULL_SCAN_BLOCKED),{code:S.FULL_SCAN_BLOCKED});const t=e.by??[],a=new Map,f=((R=e.filter)==null?void 0:R.length)??0,w=e.timeoutMs??y,i=(typeof performance<"u"?performance.now():Date.now())+w;for(const u of r){if(!z(u,e.filter))continue;if((typeof performance<"u"?performance.now():Date.now())>i){if(o==="full")throw new Error("AGG_TIMEOUT");break}const m=t.map(c=>A(u[c])),p=m.length>0?m.join("||"):"__total__";if(!a.has(p)){const c={};t.forEach((d,E)=>{c[d]=m[E]});const I={};e.metrics.forEach(d=>{const E=d.as??`${d.fn}_${d.column??"rows"}`;I[E]={sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}}),a.set(p,{keys:c,accumulators:I})}const l=a.get(p);e.metrics.forEach(c=>{const I=c.as??`${c.fn}_${c.column??"rows"}`,d=l.accumulators[I];if(c.fn==="count"){d.count+=1,d.sum+=1;return}if(!c.column)throw new Error(`Metric ${c.fn} requires a column.`);const E=N(u[c.column]);E!==null&&(d.count+=1,d.sum+=E,d.min=Math.min(d.min,E),d.max=Math.max(d.max,E))})}const h=u=>{if(!u||!s)return"number";const g=s.find(m=>m.name===u);return!g||g.type==="numerical"?"number":g.type},b=[...t.map(u=>{var g;return{name:u,type:((g=s==null?void 0:s.find(m=>m.name===u))==null?void 0:g.type)??"string"}}),...e.metrics.map(u=>({name:u.as??`${u.fn}_${u.column??"rows"}`,type:u.fn==="count"?"number":h(u.column)}))],_=[];for(const u of a.values()){const g={...u.keys};e.metrics.forEach(m=>{const p=m.as??`${m.fn}_${m.column??"rows"}`,l=u.accumulators[p];let c=null;switch(m.fn){case"sum":c=l.sum;break;case"avg":c=l.count>0?l.sum/l.count:null;break;case"count":c=l.count;break;case"min":c=l.min===Number.POSITIVE_INFINITY?null:l.min;break;case"max":c=l.max===Number.NEGATIVE_INFINITY?null:l.max;break}g[p]=c??0}),_.push(g)}e.orderBy&&e.orderBy.length>0&&_.sort((u,g)=>{for(const m of e.orderBy){const p=(m.direction??"desc").toLowerCase()==="asc"?1:-1,l=u[m.column],c=g[m.column];if(l===c)continue;if(l==null)return 1;if(c==null)return-1;if(typeof l=="number"&&typeof c=="number")return l>c?p:-p;const I=String(l).localeCompare(String(c));if(I!==0)return I*p}return 0});const k=typeof e.limit=="number"?_.slice(0,e.limit):_,M=r.length,D=o!=="full"&&M<n,O=[];return D&&O.push("Aggregated on sampled rows. Retry with allowFullScan for full coverage."),{schema:b,rows:k,provenance:{datasetId:e.datasetId,sampled:D,mode:o,processedRows:M,totalRows:n,queryHash:P(JSON.stringify({by:t,metrics:e.metrics,filter:e.filter,orderBy:e.orderBy,limit:e.limit,mode:o})),filterCount:f,warnings:O}}},q=async(r,e)=>{const n=await r.readColumnStoreRecord(e.datasetId);n||C();const s=e.mode??"sample",o=s;e.mode=o;const t=e.sampleSize??v;try{const a=o==="full"?await r.readAllRows(e.datasetId):await r.readSampledRows(e.datasetId,t);if(a.length===0)throw new Error("No rows available for aggregation.");const f=U(a,e,n.rowCount,n.columns);return f.provenance.requestedMode=s,f}catch(a){if(a instanceof Error&&(a.code===S.FULL_SCAN_BLOCKED||a.message===S.FULL_SCAN_BLOCKED))throw Object.assign(new Error("Full scan requires confirmation."),{code:S.FULL_SCAN_BLOCKED});if(a instanceof Error&&a.message==="AGG_TIMEOUT"&&o==="full"){const f=await r.readSampledRows(e.datasetId,t),w=U(f,{...e,mode:"sample"},n.rowCount,n.columns);return w.provenance.warnings.push("Full scan timed out. 采样结果，建议允许全量。"),w.provenance.requestedMode=s,w.provenance.downgradedFrom=s,w.provenance.downgradeReason="timeout",w}throw a instanceof Error&&a.message==="AGG_TIMEOUT"?Object.assign(a,{code:S.AGG_TIMEOUT}):a}},K=async(r,e)=>{const{datasetId:n,n:s=x,withColumns:o=!1}=e;if(!n)throw new Error("datasetId is required for sampling.");const[t,a]=await Promise.all([r.readSampledRows(n,s),o?r.readColumnStoreRecord(n):Promise.resolve(null)]);if(o&&!a&&C(),t.length===0)throw new Error("No rows available to sample.");return{rows:t,sampled:!0,columns:a==null?void 0:a.columns}};let L=null;const j=()=>typeof indexedDB<"u"&&"IDBDatabase"in self,H=async()=>{if(!j())throw new Error("IndexedDB is not available inside the worker context.");return L||(L=import("./agent_csv_csvAgentDb-BPVB5Ubn.js")),L},Y=async()=>{const r=await H();return{readColumnStoreRecord:r.readColumnStoreRecord,readSampledRows:r.readSampledRows,readAllRows:r.readAllRows}},W=async r=>{const e=performance.now();try{let n;const s=await Y();switch(r.action){case"profile":n=await $(s,r.payload);break;case"sample":n=await K(s,r.payload);break;case"aggregate":n=await q(s,r.payload);break;default:throw new Error(`Unknown action: ${r.action}`)}return{id:r.id,ok:!0,result:n,durationMs:performance.now()-e}}catch(n){const s=n instanceof Error?n.message:"Unknown worker error";let o,t=n==null?void 0:n.code;return n instanceof Error&&n.code==="FULL_SCAN_BLOCKED"?o="Please confirm full scan with the user, then retry with allowFullScan=true.":s.includes("IndexedDB")?(o="Browser blocked IndexedDB in this worker; falling back to main thread.",t=t??S.INDEXEDDB_UNAVAILABLE):o="Retry with a smaller sample or adjust your query.",{id:r.id,ok:!1,reason:s,hint:o,code:t,durationMs:performance.now()-e}}};self.addEventListener("message",r=>{const e=r.data;!e||typeof e.id!="string"||W(e).then(n=>{self.postMessage(n)})});export{X as c,J as m,B as p};
