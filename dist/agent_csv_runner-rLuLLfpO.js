const x="0.1.0",D="context_ready",k=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`session-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,O=(t,e)=>{const n=new Date().toISOString(),a={sessionId:k(),planId:null,stateTag:D,awaitingUser:!1,awaitPrompt:null,awaitPromptId:null,pendingUserReply:null,pendingPlan:null,pendingVerification:null,steps:[],currentStepId:null,blockedBy:null,observations:[],viewIds:[],warnings:[],updatedAt:n};return{...a,...e,steps:a.steps,observations:a.observations,viewIds:a.viewIds,warnings:a.warnings}},C=["ready","in_progress","done"],P=t=>t?["context_ready","awaiting_clarification","needs_clarification"].includes(t)?!0:/^\d{5,}-\d+$/.test(t)||/^ts[0-9a-z]{2,}-[0-9a-z_-]+$/i.test(t):!1,R=t=>{if(!Array.isArray(t))return[];const e=new Set,n=[];return t.forEach(a=>{const s=typeof(a==null?void 0:a.id)=="string"?a.id.trim():"",o=typeof(a==null?void 0:a.label)=="string"?a.label.trim():"",p=typeof(a==null?void 0:a.intent)=="string"?a.intent.trim():"conversation";if(s.length<3||o.length<3||e.has(s))return;const r=C.includes(a.status)?a.status:"ready";n.push({id:s,label:o,intent:p,status:r}),e.add(s)}),n},A=(t,e)=>{var o;if(!e)return t;const n=R(e.steps??e.nextSteps),a=typeof e.currentStepId=="string"&&e.currentStepId.trim().length>=3?e.currentStepId.trim():((o=n[0])==null?void 0:o.id)??t.currentStepId,s=typeof e.planId=="string"&&e.planId.trim().length>=3?e.planId.trim():t.planId;return{...t,planId:s,steps:n,currentStepId:a,blockedBy:e.blockedBy??t.blockedBy,stateTag:e.stateTag&&P(e.stateTag)?e.stateTag:t.stateTag,updatedAt:new Date().toISOString(),awaitPrompt:t.awaitPrompt,awaitPromptId:t.awaitPromptId,pendingUserReply:t.pendingUserReply}},f=t=>t?P(t):!1,E=["text_response","await_user","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request"],B=(t,e)=>{if(!Array.isArray(e)||e.length===0)return{ok:!0,nextState:t,acceptedActions:[]};if(t.awaitingUser)return c("awaiting_user","Graph is waiting for user input; no actions can run.",t);if(e.length>2)return c("turn_budget_exceeded","Each turn may include at most 2 actions.",t);const n=e[0];if(n.responseType!=="plan_state_update")return c("first_action_plan_required","First action must be plan_state_update.",t);if(!f(n.stateTag))return c("invalid_state_tag","plan_state_update is missing a valid stateTag.",t);if(!n.planState)return c("missing_plan_state","plan_state_update is missing planState payload.",t);const a=e[1];if(a){if(a.responseType==="plan_state_update")return c("atomic_type_invalid","Second action must be atomic, not plan_state_update.",t);if(!E.includes(a.responseType))return c("atomic_type_invalid",`Atomic action ${a.responseType} is not permitted in this turn.`,t);if(!f(a.stateTag))return c("invalid_state_tag","Atomic action is missing a valid stateTag.",t)}return{ok:!0,nextState:M(t,n,a),acceptedActions:e}},M=(t,e,n)=>{var o,p,r,i,_,l;let a=A(t,e.planState);return a={...a,stateTag:e.stateTag??a.stateTag,updatedAt:new Date().toISOString()},!!((o=e.meta)!=null&&o.awaitUser)||((p=e.planState)==null?void 0:p.blockedBy)==="awaiting_user_choice"||!!((r=n==null?void 0:n.meta)!=null&&r.awaitUser)||(n==null?void 0:n.responseType)==="await_user"?a={...a,awaitingUser:!0,blockedBy:((i=e.planState)==null?void 0:i.blockedBy)??(n==null?void 0:n.reason)??"awaiting_user_choice",awaitPrompt:(n==null?void 0:n.awaitUserPayload)??a.awaitPrompt,awaitPromptId:((_=n==null?void 0:n.awaitUserPayload)==null?void 0:_.promptId)??a.awaitPromptId}:a={...a,awaitingUser:!1,blockedBy:((l=e.planState)==null?void 0:l.blockedBy)??null,awaitPrompt:null,awaitPromptId:null},a},c=(t,e,n)=>({ok:!1,violations:[{code:t,message:e}],nextState:n}),N=t=>O(),G=({state:t})=>{const e={...t,warnings:t.warnings??[]},n=t.observations.some(s=>s.kind==="profile_dataset"),a=[];return n||a.push({type:"execute_js_code",responseType:"execute_js_code",stepId:t.currentStepId??"diagnose-profile",stateTag:t.stateTag??"context_ready",timestamp:new Date().toISOString(),reason:"需要列画像来制定计划。",meta:{toolCall:{kind:"profile_dataset"}},toolCall:{kind:"profile_dataset"}}),{state:e,actions:a,label:"diagnose"}},S="你想先做哪項？",j=[{id:"clean_month",label:"清洗/标准化 InvoiceMonth"},{id:"top_payees",label:"Top 收款方（总额/笔数/客单）"},{id:"outlier",label:"异常大额清单"},{id:"by_type",label:"按 PayeeType 分解"}],L=()=>`prompt-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,q=({state:t})=>{if(t.pendingUserReply)return{state:t,actions:[],label:"ask_user"};if(t.awaitingUser&&t.awaitPrompt){const o={type:"await_user",responseType:"await_user",stepId:t.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Still waiting for your selection before continuing.",text:t.awaitPrompt.question,meta:{awaitUser:!0,haltAfter:!0,promptId:t.awaitPrompt.promptId},awaitUserPayload:t.awaitPrompt};return{state:t,actions:[o],halted:!0,label:"ask_user"}}const e=L(),n={promptId:e,question:S,options:j,allowFreeText:!0,placeholder:"或输入：Top10 by amount desc"},a={type:"await_user",responseType:"await_user",stepId:t.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Need user choice before continuing the analysis plan.",text:S,meta:{awaitUser:!0,haltAfter:!0,promptId:e},awaitUserPayload:n},s=t.steps.length>0?t.steps:[{id:"ask-user-choice",intent:"clarification",label:"Await user choice before planning",status:"waiting_user"}];return{state:{...t,awaitingUser:!0,blockedBy:"awaiting_user_choice",stateTag:"awaiting_clarification",steps:s,awaitPrompt:n,awaitPromptId:e,pendingPlan:null,pendingVerification:null,updatedAt:new Date().toISOString()},actions:[a],halted:!0,label:"ask_user"}},V={clean_month:{toolCall:{kind:"normalize_invoice_month",params:{column:"InvoiceMonth"}},stepId:"normalize-invoice-month",stepLabel:"标准化 InvoiceMonth 字段",stepIntent:"data_cleaning",planGoal:"标准化发票月份字段，确保后续聚合一致。",planProgress:"已进入 InvoiceMonth 字段标准化阶段。",reason:"根据你的选择，先统一 InvoiceMonth 字段格式。",text:"正在本地标准化 InvoiceMonth 字段（YYYY-MM），完成后我会告知影响行数。"},outlier:{toolCall:{kind:"detect_outliers",params:{valueColumn:"Amount",multiplier:3}},stepId:"detect-amount-outliers",stepLabel:"侦测金额异常值",stepIntent:"data_validation",planGoal:"识别金额异常交易记录，提供可疑清单。",planProgress:"已开始金额异常检测（以 Amount 字段计算阈值）。",reason:"根据你的选择，先扫描金额异常值。",text:"正在比较 Amount 分布，找出超过阈值的可疑记录，稍后回报。"}},z=t=>t?V[t]:void 0,Y=t=>{if(!t||typeof t!="object")return!1;const e=t;return e.source==="langchain"&&typeof e.planId=="string"&&typeof e.stepId=="string"},F=()=>`plan-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,b=20,H=t=>({type:"execute_js_code",responseType:"execute_js_code",stepId:t.stepId,stateTag:`ts${Date.now().toString(36)}-tool`,timestamp:new Date().toISOString(),reason:t.reason,text:t.text,meta:{toolCall:t.toolCall},toolCall:t.toolCall}),K=(t,e)=>{const n=[...t,e];return n.length>b?n.slice(n.length-b):n},Q=t=>{if(!t)return null;const e=t.langChainPlan;return Y(e)?e:null},X=(t,e)=>{const n={type:"plan_state_update",responseType:"plan_state_update",stepId:e.stepId,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`LangChain 计划完成：${e.summary}`,planState:e.planState,meta:{source:"langchain",telemetry:e.telemetry}},a={id:e.stepId,summary:e.summary,plan:e.plan,createdAt:new Date().toISOString()},s={id:`langchain-plan-${Date.now().toString(36)}`,kind:"langchain_plan",payload:{summary:e.summary,telemetry:e.telemetry},at:new Date().toISOString()};return{state:{...t,planId:e.planId,steps:e.planState.steps??t.steps,currentStepId:e.planState.currentStepId??e.stepId,pendingPlan:a,pendingUserReply:null,observations:K(t.observations,s)},actions:[n],label:"plan"}},W=({state:t,payload:e})=>{var I;const n=t.pendingUserReply;if(!n)return{state:t,actions:[],label:"plan"};const a=Q(e),s=n.optionId??n.freeText??n.question??"user-choice",o=n.freeText||((I=n.options.find(U=>U.id===n.optionId))==null?void 0:I.label)||n.optionId||n.question,p=t.planId??F(),r=n.optionId?z(n.optionId):void 0;if(!r&&a)return X(t,a);const i=!r,_=i?{chartType:"bar",title:o??"Custom Analysis",description:`Based on your selection ${o}`,aggregation:"sum",groupByColumn:"auto_inferred_column",valueColumn:"auto_inferred_metric",defaultTopN:8,defaultHideOthers:!0}:{chartType:"bar",title:o??"Data operation",description:o??"Data operation",aggregation:"count",groupByColumn:"auto_inferred_column",valueColumn:"auto_inferred_metric"},l=(r==null?void 0:r.stepId)??(n.optionId?`plan-${n.optionId}`:"plan-custom"),d=r?{id:l,intent:r.stepIntent,label:r.stepLabel,status:"in_progress"}:{id:l,intent:"analysis",label:`执行：${o}`,status:"in_progress"},h=[{type:"plan_state_update",responseType:"plan_state_update",stepId:l,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`根据你的选择更新计划：${o}`,planState:{planId:p,goal:(r==null?void 0:r.planGoal)??"完成你刚刚点选的分析任务",contextSummary:n.question,progress:(r==null?void 0:r.planProgress)??`收到你的选择「${o}」，准备执行。`,nextSteps:[d],steps:[d],currentStepId:l,blockedBy:null,observationIds:[],confidence:.62,updatedAt:new Date().toISOString(),stateTag:`ts${Date.now().toString(36)}-planstate`}}];r&&h.push(H({toolCall:r.toolCall,stepId:r.stepId,reason:r.reason,text:r.text}));const v=i?{id:l,summary:o??s,plan:_,createdAt:new Date().toISOString()}:null;return{state:{...t,planId:p,steps:[d],currentStepId:l,pendingPlan:v,pendingUserReply:null},actions:h,label:"plan"}},J=({state:t})=>{const e=t.pendingPlan;if(!e||!e.plan)return{state:t,actions:[],label:"act"};const n={type:"plan_creation",responseType:"plan_creation",stepId:e.id,stateTag:`ts${Date.now().toString(36)}-act`,timestamp:new Date().toISOString(),reason:`根据选择「${e.summary}」创建分析计划`,plan:e.plan};return{state:{...t,pendingPlan:null,pendingVerification:{id:e.id,description:e.summary,createdAt:new Date().toISOString()}},actions:[n],label:"act"}},Z=({state:t})=>{var r;const e=t.pendingVerification;if(!e)return{state:t,actions:[],label:"verify"};const n=e.meta,a=[];e.summary?a.push(e.summary):n&&(n.source&&a.push(`数据源：${n.source==="sample"?"采样":"全量"}`),typeof n.rows=="number"&&a.push(`记录数：${n.rows}`),typeof n.processedRows=="number"&&typeof n.totalRows=="number"&&a.push(`处理行：${n.processedRows}/${n.totalRows}`),(r=n.warnings)!=null&&r.length&&a.push(`警告 ${n.warnings.length} 条`),n.summary&&a.push(n.summary));const o=(()=>{const i=e.payload;if(!i||typeof i!="object")return null;switch(typeof i.kind=="string"?i.kind:null){case"profile_dataset":{const l=i.columns,d=i.rowCount,y=i.sampledRows;return`列画像：${l??"?"} 列 · ${d??"?"} 行（采样 ${y??"?"}）`}case"normalize_invoice_month":{const l=i.column??"InvoiceMonth",d=i.normalizedCount,y=i.skippedCount;return`标准化 ${l}：成功 ${d??0}，跳过 ${y??0}`}case"detect_outliers":{const l=i.column??"value",d=i.count,y=i.threshold;return`异常检测 ${l}：找到 ${d??0} 条（阈值 ${y??"?"}）`}case"aggregate_plan":{const l=i.planTitle??e.description,d=i.rows;return`聚合视图「${l}」产生 ${d??0} 行结果。`}default:return null}})();o&&a.push(o);const p={type:"text_response",responseType:"text_response",stepId:e.id,stateTag:`ts${Date.now().toString(36)}-verify`,timestamp:new Date().toISOString(),reason:"确认最新的聚合结果，并说明数据来源。",text:n?`已完成「${e.description}」。
${a.join(" · ")}`:`已完成「${e.description}」的初步执行，准备生成可视化或进一步说明。`};return{state:{...t,pendingVerification:null},actions:[p],label:"verify"}},tt=({state:t})=>{const e={type:"text_response",responseType:"text_response",stepId:t.currentStepId??"adjust-next-step",stateTag:`ts${Date.now().toString(36)}-adjust`,timestamp:new Date().toISOString(),reason:"提出下一步建议以延伸分析。",text:"下一步可继续筛选特定供应商或启用异常侦测。随时告诉我想要深入的角度。"};return{state:t,actions:[e],label:"adjust"}},et=[G,q,W,J,Z,tt],nt=t=>{let e=t.state;const n=[];for(const a of et){const s=a({state:e,payload:t.payload});if(e=s.state,s.actions.length>0&&n.push(...s.actions),s.halted)return{state:e,actions:n,halted:!0,label:s.label}}return{state:e,actions:n,halted:!1,label:"complete"}},w=self;let u=N();const T=20,g=t=>{w.postMessage(t)},m=()=>Date.now(),$=()=>{g({type:"graph/ready",version:x,timestamp:m()})},at=t=>{switch(t.type){case"graph/init":$();return;case"graph/ping":g({type:"graph/pong",nonce:t.nonce,timestamp:m()});return;case"graph/shutdown":g({type:"graph/log",level:"info",message:t.reason?`Graph runtime shutting down: ${t.reason}`:"Graph runtime shutting down by request.",timestamp:m()}),w.close();return;case"graph/applyActions":st(t.actions??[]);return;case"graph/runPipeline":ot(t.payload??{});return;case"graph/userReply":rt(t.optionId??null,t.freeText??null);return;case"graph/tool_result":it(t.verification);return;default:g({type:"graph/log",level:"warn",message:`Unhandled client event ${t.type}`,timestamp:m()})}},st=t=>{var a,s,o,p;const e=m(),n=B(u,t);n.ok&&n.nextState&&(u=n.nextState),g({type:"graph/validation",ok:n.ok,timestamp:e,code:(s=(a=n.violations)==null?void 0:a[0])==null?void 0:s.code,reason:(p=(o=n.violations)==null?void 0:o[0])==null?void 0:p.message,state:n.nextState})},ot=t=>{const e=nt({state:u,payload:t});u=e.state,g({type:"graph/pipeline",node:e.label,actions:e.actions,state:u,timestamp:m()})},rt=(t,e)=>{const n=u.awaitPrompt;u={...u,awaitingUser:!1,blockedBy:null,awaitPrompt:null,awaitPromptId:null,pendingUserReply:{optionId:t??null,freeText:e??null,promptId:(n==null?void 0:n.promptId)??null,question:(n==null?void 0:n.question)??"User follow-up",options:(n==null?void 0:n.options)??[],at:new Date().toISOString()},stateTag:"context_ready",updatedAt:new Date().toISOString()};const a=t||e?`User replied with ${t??""} ${e??""}`.trim():"User reply received.";g({type:"graph/log",level:"info",message:a,timestamp:m()})},it=t=>{var p;const e=`verify-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,n=new Date().toISOString(),a={id:e,kind:typeof((p=t.payload)==null?void 0:p.kind)=="string"?t.payload.kind:"tool_result",payload:{description:t.description,summary:t.summary??null,meta:t.meta??null,...t.payload??{}},at:n},s=[...u.observations,a],o=s.length>T?s.slice(s.length-T):s;u={...u,pendingVerification:{id:e,description:t.description,meta:t.meta?{...t.meta,summary:t.summary??void 0}:null,summary:t.summary??null,payload:t.payload??null,createdAt:n},observations:o}};w.addEventListener("message",t=>{const e=t.data;if(!e||typeof e!="object"||typeof e.type!="string"){g({type:"graph/log",level:"warn",message:"Ignored message without graph type.",timestamp:m()});return}at(e)});$();
