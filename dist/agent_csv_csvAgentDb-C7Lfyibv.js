const B=(e,t)=>t.some(n=>e instanceof n);let M,A;function z(){return M||(M=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function G(){return A||(A=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const P=new WeakMap,E=new WeakMap,D=new WeakMap;function J(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",o),e.removeEventListener("error",a)},o=()=>{n(h(e.result)),s()},a=()=>{r(e.error),s()};e.addEventListener("success",o),e.addEventListener("error",a)});return D.set(t,e),t}function Q(e){if(P.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",a),e.removeEventListener("abort",a)},o=()=>{n(),s()},a=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",o),e.addEventListener("error",a),e.addEventListener("abort",a)});P.set(e,t)}let k={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return P.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return h(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function W(e){k=e(k)}function X(e){return G().includes(e)?function(...t){return e.apply(O(this),t),h(this.request)}:function(...t){return h(e.apply(O(this),t))}}function Y(e){return typeof e=="function"?X(e):(e instanceof IDBTransaction&&Q(e),B(e,z())?new Proxy(e,k):e)}function h(e){if(e instanceof IDBRequest)return J(e);if(E.has(e))return E.get(e);const t=Y(e);return t!==e&&(E.set(e,t),D.set(t,e)),t}const O=e=>D.get(e);function Z(e,t,{blocked:n,upgrade:r,blocking:s,terminated:o}={}){const a=indexedDB.open(e,t),i=h(a);return r&&a.addEventListener("upgradeneeded",c=>{r(h(a.result),c.oldVersion,c.newVersion,h(a.transaction),c)}),n&&a.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),i.then(c=>{o&&c.addEventListener("close",()=>o()),s&&c.addEventListener("versionchange",d=>s(d.oldVersion,d.newVersion,d))}).catch(()=>{}),i}const tt=["get","getKey","getAll","getAllKeys","count"],et=["put","add","delete","clear"],C=new Map;function _(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(C.get(t))return C.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=et.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||tt.includes(n)))return;const o=async function(a,...i){const c=this.transaction(a,s?"readwrite":"readonly");let d=c.store;return r&&(d=d.index(i.shift())),(await Promise.all([d[n](...i),s&&c.done]))[0]};return C.set(t,o),o}W(e=>({...e,get:(t,n,r)=>_(t,n)||e.get(t,n,r),has:(t,n)=>!!_(t,n)||e.has(t,n)}));const nt=["continue","continuePrimaryKey","advance"],L={},v=new WeakMap,$=new WeakMap,rt={get(e,t){if(!nt.includes(t))return e[t];let n=L[t];return n||(n=L[t]=function(...r){v.set(this,$.get(this)[t](...r))}),n}};async function*ot(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,rt);for($.set(n,t),D.set(n,O(t));t;)yield n,t=await(v.get(n)||t.continue()),v.delete(n)}function T(e,t){return t===Symbol.asyncIterator&&B(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&B(e,[IDBIndex,IDBObjectStore])}W(e=>({...e,get(t,n,r){return T(t,n)?ot:e.get(t,n,r)},has(t,n){return T(t,n)||e.has(t,n)}}));const F="csv_agent_db",st=3,I="provenance",l="clean_rows",w="columns",u="views";let f=null;const U=async()=>{await new Promise((e,t)=>{const n=indexedDB.deleteDatabase(F);n.onsuccess=()=>e(),n.onerror=()=>t(n.error),n.onblocked=()=>console.warn("IndexedDB delete blocked. Close other tabs to proceed.")}),f=null},at=(e,t)=>{if(!e.objectStoreNames.contains(t)){if(t===l){e.createObjectStore(t,{keyPath:"chunkId"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(t===w){e.createObjectStore(t,{keyPath:"datasetId"});return}if(t===u){e.createObjectStore(t,{keyPath:"id"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(t===I){e.createObjectStore(t,{keyPath:"datasetId"});return}throw new Error(`Unsupported store name: ${t}`)}},V=async e=>{try{return await e()}catch(t){if(t instanceof DOMException&&t.name==="VersionError")return console.warn("IndexedDB version mismatch detected. Resetting csv_agent_db...",t),await U(),e();throw t}},ct=[I,l,w,u],y=async(e=[])=>{const t=Array.from(new Set([...ct,...e])),n=(a,i)=>Z(F,a,{upgrade(c){i.forEach(d=>at(c,d))}});if(!f)return f=V(()=>n(st,t)),f;const r=await f;if(t.filter(a=>!r.objectStoreNames.contains(a)).length===0)return r;r.close();const o=r.version+1;return f=V(()=>n(o,t)),f},it=(e,t)=>{const n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n},ut=async e=>{const{datasetId:t,rows:n,columns:r,provenance:s,chunkSize:o=2e4}=e;if(!t)throw new Error("persistCleanDataset requires datasetId.");const a=async()=>{const c=(await y([l,w,u])).transaction([l,w,I],"readwrite"),d=c.objectStore(l),g=c.objectStore(w),S=c.objectStore(I);let m=await d.index("by_dataset").openCursor(t);for(;m;)await m.delete(),m=await m.continue();const p=it(n,o),j=new Date().toISOString();for(let b=0;b<p.length;b+=1){const x=p[b],H={chunkId:`${t}-chunk-${b}`,datasetId:t,rowCount:x.length,startRow:b*o,endRow:b*o+x.length-1,rows:x,createdAt:j};await d.put(H)}const K={datasetId:t,columnCount:r.length,columns:r,rowCount:n.length,updatedAt:j};await g.put(K);const q={datasetId:t,fileName:s.fileName,bytes:s.bytes,checksum:s.checksum,cleanedAt:s.cleanedAt};return await S.put(q),await c.done,{chunkCount:p.length,rowCount:n.length}};try{return await a()}catch(i){if(i instanceof DOMException&&i.name==="NotFoundError")return console.warn("IndexedDB store missing detected. Resetting and retrying persist...",i),await U(),a();throw i}},lt=async e=>{const{datasetId:t,title:n,kind:r,queryHash:s,explainer:o,dataRef:a}=e,c=(await y([u])).transaction(u,"readwrite"),d=c.objectStore(u),g=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,S=`${t}-view-${g}`,R={id:S,datasetId:t,title:n,kind:r,queryHash:s,explainer:o,dataRef:a,createdAt:new Date().toISOString()};return await d.put(R),await c.done,S},wt=async e=>{const t=await y([u]);try{const n=t.transaction(u,"readonly"),o=await n.objectStore(u).index("by_dataset").getAll(e);return await n.done,o}catch(n){return console.warn(`Failed to read card results for ${e}`,n),[]}},ft=async e=>{const n=(await y()).transaction(I,"readonly"),s=await n.objectStore(I).get(e);return await n.done,s??void 0},dt=async e=>{const n=(await y([w])).transaction(w,"readonly"),s=await n.objectStore(w).get(e);return await n.done,s??null},ht=async e=>{const t=await dt(e);return(t==null?void 0:t.columns)??null},N=async(e,t)=>{const r=(await y([l])).transaction(l,"readonly"),o=r.objectStore(l).index("by_dataset");let a=!1;const i=()=>{a=!0};let c=await o.openCursor(e);for(;c&&!a;){const d=c.value;if(await t(d,i),a)break;c=await c.continue()}await r.done},yt=async(e,t)=>{const n=[];return await N(e,(r,s)=>{for(const o of r.rows)if(n.push(o),n.length>=t){s();break}}),n},bt=async e=>{const t=[];return await N(e,n=>{t.push(...n.rows)}),t},It=async e=>{const n=(await y([u])).transaction(u,"readwrite");let o=await n.objectStore(u).index("by_dataset").openCursor(e);for(;o;)await o.delete(),o=await o.continue();await n.done};export{It as clearCardResults,ut as persistCleanDataset,bt as readAllRows,wt as readCardResults,ht as readColumnProfiles,dt as readColumnStoreRecord,ft as readProvenance,yt as readSampledRows,lt as saveCardResult};
