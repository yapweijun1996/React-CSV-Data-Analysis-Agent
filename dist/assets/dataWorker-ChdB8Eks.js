(function(){"use strict";const v=t=>{if(t==null)return null;let e=String(t).trim();if(e==="")return null;let n=!1;e.startsWith("(")&&e.endsWith(")")&&(e=e.substring(1,e.length-1),n=!0),e=e.replace(/[$\s€£¥%]/g,"");const s=e.lastIndexOf(","),r=e.lastIndexOf(".");s>r?e=e.replace(/\./g,"").replace(",","."):e=e.replace(/,/g,"");const o=parseFloat(e);return isNaN(o)?null:n?-o:o},J=t=>{if(!t||t.length===0)return[];const e=Object.keys(t[0]),n=[];for(const s of e){let r=!0;const o=t.map(u=>u[s]);let a=0;for(const u of o){const i=v(u);if(u!==null&&String(u).trim()!==""){if(i===null){r=!1;break}a++}}if(r&&a>0){const u=o.map(v).filter(i=>i!==null);n.push({name:s,type:"numerical",valueRange:[Math.min(...u),Math.max(...u)],missingPercentage:(1-u.length/t.length)*100})}else{const u=new Set(o.map(String));n.push({name:s,type:"categorical",uniqueValues:u.size,missingPercentage:o.filter(i=>i===null||String(i).trim()==="").length/t.length*100})}}return n},L=(t,e)=>e.some(n=>t instanceof n);let O,F;function Z(){return O||(O=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Q(){return F||(F=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const _=new WeakMap,N=new WeakMap,S=new WeakMap;function X(t){const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("success",o),t.removeEventListener("error",a)},o=()=>{n(p(t.result)),r()},a=()=>{s(t.error),r()};t.addEventListener("success",o),t.addEventListener("error",a)});return S.set(e,t),e}function ee(t){if(_.has(t))return;const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",a),t.removeEventListener("abort",a)},o=()=>{n(),r()},a=()=>{s(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",o),t.addEventListener("error",a),t.addEventListener("abort",a)});_.set(t,e)}let P={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return _.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return p(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function T(t){P=t(P)}function te(t){return Q().includes(t)?function(...e){return t.apply(D(this),e),p(this.request)}:function(...e){return p(t.apply(D(this),e))}}function ne(t){return typeof t=="function"?te(t):(t instanceof IDBTransaction&&ee(t),L(t,Z())?new Proxy(t,P):t)}function p(t){if(t instanceof IDBRequest)return X(t);if(N.has(t))return N.get(t);const e=ne(t);return e!==t&&(N.set(t,e),S.set(e,t)),e}const D=t=>S.get(t);function x(t,e,{blocked:n,upgrade:s,blocking:r,terminated:o}={}){const a=indexedDB.open(t,e),u=p(a);return s&&a.addEventListener("upgradeneeded",i=>{s(p(a.result),i.oldVersion,i.newVersion,p(a.transaction),i)}),n&&a.addEventListener("blocked",i=>n(i.oldVersion,i.newVersion,i)),u.then(i=>{o&&i.addEventListener("close",()=>o()),r&&i.addEventListener("versionchange",m=>r(m.oldVersion,m.newVersion,m))}).catch(()=>{}),u}const re=["get","getKey","getAll","getAllKeys","count"],oe=["put","add","delete","clear"],k=new Map;function R(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(k.get(e))return k.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,r=oe.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(r||re.includes(n)))return;const o=async function(a,...u){const i=this.transaction(a,r?"readwrite":"readonly");let m=i.store;return s&&(m=m.index(u.shift())),(await Promise.all([m[n](...u),r&&i.done]))[0]};return k.set(e,o),o}T(t=>({...t,get:(e,n,s)=>R(e,n)||t.get(e,n,s),has:(e,n)=>!!R(e,n)||t.has(e,n)}));const se=["continue","continuePrimaryKey","advance"],V={},A=new WeakMap,j=new WeakMap,ae={get(t,e){if(!se.includes(e))return t[e];let n=V[e];return n||(n=V[e]=function(...s){A.set(this,j.get(this)[e](...s))}),n}};async function*ie(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,ae);for(j.set(n,e),S.set(n,D(e));e;)yield n,e=await(A.get(n)||e.continue()),A.delete(n)}function $(t,e){return e===Symbol.asyncIterator&&L(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&L(t,[IDBIndex,IDBObjectStore])}T(t=>({...t,get(e,n,s){return $(e,n)?ie:t.get(e,n,s)},has(e,n){return $(e,n)||t.has(e,n)}}));const U="csv_agent_db",ce=1,M="provenance";let E=null;const W=t=>({clean:`clean_rows_${t}`,columns:`columns_${t}`,views:`views_${t}`}),y=(t,e)=>{if(!t.objectStoreNames.contains(e)){if(e.startsWith("clean_rows_")){t.createObjectStore(e,{keyPath:"chunkId"});return}if(e.startsWith("columns_")){t.createObjectStore(e,{keyPath:"id"});return}if(e.startsWith("views_")){t.createObjectStore(e,{keyPath:"id"});return}if(e===M){t.createObjectStore(e,{keyPath:"datasetId"});return}throw new Error(`Unsupported store name: ${e}`)}},K=async(t=[])=>{if(!E)return E=x(U,ce,{upgrade(r){y(r,M),t.forEach(o=>y(r,o))}}),E;const e=await E,n=t.filter(r=>!e.objectStoreNames.contains(r));if(n.length===0)return e;e.close();const s=e.version+1;return E=x(U,s,{upgrade(r){y(r,M),t.forEach(o=>y(r,o)),n.forEach(o=>y(r,o))}}),E},B=async t=>{const{columns:e}=W(t),s=(await K([e])).transaction(e,"readonly"),o=await s.objectStore(e).get("columns");return await s.done,o??null},z=async(t,e)=>{const{clean:n}=W(t),r=(await K([n])).transaction(n,"readonly"),o=r.objectStore(n);let a=!1;const u=()=>{a=!0};let i=await o.openCursor();for(;i&&!a;){const m=i.value;if(await e(m,u),a)break;i=await i.continue()}await r.done},C=async(t,e)=>{const n=[];return await z(t,(s,r)=>{for(const o of s.rows)if(n.push(o),n.length>=e){r();break}}),n},ue=async t=>{const e=[];return await z(t,n=>{e.push(...n.rows)}),e},le=2e3,fe=1e3,me=3e3,de=3e3,we=t=>{let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e).toString(36)},I=t=>t==null?"":typeof t=="string"?t.trim():String(t),he=(t,e,n=3)=>{const s=[];for(const r of t){const o=r[e];if(o==null||o==="")continue;const a=I(o);if(a&&(s.includes(a)||s.push(a),s.length>=n))break}return s},ge=async t=>{const{datasetId:e,sampleSize:n=le}=t;if(!e)throw new Error("datasetId is required for profiling.");const[s,r]=await Promise.all([B(e),C(e,n)]);if(!s)throw new Error("No cached metadata for this dataset. Try re-uploading the CSV.");if(r.length===0)throw new Error("No rows available to profile.");const a=J(r).map(i=>({name:i.name,type:i.type,distinct:i.uniqueValues??new Set(r.map(m=>m[i.name])).size,emptyPercentage:i.missingPercentage??0,examples:he(r,i.name)})),u=[];return s.rowCount>r.length&&u.push(`Profiled ${r.length.toLocaleString()} rows (sample) out of ${s.rowCount.toLocaleString()}.`),{rowCount:s.rowCount,sampledRows:r.length,columns:a,warnings:u}},be=(t,e)=>!e||e.length===0?!0:e.every(n=>{const s=t[n.column],r=I(s),o=I(n.value??"");switch(n.op){case"eq":return n.caseInsensitive?r.toLowerCase()===o.toLowerCase():r===o;case"neq":return n.caseInsensitive?r.toLowerCase()!==o.toLowerCase():r!==o;case"gt":return Number(r)>Number(o);case"gte":return Number(r)>=Number(o);case"lt":return Number(r)<Number(o);case"lte":return Number(r)<=Number(o);case"contains":return r.toLowerCase().includes(o.toLowerCase());case"in":return Array.isArray(n.values)?n.values.some(a=>I(a)===r):!1;default:return!0}}),pe=t=>{if(t==null)return null;if(typeof t=="number"&&Number.isFinite(t))return t;const e=I(t).replace(/[$,%\s]/g,"").replace(/,/g,"");if(!e)return null;const n=Number(e);return Number.isFinite(n)?n:null},G=(t,e,n)=>{var H;const s=e.mode??"sample";if(!Array.isArray(e.metrics)||e.metrics.length===0)throw new Error("metrics[] is required for aggregation.");if(s==="full"&&!e.allowFullScan)throw new Error("FULL_SCAN_BLOCKED");const r=e.by??[],o=new Map,a=((H=e.filter)==null?void 0:H.length)??0,u=performance.now()+de;for(const d of t){if(!be(d,e.filter))continue;if(performance.now()>u){if(s==="full")throw new Error("AGG_TIMEOUT");break}const h=r.map(c=>I(d[c])),w=h.length>0?h.join("||"):"__total__";if(!o.has(w)){const c={};r.forEach((f,b)=>{c[f]=h[b]});const l={};e.metrics.forEach(f=>{const b=f.as??`${f.fn}_${f.column??"rows"}`;l[b]={sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}}),o.set(w,{keys:c,accumulators:l})}const g=o.get(w);e.metrics.forEach(c=>{const l=c.as??`${c.fn}_${c.column??"rows"}`,f=g.accumulators[l];if(c.fn==="count"){f.count+=1,f.sum+=1;return}if(!c.column)throw new Error(`Metric ${c.fn} requires a column.`);const b=pe(d[c.column]);b!==null&&(f.count+=1,f.sum+=b,f.min=Math.min(f.min,b),f.max=Math.max(f.max,b))})}const i=[...r.map(d=>({name:d,type:"string"})),...e.metrics.map(d=>({name:d.as??`${d.fn}_${d.column??"rows"}`,type:"number"}))],m=[];for(const d of o.values()){const h={...d.keys};e.metrics.forEach(w=>{const g=w.as??`${w.fn}_${w.column??"rows"}`,c=d.accumulators[g];let l=null;switch(w.fn){case"sum":l=c.sum;break;case"avg":l=c.count>0?c.sum/c.count:null;break;case"count":l=c.count;break;case"min":l=c.min===Number.POSITIVE_INFINITY?null:c.min;break;case"max":l=c.max===Number.NEGATIVE_INFINITY?null:c.max;break}h[g]=l??0}),m.push(h)}e.orderBy&&e.orderBy.length>0&&m.sort((d,h)=>{for(const w of e.orderBy){const g=(w.direction??"desc").toLowerCase()==="asc"?1:-1,c=d[w.column],l=h[w.column];if(c===l)continue;if(c==null)return 1;if(l==null)return-1;if(typeof c=="number"&&typeof l=="number")return c>l?g:-g;const f=String(c).localeCompare(String(l));if(f!==0)return f*g}return 0});const Se=typeof e.limit=="number"?m.slice(0,e.limit):m,q=s!=="full",Y=[];return q&&Y.push("Aggregated on sampled rows. Retry with allowFullScan for full coverage."),{schema:i,rows:Se,provenance:{datasetId:e.datasetId,sampled:q,mode:s,processedRows:t.length,totalRows:n,queryHash:we(JSON.stringify({by:r,metrics:e.metrics,filter:e.filter,orderBy:e.orderBy,limit:e.limit,mode:s})),filterCount:a,warnings:Y}}},Ee=async t=>{const e=await B(t.datasetId);if(!e)throw new Error("No cached metadata for aggregation.");const n=t.mode??"sample",s=t.sampleSize??me;try{const r=n==="full"?await ue(t.datasetId):await C(t.datasetId,s);if(r.length===0)throw new Error("No rows available for aggregation.");return G(r,t,e.rowCount)}catch(r){if(r instanceof Error&&r.message==="FULL_SCAN_BLOCKED")throw Object.assign(new Error("Full scan requires confirmation."),{code:"FULL_SCAN_BLOCKED"});if(r instanceof Error&&r.message==="AGG_TIMEOUT"&&n==="full"){const o=await C(t.datasetId,s),a=G(o,{...t,mode:"sample"},e.rowCount);return a.provenance.warnings.push("Full scan timed out. Showing sampled results."),a}throw r}},Ie=async t=>{const{datasetId:e,n=fe,withColumns:s=!1}=t;if(!e)throw new Error("datasetId is required for sampling.");const[r,o]=await Promise.all([C(e,n),s?B(e):Promise.resolve(null)]);if(r.length===0)throw new Error("No rows available to sample.");return{rows:r,sampled:!0,columns:o==null?void 0:o.columns}},ye=async t=>{const e=performance.now();try{let n;switch(t.action){case"profile":n=await ge(t.payload);break;case"sample":n=await Ie(t.payload);break;case"aggregate":n=await Ee(t.payload);break;default:throw new Error(`Unknown action: ${t.action}`)}return{id:t.id,ok:!0,result:n,durationMs:performance.now()-e}}catch(n){const s=n instanceof Error?n.message:"Unknown worker error",r=n instanceof Error&&n.code==="FULL_SCAN_BLOCKED"?"Please confirm full scan with the user, then retry with allowFullScan=true.":"Retry with a smaller sample or adjust your query.";return{id:t.id,ok:!1,reason:s,hint:r,durationMs:performance.now()-e}}};self.addEventListener("message",t=>{const e=t.data;!e||typeof e.id!="string"||ye(e).then(n=>{self.postMessage(n)})})})();
