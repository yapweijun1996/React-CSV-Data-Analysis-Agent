<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Data Analysis Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#2563eb', // A slightly brighter blue for light mode
              'brand-secondary': '#3b82f6',
            },
            animation: {
                'loading-shimmer': 'loading-shimmer 2s infinite linear',
            },
            keyframes: {
                'loading-shimmer': {
                    '0%': { 'background-position': '-200% 0' },
                    '100%': { 'background-position': '200% 0' },
                }
            }
          },
        },
      }
    </script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Papaparse for CSV parsing -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- IDB for IndexedDB -->
    <script src="https://unpkg.com/idb@7.1.1/build/umd.js"></script>
    <!-- html-to-image for exporting -->
    <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>

  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.28.0",
    "idb": "https://aistudiocdn.com/idb@^8.0.3",
    "zustand": "https://aistudiocdn.com/zustand@^4.5.4",
    "openai": "https://aistudiocdn.com/openai@^4.52.7"
  }
}
</script>
    <script type="module" crossorigin src="/agent_csv_index.js"></script>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    <script>
      // Engineer presets: edit values below to bake in defaults for every user session.
      window.tempgeminiapikey = window.tempgeminiapikey ?? ''; // e.g. 'AIza...'
      window.tempopenaiapikey = window.tempopenaiapikey ?? ''; // e.g. 'sk-...'
      window.__CSV_AGENT_DEFAULTS__ = {
        defaultSettings: {
          provider: 'google', // 'google' | 'openai'
          model: 'gemini-2.5-flash',
          language: 'Mandarin', // 'English' | 'Mandarin' | 'Spanish' | 'Japanese' | 'French'
          geminiApiKey: window.tempgeminiapikey,
          openAIApiKey: window.tempopenaiapikey,
        },
        ui: {
          showNewButton: false, // false hides the "New" session button
          showSettingsButton: true, // false hides the gear icon in Assistant panel
        },
      };
    </script>
    <script>
      (function () {
        const TARGET_ORIGIN = window.location.origin;
        const queue = [];

        function sanitizeFileStem(rawHeader) {
          if (!rawHeader) return 'report';
          const firstLine = rawHeader
            .split(/\r?\n/)
            .map((line) => line.trim())
            .find(Boolean);
          if (!firstLine) return 'report';
          return firstLine
            .replace(/[^a-z0-9-_]+/gi, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '')
            .slice(0, 60) || 'report';
        }

        function enqueuePayload(payload) {
          queue.push(payload);
          window.dispatchEvent(new CustomEvent('ai-table-csv', { detail: payload }));
        }

        window.__getNextCsvPayload = function () {
          return queue.length ? queue.shift() : null;
        };

        window.addEventListener('message', (event) => {
          if (event.origin !== TARGET_ORIGIN || !event.data) return;
          const { type, csv, header } = event.data;
          if (type !== 'table_csv' || typeof csv !== 'string') return;

          const sanitizedHeader = typeof header === 'string' ? header : '';
          const fileStem = sanitizeFileStem(sanitizedHeader);
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          const fileName = `${fileStem}-${timestamp}.csv`;

          enqueuePayload({
            csv,
            header: sanitizedHeader,
            fileName,
            receivedAt: Date.now(),
          });
        });

        function notifyOpenerReady() {
          if (!window.opener) return;
          try {
            window.opener.postMessage({ type: 'ready' }, TARGET_ORIGIN);
          } catch (error) {
            console.warn('Unable to notify opener about readiness.', error);
          }
        }

        if (document.readyState === 'complete') {
          notifyOpenerReady();
        } else {
          window.addEventListener('load', notifyOpenerReady);
        }
      })();
    </script>
  </body>
</html>
