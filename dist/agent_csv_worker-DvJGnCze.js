class T{constructor(){this.nodes=new Map,this.edges=new Map,this.entryPoint=null}addNode(e,n){return this.nodes.set(e,n),this}addEdge(e,n){return this.edges.set(e,n),this}setEntryPoint(e){return this.entryPoint=e,this}build(){if(!this.entryPoint)throw new Error("LangGraphBuilder requires an entry point via setEntryPoint().");return new v(this.entryPoint,this.nodes,this.edges)}}class v{constructor(e,n,a){this.entryPoint=e,this.nodes=n,this.edges=a}async invoke(e){var l;let n=this.entryPoint,a=e.state;const s=[];let r=!1,i=n;for(;n;){const o=this.nodes.get(n);if(!o)throw new Error(`LangGraphMachine missing node handler for "${n}".`);const c=await o({state:a,payload:e.payload});if(a=c.state,(l=c.actions)!=null&&l.length&&s.push(...c.actions),i=c.label??n,c.halted){r=!0;break}n=this.edges.get(n)}return{state:a,actions:s,halted:r,label:i??"complete"}}}const $="0.1.0",k="context_ready",U=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`session-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,x=(t,e)=>{const n=new Date().toISOString(),a={sessionId:U(),planId:null,stateTag:k,awaitingUser:!1,awaitPrompt:null,awaitPromptId:null,pendingUserReply:null,pendingPlan:null,pendingVerification:null,steps:[],currentStepId:null,blockedBy:null,observations:[],viewIds:[],warnings:[],updatedAt:n};return{...a,...e,steps:a.steps,observations:a.observations,viewIds:a.viewIds,warnings:a.warnings}},D=["ready","in_progress","done"],b=t=>t?["context_ready","awaiting_clarification","needs_clarification"].includes(t)?!0:/^\d{5,}-\d+$/.test(t)||/^ts[0-9a-z]{2,}-[0-9a-z_-]+$/i.test(t):!1,O=t=>{if(!Array.isArray(t))return[];const e=new Set,n=[];return t.forEach(a=>{const s=typeof(a==null?void 0:a.id)=="string"?a.id.trim():"",r=typeof(a==null?void 0:a.label)=="string"?a.label.trim():"",i=typeof(a==null?void 0:a.intent)=="string"?a.intent.trim():"conversation";if(s.length<3||r.length<3||e.has(s))return;const l=D.includes(a.status)?a.status:"ready";n.push({id:s,label:r,intent:i,status:l}),e.add(s)}),n},E=(t,e)=>{var r;if(!e)return t;const n=O(e.steps??e.nextSteps),a=typeof e.currentStepId=="string"&&e.currentStepId.trim().length>=3?e.currentStepId.trim():((r=n[0])==null?void 0:r.id)??t.currentStepId,s=typeof e.planId=="string"&&e.planId.trim().length>=3?e.planId.trim():t.planId;return{...t,planId:s,steps:n,currentStepId:a,blockedBy:e.blockedBy??t.blockedBy,stateTag:e.stateTag&&b(e.stateTag)?e.stateTag:t.stateTag,updatedAt:new Date().toISOString(),awaitPrompt:t.awaitPrompt,awaitPromptId:t.awaitPromptId,pendingUserReply:t.pendingUserReply}},_=t=>t?b(t):!1,R=["text_response","await_user","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request"],C=(t,e)=>{if(!Array.isArray(e)||e.length===0)return{ok:!0,nextState:t,acceptedActions:[]};if(t.awaitingUser)return g("awaiting_user","Graph is waiting for user input; no actions can run.",t);if(e.length>2)return g("turn_budget_exceeded","Each turn may include at most 2 actions.",t);const n=e[0];if(n.responseType!=="plan_state_update")return g("first_action_plan_required","First action must be plan_state_update.",t);if(!_(n.stateTag))return g("invalid_state_tag","plan_state_update is missing a valid stateTag.",t);if(!n.planState)return g("missing_plan_state","plan_state_update is missing planState payload.",t);const a=e[1];if(a){if(a.responseType==="plan_state_update")return g("atomic_type_invalid","Second action must be atomic, not plan_state_update.",t);if(!R.includes(a.responseType))return g("atomic_type_invalid",`Atomic action ${a.responseType} is not permitted in this turn.`,t);if(!_(a.stateTag))return g("invalid_state_tag","Atomic action is missing a valid stateTag.",t)}return{ok:!0,nextState:N(t,n,a),acceptedActions:e}},N=(t,e,n)=>{var r,i,l,o,c,d;let a=E(t,e.planState);return a={...a,stateTag:e.stateTag??a.stateTag,updatedAt:new Date().toISOString()},!!((r=e.meta)!=null&&r.awaitUser)||((i=e.planState)==null?void 0:i.blockedBy)==="awaiting_user_choice"||!!((l=n==null?void 0:n.meta)!=null&&l.awaitUser)||(n==null?void 0:n.responseType)==="await_user"?a={...a,awaitingUser:!0,blockedBy:((o=e.planState)==null?void 0:o.blockedBy)??(n==null?void 0:n.reason)??"awaiting_user_choice",awaitPrompt:(n==null?void 0:n.awaitUserPayload)??a.awaitPrompt,awaitPromptId:((c=n==null?void 0:n.awaitUserPayload)==null?void 0:c.promptId)??a.awaitPromptId}:a={...a,awaitingUser:!1,blockedBy:((d=e.planState)==null?void 0:d.blockedBy)??null,awaitPrompt:null,awaitPromptId:null},a},g=(t,e,n)=>({ok:!1,violations:[{code:t,message:e}],nextState:n}),M=t=>x(),A=({state:t})=>{const e={...t,warnings:t.warnings??[]},n=t.observations.some(s=>s.kind==="profile_dataset"),a=[];return n||a.push({type:"execute_js_code",responseType:"execute_js_code",stepId:t.currentStepId??"diagnose-profile",stateTag:t.stateTag??"context_ready",timestamp:new Date().toISOString(),reason:"需要列画像来制定计划。",meta:{toolCall:{kind:"profile_dataset"}},toolCall:{kind:"profile_dataset"}}),{state:e,actions:a,label:"diagnose"}},I="你想先做哪項？",L=[{id:"clean_month",label:"清洗/标准化 InvoiceMonth"},{id:"top_payees",label:"Top 收款方（总额/笔数/客单）"},{id:"outlier",label:"异常大额清单"},{id:"by_type",label:"按 PayeeType 分解"}],G=()=>`prompt-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,B=({state:t})=>{if(t.pendingUserReply)return{state:t,actions:[],label:"ask_user"};if(t.awaitingUser&&t.awaitPrompt){const r={type:"await_user",responseType:"await_user",stepId:t.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Still waiting for your selection before continuing.",text:t.awaitPrompt.question,meta:{awaitUser:!0,haltAfter:!0,promptId:t.awaitPrompt.promptId},awaitUserPayload:t.awaitPrompt};return{state:t,actions:[r],halted:!0,label:"ask_user"}}const e=G(),n={promptId:e,question:I,options:L,allowFreeText:!0,placeholder:"或输入：Top10 by amount desc"},a={type:"await_user",responseType:"await_user",stepId:t.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Need user choice before continuing the analysis plan.",text:I,meta:{awaitUser:!0,haltAfter:!0,promptId:e},awaitUserPayload:n},s=t.steps.length>0?t.steps:[{id:"ask-user-choice",intent:"clarification",label:"Await user choice before planning",status:"waiting_user"}];return{state:{...t,awaitingUser:!0,blockedBy:"awaiting_user_choice",stateTag:"awaiting_clarification",steps:s,awaitPrompt:n,awaitPromptId:e,pendingPlan:null,pendingVerification:null,updatedAt:new Date().toISOString()},actions:[a],halted:!0,label:"ask_user"}},j={clean_month:{toolCall:{kind:"normalize_invoice_month",params:{column:"InvoiceMonth"}},stepId:"normalize-invoice-month",stepLabel:"标准化 InvoiceMonth 字段",stepIntent:"data_cleaning",planGoal:"标准化发票月份字段，确保后续聚合一致。",planProgress:"已进入 InvoiceMonth 字段标准化阶段。",reason:"根据你的选择，先统一 InvoiceMonth 字段格式。",text:"正在本地标准化 InvoiceMonth 字段（YYYY-MM），完成后我会告知影响行数。"},outlier:{toolCall:{kind:"detect_outliers",params:{valueColumn:"Amount",multiplier:3}},stepId:"detect-amount-outliers",stepLabel:"侦测金额异常值",stepIntent:"data_validation",planGoal:"识别金额异常交易记录，提供可疑清单。",planProgress:"已开始金额异常检测（以 Amount 字段计算阈值）。",reason:"根据你的选择，先扫描金额异常值。",text:"正在比较 Amount 分布，找出超过阈值的可疑记录，稍后回报。"}},q=t=>t?j[t]:void 0,V=t=>{if(!t||typeof t!="object")return!1;const e=t;return e.source==="langchain"&&typeof e.planId=="string"&&typeof e.stepId=="string"},z=()=>`plan-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,f=20,Y=t=>({type:"execute_js_code",responseType:"execute_js_code",stepId:t.stepId,stateTag:`ts${Date.now().toString(36)}-tool`,timestamp:new Date().toISOString(),reason:t.reason,text:t.text,meta:{toolCall:t.toolCall},toolCall:t.toolCall}),F=(t,e)=>{const n=[...t,e];return n.length>f?n.slice(n.length-f):n},K=t=>{if(!t)return null;const e=t.langChainPlan;return V(e)?e:null},H=(t,e)=>{const n={type:"plan_state_update",responseType:"plan_state_update",stepId:e.stepId,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`LangChain 计划完成：${e.summary}`,planState:e.planState,meta:{source:"langchain",telemetry:e.telemetry}},a={id:e.stepId,summary:e.summary,plan:e.plan,createdAt:new Date().toISOString()},s={id:`langchain-plan-${Date.now().toString(36)}`,kind:"langchain_plan",payload:{summary:e.summary,telemetry:e.telemetry},at:new Date().toISOString()};return{state:{...t,planId:e.planId,steps:e.planState.steps??t.steps,currentStepId:e.planState.currentStepId??e.stepId,pendingPlan:a,pendingUserReply:null,observations:F(t.observations,s)},actions:[n],label:"plan"}},X=({state:t,payload:e})=>{var u;const n=t.pendingUserReply;if(!n)return{state:t,actions:[],label:"plan"};const a=K(e),s=n.optionId?q(n.optionId):void 0;if(!s){if(!a)throw new Error("LangChain plan payload missing; cannot construct plan node actions.");return H(t,a)}const r=n.freeText||((u=n.options.find(h=>h.id===n.optionId))==null?void 0:u.label)||n.optionId||n.question,i=t.planId??z(),l=s.stepId,o={id:l,intent:s.stepIntent,label:s.stepLabel,status:"in_progress"},d=[{type:"plan_state_update",responseType:"plan_state_update",stepId:l,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`根据你的选择更新计划：${r}`,planState:{planId:i,goal:(s==null?void 0:s.planGoal)??"完成你刚刚点选的分析任务",contextSummary:n.question,progress:(s==null?void 0:s.planProgress)??`收到你的选择「${r}」，准备执行。`,nextSteps:[o],steps:[o],currentStepId:l,blockedBy:null,observationIds:[],confidence:.62,updatedAt:new Date().toISOString(),stateTag:`ts${Date.now().toString(36)}-planstate`}}];return d.push(Y({toolCall:s.toolCall,stepId:s.stepId,reason:s.reason,text:s.text})),{state:{...t,planId:i,steps:[o],currentStepId:l,pendingPlan:null,pendingUserReply:null},actions:d,label:"plan"}},Q=({state:t})=>{const e=t.pendingPlan;if(!e||!e.plan)return{state:t,actions:[],label:"act"};const n={type:"plan_creation",responseType:"plan_creation",stepId:e.id,stateTag:`ts${Date.now().toString(36)}-act`,timestamp:new Date().toISOString(),reason:`根据选择「${e.summary}」创建分析计划`,plan:e.plan};return{state:{...t,pendingPlan:null,pendingVerification:{id:e.id,description:e.summary,createdAt:new Date().toISOString()}},actions:[n],label:"act"}},W=({state:t})=>{var l;const e=t.pendingVerification;if(!e)return{state:t,actions:[],label:"verify"};const n=e.meta,a=[];e.summary?a.push(e.summary):n&&(n.source&&a.push(`数据源：${n.source==="sample"?"采样":"全量"}`),typeof n.rows=="number"&&a.push(`记录数：${n.rows}`),typeof n.processedRows=="number"&&typeof n.totalRows=="number"&&a.push(`处理行：${n.processedRows}/${n.totalRows}`),(l=n.warnings)!=null&&l.length&&a.push(`警告 ${n.warnings.length} 条`),n.summary&&a.push(n.summary));const r=(()=>{const o=e.payload;if(!o||typeof o!="object")return null;switch(typeof o.kind=="string"?o.kind:null){case"profile_dataset":{const d=o.columns,u=o.rowCount,h=o.sampledRows;return`列画像：${d??"?"} 列 · ${u??"?"} 行（采样 ${h??"?"}）`}case"normalize_invoice_month":{const d=o.column??"InvoiceMonth",u=o.normalizedCount,h=o.skippedCount;return`标准化 ${d}：成功 ${u??0}，跳过 ${h??0}`}case"detect_outliers":{const d=o.column??"value",u=o.count,h=o.threshold;return`异常检测 ${d}：找到 ${u??0} 条（阈值 ${h??"?"}）`}case"aggregate_plan":{const d=o.planTitle??e.description,u=o.rows;return`聚合视图「${d}」产生 ${u??0} 行结果。`}default:return null}})();r&&a.push(r);const i={type:"text_response",responseType:"text_response",stepId:e.id,stateTag:`ts${Date.now().toString(36)}-verify`,timestamp:new Date().toISOString(),reason:"确认最新的聚合结果，并说明数据来源。",text:n?`已完成「${e.description}」。
${a.join(" · ")}`:`已完成「${e.description}」的初步执行，准备生成可视化或进一步说明。`};return{state:{...t,pendingVerification:null},actions:[i],label:"verify"}},J=({state:t})=>{const e={type:"text_response",responseType:"text_response",stepId:t.currentStepId??"adjust-next-step",stateTag:`ts${Date.now().toString(36)}-adjust`,timestamp:new Date().toISOString(),reason:"提出下一步建议以延伸分析。",text:"下一步可继续筛选特定供应商或启用异常侦测。随时告诉我想要深入的角度。"};return{state:t,actions:[e],label:"adjust"}},w=self,Z=new T().addNode("diagnose",A).addNode("ask_user",B).addNode("plan",X).addNode("act",Q).addNode("verify",W).addNode("adjust",J).addEdge("diagnose","ask_user").addEdge("ask_user","plan").addEdge("plan","act").addEdge("act","verify").addEdge("verify","adjust").setEntryPoint("diagnose").build();let p=M();const S=20,y=()=>Date.now(),m=t=>{w.postMessage(t)},P=()=>{m({type:"graph/ready",version:$,timestamp:y()})},tt=t=>{var a,s,r,i;const e=y(),n=C(p,t);n.ok&&n.nextState&&(p=n.nextState),m({type:"graph/validation",ok:n.ok,timestamp:e,code:(s=(a=n.violations)==null?void 0:a[0])==null?void 0:s.code,reason:(i=(r=n.violations)==null?void 0:r[0])==null?void 0:i.message,state:n.nextState})},et=async t=>{const e=await Z.invoke({state:p,payload:t});p=e.state,m({type:"graph/pipeline",node:e.label,actions:e.actions,state:p,timestamp:y()})},nt=(t,e)=>{const n=p.awaitPrompt;p={...p,awaitingUser:!1,blockedBy:null,awaitPrompt:null,awaitPromptId:null,pendingUserReply:{optionId:t??null,freeText:e??null,promptId:(n==null?void 0:n.promptId)??null,question:(n==null?void 0:n.question)??"User follow-up",options:(n==null?void 0:n.options)??[],at:new Date().toISOString()},stateTag:"context_ready",updatedAt:new Date().toISOString()};const a=t||e?`User replied with ${t??""} ${e??""}`.trim():"User reply received.";m({type:"graph/log",level:"info",message:a,timestamp:y()})},at=t=>{var i;const e=`verify-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,n=new Date().toISOString(),a={id:e,kind:typeof((i=t.payload)==null?void 0:i.kind)=="string"?t.payload.kind:"tool_result",payload:{description:t.description,summary:t.summary??null,meta:t.meta??null,...t.payload??{}},at:n},s=[...p.observations,a],r=s.length>S?s.slice(s.length-S):s;p={...p,pendingVerification:{id:e,description:t.description,meta:t.meta?{...t.meta,summary:t.summary??void 0}:null,summary:t.summary??null,payload:t.payload??null,createdAt:n},observations:r}},st=t=>{switch(t.type){case"graph/init":P();return;case"graph/ping":m({type:"graph/pong",nonce:t.nonce,timestamp:y()});return;case"graph/shutdown":m({type:"graph/log",level:"info",message:t.reason?`LangGraph runtime shutting down: ${t.reason}`:"LangGraph runtime shutting down by request.",timestamp:y()}),w.close();return;case"graph/applyActions":tt(t.actions??[]);return;case"graph/runPipeline":et(t.payload??{});return;case"graph/userReply":nt(t.optionId??null,t.freeText??null);return;case"graph/tool_result":at(t.verification);return;default:m({type:"graph/log",level:"warn",message:`Unhandled client event ${t.type}`,timestamp:y()})}};w.addEventListener("message",t=>{const e=t.data;if(!e||typeof e!="object"||typeof e.type!="string"){m({type:"graph/log",level:"warn",message:"Ignored message without graph type.",timestamp:y()});return}st(e)});P();
