var ot=Object.defineProperty;var lt=(n,t,e)=>t in n?ot(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var p=(n,t,e)=>lt(n,typeof t!="symbol"?t+"":t,e);import{R as E,S as ct,a as $e,I as pt,b as k,c as oe,i as Ue,d as le,C as ge,e as U,F as de,f as ye,T as be,g as we,h as j,j as R,A as ve,k as D,H as _e,l as L,_ as Te,p as ut,m as mt,n as ht,o as ft,q as gt,r as dt,s as yt,t as bt,v as wt,w as vt,x as _t,y as Tt,z as Mt,B as Ct,D as Pt,E as kt,G as xt,J as St,K as Vt,L as Et,M as At,N as Rt,O as It,P as Ft,Q as Ot,U as A,V as jt,W as Bt,X as Nt,Y as $t,Z as Ut,$ as Dt,a0 as Lt,a1 as Kt,a2 as X,a3 as Ht,a4 as zt,a5 as Wt,a6 as qt,a7 as Jt,a8 as Gt,a9 as q,aa as Yt,ab as Me,ac as Z,ad as De,ae as Le,af as ce,ag as J,ah as V,ai as Ke,aj as Qt,ak as Xt,al as Zt,am as ea,an as ta,ao as He,ap as aa,aq as sa,ar as ra,as as na,at as ia,au as oa,av as la,aw as ne,ax as ca}from"./agent_csv_index-Bvgl1zYk.js";var K=class extends E{constructor(t){super(t);p(this,"lc_serializable",!0);p(this,"lc_namespace",["langchain_core","prompts",this._getPromptType()]);p(this,"inputVariables");p(this,"outputParser");p(this,"partialVariables");p(this,"metadata");p(this,"tags");const{inputVariables:e}=t;if(e.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,t)}get lc_attributes(){return{partialVariables:void 0}}async mergePartialAndUserVariables(t){const e=this.partialVariables??{},a={};for(const[r,i]of Object.entries(e))typeof i=="string"?a[r]=i:a[r]=await i();return{...a,...t}}async invoke(t,e){const a={...this.metadata,...e==null?void 0:e.metadata},s=[...this.tags??[],...(e==null?void 0:e.tags)??[]];return this._callWithConfig(r=>this.formatPromptValue(r),t,{...e,tags:s,metadata:a,runType:"prompt"})}},B=class extends K{async formatPromptValue(n){const t=await this.format(n);return new ct(t)}};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var pa=Object.prototype.toString,F=Array.isArray||function(t){return pa.call(t)==="[object Array]"};function Ce(n){return typeof n=="function"}function ua(n){return F(n)?"array":typeof n}function ie(n){return n.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Ee(n,t){return n!=null&&typeof n=="object"&&t in n}function ma(n,t){return n!=null&&typeof n!="object"&&n.hasOwnProperty&&n.hasOwnProperty(t)}var ha=RegExp.prototype.test;function fa(n,t){return ha.call(n,t)}var ga=/\S/;function da(n){return!fa(ga,n)}var ya={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function ba(n){return String(n).replace(/[&<>"'`=\/]/g,function(e){return ya[e]})}var wa=/\s*/,va=/\s+/,Ae=/\s*=/,_a=/\s*\}/,Ta=/#|\^|\/|>|\{|&|=|!/;function Ma(n,t){if(!n)return[];var e=!1,a=[],s=[],r=[],i=!1,o=!1,l="",c=0;function u(){if(i&&!o)for(;r.length;)delete s[r.pop()];else r=[];i=!1,o=!1}var h,m,f;function y(P){if(typeof P=="string"&&(P=P.split(va,2)),!F(P)||P.length!==2)throw new Error("Invalid tags: "+P);h=new RegExp(ie(P[0])+"\\s*"),m=new RegExp("\\s*"+ie(P[1])),f=new RegExp("\\s*"+ie("}"+P[1]))}y(t||_.tags);for(var g=new H(n),v,d,b,S,T,M;!g.eos();){if(v=g.pos,b=g.scanUntil(h),b)for(var W=0,it=b.length;W<it;++W)S=b.charAt(W),da(S)?(r.push(s.length),l+=S):(o=!0,e=!0,l+=" "),s.push(["text",S,v,v+1]),v+=1,S===`
`&&(u(),l="",c=0,e=!1);if(!g.scan(h))break;if(i=!0,d=g.scan(Ta)||"name",g.scan(wa),d==="="?(b=g.scanUntil(Ae),g.scan(Ae),g.scanUntil(m)):d==="{"?(b=g.scanUntil(f),g.scan(_a),g.scanUntil(m),d="&"):b=g.scanUntil(m),!g.scan(m))throw new Error("Unclosed tag at "+g.pos);if(d==">"?T=[d,b,v,g.pos,l,c,e]:T=[d,b,v,g.pos],c++,s.push(T),d==="#"||d==="^")a.push(T);else if(d==="/"){if(M=a.pop(),!M)throw new Error('Unopened section "'+b+'" at '+v);if(M[1]!==b)throw new Error('Unclosed section "'+M[1]+'" at '+v)}else d==="name"||d==="{"||d==="&"?o=!0:d==="="&&y(b)}if(u(),M=a.pop(),M)throw new Error('Unclosed section "'+M[1]+'" at '+g.pos);return Pa(Ca(s))}function Ca(n){for(var t=[],e,a,s=0,r=n.length;s<r;++s)e=n[s],e&&(e[0]==="text"&&a&&a[0]==="text"?(a[1]+=e[1],a[3]=e[3]):(t.push(e),a=e));return t}function Pa(n){for(var t=[],e=t,a=[],s,r,i=0,o=n.length;i<o;++i)switch(s=n[i],s[0]){case"#":case"^":e.push(s),a.push(s),e=s[4]=[];break;case"/":r=a.pop(),r[5]=s[2],e=a.length>0?a[a.length-1][4]:t;break;default:e.push(s)}return t}function H(n){this.string=n,this.tail=n,this.pos=0}H.prototype.eos=function(){return this.tail===""};H.prototype.scan=function(t){var e=this.tail.match(t);if(!e||e.index!==0)return"";var a=e[0];return this.tail=this.tail.substring(a.length),this.pos+=a.length,a};H.prototype.scanUntil=function(t){var e=this.tail.search(t),a;switch(e){case-1:a=this.tail,this.tail="";break;case 0:a="";break;default:a=this.tail.substring(0,e),this.tail=this.tail.substring(e)}return this.pos+=a.length,a};function I(n,t){this.view=n,this.cache={".":this.view},this.parent=t}I.prototype.push=function(t){return new I(t,this)};I.prototype.lookup=function(t){var e=this.cache,a;if(e.hasOwnProperty(t))a=e[t];else{for(var s=this,r,i,o,l=!1;s;){if(t.indexOf(".")>0)for(r=s.view,i=t.split("."),o=0;r!=null&&o<i.length;)o===i.length-1&&(l=Ee(r,i[o])||ma(r,i[o])),r=r[i[o++]];else r=s.view[t],l=Ee(s.view,t);if(l){a=r;break}s=s.parent}e[t]=a}return Ce(a)&&(a=a.call(this.view)),a};function w(){this.templateCache={_cache:{},set:function(t,e){this._cache[t]=e},get:function(t){return this._cache[t]},clear:function(){this._cache={}}}}w.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};w.prototype.parse=function(t,e){var a=this.templateCache,s=t+":"+(e||_.tags).join(":"),r=typeof a<"u",i=r?a.get(s):void 0;return i==null&&(i=Ma(t,e),r&&a.set(s,i)),i};w.prototype.render=function(t,e,a,s){var r=this.getConfigTags(s),i=this.parse(t,r),o=e instanceof I?e:new I(e,void 0);return this.renderTokens(i,o,a,t,s)};w.prototype.renderTokens=function(t,e,a,s,r){for(var i="",o,l,c,u=0,h=t.length;u<h;++u)c=void 0,o=t[u],l=o[0],l==="#"?c=this.renderSection(o,e,a,s,r):l==="^"?c=this.renderInverted(o,e,a,s,r):l===">"?c=this.renderPartial(o,e,a,r):l==="&"?c=this.unescapedValue(o,e):l==="name"?c=this.escapedValue(o,e,r):l==="text"&&(c=this.rawValue(o)),c!==void 0&&(i+=c);return i};w.prototype.renderSection=function(t,e,a,s,r){var i=this,o="",l=e.lookup(t[1]);function c(m){return i.render(m,e,a,r)}if(l){if(F(l))for(var u=0,h=l.length;u<h;++u)o+=this.renderTokens(t[4],e.push(l[u]),a,s,r);else if(typeof l=="object"||typeof l=="string"||typeof l=="number")o+=this.renderTokens(t[4],e.push(l),a,s,r);else if(Ce(l)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");l=l.call(e.view,s.slice(t[3],t[5]),c),l!=null&&(o+=l)}else o+=this.renderTokens(t[4],e,a,s,r);return o}};w.prototype.renderInverted=function(t,e,a,s,r){var i=e.lookup(t[1]);if(!i||F(i)&&i.length===0)return this.renderTokens(t[4],e,a,s,r)};w.prototype.indentPartial=function(t,e,a){for(var s=e.replace(/[^ \t]/g,""),r=t.split(`
`),i=0;i<r.length;i++)r[i].length&&(i>0||!a)&&(r[i]=s+r[i]);return r.join(`
`)};w.prototype.renderPartial=function(t,e,a,s){if(a){var r=this.getConfigTags(s),i=Ce(a)?a(t[1]):a[t[1]];if(i!=null){var o=t[6],l=t[5],c=t[4],u=i;l==0&&c&&(u=this.indentPartial(i,c,o));var h=this.parse(u,r);return this.renderTokens(h,e,a,u,s)}}};w.prototype.unescapedValue=function(t,e){var a=e.lookup(t[1]);if(a!=null)return a};w.prototype.escapedValue=function(t,e,a){var s=this.getConfigEscape(a)||_.escape,r=e.lookup(t[1]);if(r!=null)return typeof r=="number"&&s===_.escape?String(r):s(r)};w.prototype.rawValue=function(t){return t[1]};w.prototype.getConfigTags=function(t){return F(t)?t:t&&typeof t=="object"?t.tags:void 0};w.prototype.getConfigEscape=function(t){if(t&&typeof t=="object"&&!F(t))return t.escape};var _={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(n){N.templateCache=n},get templateCache(){return N.templateCache}},N=new w;_.clearCache=function(){return N.clearCache()};_.parse=function(t,e){return N.parse(t,e)};_.render=function(t,e,a,s){if(typeof t!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+ua(t)+'" was given as the first argument for mustache#render(template, view, partials)');return N.render(t,e,a,s)};_.escape=ba;_.Scanner=H;_.Context=I;_.Writer=w;function ze(){_.escape=n=>n}const $=n=>{const t=n.split(""),e=[],a=(r,i)=>{for(let o=i;o<t.length;o+=1)if(r.includes(t[o]))return o;return-1};let s=0;for(;s<t.length;)if(t[s]==="{"&&s+1<t.length&&t[s+1]==="{")e.push({type:"literal",text:"{"}),s+=2;else if(t[s]==="}"&&s+1<t.length&&t[s+1]==="}")e.push({type:"literal",text:"}"}),s+=2;else if(t[s]==="{"){const r=a("}",s);if(r<0)throw new Error("Unclosed '{' in template.");e.push({type:"variable",name:t.slice(s+1,r).join("")}),s=r+1}else{if(t[s]==="}")throw new Error("Single '}' in template.");{const r=a("{}",s),i=(r<0?t.slice(s):t.slice(s,r)).join("");e.push({type:"literal",text:i}),s=r<0?t.length:r}}return e},We=(n,t=[])=>{const e=[];for(const a of n)if(a[0]==="name"){const s=a[1].includes(".")?a[1].split(".")[0]:a[1];e.push({type:"variable",name:s})}else if(["#","&","^",">"].includes(a[0])){if(e.push({type:"variable",name:a[1]}),a[0]==="#"&&a.length>4&&Array.isArray(a[4])){const s=[...t,a[1]],r=We(a[4],s);e.push(...r)}}else e.push({type:"literal",text:a[1]});return e},ee=n=>{ze();const t=_.parse(n);return We(t)},qe=(n,t)=>$(n).reduce((e,a)=>{if(a.type==="variable"){if(a.name in t){const s=typeof t[a.name]=="string"?t[a.name]:JSON.stringify(t[a.name]);return e+s}throw new Error(`(f-string) Missing value for input ${a.name}`)}return e+a.text},""),Je=(n,t)=>(ze(),_.render(n,t)),te={"f-string":qe,mustache:Je},Ge={"f-string":$,mustache:ee},C=(n,t,e)=>{try{return te[t](n,e)}catch(a){throw $e(a,"INVALID_PROMPT_INPUT")}},ae=(n,t)=>Ge[t](n),z=(n,t,e)=>{if(!(t in te)){const a=Object.keys(te);throw new Error(`Invalid template format. Got \`${t}\`;
                         should be one of ${a}`)}try{const a=e.reduce((s,r)=>(s[r]="foo",s),{});Array.isArray(n)?n.forEach(s=>{if(s.type==="text"&&"text"in s&&typeof s.text=="string")C(s.text,t,a);else if(s.type==="image_url"){if(typeof s.image_url=="string")C(s.image_url,t,a);else if(typeof s.image_url=="object"&&s.image_url!==null&&"url"in s.image_url&&typeof s.image_url.url=="string"){const r=s.image_url.url;C(r,t,a)}}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):C(n,t,a)}catch(a){throw new Error(`Invalid prompt schema: ${a.message}`)}};var x=class O extends B{constructor(e){super(e);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),z(this.template,this.templateFormat,a)}}static lc_name(){return"PromptTemplate"}_getPromptType(){return"prompt"}async format(e){const a=await this.mergePartialAndUserVariables(e);return C(this.template,this.templateFormat,a)}static fromExamples(e,a,s,r=`

`,i=""){const o=[i,...e,a].join(r);return new O({inputVariables:s,template:o})}static fromTemplate(e,a){const{templateFormat:s="f-string",...r}=a??{},i=new Set;return ae(e,s).forEach(o=>{o.type==="variable"&&i.add(o.name)}),new O({inputVariables:[...i],templateFormat:s,template:e,...r})}async partial(e){const a=this.inputVariables.filter(i=>!(i in e)),s={...this.partialVariables??{},...e},r={...this,inputVariables:a,partialVariables:s};return new O(r)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new O({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}},G=class Ye extends K{constructor(e){super(e);p(this,"lc_namespace",["langchain_core","prompts","image"]);p(this,"template");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);p(this,"additionalContentFields");if(this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),z([{type:"image_url",image_url:this.template}],this.templateFormat,a)}}static lc_name(){return"ImagePromptTemplate"}_getPromptType(){return"prompt"}async partial(e){const a=this.inputVariables.filter(i=>!(i in e)),s={...this.partialVariables??{},...e},r={...this,inputVariables:a,partialVariables:s};return new Ye(r)}async format(e){const a={};for(const[o,l]of Object.entries(this.template))typeof l=="string"?a[o]=C(l,this.templateFormat,e):a[o]=l;const s=e.url||a.url,r=e.detail||a.detail;if(!s)throw new Error("Must provide either an image URL.");if(typeof s!="string")throw new Error("url must be a string.");const i={url:s};return r&&(i.detail=r),i}async formatPromptValue(e){const a=await this.format(e);return new pt(a)}},pe=class extends E{constructor(t){const e=t.templateFormat??"f-string",a=ue(t.template,e);super({inputVariables:a,...t});p(this,"lc_namespace",["langchain_core","prompts","dict"]);p(this,"lc_serializable",!0);p(this,"template");p(this,"templateFormat");p(this,"inputVariables");this.template=t.template,this.templateFormat=e,this.inputVariables=a}static lc_name(){return"DictPromptTemplate"}async format(t){return me(this.template,t,this.templateFormat)}async invoke(t){return await this._callWithConfig(this.format.bind(this),t,{runType:"prompt"})}};function ue(n,t){const e=[];for(const a of Object.values(n))if(typeof a=="string")ae(a,t).forEach(s=>{s.type==="variable"&&e.push(s.name)});else if(Array.isArray(a))for(const s of a)typeof s=="string"?ae(s,t).forEach(r=>{r.type==="variable"&&e.push(r.name)}):typeof s=="object"&&e.push(...ue(s,t));else typeof a=="object"&&a!==null&&e.push(...ue(a,t));return Array.from(new Set(e))}function me(n,t,e){const a={};for(const[s,r]of Object.entries(n))if(typeof r=="string")a[s]=C(r,e,t);else if(Array.isArray(r)){const i=[];for(const o of r)typeof o=="string"?i.push(C(o,e,t)):typeof o=="object"&&i.push(me(o,t,e));a[s]=i}else typeof r=="object"&&r!==null?a[s]=me(r,t,e):a[s]=r;return a}const se=(n,t)=>{const e=[...new Set(t==null?void 0:t.map(s=>{if(typeof s=="string")return s;const r=new s({});if(!("getType"in r)||typeof r.getType!="function")throw new Error("Invalid type provided.");return r.getType()}))],a=n.getType();return e.some(s=>s===a)};function ka(n,t){return Array.isArray(n)?Re(n,t):k.from(e=>Re(e,n))}function Re(n,t={}){const{includeNames:e,excludeNames:a,includeTypes:s,excludeTypes:r,includeIds:i,excludeIds:o}=t,l=[];for(const c of n)if(!(a&&c.name&&a.includes(c.name))){{if(r&&se(c,r))continue;if(o&&c.id&&o.includes(c.id))continue}s||i||e?(e&&c.name&&e.some(u=>u===c.name)||s&&se(c,s)||i&&c.id&&i.some(u=>u===c.id))&&l.push(c):l.push(c)}return l}function xa(n){return Array.isArray(n)?Ie(n):k.from(Ie)}function Ie(n){if(!n.length)return[];const t=[];for(const e of n){const a=e,s=t.pop();if(!s)t.push(a);else if(a.getType()==="tool"||a.getType()!==s.getType())t.push(s,a);else{const r=oe(s),i=oe(a),o=r.concat(i);typeof r.content=="string"&&typeof i.content=="string"&&(o.content=`${r.content}
${i.content}`),t.push(Ea(o))}}return t}function Sa(n,t){if(Array.isArray(n)){const e=n;if(!t)throw new Error("Options parameter is required when providing messages.");return Fe(e,t)}else{const e=n;return k.from(a=>Fe(a,e)).withConfig({runName:"trim_messages"})}}async function Fe(n,t){const{maxTokens:e,tokenCounter:a,strategy:s="last",allowPartial:r=!1,endOn:i,startOn:o,includeSystem:l=!1,textSplitter:c}=t;if(o&&s==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(l&&s==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let u;"getNumTokens"in a?u=async m=>(await Promise.all(m.map(y=>a.getNumTokens(y.content)))).reduce((y,g)=>y+g,0):u=async m=>a(m);let h=Xe;if(c&&("splitText"in c?h=c.splitText:h=async m=>c(m)),s==="first")return Qe(n,{maxTokens:e,tokenCounter:u,textSplitter:h,partialStrategy:r?"first":void 0,endOn:i});if(s==="last")return Va(n,{maxTokens:e,tokenCounter:u,textSplitter:h,allowPartial:r,includeSystem:l,startOn:o,endOn:i});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function Qe(n,t){const{maxTokens:e,tokenCounter:a,textSplitter:s,partialStrategy:r,endOn:i}=t;let o=[...n],l=0;for(let c=0;c<o.length;c+=1){const u=c>0?o.slice(0,-c):o;if(await a(u)<=e){l=o.length-c;break}}if(l<o.length&&r){let c=!1;if(Array.isArray(o[l].content)){const u=o[l];if(typeof u.content=="string")throw new Error("Expected content to be an array.");const h=u.content.length,m=r==="last"?[...u.content].reverse():u.content;for(let f=1;f<=h;f+=1){const y=r==="first"?m.slice(0,f):m.slice(-f),g=Object.fromEntries(Object.entries(u).filter(([b])=>b!=="type"&&!b.startsWith("lc_"))),v=Pe(u.getType(),{...g,content:y}),d=[...o.slice(0,l),v];if(await a(d)<=e)o=d,l+=1,c=!0;else break}c&&r==="last"&&(u.content=[...m].reverse())}if(!c){const u=o[l];let h;if(Array.isArray(u.content)&&u.content.some(m=>typeof m=="string"||m.type==="text")){const m=u.content.find(f=>f.type==="text"&&f.text);h=m==null?void 0:m.text}else typeof u.content=="string"&&(h=u.content);if(h){const m=await s(h),f=m.length;r==="last"&&m.reverse();for(let y=0;y<f-1;y+=1)if(m.pop(),u.content=m.join(""),await a([...o.slice(0,l),u])<=e){r==="last"&&(u.content=[...m].reverse().join("")),o=[...o.slice(0,l),u],l+=1;break}}}}if(i){const c=Array.isArray(i)?i:[i];for(;l>0&&!se(o[l-1],c);)l-=1}return o.slice(0,l)}async function Va(n,t){var u;const{allowPartial:e=!1,includeSystem:a=!1,endOn:s,startOn:r,...i}=t;let o=n.map(h=>{const m=Object.fromEntries(Object.entries(h).filter(([f])=>f!=="type"&&!f.startsWith("lc_")));return Pe(h.getType(),m,Ue(h))});if(s){const h=Array.isArray(s)?s:[s];for(;o.length>0&&!se(o[o.length-1],h);)o=o.slice(0,-1)}const l=a&&((u=o[0])==null?void 0:u.getType())==="system";let c=l?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return c=await Qe(c,{...i,partialStrategy:e?"last":void 0,endOn:r}),l?[c[0],...c.slice(1).reverse()]:c.reverse()}const Oe={human:{message:L,messageChunk:_e},ai:{message:D,messageChunk:ve},system:{message:R,messageChunk:j},developer:{message:R,messageChunk:j},tool:{message:we,messageChunk:be},function:{message:ye,messageChunk:de},generic:{message:U,messageChunk:ge},remove:{message:le,messageChunk:le}};function Pe(n,t,e){var r;let a,s;switch(n){case"human":e?a=new _e(t):s=new L(t);break;case"ai":if(e){let i={...t};"tool_calls"in i&&(i={...i,tool_call_chunks:(r=i.tool_calls)==null?void 0:r.map(o=>({...o,type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))}),a=new ve(i)}else s=new D(t);break;case"system":e?a=new j(t):s=new R(t);break;case"developer":e?a=new j({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}}):s=new R({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if("tool_call_id"in t)e?a=new be(t):s=new we(t);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(e)a=new de(t);else{if(!t.name)throw new Error("FunctionMessage must have a 'name' field");s=new ye(t)}break;case"generic":if("role"in t)e?a=new ge(t):s=new U(t);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${n}`)}if(e&&a)return a;if(s)return s;throw new Error(`Unrecognized message type ${n}`)}function Ea(n){const t=n.getType();let e;const a=Object.fromEntries(Object.entries(n).filter(([s])=>!["type","tool_call_chunks"].includes(s)&&!s.startsWith("lc_")));if(t in Oe&&(e=Pe(t,a)),!e)throw new Error(`Unrecognized message chunk class ${t}. Supported classes are ${Object.keys(Oe)}`);return e}function Xe(n){const t=n.split(`
`);return Promise.resolve([...t.slice(0,-1).map(e=>`${e}
`),t[t.length-1]])}const Aa=["tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result"],Ra=["image","video","audio","text-plain","file"],Ia=["text","reasoning",...Aa,...Ra];var Fa={};Te(Fa,{AIMessage:()=>D,AIMessageChunk:()=>ve,BaseMessage:()=>q,BaseMessageChunk:()=>Gt,ChatMessage:()=>U,ChatMessageChunk:()=>ge,FunctionMessage:()=>ye,FunctionMessageChunk:()=>de,HumanMessage:()=>L,HumanMessageChunk:()=>_e,KNOWN_BLOCK_TYPES:()=>Ia,RemoveMessage:()=>le,SystemMessage:()=>R,SystemMessageChunk:()=>j,ToolMessage:()=>we,ToolMessageChunk:()=>be,_isMessageFieldWithRole:()=>Jt,_mergeDicts:()=>qt,_mergeLists:()=>Wt,_mergeObj:()=>zt,_mergeStatus:()=>Ht,coerceMessageLikeToMessage:()=>X,convertToChunk:()=>oe,convertToOpenAIImageBlock:()=>Kt,convertToProviderContentBlock:()=>Lt,defaultTextSplitter:()=>Xe,defaultToolCallParser:()=>Dt,filterMessages:()=>ka,getBufferString:()=>Ut,iife:()=>$t,isAIMessage:()=>Nt,isAIMessageChunk:()=>Bt,isBase64ContentBlock:()=>jt,isBaseMessage:()=>A,isBaseMessageChunk:()=>Ue,isChatMessage:()=>Ot,isChatMessageChunk:()=>Ft,isDataContentBlock:()=>It,isDirectToolOutput:()=>Rt,isFunctionMessage:()=>At,isFunctionMessageChunk:()=>Et,isHumanMessage:()=>Vt,isHumanMessageChunk:()=>St,isIDContentBlock:()=>xt,isMessage:()=>kt,isOpenAIToolCallArray:()=>Pt,isPlainTextContentBlock:()=>Ct,isSystemMessage:()=>Mt,isSystemMessageChunk:()=>Tt,isToolMessage:()=>_t,isToolMessageChunk:()=>vt,isURLContentBlock:()=>wt,mapChatMessagesToStoredMessages:()=>bt,mapStoredMessageToChatMessage:()=>yt,mapStoredMessagesToChatMessages:()=>dt,mergeContent:()=>gt,mergeMessageRuns:()=>xa,mergeResponseMetadata:()=>ft,mergeUsageMetadata:()=>ht,parseBase64DataUrl:()=>mt,parseMimeType:()=>ut,trimMessages:()=>Sa});var re=class extends E{constructor(){super(...arguments);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0)}async invoke(t,e){return this._callWithConfig(a=>this.formatMessages(a),t,{...e,runType:"prompt"})}},he=class extends re{constructor(t){typeof t=="string"&&(t={variableName:t});super(t);p(this,"variableName");p(this,"optional");this.variableName=t.variableName,this.optional=t.optional??!1}static lc_name(){return"MessagesPlaceholder"}get inputVariables(){return[this.variableName]}async formatMessages(t){const e=t[this.variableName];if(this.optional&&!e)return[];if(!e){const s=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw s.name="InputFormatError",s}let a;try{Array.isArray(e)?a=e.map(X):a=[X(e)]}catch(s){const r=typeof e=="string"?e:JSON.stringify(e,null,2),i=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${r}`,`Additional message: ${s.message}`].join(`

`));throw i.name="InputFormatError",i.lc_error_code=s.lc_error_code,i}return a}},Ze=class extends re{constructor(t){"prompt"in t||(t={prompt:t});super(t);p(this,"prompt");this.prompt=t.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(t){return[await this.format(t)]}},ke=class extends K{constructor(n){super(n)}async format(n){return(await this.formatPromptValue(n)).toString()}async formatPromptValue(n){const t=await this.formatMessages(n);return new Yt(t)}},et=class extends Ze{constructor(t,e){"prompt"in t||(t={prompt:t,role:e});super(t);p(this,"role");this.role=t.role}static lc_name(){return"ChatMessagePromptTemplate"}async format(t){return new U(await this.prompt.format(t),this.role)}static fromTemplate(t,e,a){return new this(x.fromTemplate(t,{templateFormat:a==null?void 0:a.templateFormat}),e)}};function Oa(n){return n===null||typeof n!="object"||Array.isArray(n)?!1:Object.keys(n).length===1&&"text"in n&&typeof n.text=="string"}function ja(n){return n===null||typeof n!="object"||Array.isArray(n)?!1:"image_url"in n&&(typeof n.image_url=="string"||typeof n.image_url=="object"&&n.image_url!==null&&"url"in n.image_url&&typeof n.image_url.url=="string")}var xe=class extends re{constructor(t,e){"prompt"in t||(t={prompt:t});super(t);p(this,"lc_namespace",["langchain_core","prompts","chat"]);p(this,"lc_serializable",!0);p(this,"inputVariables",[]);p(this,"additionalOptions",{});p(this,"prompt");p(this,"messageClass");p(this,"chatMessageClass");if(this.prompt=t.prompt,Array.isArray(this.prompt)){let a=[];this.prompt.forEach(s=>{"inputVariables"in s&&(a=a.concat(s.inputVariables))}),this.inputVariables=a}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=e??this.additionalOptions}static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}createMessage(t){const e=this.constructor;if(e._messageClass()){const a=e._messageClass();return new a({content:t})}else if(e.chatMessageClass){const a=e.chatMessageClass();return new a({content:t,role:this.getRoleFromMessageClass(a.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(t){switch(t){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(t,e){if(typeof t=="string")return new this(x.fromTemplate(t,e));const a=[];for(const s of t)if(typeof s=="string")a.push(x.fromTemplate(s,e));else if(s!==null)if(Oa(s)){let r="";typeof s.text=="string"&&(r=s.text??"");const i={...e,additionalContentFields:s};a.push(x.fromTemplate(r,i))}else if(ja(s)){let r=s.image_url??"",i,o=[];if(typeof r=="string"){let l;(e==null?void 0:e.templateFormat)==="mustache"?l=ee(r):l=$(r);const c=l.flatMap(u=>u.type==="variable"?[u.name]:[]);if(((c==null?void 0:c.length)??0)>0){if(c.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${c}
From: ${r}`);o=[c[0]]}else o=[];r={url:r},i=new G({template:r,inputVariables:o,templateFormat:e==null?void 0:e.templateFormat,additionalContentFields:s})}else if(typeof r=="object"){if("url"in r){let l;(e==null?void 0:e.templateFormat)==="mustache"?l=ee(r.url):l=$(r.url),o=l.flatMap(c=>c.type==="variable"?[c.name]:[])}else o=[];i=new G({template:r,inputVariables:o,templateFormat:e==null?void 0:e.templateFormat,additionalContentFields:s})}else throw new Error("Invalid image template");a.push(i)}else typeof s=="object"&&a.push(new pe({template:s,templateFormat:e==null?void 0:e.templateFormat}));return new this({prompt:a,additionalOptions:e})}async format(t){if(this.prompt instanceof B){const e=await this.prompt.format(t);return this.createMessage(e)}else{const e=[];for(const a of this.prompt){let s={};if(!("inputVariables"in a))throw new Error(`Prompt ${a} does not have inputVariables defined.`);for(const r of a.inputVariables)s||(s={[r]:t[r]}),s={...s,[r]:t[r]};if(a instanceof B){const r=await a.format(s);let i;"additionalContentFields"in a&&(i=a.additionalContentFields),r!==""&&e.push({...i,type:"text",text:r})}else if(a instanceof G){const r=await a.format(s);let i;"additionalContentFields"in a&&(i=a.additionalContentFields),e.push({...i,type:"image_url",image_url:r})}else if(a instanceof pe){const r=await a.format(s);let i;"additionalContentFields"in a&&(i=a.additionalContentFields),e.push({...i,...r})}}return this.createMessage(e)}}async formatMessages(t){return[await this.format(t)]}},Se=class extends xe{static _messageClass(){return L}static lc_name(){return"HumanMessagePromptTemplate"}},tt=class extends xe{static _messageClass(){return D}static lc_name(){return"AIMessagePromptTemplate"}},at=class extends xe{static _messageClass(){return R}static lc_name(){return"SystemMessagePromptTemplate"}};function Ba(n){return typeof n.formatMessages=="function"}function Na(n,t){if(Ba(n)||A(n))return n;if(Array.isArray(n)&&n[0]==="placeholder"){const s=n[1];if((t==null?void 0:t.templateFormat)==="mustache"&&typeof s=="string"&&s.slice(0,2)==="{{"&&s.slice(-2)==="}}"){const r=s.slice(2,-2);return new he({variableName:r,optional:!0})}else if(typeof s=="string"&&s[0]==="{"&&s[s.length-1]==="}"){const r=s.slice(1,-1);return new he({variableName:r,optional:!0})}throw new Error(`Invalid placeholder template for format ${(t==null?void 0:t.templateFormat)??'"f-string"'}: "${n[1]}". Expected a variable name surrounded by ${(t==null?void 0:t.templateFormat)==="mustache"?"double":"single"} curly braces.`)}const e=X(n);let a;if(typeof e.content=="string"?a=e.content:a=e.content.map(s=>"text"in s?{...s,text:s.text}:"image_url"in s?{...s,image_url:s.image_url}:s),e._getType()==="human")return Se.fromTemplate(a,t);if(e._getType()==="ai")return tt.fromTemplate(a,t);if(e._getType()==="system")return at.fromTemplate(a,t);if(U.isInstance(e))return et.fromTemplate(e.content,e.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${e._getType()}".`)}function $a(n){return n.constructor.lc_name()==="MessagesPlaceholder"}var Ve=class Y extends ke{constructor(e){super(e);p(this,"promptMessages");p(this,"validateTemplate",!0);p(this,"templateFormat","f-string");if(e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const a=new Set;for(const l of this.promptMessages)if(!(l instanceof q))for(const c of l.inputVariables)a.add(c);const s=this.inputVariables,r=new Set(this.partialVariables?s.concat(Object.keys(this.partialVariables)):s),i=new Set([...r].filter(l=>!a.has(l)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are not used in any of the prompt messages.`);const o=new Set([...a].filter(l=>!r.has(l)));if(o.size>0)throw new Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}_getPromptType(){return"chat"}async _parseImagePrompts(e,a){if(typeof e.content=="string")return e;const s=await Promise.all(e.content.map(async r=>{if(r.type!=="image_url")return r;let i="";typeof r.image_url=="string"?i=r.image_url:typeof r.image_url=="object"&&r.image_url!==null&&"url"in r.image_url&&typeof r.image_url.url=="string"&&(i=r.image_url.url);const l=await x.fromTemplate(i,{templateFormat:this.templateFormat}).format(a);return typeof r.image_url=="object"&&r.image_url!==null&&"url"in r.image_url?r.image_url.url=l:r.image_url=l,r}));return e.content=s,e}async formatMessages(e){const a=await this.mergePartialAndUserVariables(e);let s=[];for(const r of this.promptMessages)if(r instanceof q)s.push(await this._parseImagePrompts(r,a));else{let i;this.templateFormat==="mustache"?i={...a}:i=r.inputVariables.reduce((l,c)=>{if(!(c in a)&&!($a(r)&&r.optional))throw $e(new Error(`Missing value for input variable \`${c.toString()}\``),"INVALID_PROMPT_INPUT");return l[c]=a[c],l},{});const o=await r.formatMessages(i);s=s.concat(o)}return s}async partial(e){const a=this.inputVariables.filter(i=>!(i in e)),s={...this.partialVariables??{},...e},r={...this,inputVariables:a,partialVariables:s};return new Y(r)}static fromTemplate(e,a){const s=x.fromTemplate(e,a),r=new Se({prompt:s});return this.fromMessages([r])}static fromMessages(e,a){const s=e.reduce((o,l)=>o.concat(l instanceof Y?l.promptMessages:[Na(l,a)]),[]),r=e.reduce((o,l)=>l instanceof Y?Object.assign(o,l.partialVariables):o,Object.create(null)),i=new Set;for(const o of s)if(!(o instanceof q))for(const l of o.inputVariables)l in r||i.add(l);return new this({...a,inputVariables:[...i],promptMessages:s,partialVariables:r,templateFormat:a==null?void 0:a.templateFormat})}},Ua=class fe extends B{constructor(e){super(e);p(this,"lc_serializable",!1);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),z(this.prefix+this.suffix,this.templateFormat,a)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const a=this.inputVariables.filter(i=>!(i in e)),s={...this.partialVariables??{},...e},r={...this,inputVariables:a,partialVariables:s};return new fe(r)}async format(e){const a=await this.mergePartialAndUserVariables(e),s=await this.getExamples(a),r=await Promise.all(s.map(o=>this.examplePrompt.format(o))),i=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return C(i,this.templateFormat,a)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:a}=e;if(!a)throw new Error("Missing example prompt");const s=await x.deserialize(a);let r;if(Array.isArray(e.examples))r=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new fe({inputVariables:e.input_variables,examplePrompt:s,examples:r,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}},Da=class st extends ke{constructor(e){super(e);p(this,"lc_serializable",!0);p(this,"examples");p(this,"exampleSelector");p(this,"examplePrompt");p(this,"suffix","");p(this,"exampleSeparator",`

`);p(this,"prefix","");p(this,"templateFormat","f-string");p(this,"validateTemplate",!0);if(this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),z(this.prefix+this.suffix,this.templateFormat,a)}}_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){const a=await this.mergePartialAndUserVariables(e);let s=await this.getExamples(a);s=s.map(i=>{const o={};return this.examplePrompt.inputVariables.forEach(l=>{o[l]=i[l]}),o});const r=[];for(const i of s){const o=await this.examplePrompt.formatMessages(i);r.push(...o)}return r}async format(e){const a=await this.mergePartialAndUserVariables(e),s=await this.getExamples(a),i=(await Promise.all(s.map(l=>this.examplePrompt.formatMessages(l)))).flat().map(l=>l.content),o=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return C(o,this.templateFormat,a)}async partial(e){const a=this.inputVariables.filter(i=>!(i in e)),s={...this.partialVariables??{},...e},r={...this,inputVariables:a,partialVariables:s};return new st(r)}},La=class Q extends K{constructor(e){super({...e,inputVariables:[]});p(this,"pipelinePrompts");p(this,"finalPrompt");this.pipelinePrompts=e.pipelinePrompts,this.finalPrompt=e.finalPrompt,this.inputVariables=this.computeInputValues()}static lc_name(){return"PipelinePromptTemplate"}computeInputValues(){const e=this.pipelinePrompts.map(s=>s.name),a=this.pipelinePrompts.map(s=>s.prompt.inputVariables.filter(r=>!e.includes(r))).flat();return[...new Set(a)]}static extractRequiredInputValues(e,a){return a.reduce((s,r)=>(s[r]=e[r],s),{})}async formatPipelinePrompts(e){const a=await this.mergePartialAndUserVariables(e);for(const{name:s,prompt:r}of this.pipelinePrompts){const i=Q.extractRequiredInputValues(a,r.inputVariables);r instanceof Ve?a[s]=await r.formatMessages(i):a[s]=await r.format(i)}return Q.extractRequiredInputValues(a,this.finalPrompt.inputVariables)}async formatPromptValue(e){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(e))}async format(e){return this.finalPrompt.format(await this.formatPipelinePrompts(e))}async partial(e){const a={...this};return a.inputVariables=this.inputVariables.filter(s=>!(s in e)),a.partialVariables={...this.partialVariables??{},...e},new Q(a)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function je(n){return typeof n=="object"&&n!=null&&"withStructuredOutput"in n&&typeof n.withStructuredOutput=="function"}function Ka(n){return typeof n=="object"&&n!=null&&"lc_id"in n&&Array.isArray(n.lc_id)&&n.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var Ha=class rt extends Ve{constructor(e){super(e);p(this,"schema");p(this,"method");p(this,"lc_namespace",["langchain_core","prompts","structured"]);this.schema=e.schema,this.method=e.method}get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}pipe(e){if(je(e))return super.pipe(e.withStructuredOutput(this.schema));if(Ka(e)&&je(e.bound))return super.pipe(new Me({bound:e.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:e.kwargs??{},config:e.config,configFactories:e.configFactories}));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(e,a,s){return rt.fromMessages(e,{schema:a,method:s})}},za={};Te(za,{AIMessagePromptTemplate:()=>tt,BaseChatPromptTemplate:()=>ke,BaseMessagePromptTemplate:()=>re,BaseMessageStringPromptTemplate:()=>Ze,BasePromptTemplate:()=>K,BaseStringPromptTemplate:()=>B,ChatMessagePromptTemplate:()=>et,ChatPromptTemplate:()=>Ve,DEFAULT_FORMATTER_MAPPING:()=>te,DEFAULT_PARSER_MAPPING:()=>Ge,DictPromptTemplate:()=>pe,FewShotChatMessagePromptTemplate:()=>Da,FewShotPromptTemplate:()=>Ua,HumanMessagePromptTemplate:()=>Se,ImagePromptTemplate:()=>G,MessagesPlaceholder:()=>he,PipelinePromptTemplate:()=>La,PromptTemplate:()=>x,StructuredPrompt:()=>Ha,SystemMessagePromptTemplate:()=>at,checkValidTemplate:()=>z,interpolateFString:()=>qe,interpolateMustache:()=>Je,parseFString:()=>$,parseMustache:()=>ee,parseTemplate:()=>ae,renderTemplate:()=>C});var nt=class extends E{constructor(t){super(t);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"func");t&&(this.func=t.func)}static lc_name(){return"RunnablePassthrough"}async invoke(t,e){const a=Z(e);return this.func&&await this.func(t,a),this._callWithConfig(s=>Promise.resolve(s),t,a)}async*transform(t,e){const a=Z(e);let s,r=!0;for await(const i of this._transformStreamWithConfig(t,o=>o,a))if(yield i,r)if(s===void 0)s=i;else try{s=ce(s,i)}catch{s=void 0,r=!1}this.func&&s!==void 0&&await this.func(s,a)}static assign(t){return new De(new Le({steps:t}))}},Wa=class extends E{constructor(t){super(t);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"runnables");this.runnables=t.runnables}static lc_name(){return"RouterRunnable"}async invoke(t,e){const{key:a,input:s}=t,r=this.runnables[a];if(r===void 0)throw new Error(`No runnable associated with key "${a}".`);return r.invoke(s,Z(e))}async batch(t,e,a){var m;const s=t.map(f=>f.key),r=t.map(f=>f.input);if(s.find(f=>this.runnables[f]===void 0)!==void 0)throw new Error("One or more keys do not have a corresponding runnable.");const o=s.map(f=>this.runnables[f]),l=this._getOptionsList(e??{},t.length),c=((m=l[0])==null?void 0:m.maxConcurrency)??(a==null?void 0:a.maxConcurrency),u=c&&c>0?c:t.length,h=[];for(let f=0;f<r.length;f+=u){const y=r.slice(f,f+u).map((v,d)=>o[d].invoke(v,l[d])),g=await Promise.all(y);h.push(g)}return h.flat()}async stream(t,e){const{key:a,input:s}=t,r=this.runnables[a];if(r===void 0)throw new Error(`No runnable associated with key "${a}".`);return r.stream(s,e)}},qa=class extends E{constructor(t){super(t);p(this,"lc_namespace",["langchain_core","runnables"]);p(this,"lc_serializable",!0);p(this,"default");p(this,"branches");this.branches=t.branches,this.default=t.default}static lc_name(){return"RunnableBranch"}static from(t){if(t.length<1)throw new Error("RunnableBranch requires at least one branch");const a=t.slice(0,-1).map(([r,i])=>[J(r),J(i)]),s=J(t[t.length-1]);return new this({branches:a,default:s})}async _invoke(t,e,a){let s;for(let r=0;r<this.branches.length;r+=1){const[i,o]=this.branches[r];if(await i.invoke(t,V(e,{callbacks:a==null?void 0:a.getChild(`condition:${r+1}`)}))){s=await o.invoke(t,V(e,{callbacks:a==null?void 0:a.getChild(`branch:${r+1}`)}));break}}return s||(s=await this.default.invoke(t,V(e,{callbacks:a==null?void 0:a.getChild("branch:default")}))),s}async invoke(t,e={}){return this._callWithConfig(this._invoke,t,e)}async*_streamIterator(t,e){const a=await Ke(e),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),Qt(t,"input"),e==null?void 0:e.runId,void 0,void 0,void 0,e==null?void 0:e.runName));let r,i=!0,o;try{for(let l=0;l<this.branches.length;l+=1){const[c,u]=this.branches[l];if(await c.invoke(t,V(e,{callbacks:s==null?void 0:s.getChild(`condition:${l+1}`)}))){o=await u.stream(t,V(e,{callbacks:s==null?void 0:s.getChild(`branch:${l+1}`)}));for await(const m of o)if(yield m,i)if(r===void 0)r=m;else try{r=ce(r,m)}catch{r=void 0,i=!1}break}}if(o===void 0){o=await this.default.stream(t,V(e,{callbacks:s==null?void 0:s.getChild("branch:default")}));for await(const l of o)if(yield l,i)if(r===void 0)r=l;else try{r=ce(r,l)}catch{r=void 0,i=!1}}}catch(l){throw await(s==null?void 0:s.handleChainError(l)),l}await(s==null?void 0:s.handleChainEnd(r??{}))}},Ja=class extends Me{constructor(t){let e=k.from((i,o)=>this._enterHistory(i,o??{})).withConfig({runName:"loadHistory"});const a=t.historyMessagesKey??t.inputMessagesKey;a&&(e=nt.assign({[a]:e}).withConfig({runName:"insertHistory"}));const s=e.pipe(t.runnable.withListeners({onEnd:(i,o)=>this._exitHistory(i,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),r=t.config??{};super({...t,config:r,bound:s});p(this,"runnable");p(this,"inputMessagesKey");p(this,"outputMessagesKey");p(this,"historyMessagesKey");p(this,"getMessageHistory");this.runnable=t.runnable,this.getMessageHistory=t.getMessageHistory,this.inputMessagesKey=t.inputMessagesKey,this.outputMessagesKey=t.outputMessagesKey,this.historyMessagesKey=t.historyMessagesKey}_getInputMessages(t){let e;if(typeof t=="object"&&!Array.isArray(t)&&!A(t)){let a;this.inputMessagesKey?a=this.inputMessagesKey:Object.keys(t).length===1?a=Object.keys(t)[0]:a="input",Array.isArray(t[a])&&Array.isArray(t[a][0])?e=t[a][0]:e=t[a]}else e=t;if(typeof e=="string")return[new L(e)];if(Array.isArray(e))return e;if(A(e))return[e];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(e,null,2)}`)}_getOutputMessages(t){let e;if(!Array.isArray(t)&&!A(t)&&typeof t!="string"){let a;this.outputMessagesKey!==void 0?a=this.outputMessagesKey:Object.keys(t).length===1?a=Object.keys(t)[0]:a="output",t.generations!==void 0?e=t.generations[0][0].message:e=t[a]}else e=t;if(typeof e=="string")return[new D(e)];if(Array.isArray(e))return e;if(A(e))return[e];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(e,null,2)}`)}async _enterHistory(t,e){var r;const s=await((r=e==null?void 0:e.configurable)==null?void 0:r.messageHistory).getMessages();return this.historyMessagesKey===void 0?s.concat(this._getInputMessages(t)):s}async _exitHistory(t,e){var l;const a=(l=e.configurable)==null?void 0:l.messageHistory;let s;Array.isArray(t.inputs)&&Array.isArray(t.inputs[0])?s=t.inputs[0]:s=t.inputs;let r=this._getInputMessages(s);if(this.historyMessagesKey===void 0){const c=await a.getMessages();r=r.slice(c.length)}const i=t.outputs;if(!i)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(t,null,2)}`);const o=this._getOutputMessages(i);await a.addMessages([...r,...o])}async _mergeConfig(...t){const e=await super._mergeConfig(...t);if(!e.configurable||!e.configurable.sessionId){const s={[this.inputMessagesKey??"input"]:"foo"},r={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(s)}, ${JSON.stringify(r)})`)}const{sessionId:a}=e.configurable;return e.configurable.messageHistory=await this.getMessageHistory(a),e}},Ga={};Te(Ga,{RouterRunnable:()=>Wa,Runnable:()=>E,RunnableAssign:()=>De,RunnableBinding:()=>Me,RunnableBranch:()=>qa,RunnableEach:()=>na,RunnableLambda:()=>k,RunnableMap:()=>Le,RunnableParallel:()=>ra,RunnablePassthrough:()=>nt,RunnablePick:()=>sa,RunnableRetry:()=>aa,RunnableSequence:()=>He,RunnableToolLike:()=>ta,RunnableWithFallbacks:()=>ea,RunnableWithMessageHistory:()=>Ja,_coerceToRunnable:()=>J,ensureConfig:()=>Z,getCallbackManagerForConfig:()=>Ke,mergeConfigs:()=>Zt,patchConfig:()=>V,pickRunnableConfigKeys:()=>Xt});const Be={columns:12,rowCount:12345,sampledRows:500,warnings:[]},Ya=ia({title:ne(),description:ne(),chartType:ne()}),Qa=()=>x.fromTemplate(`You are a data analyst. Dataset profile: 
{dataset}
Generate ONE chart plan as JSON with keys "title", "description", "chartType" (bar/line/pie).`),Xa=n=>({columns:n.payload.columns,rowCount:n.payload.rowCount,sampledRows:n.payload.sampledRows,warnings:n.meta.warnings}),Ne=n=>({title:"Dataset Overview",description:`Profile snapshot：${n.columns} columns、${n.rowCount} rows`,chartType:"bar",aggregation:"count",groupByColumn:"auto",valueColumn:void 0,defaultTopN:8,defaultHideOthers:!0}),Za=(n,t,e)=>k.from(async({instructions:a})=>{if(!n.columns.length||n.rows.length===0)return n.debug&&console.warn("[LangChain Plan] Missing dataset/columns, fallback plan used."),Ne(t);try{const s=n.rows.slice(0,200),{plans:r,warnings:i,telemetry:o}=await la(n.columns,s,n.settings);o&&(e==null||e(o)),i.length&&n.addProgress&&n.addProgress(`[LangChain Plan] Warnings: ${i.map(c=>c.message).join(" / ")}`);const l=r[0];if(l)return l}catch(s){n.debug&&console.error("[LangChain Plan] generateAnalysisPlans failed, fallback plan used.",s,a)}return Ne(t)}),es=async n=>{if(!n.datasetId)return n.debug&&console.warn("[LangChain Plan] datasetId missing, using fallback profile."),n.fallbackProfile??Be;try{const t=await oa.profileDataset(n.datasetId,n.sampleSize);return Xa(t)}catch(t){return n.debug&&console.warn("[LangChain Plan] profileDataset failed, fallback to stub.",t),n.fallbackProfile??Be}},ts=n=>{if(!n||n.length===0)return;let t=0,e=0,a=0,s=!1,r=!1,i=!1;n.forEach(l=>{typeof l.promptTokens=="number"&&(t+=l.promptTokens,s=!0),typeof l.completionTokens=="number"&&(e+=l.completionTokens,r=!0),typeof l.totalTokens=="number"&&(a+=l.totalTokens,i=!0)});const o={};return s&&(o.promptTokens=t),r&&(o.completionTokens=e),i&&(o.totalTokens=a),Object.keys(o).length>0?o:void 0},as=n=>{if(!n||n.length===0)return;let t=0;return n.forEach(e=>{const a=ca(e);typeof a=="number"&&(t+=a)}),t>0?Number(t.toFixed(6)):void 0},ns=async n=>{const t=typeof performance<"u"?performance.now():Date.now(),e=await es(n),a=Qa();let s;const r=Za(n,e,T=>{s=T}),o=await He.from([k.from(async()=>({profile:e,promptText:await a.format({dataset:JSON.stringify(e,null,2)})})),k.from(async({profile:T,promptText:M})=>({plan:await r.invoke({instructions:M}),profile:T})),k.from(async({plan:T,profile:M})=>(Ya.parse({title:T.title??"Untitled plan",description:T.description??"Generated via LangChain PoC",chartType:T.chartType??"bar"}),{plan:T,profile:M}))]).invoke(),l=typeof performance<"u"?performance.now():Date.now(),c=Math.max(0,l-t),u=ts(s),h=as(s),m=`langchain-${Date.now().toString(36)}`,f=`${m}-execute`,y=o.plan.title??"LangChain plan",g={id:f,label:y,intent:"analysis",status:"ready"},v={planId:m,goal:y,contextSummary:"Generated via LangChain Runnable",progress:`Plan ready (latency ${c.toFixed(0)} ms)`,nextSteps:[g],steps:[g],currentStepId:f,blockedBy:null,observationIds:[],confidence:.55,updatedAt:new Date().toISOString(),stateTag:"context_ready"},d=`obs-langchain-${Date.now().toString(36)}`,b=new Date().toISOString(),S={id:d,actionId:"langchain_plan",responseType:"plan_creation",status:"success",timestamp:b,outputs:{summary:`LangChain plan: ${y}`,chartType:o.plan.chartType,groupByColumn:o.plan.groupByColumn,valueColumn:o.plan.valueColumn,latencyMs:Math.round(c)}};return{source:"langchain",planId:m,stepId:f,summary:y,plan:o.plan,planState:v,observation:S,telemetry:{latencyMs:c,startedAt:t,finishedAt:l,provider:n.settings.provider,tokenUsage:u,estimatedCostUsd:h},profile:o.profile,usageLog:s??[]}};export{ns as generateLangChainPlanEnvelope};
