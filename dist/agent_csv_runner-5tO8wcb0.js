const I="0.1.0",h="context_ready",T=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`session-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,b=(e,t)=>{const n=new Date().toISOString(),a={sessionId:T(),planId:null,stateTag:h,awaitingUser:!1,awaitPrompt:null,awaitPromptId:null,pendingUserReply:null,pendingPlan:null,pendingVerification:null,steps:[],currentStepId:null,blockedBy:null,observations:[],viewIds:[],warnings:[],updatedAt:n};return{...a,...t,steps:a.steps,observations:a.observations,viewIds:a.viewIds,warnings:a.warnings}},P=["ready","in_progress","done"],f=e=>e?["context_ready","awaiting_clarification","needs_clarification"].includes(e)?!0:/^\d{5,}-\d+$/.test(e)||/^ts[0-9a-z]{2,}-[0-9a-z_-]+$/i.test(e):!1,U=e=>{if(!Array.isArray(e))return[];const t=new Set,n=[];return e.forEach(a=>{const r=typeof(a==null?void 0:a.id)=="string"?a.id.trim():"",s=typeof(a==null?void 0:a.label)=="string"?a.label.trim():"",i=typeof(a==null?void 0:a.intent)=="string"?a.intent.trim():"conversation";if(r.length<3||s.length<3||t.has(r))return;const o=P.includes(a.status)?a.status:"ready";n.push({id:r,label:s,intent:i,status:o}),t.add(r)}),n},v=(e,t)=>{var s;if(!t)return e;const n=U(t.steps??t.nextSteps),a=typeof t.currentStepId=="string"&&t.currentStepId.trim().length>=3?t.currentStepId.trim():((s=n[0])==null?void 0:s.id)??e.currentStepId,r=typeof t.planId=="string"&&t.planId.trim().length>=3?t.planId.trim():e.planId;return{...e,planId:r,steps:n,currentStepId:a,blockedBy:t.blockedBy??e.blockedBy,stateTag:t.stateTag&&f(t.stateTag)?t.stateTag:e.stateTag,updatedAt:new Date().toISOString(),awaitPrompt:e.awaitPrompt,awaitPromptId:e.awaitPromptId,pendingUserReply:e.pendingUserReply}},m=e=>e?f(e):!1,D=["text_response","await_user","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request"],k=(e,t)=>{if(!Array.isArray(t)||t.length===0)return{ok:!0,nextState:e,acceptedActions:[]};if(e.awaitingUser)return l("awaiting_user","Graph is waiting for user input; no actions can run.",e);if(t.length>2)return l("turn_budget_exceeded","Each turn may include at most 2 actions.",e);const n=t[0];if(n.responseType!=="plan_state_update")return l("first_action_plan_required","First action must be plan_state_update.",e);if(!m(n.stateTag))return l("invalid_state_tag","plan_state_update is missing a valid stateTag.",e);if(!n.planState)return l("missing_plan_state","plan_state_update is missing planState payload.",e);const a=t[1];if(a){if(a.responseType==="plan_state_update")return l("atomic_type_invalid","Second action must be atomic, not plan_state_update.",e);if(!D.includes(a.responseType))return l("atomic_type_invalid",`Atomic action ${a.responseType} is not permitted in this turn.`,e);if(!m(a.stateTag))return l("invalid_state_tag","Atomic action is missing a valid stateTag.",e)}return{ok:!0,nextState:x(e,n,a),acceptedActions:t}},x=(e,t,n)=>{var s,i,o,g,c,y;let a=v(e,t.planState);return a={...a,stateTag:t.stateTag??a.stateTag,updatedAt:new Date().toISOString()},!!((s=t.meta)!=null&&s.awaitUser)||((i=t.planState)==null?void 0:i.blockedBy)==="awaiting_user_choice"||!!((o=n==null?void 0:n.meta)!=null&&o.awaitUser)||(n==null?void 0:n.responseType)==="await_user"?a={...a,awaitingUser:!0,blockedBy:((g=t.planState)==null?void 0:g.blockedBy)??(n==null?void 0:n.reason)??"awaiting_user_choice",awaitPrompt:(n==null?void 0:n.awaitUserPayload)??a.awaitPrompt,awaitPromptId:((c=n==null?void 0:n.awaitUserPayload)==null?void 0:c.promptId)??a.awaitPromptId}:a={...a,awaitingUser:!1,blockedBy:((y=t.planState)==null?void 0:y.blockedBy)??null,awaitPrompt:null,awaitPromptId:null},a},l=(e,t,n)=>({ok:!1,violations:[{code:e,message:t}],nextState:n}),$=e=>b(),O=({state:e})=>({state:{...e,warnings:e.warnings??[]},actions:[],label:"diagnose"}),_="你想先做哪項？",R=[{id:"clean_month",label:"清洗/标准化 InvoiceMonth"},{id:"top_payees",label:"Top 收款方（总额/笔数/客单）"},{id:"outlier",label:"异常大额清单"},{id:"by_type",label:"按 PayeeType 分解"}],E=()=>`prompt-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,B=({state:e})=>{if(e.pendingUserReply)return{state:e,actions:[],label:"ask_user"};if(e.awaitingUser&&e.awaitPrompt){const s={type:"await_user",responseType:"await_user",stepId:e.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Still waiting for your selection before continuing.",text:e.awaitPrompt.question,meta:{awaitUser:!0,haltAfter:!0,promptId:e.awaitPrompt.promptId},awaitUserPayload:e.awaitPrompt};return{state:e,actions:[s],halted:!0,label:"ask_user"}}const t=E(),n={promptId:t,question:_,options:R,allowFreeText:!0,placeholder:"或输入：Top10 by amount desc"},a={type:"await_user",responseType:"await_user",stepId:e.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Need user choice before continuing the analysis plan.",text:_,meta:{awaitUser:!0,haltAfter:!0,promptId:t},awaitUserPayload:n},r=e.steps.length>0?e.steps:[{id:"ask-user-choice",intent:"clarification",label:"Await user choice before planning",status:"waiting_user"}];return{state:{...e,awaitingUser:!0,blockedBy:"awaiting_user_choice",stateTag:"awaiting_clarification",steps:r,awaitPrompt:n,awaitPromptId:t,pendingPlan:null,pendingVerification:null,updatedAt:new Date().toISOString()},actions:[a],halted:!0,label:"ask_user"}},N=()=>`plan-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,q=({state:e})=>{var c;const t=e.pendingUserReply;if(!t)return{state:e,actions:[],label:"plan"};const n=t.optionId??t.freeText??t.question??"user-choice",a=t.freeText||((c=t.options.find(y=>y.id===t.optionId))==null?void 0:c.label)||t.optionId||t.question,r=e.planId??N(),s={chartType:"bar",title:a??"Custom Analysis",description:`Based on your selection ${a}`,aggregation:"sum",groupByColumn:"auto_inferred_column",valueColumn:"auto_inferred_metric",defaultTopN:8,defaultHideOthers:!0},i=t.optionId?`plan-${t.optionId}`:"plan-custom",o={id:i,intent:"analysis",label:`执行：${a}`,status:"in_progress"},g={type:"plan_state_update",responseType:"plan_state_update",stepId:i,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`根据你的选择更新计划：${a}`,planState:{planId:r,goal:"完成你刚刚点选的分析任务",contextSummary:t.question,progress:`收到你的选择「${a}」，准备执行。`,nextSteps:[o],steps:[o],currentStepId:i,blockedBy:null,observationIds:[],confidence:.62,updatedAt:new Date().toISOString(),stateTag:`ts${Date.now().toString(36)}-planstate`}};return{state:{...e,planId:r,steps:[o],currentStepId:i,pendingPlan:{id:i,summary:a??n,plan:s,createdAt:new Date().toISOString()},pendingUserReply:null},actions:[g],label:"plan"}},G=({state:e})=>{const t=e.pendingPlan;if(!t||!t.plan)return{state:e,actions:[],label:"act"};const n={type:"plan_creation",responseType:"plan_creation",stepId:t.id,stateTag:`ts${Date.now().toString(36)}-act`,timestamp:new Date().toISOString(),reason:`根据选择「${t.summary}」创建分析计划`,plan:t.plan};return{state:{...e,pendingPlan:null,pendingVerification:{id:t.id,description:t.summary,createdAt:new Date().toISOString()}},actions:[n],label:"act"}},A=({state:e})=>{const t=e.pendingVerification;if(!t)return{state:e,actions:[],label:"verify"};const n={type:"text_response",responseType:"text_response",stepId:t.id,stateTag:`ts${Date.now().toString(36)}-verify`,timestamp:new Date().toISOString(),reason:"确认动作已执行，准备分享结果。",text:`已完成「${t.description}」的初步执行，准备生成可视化或进一步说明。`};return{state:{...e,pendingVerification:null},actions:[n],label:"verify"}},M=({state:e})=>({state:e,actions:[],label:"adjust"}),V=[O,B,q,G,A,M],C=e=>{let t=e.state;const n=[];for(const a of V){const r=a({state:t,payload:e.payload});if(t=r.state,r.actions.length>0&&n.push(...r.actions),r.halted)return{state:t,actions:n,halted:!0,label:r.label}}return{state:t,actions:n,halted:!1,label:"complete"}},w=self;let p=$();const d=e=>{w.postMessage(e)},u=()=>Date.now(),S=()=>{d({type:"graph/ready",version:I,timestamp:u()})},j=e=>{switch(e.type){case"graph/init":S();return;case"graph/ping":d({type:"graph/pong",nonce:e.nonce,timestamp:u()});return;case"graph/shutdown":d({type:"graph/log",level:"info",message:e.reason?`Graph runtime shutting down: ${e.reason}`:"Graph runtime shutting down by request.",timestamp:u()}),w.close();return;case"graph/applyActions":L(e.actions??[]);return;case"graph/runPipeline":z(e.payload??{});return;case"graph/userReply":F(e.optionId??null,e.freeText??null);return;default:d({type:"graph/log",level:"warn",message:`Unhandled client event ${e.type}`,timestamp:u()})}},L=e=>{var a,r,s,i;const t=u(),n=k(p,e);n.ok&&n.nextState&&(p=n.nextState),d({type:"graph/validation",ok:n.ok,timestamp:t,code:(r=(a=n.violations)==null?void 0:a[0])==null?void 0:r.code,reason:(i=(s=n.violations)==null?void 0:s[0])==null?void 0:i.message,state:n.nextState})},z=e=>{const t=C({state:p,payload:e});p=t.state,d({type:"graph/pipeline",node:t.label,actions:t.actions,state:p,timestamp:u()})},F=(e,t)=>{const n=p.awaitPrompt;p={...p,awaitingUser:!1,blockedBy:null,awaitPrompt:null,awaitPromptId:null,pendingUserReply:{optionId:e??null,freeText:t??null,promptId:(n==null?void 0:n.promptId)??null,question:(n==null?void 0:n.question)??"User follow-up",options:(n==null?void 0:n.options)??[],at:new Date().toISOString()},stateTag:"context_ready",updatedAt:new Date().toISOString()};const a=e||t?`User replied with ${e??""} ${t??""}`.trim():"User reply received.";d({type:"graph/log",level:"info",message:a,timestamp:u()})};w.addEventListener("message",e=>{const t=e.data;if(!t||typeof t!="object"||typeof t.type!="string"){d({type:"graph/log",level:"warn",message:"Ignored message without graph type.",timestamp:u()});return}j(t)});S();
