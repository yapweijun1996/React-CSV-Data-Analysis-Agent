import{p as G}from"./agent_csv_dataWorker-A6IhGAuG.js";const B=(e,t)=>t.some(n=>e instanceof n);let j,_;function J(){return j||(j=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Q(){return _||(_=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const P=new WeakMap,x=new WeakMap,D=new WeakMap;function X(e){const t=new Promise((n,o)=>{const r=()=>{e.removeEventListener("success",s),e.removeEventListener("error",a)},s=()=>{n(y(e.result)),r()},a=()=>{o(e.error),r()};e.addEventListener("success",s),e.addEventListener("error",a)});return D.set(t,e),t}function Y(e){if(P.has(e))return;const t=new Promise((n,o)=>{const r=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",a),e.removeEventListener("abort",a)},s=()=>{n(),r()},a=()=>{o(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",s),e.addEventListener("error",a),e.addEventListener("abort",a)});P.set(e,t)}let R={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return P.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return y(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function F(e){R=e(R)}function Z(e){return Q().includes(e)?function(...t){return e.apply(A(this),t),y(this.request)}:function(...t){return y(e.apply(A(this),t))}}function tt(e){return typeof e=="function"?Z(e):(e instanceof IDBTransaction&&Y(e),B(e,J())?new Proxy(e,R):e)}function y(e){if(e instanceof IDBRequest)return X(e);if(x.has(e))return x.get(e);const t=tt(e);return t!==e&&(x.set(e,t),D.set(t,e)),t}const A=e=>D.get(e);function et(e,t,{blocked:n,upgrade:o,blocking:r,terminated:s}={}){const a=indexedDB.open(e,t),i=y(a);return o&&a.addEventListener("upgradeneeded",c=>{o(y(a.result),c.oldVersion,c.newVersion,y(a.transaction),c)}),n&&a.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),i.then(c=>{s&&c.addEventListener("close",()=>s()),r&&c.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),i}const nt=["get","getKey","getAll","getAllKeys","count"],ot=["put","add","delete","clear"],E=new Map;function L(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(E.get(t))return E.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,r=ot.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(r||nt.includes(n)))return;const s=async function(a,...i){const c=this.transaction(a,r?"readwrite":"readonly");let d=c.store;return o&&(d=d.index(i.shift())),(await Promise.all([d[n](...i),r&&c.done]))[0]};return E.set(t,s),s}F(e=>({...e,get:(t,n,o)=>L(t,n)||e.get(t,n,o),has:(t,n)=>!!L(t,n)||e.has(t,n)}));const rt=["continue","continuePrimaryKey","advance"],V={},O=new WeakMap,W=new WeakMap,st={get(e,t){if(!rt.includes(t))return e[t];let n=V[t];return n||(n=V[t]=function(...o){O.set(this,W.get(this)[t](...o))}),n}};async function*at(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,st);for(W.set(n,t),D.set(n,A(t));t;)yield n,t=await(O.get(n)||t.continue()),O.delete(n)}function T(e,t){return t===Symbol.asyncIterator&&B(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&B(e,[IDBIndex,IDBObjectStore])}F(e=>({...e,get(t,n,o){return T(t,n)?at:e.get(t,n,o)},has(t,n){return T(t,n)||e.has(t,n)}}));const U="csv_agent_db",ct=3,m="provenance",w="clean_rows",l="columns",u="views";let h=null;const K=async()=>{await new Promise((e,t)=>{const n=indexedDB.deleteDatabase(U);n.onsuccess=()=>e(),n.onerror=()=>t(n.error),n.onblocked=()=>console.warn("IndexedDB delete blocked. Close other tabs to proceed.")}),h=null},it=(e,t)=>{if(!e.objectStoreNames.contains(t)){if(t===w){e.createObjectStore(t,{keyPath:"chunkId"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(t===l){e.createObjectStore(t,{keyPath:"datasetId"});return}if(t===u){e.createObjectStore(t,{keyPath:"id"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(t===m){e.createObjectStore(t,{keyPath:"datasetId"});return}throw new Error(`Unsupported store name: ${t}`)}},$=async e=>{try{return await e()}catch(t){if(t instanceof DOMException&&t.name==="VersionError")return console.warn("IndexedDB version mismatch detected. Resetting csv_agent_db...",t),await K(),e();throw t}},dt=[m,w,l,u],f=async(e=[])=>{const t=Array.from(new Set([...dt,...e])),n=(a,i)=>et(U,a,{upgrade(c){i.forEach(d=>it(c,d))}});if(!h)return h=$(()=>n(ct,t)),h;const o=await h;if(t.filter(a=>!o.objectStoreNames.contains(a)).length===0)return o;o.close();const s=o.version+1;return h=$(()=>n(s,t)),h},ut=(e,t)=>{const n=[];for(let o=0;o<e.length;o+=t)n.push(e.slice(o,o+t));return n},bt=async e=>{const{datasetId:t,rows:n,columns:o,provenance:r,chunkSize:s=2e4}=e;if(!t)throw new Error("persistCleanDataset requires datasetId.");const a=async()=>{const c=(await f([w,l,u])).transaction([w,l,m],"readwrite"),d=c.objectStore(w),I=c.objectStore(l),S=c.objectStore(m);let g=await d.index("by_dataset").openCursor(t);for(;g;)await g.delete(),g=await g.continue();const p=ut(n,s),M=new Date().toISOString();for(let b=0;b<p.length;b+=1){const C=p[b],H={chunkId:`${t}-chunk-${b}`,datasetId:t,rowCount:C.length,startRow:b*s,endRow:b*s+C.length-1,rows:C,createdAt:M};await d.put(H)}const q={datasetId:t,columnCount:o.length,columns:o,rowCount:n.length,updatedAt:M};await I.put(q);const z={datasetId:t,fileName:r.fileName,bytes:r.bytes,checksum:r.checksum,cleanedAt:r.cleanedAt};return await S.put(z),await c.done,{chunkCount:p.length,rowCount:n.length}};try{return await a()}catch(i){if(i instanceof DOMException&&i.name==="NotFoundError")return console.warn("IndexedDB store missing detected. Resetting and retrying persist...",i),await K(),a();throw i}},mt=async e=>{const{datasetId:t,title:n,kind:o,queryHash:r,explainer:s,dataRef:a}=e,c=(await f([u])).transaction(u,"readwrite"),d=c.objectStore(u),I=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,S=`${t}-view-${I}`,v={id:S,datasetId:t,title:n,kind:o,queryHash:r,explainer:s,dataRef:a,createdAt:new Date().toISOString()};return await d.put(v),await c.done,S},St=async e=>{const t=await f([u]);try{const n=t.transaction(u,"readonly"),s=await n.objectStore(u).index("by_dataset").getAll(e);return await n.done,s}catch(n){return console.warn(`Failed to read card results for ${e}`,n),[]}},gt=async e=>{const n=(await f()).transaction(m,"readonly"),r=await n.objectStore(m).get(e);return await n.done,r??void 0},N=async e=>{const n=(await f([l])).transaction(l,"readonly"),r=await n.objectStore(l).get(e);return await n.done,r??null},Dt=async e=>{const t=await N(e);return(t==null?void 0:t.columns)??null},k=async(e,t)=>{const o=(await f([w])).transaction(w,"readonly"),s=o.objectStore(w).index("by_dataset");let a=!1;const i=()=>{a=!0};let c=await s.openCursor(e);for(;c&&!a;){const d=c.value;if(await t(d,i),a)break;c=await c.continue()}await o.done},lt=async e=>{let t=0;return await k(e,n=>{const o=typeof n.rowCount=="number"?n.rowCount:n.rows.length;t+=o}),t},wt=async(e,t)=>{const n=[];return await k(e,(o,r)=>{for(const s of o.rows)if(n.push(s),n.length>=t){r();break}}),n},It=async e=>{const t=[];return await k(e,n=>{t.push(...n.rows)}),t},ft=2e3,ht=async e=>{try{const[t,n]=await Promise.all([wt(e,ft),lt(e)]);if(n===0||t.length===0)return console.warn(`CSV Agent: unable to rebuild column metadata for ${e} because the dataset has no cached rows.`),null;const o=G(t),r={datasetId:e,columnCount:o.length,columns:o,rowCount:n,updatedAt:new Date().toISOString()},a=(await f([l])).transaction(l,"readwrite");return await a.objectStore(l).put(r),await a.done,console.info(`CSV Agent: rebuilt missing column metadata for dataset ${e}.`),r}catch(t){return console.error(`CSV Agent: failed to rebuild column metadata for dataset ${e}.`,t),null}},pt=async e=>{const t=await N(e);return t||ht(e)},Ct=async e=>{const n=(await f([u])).transaction(u,"readwrite");let s=await n.objectStore(u).index("by_dataset").openCursor(e);for(;s;)await s.delete(),s=await s.continue();await n.done};export{Ct as clearCardResults,pt as ensureColumnStoreRecord,bt as persistCleanDataset,It as readAllRows,St as readCardResults,Dt as readColumnProfiles,N as readColumnStoreRecord,gt as readProvenance,wt as readSampledRows,mt as saveCardResult};
