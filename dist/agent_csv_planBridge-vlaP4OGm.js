var Ou=Object.defineProperty;var Pu=(n,e,t)=>e in n?Ou(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var m=(n,e,t)=>Pu(n,typeof e!="symbol"?e+"":e,t);import{g as In,a as Nu,b as Lu,e as Mu}from"./agent_csv_index-C5BsjKGG.js";var ju=Object.defineProperty,fe=(n,e)=>{for(var t in e)ju(n,t,{get:e[t],enumerable:!0})},qn,gi;function Du(){return gi||(gi=1,qn=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),qn}var Uu=Du();const Fu=In(Uu);var zr={exports:{}},_i;function Bu(){if(_i)return zr.exports;_i=1;const n=/[\p{Lu}]/u,e=/[\p{Ll}]/u,t=/^[\p{Lu}](?![\p{Lu}])/gu,r=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,a=new RegExp("^"+s.source),i=new RegExp(s.source+r.source,"gu"),o=new RegExp("\\d+"+r.source,"gu"),l=(h,f,p)=>{let _=!1,g=!1,y=!1;for(let w=0;w<h.length;w++){const v=h[w];_&&n.test(v)?(h=h.slice(0,w)+"-"+h.slice(w),_=!1,y=g,g=!0,w++):g&&y&&e.test(v)?(h=h.slice(0,w-1)+"-"+h.slice(w-1),y=g,g=!1,_=!0):(_=f(v)===v&&p(v)!==v,y=g,g=p(v)===v&&f(v)!==v)}return h},c=(h,f)=>(t.lastIndex=0,h.replace(t,p=>f(p))),u=(h,f)=>(i.lastIndex=0,o.lastIndex=0,h.replace(i,(p,_)=>f(_)).replace(o,p=>f(p))),d=(h,f)=>{if(!(typeof h=="string"||Array.isArray(h)))throw new TypeError("Expected the input to be `string | string[]`");if(f={pascalCase:!1,preserveConsecutiveUppercase:!1,...f},Array.isArray(h)?h=h.map(y=>y.trim()).filter(y=>y.length).join("-"):h=h.trim(),h.length===0)return"";const p=f.locale===!1?y=>y.toLowerCase():y=>y.toLocaleLowerCase(f.locale),_=f.locale===!1?y=>y.toUpperCase():y=>y.toLocaleUpperCase(f.locale);return h.length===1?f.pascalCase?_(h):p(h):(h!==p(h)&&(h=l(h,p,_)),h=h.replace(a,""),f.preserveConsecutiveUppercase?h=c(h,p):h=p(h),f.pascalCase&&(h=_(h.charAt(0))+h.slice(1)),u(h,_))};return zr.exports=d,zr.exports.default=d,zr.exports}Bu();function zu(n,e){return(e==null?void 0:e[n])||Fu(n)}function Vu(n,e,t){const r={};for(const s in n)Object.hasOwn(n,s)&&(r[e(s,t)]=n[s]);return r}var qu={};fe(qu,{Serializable:()=>Gt,get_lc_unique_name:()=>ja});function vi(n){return Array.isArray(n)?[...n]:{...n}}function Gu(n,e){const t=vi(n);for(const[r,s]of Object.entries(e)){const[a,...i]=r.split(".").reverse();let o=t;for(const l of i.reverse()){if(o[l]===void 0)break;o[l]=vi(o[l]),o=o[l]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[s]})}return t}function ja(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var Gt=class Ol{constructor(e,...t){m(this,"lc_serializable",!1);m(this,"lc_kwargs");this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([r])=>{var s;return(s=this.lc_serializable_keys)==null?void 0:s.includes(r)})):this.lc_kwargs=e??{}}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ja(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Ol||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((s,a)=>(s[a]=a in this?this[a]:this.lc_kwargs[a],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let a=this,i=r;const[o,...l]=s.split(".").reverse();for(const c of l.reverse()){if(!(c in a)||a[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof a[c]=="object"&&a[c]!=null?i[c]={}:Array.isArray(a[c])&&(i[c]=[])),a=a[c],i=i[c]}o in a&&a[o]!==void 0&&(i[o]=i[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Vu(Object.keys(t).length?Gu(r,t):r,zu,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Pl(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}var Hu=class extends Error{constructor(e,t){super(e);m(this,"output");this.output=t}};const Nl=Symbol.for("ls:tracing_async_local_storage"),pr=Symbol.for("lc:context_variables"),Zu=n=>{globalThis[Nl]=n},_r=()=>globalThis[Nl];function vt(n){return typeof n=="object"&&n!==null&&"type"in n&&typeof n.type=="string"&&"source_type"in n&&(n.source_type==="url"||n.source_type==="base64"||n.source_type==="text"||n.source_type==="id")}function Ll(n){return vt(n)&&n.source_type==="url"&&"url"in n&&typeof n.url=="string"}function Ml(n){return vt(n)&&n.source_type==="base64"&&"data"in n&&typeof n.data=="string"}function Ju(n){return vt(n)&&n.source_type==="text"&&"text"in n&&typeof n.text=="string"}function jl(n){return vt(n)&&n.source_type==="id"&&"id"in n&&typeof n.id=="string"}function Wu(n){if(vt(n)){if(n.source_type==="url")return{type:"image_url",image_url:{url:n.url}};if(n.source_type==="base64"){if(!n.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${n.mime_type};base64,${n.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function Ku(n){const e=n.split(";")[0].split("/");if(e.length!==2)throw new Error(`Invalid mime type: "${n}" - does not match type/subtype format.`);const t=e[0].trim(),r=e[1].trim();if(t===""||r==="")throw new Error(`Invalid mime type: "${n}" - type or subtype is empty.`);const s={};for(const a of n.split(";").slice(1)){const i=a.split("=");if(i.length!==2)throw new Error(`Invalid parameter syntax in mime type: "${n}".`);const o=i[0].trim(),l=i[1].trim();if(o==="")throw new Error(`Invalid parameter syntax in mime type: "${n}".`);s[o]=l}return{type:t,subtype:r,parameters:s}}function la({dataUrl:n,asTypedArray:e=!1}){const t=n.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let r;if(t){r=t[1].toLowerCase();const s=e?Uint8Array.from(atob(t[2]),a=>a.charCodeAt(0)):t[2];return{mime_type:r,data:s}}}function Yu(n,e){if(n.type==="text"){if(!e.fromStandardTextBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardTextBlock\` method.`);return e.fromStandardTextBlock(n)}if(n.type==="image"){if(!e.fromStandardImageBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardImageBlock\` method.`);return e.fromStandardImageBlock(n)}if(n.type==="audio"){if(!e.fromStandardAudioBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardAudioBlock\` method.`);return e.fromStandardAudioBlock(n)}if(n.type==="file"){if(!e.fromStandardFileBlock)throw new Error(`Converter for ${e.providerName} does not implement \`fromStandardFileBlock\` method.`);return e.fromStandardFileBlock(n)}throw new Error(`Unable to convert content block type '${n.type}' to provider-specific format: not recognized.`)}function B(n,e){return W(n)&&n.type===e}function W(n){return typeof n=="object"&&n!==null}function et(n){return Array.isArray(n)}function O(n){return typeof n=="string"}function qe(n){return typeof n=="number"}function Da(n){return n instanceof Uint8Array}function wi(n){try{return JSON.parse(n)}catch{return}}const vr=n=>n();function Xu(n){if(n.type==="char_location"&&O(n.document_title)&&qe(n.start_char_index)&&qe(n.end_char_index)&&O(n.cited_text)){const{document_title:e,start_char_index:t,end_char_index:r,cited_text:s,...a}=n;return{...a,type:"citation",source:"char",title:e??void 0,startIndex:t,endIndex:r,citedText:s}}if(n.type==="page_location"&&O(n.document_title)&&qe(n.start_page_number)&&qe(n.end_page_number)&&O(n.cited_text)){const{document_title:e,start_page_number:t,end_page_number:r,cited_text:s,...a}=n;return{...a,type:"citation",source:"page",title:e??void 0,startIndex:t,endIndex:r,citedText:s}}if(n.type==="content_block_location"&&O(n.document_title)&&qe(n.start_block_index)&&qe(n.end_block_index)&&O(n.cited_text)){const{document_title:e,start_block_index:t,end_block_index:r,cited_text:s,...a}=n;return{...a,type:"citation",source:"block",title:e??void 0,startIndex:t,endIndex:r,citedText:s}}if(n.type==="web_search_result_location"&&O(n.url)&&O(n.title)&&O(n.encrypted_index)&&O(n.cited_text)){const{url:e,title:t,encrypted_index:r,cited_text:s,...a}=n;return{...a,type:"citation",source:"url",url:e,title:t,startIndex:Number(r),endIndex:Number(r),citedText:s}}if(n.type==="search_result_location"&&O(n.source)&&O(n.title)&&qe(n.start_block_index)&&qe(n.end_block_index)&&O(n.cited_text)){const{source:e,title:t,start_block_index:r,end_block_index:s,cited_text:a,...i}=n;return{...i,type:"citation",source:"search",url:e,title:t??void 0,startIndex:r,endIndex:s,citedText:a}}}function Dl(n){if(B(n,"document")&&W(n.source)&&"type"in n.source){if(n.source.type==="base64"&&O(n.source.media_type)&&O(n.source.data))return{type:"file",mimeType:n.source.media_type,data:n.source.data};if(n.source.type==="url"&&O(n.source.url))return{type:"file",url:n.source.url};if(n.source.type==="file"&&O(n.source.file_id))return{type:"file",fileId:n.source.file_id};if(n.source.type==="text"&&O(n.source.data))return{type:"file",mimeType:String(n.source.media_type??"text/plain"),data:n.source.data}}else if(B(n,"image")&&W(n.source)&&"type"in n.source){if(n.source.type==="base64"&&O(n.source.media_type)&&O(n.source.data))return{type:"image",mimeType:n.source.media_type,data:n.source.data};if(n.source.type==="url"&&O(n.source.url))return{type:"image",url:n.source.url};if(n.source.type==="file"&&O(n.source.file_id))return{type:"image",fileId:n.source.file_id}}}function Qu(n){function*e(){for(const t of n){const r=Dl(t);r?yield r:yield t}}return Array.from(e())}function bi(n){function*e(){var r;const t=typeof n.content=="string"?[{type:"text",text:n.content}]:n.content;for(const s of t){if(B(s,"text")&&O(s.text)){const{text:a,citations:i,...o}=s;if(et(i)&&i.length){const l=i.reduce((c,u)=>{const d=Xu(u);return d?[...c,d]:c},[]);yield{...o,type:"text",text:a,annotations:l};continue}else{yield{...o,type:"text",text:a};continue}}else if(B(s,"thinking")&&O(s.thinking)){const{thinking:a,signature:i,...o}=s;yield{...o,type:"reasoning",reasoning:a,signature:i};continue}else if(B(s,"redacted_thinking")){yield{type:"non_standard",value:s};continue}else if(B(s,"tool_use")&&O(s.name)&&O(s.id)){yield{type:"tool_call",id:s.id,name:s.name,args:s.input};continue}else if(B(s,"input_json_delta")){if(td(n)&&((r=n.tool_call_chunks)!=null&&r.length)){const a=n.tool_call_chunks[0];yield{type:"tool_call_chunk",id:a.id,name:a.name,args:a.args,index:a.index};continue}}else if(B(s,"server_tool_use")&&O(s.name)&&O(s.id)){const{name:a,id:i}=s;if(a==="web_search"){const o=vr(()=>{if(typeof s.input=="string")return s.input;if(W(s.input)&&O(s.input.query))return s.input.query;if(O(s.partial_json)){const l=wi(s.partial_json);if(l!=null&&l.query)return l.query}return""});yield{id:i,type:"server_tool_call",name:"web_search",args:{query:o}};continue}else if(s.name==="code_execution"){const o=vr(()=>{if(typeof s.input=="string")return s.input;if(W(s.input)&&O(s.input.code))return s.input.code;if(O(s.partial_json)){const l=wi(s.partial_json);if(l!=null&&l.code)return l.code}return""});yield{id:i,type:"server_tool_call",name:"code_execution",args:{code:o}};continue}}else if(B(s,"web_search_tool_result")&&O(s.tool_use_id)&&et(s.content)){const{content:a,tool_use_id:i}=s,o=a.reduce((l,c)=>B(c,"web_search_result")?[...l,c.url]:l,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:i,status:"success",output:{urls:o}};continue}else if(B(s,"code_execution_tool_result")&&O(s.tool_use_id)&&W(s.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(B(s,"mcp_tool_use")){yield{id:s.id,type:"server_tool_call",name:"mcp_tool_use",args:s.input};continue}else if(B(s,"mcp_tool_result")&&O(s.tool_use_id)&&W(s.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:s.tool_use_id,status:"success",output:s.content};continue}else if(B(s,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:s.input};continue}else if(B(s,"search_result")){yield{id:s.id,type:"non_standard",value:s};continue}else if(B(s,"tool_result")){yield{id:s.id,type:"non_standard",value:s};continue}else{const a=Dl(s);if(a){yield a;continue}}yield{type:"non_standard",value:s}}}return Array.from(e())}const ed={translateContent:bi,translateContentChunk:bi};function td(n){return typeof(n==null?void 0:n._getType)=="function"&&typeof n.concat=="function"&&n._getType()==="ai"}function rd(n){return Ll(n)?{type:n.type,mimeType:n.mime_type,url:n.url,metadata:n.metadata}:Ml(n)?{type:n.type,mimeType:n.mime_type??"application/octet-stream",data:n.data,metadata:n.metadata}:jl(n)?{type:n.type,mimeType:n.mime_type,fileId:n.id,metadata:n.metadata}:n}function nd(n){return n.map(rd)}function sd(n){return!!(B(n,"image_url")&&W(n.image_url)||B(n,"input_audio")&&W(n.input_audio)||B(n,"file")&&W(n.file))}function ad(n){if(B(n,"image_url")&&W(n.image_url)&&O(n.image_url.url)){const e=la({dataUrl:n.image_url.url});return e?{type:"image",mimeType:e.mime_type,data:e.data}:{type:"image",url:n.image_url.url}}else{if(B(n,"input_audio")&&W(n.input_audio)&&O(n.input_audio.data)&&O(n.input_audio.format))return{type:"audio",data:n.input_audio.data,mimeType:`audio/${n.input_audio.format}`};if(B(n,"file")&&W(n.file)&&O(n.file.data)){const e=la({dataUrl:n.file.data});if(e)return{type:"file",data:e.data,mimeType:e.mime_type};if(O(n.file.file_id))return{type:"file",fileId:n.file.file_id}}}return n}function id(n){const e=[];typeof n.content=="string"?e.push({type:"text",text:n.content}):e.push(...Ua(n.content));for(const t of n.tool_calls??[])e.push({type:"tool_call",id:t.id,name:t.name,args:t.args});return e}function od(n){const e=[];typeof n.content=="string"?e.push({type:"text",text:n.content}):e.push(...Ua(n.content));for(const t of n.tool_calls??[])e.push({type:"tool_call",id:t.id,name:t.name,args:t.args});return e}function Ua(n){const e=[];for(const t of n)sd(t)?e.push(ad(t)):e.push(t);return e}function ld(n){if(n.type==="url_citation"){const{url:e,title:t,start_index:r,end_index:s}=n;return{type:"citation",url:e,title:t,startIndex:r,endIndex:s}}if(n.type==="file_citation"){const{file_id:e,filename:t,index:r}=n;return{type:"citation",title:t,startIndex:r,endIndex:r,fileId:e}}return n}function Ul(n){function*e(){var r;W((r=n.additional_kwargs)==null?void 0:r.reasoning)&&et(n.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:n.additional_kwargs.reasoning.summary.reduce((a,i)=>W(i)&&O(i.text)?`${a}${i.text}`:a,"")});const t=typeof n.content=="string"?[{type:"text",text:n.content}]:n.content;for(const s of t)if(B(s,"text")){const{text:a,annotations:i,...o}=s;Array.isArray(i)?yield{...o,type:"text",text:String(a),annotations:i.map(ld)}:yield{...o,type:"text",text:String(a)}}for(const s of n.tool_calls??[])yield{type:"tool_call",id:s.id,name:s.name,args:s.args};if(W(n.additional_kwargs)&&et(n.additional_kwargs.tool_outputs))for(const s of n.additional_kwargs.tool_outputs){if(B(s,"web_search_call")){yield{id:s.id,type:"server_tool_call",name:"web_search",args:{query:s.query}};continue}else if(B(s,"file_search_call")){yield{id:s.id,type:"server_tool_call",name:"file_search",args:{query:s.query}};continue}else if(B(s,"computer_call")){yield{type:"non_standard",value:s};continue}else if(B(s,"code_interpreter_call")){if(O(s.code)&&(yield{id:s.id,type:"server_tool_call",name:"code_interpreter",args:{code:s.code}}),et(s.outputs)){const a=vr(()=>{if(s.status!=="in_progress"){if(s.status==="completed")return 0;if(s.status==="incomplete")return 127;if(s.status!=="interpreting"&&s.status==="failed")return 1}});for(const i of s.outputs)if(B(i,"logs")){yield{type:"server_tool_call_result",toolCallId:s.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:a??0,stderr:[0,void 0].includes(a)?void 0:String(i.logs),stdout:[0,void 0].includes(a)?String(i.logs):void 0}};continue}}continue}else if(B(s,"mcp_call")){yield{id:s.id,type:"server_tool_call",name:"mcp_call",args:s.input};continue}else if(B(s,"mcp_list_tools")){yield{id:s.id,type:"server_tool_call",name:"mcp_list_tools",args:s.input};continue}else if(B(s,"mcp_approval_request")){yield{type:"non_standard",value:s};continue}else if(B(s,"image_generation_call")){yield{type:"non_standard",value:s};continue}W(s)&&(yield{type:"non_standard",value:s})}}return Array.from(e())}function cd(n){function*e(){yield*Ul(n);for(const t of n.tool_call_chunks??[])yield{type:"tool_call_chunk",id:t.id,name:t.name,args:t.args}}return Array.from(e())}const ud={translateContent:n=>typeof n.content=="string"?id(n):Ul(n),translateContentChunk:n=>typeof n.content=="string"?od(n):cd(n)};function Fl(n){return typeof n=="object"&&n!==null&&"type"in n&&"content"in n&&(typeof n.content=="string"||Array.isArray(n.content))}function dd(n,e="pretty"){return e==="pretty"?hd(n):JSON.stringify(n)}function hd(n){const e=[],t=` ${n.type.charAt(0).toUpperCase()+n.type.slice(1)} Message `,r=Math.floor((80-t.length)/2),s="=".repeat(r),a=t.length%2===0?s:`${s}=`;if(e.push(`${s}${t}${a}`),n.type==="ai"){const i=n;if(i.tool_calls&&i.tool_calls.length>0){e.push("Tool Calls:");for(const o of i.tool_calls){e.push(`  ${o.name} (${o.id})`),e.push(` Call ID: ${o.id}`),e.push("  Args:");for(const[l,c]of Object.entries(o.args))e.push(`    ${l}: ${c}`)}}}if(n.type==="tool"){const i=n;i.name&&e.push(`Name: ${i.name}`)}return typeof n.content=="string"&&n.content.trim()&&(e.length>1&&e.push(""),e.push(n.content)),e.join(`
`)}const Gn=Symbol.for("langchain.message");function Nt(n,e){return typeof n=="string"?n===""?e:typeof e=="string"?n+e:Array.isArray(e)&&e.some(t=>vt(t))?[{type:"text",source_type:"text",text:n},...e]:[{type:"text",text:n},...e]:Array.isArray(e)?Cr(n,e)??[...n,...e]:e===""?n:Array.isArray(n)&&n.some(t=>vt(t))?[...n,{type:"file",source_type:"text",text:e}]:[...n,{type:"text",text:e}]}function Bl(n,e){return n==="error"||e==="error"?"error":"success"}function fd(n,e){function t(r,s){if(typeof r!="object"||r===null||r===void 0)return r;if(s>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,s+1));const a={};for(const i of Object.keys(r))a[i]=t(r[i],s+1);return a}return JSON.stringify(t(n,0),null,2)}var kl,De=class extends Gt{constructor(e){const t=typeof e=="string"||Array.isArray(e)?{content:e}:e;t.additional_kwargs||(t.additional_kwargs={}),t.response_metadata||(t.response_metadata={});super(t);m(this,"lc_namespace",["langchain_core","messages"]);m(this,"lc_serializable",!0);m(this,kl,!0);m(this,"id");m(this,"name");m(this,"content");m(this,"additional_kwargs");m(this,"response_metadata");this.name=t.name,t.content===void 0&&t.contentBlocks!==void 0?(this.content=t.contentBlocks,this.response_metadata={output_version:"v1",...t.response_metadata}):t.content!==void 0?(this.content=t.content??[],this.response_metadata=t.response_metadata):(this.content=[],this.response_metadata=t.response_metadata),this.additional_kwargs=t.additional_kwargs,this.id=t.id}get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}_getType(){return this.type}getType(){return this._getType()}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[nd,Ua,Qu].reduce((s,a)=>a(s),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Gn in e&&e[Gn]===!0&&Fl(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[(kl=Gn,Symbol.toStringTag)](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=fd(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}toFormattedString(e="pretty"){return dd(this,e)}};function pd(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}function be(n={},e={}){const t={...n};for(const[r,s]of Object.entries(e))if(t[r]==null)t[r]=s;else{if(s==null)continue;if(typeof t[r]!=typeof s||Array.isArray(t[r])!==Array.isArray(s))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;["id","name","output_version","model_provider"].includes(r)?t[r]=s:t[r]+=s}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=be(t[r],s);else if(Array.isArray(t[r]))t[r]=Cr(t[r],s);else{if(t[r]===s)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function Cr(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{const t=[...n];for(const r of e)if(typeof r=="object"&&r!==null&&"index"in r&&typeof r.index=="number"){const s=t.findIndex(a=>{const i=typeof a=="object",o="index"in a&&a.index===r.index,l="id"in a&&"id"in r&&(a==null?void 0:a.id)===(r==null?void 0:r.id),c=!("id"in a)||!(a!=null&&a.id)||!("id"in r)||!(r!=null&&r.id);return i&&o&&(l||c)});s!==-1&&typeof t[s]=="object"&&t[s]!==null?t[s]=be(t[s],r):t.push(r)}else{if(typeof r=="object"&&r!==null&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}function zl(n,e){if(!n&&!e)throw new Error("Cannot merge two undefined objects.");if(!n||!e)return n||e;if(typeof n!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof n}
Right ${typeof e}`);if(typeof n=="string"&&typeof e=="string")return n+e;if(Array.isArray(n)&&Array.isArray(e))return Cr(n,e);if(typeof n=="object"&&typeof e=="object")return be(n,e);if(n===e)return n;throw new Error(`Can not merge objects of different types.
Left ${n}
Right ${e}`)}var Lt=class extends De{static isInstance(n){return super.isInstance(n)&&"concat"in n&&typeof n.concat=="function"}};function Vl(n){return typeof n.role=="string"}function pt(n){return typeof(n==null?void 0:n._getType)=="function"}function ql(n){return pt(n)&&typeof n.concat=="function"}var md={};fe(md,{ToolMessage:()=>Qt,ToolMessageChunk:()=>An,defaultToolCallParser:()=>Fa,isDirectToolOutput:()=>Gl,isToolMessage:()=>Hl,isToolMessageChunk:()=>Zl});function Gl(n){return n!=null&&typeof n=="object"&&"lc_direct_tool_output"in n&&n.lc_direct_tool_output===!0}var Qt=class extends De{constructor(e,t,r){const s=typeof e=="string"||Array.isArray(e)?{content:e,name:r,tool_call_id:t}:e;super(s);m(this,"lc_direct_tool_output",!0);m(this,"type","tool");m(this,"status");m(this,"tool_call_id");m(this,"metadata");m(this,"artifact");this.tool_call_id=s.tool_call_id,this.artifact=s.artifact,this.status=s.status,this.metadata=s.metadata}static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},An=class extends Lt{constructor(e){super(e);m(this,"type","tool");m(this,"tool_call_id");m(this,"status");m(this,"artifact");this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const t=this.constructor;return new t({content:Nt(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),artifact:zl(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Bl(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function Fa(n){const e=[],t=[];for(const r of n)if(r.function){const s=r.function.name;try{const a=JSON.parse(r.function.arguments);e.push({name:s||"",args:a||{},id:r.id})}catch{t.push({name:s,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}function Hl(n){return typeof n=="object"&&n!==null&&"getType"in n&&typeof n.getType=="function"&&n.getType()==="tool"}function Zl(n){return n._getType()==="tool"}function yd(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="";const t=[];let r=!1,s=!1;for(let a of n){if(r)a==='"'&&!s?r=!1:a===`
`&&!s?a="\\n":a==="\\"?s=!s:s=!1;else if(a==='"')r=!0,s=!1;else if(a==="{")t.push("}");else if(a==="[")t.push("]");else if(a==="}"||a==="]")if(t&&t[t.length-1]===a)t.pop();else return null;e+=a}r&&(e+='"');for(let a=t.length-1;a>=0;a-=1)e+=t[a];try{return JSON.parse(e)}catch{return null}}function Ba(n){switch(n){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function gd(n){if(W(n.document)&&W(n.document.source)){const e=W(n.document)&&O(n.document.format)?n.document.format:"",t=Ba(e);if(W(n.document.source)){if(W(n.document.source.s3Location)&&O(n.document.source.s3Location.uri))return{type:"file",mimeType:t,fileId:n.document.source.s3Location.uri};if(Da(n.document.source.bytes))return{type:"file",mimeType:t,data:n.document.source.bytes};if(O(n.document.source.text))return{type:"file",mimeType:t,data:Buffer.from(n.document.source.text).toString("base64")};if(et(n.document.source.content)){const r=n.document.source.content.reduce((s,a)=>W(a)&&O(a.text)?s+a.text:s,"");return{type:"file",mimeType:t,data:r}}}}return{type:"non_standard",value:n}}function _d(n){if(B(n,"image")&&W(n.image)){const e=W(n.image)&&O(n.image.format)?n.image.format:"",t=Ba(e);if(W(n.image.source)){if(W(n.image.source.s3Location)&&O(n.image.source.s3Location.uri))return{type:"image",mimeType:t,fileId:n.image.source.s3Location.uri};if(Da(n.image.source.bytes))return{type:"image",mimeType:t,data:n.image.source.bytes}}}return{type:"non_standard",value:n}}function vd(n){if(B(n,"video")&&W(n.video)){const e=W(n.video)&&O(n.video.format)?n.video.format:"",t=Ba(e);if(W(n.video.source)){if(W(n.video.source.s3Location)&&O(n.video.source.s3Location.uri))return{type:"video",mimeType:t,fileId:n.video.source.s3Location.uri};if(Da(n.video.source.bytes))return{type:"video",mimeType:t,data:n.video.source.bytes}}}return{type:"non_standard",value:n}}function Ei(n){function*e(){const t=typeof n.content=="string"?[{type:"text",text:n.content}]:n.content;for(const r of t){if(B(r,"cache_point")){yield{type:"non_standard",value:r};continue}else if(B(r,"citations_content")&&W(r.citationsContent)){const s=et(r.citationsContent.content)?r.citationsContent.content.reduce((i,o)=>W(o)&&O(o.text)?i+o.text:i,""):"",a=et(r.citationsContent.citations)?r.citationsContent.citations.reduce((i,o)=>{if(W(o)){const l=et(o.sourceContent)?o.sourceContent.reduce((u,d)=>W(d)&&O(d.text)?u+d.text:u,""):"",c=vr(()=>{if(W(o.location)){const u=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(W(u))return{source:qe(u.documentIndex)?u.documentIndex.toString():void 0,startIndex:qe(u.start)?u.start:void 0,endIndex:qe(u.end)?u.end:void 0}}return{}});i.push({type:"citation",citedText:l,...c})}return i},[]):[];yield{type:"text",text:s,annotations:a};continue}else if(B(r,"document")&&W(r.document)){yield gd(r);continue}else if(B(r,"guard_content")){yield{type:"non_standard",value:r};continue}else if(B(r,"image")&&W(r.image)){yield _d(r);continue}else if(B(r,"reasoning_content")&&O(r.reasoningText)){yield{type:"reasoning",reasoning:r.reasoningText};continue}else if(B(r,"text")&&O(r.text)){yield{type:"text",text:r.text};continue}else if(B(r,"tool_result")){yield{type:"non_standard",value:r};continue}else{if(B(r,"tool_call"))continue;if(B(r,"video")&&W(r.video)){yield vd(r);continue}}yield{type:"non_standard",value:r}}}return Array.from(e())}const wd={translateContent:Ei,translateContentChunk:Ei};function Si(n){function*e(){const t=typeof n.content=="string"?[{type:"text",text:n.content}]:n.content;for(const r of t){if(B(r,"text")&&O(r.text)){yield{type:"text",text:r.text};continue}else if(B(r,"inlineData")&&W(r.inlineData)&&O(r.inlineData.mimeType)&&O(r.inlineData.data)){yield{type:"file",mimeType:r.inlineData.mimeType,data:r.inlineData.data};continue}else if(B(r,"functionCall")&&W(r.functionCall)&&O(r.functionCall.name)&&W(r.functionCall.args)){yield{type:"tool_call",id:n.id,name:r.functionCall.name,args:r.functionCall.args};continue}else if(B(r,"functionResponse")){yield{type:"non_standard",value:r};continue}else if(B(r,"fileData")&&W(r.fileData)&&O(r.fileData.mimeType)&&O(r.fileData.fileUri)){yield{type:"file",mimeType:r.fileData.mimeType,fileId:r.fileData.fileUri};continue}else if(B(r,"executableCode")){yield{type:"non_standard",value:r};continue}else if(B(r,"codeExecutionResult")){yield{type:"non_standard",value:r};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const bd={translateContent:Si,translateContentChunk:Si};function Ti(n){function*e(){const t=typeof n.content=="string"?[{type:"text",text:n.content}]:n.content;for(const r of t){if(B(r,"reasoning")&&O(r.reasoning)){const s=vr(()=>{var i;const a=t.indexOf(r);if(et((i=n.additional_kwargs)==null?void 0:i.signatures)&&a>=0)return n.additional_kwargs.signatures.at(a)});O(s)?yield{type:"reasoning",reasoning:r.reasoning,signature:s}:yield{type:"reasoning",reasoning:r.reasoning};continue}else if(B(r,"text")&&O(r.text)){yield{type:"text",text:r.text};continue}else if(B(r,"image_url")){if(O(r.image_url))if(r.image_url.startsWith("data:")){const s=/^data:([^;]+);base64,(.+)$/,a=r.image_url.match(s);a?yield{type:"image",data:a[2],mimeType:a[1]}:yield{type:"image",url:r.image_url}}else yield{type:"image",url:r.image_url};continue}else if(B(r,"media")&&O(r.mimeType)&&O(r.data)){yield{type:"file",mimeType:r.mimeType,data:r.data};continue}yield{type:"non_standard",value:r}}}return Array.from(e())}const Ed={translateContent:Ti,translateContentChunk:Ti};globalThis.lc_block_translators_registry??(globalThis.lc_block_translators_registry=new Map([["anthropic",ed],["bedrock-converse",wd],["google-genai",bd],["google-vertexai",Ed],["openai",ud]]));function Jl(n){return globalThis.lc_block_translators_registry.get(n)}function Wl(n,e){return be(n??{},e??{})}function Kl(n,e){const t={};return((n==null?void 0:n.audio)!==void 0||(e==null?void 0:e.audio)!==void 0)&&(t.audio=((n==null?void 0:n.audio)??0)+((e==null?void 0:e.audio)??0)),((n==null?void 0:n.image)!==void 0||(e==null?void 0:e.image)!==void 0)&&(t.image=((n==null?void 0:n.image)??0)+((e==null?void 0:e.image)??0)),((n==null?void 0:n.video)!==void 0||(e==null?void 0:e.video)!==void 0)&&(t.video=((n==null?void 0:n.video)??0)+((e==null?void 0:e.video)??0)),((n==null?void 0:n.document)!==void 0||(e==null?void 0:e.document)!==void 0)&&(t.document=((n==null?void 0:n.document)??0)+((e==null?void 0:e.document)??0)),((n==null?void 0:n.text)!==void 0||(e==null?void 0:e.text)!==void 0)&&(t.text=((n==null?void 0:n.text)??0)+((e==null?void 0:e.text)??0)),t}function Sd(n,e){const t={...Kl(n,e)};return((n==null?void 0:n.cache_read)!==void 0||(e==null?void 0:e.cache_read)!==void 0)&&(t.cache_read=((n==null?void 0:n.cache_read)??0)+((e==null?void 0:e.cache_read)??0)),((n==null?void 0:n.cache_creation)!==void 0||(e==null?void 0:e.cache_creation)!==void 0)&&(t.cache_creation=((n==null?void 0:n.cache_creation)??0)+((e==null?void 0:e.cache_creation)??0)),t}function Td(n,e){const t={...Kl(n,e)};return((n==null?void 0:n.reasoning)!==void 0||(e==null?void 0:e.reasoning)!==void 0)&&(t.reasoning=((n==null?void 0:n.reasoning)??0)+((e==null?void 0:e.reasoning)??0)),t}function Yl(n,e){return{input_tokens:((n==null?void 0:n.input_tokens)??0)+((e==null?void 0:e.input_tokens)??0),output_tokens:((n==null?void 0:n.output_tokens)??0)+((e==null?void 0:e.output_tokens)??0),total_tokens:((n==null?void 0:n.total_tokens)??0)+((e==null?void 0:e.total_tokens)??0),input_token_details:Sd(n==null?void 0:n.input_token_details,e==null?void 0:e.input_token_details),output_token_details:Td(n==null?void 0:n.output_token_details,e==null?void 0:e.output_token_details)}}var wt=class extends De{constructor(e){var r;let t;if(typeof e=="string"||Array.isArray(e))t={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{t=e;const s=(r=t.additional_kwargs)==null?void 0:r.tool_calls,a=t.tool_calls;s!=null&&s.length>0&&(a===void 0||a.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(s!=null&&a===void 0){const[i,o]=Fa(s);t.tool_calls=i??[],t.invalid_tool_calls=o??[]}else t.tool_calls=t.tool_calls??[],t.invalid_tool_calls=t.invalid_tool_calls??[]}catch{t.tool_calls=[],t.invalid_tool_calls=[]}if(t.response_metadata!==void 0&&"output_version"in t.response_metadata&&t.response_metadata.output_version==="v1"&&(t.contentBlocks=t.content,t.content=void 0),t.contentBlocks!==void 0){t.contentBlocks.push(...t.tool_calls.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})));const i=t.contentBlocks.filter(o=>o.type==="tool_call").filter(o=>{var l;return!((l=t.tool_calls)!=null&&l.some(c=>c.id===o.id&&c.name===o.name))});i.length>0&&(t.tool_calls=i.map(o=>({type:"tool_call",id:o.id,name:o.name,args:o.args})))}}super(t);m(this,"type","ai");m(this,"tool_calls",[]);m(this,"invalid_tool_calls",[]);m(this,"usage_metadata");typeof t!="string"&&(this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const t=Jl(this.response_metadata.model_provider);if(t)return t.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const t=this.tool_calls.filter(r=>!e.some(s=>s.id===r.id&&s.name===r.name));e.push(...t.map(r=>({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function xd(n){return n._getType()==="ai"}function Id(n){return n._getType()==="ai"}var er=class extends Lt{constructor(e){var r,s;let t;if(typeof e=="string"||Array.isArray(e))t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0||e.tool_call_chunks.length===0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const i=(e.tool_call_chunks??[]).reduce((c,u)=>{const d=c.findIndex(([h])=>"id"in u&&u.id&&"index"in u&&u.index!==void 0?u.id===h.id&&u.index===h.index:"id"in u&&u.id?u.id===h.id:"index"in u&&u.index!==void 0?u.index===h.index:!1);return d!==-1?c[d].push(u):c.push([u]),c},[]),o=[],l=[];for(const c of i){let u=null;const d=((r=c[0])==null?void 0:r.name)??"",h=c.map(_=>_.args||"").join(""),f=h.length?h:"{}",p=(s=c[0])==null?void 0:s.id;try{if(u=yd(f),!p||u===null||typeof u!="object"||Array.isArray(u))throw new Error("Malformed tool call chunk args.");o.push({name:d,args:u,id:p,type:"tool_call"})}catch{l.push({name:d,args:f,id:p,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:o,invalid_tool_calls:l,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t);m(this,"type","ai");m(this,"tool_calls",[]);m(this,"invalid_tool_calls",[]);m(this,"tool_call_chunks",[]);m(this,"usage_metadata");this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const t=Jl(this.response_metadata.model_provider);if(t)return t.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const t=this.content.filter(r=>r.type==="tool_call").map(r=>r.id);for(const r of this.tool_calls)r.id&&!t.includes(r.id)&&e.push({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:Nt(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:Wl(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const s=Cr(this.tool_call_chunks,e.tool_call_chunks);s!==void 0&&s.length>0&&(t.tool_call_chunks=s)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(t.usage_metadata=Yl(this.usage_metadata,e.usage_metadata));const r=this.constructor;return new r(t)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}},Mt=class Xl extends De{constructor(t,r){(typeof t=="string"||Array.isArray(t))&&(t={content:t,role:r});super(t);m(this,"type","generic");m(this,"role");this.role=t.role}static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Xl}static isInstance(t){return super.isInstance(t)&&t.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},Rn=class extends Lt{constructor(e,t){(typeof e=="string"||Array.isArray(e))&&(e={content:e,role:t});super(e);m(this,"type","generic");m(this,"role");this.role=e.role}static lc_name(){return"ChatMessageChunk"}concat(e){const t=this.constructor;return new t({content:Nt(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};function Ad(n){return n._getType()==="generic"}function Rd(n){return n._getType()==="generic"}var $n=class extends De{constructor(e){super(e);m(this,"type","function");m(this,"name");this.name=e.name}static lc_name(){return"FunctionMessage"}},Cn=class extends Lt{constructor(){super(...arguments);m(this,"type","function")}static lc_name(){return"FunctionMessageChunk"}concat(e){const t=this.constructor;return new t({content:Nt(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function $d(n){return n._getType()==="function"}function Cd(n){return n._getType()==="function"}var nt=class extends De{constructor(e){super(e);m(this,"type","human")}static lc_name(){return"HumanMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="human"}},kn=class extends Lt{constructor(e){super(e);m(this,"type","human")}static lc_name(){return"HumanMessageChunk"}concat(e){const t=this.constructor;return new t({content:Nt(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="human"}};function kd(n){return n.getType()==="human"}function Od(n){return n.getType()==="human"}var ot=class extends De{constructor(e){super(e);m(this,"type","system")}static lc_name(){return"SystemMessage"}static isInstance(e){return super.isInstance(e)&&e.type==="system"}},Ht=class extends Lt{constructor(e){super(e);m(this,"type","system")}static lc_name(){return"SystemMessageChunk"}concat(e){const t=this.constructor;return new t({content:Nt(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&e.type==="system"}};function Pd(n){return n._getType()==="system"}function Nd(n){return n._getType()==="system"}function za(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${e}/
`,n}var an=class extends De{constructor(e){super({...e,content:[]});m(this,"type","remove");m(this,"id");this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&e.type==="remove"}};const Ld=n=>n();function Md(n){return Pl(n)?n:typeof n.id=="string"&&n.type==="function"&&typeof n.function=="object"&&n.function!==null&&"arguments"in n.function&&typeof n.function.arguments=="string"&&"name"in n.function&&typeof n.function.name=="string"?{id:n.id,args:JSON.parse(n.function.arguments),name:n.function.name,type:"tool_call"}:n}function jd(n){return typeof n=="object"&&n!=null&&n.lc===1&&Array.isArray(n.id)&&n.kwargs!=null&&typeof n.kwargs=="object"}function Hn(n){let e,t;if(jd(n)){const r=n.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?e="function":r==="ToolMessage"||r==="ToolMessageChunk"?e="tool":e="unknown",t=n.kwargs}else{const{type:r,...s}=n;e=r,t=s}if(e==="human"||e==="user")return new nt(t);if(e==="ai"||e==="assistant"){const{tool_calls:r,...s}=t;if(!Array.isArray(r))return new wt(t);const a=r.map(Md);return new wt({...s,tool_calls:a})}else{if(e==="system")return new ot(t);if(e==="developer")return new ot({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new Qt({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});if(e==="remove"&&"id"in t&&typeof t.id=="string")return new an({...t,id:t.id});throw za(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(n,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function on(n){if(typeof n=="string")return new nt(n);if(pt(n))return n;if(Array.isArray(n)){const[e,t]=n;return Hn({type:e,content:t})}else if(Vl(n)){const{role:e,...t}=n;return Hn({...t,type:e})}else return Hn(n)}function Va(n,e="Human",t="AI"){const r=[];for(const s of n){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=t;else if(s._getType()==="system")a="System";else if(s._getType()==="tool")a="Tool";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const i=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);r.push(`${a}: ${i}${o}`)}return r.join(`
`)}function Dd(n){if(n.data!==void 0)return n;{const e=n;return{type:e.type,data:{content:e.text,role:e.role,name:void 0,tool_call_id:void 0}}}}function Ql(n){const e=Dd(n);switch(e.type){case"human":return new nt(e.data);case"ai":return new wt(e.data);case"system":return new ot(e.data);case"function":if(e.data.name===void 0)throw new Error("Name must be defined for function messages");return new $n(e.data);case"tool":if(e.data.tool_call_id===void 0)throw new Error("Tool call ID must be defined for tool messages");return new Qt(e.data);case"generic":if(e.data.role===void 0)throw new Error("Role must be defined for chat messages");return new Mt(e.data);default:throw new Error(`Got unexpected type: ${e.type}`)}}function Ud(n){return n.map(Ql)}function Fd(n){return n.map(e=>e.toDict())}function ca(n){var t;const e=n._getType();if(e==="human")return new kn({...n});if(e==="ai"){let r={...n};return"tool_calls"in r&&(r={...r,tool_call_chunks:(t=r.tool_calls)==null?void 0:t.map(s=>({...s,type:"tool_call_chunk",index:void 0,args:JSON.stringify(s.args)}))}),new er({...r})}else{if(e==="system")return new Ht({...n});if(e==="function")return new Cn({...n});if(Mt.isInstance(n))return new Rn({...n});throw new Error("Unknown message type.")}}var Zn={},Bd={};fe(Bd,{getEnv:()=>sc,getEnvironmentVariable:()=>At,getRuntimeEnvironment:()=>ac,isBrowser:()=>ec,isDeno:()=>On,isJsDom:()=>rc,isNode:()=>nc,isWebWorker:()=>tc});const ec=()=>typeof window<"u"&&typeof window.document<"u",tc=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",rc=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),On=()=>typeof Deno<"u",nc=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!On(),sc=()=>{let n;return ec()?n="browser":nc()?n="node":tc()?n="webworker":rc()?n="jsdom":On()?n="deno":n="other",n};let Jn;function ac(){return Jn===void 0&&(Jn={library:"langchain-js",runtime:sc()}),Jn}function At(n){try{return typeof process<"u"?Zn==null?void 0:Zn[n]:On()?Deno==null?void 0:Deno.env.get(n):void 0}catch{return}}const zd=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function mr(n){return typeof n=="string"&&zd.test(n)}function Vd(n){if(!mr(n))throw TypeError("Invalid UUID");var e,t=new Uint8Array(16);return t[0]=(e=parseInt(n.slice(0,8),16))>>>24,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=e&255,t[4]=(e=parseInt(n.slice(9,13),16))>>>8,t[5]=e&255,t[6]=(e=parseInt(n.slice(14,18),16))>>>8,t[7]=e&255,t[8]=(e=parseInt(n.slice(19,23),16))>>>8,t[9]=e&255,t[10]=(e=parseInt(n.slice(24,36),16))/1099511627776&255,t[11]=e/4294967296&255,t[12]=e>>>24&255,t[13]=e>>>16&255,t[14]=e>>>8&255,t[15]=e&255,t}var we=[];for(var Wn=0;Wn<256;++Wn)we.push((Wn+256).toString(16).slice(1));function ic(n,e=0){return(we[n[e+0]]+we[n[e+1]]+we[n[e+2]]+we[n[e+3]]+"-"+we[n[e+4]]+we[n[e+5]]+"-"+we[n[e+6]]+we[n[e+7]]+"-"+we[n[e+8]]+we[n[e+9]]+"-"+we[n[e+10]]+we[n[e+11]]+we[n[e+12]]+we[n[e+13]]+we[n[e+14]]+we[n[e+15]]).toLowerCase()}var Vr,qd=new Uint8Array(16);function Gd(){if(!Vr&&(Vr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Vr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Vr(qd)}function Hd(n){n=unescape(encodeURIComponent(n));for(var e=[],t=0;t<n.length;++t)e.push(n.charCodeAt(t));return e}var Zd="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Jd="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Wd(n,e,t){function r(s,a,i,o){var l;if(typeof s=="string"&&(s=Hd(s)),typeof a=="string"&&(a=Vd(a)),((l=a)===null||l===void 0?void 0:l.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var c=new Uint8Array(16+s.length);if(c.set(a),c.set(s,a.length),c=t(c),c[6]=c[6]&15|e,c[8]=c[8]&63|128,i){o=o||0;for(var u=0;u<16;++u)i[o+u]=c[u];return i}return ic(c)}try{r.name=n}catch{}return r.DNS=Zd,r.URL=Jd,r}var Kd=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const xi={randomUUID:Kd};function Te(n,e,t){if(xi.randomUUID&&!n)return xi.randomUUID();n=n||{};var r=n.random||(n.rng||Gd)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ic(r)}function Yd(n,e,t,r){switch(n){case 0:return e&t^~e&r;case 1:return e^t^r;case 2:return e&t^e&r^t&r;case 3:return e^t^r}}function Kn(n,e){return n<<e|n>>>32-e}function Xd(n){var e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof n=="string"){var r=unescape(encodeURIComponent(n));n=[];for(var s=0;s<r.length;++s)n.push(r.charCodeAt(s))}else Array.isArray(n)||(n=Array.prototype.slice.call(n));n.push(128);for(var a=n.length/4+2,i=Math.ceil(a/16),o=new Array(i),l=0;l<i;++l){for(var c=new Uint32Array(16),u=0;u<16;++u)c[u]=n[l*64+u*4]<<24|n[l*64+u*4+1]<<16|n[l*64+u*4+2]<<8|n[l*64+u*4+3];o[l]=c}o[i-1][14]=(n.length-1)*8/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=(n.length-1)*8&4294967295;for(var d=0;d<i;++d){for(var h=new Uint32Array(80),f=0;f<16;++f)h[f]=o[d][f];for(var p=16;p<80;++p)h[p]=Kn(h[p-3]^h[p-8]^h[p-14]^h[p-16],1);for(var _=t[0],g=t[1],y=t[2],w=t[3],v=t[4],E=0;E<80;++E){var b=Math.floor(E/20),x=Kn(_,5)+Yd(b,g,y,w)+v+e[b]+h[E]>>>0;v=w,w=y,y=Kn(g,30)>>>0,g=_,_=x}t[0]=t[0]+_>>>0,t[1]=t[1]+g>>>0,t[2]=t[2]+y>>>0,t[3]=t[3]+w>>>0,t[4]=t[4]+v>>>0}return[t[0]>>24&255,t[0]>>16&255,t[0]>>8&255,t[0]&255,t[1]>>24&255,t[1]>>16&255,t[1]>>8&255,t[1]&255,t[2]>>24&255,t[2]>>16&255,t[2]>>8&255,t[2]&255,t[3]>>24&255,t[3]>>16&255,t[3]>>8&255,t[3]&255,t[4]>>24&255,t[4]>>16&255,t[4]>>8&255,t[4]&255]}var Ii=Wd("v5",80,Xd),Qd={};fe(Qd,{BaseCallbackHandler:()=>kr,callbackHandlerPrefersStreaming:()=>th,isBaseCallbackHandler:()=>oc});var eh=class{};function th(n){return"lc_prefer_streaming"in n&&n.lc_prefer_streaming}var kr=class extends eh{constructor(e){super();m(this,"lc_serializable",!1);m(this,"lc_kwargs");m(this,"ignoreLLM",!1);m(this,"ignoreChain",!1);m(this,"ignoreAgent",!1);m(this,"ignoreRetriever",!1);m(this,"ignoreCustomEvent",!1);m(this,"raiseError",!1);m(this,"awaitHandlers",At("LANGCHAIN_CALLBACKS_BACKGROUND")==="false");this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ja(this.constructor)]}copy(){return new this.constructor(this)}toJSON(){return Gt.prototype.toJSON.call(this)}toJSONNotImplemented(){return Gt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends kr{constructor(){super();m(this,"name",Te());Object.assign(this,e)}}return new t}};const oc=n=>{const e=n;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"},rh="gen_ai.operation.name",nh="gen_ai.system",Ai="gen_ai.request.model",sh="gen_ai.response.model",Ri="gen_ai.usage.input_tokens",$i="gen_ai.usage.output_tokens",Ci="gen_ai.usage.total_tokens",ah="gen_ai.request.max_tokens",ih="gen_ai.request.temperature",oh="gen_ai.request.top_p",lh="gen_ai.request.frequency_penalty",ch="gen_ai.request.presence_penalty",uh="gen_ai.response.finish_reasons",dh="gen_ai.prompt",hh="gen_ai.completion",fh="gen_ai.request.extra_query",ph="gen_ai.request.extra_body",mh="gen_ai.serialized.name",yh="gen_ai.serialized.signature",gh="gen_ai.serialized.doc",_h="gen_ai.response.id",vh="gen_ai.response.service_tier",wh="gen_ai.response.system_fingerprint",bh="gen_ai.usage.input_token_details",Eh="gen_ai.usage.output_token_details",Sh="langsmith.trace.session_id",Th="langsmith.trace.session_name",xh="langsmith.span.kind",Ih="langsmith.trace.name",Ah="langsmith.metadata",ki="langsmith.span.tags",Rh="langsmith.request.streaming",$h="langsmith.request.headers",Ch=(...n)=>fetch(...n),lc=Symbol.for("ls:fetch_implementation"),kh=()=>{const n=globalThis[lc];return n?typeof n=="function"&&"Headers"in n&&"Request"in n&&"Response"in n:!1},Oh=n=>async(...e)=>{if(n||Ce("DEBUG")==="true"){const[r,s]=e;console.log(` ${(s==null?void 0:s.method)||"GET"} ${r}`)}const t=await(globalThis[lc]??Ch)(...e);return(n||Ce("DEBUG")==="true")&&console.log(` ${t.status} ${t.statusText} ${t.url}`),t},cc=()=>Ce("PROJECT")??rt("LANGCHAIN_SESSION")??"default",uc="0.3.79";var yr={};let Xe;const Ph=()=>typeof window<"u"&&typeof window.document<"u",Nh=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Lh=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),dc=()=>typeof Deno<"u",Mh=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!dc(),hc=()=>Xe||(typeof Bun<"u"?Xe="bun":Ph()?Xe="browser":Mh()?Xe="node":Nh()?Xe="webworker":Lh()?Xe="jsdom":dc()?Xe="deno":Xe="other",Xe);let Yn;function fc(){if(Yn===void 0){const n=hc(),e=Dh();Yn={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:uc,...e}}return Yn}function pc(){const n=jh(),e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(n))typeof s=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function jh(){const n={};try{if(typeof process<"u"&&yr)for(const[e,t]of Object.entries(yr))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&t!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof t=="string"?n[e]=t.slice(0,2)+"*".repeat(t.length-4)+t.slice(-2):n[e]=t)}catch{}return n}function rt(n){try{return typeof process<"u"?yr==null?void 0:yr[n]:void 0}catch{return}}function Ce(n){return rt(`LANGSMITH_${n}`)||rt(`LANGCHAIN_${n}`)}let Xn;function Dh(){if(Xn!==void 0)return Xn;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=rt(t);r!==void 0&&(e[t]=r)}return Xn=e,e}function mc(){return rt("OTEL_ENABLED")==="true"||Ce("OTEL_ENABLED")==="true"}class Uh{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){!this.hasWarned&&mc()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let r;if(t.length===1&&typeof t[0]=="function"?r=t[0]:t.length===2&&typeof t[1]=="function"?r=t[1]:t.length===3&&typeof t[2]=="function"&&(r=t[2]),typeof r=="function")return r()}}class Fh{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new Uh})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}}class Bh{active(){return{}}with(e,t){return t()}}const Qn=Symbol.for("ls:otel_trace"),es=Symbol.for("ls:otel_context"),Oi=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),zh=new Fh,Vh=new Bh;class qh{getTraceInstance(){return globalThis[Qn]??zh}getContextInstance(){return globalThis[es]??Vh}initializeGlobalInstances(e){globalThis[Qn]===void 0&&(globalThis[Qn]=e.trace),globalThis[es]===void 0&&(globalThis[es]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[Oi]=e}getDefaultOTLPTracerComponents(){return globalThis[Oi]??void 0}}const qa=new qh;function yc(){return qa.getTraceInstance()}function Gh(){return qa.getContextInstance()}function Hh(){return qa.getDefaultOTLPTracerComponents()}const Zh={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function Jh(n){return Zh[n]||n}class Wh{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(const r of e)try{if(!r.run)continue;if(r.operation==="post"){const s=this.createSpanForRun(r,r.run,t.get(r.id));s&&!r.run.end_time&&this.spans.set(r.id,s)}else this.updateSpanForRun(r,r.run)}catch(s){console.error(`Error processing operation ${r.id}:`,s)}}createSpanForRun(e,t,r){const s=r&&yc().getSpan(r);if(s)try{return this.finishSpanSetup(s,t,e)}catch(a){console.error(`Failed to create span for run ${e.id}:`,a);return}}finishSpanSetup(e,t,r){return this.setSpanAttributes(e,t,r),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{const r=this.spans.get(e.id);if(!r){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(r,t,e),t.error?(r.setStatus({code:2}),r.recordException(new Error(t.error))):r.setStatus({code:1});const s=t.end_time;s&&(r.end(new Date(s)),this.spans.delete(e.id))}catch(r){console.error(`Failed to update span for run ${e.id}:`,r)}}extractModelName(e){var t;if((t=e.extra)!=null&&t.metadata){const r=e.extra.metadata;if(r.ls_model_name)return r.ls_model_name;if(r.invocation_params){const s=r.invocation_params;if(s.model)return s.model;if(s.model_name)return s.model_name}}}setSpanAttributes(e,t,r){var o;if("run_type"in t&&t.run_type){e.setAttribute(xh,t.run_type);const l=Jh(t.run_type||"chain");e.setAttribute(rh,l)}"name"in t&&t.name&&e.setAttribute(Ih,t.name),"session_id"in t&&t.session_id&&e.setAttribute(Sh,t.session_id),"session_name"in t&&t.session_name&&e.setAttribute(Th,t.session_name),this.setGenAiSystem(e,t);const s=this.extractModelName(t);s&&e.setAttribute(Ai,s),"prompt_tokens"in t&&typeof t.prompt_tokens=="number"&&e.setAttribute(Ri,t.prompt_tokens),"completion_tokens"in t&&typeof t.completion_tokens=="number"&&e.setAttribute($i,t.completion_tokens),"total_tokens"in t&&typeof t.total_tokens=="number"&&e.setAttribute(Ci,t.total_tokens),this.setInvocationParameters(e,t);const a=((o=t.extra)==null?void 0:o.metadata)||{};for(const[l,c]of Object.entries(a))c!=null&&e.setAttribute(`${Ah}.${l}`,String(c));const i=t.tags;if(i&&Array.isArray(i)?e.setAttribute(ki,i.join(", ")):i&&e.setAttribute(ki,String(i)),"serialized"in t&&typeof t.serialized=="object"){const l=t.serialized;l.name&&e.setAttribute(mh,String(l.name)),l.signature&&e.setAttribute(yh,String(l.signature)),l.doc&&e.setAttribute(gh,String(l.doc))}this.setIOAttributes(e,r)}setGenAiSystem(e,t){let r="langchain";const s=this.extractModelName(t);if(s){const a=s.toLowerCase();a.includes("anthropic")||a.startsWith("claude")?r="anthropic":a.includes("bedrock")?r="aws.bedrock":a.includes("azure")&&a.includes("openai")?r="az.ai.openai":a.includes("azure")&&a.includes("inference")?r="az.ai.inference":a.includes("cohere")?r="cohere":a.includes("deepseek")?r="deepseek":a.includes("gemini")?r="gemini":a.includes("groq")?r="groq":a.includes("watson")||a.includes("ibm")?r="ibm.watsonx.ai":a.includes("mistral")?r="mistral_ai":a.includes("gpt")||a.includes("openai")?r="openai":a.includes("perplexity")||a.includes("sonar")?r="perplexity":a.includes("vertex")?r="vertex_ai":(a.includes("xai")||a.includes("grok"))&&(r="xai")}e.setAttribute(nh,r)}setInvocationParameters(e,t){var s,a;if(!((a=(s=t.extra)==null?void 0:s.metadata)!=null&&a.invocation_params))return;const r=t.extra.metadata.invocation_params;r.max_tokens!==void 0&&e.setAttribute(ah,r.max_tokens),r.temperature!==void 0&&e.setAttribute(ih,r.temperature),r.top_p!==void 0&&e.setAttribute(oh,r.top_p),r.frequency_penalty!==void 0&&e.setAttribute(lh,r.frequency_penalty),r.presence_penalty!==void 0&&e.setAttribute(ch,r.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{const r=t.run.inputs;typeof r=="object"&&r!==null&&(r.model&&Array.isArray(r.messages)&&e.setAttribute(Ai,r.model),r.stream!==void 0&&e.setAttribute(Rh,r.stream),r.extra_headers&&e.setAttribute($h,JSON.stringify(r.extra_headers)),r.extra_query&&e.setAttribute(fh,JSON.stringify(r.extra_query)),r.extra_body&&e.setAttribute(ph,JSON.stringify(r.extra_body))),e.setAttribute(dh,JSON.stringify(r))}catch(r){console.debug(`Failed to process inputs for run ${t.id}`,r)}if(t.run.outputs)try{const r=t.run.outputs,s=this.getUnifiedRunTokens(r);if(s&&(e.setAttribute(Ri,s[0]),e.setAttribute($i,s[1]),e.setAttribute(Ci,s[0]+s[1])),r&&typeof r=="object"){if(r.model&&e.setAttribute(sh,String(r.model)),r.id&&e.setAttribute(_h,r.id),r.choices&&Array.isArray(r.choices)){const a=r.choices.map(i=>i.finish_reason).filter(i=>i).map(String);a.length>0&&e.setAttribute(uh,a.join(", "))}if(r.service_tier&&e.setAttribute(vh,r.service_tier),r.system_fingerprint&&e.setAttribute(wh,r.system_fingerprint),r.usage_metadata&&typeof r.usage_metadata=="object"){const a=r.usage_metadata;a.input_token_details&&e.setAttribute(bh,JSON.stringify(a.input_token_details)),a.output_token_details&&e.setAttribute(Eh,JSON.stringify(a.output_token_details))}}e.setAttribute(hh,JSON.stringify(r))}catch(r){console.debug(`Failed to process outputs for run ${t.id}`,r)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;const r=Object.keys(e);for(const i of r){const o=e[i];if(!(!o||typeof o!="object")&&(t=this.extractUnifiedRunTokens(o.usage_metadata),t||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(t=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),t)))return t}const s=e.generations||[];if(!Array.isArray(s))return null;const a=Array.isArray(s[0])?s.flat():s;for(const i of a)if(typeof i=="object"&&i.message&&typeof i.message=="object"&&i.message.kwargs&&typeof i.message.kwargs=="object"&&(t=this.extractUnifiedRunTokens(i.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}var or={exports:{}},ts={},rs,Pi;function Kh(){if(Pi)return rs;Pi=1;function n(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return rs=n,n.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},n.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},n.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},r),this._options.unref&&this._timer.unref(),!0},n.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},n.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},n.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},n.prototype.start=n.prototype.try,n.prototype.errors=function(){return this._errors},n.prototype.attempts=function(){return this._attempts},n.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,r=0,s=0;s<this._errors.length;s++){var a=this._errors[s],i=a.message,o=(e[i]||0)+1;e[i]=o,o>=r&&(t=a,r=o)}return t},rs}var Ni;function Yh(){return Ni||(Ni=1,(function(n){var e=Kh();n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)r[s]=t[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],i=0;i<r.retries;i++)a.push(this.createTimeout(i,r));return t&&t.forever&&!a.length&&a.push(this.createTimeout(i,r)),a.sort(function(o,l){return o-l}),a},n.createTimeout=function(t,r){var s=r.randomize?Math.random()+1:1,a=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return a=Math.min(a,r.maxTimeout),a},n.wrap=function(t,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var a in t)typeof t[a]=="function"&&s.push(a)}for(var i=0;i<s.length;i++){var o=s[i],l=t[o];t[o]=(function(u){var d=n.operation(r),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(p){d.retry(p)||(p&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){u.apply(t,h)})}).bind(t,l),t[o].options=r}}})(ts)),ts}var ns,Li;function Xh(){return Li||(Li=1,ns=Yh()),ns}var Mi;function Qh(){if(Mi)return or.exports;Mi=1;const n=Xh(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class t extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const r=(i,o,l)=>{const c=l.retries-(o-1);return i.attemptNumber=o,i.retriesLeft=c,i},s=i=>e.includes(i),a=(i,o)=>new Promise((l,c)=>{o={onFailedAttempt:()=>{},retries:10,...o};const u=n.operation(o);u.attempt(async d=>{try{l(await i(d))}catch(h){if(!(h instanceof Error)){c(new TypeError(`Non-error was thrown: "${h}". You should only throw errors.`));return}if(h instanceof t)u.stop(),c(h.originalError);else if(h instanceof TypeError&&!s(h.message))u.stop(),c(h);else{r(h,d,o);try{await o.onFailedAttempt(h)}catch(f){c(f);return}u.retry(h)||c(u.mainError())}}})});return or.exports=a,or.exports.default=a,or.exports.AbortError=t,or.exports}var ef=Qh();const ln=In(ef);var qr={},ss={exports:{}},ji;function tf(){return ji||(ji=1,(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function s(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function a(l,c,u,d,h){if(typeof u!="function")throw new TypeError("The listener must be a function");var f=new s(u,d||l,h),p=t?t+c:c;return l._events[p]?l._events[p].fn?l._events[p]=[l._events[p],f]:l._events[p].push(f):(l._events[p]=f,l._eventsCount++),l}function i(l,c){--l._eventsCount===0?l._events=new r:delete l._events[c]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],u,d;if(this._eventsCount===0)return c;for(d in u=this._events)e.call(u,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},o.prototype.listeners=function(c){var u=t?t+c:c,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,p=new Array(f);h<f;h++)p[h]=d[h].fn;return p},o.prototype.listenerCount=function(c){var u=t?t+c:c,d=this._events[u];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,u,d,h,f,p){var _=t?t+c:c;if(!this._events[_])return!1;var g=this._events[_],y=arguments.length,w,v;if(g.fn){switch(g.once&&this.removeListener(c,g.fn,void 0,!0),y){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,u),!0;case 3:return g.fn.call(g.context,u,d),!0;case 4:return g.fn.call(g.context,u,d,h),!0;case 5:return g.fn.call(g.context,u,d,h,f),!0;case 6:return g.fn.call(g.context,u,d,h,f,p),!0}for(v=1,w=new Array(y-1);v<y;v++)w[v-1]=arguments[v];g.fn.apply(g.context,w)}else{var E=g.length,b;for(v=0;v<E;v++)switch(g[v].once&&this.removeListener(c,g[v].fn,void 0,!0),y){case 1:g[v].fn.call(g[v].context);break;case 2:g[v].fn.call(g[v].context,u);break;case 3:g[v].fn.call(g[v].context,u,d);break;case 4:g[v].fn.call(g[v].context,u,d,h);break;default:if(!w)for(b=1,w=new Array(y-1);b<y;b++)w[b-1]=arguments[b];g[v].fn.apply(g[v].context,w)}}return!0},o.prototype.on=function(c,u,d){return a(this,c,u,d,!1)},o.prototype.once=function(c,u,d){return a(this,c,u,d,!0)},o.prototype.removeListener=function(c,u,d,h){var f=t?t+c:c;if(!this._events[f])return this;if(!u)return i(this,f),this;var p=this._events[f];if(p.fn)p.fn===u&&(!h||p.once)&&(!d||p.context===d)&&i(this,f);else{for(var _=0,g=[],y=p.length;_<y;_++)(p[_].fn!==u||h&&!p[_].once||d&&p[_].context!==d)&&g.push(p[_]);g.length?this._events[f]=g.length===1?g[0]:g:i(this,f)}return this},o.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&i(this,u)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(ss)),ss.exports}var lr={exports:{}},as,Di;function rf(){return Di||(Di=1,as=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))),as}var Ui;function nf(){if(Ui)return lr.exports;Ui=1;const n=rf();class e extends Error{constructor(s){super(s),this.name="TimeoutError"}}const t=(r,s,a)=>new Promise((i,o)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){i(r);return}const l=setTimeout(()=>{if(typeof a=="function"){try{i(a())}catch(d){o(d)}return}const c=typeof a=="string"?a:`Promise timed out after ${s} milliseconds`,u=a instanceof Error?a:new e(c);typeof r.cancel=="function"&&r.cancel(),o(u)},s);n(r.then(i,o),()=>{clearTimeout(l)})});return lr.exports=t,lr.exports.default=t,lr.exports.TimeoutError=e,lr.exports}var Gr={},Hr={},Fi;function sf(){if(Fi)return Hr;Fi=1,Object.defineProperty(Hr,"__esModule",{value:!0});function n(e,t,r){let s=0,a=e.length;for(;a>0;){const i=a/2|0;let o=s+i;r(e[o],t)<=0?(s=++o,a-=i+1):a=i}return s}return Hr.default=n,Hr}var Bi;function af(){if(Bi)return Gr;Bi=1,Object.defineProperty(Gr,"__esModule",{value:!0});const n=sf();class e{constructor(){this._queue=[]}enqueue(r,s){s=Object.assign({priority:0},s);const a={priority:s.priority,run:r};if(this.size&&this._queue[this.size-1].priority>=s.priority){this._queue.push(a);return}const i=n.default(this._queue,a,(o,l)=>l.priority-o.priority);this._queue.splice(i,0,a)}dequeue(){const r=this._queue.shift();return r==null?void 0:r.run}filter(r){return this._queue.filter(s=>s.priority===r.priority).map(s=>s.run)}get size(){return this._queue.length}}return Gr.default=e,Gr}var zi;function of(){if(zi)return qr;zi=1,Object.defineProperty(qr,"__esModule",{value:!0});const n=tf(),e=nf(),t=af(),r=()=>{},s=new e.TimeoutError;class a extends n{constructor(o){var l,c,u,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=r,this._resolveIdle=r,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:t.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(c=(l=o.intervalCap)===null||l===void 0?void 0:l.toString())!==null&&c!==void 0?c:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(u=o.interval)===null||u===void 0?void 0:u.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=r,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=r,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const l=this._intervalEnd-o;if(l<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},l)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const l=this._queue.dequeue();return l?(this.emit("active"),l(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,l={}){return new Promise((c,u)=>{const d=async()=>{this._pendingCount++,this._intervalCount++;try{const h=this._timeout===void 0&&l.timeout===void 0?o():e.default(Promise.resolve(o()),l.timeout===void 0?this._timeout:l.timeout,()=>{(l.throwOnTimeout===void 0?this._throwOnTimeout:l.throwOnTimeout)&&u(s)});c(await h)}catch(h){u(h)}this._next()};this._queue.enqueue(d,l),this._tryToStartAnother(),this.emit("add")})}async addAll(o,l){return Promise.all(o.map(async c=>this.add(c,l)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const l=this._resolveEmpty;this._resolveEmpty=()=>{l(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const l=this._resolveIdle;this._resolveIdle=()=>{l(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return qr.default=a,qr}var lf=of();const at=In(lf),cf=[429,500,502,503,504];let Vi=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in at?this.queue=new at.default({concurrency:this.maxConcurrency}):this.queue=new at({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>ln(()=>e(...t).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.name==="TimeoutError"||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;const a=s==null?void 0:s.response;if(r&&await r(a))return;const i=(a==null?void 0:a.status)??(s==null?void 0:s.status);if(i&&!cf.includes(+i))throw s},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}};function qi(n){return typeof(n==null?void 0:n._getType)=="function"}function Gi(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}const uf=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Y(n,e){if(!uf.test(n)){const t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}const Hi={};function ua(n){Hi[n]||(console.warn(n),Hi[n]=!0)}var Zr={exports:{}},is,Zi;function Pn(){if(Zi)return is;Zi=1;const n="2.0.0",e=256,t=Number.MAX_SAFE_INTEGER||9007199254740991,r=16,s=e-6;return is={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:s,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:n,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},is}var os,Ji;function Nn(){if(Ji)return os;Ji=1;var n={};return os=typeof process=="object"&&n&&n.NODE_DEBUG&&/\bsemver\b/i.test(n.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{},os}var Wi;function Or(){return Wi||(Wi=1,(function(n,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=Pn(),a=Nn();e=n.exports={};const i=e.re=[],o=e.safeRe=[],l=e.src=[],c=e.safeSrc=[],u=e.t={};let d=0;const h="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[h,r]],p=g=>{for(const[y,w]of f)g=g.split(`${y}*`).join(`${y}{0,${w}}`).split(`${y}+`).join(`${y}{1,${w}}`);return g},_=(g,y,w)=>{const v=p(y),E=d++;a(g,E,y),u[g]=E,l[E]=y,c[E]=v,i[E]=new RegExp(y,w?"g":void 0),o[E]=new RegExp(v,w?"g":void 0)};_("NUMERICIDENTIFIER","0|[1-9]\\d*"),_("NUMERICIDENTIFIERLOOSE","\\d+"),_("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),_("MAINVERSION",`(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})`),_("MAINVERSIONLOOSE",`(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})`),_("PRERELEASEIDENTIFIER",`(?:${l[u.NONNUMERICIDENTIFIER]}|${l[u.NUMERICIDENTIFIER]})`),_("PRERELEASEIDENTIFIERLOOSE",`(?:${l[u.NONNUMERICIDENTIFIER]}|${l[u.NUMERICIDENTIFIERLOOSE]})`),_("PRERELEASE",`(?:-(${l[u.PRERELEASEIDENTIFIER]}(?:\\.${l[u.PRERELEASEIDENTIFIER]})*))`),_("PRERELEASELOOSE",`(?:-?(${l[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[u.PRERELEASEIDENTIFIERLOOSE]})*))`),_("BUILDIDENTIFIER",`${h}+`),_("BUILD",`(?:\\+(${l[u.BUILDIDENTIFIER]}(?:\\.${l[u.BUILDIDENTIFIER]})*))`),_("FULLPLAIN",`v?${l[u.MAINVERSION]}${l[u.PRERELEASE]}?${l[u.BUILD]}?`),_("FULL",`^${l[u.FULLPLAIN]}$`),_("LOOSEPLAIN",`[v=\\s]*${l[u.MAINVERSIONLOOSE]}${l[u.PRERELEASELOOSE]}?${l[u.BUILD]}?`),_("LOOSE",`^${l[u.LOOSEPLAIN]}$`),_("GTLT","((?:<|>)?=?)"),_("XRANGEIDENTIFIERLOOSE",`${l[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),_("XRANGEIDENTIFIER",`${l[u.NUMERICIDENTIFIER]}|x|X|\\*`),_("XRANGEPLAIN",`[v=\\s]*(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:${l[u.PRERELEASE]})?${l[u.BUILD]}?)?)?`),_("XRANGEPLAINLOOSE",`[v=\\s]*(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:${l[u.PRERELEASELOOSE]})?${l[u.BUILD]}?)?)?`),_("XRANGE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAIN]}$`),_("XRANGELOOSE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAINLOOSE]}$`),_("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),_("COERCE",`${l[u.COERCEPLAIN]}(?:$|[^\\d])`),_("COERCEFULL",l[u.COERCEPLAIN]+`(?:${l[u.PRERELEASE]})?(?:${l[u.BUILD]})?(?:$|[^\\d])`),_("COERCERTL",l[u.COERCE],!0),_("COERCERTLFULL",l[u.COERCEFULL],!0),_("LONETILDE","(?:~>?)"),_("TILDETRIM",`(\\s*)${l[u.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",_("TILDE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAIN]}$`),_("TILDELOOSE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAINLOOSE]}$`),_("LONECARET","(?:\\^)"),_("CARETTRIM",`(\\s*)${l[u.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",_("CARET",`^${l[u.LONECARET]}${l[u.XRANGEPLAIN]}$`),_("CARETLOOSE",`^${l[u.LONECARET]}${l[u.XRANGEPLAINLOOSE]}$`),_("COMPARATORLOOSE",`^${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]})$|^$`),_("COMPARATOR",`^${l[u.GTLT]}\\s*(${l[u.FULLPLAIN]})$|^$`),_("COMPARATORTRIM",`(\\s*)${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]}|${l[u.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",_("HYPHENRANGE",`^\\s*(${l[u.XRANGEPLAIN]})\\s+-\\s+(${l[u.XRANGEPLAIN]})\\s*$`),_("HYPHENRANGELOOSE",`^\\s*(${l[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[u.XRANGEPLAINLOOSE]})\\s*$`),_("STAR","(<|>)?=?\\s*\\*"),_("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),_("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Zr,Zr.exports)),Zr.exports}var ls,Ki;function Ga(){if(Ki)return ls;Ki=1;const n=Object.freeze({loose:!0}),e=Object.freeze({});return ls=r=>r?typeof r!="object"?n:r:e,ls}var cs,Yi;function gc(){if(Yi)return cs;Yi=1;const n=/^[0-9]+$/,e=(r,s)=>{if(typeof r=="number"&&typeof s=="number")return r===s?0:r<s?-1:1;const a=n.test(r),i=n.test(s);return a&&i&&(r=+r,s=+s),r===s?0:a&&!i?-1:i&&!a?1:r<s?-1:1};return cs={compareIdentifiers:e,rcompareIdentifiers:(r,s)=>e(s,r)},cs}var us,Xi;function xe(){if(Xi)return us;Xi=1;const n=Nn(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:t}=Pn(),{safeRe:r,t:s}=Or(),a=Ga(),{compareIdentifiers:i}=gc();class o{constructor(c,u){if(u=a(u),c instanceof o){if(c.loose===!!u.loose&&c.includePrerelease===!!u.includePrerelease)return c;c=c.version}else if(typeof c!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof c}".`);if(c.length>e)throw new TypeError(`version is longer than ${e} characters`);n("SemVer",c,u),this.options=u,this.loose=!!u.loose,this.includePrerelease=!!u.includePrerelease;const d=c.trim().match(u.loose?r[s.LOOSE]:r[s.FULL]);if(!d)throw new TypeError(`Invalid Version: ${c}`);if(this.raw=c,this.major=+d[1],this.minor=+d[2],this.patch=+d[3],this.major>t||this.major<0)throw new TypeError("Invalid major version");if(this.minor>t||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>t||this.patch<0)throw new TypeError("Invalid patch version");d[4]?this.prerelease=d[4].split(".").map(h=>{if(/^[0-9]+$/.test(h)){const f=+h;if(f>=0&&f<t)return f}return h}):this.prerelease=[],this.build=d[5]?d[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(c){if(n("SemVer.compare",this.version,this.options,c),!(c instanceof o)){if(typeof c=="string"&&c===this.version)return 0;c=new o(c,this.options)}return c.version===this.version?0:this.compareMain(c)||this.comparePre(c)}compareMain(c){return c instanceof o||(c=new o(c,this.options)),this.major<c.major?-1:this.major>c.major?1:this.minor<c.minor?-1:this.minor>c.minor?1:this.patch<c.patch?-1:this.patch>c.patch?1:0}comparePre(c){if(c instanceof o||(c=new o(c,this.options)),this.prerelease.length&&!c.prerelease.length)return-1;if(!this.prerelease.length&&c.prerelease.length)return 1;if(!this.prerelease.length&&!c.prerelease.length)return 0;let u=0;do{const d=this.prerelease[u],h=c.prerelease[u];if(n("prerelease compare",u,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return i(d,h)}while(++u)}compareBuild(c){c instanceof o||(c=new o(c,this.options));let u=0;do{const d=this.build[u],h=c.build[u];if(n("build compare",u,d,h),d===void 0&&h===void 0)return 0;if(h===void 0)return 1;if(d===void 0)return-1;if(d===h)continue;return i(d,h)}while(++u)}inc(c,u,d){if(c.startsWith("pre")){if(!u&&d===!1)throw new Error("invalid increment argument: identifier is empty");if(u){const h=`-${u}`.match(this.options.loose?r[s.PRERELEASELOOSE]:r[s.PRERELEASE]);if(!h||h[1]!==u)throw new Error(`invalid identifier: ${u}`)}}switch(c){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",u,d);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",u,d);break;case"prepatch":this.prerelease.length=0,this.inc("patch",u,d),this.inc("pre",u,d);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",u,d),this.inc("pre",u,d);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const h=Number(d)?1:0;if(this.prerelease.length===0)this.prerelease=[h];else{let f=this.prerelease.length;for(;--f>=0;)typeof this.prerelease[f]=="number"&&(this.prerelease[f]++,f=-2);if(f===-1){if(u===this.prerelease.join(".")&&d===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(h)}}if(u){let f=[u,h];d===!1&&(f=[u]),i(this.prerelease[0],u)===0?isNaN(this.prerelease[1])&&(this.prerelease=f):this.prerelease=f}break}default:throw new Error(`invalid increment argument: ${c}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return us=o,us}var ds,Qi;function tr(){if(Qi)return ds;Qi=1;const n=xe();return ds=(t,r,s=!1)=>{if(t instanceof n)return t;try{return new n(t,r)}catch(a){if(!s)return null;throw a}},ds}var hs,eo;function df(){if(eo)return hs;eo=1;const n=tr();return hs=(t,r)=>{const s=n(t,r);return s?s.version:null},hs}var fs,to;function hf(){if(to)return fs;to=1;const n=tr();return fs=(t,r)=>{const s=n(t.trim().replace(/^[=v]+/,""),r);return s?s.version:null},fs}var ps,ro;function ff(){if(ro)return ps;ro=1;const n=xe();return ps=(t,r,s,a,i)=>{typeof s=="string"&&(i=a,a=s,s=void 0);try{return new n(t instanceof n?t.version:t,s).inc(r,a,i).version}catch{return null}},ps}var ms,no;function pf(){if(no)return ms;no=1;const n=tr();return ms=(t,r)=>{const s=n(t,null,!0),a=n(r,null,!0),i=s.compare(a);if(i===0)return null;const o=i>0,l=o?s:a,c=o?a:s,u=!!l.prerelease.length;if(!!c.prerelease.length&&!u){if(!c.patch&&!c.minor)return"major";if(c.compareMain(l)===0)return c.minor&&!c.patch?"minor":"patch"}const h=u?"pre":"";return s.major!==a.major?h+"major":s.minor!==a.minor?h+"minor":s.patch!==a.patch?h+"patch":"prerelease"},ms}var ys,so;function mf(){if(so)return ys;so=1;const n=xe();return ys=(t,r)=>new n(t,r).major,ys}var gs,ao;function yf(){if(ao)return gs;ao=1;const n=xe();return gs=(t,r)=>new n(t,r).minor,gs}var _s,io;function gf(){if(io)return _s;io=1;const n=xe();return _s=(t,r)=>new n(t,r).patch,_s}var vs,oo;function _f(){if(oo)return vs;oo=1;const n=tr();return vs=(t,r)=>{const s=n(t,r);return s&&s.prerelease.length?s.prerelease:null},vs}var ws,lo;function We(){if(lo)return ws;lo=1;const n=xe();return ws=(t,r,s)=>new n(t,s).compare(new n(r,s)),ws}var bs,co;function vf(){if(co)return bs;co=1;const n=We();return bs=(t,r,s)=>n(r,t,s),bs}var Es,uo;function wf(){if(uo)return Es;uo=1;const n=We();return Es=(t,r)=>n(t,r,!0),Es}var Ss,ho;function Ha(){if(ho)return Ss;ho=1;const n=xe();return Ss=(t,r,s)=>{const a=new n(t,s),i=new n(r,s);return a.compare(i)||a.compareBuild(i)},Ss}var Ts,fo;function bf(){if(fo)return Ts;fo=1;const n=Ha();return Ts=(t,r)=>t.sort((s,a)=>n(s,a,r)),Ts}var xs,po;function Ef(){if(po)return xs;po=1;const n=Ha();return xs=(t,r)=>t.sort((s,a)=>n(a,s,r)),xs}var Is,mo;function Ln(){if(mo)return Is;mo=1;const n=We();return Is=(t,r,s)=>n(t,r,s)>0,Is}var As,yo;function Za(){if(yo)return As;yo=1;const n=We();return As=(t,r,s)=>n(t,r,s)<0,As}var Rs,go;function _c(){if(go)return Rs;go=1;const n=We();return Rs=(t,r,s)=>n(t,r,s)===0,Rs}var $s,_o;function vc(){if(_o)return $s;_o=1;const n=We();return $s=(t,r,s)=>n(t,r,s)!==0,$s}var Cs,vo;function Ja(){if(vo)return Cs;vo=1;const n=We();return Cs=(t,r,s)=>n(t,r,s)>=0,Cs}var ks,wo;function Wa(){if(wo)return ks;wo=1;const n=We();return ks=(t,r,s)=>n(t,r,s)<=0,ks}var Os,bo;function wc(){if(bo)return Os;bo=1;const n=_c(),e=vc(),t=Ln(),r=Ja(),s=Za(),a=Wa();return Os=(o,l,c,u)=>{switch(l){case"===":return typeof o=="object"&&(o=o.version),typeof c=="object"&&(c=c.version),o===c;case"!==":return typeof o=="object"&&(o=o.version),typeof c=="object"&&(c=c.version),o!==c;case"":case"=":case"==":return n(o,c,u);case"!=":return e(o,c,u);case">":return t(o,c,u);case">=":return r(o,c,u);case"<":return s(o,c,u);case"<=":return a(o,c,u);default:throw new TypeError(`Invalid operator: ${l}`)}},Os}var Ps,Eo;function Sf(){if(Eo)return Ps;Eo=1;const n=xe(),e=tr(),{safeRe:t,t:r}=Or();return Ps=(a,i)=>{if(a instanceof n)return a;if(typeof a=="number"&&(a=String(a)),typeof a!="string")return null;i=i||{};let o=null;if(!i.rtl)o=a.match(i.includePrerelease?t[r.COERCEFULL]:t[r.COERCE]);else{const f=i.includePrerelease?t[r.COERCERTLFULL]:t[r.COERCERTL];let p;for(;(p=f.exec(a))&&(!o||o.index+o[0].length!==a.length);)(!o||p.index+p[0].length!==o.index+o[0].length)&&(o=p),f.lastIndex=p.index+p[1].length+p[2].length;f.lastIndex=-1}if(o===null)return null;const l=o[2],c=o[3]||"0",u=o[4]||"0",d=i.includePrerelease&&o[5]?`-${o[5]}`:"",h=i.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${l}.${c}.${u}${d}${h}`,i)},Ps}var Ns,So;function Tf(){if(So)return Ns;So=1;class n{constructor(){this.max=1e3,this.map=new Map}get(t){const r=this.map.get(t);if(r!==void 0)return this.map.delete(t),this.map.set(t,r),r}delete(t){return this.map.delete(t)}set(t,r){if(!this.delete(t)&&r!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(t,r)}return this}}return Ns=n,Ns}var Ls,To;function Ke(){if(To)return Ls;To=1;const n=/\s+/g;class e{constructor(A,z){if(z=s(z),A instanceof e)return A.loose===!!z.loose&&A.includePrerelease===!!z.includePrerelease?A:new e(A.raw,z);if(A instanceof a)return this.raw=A.value,this.set=[[A]],this.formatted=void 0,this;if(this.options=z,this.loose=!!z.loose,this.includePrerelease=!!z.includePrerelease,this.raw=A.trim().replace(n," "),this.set=this.raw.split("||").map(j=>this.parseRange(j.trim())).filter(j=>j.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const j=this.set[0];if(this.set=this.set.filter(V=>!_(V[0])),this.set.length===0)this.set=[j];else if(this.set.length>1){for(const V of this.set)if(V.length===1&&g(V[0])){this.set=[V];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let A=0;A<this.set.length;A++){A>0&&(this.formatted+="||");const z=this.set[A];for(let j=0;j<z.length;j++)j>0&&(this.formatted+=" "),this.formatted+=z[j].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(A){const j=((this.options.includePrerelease&&f)|(this.options.loose&&p))+":"+A,V=r.get(j);if(V)return V;const D=this.options.loose,H=D?l[c.HYPHENRANGELOOSE]:l[c.HYPHENRANGE];A=A.replace(H,Fe(this.options.includePrerelease)),i("hyphen replace",A),A=A.replace(l[c.COMPARATORTRIM],u),i("comparator trim",A),A=A.replace(l[c.TILDETRIM],d),i("tilde trim",A),A=A.replace(l[c.CARETTRIM],h),i("caret trim",A);let ee=A.split(" ").map(ae=>w(ae,this.options)).join(" ").split(/\s+/).map(ae=>Pe(ae,this.options));D&&(ee=ee.filter(ae=>(i("loose invalid filter",ae,this.options),!!ae.match(l[c.COMPARATORLOOSE])))),i("range list",ee);const X=new Map,oe=ee.map(ae=>new a(ae,this.options));for(const ae of oe){if(_(ae))return[ae];X.set(ae.value,ae)}X.size>1&&X.has("")&&X.delete("");const _e=[...X.values()];return r.set(j,_e),_e}intersects(A,z){if(!(A instanceof e))throw new TypeError("a Range is required");return this.set.some(j=>y(j,z)&&A.set.some(V=>y(V,z)&&j.every(D=>V.every(H=>D.intersects(H,z)))))}test(A){if(!A)return!1;if(typeof A=="string")try{A=new o(A,this.options)}catch{return!1}for(let z=0;z<this.set.length;z++)if(Ut(this.set[z],A,this.options))return!0;return!1}}Ls=e;const t=Tf(),r=new t,s=Ga(),a=Mn(),i=Nn(),o=xe(),{safeRe:l,t:c,comparatorTrimReplace:u,tildeTrimReplace:d,caretTrimReplace:h}=Or(),{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:p}=Pn(),_=$=>$.value==="<0.0.0-0",g=$=>$.value==="",y=($,A)=>{let z=!0;const j=$.slice();let V=j.pop();for(;z&&j.length;)z=j.every(D=>V.intersects(D,A)),V=j.pop();return z},w=($,A)=>($=$.replace(l[c.BUILD],""),i("comp",$,A),$=x($,A),i("caret",$),$=E($,A),i("tildes",$),$=I($,A),i("xrange",$),$=ve($,A),i("stars",$),$),v=$=>!$||$.toLowerCase()==="x"||$==="*",E=($,A)=>$.trim().split(/\s+/).map(z=>b(z,A)).join(" "),b=($,A)=>{const z=A.loose?l[c.TILDELOOSE]:l[c.TILDE];return $.replace(z,(j,V,D,H,ee)=>{i("tilde",$,j,V,D,H,ee);let X;return v(V)?X="":v(D)?X=`>=${V}.0.0 <${+V+1}.0.0-0`:v(H)?X=`>=${V}.${D}.0 <${V}.${+D+1}.0-0`:ee?(i("replaceTilde pr",ee),X=`>=${V}.${D}.${H}-${ee} <${V}.${+D+1}.0-0`):X=`>=${V}.${D}.${H} <${V}.${+D+1}.0-0`,i("tilde return",X),X})},x=($,A)=>$.trim().split(/\s+/).map(z=>N(z,A)).join(" "),N=($,A)=>{i("caret",$,A);const z=A.loose?l[c.CARETLOOSE]:l[c.CARET],j=A.includePrerelease?"-0":"";return $.replace(z,(V,D,H,ee,X)=>{i("caret",$,V,D,H,ee,X);let oe;return v(D)?oe="":v(H)?oe=`>=${D}.0.0${j} <${+D+1}.0.0-0`:v(ee)?D==="0"?oe=`>=${D}.${H}.0${j} <${D}.${+H+1}.0-0`:oe=`>=${D}.${H}.0${j} <${+D+1}.0.0-0`:X?(i("replaceCaret pr",X),D==="0"?H==="0"?oe=`>=${D}.${H}.${ee}-${X} <${D}.${H}.${+ee+1}-0`:oe=`>=${D}.${H}.${ee}-${X} <${D}.${+H+1}.0-0`:oe=`>=${D}.${H}.${ee}-${X} <${+D+1}.0.0-0`):(i("no pr"),D==="0"?H==="0"?oe=`>=${D}.${H}.${ee}${j} <${D}.${H}.${+ee+1}-0`:oe=`>=${D}.${H}.${ee}${j} <${D}.${+H+1}.0-0`:oe=`>=${D}.${H}.${ee} <${+D+1}.0.0-0`),i("caret return",oe),oe})},I=($,A)=>(i("replaceXRanges",$,A),$.split(/\s+/).map(z=>le(z,A)).join(" ")),le=($,A)=>{$=$.trim();const z=A.loose?l[c.XRANGELOOSE]:l[c.XRANGE];return $.replace(z,(j,V,D,H,ee,X)=>{i("xRange",$,j,V,D,H,ee,X);const oe=v(D),_e=oe||v(H),ae=_e||v(ee),Ye=ae;return V==="="&&Ye&&(V=""),X=A.includePrerelease?"-0":"",oe?V===">"||V==="<"?j="<0.0.0-0":j="*":V&&Ye?(_e&&(H=0),ee=0,V===">"?(V=">=",_e?(D=+D+1,H=0,ee=0):(H=+H+1,ee=0)):V==="<="&&(V="<",_e?D=+D+1:H=+H+1),V==="<"&&(X="-0"),j=`${V+D}.${H}.${ee}${X}`):_e?j=`>=${D}.0.0${X} <${+D+1}.0.0-0`:ae&&(j=`>=${D}.${H}.0${X} <${D}.${+H+1}.0-0`),i("xRange return",j),j})},ve=($,A)=>(i("replaceStars",$,A),$.trim().replace(l[c.STAR],"")),Pe=($,A)=>(i("replaceGTE0",$,A),$.trim().replace(l[A.includePrerelease?c.GTE0PRE:c.GTE0],"")),Fe=$=>(A,z,j,V,D,H,ee,X,oe,_e,ae,Ye)=>(v(j)?z="":v(V)?z=`>=${j}.0.0${$?"-0":""}`:v(D)?z=`>=${j}.${V}.0${$?"-0":""}`:H?z=`>=${z}`:z=`>=${z}${$?"-0":""}`,v(oe)?X="":v(_e)?X=`<${+oe+1}.0.0-0`:v(ae)?X=`<${oe}.${+_e+1}.0-0`:Ye?X=`<=${oe}.${_e}.${ae}-${Ye}`:$?X=`<${oe}.${_e}.${+ae+1}-0`:X=`<=${X}`,`${z} ${X}`.trim()),Ut=($,A,z)=>{for(let j=0;j<$.length;j++)if(!$[j].test(A))return!1;if(A.prerelease.length&&!z.includePrerelease){for(let j=0;j<$.length;j++)if(i($[j].semver),$[j].semver!==a.ANY&&$[j].semver.prerelease.length>0){const V=$[j].semver;if(V.major===A.major&&V.minor===A.minor&&V.patch===A.patch)return!0}return!1}return!0};return Ls}var Ms,xo;function Mn(){if(xo)return Ms;xo=1;const n=Symbol("SemVer ANY");class e{static get ANY(){return n}constructor(u,d){if(d=t(d),u instanceof e){if(u.loose===!!d.loose)return u;u=u.value}u=u.trim().split(/\s+/).join(" "),i("comparator",u,d),this.options=d,this.loose=!!d.loose,this.parse(u),this.semver===n?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(u){const d=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],h=u.match(d);if(!h)throw new TypeError(`Invalid comparator: ${u}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=n}toString(){return this.value}test(u){if(i("Comparator.test",u,this.options.loose),this.semver===n||u===n)return!0;if(typeof u=="string")try{u=new o(u,this.options)}catch{return!1}return a(u,this.operator,this.semver,this.options)}intersects(u,d){if(!(u instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new l(u.value,d).test(this.value):u.operator===""?u.value===""?!0:new l(this.value,d).test(u.semver):(d=t(d),d.includePrerelease&&(this.value==="<0.0.0-0"||u.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||u.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&u.operator.startsWith(">")||this.operator.startsWith("<")&&u.operator.startsWith("<")||this.semver.version===u.semver.version&&this.operator.includes("=")&&u.operator.includes("=")||a(this.semver,"<",u.semver,d)&&this.operator.startsWith(">")&&u.operator.startsWith("<")||a(this.semver,">",u.semver,d)&&this.operator.startsWith("<")&&u.operator.startsWith(">")))}}Ms=e;const t=Ga(),{safeRe:r,t:s}=Or(),a=wc(),i=Nn(),o=xe(),l=Ke();return Ms}var js,Io;function jn(){if(Io)return js;Io=1;const n=Ke();return js=(t,r,s)=>{try{r=new n(r,s)}catch{return!1}return r.test(t)},js}var Ds,Ao;function xf(){if(Ao)return Ds;Ao=1;const n=Ke();return Ds=(t,r)=>new n(t,r).set.map(s=>s.map(a=>a.value).join(" ").trim().split(" ")),Ds}var Us,Ro;function If(){if(Ro)return Us;Ro=1;const n=xe(),e=Ke();return Us=(r,s,a)=>{let i=null,o=null,l=null;try{l=new e(s,a)}catch{return null}return r.forEach(c=>{l.test(c)&&(!i||o.compare(c)===-1)&&(i=c,o=new n(i,a))}),i},Us}var Fs,$o;function Af(){if($o)return Fs;$o=1;const n=xe(),e=Ke();return Fs=(r,s,a)=>{let i=null,o=null,l=null;try{l=new e(s,a)}catch{return null}return r.forEach(c=>{l.test(c)&&(!i||o.compare(c)===1)&&(i=c,o=new n(i,a))}),i},Fs}var Bs,Co;function Rf(){if(Co)return Bs;Co=1;const n=xe(),e=Ke(),t=Ln();return Bs=(s,a)=>{s=new e(s,a);let i=new n("0.0.0");if(s.test(i)||(i=new n("0.0.0-0"),s.test(i)))return i;i=null;for(let o=0;o<s.set.length;++o){const l=s.set[o];let c=null;l.forEach(u=>{const d=new n(u.semver.version);switch(u.operator){case">":d.prerelease.length===0?d.patch++:d.prerelease.push(0),d.raw=d.format();case"":case">=":(!c||t(d,c))&&(c=d);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${u.operator}`)}}),c&&(!i||t(i,c))&&(i=c)}return i&&s.test(i)?i:null},Bs}var zs,ko;function $f(){if(ko)return zs;ko=1;const n=Ke();return zs=(t,r)=>{try{return new n(t,r).range||"*"}catch{return null}},zs}var Vs,Oo;function Ka(){if(Oo)return Vs;Oo=1;const n=xe(),e=Mn(),{ANY:t}=e,r=Ke(),s=jn(),a=Ln(),i=Za(),o=Wa(),l=Ja();return Vs=(u,d,h,f)=>{u=new n(u,f),d=new r(d,f);let p,_,g,y,w;switch(h){case">":p=a,_=o,g=i,y=">",w=">=";break;case"<":p=i,_=l,g=a,y="<",w="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(u,d,f))return!1;for(let v=0;v<d.set.length;++v){const E=d.set[v];let b=null,x=null;if(E.forEach(N=>{N.semver===t&&(N=new e(">=0.0.0")),b=b||N,x=x||N,p(N.semver,b.semver,f)?b=N:g(N.semver,x.semver,f)&&(x=N)}),b.operator===y||b.operator===w||(!x.operator||x.operator===y)&&_(u,x.semver))return!1;if(x.operator===w&&g(u,x.semver))return!1}return!0},Vs}var qs,Po;function Cf(){if(Po)return qs;Po=1;const n=Ka();return qs=(t,r,s)=>n(t,r,">",s),qs}var Gs,No;function kf(){if(No)return Gs;No=1;const n=Ka();return Gs=(t,r,s)=>n(t,r,"<",s),Gs}var Hs,Lo;function Of(){if(Lo)return Hs;Lo=1;const n=Ke();return Hs=(t,r,s)=>(t=new n(t,s),r=new n(r,s),t.intersects(r,s)),Hs}var Zs,Mo;function Pf(){if(Mo)return Zs;Mo=1;const n=jn(),e=We();return Zs=(t,r,s)=>{const a=[];let i=null,o=null;const l=t.sort((h,f)=>e(h,f,s));for(const h of l)n(h,r,s)?(o=h,i||(i=h)):(o&&a.push([i,o]),o=null,i=null);i&&a.push([i,null]);const c=[];for(const[h,f]of a)h===f?c.push(h):!f&&h===l[0]?c.push("*"):f?h===l[0]?c.push(`<=${f}`):c.push(`${h} - ${f}`):c.push(`>=${h}`);const u=c.join(" || "),d=typeof r.raw=="string"?r.raw:String(r);return u.length<d.length?u:r},Zs}var Js,jo;function Nf(){if(jo)return Js;jo=1;const n=Ke(),e=Mn(),{ANY:t}=e,r=jn(),s=We(),a=(d,h,f={})=>{if(d===h)return!0;d=new n(d,f),h=new n(h,f);let p=!1;e:for(const _ of d.set){for(const g of h.set){const y=l(_,g,f);if(p=p||y!==null,y)continue e}if(p)return!1}return!0},i=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],l=(d,h,f)=>{if(d===h)return!0;if(d.length===1&&d[0].semver===t){if(h.length===1&&h[0].semver===t)return!0;f.includePrerelease?d=i:d=o}if(h.length===1&&h[0].semver===t){if(f.includePrerelease)return!0;h=o}const p=new Set;let _,g;for(const I of d)I.operator===">"||I.operator===">="?_=c(_,I,f):I.operator==="<"||I.operator==="<="?g=u(g,I,f):p.add(I.semver);if(p.size>1)return null;let y;if(_&&g){if(y=s(_.semver,g.semver,f),y>0)return null;if(y===0&&(_.operator!==">="||g.operator!=="<="))return null}for(const I of p){if(_&&!r(I,String(_),f)||g&&!r(I,String(g),f))return null;for(const le of h)if(!r(I,String(le),f))return!1;return!0}let w,v,E,b,x=g&&!f.includePrerelease&&g.semver.prerelease.length?g.semver:!1,N=_&&!f.includePrerelease&&_.semver.prerelease.length?_.semver:!1;x&&x.prerelease.length===1&&g.operator==="<"&&x.prerelease[0]===0&&(x=!1);for(const I of h){if(b=b||I.operator===">"||I.operator===">=",E=E||I.operator==="<"||I.operator==="<=",_){if(N&&I.semver.prerelease&&I.semver.prerelease.length&&I.semver.major===N.major&&I.semver.minor===N.minor&&I.semver.patch===N.patch&&(N=!1),I.operator===">"||I.operator===">="){if(w=c(_,I,f),w===I&&w!==_)return!1}else if(_.operator===">="&&!r(_.semver,String(I),f))return!1}if(g){if(x&&I.semver.prerelease&&I.semver.prerelease.length&&I.semver.major===x.major&&I.semver.minor===x.minor&&I.semver.patch===x.patch&&(x=!1),I.operator==="<"||I.operator==="<="){if(v=u(g,I,f),v===I&&v!==g)return!1}else if(g.operator==="<="&&!r(g.semver,String(I),f))return!1}if(!I.operator&&(g||_)&&y!==0)return!1}return!(_&&E&&!g&&y!==0||g&&b&&!_&&y!==0||N||x)},c=(d,h,f)=>{if(!d)return h;const p=s(d.semver,h.semver,f);return p>0?d:p<0||h.operator===">"&&d.operator===">="?h:d},u=(d,h,f)=>{if(!d)return h;const p=s(d.semver,h.semver,f);return p<0?d:p>0||h.operator==="<"&&d.operator==="<="?h:d};return Js=a,Js}var Ws,Do;function Lf(){if(Do)return Ws;Do=1;const n=Or(),e=Pn(),t=xe(),r=gc(),s=tr(),a=df(),i=hf(),o=ff(),l=pf(),c=mf(),u=yf(),d=gf(),h=_f(),f=We(),p=vf(),_=wf(),g=Ha(),y=bf(),w=Ef(),v=Ln(),E=Za(),b=_c(),x=vc(),N=Ja(),I=Wa(),le=wc(),ve=Sf(),Pe=Mn(),Fe=Ke(),Ut=jn(),$=xf(),A=If(),z=Af(),j=Rf(),V=$f(),D=Ka(),H=Cf(),ee=kf(),X=Of(),oe=Pf(),_e=Nf();return Ws={parse:s,valid:a,clean:i,inc:o,diff:l,major:c,minor:u,patch:d,prerelease:h,compare:f,rcompare:p,compareLoose:_,compareBuild:g,sort:y,rsort:w,gt:v,lt:E,eq:b,neq:x,gte:N,lte:I,cmp:le,coerce:ve,Comparator:Pe,Range:Fe,satisfies:Ut,toComparators:$,maxSatisfying:A,minSatisfying:z,minVersion:j,validRange:V,outside:D,gtr:H,ltr:ee,intersects:X,simplifyRange:oe,subset:_e,SemVer:t,re:n.re,src:n.src,tokens:n.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:r.compareIdentifiers,rcompareIdentifiers:r.rcompareIdentifiers},Ws}Lf();function dt(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);const[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){const[s,a]=e.split("/",2);if(!s||!a)throw new Error(`Invalid identifier format: ${n}`);return[s,a,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}class Mf extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function U(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}if(n.status===403)try{const i=await n.json();(i==null?void 0:i.error)==="org_scoped_key_requires_workspace"&&(r="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${n.status} ${n.statusText}`);throw o.status=n==null?void 0:n.status,o}if(r===void 0)try{r=await n.text()}catch{r=""}const s=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Message: ${r}`;if(n.status===409)throw new Mf(s);const a=new Error(s);throw a.status=n.status,a}const bc="ERR_CONFLICTING_ENDPOINTS";class jf extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:bc}),this.name="ConflictingEndpointsError"}}function Df(n){return typeof n=="object"&&n!==null&&n.code===bc}var Uo="[...]",Uf={result:"[Circular]"},cn=[],zt=[];const Ff=new TextEncoder;function Bf(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function Jr(n){return Ff.encode(n)}function Ec(n){if(n&&typeof n=="object"&&n!==null){if(n instanceof Map)return Object.fromEntries(n);if(n instanceof Set)return Array.from(n);if(n instanceof Date)return n.toISOString();if(n instanceof RegExp)return n.toString();if(n instanceof Error)return{name:n.name,message:n.message}}else if(typeof n=="bigint")return n.toString();return n}function zf(n){return function(e,t){return Ec(t)}}function Ne(n,e,t,r,s){var a;try{const i=JSON.stringify(n,zf(t),r);return Jr(i)}catch(i){if(!((a=i.message)!=null&&a.includes("Converting circular structure to JSON")))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),Jr("[Unserializable]");Ce("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=Bf()),da(n,"",0,[],void 0,0,s);let o;try{zt.length===0?o=JSON.stringify(n,t,r):o=JSON.stringify(n,Vf(t),r)}catch{return Jr("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;cn.length!==0;){const l=cn.pop();l.length===4?Object.defineProperty(l[0],l[1],l[3]):l[0][l[1]]=l[2]}}return Jr(o)}}function Ks(n,e,t,r){var s=Object.getOwnPropertyDescriptor(r,t);s.get!==void 0?s.configurable?(Object.defineProperty(r,t,{value:n}),cn.push([r,t,e,s])):zt.push([e,t,n]):(r[t]=n,cn.push([r,t,e]))}function da(n,e,t,r,s,a,i){a+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){Ks(Uf,n,e,s);return}if(typeof i.depthLimit<"u"&&a>i.depthLimit){Ks(Uo,n,e,s);return}if(typeof i.edgesLimit<"u"&&t+1>i.edgesLimit){Ks(Uo,n,e,s);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)da(n[o],o,o,r,n,a,i);else{n=Ec(n);var l=Object.keys(n);for(o=0;o<l.length;o++){var c=l[o];da(n[c],c,o,r,n,a,i)}}r.pop()}}function Vf(n){return n=typeof n<"u"?n:function(e,t){return t},function(e,t){if(zt.length>0)for(var r=0;r<zt.length;r++){var s=zt[r];if(s[1]===e&&s[0]===t){t=s[2],zt.splice(r,1);break}}return n.call(this,e,t)}}function Fo(n,e){const t=fc(),r=e??pc(),s=n.extra??{},a=s.metadata;return n.extra={...s,runtime:{...t,...s==null?void 0:s.runtime},metadata:{...r,...r.revision_id||"revision_id"in n&&n.revision_id?{revision_id:("revision_id"in n?n.revision_id:void 0)??r.revision_id}:{},...a}},n}const qf=n=>{const e=(n==null?void 0:n.toString())??Ce("TRACING_SAMPLING_RATE");if(e===void 0)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t},Gf=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function Hf(n){const e=[];for await(const t of n)e.push(t);return e}function Wr(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Zf=async n=>{if((n==null?void 0:n.status)===429){const e=parseInt(n.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};function Bo(n){return typeof n=="number"?Number(n.toFixed(4)):n}class Jf{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise(a=>{t=a}),s=Ne(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:r,size:s}),this.sizeBytes+=s,r}pop({upToSizeBytes:e,upToSize:t}){var a;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const r=[];let s=0;for(;s+(((a=this.peek())==null?void 0:a.size)??0)<e&&this.items.length>0&&r.length<t;){const i=this.items.shift();i&&(r.push(i),s+=i.size,this.sizeBytes-=i.size)}if(r.length===0&&this.items.length>0){const i=this.items.shift();r.push(i),s+=i.size,this.sizeBytes-=i.size}return[r.map(i=>({action:i.action,item:i.payload,otelContext:i.otelContext,apiKey:i.apiKey,apiUrl:i.apiUrl})),()=>r.forEach(i=>i.itemPromiseResolve())]}}const Wf=24*1024*1024,Kf=1e4,Yf=100,zo="https://api.smith.langchain.com";class wr{get _fetch(){return this.fetchImplementation||Oh(this.debug)}constructor(e={}){var r;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Jf}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:rt("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:rt("LANGSMITH_DEBUG")==="true"});const t=wr.getDefaultClientConfig();if(this.tracingSampleRate=qf(e.tracingSamplingRate),this.apiUrl=Wr(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Wr(e.apiKey??t.apiKey),this.webUrl=Wr(e.webUrl??t.webUrl),(r=this.webUrl)!=null&&r.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=Wr(e.workspaceId??Ce("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Vi({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new Vi({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:Zf,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,mc()&&(this.langSmithToOTELTranslator=new Wh),this.cachedLSEnvVarsForMetadata=pc()}static getDefaultClientConfig(){const e=Ce("API_KEY"),t=Ce("ENDPOINT")??zo,r=Ce("HIDE_INPUTS")==="true",s=Ce("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:Gf(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${uc}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=await this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",s=`${this.apiUrl}${e}?${r}`;return await this.caller.call(async()=>{const i=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(i,`fetch ${e}`),i})}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let s=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(s)),t.set("limit",String(a));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(async()=>{const c=await this._fetch(i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(c,`fetch ${e}`),c}),l=r?r(await o.json()):await o.json();if(l.length===0||(yield l,l.length<a))break;s+=l.length}}async*_getCursorPaginatedList(e,t=null,r="POST",s="runs"){const a=t?{...t}:{};for(;;){const i=JSON.stringify(a),l=await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(u,`fetch ${e}`),u})).json();if(!l||!l[s])break;yield l[s];const c=l.cursors;if(!c||!c.next)break;a.cursor=c.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):r.push(s);return r}else{const r=[];for(const s of e){const a=s.trace_id??s.id;this.filteredPostUuids.has(a)||(s.id===a?this._shouldSample()?r.push(s):this.filteredPostUuids.add(a):r.push(s))}return r}}async _getBatchSizeLimitBytes(){var t;const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??((t=e.batch_ingest_config)==null?void 0:t.size_limit_bytes)??Wf}async _getBatchSizeLimit(){var t;const e=await this._ensureServerInfo();return this.batchSizeLimit??((t=e.batch_ingest_config)==null?void 0:t.size_limit)??Yf}async _getDatasetExamplesMultiPartSupport(){var t;return((t=(await this._ensureServerInfo()).instance_flags)==null?void 0:t.dataset_examples_multipart_enabled)??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t}){const r=[];for(;this.autoBatchQueue.items.length>0;){const[s,a]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:t});if(!s.length){a();break}const i=s.reduce((c,u)=>{const d=u.apiUrl??this.apiUrl,h=u.apiKey??this.apiKey,p=u.apiKey===this.apiKey&&u.apiUrl===this.apiUrl?"default":`${d}|${h}`;return c[p]||(c[p]=[]),c[p].push(u),c},{}),o=[];for(const[c,u]of Object.entries(i)){const d=this._processBatch(u,{apiUrl:c==="default"?void 0:c.split("|")[0],apiKey:c==="default"?void 0:c.split("|")[1]});o.push(d)}const l=Promise.all(o).finally(a);r.push(l)}return Promise.all(r)}async _processBatch(e,t){var r,s;if(e.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{const a={runCreates:e.filter(o=>o.action==="create").map(o=>o.item),runUpdates:e.filter(o=>o.action==="update").map(o=>o.item)},i=await this._ensureServerInfo();if((r=i==null?void 0:i.batch_ingest_config)!=null&&r.use_multipart_endpoint){const o=(s=i==null?void 0:i.instance_flags)==null?void 0:s.gzip_body_enabled;await this.multipartIngestRuns(a,{...t,useGzip:o})}else await this.batchIngestRuns(a,t)}}catch(a){console.error("Error exporting batch:",a)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){const t=new Map,r=[];for(const s of e)s.item.id&&s.otelContext&&(t.set(s.item.id,s.otelContext),s.action==="create"?r.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):r.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(r,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=Fo(e.item,this.cachedLSEnvVarsForMetadata);const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const r=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>r||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const t=await(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(Kf),...this.fetchOptions});return await U(r,"get server info"),r})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(t,null,2)+`
`),t}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),t=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t})}_cloneCurrentOTELContext(){const e=yc(),t=Gh();if(this.langSmithToOTELTranslator!==void 0){const r=e.getActiveSpan();if(r)return e.setSpan(t.active(),r)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;const r={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;const a=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){const l=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:a,otelContext:l,apiKey:t==null?void 0:t.apiKey,apiUrl:t==null?void 0:t.apiUrl}).catch(console.error);return}const i=Fo(a,this.cachedLSEnvVarsForMetadata);(t==null?void 0:t.apiKey)!==void 0&&(r["x-api-key"]=t.apiKey),(t==null?void 0:t.workspaceId)!==void 0&&(r["x-tenant-id"]=t.workspaceId);const o=Ne(i,`Creating run with id: ${i.id}`);await this.caller.call(async()=>{const l=await this._fetch(`${(t==null?void 0:t.apiUrl)??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await U(l,"create run",!0),l})}async batchIngestRuns({runCreates:e,runUpdates:t},r){if(e===void 0&&t===void 0)return;let s=await Promise.all((e==null?void 0:e.map(l=>this.prepareRunCreateOrUpdateInputs(l)))??[]),a=await Promise.all((t==null?void 0:t.map(l=>this.prepareRunCreateOrUpdateInputs(l)))??[]);if(s.length>0&&a.length>0){const l=s.reduce((u,d)=>(d.id&&(u[d.id]=d),u),{}),c=[];for(const u of a)u.id!==void 0&&l[u.id]?l[u.id]={...l[u.id],...u}:c.push(u);s=Object.values(l),a=c}const i={post:s,patch:a};if(!i.post.length&&!i.patch.length)return;const o={post:[],patch:[]};for(const l of["post","patch"]){const c=l,u=i[c].reverse();let d=u.pop();for(;d!==void 0;)o[c].push(d),d=u.pop()}if(o.post.length>0||o.patch.length>0){const l=o.post.map(c=>c.id).concat(o.patch.map(c=>c.id)).join(",");await this._postBatchIngestRuns(Ne(o,`Ingesting runs with ids: ${l}`),r)}}async _postBatchIngestRuns(e,t){const r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};(t==null?void 0:t.apiKey)!==void 0&&(r["x-api-key"]=t.apiKey),await this.batchIngestCaller.call(async()=>{const s=await this._fetch(`${(t==null?void 0:t.apiUrl)??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await U(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:t},r){if(e===void 0&&t===void 0)return;const s={};let a=[];for(const d of e??[]){const h=await this.prepareRunCreateOrUpdateInputs(d);h.id!==void 0&&h.attachments!==void 0&&(s[h.id]=h.attachments),delete h.attachments,a.push(h)}let i=[];for(const d of t??[])i.push(await this.prepareRunCreateOrUpdateInputs(d));if(a.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(i.find(d=>d.trace_id===void 0||d.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&i.length>0){const d=a.reduce((f,p)=>(p.id&&(f[p.id]=p),f),{}),h=[];for(const f of i)f.id!==void 0&&d[f.id]?d[f.id]={...d[f.id],...f}:h.push(f);a=Object.values(d),i=h}if(a.length===0&&i.length===0)return;const c=[],u=[];for(const[d,h]of[["post",a],["patch",i]])for(const f of h){const{inputs:p,outputs:_,events:g,extra:y,error:w,serialized:v,attachments:E,...b}=f,x={inputs:p,outputs:_,events:g,extra:y,error:w,serialized:v},N=Ne(b,`Serializing for multipart ingestion of run with id: ${b.id}`);u.push({name:`${d}.${b.id}`,payload:new Blob([N],{type:`application/json; length=${N.length}`})});for(const[I,le]of Object.entries(x)){if(le===void 0)continue;const ve=Ne(le,`Serializing ${I} for multipart ingestion of run with id: ${b.id}`);u.push({name:`${d}.${b.id}.${I}`,payload:new Blob([ve],{type:`application/json; length=${ve.length}`})})}if(b.id!==void 0){const I=s[b.id];if(I){delete s[b.id];for(const[le,ve]of Object.entries(I)){let Pe,Fe;if(Array.isArray(ve)?[Pe,Fe]=ve:(Pe=ve.mimeType,Fe=ve.data),le.includes(".")){console.warn(`Skipping attachment '${le}' for run ${b.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}u.push({name:`attachment.${b.id}.${le}`,payload:new Blob([Fe],{type:`${Pe}; length=${Fe.byteLength}`})})}}}c.push(`trace=${b.trace_id},id=${b.id}`)}await this._sendMultipartRequest(u,c.join("; "),r)}async _createNodeFetchBody(e,t){const r=[];for(const i of e)r.push(new Blob([`--${t}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${i.name}"\r
`,`Content-Type: ${i.payload.type}\r
\r
`])),r.push(i.payload),r.push(new Blob([`\r
`]));return r.push(new Blob([`--${t}--\r
`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(e,t){const r=new TextEncoder;return new ReadableStream({async start(a){const i=async o=>{typeof o=="string"?a.enqueue(r.encode(o)):a.enqueue(o)};for(const o of e){await i(`--${t}\r
`),await i(`Content-Disposition: form-data; name="${o.name}"\r
`),await i(`Content-Type: ${o.payload.type}\r
\r
`);const c=o.payload.stream().getReader();try{let u;for(;!(u=await c.read()).done;)a.enqueue(u.value)}finally{c.releaseLock()}await i(`\r
`)}await i(`--${t}--\r
`),a.close()}})}async _sendMultipartRequest(e,t,r){const s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=kh(),i=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),l=async c=>this.batchIngestCaller.call(async()=>{const u=await c(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};(r==null?void 0:r.apiKey)!==void 0&&(d["x-api-key"]=r.apiKey);let h=u;r!=null&&r.useGzip&&typeof u=="object"&&"pipeThrough"in u&&(h=u.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");const f=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:h,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(f,"Failed to send multipart request",!0),f});try{let c,u=!1;!a&&!this.multipartStreamingDisabled&&hc()!=="bun"?(u=!0,c=await l(o)):c=await l(i),(!this.multipartStreamingDisabled||u)&&c.status===422&&((r==null?void 0:r.apiUrl)??this.apiUrl)!==zo&&(console.warn(`Streaming multipart upload to ${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,c=await l(i))}catch(c){console.warn(`${c.message.trim()}

Context: ${t}`)}}async updateRun(e,t,r){Y(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const s={...t,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(t.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:r==null?void 0:r.apiKey,apiUrl:r==null?void 0:r.apiUrl}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"};(r==null?void 0:r.apiKey)!==void 0&&(a["x-api-key"]=r.apiKey),(r==null?void 0:r.workspaceId)!==void 0&&(a["x-tenant-id"]=r.workspaceId);const i=Ne(t,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const o=await this._fetch(`${(r==null?void 0:r.apiUrl)??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(o,"update run",!0),o})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Y(e);let r=await this._get(`/runs/${e}`);return t&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let s;t.session_id?s=t.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:Ce("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){var a;const t=await Hf(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},s={};t.sort((i,o)=>((i==null?void 0:i.dotted_order)??"").localeCompare((o==null?void 0:o.dotted_order)??""));for(const i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);(a=i.dotted_order)!=null&&a.startsWith(e.dotted_order??"")&&i.id!==e.id&&(i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),s[i.id]=i)}e.child_runs=r[e.id]||[];for(const i in r)i!==e.id&&(s[i].child_runs=r[i]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:s,traceId:a,referenceExampleId:i,startTime:o,executionOrder:l,isRoot:c,runType:u,error:d,id:h,query:f,filter:p,traceFilter:_,treeFilter:g,limit:y,select:w,order:v}=e;let E=[];if(t&&(E=Array.isArray(t)?t:[t]),r){const I=Array.isArray(r)?r:[r],le=await Promise.all(I.map(ve=>this.readProject({projectName:ve}).then(Pe=>Pe.id)));E.push(...le)}const b=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],x={session:E.length?E:null,run_type:u,reference_example:i,query:f,filter:p,trace_filter:_,tree_filter:g,execution_order:l,parent_run:s,start_time:o?o.toISOString():null,error:d,id:h,limit:y,trace:a,select:w||b,is_root:c,order:v};x.select.includes("child_run_ids")&&ua("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let N=0;for await(const I of this._getCursorPaginatedList("/runs/query",x))if(y){if(N>=y)break;if(I.length+N>y){yield*I.slice(0,y-N);break}N+=I.length,yield*I}else yield*I}async*listGroupRuns(e){const{projectId:t,projectName:r,groupBy:s,filter:a,startTime:i,endTime:o,limit:l,offset:c}=e,d={session_id:t||(await this.readProject({projectName:r})).id,group_by:s,filter:a,start_time:i?i.toISOString():null,end_time:o?o.toISOString():null,limit:Number(l)||100};let h=Number(c)||0;const f="/runs/group",p=`${this.apiUrl}${f}`;for(;;){const _={...d,offset:h},g=Object.fromEntries(Object.entries(_).filter(([x,N])=>N!==void 0)),y=JSON.stringify(g),v=await(await this.caller.call(async()=>{const x=await this._fetch(p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:y});return await U(x,`Failed to fetch ${f}`),x})).json(),{groups:E,total:b}=v;if(E.length===0)break;for(const x of E)yield x;if(h+=E.length,h>=b)break}}async getRunStats({id:e,trace:t,parentRun:r,runType:s,projectNames:a,projectIds:i,referenceExampleIds:o,startTime:l,endTime:c,error:u,query:d,filter:h,traceFilter:f,treeFilter:p,isRoot:_,dataSourceType:g}){let y=i||[];a&&(y=[...i||[],...await Promise.all(a.map(N=>this.readProject({projectName:N}).then(I=>I.id)))]);const v=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:s,session:y,reference_example:o,start_time:l,end_time:c,error:u,query:d,filter:h,trace_filter:f,tree_filter:p,is_root:_,data_source_type:g}).filter(([N,I])=>I!==void 0)),E=JSON.stringify(v);return await(await this.caller.call(async()=>{const N=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:E});return await U(N,"get run stats"),N})).json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||Te()};Y(e);const s=JSON.stringify(r),i=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await U(o,"share run"),o})).json();if(i===null||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){Y(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(t,"unshare run",!0),t})}async readRunSharedLink(e){Y(e);const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,"read run shared link"),s})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)r.append("id",i);return Y(e),await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(i,"list shared runs"),i})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Y(e);const s=await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(a,"read dataset shared schema"),a})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};Y(e);const s=JSON.stringify(r),i=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await U(o,"share dataset"),o})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){Y(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(t,"unshare dataset",!0),t})}async readSharedDataset(e){return Y(e),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,"read shared dataset"),s})).json()}async listSharedExamples(e,t){const r={};t!=null&&t.exampleIds&&(r.id=t.exampleIds);const s=new URLSearchParams;Object.entries(r).forEach(([o,l])=>{Array.isArray(l)?l.forEach(c=>s.append(o,c)):s.append(o,l)});const a=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(o,"list shared examples"),o}),i=await a.json();if(!a.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${Array.isArray(i.detail)?i.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:s=!1,projectExtra:a=null,referenceDatasetId:i=null}){const o=s?"?upsert=true":"",l=`${this.apiUrl}/sessions${o}`,c=a||{};r&&(c.metadata=r);const u={name:e,extra:c,description:t};i!==null&&(u.reference_dataset_id=i);const d=JSON.stringify(u);return await(await this.caller.call(async()=>{const p=await this._fetch(l,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await U(p,"create project"),p})).json()}async updateProject(e,{name:t=null,description:r=null,metadata:s=null,projectExtra:a=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let l=a;s&&(l={...l||{},metadata:s});const c=JSON.stringify({name:t,extra:l,description:r,end_time:i?new Date(i).toISOString():null});return await(await this.caller.call(async()=>{const h=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await U(h,"update project"),h})).json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(i,"has project"),i});try{const i=await a.json();return a.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let s="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),s+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&a.append("include_stats",r.toString());const i=await this._get(s,a);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:s,referenceDatasetName:a,includeStats:i,datasetVersion:o,referenceFree:l,metadata:c}={}){const u=new URLSearchParams;if(e!==void 0)for(const d of e)u.append("id",d);if(t!==void 0&&u.append("name",t),r!==void 0&&u.append("name_contains",r),s!==void 0)u.append("reference_dataset",s);else if(a!==void 0){const d=await this.readDataset({datasetName:a});u.append("reference_dataset",d.id)}i!==void 0&&u.append("include_stats",i.toString()),o!==void 0&&u.append("dataset_version",o),l!==void 0&&u.append("reference_free",l.toString()),c!==void 0&&u.append("metadata",JSON.stringify(c));for await(const d of this._getPaginated("/sessions",u))yield*d}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,Y(r),await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,`delete session ${r} (${t})`,!0),s})}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:s,description:a,dataType:i,name:o}){const l=`${this.apiUrl}/datasets/upload`,c=new FormData;return c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),s.forEach(h=>{c.append("output_keys",h)}),a&&c.append("description",a),i&&c.append("data_type",i),o&&c.append("name",o),await(await this.caller.call(async()=>{const h=await this._fetch(l,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await U(h,"upload CSV"),h})).json()}async createDataset(e,{description:t,dataType:r,inputsSchema:s,outputsSchema:a,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),s&&(o.inputs_schema_definition=s),a&&(o.outputs_schema_definition=a);const l=JSON.stringify(o);return await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await U(d,"create dataset"),d})).json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)Y(e),r+=`/${e}`;else if(t)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(r,s);let i;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:s}){let a=e;if(a===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:s,datasetNameContains:a,metadata:i}={}){const o="/datasets",l=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const c of r)l.append("id",c);s!==void 0&&l.append("name",s),a!==void 0&&l.append("name_contains",a),i!==void 0&&l.append("metadata",JSON.stringify(i));for await(const c of this._getPaginated(o,l))yield*c}async updateDataset(e){const{datasetId:t,datasetName:r,...s}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:r})).id;Y(a);const i=JSON.stringify(s);return await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(l,"update dataset"),l})).json()}async updateDatasetTag(e){const{datasetId:t,datasetName:r,asOf:s,tag:a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:r})).id;Y(i);const o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:a});await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await U(l,"update dataset tags",!0),l})}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)Y(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const a=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(a,`delete ${r}`,!0),a})}async indexDataset({datasetId:e,datasetName:t,tag:r}){let s=e;if(!s&&!t)throw new Error("Must provide either datasetName or datasetId");if(s&&t)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:t})).id),Y(s);const i=JSON.stringify({tag:r});await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(l,"index dataset"),l})).json()}async similarExamples(e,t,r,{filter:s}={}){const a={limit:r,inputs:e};s!==void 0&&(a.filter=s),Y(t);const i=JSON.stringify(a);return(await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:i});return await U(c,"fetch similar examples"),c})).json()).examples}async createExample(e,t,r){var u;if(Vo(e)&&(t!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=t?r==null?void 0:r.datasetId:e.dataset_id;const a=t?r==null?void 0:r.datasetName:e.dataset_name;if(s===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:a})).id);const i=(t?r==null?void 0:r.createdAt:e.created_at)||new Date;let o;Vo(e)?o=e:o={inputs:e,outputs:t,created_at:i==null?void 0:i.toISOString(),id:r==null?void 0:r.exampleId,metadata:r==null?void 0:r.metadata,split:r==null?void 0:r.split,source_run_id:r==null?void 0:r.sourceRunId,use_source_run_io:r==null?void 0:r.useSourceRunIO,use_source_run_attachments:r==null?void 0:r.useSourceRunAttachments,attachments:r==null?void 0:r.attachments};const l=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(((u=l.example_ids)==null?void 0:u[0])??Te())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const w=e;let v=w[0].dataset_id;const E=w[0].dataset_name;if(v===void 0&&E===void 0)throw new Error("Must provide either datasetName or datasetId");if(v!==void 0&&E!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");v===void 0&&(v=(await this.readDataset({datasetName:E})).id);const b=await this._uploadExamplesMultipart(v,w);return await Promise.all(b.example_ids.map(N=>this.readExample(N)))}const{inputs:t,outputs:r,metadata:s,splits:a,sourceRunIds:i,useSourceRunIOs:o,useSourceRunAttachments:l,attachments:c,exampleIds:u,datasetId:d,datasetName:h}=e;if(t===void 0)throw new Error("Must provide inputs when using legacy parameters");let f=d;const p=h;if(f===void 0&&p===void 0)throw new Error("Must provide either datasetName or datasetId");if(f!==void 0&&p!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");f===void 0&&(f=(await this.readDataset({datasetName:p})).id);const _=t.map((w,v)=>({dataset_id:f,inputs:w,outputs:r==null?void 0:r[v],metadata:s==null?void 0:s[v],split:a==null?void 0:a[v],id:u==null?void 0:u[v],attachments:c==null?void 0:c[v],source_run_id:i==null?void 0:i[v],use_source_run_io:o==null?void 0:o[v],use_source_run_attachments:l==null?void 0:l[v]})),g=await this._uploadExamplesMultipart(f,_);return await Promise.all(g.example_ids.map(w=>this.readExample(w)))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const s=e.map(i=>qi(i)?Gi(i):i),a=qi(t)?Gi(t):t;return this.createExample({input:s},{output:a},r)}async readExample(e){Y(e);const t=`/examples/${e}`,r=await this._get(t),{attachment_urls:s,...a}=r,i=a;return s&&(i.attachments=Object.entries(s).reduce((o,[l,c])=>(o[l.slice(11)]={presigned_url:c.presigned_url,mime_type:c.mime_type},o),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:s,splits:a,inlineS3Urls:i,metadata:o,limit:l,offset:c,filter:u,includeAttachments:d}={}){let h;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(t!==void 0)h=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const f=new URLSearchParams({dataset:h}),p=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;p&&f.append("as_of",p);const _=i??!0;if(f.append("inline_s3_urls",_.toString()),r!==void 0)for(const y of r)f.append("id",y);if(a!==void 0)for(const y of a)f.append("splits",y);if(o!==void 0){const y=JSON.stringify(o);f.append("metadata",y)}l!==void 0&&f.append("limit",l.toString()),c!==void 0&&f.append("offset",c.toString()),u!==void 0&&f.append("filter",u),d===!0&&["attachment_urls","outputs","metadata"].forEach(y=>f.append("select",y));let g=0;for await(const y of this._getPaginated("/examples",f)){for(const w of y){const{attachment_urls:v,...E}=w,b=E;v&&(b.attachments=Object.entries(v).reduce((x,[N,I])=>(x[N.slice(11)]={presigned_url:I.presigned_url,mime_type:I.mime_type||void 0},x),{})),yield b,g++}if(l!==void 0&&g>=l)break}}async deleteExample(e){Y(e);const t=`/examples/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(r,`delete ${t}`,!0),r})}async updateExample(e,t){let r;t?r=e:r=e.id,Y(r);let s;t?s={id:r,...t}:s=e;let a;return s.dataset_id!==void 0?a=s.dataset_id:a=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(a,[s])}async updateExamples(e){let t;return e[0].dataset_id===void 0?t=(await this.readExample(e[0].id)).dataset_id:t=e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:s}){let a;if(e?a=e:a=(await this.readDataset({datasetName:t})).id,Y(a),r&&s||!r&&!s)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;return r!==void 0&&i.append("as_of",typeof r=="string"?r:r.toISOString()),s!==void 0&&i.append("tag",s),await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/datasets/${a}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(l,"read dataset version"),l})).json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let s;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:t})).id:s=e,Y(s);const a=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&a.append("as_of",i),await this._get(`/datasets/${s}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:s,remove:a=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,Y(i);const o={split_name:r,examples:s.map(c=>(Y(c),c)),remove:a},l=JSON.stringify(o);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await U(c,"update dataset splits",!0),c})}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:s,referenceExample:a}={loadChildRuns:!1}){ua("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,a),[l,c]=await this._logEvaluationFeedback(o,i,r);return c[0]}async createFeedback(e,t,{score:r,value:s,correction:a,comment:i,sourceInfo:o,feedbackSourceType:l="api",sourceRunId:c,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){var w;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const p={type:l??"api",metadata:o??{}};c!==void 0&&(p==null?void 0:p.metadata)!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:c}),(p==null?void 0:p.metadata)!==void 0&&((w=p.metadata.__run)==null?void 0:w.run_id)!==void 0&&Y(p.metadata.__run.run_id);const _={id:u??Te(),run_id:e,key:t,score:Bo(r),value:s,correction:a,comment:i,feedback_source:p,comparative_experiment_id:f,feedbackConfig:d,session_id:h},g=JSON.stringify(_),y=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const v=await this._fetch(y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:g});return await U(v,"create feedback",!0),v}),_}async updateFeedback(e,{score:t,value:r,correction:s,comment:a}){const i={};t!=null&&(i.score=Bo(t)),r!=null&&(i.value=r),s!=null&&(i.correction=s),a!=null&&(i.comment=a),Y(e);const o=JSON.stringify(i);await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await U(l,"update feedback",!0),l})}async readFeedback(e){Y(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Y(e);const t=`/feedback/${e}`;await this.caller.call(async()=>{const r=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(r,`delete ${t}`,!0),r})}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e)for(const a of e)Y(a),s.append("run",a);if(t)for(const a of t)s.append("key",a);if(r)for(const a of r)s.append("source",a);for await(const a of this._getPaginated("/feedback",s))yield*a}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:s}={}){const a={run_id:e,feedback_key:t,feedback_config:s};r?typeof r=="string"?a.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(a.expires_in=r):a.expires_in={hours:3};const i=JSON.stringify(a);return await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(l,"create presigned feedback token"),l})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:s,description:a,metadata:i,id:o}){var d;if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const l={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:a,created_at:(d=s??new Date)==null?void 0:d.toISOString(),extra:{}};i&&(l.extra.metadata=i);const c=JSON.stringify(l);return(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await U(h,"create comparative experiment"),h})).json()}async*listPresignedFeedbackTokens(e){Y(e);const t=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:Array.isArray(e)?t=e:t=[e],t}async _logEvaluationFeedback(e,t,r){const s=this._selectEvalResults(e),a=[];for(const i of s){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let l=null;i.targetRunId?l=i.targetRunId:t&&(l=t.id),a.push(await this.createFeedback(l,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[s,a]}async logEvaluationFeedback(e,t,r){const[s]=await this._logEvaluationFeedback(e,t,r);return s}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:s,limit:a}=e,i=new URLSearchParams;t&&t.forEach((l,c)=>{Y(l,`queueIds[${c}]`),i.append("ids",l)}),r&&i.append("name",r),s&&i.append("name_contains",s),i.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(const l of this._getPaginated("/annotation-queues",i))if(yield*l,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:s,rubricInstructions:a}=e,i={name:t,description:r,id:s||Te(),rubric_instructions:a},o=JSON.stringify(Object.fromEntries(Object.entries(i).filter(([c,u])=>u!==void 0)));return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await U(c,"create annotation queue"),c})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(r,"read annotation queue"),r})).json()}async updateAnnotationQueue(e,t){const{name:r,description:s,rubricInstructions:a}=t,i=JSON.stringify({name:r,description:s,rubric_instructions:a});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){const r=JSON.stringify(t.map((s,a)=>Y(s,`runIds[${a}]`).toString()));await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await U(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${Y(e,"queueId")}/run`;return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(a,"get run from annotation queue"),a})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/runs/${Y(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(r,"get size from annotation queue"),r})).json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const r=await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,"get latest commit hash"),s})).json();if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,s,a]=dt(e),i=JSON.stringify({like:t});return(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/likes/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(l,`${t?"like":"unlike"} prompt`),l})).json()}async _getPromptUrl(e){const[t,r,s]=dt(e);if(await this._currentTenantIsOwner(t)){const a=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${r}/${s.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${a.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",(e==null?void 0:e.sortField)??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&t.append("is_public",e.isPublic.toString()),e!=null&&e.query&&t.append("query",e.query);for await(const r of this._getPaginated("/repos",t,s=>s.repos))yield*r}async getPrompt(e){const[t,r,s]=dt(e),a=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return(o==null?void 0:o.status)===404?null:(await U(o,"get prompt"),o)}),i=await(a==null?void 0:a.json());return i!=null&&i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t!=null&&t.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[s,a,i]=dt(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);const o={repo_handle:a,...(t==null?void 0:t.description)&&{description:t.description},...(t==null?void 0:t.readme)&&{readme:t.readme},...(t==null?void 0:t.tags)&&{tags:t.tags},is_public:!!(t!=null&&t.isPublic)},l=JSON.stringify(o),c=await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await U(d,"create prompt"),d}),{repo:u}=await c.json();return u}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[s,a,i]=dt(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${s}/${a}`):r==null?void 0:r.parentCommitHash,l={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=JSON.stringify(l),d=await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/commits/${s}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await U(h,"create commit"),h})).json();return this._getPromptUrl(`${s}/${a}${d.commit_hash?`:${d.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){var i;if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const o of t){const l=o.id,c={...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},u=Ne(c,`Serializing body for example with id: ${l}`),d=new Blob([u],{type:"application/json"});if(r.append(l,d),o.inputs){const h=Ne(o.inputs,`Serializing inputs for example with id: ${l}`),f=new Blob([h],{type:"application/json"});r.append(`${l}.inputs`,f)}if(o.outputs){const h=Ne(o.outputs,`Serializing outputs whle updating example with id: ${l}`),f=new Blob([h],{type:"application/json"});r.append(`${l}.outputs`,f)}if(o.attachments)for(const[h,f]of Object.entries(o.attachments)){let p,_;Array.isArray(f)?[p,_]=f:(p=f.mimeType,_=f.data);const g=new Blob([_],{type:`${p}; length=${_.byteLength}`});r.append(`${l}.attachment.${h}`,g)}if(o.attachments_operations){const h=Ne(o.attachments_operations,`Serializing attachments while updating example with id: ${l}`),f=new Blob([h],{type:"application/json"});r.append(`${l}.attachments_operations`,f)}}const s=e??((i=t[0])==null?void 0:i.dataset_id);return(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await U(o,"update examples"),o})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const a of t){const i=(a.id??Te()).toString(),o={created_at:a.created_at,...a.metadata&&{metadata:a.metadata},...a.split&&{split:a.split},...a.source_run_id&&{source_run_id:a.source_run_id},...a.use_source_run_io&&{use_source_run_io:a.use_source_run_io},...a.use_source_run_attachments&&{use_source_run_attachments:a.use_source_run_attachments}},l=Ne(o,`Serializing body for uploaded example with id: ${i}`),c=new Blob([l],{type:"application/json"});if(r.append(i,c),a.inputs){const u=Ne(a.inputs,`Serializing inputs for uploaded example with id: ${i}`),d=new Blob([u],{type:"application/json"});r.append(`${i}.inputs`,d)}if(a.outputs){const u=Ne(a.outputs,`Serializing outputs for uploaded example with id: ${i}`),d=new Blob([u],{type:"application/json"});r.append(`${i}.outputs`,d)}if(a.attachments)for(const[u,d]of Object.entries(a.attachments)){let h,f;Array.isArray(d)?[h,f]=d:(h=d.mimeType,f=d.data);const p=new Blob([f],{type:`${h}; length=${f.byteLength}`});r.append(`${i}.attachment.${u}`,p)}}return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await U(a,"upload examples"),a})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s]=dt(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if((t==null?void 0:t.description)!==void 0&&(a.description=t.description),(t==null?void 0:t.readme)!==void 0&&(a.readme=t.readme),(t==null?void 0:t.tags)!==void 0&&(a.tags=t.tags),(t==null?void 0:t.isPublic)!==void 0&&(a.is_public=t.isPublic),(t==null?void 0:t.isArchived)!==void 0&&(a.is_archived=t.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const i=JSON.stringify(a);return(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/repos/${r}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await U(l,"update prompt"),l})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,s]=dt(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(i,"delete prompt"),i})).json()}async pullPromptCommit(e,t){const[r,s,a]=dt(e),o=await(await this.caller.call(async()=>{const l=await this._fetch(`${this.apiUrl}/commits/${r}/${s}/${a}${t!=null&&t.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(l,"pull prompt commit"),l})).json();return{owner:r,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t==null?void 0:t.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(s=>s!=="object")&&await this.updatePrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}):await this.createPrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}),t!=null&&t.object?await this.createCommit(e,t==null?void 0:t.object,{parentCommitHash:t==null?void 0:t.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:s}=t,[a,i]=this.parseTokenOrUrl(e,r),o=new wr({apiUrl:a,apiKey:"placeholder"}),l=await o.readSharedDataset(i),c=s||l.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}const u=await o.listSharedExamples(i),d=await this.createDataset(c,{description:l.description,dataType:l.data_type||"kv",inputsSchema:l.inputs_schema_definition??void 0,outputsSchema:l.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map(h=>h.inputs),outputs:u.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),h}}parseTokenOrUrl(e,t,r=2,s="dataset"){try{return Y(e),[t,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){const o=i[i.length-r];return[t,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){var e,t;if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:r})=>r),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await((t=(e=Hh())==null?void 0:e.DEFAULT_LANGSMITH_SPAN_PROCESSOR)==null?void 0:t.forceFlush())}}function Vo(n){return"dataset_id"in n||"dataset_name"in n}const Xf=n=>!!["TRACING_V2","TRACING"].find(t=>Ce(t)==="true"),Ys=Symbol.for("lc:context_variables");function Qf(n){return n.replace(/[-:.]/g,"")}function Sc(n,e,t=1){const r=t.toFixed(0).slice(0,3).padStart(3,"0"),s=`${new Date(n).toISOString().slice(0,-1)}${r}Z`;return{dottedOrder:Qf(s)+e,microsecondPrecisionDatestring:s}}class un{constructor(e,t,r,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=r,this.replicas=s}static fromHeader(e){const t=e.split(",");let r={},s=[],a,i;for(const o of t){const[l,c]=o.split("="),u=decodeURIComponent(c);l==="langsmith-metadata"?r=JSON.parse(u):l==="langsmith-tags"?s=u.split(","):l==="langsmith-project"?a=u:l==="langsmith-replicas"&&(i=JSON.parse(u))}return new un(r,s,a,i)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class $e{constructor(e){var o;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),ep(e)){Object.assign(this,{...e});return}const t=$e.getDefaultConfig(),{metadata:r,...s}=e,a=s.client??$e.getSharedClient(),i={...r,...(o=s==null?void 0:s.extra)==null?void 0:o.metadata};if(s.extra={...s.extra,metadata:i},"id"in s&&s.id==null&&delete s.id,Object.assign(this,{...t,...s,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=ap(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const{dottedOrder:l,microsecondPrecisionDatestring:c}=Sc(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+l:this.dotted_order=l,this._serialized_start_time=c}}set metadata(e){var t;this.extra={...this.extra,metadata:{...(t=this.extra)==null?void 0:t.metadata,...e}}}get metadata(){var e;return(e=this.extra)==null?void 0:e.metadata}static getDefaultConfig(){return{id:Te(),run_type:"chain",project_name:cc(),child_runs:[],api_url:rt("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:rt("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return $e.sharedClient||($e.sharedClient=new wr),$e.sharedClient}createChild(e){var l,c,u,d,h,f;const t=this.child_execution_order+1,r=new $e({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Ys in this&&(r[Ys]=this[Ys]);const s=Symbol.for("lc:child_config"),a=((l=e.extra)==null?void 0:l[s])??this.extra[s];if(rp(a)){const p={...a},_=tp(p.callbacks)?(u=(c=p.callbacks).copy)==null?void 0:u.call(c):void 0;_&&(Object.assign(_,{_parentRunId:r.id}),(f=(h=(d=_.handlers)==null?void 0:d.find(Tc))==null?void 0:h.updateFromRunTree)==null||f.call(h,r),p.callbacks=_),r.extra[s]=p}const i=new Set;let o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,t,r=!0){var o,l;const s=e.extra??{};if(((o=s==null?void 0:s.runtime)==null?void 0:o.library)===void 0&&(s.runtime||(s.runtime={}),t))for(const[c,u]of Object.entries(t))s.runtime[c]||(s.runtime[c]=u);let a,i;return r?(i=((l=e.parent_run)==null?void 0:l.id)??e.parent_run_id,a=[]):(a=e.child_runs.map(c=>this._convertToCreate(c,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,t,r=!0){const s=this._convertToCreate(this,t,r);if(e===this.project_name)return s;const a=d=>Ii(`${d}:${e}`,Ii.DNS),i=a(s.id),o=s.trace_id?a(s.trace_id):void 0,l=s.parent_run_id?a(s.parent_run_id):void 0;let c;if(s.dotted_order){const d=np(s.dotted_order),h=[];for(let p=0;p<d.length-1;p++){const[_,g]=d[p],y=a(g);h.push(_.toISOString().replace(/[-:]/g,"").replace(".","")+y)}const[f]=d[d.length-1];h.push(f.toISOString().replace(/[-:]/g,"").replace(".","")+i),c=h.join(".")}else c=void 0;return{...s,id:i,trace_id:o,parent_run_id:l,dotted_order:c,session_name:e}}async postRun(e=!0){try{const t=fc();if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:a,workspaceId:i}of this.replicas){const o=this._remapForProject(r??this.project_name,t,!0);await this.client.createRun(o,{apiKey:s,apiUrl:a,workspaceId:i})}else{const r=this._convertToCreate(this,t,e);await this.client.createRun(r)}if(!e){ua("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const r of this.child_runs)await r.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(e){var t;if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:s,apiUrl:a,workspaceId:i,updates:o}of this.replicas){const l=this._remapForProject(r??this.project_name),c={id:l.id,outputs:l.outputs,error:l.error,parent_run_id:l.parent_run_id,session_name:l.session_name,reference_example_id:l.reference_example_id,end_time:l.end_time,dotted_order:l.dotted_order,trace_id:l.trace_id,events:l.events,tags:l.tags,extra:l.extra,attachments:this.attachments,...o};e!=null&&e.excludeInputs||(c.inputs=l.inputs),await this.client.updateRun(l.id,c,{apiKey:s,apiUrl:a,workspaceId:i})}else try{const r={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:((t=this.parent_run)==null?void 0:t.id)??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e!=null&&e.excludeInputs||(r.inputs=this.inputs),await this.client.updateRun(this.id,r)}catch(r){console.error(`Error in patchRun for run ${this.id}`,r)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){var c,u,d,h;const r=e==null?void 0:e.callbacks;let s,a,i,o=Xf();if(r){const f=((c=r==null?void 0:r.getParentRunId)==null?void 0:c.call(r))??"",p=(u=r==null?void 0:r.handlers)==null?void 0:u.find(_=>(_==null?void 0:_.name)=="langchain_tracer");s=(d=p==null?void 0:p.getRun)==null?void 0:d.call(p,f),a=p==null?void 0:p.projectName,i=p==null?void 0:p.client,o=o||!!p}return s?new $e({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:i,tracingEnabled:o,project_name:a,tags:[...new Set(((s==null?void 0:s.tags)??[]).concat((e==null?void 0:e.tags)??[]))],extra:{metadata:{...(h=s==null?void 0:s.extra)==null?void 0:h.metadata,...e==null?void 0:e.metadata}}}).createChild(t):new $e({...t,client:i,tracingEnabled:o,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){var c;const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=r["langsmith-trace"];if(!s||typeof s!="string")return;const a=s.trim(),i=a.split(".").map(u=>{const[d,h]=u.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=i[0].uuid,l={...t,name:(t==null?void 0:t.name)??"parent",run_type:(t==null?void 0:t.run_type)??"chain",start_time:(t==null?void 0:t.start_time)??Date.now(),id:(c=i.at(-1))==null?void 0:c.uuid,trace_id:o,dotted_order:a};if(r.baggage&&typeof r.baggage=="string"){const u=un.fromHeader(r.baggage);l.metadata=u.metadata,l.tags=u.tags,l.project_name=u.project_name,l.replicas=u.replicas}return new $e(l)}toHeaders(e){var r;const t={"langsmith-trace":this.dotted_order,baggage:new un((r=this.extra)==null?void 0:r.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[s,a]of Object.entries(t))e.set(s,a);return t}}Object.defineProperty($e,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function ep(n){return n!=null&&typeof n.createChild=="function"&&typeof n.postRun=="function"}function Tc(n){return typeof n=="object"&&n!=null&&typeof n.name=="string"&&n.name==="langchain_tracer"}function qo(n){return Array.isArray(n)&&n.some(e=>Tc(e))}function tp(n){return typeof n=="object"&&n!=null&&Array.isArray(n.handlers)}function rp(n){var e;return n!=null&&typeof n.callbacks=="object"&&(qo((e=n.callbacks)==null?void 0:e.handlers)||qo(n.callbacks))}function np(n){return n.split(".").map(t=>{const r=t.slice(0,-36),s=t.slice(-36),a=parseInt(r.slice(0,4)),i=parseInt(r.slice(4,6))-1,o=parseInt(r.slice(6,8)),l=parseInt(r.slice(9,11)),c=parseInt(r.slice(11,13)),u=parseInt(r.slice(13,15)),d=parseInt(r.slice(15,21));return[new Date(a,i,o,l,c,u,d/1e3),s]})}function sp(){const n=rt("LANGSMITH_RUNS_ENDPOINTS");if(!n)return[];try{const e=JSON.parse(n);if(Array.isArray(e)){const t=[];for(const r of e){if(typeof r!="object"||r===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof r}`);continue}if(typeof r.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_url}`);continue}if(typeof r.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_key}`);continue}t.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key})}return t}else if(typeof e=="object"&&e!==null){ip(e);const t=[];for(const[r,s]of Object.entries(e)){const a=r.replace(/\/$/,"");if(typeof s=="string")t.push({apiUrl:a,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got ${typeof s}`);continue}}return t}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(Df(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function ap(n){return n?n.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):sp()}function ip(n){if(Object.keys(n).length>0&&Ce("ENDPOINT"))throw new jf}var op={};fe(op,{BaseTracer:()=>rr,isBaseTracer:()=>Ft});const lp=n=>{if(n)return n.events=n.events??[],n.child_runs=n.child_runs??[],n};function ha(n,e){if(n)return new $e({...n,start_time:n._serialized_start_time??n.start_time,parent_run:ha(e),child_runs:n.child_runs.map(t=>ha(t)).filter(t=>t!==void 0),extra:{...n.extra,runtime:ac()},tracingEnabled:!1})}function Xs(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function Ft(n){return typeof n._addRunToRunMap=="function"}var rr=class extends kr{constructor(e){super(...arguments);m(this,"runMap",new Map);m(this,"runTreeMap",new Map);m(this,"usesRunTreeMap",!1)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?lp(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:r}=Sc(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},a=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?a&&(this._addChildRun(a,s),a.child_execution_order=Math.max(a.child_execution_order,s.child_execution_order),s.trace_id=a.trace_id,a.dotted_order!==void 0&&(s.dotted_order=[a.dotted_order,t].join("."),s._serialized_start_time=r)):(s.trace_id=s.id,s.dotted_order=t,s._serialized_start_time=r),this.usesRunTreeMap){const i=ha(s,a);i!==void 0&&this.runTreeMap.set(s.id,i)}else this.runMap.set(s.id,s);return s}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await((r=this.onRunUpdate)==null?void 0:r.call(this,e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,s,a,i,o,l){const c=this._getExecutionOrder(s),u=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:l??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,s,a,i,o,l){var u,d;const c=this.getRunById(r)??this._createRunForLLMStart(e,t,r,s,a,i,o,l);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}_createRunForChatModelStart(e,t,r,s,a,i,o,l){const c=this._getExecutionOrder(s),u=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:l??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,s,a,i,o,l){var u,d;const c=this.getRunById(r)??this._createRunForChatModelStart(e,t,r,s,a,i,o,l);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((d=this.onLLMStart)==null?void 0:d.call(this,c)),c}async handleLLMEnd(e,t,r,s,a){var o;const i=this.getRunById(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleLLMError(e,t,r,s,a){var o;const i=this.getRunById(t);if(!i||(i==null?void 0:i.run_type)!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await((o=this.onLLMError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForChainStart(e,t,r,s,a,i,o,l){const c=this._getExecutionOrder(s),u=Date.now(),d={id:r,name:l??e.id[e.id.length-1],parent_run_id:s,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,s,a,i,o,l){var u,d;const c=this.getRunById(r)??this._createRunForChainStart(e,t,r,s,a,i,o,l);return await((u=this.onRunCreate)==null?void 0:u.call(this,c)),await((d=this.onChainStart)==null?void 0:d.call(this,c)),c}async handleChainEnd(e,t,r,s,a){var o;const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Xs(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Xs(a.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,s,a){var o;const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Xs(a.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,t,r,s,a,i,o){const l=this._getExecutionOrder(s),c=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:l,child_execution_order:l,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,r,s,a,i,o){var c,u;const l=this.getRunById(r)??this._createRunForToolStart(e,t,r,s,a,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,l)),await((u=this.onToolStart)==null?void 0:u.call(this,l)),l}async handleToolEnd(e,t){var s;const r=this.getRunById(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var s;const r=this.getRunById(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var a;const r=this.getRunById(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,r))}async handleAgentEnd(e,t){var s;const r=this.getRunById(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}_createRunForRetrieverStart(e,t,r,s,a,i,o){const l=this._getExecutionOrder(s),c=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:l,child_execution_order:l,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,r,s,a,i,o){var c,u;const l=this.getRunById(r)??this._createRunForRetrieverStart(e,t,r,s,a,i,o);return await((c=this.onRunCreate)==null?void 0:c.call(this,l)),await((u=this.onRetrieverStart)==null?void 0:u.call(this,l)),l}async handleRetrieverEnd(e,t){var s;const r=this.getRunById(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var s;const r=this.getRunById(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var s;const r=this.getRunById(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,t,r,s,a,i){var l;const o=this.getRunById(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((l=this.onLLMNewToken)==null?void 0:l.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}},Xr={exports:{}};Xr.exports;var Go;function cp(){return Go||(Go=1,(function(n){const t=(a=0)=>i=>`\x1B[${38+a};5;${i}m`,r=(a=0)=>(i,o,l)=>`\x1B[${38+a};2;${i};${o};${l}m`;function s(){const a=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,l]of Object.entries(i)){for(const[c,u]of Object.entries(l))i[c]={open:`\x1B[${u[0]}m`,close:`\x1B[${u[1]}m`},l[c]=i[c],a.set(u[0],u[1]);Object.defineProperty(i,o,{value:l,enumerable:!1})}return Object.defineProperty(i,"codes",{value:a,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=r(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,l,c)=>o===l&&l===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(l/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const l=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!l)return[0,0,0];let{colorString:c}=l.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const u=Number.parseInt(c,16);return[u>>16&255,u>>8&255,u&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(n,"exports",{enumerable:!0,get:s})})(Xr)),Xr.exports}var up=cp();const xc=In(up);var dp={};fe(dp,{ConsoleCallbackHandler:()=>fa});function Ee(n,e){return`${n.open}${e}${n.close}`}function je(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function Ho(n){return typeof n=="string"?n.trim():n==null?n:je(n,n.toString())}function ht(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:Re}=xc;var fa=class extends rr{constructor(){super(...arguments);m(this,"name","console_callback_handler")}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)t.push(s),r=s;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,a,i)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return a===i.length-1?Ee(xc.bold,o):o}).join(" > ");return Ee(Re.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.green,"[chain/start]")} [${t}] Entering Chain run with input: ${je(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.cyan,"[chain/end]")} [${t}] [${ht(e)}] Exiting Chain run with output: ${je(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.red,"[chain/error]")} [${t}] [${ht(e)}] Chain run errored with error: ${je(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${Ee(Re.green,"[llm/start]")} [${t}] Entering LLM run with input: ${je(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.cyan,"[llm/end]")} [${t}] [${ht(e)}] Exiting LLM run with output: ${je(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.red,"[llm/error]")} [${t}] [${ht(e)}] LLM run errored with error: ${je(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Ho(e.inputs.input)}"`)}onToolEnd(e){var r;const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.cyan,"[tool/end]")} [${t}] [${ht(e)}] Exiting Tool run with output: "${Ho((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.red,"[tool/error]")} [${t}] [${ht(e)}] Tool run errored with error: ${je(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${je(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.cyan,"[retriever/end]")} [${t}] [${ht(e)}] Exiting Retriever run with output: ${je(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Ee(Re.red,"[retriever/error]")} [${t}] [${ht(e)}] Retriever run errored with error: ${je(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${Ee(Re.blue,"[agent/action]")} [${r}] Agent selected action: ${je(t.actions[t.actions.length-1],"[action]")}`)}};let Qs;const Ic=()=>{if(Qs===void 0){const n=At("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Qs=new wr(n)}return Qs};let hp=class{getStore(){}run(e,t){return t()}};const ea=Symbol.for("ls:tracing_async_local_storage"),fp=new hp;let pp=class{getInstance(){return globalThis[ea]??fp}initializeGlobalInstance(e){globalThis[ea]===void 0&&(globalThis[ea]=e)}};const mp=new pp;function yp(n=!1){const e=mp.getInstance().getStore();if(!n&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function Ya(n){return typeof n=="function"&&"langsmith:traceable"in n}var gp={};fe(gp,{LangChainTracer:()=>Qr});var Qr=class Ac extends rr{constructor(t={}){super(t);m(this,"name","langchain_tracer");m(this,"projectName");m(this,"exampleId");m(this,"client");m(this,"replicas");m(this,"usesRunTreeMap",!0);const{exampleId:r,projectName:s,client:a,replicas:i}=t;this.projectName=s??cc(),this.replicas=i,this.exampleId=r,this.client=a??Ic();const o=Ac.getTraceableRunTree();o&&this.updateFromRunTree(o)}async persistRun(t){}async onRunCreate(t){const r=this.getRunTreeWithTracingConfig(t.id);await(r==null?void 0:r.postRun())}async onRunUpdate(t){const r=this.getRunTreeWithTracingConfig(t.id);await(r==null?void 0:r.patchRun())}getRun(t){return this.runTreeMap.get(t)}updateFromRunTree(t){this.runTreeMap.set(t.id,t);let r=t;const s=new Set;for(;r.parent_run&&!(s.has(r.id)||(s.add(r.id),!r.parent_run));)r=r.parent_run;s.clear();const a=[r];for(;a.length>0;){const i=a.shift();!i||s.has(i.id)||(s.add(i.id),this.runTreeMap.set(i.id,i),i.child_runs&&a.push(...i.child_runs))}this.client=t.client??this.client,this.replicas=t.replicas??this.replicas,this.projectName=t.project_name??this.projectName,this.exampleId=t.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(t){const r=this.runTreeMap.get(t);if(r)return new $e({...r,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return yp(!0)}catch{return}}};let Rt;function _p(){const n="default"in at?at.default:at;return new n({autoStart:!0,concurrency:1})}function vp(){return typeof Rt>"u"&&(Rt=_p()),Rt}async function me(n,e){if(e===!0){const t=_r();t!==void 0?await t.run(void 0,async()=>n()):await n()}else Rt=vp(),Rt.add(async()=>{const t=_r();t!==void 0?await t.run(void 0,async()=>n()):await n()})}async function wp(){const n=Ic();await Promise.allSettled([typeof Rt<"u"?Rt.onIdle():Promise.resolve(),n.awaitPendingTraceBatches()])}var bp={};fe(bp,{awaitAllCallbacks:()=>wp,consumeCallback:()=>me});const Ep=n=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>At(t)==="true");function Rc(n){var r;const e=_r();if(e===void 0)return;const t=e.getStore();return(r=t==null?void 0:t[pr])==null?void 0:r[n]}const Sp=Symbol("lc:configure_hooks"),Tp=()=>Rc(Sp)||[];var xp={};fe(xp,{BaseCallbackManager:()=>$c,BaseRunManager:()=>Pr,CallbackManager:()=>jt,CallbackManagerForChainRun:()=>kc,CallbackManagerForLLMRun:()=>pa,CallbackManagerForRetrieverRun:()=>Cc,CallbackManagerForToolRun:()=>Oc,ensureHandler:()=>br,parseCallbackConfigArg:()=>Ip});function Ip(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}var $c=class{setHandler(n){return this.setHandlers([n])}},Pr=class{constructor(n,e,t,r,s,a,i,o){this.runId=n,this.handlers=e,this.inheritableHandlers=t,this.tags=r,this.inheritableTags=s,this.metadata=a,this.inheritableMetadata=i,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(n){await Promise.all(this.handlers.map(e=>me(async()=>{var t;try{await((t=e.handleText)==null?void 0:t.call(e,n,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleText: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleCustomEvent(n,e,t,r,s){await Promise.all(this.handlers.map(a=>me(async()=>{var i;try{await((i=a.handleCustomEvent)==null?void 0:i.call(a,n,e,this.runId,this.tags,this.metadata))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}},Cc=class extends Pr{getChild(n){const e=new jt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),n&&e.addTags([n],!1),e}async handleRetrieverEnd(n){await Promise.all(this.handlers.map(e=>me(async()=>{var t;if(!e.ignoreRetriever)try{await((t=e.handleRetrieverEnd)==null?void 0:t.call(e,n,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetriever`),e.raiseError)throw r}},e.awaitHandlers)))}async handleRetrieverError(n){await Promise.all(this.handlers.map(e=>me(async()=>{var t;if(!e.ignoreRetriever)try{await((t=e.handleRetrieverError)==null?void 0:t.call(e,n,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleRetrieverError: ${r}`),e.raiseError)throw n}},e.awaitHandlers)))}},pa=class extends Pr{async handleLLMNewToken(n,e,t,r,s,a){await Promise.all(this.handlers.map(i=>me(async()=>{var o;if(!i.ignoreLLM)try{await((o=i.handleLLMNewToken)==null?void 0:o.call(i,n,e??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(l){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMNewToken: ${l}`),i.raiseError)throw l}},i.awaitHandlers)))}async handleLLMError(n,e,t,r,s){await Promise.all(this.handlers.map(a=>me(async()=>{var i;if(!a.ignoreLLM)try{await((i=a.handleLLMError)==null?void 0:i.call(a,n,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleLLMEnd(n,e,t,r,s){await Promise.all(this.handlers.map(a=>me(async()=>{var i;if(!a.ignoreLLM)try{await((i=a.handleLLMEnd)==null?void 0:i.call(a,n,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}},kc=class extends Pr{getChild(n){const e=new jt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),n&&e.addTags([n],!1),e}async handleChainError(n,e,t,r,s){await Promise.all(this.handlers.map(a=>me(async()=>{var i;if(!a.ignoreChain)try{await((i=a.handleChainError)==null?void 0:i.call(a,n,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleChainEnd(n,e,t,r,s){await Promise.all(this.handlers.map(a=>me(async()=>{var i;if(!a.ignoreChain)try{await((i=a.handleChainEnd)==null?void 0:i.call(a,n,this.runId,this._parentRunId,this.tags,s))}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleAgentAction(n){await Promise.all(this.handlers.map(e=>me(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleAgentAction)==null?void 0:t.call(e,n,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentAction: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleAgentEnd(n){await Promise.all(this.handlers.map(e=>me(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleAgentEnd)==null?void 0:t.call(e,n,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleAgentEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},Oc=class extends Pr{getChild(n){const e=new jt(this.runId);return e.setHandlers(this.inheritableHandlers),e.addTags(this.inheritableTags),e.addMetadata(this.inheritableMetadata),n&&e.addTags([n],!1),e}async handleToolError(n){await Promise.all(this.handlers.map(e=>me(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleToolError)==null?void 0:t.call(e,n,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolError: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}async handleToolEnd(n){await Promise.all(this.handlers.map(e=>me(async()=>{var t;if(!e.ignoreAgent)try{await((t=e.handleToolEnd)==null?void 0:t.call(e,n,this.runId,this._parentRunId,this.tags))}catch(r){if((e.raiseError?console.error:console.warn)(`Error in handler ${e.constructor.name}, handleToolEnd: ${r}`),e.raiseError)throw r}},e.awaitHandlers)))}},jt=class cr extends $c{constructor(t,r){super();m(this,"handlers",[]);m(this,"inheritableHandlers",[]);m(this,"tags",[]);m(this,"inheritableTags",[]);m(this,"metadata",{});m(this,"inheritableMetadata",{});m(this,"name","callback_manager");m(this,"_parentRunId");this.handlers=(r==null?void 0:r.handlers)??this.handlers,this.inheritableHandlers=(r==null?void 0:r.inheritableHandlers)??this.inheritableHandlers,this.tags=(r==null?void 0:r.tags)??this.tags,this.inheritableTags=(r==null?void 0:r.inheritableTags)??this.inheritableTags,this.metadata=(r==null?void 0:r.metadata)??this.metadata,this.inheritableMetadata=(r==null?void 0:r.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=t}getParentRunId(){return this._parentRunId}async handleLLMStart(t,r,s=void 0,a=void 0,i=void 0,o=void 0,l=void 0,c=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&s?s:Te();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return Ft(f)&&f._createRunForLLMStart(t,[u],h,this._parentRunId,i,this.tags,this.metadata,c),me(async()=>{var p;try{await((p=f.handleLLMStart)==null?void 0:p.call(f,t,[u],h,this._parentRunId,i,this.tags,this.metadata,c))}catch(_){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${_}`),f.raiseError)throw _}},f.awaitHandlers)})),new pa(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(t,r,s=void 0,a=void 0,i=void 0,o=void 0,l=void 0,c=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&s?s:Te();return await Promise.all(this.handlers.map(f=>{if(!f.ignoreLLM)return Ft(f)&&f._createRunForChatModelStart(t,[u],h,this._parentRunId,i,this.tags,this.metadata,c),me(async()=>{var p,_;try{if(f.handleChatModelStart)await((p=f.handleChatModelStart)==null?void 0:p.call(f,t,[u],h,this._parentRunId,i,this.tags,this.metadata,c));else if(f.handleLLMStart){const g=Va(u);await((_=f.handleLLMStart)==null?void 0:_.call(f,t,[g],h,this._parentRunId,i,this.tags,this.metadata,c))}}catch(g){if((f.raiseError?console.error:console.warn)(`Error in handler ${f.constructor.name}, handleLLMStart: ${g}`),f.raiseError)throw g}},f.awaitHandlers)})),new pa(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(t,r,s=Te(),a=void 0,i=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreChain)return Ft(c)&&c._createRunForChainStart(t,r,s,this._parentRunId,this.tags,this.metadata,a,l),me(async()=>{var u;try{await((u=c.handleChainStart)==null?void 0:u.call(c,t,r,s,this._parentRunId,this.tags,this.metadata,a,l))}catch(d){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleChainStart: ${d}`),c.raiseError)throw d}},c.awaitHandlers)})),new kc(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(t,r,s=Te(),a=void 0,i=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreAgent)return Ft(c)&&c._createRunForToolStart(t,r,s,this._parentRunId,this.tags,this.metadata,l),me(async()=>{var u;try{await((u=c.handleToolStart)==null?void 0:u.call(c,t,r,s,this._parentRunId,this.tags,this.metadata,l))}catch(d){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleToolStart: ${d}`),c.raiseError)throw d}},c.awaitHandlers)})),new Oc(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(t,r,s=Te(),a=void 0,i=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreRetriever)return Ft(c)&&c._createRunForRetrieverStart(t,r,s,this._parentRunId,this.tags,this.metadata,l),me(async()=>{var u;try{await((u=c.handleRetrieverStart)==null?void 0:u.call(c,t,r,s,this._parentRunId,this.tags,this.metadata,l))}catch(d){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${d}`),c.raiseError)throw d}},c.awaitHandlers)})),new Cc(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(t,r,s,a,i){await Promise.all(this.handlers.map(o=>me(async()=>{var l;if(!o.ignoreCustomEvent)try{await((l=o.handleCustomEvent)==null?void 0:l.call(o,t,r,s,this.tags,this.metadata))}catch(c){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleCustomEvent: ${c}`),o.raiseError)throw c}},o.awaitHandlers)))}addHandler(t,r=!0){this.handlers.push(t),r&&this.inheritableHandlers.push(t)}removeHandler(t){this.handlers=this.handlers.filter(r=>r!==t),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==t)}setHandlers(t,r=!0){this.handlers=[],this.inheritableHandlers=[];for(const s of t)this.addHandler(s,r)}addTags(t,r=!0){this.removeTags(t),this.tags.push(...t),r&&this.inheritableTags.push(...t)}removeTags(t){this.tags=this.tags.filter(r=>!t.includes(r)),this.inheritableTags=this.inheritableTags.filter(r=>!t.includes(r))}addMetadata(t,r=!0){this.metadata={...this.metadata,...t},r&&(this.inheritableMetadata={...this.inheritableMetadata,...t})}removeMetadata(t){for(const r of Object.keys(t))delete this.metadata[r],delete this.inheritableMetadata[r]}copy(t=[],r=!0){const s=new cr(this._parentRunId);for(const a of this.handlers){const i=this.inheritableHandlers.includes(a);s.addHandler(a,i)}for(const a of this.tags){const i=this.inheritableTags.includes(a);s.addTags([a],i)}for(const a of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(a);s.addMetadata({[a]:this.metadata[a]},i)}for(const a of t)s.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===a.name)||s.addHandler(a,r);return s}static fromHandlers(t){class r extends kr{constructor(){super();m(this,"name",Te());Object.assign(this,t)}}const s=new this;return s.addHandler(new r),s}static configure(t,r,s,a,i,o,l){return this._configureSync(t,r,s,a,i,o,l)}static _configureSync(t,r,s,a,i,o,l){var f;let c;(t||r)&&(Array.isArray(t)||!t?(c=new cr,c.setHandlers((t==null?void 0:t.map(br))??[],!0)):c=t,c=c.copy(Array.isArray(r)?r.map(br):r==null?void 0:r.handlers,!1));const u=At("LANGCHAIN_VERBOSE")==="true"||(l==null?void 0:l.verbose),d=((f=Qr.getTraceableRunTree())==null?void 0:f.tracingEnabled)||Ep(),h=d||(At("LANGCHAIN_TRACING")??!1);if(u||h){if(c||(c=new cr),u&&!c.handlers.some(p=>p.name===fa.prototype.name)){const p=new fa;c.addHandler(p,!0)}if(h&&!c.handlers.some(p=>p.name==="langchain_tracer")&&d){const p=new Qr;c.addHandler(p,!0)}if(d){const p=Qr.getTraceableRunTree();if(p&&c._parentRunId===void 0){c._parentRunId=p.id;const _=c.handlers.find(g=>g.name==="langchain_tracer");_==null||_.updateFromRunTree(p)}}}for(const{contextVar:p,inheritable:_=!0,handlerClass:g,envVar:y}of Tp()){const w=y&&At(y)==="true"&&g;let v;const E=p!==void 0?Rc(p):void 0;E&&oc(E)?v=E:w&&(v=new g({})),v!==void 0&&(c||(c=new cr),c.handlers.some(b=>b.name===v.name)||c.addHandler(v,_))}return(s||a)&&c&&(c.addTags(s??[]),c.addTags(a??[],!1)),(i||o)&&c&&(c.addMetadata(i??{}),c.addMetadata(o??{},!1)),c}};function br(n){return"name"in n?n:kr.fromMethods(n)}var Pc=class{getStore(){}run(n,e){return e()}enterWith(n){}};const Ap=new Pc,Zo=Symbol.for("lc:child_config");var Rp=class{getInstance(){return _r()??Ap}getRunnableConfig(){var e,t;return(t=(e=this.getInstance().getStore())==null?void 0:e.extra)==null?void 0:t[Zo]}runWithConfig(n,e,t){var c;const r=jt._configureSync(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata),s=this.getInstance(),a=s.getStore(),i=r==null?void 0:r.getParentRunId(),o=(c=r==null?void 0:r.handlers)==null?void 0:c.find(u=>(u==null?void 0:u.name)==="langchain_tracer");let l;return o&&i?l=o.getRunTreeWithTracingConfig(i):t||(l=new $e({name:"<runnable_lambda>",tracingEnabled:!1})),l&&(l.extra={...l.extra,[Zo]:n}),a!==void 0&&a[pr]!==void 0&&(l===void 0&&(l={}),l[pr]=a[pr]),s.run(l,e)}initializeGlobalInstance(n){_r()===void 0&&Zu(n)}};const lt=new Rp;var $p={};fe($p,{AsyncLocalStorageProviderSingleton:()=>lt,MockAsyncLocalStorage:()=>Pc,_CONTEXT_VARIABLES_KEY:()=>pr});const ta=25;async function Le(n){return jt._configureSync(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function ma(...n){const e={};for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){const s=e[r]??[];e[r]=[...new Set(s.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(r==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(r==="callbacks"){const s=e.callbacks,a=t.callbacks;if(Array.isArray(a))if(!s)e.callbacks=a;else if(Array.isArray(s))e.callbacks=s.concat(a);else{const i=s.copy();for(const o of a)i.addHandler(br(o),!0);e.callbacks=i}else if(a)if(!s)e.callbacks=a;else if(Array.isArray(s)){const i=a.copy();for(const o of s)i.addHandler(br(o),!0);e.callbacks=i}else e.callbacks=new jt(a._parentRunId,{handlers:s.handlers.concat(a.handlers),inheritableHandlers:s.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(a.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(a.inheritableTags))),metadata:{...s.metadata,...a.metadata}})}else{const s=r;e[s]=t[s]??e[s]}return e}const Cp=new Set(["string","number","boolean"]);function ne(n){var r;const e=lt.getRunnableConfig();let t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:s,runName:a,...i}=e;t=Object.entries(i).reduce((o,[l,c])=>(c!==void 0&&(o[l]=c),o),t)}if(n&&(t=Object.entries(n).reduce((s,[a,i])=>(i!==void 0&&(s[a]=i),s),t)),t!=null&&t.configurable)for(const s of Object.keys(t.configurable))Cp.has(typeof t.configurable[s])&&!((r=t.metadata)!=null&&r[s])&&(t.metadata||(t.metadata={}),t.metadata[s]=t.configurable[s]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");const s=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,s])):t.signal=s,delete t.timeout}return t}function ue(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:s,configurable:a,runId:i}={}){const o=ne(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),s!==void 0&&(o.runName=s),a!==void 0&&(o.configurable={...o.configurable,...a}),i!==void 0&&delete o.runId,o}function Ct(n){return n?{configurable:n.configurable,recursionLimit:n.recursionLimit,callbacks:n.callbacks,tags:n.tags,metadata:n.metadata,maxConcurrency:n.maxConcurrency,timeout:n.timeout,signal:n.signal}:void 0}async function bt(n,e){if(e===void 0)return n;let t;return Promise.race([n.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,s)=>{t=()=>{s(dn(e))},e.addEventListener("abort",t),e.aborted&&s(dn(e))})]).finally(()=>e.removeEventListener("abort",t))}function dn(n){return(n==null?void 0:n.reason)instanceof Error?n.reason:typeof(n==null?void 0:n.reason)=="string"?new Error(n.reason):new Error("Aborted")}var kp={};fe(kp,{AsyncGeneratorWithSetup:()=>Dt,IterableReadableStream:()=>Je,atee:()=>Xa,concat:()=>Zt,pipeGeneratorWithSetup:()=>Nc});var Je=class ya extends ReadableStream{constructor(){super(...arguments);m(this,"reader")}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const t=await this.reader.read();return t.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:t.value}}catch(t){throw this.reader.releaseLock(),t}}async return(){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}return{done:!0,value:void 0}}async throw(t){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}throw t}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(t){const r=t.getReader();return new ya({start(s){return a();function a(){return r.read().then(({done:i,value:o})=>{if(i){s.close();return}return s.enqueue(o),a()})}},cancel(){r.releaseLock()}})}static fromAsyncGenerator(t){return new ya({async pull(r){const{value:s,done:a}=await t.next();a&&r.close(),r.enqueue(s)},async cancel(r){await t.return(r)}})}};function Xa(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){const a=await n.next();for(const i of t)i.push(a)}else{if(s[0].done)return;yield s.shift().value}})}function Zt(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,s]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Zt(t[r],s):t[r]=s;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var Dt=class{constructor(n){m(this,"generator");m(this,"setup");m(this,"config");m(this,"signal");m(this,"firstResult");m(this,"firstResultUsed",!1);var e;this.generator=n.generator,this.config=n.config,this.signal=n.signal??((e=this.config)==null?void 0:e.signal),this.setup=new Promise((t,r)=>{lt.runWithConfig(Ct(n.config),async()=>{this.firstResult=n.generator.next(),n.startSetup?this.firstResult.then(n.startSetup).then(t,r):this.firstResult.then(s=>t(void 0),r)},!0)})}async next(...n){var e;return(e=this.signal)==null||e.throwIfAborted(),this.firstResultUsed?lt.runWithConfig(Ct(this.config),this.signal?async()=>bt(this.generator.next(...n),this.signal):async()=>this.generator.next(...n),!0):(this.firstResultUsed=!0,this.firstResult)}async return(n){return this.generator.return(n)}async throw(n){return this.generator.throw(n)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function Nc(n,e,t,r,...s){const a=new Dt({generator:e,startSetup:t,signal:r}),i=await a.setup;return{output:n(a,i,...s),setup:i}}/*!
* https://github.com/Starcounter-Jack/JSON-Patch
* (c) 2017-2022 Joachim Wester
* MIT licensed
*/const Op=Object.prototype.hasOwnProperty;function Pp(n,e){return Op.call(n,e)}function Np(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Pp(n,t)&&e.push(t);return e}function kt(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function ga(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Lp(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function _a(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(_a(n[t]))return!0}else if(typeof n=="object"){const t=Np(n),r=t.length;for(var e=0;e<r;e++)if(_a(n[t[e]]))return!0}}return!1}function Jo(n,e){const t=[n];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&t.push(`${r}: ${s}`)}return t.join(`
`)}var Mp=class extends Error{constructor(n,e,t,r,s){super(Jo(n,{name:e,index:t,operation:r,tree:s})),this.name=e,this.index=t,this.operation=r,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=Jo(n,{name:e,index:t,operation:r,tree:s})}},Lc={};fe(Lc,{JsonPatchError:()=>de,_areEquals:()=>Sr,applyOperation:()=>$t,applyPatch:()=>Er,applyReducer:()=>Up,deepClone:()=>jp,getValueByPointer:()=>hn,validate:()=>Mc,validator:()=>fn});const de=Mp,jp=kt,Vt={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=hn(t,this.path);r&&(r=kt(r));const s=$t(t,{op:"remove",path:this.from}).removed;return $t(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=hn(t,this.from);return $t(t,{op:"add",path:this.path,value:kt(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Sr(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var Dp={add:function(n,e,t){return ga(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Vt.move,copy:Vt.copy,test:Vt.test,_get:Vt._get};function hn(n,e){if(e=="")return n;var t={op:"_get",path:e};return $t(n,t),t.value}function $t(n,e,t=!1,r=!0,s=!0,a=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):fn(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=hn(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=Sr(n,e.value),i.test===!1)throw new de("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new de("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,n);return i}}else{r||(n=kt(n));const o=(e.path||"").split("/");let l=n,c=1,u=o.length,d,h,f;for(typeof t=="function"?f=t:f=fn;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=Lp(h)),s&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(l[h]===void 0?d=o.slice(0,c).join("/"):c==u-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),c++,Array.isArray(l)){if(h==="-")h=l.length;else{if(t&&!ga(h))throw new de("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,n);ga(h)&&(h=~~h)}if(c>=u){if(t&&e.op==="add"&&h>l.length)throw new de("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,n);const p=Dp[e.op].call(e,l,h,n);if(p.test===!1)throw new de("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return p}}else if(c>=u){const p=Vt[e.op].call(e,l,h,n);if(p.test===!1)throw new de("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return p}if(l=l[h],t&&c<u&&(!l||typeof l!="object"))throw new de("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,n)}}}function Er(n,e,t,r=!0,s=!0){if(t&&!Array.isArray(e))throw new de("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=kt(n));const a=new Array(e.length);for(let i=0,o=e.length;i<o;i++)a[i]=$t(n,e[i],t,!0,s,i),n=a[i].newDocument;return a.newDocument=n,a}function Up(n,e,t){const r=$t(n,e);if(r.test===!1)throw new de("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function fn(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new de("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Vt[n.op]){if(typeof n.path!="string")throw new de("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new de('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new de("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new de("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&_a(n.value))throw new de("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var s=n.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new de("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new de("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=Mc([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new de("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new de("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Mc(n,e,t){try{if(!Array.isArray(n))throw new de("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Er(kt(e),kt(n),t||!0);else{t=t||fn;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(s){if(s instanceof de)return s;throw s}}function Sr(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),s,a,i;if(t&&r){if(a=n.length,a!=e.length)return!1;for(s=a;s--!==0;)if(!Sr(n[s],e[s]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(a=o.length,a!==Object.keys(e).length)return!1;for(s=a;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=a;s--!==0;)if(i=o[s],!Sr(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}({...Lc});var Fp={};fe(Fp,{LogStreamCallbackHandler:()=>wa,RunLog:()=>Qa,RunLogPatch:()=>st,isLogStreamHandler:()=>jc});var st=class{constructor(n){m(this,"ops");this.ops=n.ops??[]}concat(n){const e=this.ops.concat(n.ops),t=Er({},e);return new Qa({ops:e,state:t[t.length-1].newDocument})}},Qa=class va extends st{constructor(t){super(t);m(this,"state");this.state=t.state}concat(t){const r=this.ops.concat(t.ops),s=Er(this.state,t.ops);return new va({ops:r,state:s[s.length-1].newDocument})}static fromRunLogPatch(t){const r=Er({},t.ops);return new va({ops:t.ops,state:r[r.length-1].newDocument})}};const jc=n=>n.name==="log_stream_tracer";async function Wo(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function Ko(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function Bp(n){return n!==void 0&&n.message!==void 0}var wa=class extends rr{constructor(e){super({_awaitHandler:!0,...e});m(this,"autoClose",!0);m(this,"includeNames");m(this,"includeTypes");m(this,"includeTags");m(this,"excludeNames");m(this,"excludeTypes");m(this,"excludeTags");m(this,"_schemaFormat","original");m(this,"rootId");m(this,"keyMapByRunId",{});m(this,"counterMapByRunName",{});m(this,"transformStream");m(this,"writer");m(this,"receiveStream");m(this,"name","log_stream_tracer");m(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(e==null?void 0:e._schemaFormat)??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Je.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const s=this.keyMapByRunId[e];s&&await this.writer.write(new st({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new st({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Wo(e,this._schemaFormat)),await this.writer.write(new st({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Wo(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await Ko(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const s=new st({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){const t=new st({ops:[{op:"replace",path:"/final_output",value:await Ko(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const s=this.keyMapByRunId[e.id];if(s===void 0)return;const a=e.inputs.messages!==void 0;let i;a?Bp(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new er({id:`run-${e.id}`,content:t}):i=t;const o=new st({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:i}]});await this.writer.write(o)}},zp={};fe(zp,{ChatGenerationChunk:()=>qp,GenerationChunk:()=>pn,RUN_KEY:()=>Vp});const Vp="__run";var pn=class Dc{constructor(e){m(this,"text");m(this,"generationInfo");this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Dc({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},qp=class Uc extends pn{constructor(t){super(t);m(this,"message");this.message=t.message}concat(t){return new Uc({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo},message:this.message.concat(t.message)})}};function Kr({name:n,serialized:e}){return n!==void 0?n:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}const Gp=n=>n.name==="event_stream_tracer";var Hp=class extends rr{constructor(e){super({_awaitHandler:!0,...e});m(this,"autoClose",!0);m(this,"includeNames");m(this,"includeTypes");m(this,"includeTags");m(this,"excludeNames");m(this,"excludeTypes");m(this,"excludeTags");m(this,"runInfoMap",new Map);m(this,"tappedPromises",new Map);m(this,"transformStream");m(this,"writer");m(this,"receiveStream");m(this,"name","event_stream_tracer");m(this,"lc_prefer_streaming",!0);this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Je.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const s=this.runInfoMap.get(e);if(s===void 0){yield r.value;return}function a(o,l){return o==="llm"&&typeof l=="string"?new pn({text:l}):l}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(l=>{o=l}),this.tappedPromises.set(e,i);try{const l={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...l,data:{chunk:a(s.runType,r.value)}},s),yield r.value;for await(const c of t)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...l,data:{chunk:a(s.runType,c)}},s),yield c}finally{o==null||o()}}else{yield r.value;for await(const o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){var i,o;const t=Kr(e),r=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,s);const a=`on_${r}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onLLMNewToken(e,t,r){const s=this.runInfoMap.get(e.id);let a,i;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")i="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?a=new er({content:t,id:`run-${e.id}`}):a=r.chunk.message;else if(s.runType==="llm")i="on_llm_stream",(r==null?void 0:r.chunk)===void 0?a=new pn({text:t}):a=r.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:i,data:{chunk:a},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){var i,o,l;const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const s=(i=e.outputs)==null?void 0:i.generations;let a;if(t.runType==="chat_model"){for(const c of s??[]){if(a!==void 0)break;a=(o=c[0])==null?void 0:o.message}r="on_chat_model_end"}else if(t.runType==="llm")a={generations:s==null?void 0:s.map(c=>c.map(u=>({text:u.text,generationInfo:u.generationInfo}))),llmOutput:((l=e.outputs)==null?void 0:l.llmOutput)??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){var i,o;const t=Kr(e),r=e.run_type??"chain",s={tags:e.tags??[],metadata:((i=e.extra)==null?void 0:i.metadata)??{},name:t,runType:e.run_type};let a={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(a={},s.inputs={}):e.inputs.input!==void 0?(a.input=e.inputs.input,s.inputs=e.inputs.input):(a.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${r}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:((o=e.extra)==null?void 0:o.metadata)??{}},s)}async onChainEnd(e){var o;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,s=e.inputs??t.inputs??{},i={output:((o=e.outputs)==null?void 0:o.output)??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(i.input=s.input,t.inputs=s.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){var s,a;const t=Kr(e),r={tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{}},r)}async onToolEnd(e){var s;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=((s=e.outputs)==null?void 0:s.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){var a,i;const t=Kr(e),s={tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:((i=e.extra)==null?void 0:i.metadata)??{}},s)}async onRetrieverEnd(e){var r;const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:((r=e.outputs)==null?void 0:r.documents)??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const s=this.runInfoMap.get(r);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:s.tags,metadata:s.metadata,data:t},s)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}},Zp={};fe(Zp,{AsyncCaller:()=>Fc});const Jp=[400,401,402,403,404,405,406,407,409],Wp=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&Jp.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}};var Fc=class{constructor(n){m(this,"maxConcurrency");m(this,"maxRetries");m(this,"onFailedAttempt");m(this,"queue");this.maxConcurrency=n.maxConcurrency??1/0,this.maxRetries=n.maxRetries??6,this.onFailedAttempt=n.onFailedAttempt??Wp;const e="default"in at?at.default:at;this.queue=new e({concurrency:this.maxConcurrency})}call(n,...e){return this.queue.add(()=>ln(()=>n(...e).catch(t=>{throw t instanceof Error?t:new Error(t)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(n,e,...t){if(n.signal){let r;return Promise.race([this.call(e,...t),new Promise((s,a)=>{var i;r=()=>{a(dn(n.signal))},(i=n.signal)==null||i.addEventListener("abort",r)})]).finally(()=>{n.signal&&r&&n.signal.removeEventListener("abort",r)})}return this.call(e,...t)}fetch(...n){return this.call(()=>fetch(...n).then(e=>e.ok?e:Promise.reject(e)))}},Bc=class extends rr{constructor({config:e,onStart:t,onEnd:r,onError:s}){super({_awaitHandler:!0});m(this,"name","RootListenersTracer");m(this,"rootId");m(this,"config");m(this,"argOnStart");m(this,"argOnEnd");m(this,"argOnError");this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function ei(n){return n?n.lc_runnable:!1}var Kp=class{constructor(n){m(this,"includeNames");m(this,"includeTypes");m(this,"includeTags");m(this,"excludeNames");m(this,"excludeTypes");m(this,"excludeTags");this.includeNames=n.includeNames,this.includeTypes=n.includeTypes,this.includeTags=n.includeTags,this.excludeNames=n.excludeNames,this.excludeTypes=n.excludeTypes,this.excludeTags=n.excludeTags}includeEvent(n,e){let t=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const r=n.tags??[];return this.includeNames!==void 0&&(t=t||this.includeNames.includes(n.name)),this.includeTypes!==void 0&&(t=t||this.includeTypes.includes(e)),this.includeTags!==void 0&&(t=t||r.some(s=>{var a;return(a=this.includeTags)==null?void 0:a.includes(s)})),this.excludeNames!==void 0&&(t=t&&!this.excludeNames.includes(n.name)),this.excludeTypes!==void 0&&(t=t&&!this.excludeTypes.includes(e)),this.excludeTags!==void 0&&(t=t&&r.every(s=>{var a;return!((a=this.excludeTags)!=null&&a.includes(s))})),t}};function Dn(n,e,t){function r(o,l){var c;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(c=o._zod).traits??(c.traits=new Set),o._zod.traits.add(n),e(o,l);for(const u in i.prototype)u in o||Object.defineProperty(o,u,{value:i.prototype[u].bind(o)});o._zod.constr=i,o._zod.def=l}const s=(t==null?void 0:t.Parent)??Object;class a extends s{}Object.defineProperty(a,"name",{value:n});function i(o){var l;const c=t!=null&&t.Parent?new a:this;r(c,o),(l=c._zod).deferred??(l.deferred=[]);for(const u of c._zod.deferred)u();return c}return Object.defineProperty(i,"init",{value:r}),Object.defineProperty(i,Symbol.hasInstance,{value:o=>{var l,c;return t!=null&&t.Parent&&o instanceof t.Parent?!0:(c=(l=o==null?void 0:o._zod)==null?void 0:l.traits)==null?void 0:c.has(n)}}),Object.defineProperty(i,"name",{value:n}),i}class ba extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const Yp={};function ti(n){return Yp}function Xp(n){const e=Object.values(n).filter(r=>typeof r=="number");return Object.entries(n).filter(([r,s])=>e.indexOf(+r)===-1).map(([r,s])=>s)}function Qp(n,e){return typeof e=="bigint"?e.toString():e}const em=Error.captureStackTrace?Error.captureStackTrace:(...n)=>{};function mn(n,e,t){const r=new n._zod.constr(e??n._zod.def);return(!e||t!=null&&t.parent)&&(r._zod.parent=n),r}function tm(n){return{}}function ra(n,e=0){var t;for(let r=e;r<n.issues.length;r++)if(((t=n.issues[r])==null?void 0:t.continue)!==!0)return!0;return!1}function Yr(n){return typeof n=="string"?n:n==null?void 0:n.message}function ri(n,e,t){var s,a,i,o,l,c;const r={...n,path:n.path??[]};if(!n.message){const u=Yr((i=(a=(s=n.inst)==null?void 0:s._zod.def)==null?void 0:a.error)==null?void 0:i.call(a,n))??Yr((o=e==null?void 0:e.error)==null?void 0:o.call(e,n))??Yr((l=t.customError)==null?void 0:l.call(t,n))??Yr((c=t.localeError)==null?void 0:c.call(t,n))??"Invalid input";r.message=u}return delete r.inst,delete r.continue,e!=null&&e.reportInput||delete r.input,r}const zc=(n,e)=>{n.name="$ZodError",Object.defineProperty(n,"_zod",{value:n._zod,enumerable:!1}),Object.defineProperty(n,"issues",{value:e,enumerable:!1}),Object.defineProperty(n,"message",{get(){return JSON.stringify(e,Qp,2)},enumerable:!0}),Object.defineProperty(n,"toString",{value:()=>n.message,enumerable:!1})},rm=Dn("$ZodError",zc),ni=Dn("$ZodError",zc,{Parent:Error}),nm=n=>async(e,t,r,s)=>{const a=r?Object.assign(r,{async:!0}):{async:!0};let i=e._zod.run({value:t,issues:[]},a);if(i instanceof Promise&&(i=await i),i.issues.length){const o=new((s==null?void 0:s.Err)??n)(i.issues.map(l=>ri(l,a,ti())));throw em(o,s==null?void 0:s.callee),o}return i.value},sm=nm(ni),am=n=>(e,t,r)=>{const s=r?{...r,async:!1}:{async:!1},a=e._zod.run({value:t,issues:[]},s);if(a instanceof Promise)throw new ba;return a.issues.length?{success:!1,error:new(n??rm)(a.issues.map(i=>ri(i,s,ti())))}:{success:!0,data:a.value}},im=am(ni),om=n=>async(e,t,r)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let a=e._zod.run({value:t,issues:[]},s);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new n(a.issues.map(i=>ri(i,s,ti())))}:{success:!0,data:a.value}},lm=om(ni),cm={major:4,minor:0,patch:0},um=Dn("$ZodType",(n,e)=>{var s;var t;n??(n={}),n._zod.def=e,n._zod.bag=n._zod.bag||{},n._zod.version=cm;const r=[...n._zod.def.checks??[]];n._zod.traits.has("$ZodCheck")&&r.unshift(n);for(const a of r)for(const i of a._zod.onattach)i(n);if(r.length===0)(t=n._zod).deferred??(t.deferred=[]),(s=n._zod.deferred)==null||s.push(()=>{n._zod.run=n._zod.parse});else{const a=(i,o,l)=>{let c=ra(i),u;for(const d of o){if(d._zod.def.when){if(!d._zod.def.when(i))continue}else if(c)continue;const h=i.issues.length,f=d._zod.check(i);if(f instanceof Promise&&(l==null?void 0:l.async)===!1)throw new ba;if(u||f instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await f,i.issues.length!==h&&(c||(c=ra(i,h)))});else{if(i.issues.length===h)continue;c||(c=ra(i,h))}}return u?u.then(()=>i):i};n._zod.run=(i,o)=>{const l=n._zod.parse(i,o);if(l instanceof Promise){if(o.async===!1)throw new ba;return l.then(c=>a(c,r,o))}return a(l,r,o)}}n["~standard"]={validate:a=>{var i;try{const o=im(n,a);return o.success?{value:o.data}:{issues:(i=o.error)==null?void 0:i.issues}}catch{return lm(n,a).then(l=>{var c;return l.success?{value:l.data}:{issues:(c=l.error)==null?void 0:c.issues}})}},vendor:"zod",version:1}}),dm=Dn("$ZodNever",(n,e)=>{um.init(n,e),n._zod.parse=(t,r)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:n}),t)});class Vc{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const r=t[0];if(this._map.set(e,r),r&&typeof r=="object"&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const r={...this.get(t)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function hm(){return new Vc}const mt=hm();function fm(n,e){return new n({type:"never",...tm()})}class Yo{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??mt,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var d,h,f;var r;const s=e._zod.def,a={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},i=this.seen.get(e);if(i)return i.count++,t.schemaPath.includes(e)&&(i.cycle=t.path),i.schema;const o={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,o);const l=(h=(d=e._zod).toJSONSchema)==null?void 0:h.call(d);if(l)o.schema=l;else{const p={...t,schemaPath:[...t.schemaPath,e],path:t.path},_=e._zod.parent;if(_)o.ref=_,this.process(_,p),this.seen.get(_).isParent=!0;else{const g=o.schema;switch(s.type){case"string":{const y=g;y.type="string";const{minimum:w,maximum:v,format:E,patterns:b,contentEncoding:x}=e._zod.bag;if(typeof w=="number"&&(y.minLength=w),typeof v=="number"&&(y.maxLength=v),E&&(y.format=a[E]??E,y.format===""&&delete y.format),x&&(y.contentEncoding=x),b&&b.size>0){const N=[...b];N.length===1?y.pattern=N[0].source:N.length>1&&(o.schema.allOf=[...N.map(I=>({...this.target==="draft-7"?{type:"string"}:{},pattern:I.source}))])}break}case"number":{const y=g,{minimum:w,maximum:v,format:E,multipleOf:b,exclusiveMaximum:x,exclusiveMinimum:N}=e._zod.bag;typeof E=="string"&&E.includes("int")?y.type="integer":y.type="number",typeof N=="number"&&(y.exclusiveMinimum=N),typeof w=="number"&&(y.minimum=w,typeof N=="number"&&(N>=w?delete y.minimum:delete y.exclusiveMinimum)),typeof x=="number"&&(y.exclusiveMaximum=x),typeof v=="number"&&(y.maximum=v,typeof x=="number"&&(x<=v?delete y.maximum:delete y.exclusiveMaximum)),typeof b=="number"&&(y.multipleOf=b);break}case"boolean":{const y=g;y.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{g.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{g.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const y=g,{minimum:w,maximum:v}=e._zod.bag;typeof w=="number"&&(y.minItems=w),typeof v=="number"&&(y.maxItems=v),y.type="array",y.items=this.process(s.element,{...p,path:[...p.path,"items"]});break}case"object":{const y=g;y.type="object",y.properties={};const w=s.shape;for(const b in w)y.properties[b]=this.process(w[b],{...p,path:[...p.path,"properties",b]});const v=new Set(Object.keys(w)),E=new Set([...v].filter(b=>{const x=s.shape[b]._zod;return this.io==="input"?x.optin===void 0:x.optout===void 0}));E.size>0&&(y.required=Array.from(E)),((f=s.catchall)==null?void 0:f._zod.def.type)==="never"?y.additionalProperties=!1:s.catchall?s.catchall&&(y.additionalProperties=this.process(s.catchall,{...p,path:[...p.path,"additionalProperties"]})):this.io==="output"&&(y.additionalProperties=!1);break}case"union":{const y=g;y.anyOf=s.options.map((w,v)=>this.process(w,{...p,path:[...p.path,"anyOf",v]}));break}case"intersection":{const y=g,w=this.process(s.left,{...p,path:[...p.path,"allOf",0]}),v=this.process(s.right,{...p,path:[...p.path,"allOf",1]}),E=x=>"allOf"in x&&Object.keys(x).length===1,b=[...E(w)?w.allOf:[w],...E(v)?v.allOf:[v]];y.allOf=b;break}case"tuple":{const y=g;y.type="array";const w=s.items.map((b,x)=>this.process(b,{...p,path:[...p.path,"prefixItems",x]}));if(this.target==="draft-2020-12"?y.prefixItems=w:y.items=w,s.rest){const b=this.process(s.rest,{...p,path:[...p.path,"items"]});this.target==="draft-2020-12"?y.items=b:y.additionalItems=b}s.rest&&(y.items=this.process(s.rest,{...p,path:[...p.path,"items"]}));const{minimum:v,maximum:E}=e._zod.bag;typeof v=="number"&&(y.minItems=v),typeof E=="number"&&(y.maxItems=E);break}case"record":{const y=g;y.type="object",y.propertyNames=this.process(s.keyType,{...p,path:[...p.path,"propertyNames"]}),y.additionalProperties=this.process(s.valueType,{...p,path:[...p.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const y=g,w=Xp(s.entries);w.every(v=>typeof v=="number")&&(y.type="number"),w.every(v=>typeof v=="string")&&(y.type="string"),y.enum=w;break}case"literal":{const y=g,w=[];for(const v of s.values)if(v===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof v=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");w.push(Number(v))}else w.push(v);if(w.length!==0)if(w.length===1){const v=w[0];y.type=v===null?"null":typeof v,y.const=v}else w.every(v=>typeof v=="number")&&(y.type="number"),w.every(v=>typeof v=="string")&&(y.type="string"),w.every(v=>typeof v=="boolean")&&(y.type="string"),w.every(v=>v===null)&&(y.type="null"),y.enum=w;break}case"file":{const y=g,w={type:"string",format:"binary",contentEncoding:"binary"},{minimum:v,maximum:E,mime:b}=e._zod.bag;v!==void 0&&(w.minLength=v),E!==void 0&&(w.maxLength=E),b?b.length===1?(w.contentMediaType=b[0],Object.assign(y,w)):y.anyOf=b.map(x=>({...w,contentMediaType:x})):Object.assign(y,w);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const y=this.process(s.innerType,p);g.anyOf=[y,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,p),o.ref=s.innerType;break}case"success":{const y=g;y.type="boolean";break}case"default":{this.process(s.innerType,p),o.ref=s.innerType,g.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,p),o.ref=s.innerType,this.io==="input"&&(g._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,p),o.ref=s.innerType;let y;try{y=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}g.default=y;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const y=g,w=e._zod.pattern;if(!w)throw new Error("Pattern not found in template literal");y.type="string",y.pattern=w.source;break}case"pipe":{const y=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(y,p),o.ref=y;break}case"readonly":{this.process(s.innerType,p),o.ref=s.innerType,g.readOnly=!0;break}case"promise":{this.process(s.innerType,p),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,p),o.ref=s.innerType;break}case"lazy":{const y=e._zod.innerType;this.process(y,p),o.ref=y;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const c=this.metadataRegistry.get(e);return c&&Object.assign(o.schema,c),this.io==="input"&&ye(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((r=o.schema).default??(r.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,t){var u,d,h,f,p,_;const r={cycles:(t==null?void 0:t.cycles)??"ref",reused:(t==null?void 0:t.reused)??"inline",external:(t==null?void 0:t.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const a=g=>{var b;const y=this.target==="draft-2020-12"?"$defs":"definitions";if(r.external){const x=(b=r.external.registry.get(g[0]))==null?void 0:b.id,N=r.external.uri??(le=>le);if(x)return{ref:N(x)};const I=g[1].defId??g[1].schema.id??`schema${this.counter++}`;return g[1].defId=I,{defId:I,ref:`${N("__shared")}#/${y}/${I}`}}if(g[1]===s)return{ref:"#"};const v=`#/${y}/`,E=g[1].schema.id??`__schema${this.counter++}`;return{defId:E,ref:v+E}},i=g=>{if(g[1].schema.$ref)return;const y=g[1],{ref:w,defId:v}=a(g);y.def={...y.schema},v&&(y.defId=v);const E=y.schema;for(const b in E)delete E[b];E.$ref=w};if(r.cycles==="throw")for(const g of this.seen.entries()){const y=g[1];if(y.cycle)throw new Error(`Cycle detected: #/${(u=y.cycle)==null?void 0:u.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const g of this.seen.entries()){const y=g[1];if(e===g[0]){i(g);continue}if(r.external){const v=(d=r.external.registry.get(g[0]))==null?void 0:d.id;if(e!==g[0]&&v){i(g);continue}}if((h=this.metadataRegistry.get(g[0]))==null?void 0:h.id){i(g);continue}if(y.cycle){i(g);continue}if(y.count>1&&r.reused==="ref"){i(g);continue}}const o=(g,y)=>{const w=this.seen.get(g),v=w.def??w.schema,E={...v};if(w.ref===null)return;const b=w.ref;if(w.ref=null,b){o(b,y);const x=this.seen.get(b).schema;x.$ref&&y.target==="draft-7"?(v.allOf=v.allOf??[],v.allOf.push(x)):(Object.assign(v,x),Object.assign(v,E))}w.isParent||this.override({zodSchema:g,jsonSchema:v,path:w.path??[]})};for(const g of[...this.seen.entries()].reverse())o(g[0],{target:this.target});const l={};if(this.target==="draft-2020-12"?l.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?l.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),(f=r.external)!=null&&f.uri){const g=(p=r.external.registry.get(e))==null?void 0:p.id;if(!g)throw new Error("Schema is missing an `id` property");l.$id=r.external.uri(g)}Object.assign(l,s.def);const c=((_=r.external)==null?void 0:_.defs)??{};for(const g of this.seen.entries()){const y=g[1];y.def&&y.defId&&(c[y.defId]=y.def)}r.external||Object.keys(c).length>0&&(this.target==="draft-2020-12"?l.$defs=c:l.definitions=c);try{return JSON.parse(JSON.stringify(l))}catch{throw new Error("Error converting schema to JSON.")}}}function Xo(n,e){if(n instanceof Vc){const r=new Yo(e),s={};for(const o of n._idmap.entries()){const[l,c]=o;r.process(c)}const a={},i={registry:n,uri:e==null?void 0:e.uri,defs:s};for(const o of n._idmap.entries()){const[l,c]=o;a[l]=r.emit(c,{...e,external:i})}if(Object.keys(s).length>0){const o=r.target==="draft-2020-12"?"$defs":"definitions";a.__shared={[o]:s}}return{schemas:a}}const t=new Yo(e);return t.process(n),t.emit(n,e)}function ye(n,e){const t=e??{seen:new Set};if(t.seen.has(n))return!1;t.seen.add(n);const s=n._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return ye(s.element,t);case"object":{for(const a in s.shape)if(ye(s.shape[a],t))return!0;return!1}case"union":{for(const a of s.options)if(ye(a,t))return!0;return!1}case"intersection":return ye(s.left,t)||ye(s.right,t);case"tuple":{for(const a of s.items)if(ye(a,t))return!0;return!!(s.rest&&ye(s.rest,t))}case"record":return ye(s.keyType,t)||ye(s.valueType,t);case"map":return ye(s.keyType,t)||ye(s.valueType,t);case"set":return ye(s.valueType,t);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return ye(s.innerType,t);case"lazy":return ye(s.getter(),t);case"default":return ye(s.innerType,t);case"prefault":return ye(s.innerType,t);case"custom":return!1;case"transform":return!0;case"pipe":return ye(s.in,t)||ye(s.out,t);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${s.type}`)}function ut(n){if(typeof n!="object"||n===null)return!1;const e=n;if(!("_zod"in e))return!1;const t=e._zod;return typeof t=="object"&&t!==null&&"def"in t}function Tt(n){if(typeof n!="object"||n===null)return!1;const e=n;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return typeof t=="object"&&t!=null&&"typeName"in t}function pm(n){return!n||typeof n!="object"||Array.isArray(n)?!1:!!(ut(n)||Tt(n))}async function mm(n,e){if(ut(n))return await sm(n,e);if(Tt(n))return await n.parseAsync(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function ym(n){var e;if(ut(n))return(e=mt.get(n))==null?void 0:e.description;if(Tt(n)||"description"in n&&typeof n.description=="string")return n.description}function gm(n){return pm(n)?Tt(n)?n._def.typeName==="ZodString":ut(n)?n._zod.def.type==="string":!1:!1}function gr(n){return ut(n)?typeof n=="object"&&n!==null&&"_zod"in n&&typeof n._zod=="object"&&n._zod!==null&&"def"in n._zod&&typeof n._zod.def=="object"&&n._zod.def!==null&&"type"in n._zod.def&&n._zod.def.type==="object":!1}function qc(n){return ut(n)?typeof n=="object"&&n!==null&&"_zod"in n&&typeof n._zod=="object"&&n._zod!==null&&"def"in n._zod&&typeof n._zod.def=="object"&&n._zod.def!==null&&"type"in n._zod.def&&n._zod.def.type==="array":!1}function Ea(n,e=!1){if(Tt(n))return n.strict();if(gr(n)){const t=n._zod.def.shape;if(e)for(const[a,i]of Object.entries(n._zod.def.shape)){if(gr(i)){const l=Ea(i,e);t[a]=l}else if(qc(i)){let l=i._zod.def.element;gr(l)&&(l=Ea(l,e)),t[a]=mn(i,{...i._zod.def,element:l})}else t[a]=i;const o=mt.get(i);o&&mt.add(t[a],o)}const r=mn(n,{...n._zod.def,shape:t,catchall:fm(dm)}),s=mt.get(n);return s&&mt.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function _m(n){return Tt(n)&&"typeName"in n._def&&n._def.typeName==="ZodEffects"}function vm(n){return ut(n)&&n._zod.def.type==="pipe"}function ur(n,e=!1){if(Tt(n))return _m(n)?ur(n._def.schema,e):n;if(ut(n)){let t=n;if(vm(n)&&(t=ur(n._zod.def.in,e)),e){if(gr(t)){const s=t._zod.def.shape;for(const[a,i]of Object.entries(t._zod.def.shape))s[a]=ur(i,e);t=mn(t,{...t._zod.def,shape:s})}else if(qc(t)){const s=ur(t._zod.def.element,e);t=mn(t,{...t._zod.def,element:s})}}const r=mt.get(n);return r&&mt.add(t,r),t}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function na(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}const wm=["*","_","`"];function bm(n){let e="";for(const[t,r]of Object.entries(n))e+=`	classDef ${t} ${r};
`;return e}function Em(n,e,t){const{firstNode:r,lastNode:s,nodeColors:a,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=t??{};let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){const f="default",p={[f]:"{0}({1})"};r!==void 0&&(p[r]="{0}([{1}]):::first"),s!==void 0&&(p[s]="{0}([{1}]):::last");for(const[_,g]of Object.entries(n)){const y=g.name.split(":").pop()??"";let v=wm.some(b=>y.startsWith(b)&&y.endsWith(b))?`<p>${y}</p>`:y;Object.keys(g.metadata??{}).length&&(v+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([b,x])=>`${b} = ${x}`).join(`
`)}</em></small>`);const E=(p[_]??p[f]).replace("{0}",na(_)).replace("{1}",v);c+=`	${E}
`}}const u={};for(const f of e){const p=f.source.split(":"),_=f.target.split(":"),g=p.filter((y,w)=>y===_[w]).join(":");u[g]||(u[g]=[]),u[g].push(f)}const d=new Set;function h(f,p){const _=f.length===1&&f[0].source===f[0].target;if(p&&!_){const g=p.split(":").pop();if(d.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(g),c+=`	subgraph ${g}
`}for(const g of f){const{source:y,target:w,data:v,conditional:E}=g;let b="";if(v!==void 0){let x=v;const N=x.split(" ");N.length>l&&(x=Array.from({length:Math.ceil(N.length/l)},(I,le)=>N.slice(le*l,(le+1)*l).join(" ")).join("&nbsp;<br>&nbsp;")),b=E?` -. &nbsp;${x}&nbsp; .-> `:` -- &nbsp;${x}&nbsp; --> `}else b=E?" -.-> ":" --> ";c+=`	${na(y)}${b}${na(w)};
`}for(const g in u)g.startsWith(`${p}:`)&&g!==p&&h(u[g],g);p&&!_&&(c+=`	end
`)}h(u[""]??[],"");for(const f in u)!f.includes(":")&&f!==""&&h(u[f],f);return i&&(c+=bm(a??{})),c}async function Sm(n,e){let t=(e==null?void 0:e.backgroundColor)??"white";const r=(e==null?void 0:e.imageType)??"png",s=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));const a=`https://mermaid.ink/img/${s}?bgColor=${t}&type=${r}`,i=await fetch(a);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join(`
`));return await i.blob()}const Tm=Symbol("Let zodToJsonSchema decide on which parser to use"),xm={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Im=n=>({...xm,...n}),Am=n=>{const e=Im(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}},Gc=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")};function ke(n){if(n.target!=="openAi")return{};const e=[...n.basePath,n.definitionPath,n.openAiAnyTypeName];return n.flags.hasReferencedOpenAiAnyType=!0,{$ref:n.$refStrategy==="relative"?Gc(e,n.currentPath):e.join("/")}}function Hc(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function ie(n,e,t,r,s){n[e]=t,Hc(n,e,r,s)}var re;(function(n){n.assertEqual=s=>{};function e(s){}n.assertIs=e;function t(s){throw new Error}n.assertNever=t,n.arrayToEnum=s=>{const a={};for(const i of s)a[i]=i;return a},n.getValidEnumValues=s=>{const a=n.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),i={};for(const o of a)i[o]=s[o];return n.objectValues(i)},n.objectValues=s=>n.objectKeys(s).map(function(a){return s[a]}),n.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const a=[];for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&a.push(i);return a},n.find=(s,a)=>{for(const i of s)if(a(i))return i},n.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function r(s,a=" | "){return s.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}n.joinValues=r,n.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(re||(re={}));var Qo;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Qo||(Qo={}));const L=re.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),ft=n=>{switch(typeof n){case"undefined":return L.undefined;case"string":return L.string;case"number":return Number.isNaN(n)?L.nan:L.number;case"boolean":return L.boolean;case"function":return L.function;case"bigint":return L.bigint;case"symbol":return L.symbol;case"object":return Array.isArray(n)?L.array:n===null?L.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?L.promise:typeof Map<"u"&&n instanceof Map?L.map:typeof Set<"u"&&n instanceof Set?L.set:typeof Date<"u"&&n instanceof Date?L.date:L.object;default:return L.unknown}},S=re.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class ct extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},r={_errors:[]},s=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(s);else if(i.code==="invalid_return_type")s(i.returnTypeError);else if(i.code==="invalid_arguments")s(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,l=0;for(;l<i.path.length;){const c=i.path[l];l===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],l++}}};return s(this),r}static assert(e){if(!(e instanceof ct))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,re.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const s of this.issues)if(s.path.length>0){const a=s.path[0];t[a]=t[a]||[],t[a].push(e(s))}else r.push(e(s));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}ct.create=n=>new ct(n);const Sa=(n,e)=>{let t;switch(n.code){case S.invalid_type:n.received===L.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case S.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,re.jsonStringifyReplacer)}`;break;case S.unrecognized_keys:t=`Unrecognized key(s) in object: ${re.joinValues(n.keys,", ")}`;break;case S.invalid_union:t="Invalid input";break;case S.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${re.joinValues(n.options)}`;break;case S.invalid_enum_value:t=`Invalid enum value. Expected ${re.joinValues(n.options)}, received '${n.received}'`;break;case S.invalid_arguments:t="Invalid function arguments";break;case S.invalid_return_type:t="Invalid function return type";break;case S.invalid_date:t="Invalid date";break;case S.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:re.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case S.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="bigint"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case S.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case S.custom:t="Invalid input";break;case S.invalid_intersection_types:t="Intersection results could not be merged";break;case S.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case S.not_finite:t="Number must be finite";break;default:t=e.defaultError,re.assertNever(n)}return{message:t}};let Rm=Sa;function $m(){return Rm}const Cm=n=>{const{data:e,path:t,errorMaps:r,issueData:s}=n,a=[...t,...s.path||[]],i={...s,path:a};if(s.message!==void 0)return{...s,path:a,message:s.message};let o="";const l=r.filter(c=>!!c).slice().reverse();for(const c of l)o=c(i,{data:e,defaultError:o}).message;return{...s,path:a,message:o}};function C(n,e){const t=$m(),r=Cm({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===Sa?void 0:Sa].filter(s=>!!s)});n.common.issues.push(r)}class Me{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const s of t){if(s.status==="aborted")return K;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const s of t){const a=await s.key,i=await s.value;r.push({key:a,value:i})}return Me.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const s of t){const{key:a,value:i}=s;if(a.status==="aborted"||i.status==="aborted")return K;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||s.alwaysSet)&&(r[a.value]=i.value)}return{status:e.value,value:r}}}const K=Object.freeze({status:"aborted"}),dr=n=>({status:"dirty",value:n}),Ue=n=>({status:"valid",value:n}),el=n=>n.status==="aborted",tl=n=>n.status==="dirty",Jt=n=>n.status==="valid",yn=n=>typeof Promise<"u"&&n instanceof Promise;var M;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(M||(M={}));class Et{constructor(e,t,r,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const rl=(n,e)=>{if(Jt(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new ct(n.common.issues);return this._error=t,this._error}}};function Q(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:s}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(i,o)=>{const{message:l}=n;return i.code==="invalid_enum_value"?{message:l??o.defaultError}:typeof o.data>"u"?{message:l??r??o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:l??t??o.defaultError}},description:s}}class te{get description(){return this._def.description}_getType(e){return ft(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:ft(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Me,ctx:{common:e.parent.common,data:e.data,parsedType:ft(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(yn(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){const r={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ft(e)},s=this._parseSync({data:e,path:r.path,parent:r});return rl(r,s)}"~validate"(e){var r,s;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ft(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:t});return Jt(a)?{value:a.value}:{issues:t.common.issues}}catch(a){(s=(r=a==null?void 0:a.message)==null?void 0:r.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(a=>Jt(a)?{value:a.value}:{issues:t.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ft(e)},s=this._parse({data:e,path:r.path,parent:r}),a=await(yn(s)?s:Promise.resolve(s));return rl(r,a)}refine(e,t){const r=s=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,a)=>{const i=e(s),o=()=>a.addIssue({code:S.custom,...r(s)});return typeof Promise<"u"&&i instanceof Promise?i.then(l=>l?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof t=="function"?t(r,s):t),!1))}_refinement(e){return new Kt({schema:this,typeName:T.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return _t.create(this,this._def)}nullable(){return Yt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return tt.create(this)}promise(){return wn.create(this,this._def)}or(e){return _n.create([this,e],this._def)}and(e){return vn.create(this,e,this._def)}transform(e){return new Kt({...Q(this._def),schema:this,typeName:T.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Ia({...Q(this._def),innerType:this,defaultValue:t,typeName:T.ZodDefault})}brand(){return new Qm({typeName:T.ZodBranded,type:this,...Q(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Aa({...Q(this._def),innerType:this,catchValue:t,typeName:T.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return si.create(this,e)}readonly(){return Ra.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const km=/^c[^\s-]{8,}$/i,Om=/^[0-9a-z]+$/,Pm=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Nm=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Lm=/^[a-z0-9_-]{21}$/i,Mm=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,jm=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Dm=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Um="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let sa;const Fm=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Bm=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,zm=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Vm=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,qm=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Gm=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Zc="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Hm=new RegExp(`^${Zc}$`);function Jc(n){let e="[0-5]\\d";n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`);const t=n.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function Zm(n){return new RegExp(`^${Jc(n)}$`)}function Jm(n){let e=`${Zc}T${Jc(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Wm(n,e){return!!((e==="v4"||!e)&&Fm.test(n)||(e==="v6"||!e)&&zm.test(n))}function Km(n,e){if(!Mm.test(n))return!1;try{const[t]=n.split(".");if(!t)return!1;const r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function Ym(n,e){return!!((e==="v4"||!e)&&Bm.test(n)||(e==="v6"||!e)&&Vm.test(n))}class yt extends te{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==L.string){const a=this._getOrReturnCtx(e);return C(a,{code:S.invalid_type,expected:L.string,received:a.parsedType}),K}const r=new Me;let s;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),C(s,{code:S.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),C(s,{code:S.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(s=this._getOrReturnCtx(e,s),i?C(s,{code:S.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&C(s,{code:S.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),r.dirty())}else if(a.kind==="email")Dm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"email",code:S.invalid_string,message:a.message}),r.dirty());else if(a.kind==="emoji")sa||(sa=new RegExp(Um,"u")),sa.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"emoji",code:S.invalid_string,message:a.message}),r.dirty());else if(a.kind==="uuid")Nm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"uuid",code:S.invalid_string,message:a.message}),r.dirty());else if(a.kind==="nanoid")Lm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"nanoid",code:S.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid")km.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"cuid",code:S.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid2")Om.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"cuid2",code:S.invalid_string,message:a.message}),r.dirty());else if(a.kind==="ulid")Pm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"ulid",code:S.invalid_string,message:a.message}),r.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),C(s,{validation:"url",code:S.invalid_string,message:a.message}),r.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"regex",code:S.invalid_string,message:a.message}),r.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),C(s,{code:S.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),r.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),C(s,{code:S.invalid_string,validation:{startsWith:a.value},message:a.message}),r.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),C(s,{code:S.invalid_string,validation:{endsWith:a.value},message:a.message}),r.dirty()):a.kind==="datetime"?Jm(a).test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{code:S.invalid_string,validation:"datetime",message:a.message}),r.dirty()):a.kind==="date"?Hm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{code:S.invalid_string,validation:"date",message:a.message}),r.dirty()):a.kind==="time"?Zm(a).test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{code:S.invalid_string,validation:"time",message:a.message}),r.dirty()):a.kind==="duration"?jm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"duration",code:S.invalid_string,message:a.message}),r.dirty()):a.kind==="ip"?Wm(e.data,a.version)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"ip",code:S.invalid_string,message:a.message}),r.dirty()):a.kind==="jwt"?Km(e.data,a.alg)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"jwt",code:S.invalid_string,message:a.message}),r.dirty()):a.kind==="cidr"?Ym(e.data,a.version)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"cidr",code:S.invalid_string,message:a.message}),r.dirty()):a.kind==="base64"?qm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"base64",code:S.invalid_string,message:a.message}),r.dirty()):a.kind==="base64url"?Gm.test(e.data)||(s=this._getOrReturnCtx(e,s),C(s,{validation:"base64url",code:S.invalid_string,message:a.message}),r.dirty()):re.assertNever(a);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(s=>e.test(s),{validation:t,code:S.invalid_string,...M.errToObj(r)})}_addCheck(e){return new yt({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...M.errToObj(e)})}url(e){return this._addCheck({kind:"url",...M.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...M.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...M.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...M.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...M.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...M.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...M.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...M.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...M.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...M.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...M.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...M.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...M.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...M.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...M.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...M.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...M.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...M.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...M.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...M.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...M.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...M.errToObj(t)})}nonempty(e){return this.min(1,M.errToObj(e))}trim(){return new yt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new yt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new yt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}yt.create=n=>new yt({checks:[],typeName:T.ZodString,coerce:(n==null?void 0:n.coerce)??!1,...Q(n)});function Xm(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=t>r?t:r,a=Number.parseInt(n.toFixed(s).replace(".","")),i=Number.parseInt(e.toFixed(s).replace(".",""));return a%i/10**s}class Tr extends te{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==L.number){const a=this._getOrReturnCtx(e);return C(a,{code:S.invalid_type,expected:L.number,received:a.parsedType}),K}let r;const s=new Me;for(const a of this._def.checks)a.kind==="int"?re.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),C(r,{code:S.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),C(r,{code:S.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),C(r,{code:S.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?Xm(e.data,a.value)!==0&&(r=this._getOrReturnCtx(e,r),C(r,{code:S.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),C(r,{code:S.not_finite,message:a.message}),s.dirty()):re.assertNever(a);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,M.toString(t))}gt(e,t){return this.setLimit("min",e,!1,M.toString(t))}lte(e,t){return this.setLimit("max",e,!0,M.toString(t))}lt(e,t){return this.setLimit("max",e,!1,M.toString(t))}setLimit(e,t,r,s){return new Tr({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:M.toString(s)}]})}_addCheck(e){return new Tr({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:M.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:M.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:M.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:M.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:M.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:M.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:M.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:M.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:M.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&re.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Tr.create=n=>new Tr({checks:[],typeName:T.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...Q(n)});class xr extends te{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==L.bigint)return this._getInvalidInput(e);let r;const s=new Me;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),C(r,{code:S.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),C(r,{code:S.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),C(r,{code:S.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):re.assertNever(a);return{status:s.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return C(t,{code:S.invalid_type,expected:L.bigint,received:t.parsedType}),K}gte(e,t){return this.setLimit("min",e,!0,M.toString(t))}gt(e,t){return this.setLimit("min",e,!1,M.toString(t))}lte(e,t){return this.setLimit("max",e,!0,M.toString(t))}lt(e,t){return this.setLimit("max",e,!1,M.toString(t))}setLimit(e,t,r,s){return new xr({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:M.toString(s)}]})}_addCheck(e){return new xr({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:M.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:M.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:M.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:M.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:M.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}xr.create=n=>new xr({checks:[],typeName:T.ZodBigInt,coerce:(n==null?void 0:n.coerce)??!1,...Q(n)});class nl extends te{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==L.boolean){const r=this._getOrReturnCtx(e);return C(r,{code:S.invalid_type,expected:L.boolean,received:r.parsedType}),K}return Ue(e.data)}}nl.create=n=>new nl({typeName:T.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...Q(n)});class gn extends te{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==L.date){const a=this._getOrReturnCtx(e);return C(a,{code:S.invalid_type,expected:L.date,received:a.parsedType}),K}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return C(a,{code:S.invalid_date}),K}const r=new Me;let s;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),C(s,{code:S.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),C(s,{code:S.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):re.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new gn({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:M.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:M.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}gn.create=n=>new gn({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:T.ZodDate,...Q(n)});class sl extends te{_parse(e){if(this._getType(e)!==L.symbol){const r=this._getOrReturnCtx(e);return C(r,{code:S.invalid_type,expected:L.symbol,received:r.parsedType}),K}return Ue(e.data)}}sl.create=n=>new sl({typeName:T.ZodSymbol,...Q(n)});class al extends te{_parse(e){if(this._getType(e)!==L.undefined){const r=this._getOrReturnCtx(e);return C(r,{code:S.invalid_type,expected:L.undefined,received:r.parsedType}),K}return Ue(e.data)}}al.create=n=>new al({typeName:T.ZodUndefined,...Q(n)});class il extends te{_parse(e){if(this._getType(e)!==L.null){const r=this._getOrReturnCtx(e);return C(r,{code:S.invalid_type,expected:L.null,received:r.parsedType}),K}return Ue(e.data)}}il.create=n=>new il({typeName:T.ZodNull,...Q(n)});class Ta extends te{constructor(){super(...arguments),this._any=!0}_parse(e){return Ue(e.data)}}Ta.create=n=>new Ta({typeName:T.ZodAny,...Q(n)});class ol extends te{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ue(e.data)}}ol.create=n=>new ol({typeName:T.ZodUnknown,...Q(n)});class St extends te{_parse(e){const t=this._getOrReturnCtx(e);return C(t,{code:S.invalid_type,expected:L.never,received:t.parsedType}),K}}St.create=n=>new St({typeName:T.ZodNever,...Q(n)});class ll extends te{_parse(e){if(this._getType(e)!==L.undefined){const r=this._getOrReturnCtx(e);return C(r,{code:S.invalid_type,expected:L.void,received:r.parsedType}),K}return Ue(e.data)}}ll.create=n=>new ll({typeName:T.ZodVoid,...Q(n)});class tt extends te{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),s=this._def;if(t.parsedType!==L.array)return C(t,{code:S.invalid_type,expected:L.array,received:t.parsedType}),K;if(s.exactLength!==null){const i=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(i||o)&&(C(t,{code:i?S.too_big:S.too_small,minimum:o?s.exactLength.value:void 0,maximum:i?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(C(t,{code:S.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(C(t,{code:S.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>s.type._parseAsync(new Et(t,i,t.path,o)))).then(i=>Me.mergeArray(r,i));const a=[...t.data].map((i,o)=>s.type._parseSync(new Et(t,i,t.path,o)));return Me.mergeArray(r,a)}get element(){return this._def.type}min(e,t){return new tt({...this._def,minLength:{value:e,message:M.toString(t)}})}max(e,t){return new tt({...this._def,maxLength:{value:e,message:M.toString(t)}})}length(e,t){return new tt({...this._def,exactLength:{value:e,message:M.toString(t)}})}nonempty(e){return this.min(1,e)}}tt.create=(n,e)=>new tt({type:n,minLength:null,maxLength:null,exactLength:null,typeName:T.ZodArray,...Q(e)});function Bt(n){if(n instanceof pe){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=_t.create(Bt(r))}return new pe({...n._def,shape:()=>e})}else return n instanceof tt?new tt({...n._def,type:Bt(n.element)}):n instanceof _t?_t.create(Bt(n.unwrap())):n instanceof Yt?Yt.create(Bt(n.unwrap())):n instanceof Ot?Ot.create(n.items.map(e=>Bt(e))):n}class pe extends te{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=re.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==L.object){const c=this._getOrReturnCtx(e);return C(c,{code:S.invalid_type,expected:L.object,received:c.parsedType}),K}const{status:r,ctx:s}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof St&&this._def.unknownKeys==="strip"))for(const c in s.data)i.includes(c)||o.push(c);const l=[];for(const c of i){const u=a[c],d=s.data[c];l.push({key:{status:"valid",value:c},value:u._parse(new Et(s,d,s.path,c)),alwaysSet:c in s.data})}if(this._def.catchall instanceof St){const c=this._def.unknownKeys;if(c==="passthrough")for(const u of o)l.push({key:{status:"valid",value:u},value:{status:"valid",value:s.data[u]}});else if(c==="strict")o.length>0&&(C(s,{code:S.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const u of o){const d=s.data[u];l.push({key:{status:"valid",value:u},value:c._parse(new Et(s,d,s.path,u)),alwaysSet:u in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const c=[];for(const u of l){const d=await u.key,h=await u.value;c.push({key:d,value:h,alwaysSet:u.alwaysSet})}return c}).then(c=>Me.mergeObjectSync(r,c)):Me.mergeObjectSync(r,l)}get shape(){return this._def.shape()}strict(e){return M.errToObj,new pe({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,i;const s=((i=(a=this._def).errorMap)==null?void 0:i.call(a,t,r).message)??r.defaultError;return t.code==="unrecognized_keys"?{message:M.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new pe({...this._def,unknownKeys:"strip"})}passthrough(){return new pe({...this._def,unknownKeys:"passthrough"})}extend(e){return new pe({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new pe({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:T.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new pe({...this._def,catchall:e})}pick(e){const t={};for(const r of re.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new pe({...this._def,shape:()=>t})}omit(e){const t={};for(const r of re.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new pe({...this._def,shape:()=>t})}deepPartial(){return Bt(this)}partial(e){const t={};for(const r of re.objectKeys(this.shape)){const s=this.shape[r];e&&!e[r]?t[r]=s:t[r]=s.optional()}return new pe({...this._def,shape:()=>t})}required(e){const t={};for(const r of re.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let a=this.shape[r];for(;a instanceof _t;)a=a._def.innerType;t[r]=a}return new pe({...this._def,shape:()=>t})}keyof(){return Wc(re.objectKeys(this.shape))}}pe.create=(n,e)=>new pe({shape:()=>n,unknownKeys:"strip",catchall:St.create(),typeName:T.ZodObject,...Q(e)});pe.strictCreate=(n,e)=>new pe({shape:()=>n,unknownKeys:"strict",catchall:St.create(),typeName:T.ZodObject,...Q(e)});pe.lazycreate=(n,e)=>new pe({shape:n,unknownKeys:"strip",catchall:St.create(),typeName:T.ZodObject,...Q(e)});class _n extends te{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function s(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=a.map(o=>new ct(o.ctx.common.issues));return C(t,{code:S.invalid_union,unionErrors:i}),K}if(t.common.async)return Promise.all(r.map(async a=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(s);{let a;const i=[];for(const l of r){const c={...t,common:{...t.common,issues:[]},parent:null},u=l._parseSync({data:t.data,path:t.path,parent:c});if(u.status==="valid")return u;u.status==="dirty"&&!a&&(a={result:u,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=i.map(l=>new ct(l));return C(t,{code:S.invalid_union,unionErrors:o}),K}}get options(){return this._def.options}}_n.create=(n,e)=>new _n({options:n,typeName:T.ZodUnion,...Q(e)});function xa(n,e){const t=ft(n),r=ft(e);if(n===e)return{valid:!0,data:n};if(t===L.object&&r===L.object){const s=re.objectKeys(e),a=re.objectKeys(n).filter(o=>s.indexOf(o)!==-1),i={...n,...e};for(const o of a){const l=xa(n[o],e[o]);if(!l.valid)return{valid:!1};i[o]=l.data}return{valid:!0,data:i}}else if(t===L.array&&r===L.array){if(n.length!==e.length)return{valid:!1};const s=[];for(let a=0;a<n.length;a++){const i=n[a],o=e[a],l=xa(i,o);if(!l.valid)return{valid:!1};s.push(l.data)}return{valid:!0,data:s}}else return t===L.date&&r===L.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class vn extends te{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=(a,i)=>{if(el(a)||el(i))return K;const o=xa(a.value,i.value);return o.valid?((tl(a)||tl(i))&&t.dirty(),{status:t.value,value:o.data}):(C(r,{code:S.invalid_intersection_types}),K)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([a,i])=>s(a,i)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}vn.create=(n,e,t)=>new vn({left:n,right:e,typeName:T.ZodIntersection,...Q(t)});class Ot extends te{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==L.array)return C(r,{code:S.invalid_type,expected:L.array,received:r.parsedType}),K;if(r.data.length<this._def.items.length)return C(r,{code:S.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),K;!this._def.rest&&r.data.length>this._def.items.length&&(C(r,{code:S.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...r.data].map((i,o)=>{const l=this._def.items[o]||this._def.rest;return l?l._parse(new Et(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(a).then(i=>Me.mergeArray(t,i)):Me.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new Ot({...this._def,rest:e})}}Ot.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ot({items:n,typeName:T.ZodTuple,rest:null,...Q(e)})};class cl extends te{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==L.map)return C(r,{code:S.invalid_type,expected:L.map,received:r.parsedType}),K;const s=this._def.keyType,a=this._def.valueType,i=[...r.data.entries()].map(([o,l],c)=>({key:s._parse(new Et(r,o,r.path,[c,"key"])),value:a._parse(new Et(r,l,r.path,[c,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const l of i){const c=await l.key,u=await l.value;if(c.status==="aborted"||u.status==="aborted")return K;(c.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(c.value,u.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const l of i){const c=l.key,u=l.value;if(c.status==="aborted"||u.status==="aborted")return K;(c.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(c.value,u.value)}return{status:t.value,value:o}}}}cl.create=(n,e,t)=>new cl({valueType:e,keyType:n,typeName:T.ZodMap,...Q(t)});class Ir extends te{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==L.set)return C(r,{code:S.invalid_type,expected:L.set,received:r.parsedType}),K;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(C(r,{code:S.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(C(r,{code:S.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const a=this._def.valueType;function i(l){const c=new Set;for(const u of l){if(u.status==="aborted")return K;u.status==="dirty"&&t.dirty(),c.add(u.value)}return{status:t.value,value:c}}const o=[...r.data.values()].map((l,c)=>a._parse(new Et(r,l,r.path,c)));return r.common.async?Promise.all(o).then(l=>i(l)):i(o)}min(e,t){return new Ir({...this._def,minSize:{value:e,message:M.toString(t)}})}max(e,t){return new Ir({...this._def,maxSize:{value:e,message:M.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ir.create=(n,e)=>new Ir({valueType:n,minSize:null,maxSize:null,typeName:T.ZodSet,...Q(e)});class ul extends te{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}ul.create=(n,e)=>new ul({getter:n,typeName:T.ZodLazy,...Q(e)});class dl extends te{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return C(t,{received:t.data,code:S.invalid_literal,expected:this._def.value}),K}return{status:"valid",value:e.data}}get value(){return this._def.value}}dl.create=(n,e)=>new dl({value:n,typeName:T.ZodLiteral,...Q(e)});function Wc(n,e){return new Wt({values:n,typeName:T.ZodEnum,...Q(e)})}class Wt extends te{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return C(t,{expected:re.joinValues(r),received:t.parsedType,code:S.invalid_type}),K}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return C(t,{received:t.data,code:S.invalid_enum_value,options:r}),K}return Ue(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Wt.create(e,{...this._def,...t})}exclude(e,t=this._def){return Wt.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}}Wt.create=Wc;class hl extends te{_parse(e){const t=re.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==L.string&&r.parsedType!==L.number){const s=re.objectValues(t);return C(r,{expected:re.joinValues(s),received:r.parsedType,code:S.invalid_type}),K}if(this._cache||(this._cache=new Set(re.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=re.objectValues(t);return C(r,{received:r.data,code:S.invalid_enum_value,options:s}),K}return Ue(e.data)}get enum(){return this._def.values}}hl.create=(n,e)=>new hl({values:n,typeName:T.ZodNativeEnum,...Q(e)});class wn extends te{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==L.promise&&t.common.async===!1)return C(t,{code:S.invalid_type,expected:L.promise,received:t.parsedType}),K;const r=t.parsedType===L.promise?t.data:Promise.resolve(t.data);return Ue(r.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}}wn.create=(n,e)=>new wn({type:n,typeName:T.ZodPromise,...Q(e)});class Kt extends te{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===T.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:i=>{C(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){const i=s.transform(r.data,a);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return K;const l=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return l.status==="aborted"?K:l.status==="dirty"||t.value==="dirty"?dr(l.value):l});{if(t.value==="aborted")return K;const o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?K:o.status==="dirty"||t.value==="dirty"?dr(o.value):o}}if(s.type==="refinement"){const i=o=>{const l=s.refinement(o,a);if(r.common.async)return Promise.resolve(l);if(l instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?K:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?K:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Jt(i))return K;const o=s.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Jt(i)?Promise.resolve(s.transform(i.value,a)).then(o=>({status:t.value,value:o})):K);re.assertNever(s)}}Kt.create=(n,e,t)=>new Kt({schema:n,typeName:T.ZodEffects,effect:e,...Q(t)});Kt.createWithPreprocess=(n,e,t)=>new Kt({schema:e,effect:{type:"preprocess",transform:n},typeName:T.ZodEffects,...Q(t)});class _t extends te{_parse(e){return this._getType(e)===L.undefined?Ue(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}_t.create=(n,e)=>new _t({innerType:n,typeName:T.ZodOptional,...Q(e)});class Yt extends te{_parse(e){return this._getType(e)===L.null?Ue(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Yt.create=(n,e)=>new Yt({innerType:n,typeName:T.ZodNullable,...Q(e)});class Ia extends te{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===L.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Ia.create=(n,e)=>new Ia({innerType:n,typeName:T.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...Q(e)});class Aa extends te{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return yn(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new ct(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new ct(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Aa.create=(n,e)=>new Aa({innerType:n,typeName:T.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...Q(e)});class fl extends te{_parse(e){if(this._getType(e)!==L.nan){const r=this._getOrReturnCtx(e);return C(r,{code:S.invalid_type,expected:L.nan,received:r.parsedType}),K}return{status:"valid",value:e.data}}}fl.create=n=>new fl({typeName:T.ZodNaN,...Q(n)});class Qm extends te{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class si extends te{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?K:a.status==="dirty"?(t.dirty(),dr(a.value)):this._def.out._parseAsync({data:a.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?K:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,t){return new si({in:e,out:t,typeName:T.ZodPipeline})}}class Ra extends te{_parse(e){const t=this._def.innerType._parse(e),r=s=>(Jt(s)&&(s.value=Object.freeze(s.value)),s);return yn(t)?t.then(s=>r(s)):r(t)}unwrap(){return this._def.innerType}}Ra.create=(n,e)=>new Ra({innerType:n,typeName:T.ZodReadonly,...Q(e)});var T;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(T||(T={}));const en=yt.create,pl=Ta.create;St.create;tt.create;const Kc=pe.create;_n.create;vn.create;Ot.create;Wt.create;wn.create;_t.create;Yt.create;function ey(n,e){var r,s,a;const t={type:"array"};return(r=n.type)!=null&&r._def&&((a=(s=n.type)==null?void 0:s._def)==null?void 0:a.typeName)!==T.ZodAny&&(t.items=se(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&ie(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&ie(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(ie(t,"minItems",n.exactLength.value,n.exactLength.message,e),ie(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function ty(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?ie(t,"minimum",r.value,r.message,e):ie(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ie(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ie(t,"maximum",r.value,r.message,e):ie(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ie(t,"maximum",r.value,r.message,e));break;case"multipleOf":ie(t,"multipleOf",r.value,r.message,e);break}return t}function ry(){return{type:"boolean"}}function Yc(n,e){return se(n.type._def,e)}const ny=(n,e)=>se(n.innerType._def,e);function Xc(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(s=>Xc(n,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return sy(n,e)}}const sy=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":ie(t,"minimum",r.value,r.message,e);break;case"max":ie(t,"maximum",r.value,r.message,e);break}return t};function ay(n,e){return{...se(n.innerType._def,e),default:n.defaultValue()}}function iy(n,e){return e.effectStrategy==="input"?se(n.schema._def,e):ke(e)}function oy(n){return{type:"string",enum:Array.from(n.values)}}const ly=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function cy(n,e){const t=[se(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),se(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return t.forEach(a=>{if(ly(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...l}=a;i=l}else r=void 0;s.push(i)}}),s.length?{allOf:s,...r}:void 0}function uy(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let aa;const Be={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(aa===void 0&&(aa=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),aa),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Qc(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":ie(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":ie(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":ze(t,"email",r.message,e);break;case"format:idn-email":ze(t,"idn-email",r.message,e);break;case"pattern:zod":Se(t,Be.email,r.message,e);break}break;case"url":ze(t,"uri",r.message,e);break;case"uuid":ze(t,"uuid",r.message,e);break;case"regex":Se(t,r.regex,r.message,e);break;case"cuid":Se(t,Be.cuid,r.message,e);break;case"cuid2":Se(t,Be.cuid2,r.message,e);break;case"startsWith":Se(t,RegExp(`^${ia(r.value,e)}`),r.message,e);break;case"endsWith":Se(t,RegExp(`${ia(r.value,e)}$`),r.message,e);break;case"datetime":ze(t,"date-time",r.message,e);break;case"date":ze(t,"date",r.message,e);break;case"time":ze(t,"time",r.message,e);break;case"duration":ze(t,"duration",r.message,e);break;case"length":ie(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),ie(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":Se(t,RegExp(ia(r.value,e)),r.message,e);break;case"ip":r.version!=="v6"&&ze(t,"ipv4",r.message,e),r.version!=="v4"&&ze(t,"ipv6",r.message,e);break;case"base64url":Se(t,Be.base64url,r.message,e);break;case"jwt":Se(t,Be.jwt,r.message,e);break;case"cidr":r.version!=="v6"&&Se(t,Be.ipv4Cidr,r.message,e),r.version!=="v4"&&Se(t,Be.ipv6Cidr,r.message,e);break;case"emoji":Se(t,Be.emoji(),r.message,e);break;case"ulid":Se(t,Be.ulid,r.message,e);break;case"base64":switch(e.base64Strategy){case"format:binary":ze(t,"binary",r.message,e);break;case"contentEncoding:base64":ie(t,"contentEncoding","base64",r.message,e);break;case"pattern:zod":Se(t,Be.base64,r.message,e);break}break;case"nanoid":Se(t,Be.nanoid,r.message,e);break}return t}function ia(n,e){return e.patternStrategy==="escape"?hy(n):n}const dy=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function hy(n){let e="";for(let t=0;t<n.length;t++)dy.has(n[t])||(e+="\\"),e+=n[t];return e}function ze(n,e,t,r){var s;n.format||(s=n.anyOf)!=null&&s.some(a=>a.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):ie(n,"format",e,t,r)}function Se(n,e,t,r){var s;n.pattern||(s=n.allOf)!=null&&s.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:ml(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):ie(n,"pattern",ml(e,r),t,r)}function ml(n,e){var l;if(!e.applyRegexFlags||!n.flags)return n.source;const t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source;let s="",a=!1,i=!1,o=!1;for(let c=0;c<r.length;c++){if(a){s+=r[c],a=!1;continue}if(t.i){if(i){if(r[c].match(/[a-z]/)){o?(s+=r[c],s+=`${r[c-2]}-${r[c]}`.toUpperCase(),o=!1):r[c+1]==="-"&&((l=r[c+2])!=null&&l.match(/[a-z]/))?(s+=r[c],o=!0):s+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){s+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(t.m){if(r[c]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){s+=`($|(?=[\r
]))`;continue}}if(t.s&&r[c]==="."){s+=i?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}s+=r[c],r[c]==="\\"?a=!0:i&&r[c]==="]"?i=!1:!i&&r[c]==="["&&(i=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return s}function eu(n,e){var r,s,a,i,o,l;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===T.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((c,u)=>({...c,[u]:se(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??ke(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};const t={type:"object",additionalProperties:se(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===T.ZodString&&((a=n.keyType._def.checks)!=null&&a.length)){const{type:c,...u}=Qc(n.keyType._def,e);return{...t,propertyNames:u}}else{if(((i=n.keyType)==null?void 0:i._def.typeName)===T.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(((o=n.keyType)==null?void 0:o._def.typeName)===T.ZodBranded&&n.keyType._def.type._def.typeName===T.ZodString&&((l=n.keyType._def.type._def.checks)!=null&&l.length)){const{type:c,...u}=Yc(n.keyType._def,e);return{...t,propertyNames:u}}}return t}function fy(n,e){if(e.mapStrategy==="record")return eu(n,e);const t=se(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||ke(e),r=se(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||ke(e);return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function py(n){const e=n.values,r=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function my(n){return n.target==="openAi"?void 0:{not:ke({...n,currentPath:[...n.currentPath,"not"]})}}function yy(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const bn={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function gy(n,e){if(e.target==="openApi3")return yl(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in bn&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((s,a)=>{const i=bn[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((s,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":return a._def.value===null?[...s,"null"]:s;case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===t.length){const s=r.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:t.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return yl(n,e)}const yl=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,s)=>se(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function _y(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:bn[n.innerType._def.typeName],nullable:!0}:{type:[bn[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=se(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=se(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function vy(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",Hc(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?ie(t,"minimum",r.value,r.message,e):ie(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ie(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ie(t,"maximum",r.value,r.message,e):ie(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ie(t,"maximum",r.value,r.message,e));break;case"multipleOf":ie(t,"multipleOf",r.value,r.message,e);break}return t}function wy(n,e){const t=e.target==="openAi",r={type:"object",properties:{}},s=[],a=n.shape();for(const o in a){let l=a[o];if(l===void 0||l._def===void 0)continue;let c=Ey(l);c&&t&&(l._def.typeName==="ZodOptional"&&(l=l._def.innerType),l.isNullable()||(l=l.nullable()),c=!1);const u=se(l._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});u!==void 0&&(r.properties[o]=u,c||s.push(o))}s.length&&(r.required=s);const i=by(n,e);return i!==void 0&&(r.additionalProperties=i),r}function by(n,e){if(n.catchall._def.typeName!=="ZodNever")return se(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(n.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function Ey(n){try{return n.isOptional()}catch{return!0}}const Sy=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return se(n.innerType._def,e);const t=se(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:ke(e)},t]}:ke(e)},Ty=(n,e)=>{if(e.pipeStrategy==="input")return se(n.in._def,e);if(e.pipeStrategy==="output")return se(n.out._def,e);const t=se(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=se(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(s=>s!==void 0)}};function xy(n,e){return se(n.type._def,e)}function Iy(n,e){const r={type:"array",uniqueItems:!0,items:se(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&ie(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&ie(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Ay(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>se(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:se(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>se(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function Ry(n){return{not:ke(n)}}function $y(n){return ke(n)}const Cy=(n,e)=>se(n.innerType._def,e),ky=(n,e,t)=>{switch(e){case T.ZodString:return Qc(n,t);case T.ZodNumber:return vy(n,t);case T.ZodObject:return wy(n,t);case T.ZodBigInt:return ty(n,t);case T.ZodBoolean:return ry();case T.ZodDate:return Xc(n,t);case T.ZodUndefined:return Ry(t);case T.ZodNull:return yy(t);case T.ZodArray:return ey(n,t);case T.ZodUnion:case T.ZodDiscriminatedUnion:return gy(n,t);case T.ZodIntersection:return cy(n,t);case T.ZodTuple:return Ay(n,t);case T.ZodRecord:return eu(n,t);case T.ZodLiteral:return uy(n,t);case T.ZodEnum:return oy(n);case T.ZodNativeEnum:return py(n);case T.ZodNullable:return _y(n,t);case T.ZodOptional:return Sy(n,t);case T.ZodMap:return fy(n,t);case T.ZodSet:return Iy(n,t);case T.ZodLazy:return()=>n.getter()._def;case T.ZodPromise:return xy(n,t);case T.ZodNaN:case T.ZodNever:return my(t);case T.ZodEffects:return iy(n,t);case T.ZodAny:return ke(t);case T.ZodUnknown:return $y(t);case T.ZodDefault:return ay(n,t);case T.ZodBranded:return Yc(n,t);case T.ZodReadonly:return Cy(n,t);case T.ZodCatch:return ny(n,t);case T.ZodPipeline:return Ty(n,t);case T.ZodFunction:case T.ZodVoid:case T.ZodSymbol:return;default:return(r=>{})()}};function se(n,e,t=!1){var o;const r=e.seen.get(n);if(e.override){const l=(o=e.override)==null?void 0:o.call(e,n,e,r,t);if(l!==Tm)return l}if(r&&!t){const l=Oy(r,e);if(l!==void 0)return l}const s={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,s);const a=ky(n,n.typeName,e),i=typeof a=="function"?se(a(),e):a;if(i&&Py(n,e,i),e.postProcess){const l=e.postProcess(i,n,e);return s.jsonSchema=i,l}return s.jsonSchema=i,i}const Oy=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Gc(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),ke(e)):e.$refStrategy==="seen"?ke(e):void 0}},Py=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),Ny=(n,e)=>{const t=Am(e);let r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((o,[l,c])=>({...o,[l]:se(c._def,{...t,currentPath:[...t.basePath,t.definitionPath,l]},!0)??ke(t)}),{}):void 0;const s=typeof e=="string"?e:e==null?void 0:e.name,a=se(n._def,t,!1)??ke(t);t.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[t.openAiAnyTypeName]||(r[t.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:t.$refStrategy==="relative"?"1":[...t.basePath,t.definitionPath,t.openAiAnyTypeName].join("/")}}));const i=s===void 0?r?{...a,[t.definitionPath]:r}:a:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...r,[s]:a}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i};function qt(n,e){const t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;const r=n.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!qt(n[s],e[s]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;const r=Object.keys(n),s=Object.keys(e);if(r.length!==s.length)return!1;for(const i of r)if(!qt(n[i],e[i]))return!1;return!0}return n===e}function Ve(n){return encodeURI(Ly(n))}function Ly(n){return n.replace(/~/g,"~0").replace(/\//g,"~1")}const My={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},jy={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},Dy={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let Uy=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function gt(n,e=Object.create(null),t=Uy,r=""){if(n&&typeof n=="object"&&!Array.isArray(n)){const a=n.$id||n.id;if(a){const i=new URL(a,t.href);i.hash.length>1?e[i.href]=n:(i.hash="",r===""?t=i:gt(n,e,t))}}else if(n!==!0&&n!==!1)return e;const s=t.href+(r?"#"+r:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=n,n===!0||n===!1)return e;if(n.__absolute_uri__===void 0&&Object.defineProperty(n,"__absolute_uri__",{enumerable:!1,value:s}),n.$ref&&n.__absolute_ref__===void 0){const a=new URL(n.$ref,t.href);a.hash=a.hash,Object.defineProperty(n,"__absolute_ref__",{enumerable:!1,value:a.href})}if(n.$recursiveRef&&n.__absolute_recursive_ref__===void 0){const a=new URL(n.$recursiveRef,t.href);a.hash=a.hash,Object.defineProperty(n,"__absolute_recursive_ref__",{enumerable:!1,value:a.href})}if(n.$anchor){const a=new URL("#"+n.$anchor,t.href);e[a.href]=n}for(let a in n){if(Dy[a])continue;const i=`${r}/${Ve(a)}`,o=n[a];if(Array.isArray(o)){if(My[a]){const l=o.length;for(let c=0;c<l;c++)gt(o[c],e,t,`${i}/${c}`)}}else if(jy[a])for(let l in o)gt(o[l],e,t,`${i}/${Ve(l)}`);else gt(o,e,t,i)}return e}const Fy=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,By=[0,31,28,31,30,31,30,31,31,30,31,30,31],zy=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,Vy=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,qy=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,Gy=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,Hy=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,Zy=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,Jy=/^(?:\/(?:[^~/]|~0|~1)*)*$/,Wy=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,Ky=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,Yy=n=>{if(n[0]==='"')return!1;const[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},Xy=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,Qy=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,eg=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function Qe(n){return n.test.bind(n)}const gl={date:tu,time:ru.bind(void 0,!1),"date-time":ng,duration:eg,uri:ig,"uri-reference":Qe(qy),"uri-template":Qe(Gy),url:Qe(Hy),email:Yy,hostname:Qe(Vy),ipv4:Qe(Xy),ipv6:Qe(Qy),regex:lg,uuid:Qe(Zy),"json-pointer":Qe(Jy),"json-pointer-uri-fragment":Qe(Wy),"relative-json-pointer":Qe(Ky)};function tg(n){return n%4===0&&(n%100!==0||n%400===0)}function tu(n){const e=n.match(Fy);if(!e)return!1;const t=+e[1],r=+e[2],s=+e[3];return r>=1&&r<=12&&s>=1&&s<=(r==2&&tg(t)?29:By[r])}function ru(n,e){const t=e.match(zy);if(!t)return!1;const r=+t[1],s=+t[2],a=+t[3],i=!!t[5];return(r<=23&&s<=59&&a<=59||r==23&&s==59&&a==60)&&(!n||i)}const rg=/t|\s/i;function ng(n){const e=n.split(rg);return e.length==2&&tu(e[0])&&ru(!0,e[1])}const sg=/\/|:/,ag=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function ig(n){return sg.test(n)&&ag.test(n)}const og=/[^\\]\\Z/;function lg(n){if(og.test(n))return!1;try{return new RegExp(n,"u"),!0}catch{return!1}}function cg(n){let e=0,t=n.length,r=0,s;for(;r<t;)e++,s=n.charCodeAt(r++),s>=55296&&s<=56319&&r<t&&(s=n.charCodeAt(r),(s&64512)==56320&&r++);return e}function ce(n,e,t="2019-09",r=gt(e),s=!0,a=null,i="#",o="#",l=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:i,keyword:"false",keywordLocation:i,error:"False boolean schema."}]};const c=typeof n;let u;switch(c){case"boolean":case"number":case"string":u=c;break;case"object":n===null?u="null":Array.isArray(n)?u="array":u="object";break;default:throw new Error(`Instances of "${c}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:f,type:p,const:_,enum:g,required:y,not:w,anyOf:v,allOf:E,oneOf:b,if:x,then:N,else:I,format:le,properties:ve,patternProperties:Pe,additionalProperties:Fe,unevaluatedProperties:Ut,minProperties:$,maxProperties:A,propertyNames:z,dependentRequired:j,dependentSchemas:V,dependencies:D,prefixItems:H,items:ee,additionalItems:X,unevaluatedItems:oe,contains:_e,minContains:ae,maxContains:Ye,minItems:zn,maxItems:Vn,uniqueItems:Cu,minimum:xt,maximum:It,exclusiveMinimum:ar,exclusiveMaximum:ir,multipleOf:jr,minLength:Dr,maxLength:Ur,pattern:pi,__absolute_ref__:Fr,__absolute_recursive_ref__:ku}=e,k=[];if(f===!0&&a===null&&(a=e),h==="#"){const q=a===null?r[ku]:a,F=`${o}/$recursiveRef`,J=ce(n,a===null?e:a,t,r,s,q,i,F,l);J.valid||k.push({instanceLocation:i,keyword:"$recursiveRef",keywordLocation:F,error:"A subschema had errors."},...J.errors)}if(d!==void 0){const F=r[Fr||d];if(F===void 0){let R=`Unresolved $ref "${d}".`;throw Fr&&Fr!==d&&(R+=`  Absolute URI "${Fr}".`),R+=`
Known schemas:
- ${Object.keys(r).join(`
- `)}`,new Error(R)}const J=`${o}/$ref`,P=ce(n,F,t,r,s,a,i,J,l);if(P.valid||k.push({instanceLocation:i,keyword:"$ref",keywordLocation:J,error:"A subschema had errors."},...P.errors),t==="4"||t==="7")return{valid:k.length===0,errors:k}}if(Array.isArray(p)){let q=p.length,F=!1;for(let J=0;J<q;J++)if(u===p[J]||p[J]==="integer"&&u==="number"&&n%1===0&&n===n){F=!0;break}F||k.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${p.join('", "')}".`})}else p==="integer"?(u!=="number"||n%1||n!==n)&&k.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${p}".`}):p!==void 0&&u!==p&&k.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${p}".`});if(_!==void 0&&(u==="object"||u==="array"?qt(n,_)||k.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(_)}.`}):n!==_&&k.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(_)}.`})),g!==void 0&&(u==="object"||u==="array"?g.some(q=>qt(n,q))||k.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some(q=>n===q)||k.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),w!==void 0){const q=`${o}/not`;ce(n,w,t,r,s,a,i,q).valid&&k.push({instanceLocation:i,keyword:"not",keywordLocation:q,error:'Instance matched "not" schema.'})}let Br=[];if(v!==void 0){const q=`${o}/anyOf`,F=k.length;let J=!1;for(let P=0;P<v.length;P++){const R=v[P],Z=Object.create(l),G=ce(n,R,t,r,s,f===!0?a:null,i,`${q}/${P}`,Z);k.push(...G.errors),J=J||G.valid,G.valid&&Br.push(Z)}J?k.length=F:k.splice(F,0,{instanceLocation:i,keyword:"anyOf",keywordLocation:q,error:"Instance does not match any subschemas."})}if(E!==void 0){const q=`${o}/allOf`,F=k.length;let J=!0;for(let P=0;P<E.length;P++){const R=E[P],Z=Object.create(l),G=ce(n,R,t,r,s,f===!0?a:null,i,`${q}/${P}`,Z);k.push(...G.errors),J=J&&G.valid,G.valid&&Br.push(Z)}J?k.length=F:k.splice(F,0,{instanceLocation:i,keyword:"allOf",keywordLocation:q,error:"Instance does not match every subschema."})}if(b!==void 0){const q=`${o}/oneOf`,F=k.length,J=b.filter((P,R)=>{const Z=Object.create(l),G=ce(n,P,t,r,s,f===!0?a:null,i,`${q}/${R}`,Z);return k.push(...G.errors),G.valid&&Br.push(Z),G.valid}).length;J===1?k.length=F:k.splice(F,0,{instanceLocation:i,keyword:"oneOf",keywordLocation:q,error:`Instance does not match exactly one subschema (${J} matches).`})}if((u==="object"||u==="array")&&Object.assign(l,...Br),x!==void 0){const q=`${o}/if`;if(ce(n,x,t,r,s,a,i,q,l).valid){if(N!==void 0){const J=ce(n,N,t,r,s,a,i,`${o}/then`,l);J.valid||k.push({instanceLocation:i,keyword:"if",keywordLocation:q,error:'Instance does not match "then" schema.'},...J.errors)}}else if(I!==void 0){const J=ce(n,I,t,r,s,a,i,`${o}/else`,l);J.valid||k.push({instanceLocation:i,keyword:"if",keywordLocation:q,error:'Instance does not match "else" schema.'},...J.errors)}}if(u==="object"){if(y!==void 0)for(const P of y)P in n||k.push({instanceLocation:i,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${P}".`});const q=Object.keys(n);if($!==void 0&&q.length<$&&k.push({instanceLocation:i,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${$} properties.`}),A!==void 0&&q.length>A&&k.push({instanceLocation:i,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${A} properties.`}),z!==void 0){const P=`${o}/propertyNames`;for(const R in n){const Z=`${i}/${Ve(R)}`,G=ce(R,z,t,r,s,a,Z,P);G.valid||k.push({instanceLocation:i,keyword:"propertyNames",keywordLocation:P,error:`Property name "${R}" does not match schema.`},...G.errors)}}if(j!==void 0){const P=`${o}/dependantRequired`;for(const R in j)if(R in n){const Z=j[R];for(const G of Z)G in n||k.push({instanceLocation:i,keyword:"dependentRequired",keywordLocation:P,error:`Instance has "${R}" but does not have "${G}".`})}}if(V!==void 0)for(const P in V){const R=`${o}/dependentSchemas`;if(P in n){const Z=ce(n,V[P],t,r,s,a,i,`${R}/${Ve(P)}`,l);Z.valid||k.push({instanceLocation:i,keyword:"dependentSchemas",keywordLocation:R,error:`Instance has "${P}" but does not match dependant schema.`},...Z.errors)}}if(D!==void 0){const P=`${o}/dependencies`;for(const R in D)if(R in n){const Z=D[R];if(Array.isArray(Z))for(const G of Z)G in n||k.push({instanceLocation:i,keyword:"dependencies",keywordLocation:P,error:`Instance has "${R}" but does not have "${G}".`});else{const G=ce(n,Z,t,r,s,a,i,`${P}/${Ve(R)}`);G.valid||k.push({instanceLocation:i,keyword:"dependencies",keywordLocation:P,error:`Instance has "${R}" but does not match dependant schema.`},...G.errors)}}}const F=Object.create(null);let J=!1;if(ve!==void 0){const P=`${o}/properties`;for(const R in ve){if(!(R in n))continue;const Z=`${i}/${Ve(R)}`,G=ce(n[R],ve[R],t,r,s,a,Z,`${P}/${Ve(R)}`);if(G.valid)l[R]=F[R]=!0;else if(J=s,k.push({instanceLocation:i,keyword:"properties",keywordLocation:P,error:`Property "${R}" does not match schema.`},...G.errors),J)break}}if(!J&&Pe!==void 0){const P=`${o}/patternProperties`;for(const R in Pe){const Z=new RegExp(R,"u"),G=Pe[R];for(const Ae in n){if(!Z.test(Ae))continue;const mi=`${i}/${Ve(Ae)}`,yi=ce(n[Ae],G,t,r,s,a,mi,`${P}/${Ve(R)}`);yi.valid?l[Ae]=F[Ae]=!0:(J=s,k.push({instanceLocation:i,keyword:"patternProperties",keywordLocation:P,error:`Property "${Ae}" matches pattern "${R}" but does not match associated schema.`},...yi.errors))}}}if(!J&&Fe!==void 0){const P=`${o}/additionalProperties`;for(const R in n){if(F[R])continue;const Z=`${i}/${Ve(R)}`,G=ce(n[R],Fe,t,r,s,a,Z,P);G.valid?l[R]=!0:(J=s,k.push({instanceLocation:i,keyword:"additionalProperties",keywordLocation:P,error:`Property "${R}" does not match additional properties schema.`},...G.errors))}}else if(!J&&Ut!==void 0){const P=`${o}/unevaluatedProperties`;for(const R in n)if(!l[R]){const Z=`${i}/${Ve(R)}`,G=ce(n[R],Ut,t,r,s,a,Z,P);G.valid?l[R]=!0:k.push({instanceLocation:i,keyword:"unevaluatedProperties",keywordLocation:P,error:`Property "${R}" does not match unevaluated properties schema.`},...G.errors)}}}else if(u==="array"){Vn!==void 0&&n.length>Vn&&k.push({instanceLocation:i,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${n.length} > ${Vn}).`}),zn!==void 0&&n.length<zn&&k.push({instanceLocation:i,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${n.length} < ${zn}).`});const q=n.length;let F=0,J=!1;if(H!==void 0){const P=`${o}/prefixItems`,R=Math.min(H.length,q);for(;F<R;F++){const Z=ce(n[F],H[F],t,r,s,a,`${i}/${F}`,`${P}/${F}`);if(l[F]=!0,!Z.valid&&(J=s,k.push({instanceLocation:i,keyword:"prefixItems",keywordLocation:P,error:"Items did not match schema."},...Z.errors),J))break}}if(ee!==void 0){const P=`${o}/items`;if(Array.isArray(ee)){const R=Math.min(ee.length,q);for(;F<R;F++){const Z=ce(n[F],ee[F],t,r,s,a,`${i}/${F}`,`${P}/${F}`);if(l[F]=!0,!Z.valid&&(J=s,k.push({instanceLocation:i,keyword:"items",keywordLocation:P,error:"Items did not match schema."},...Z.errors),J))break}}else for(;F<q;F++){const R=ce(n[F],ee,t,r,s,a,`${i}/${F}`,P);if(l[F]=!0,!R.valid&&(J=s,k.push({instanceLocation:i,keyword:"items",keywordLocation:P,error:"Items did not match schema."},...R.errors),J))break}if(!J&&X!==void 0){const R=`${o}/additionalItems`;for(;F<q;F++){const Z=ce(n[F],X,t,r,s,a,`${i}/${F}`,R);l[F]=!0,Z.valid||(J=s,k.push({instanceLocation:i,keyword:"additionalItems",keywordLocation:R,error:"Items did not match additional items schema."},...Z.errors))}}}if(_e!==void 0)if(q===0&&ae===void 0)k.push({instanceLocation:i,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(ae!==void 0&&q<ae)k.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${q}) than minContains (${ae}).`});else{const P=`${o}/contains`,R=k.length;let Z=0;for(let G=0;G<q;G++){const Ae=ce(n[G],_e,t,r,s,a,`${i}/${G}`,P);Ae.valid?(l[G]=!0,Z++):k.push(...Ae.errors)}Z>=(ae||0)&&(k.length=R),ae===void 0&&Ye===void 0&&Z===0?k.splice(R,0,{instanceLocation:i,keyword:"contains",keywordLocation:P,error:"Array does not contain item matching schema."}):ae!==void 0&&Z<ae?k.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${ae} items matching schema. Only ${Z} items were found.`}):Ye!==void 0&&Z>Ye&&k.push({instanceLocation:i,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${Ye} items matching schema. ${Z} items were found.`})}if(!J&&oe!==void 0){const P=`${o}/unevaluatedItems`;for(F;F<q;F++){if(l[F])continue;const R=ce(n[F],oe,t,r,s,a,`${i}/${F}`,P);l[F]=!0,R.valid||k.push({instanceLocation:i,keyword:"unevaluatedItems",keywordLocation:P,error:"Items did not match unevaluated items schema."},...R.errors)}}if(Cu)for(let P=0;P<q;P++){const R=n[P],Z=typeof R=="object"&&R!==null;for(let G=0;G<q;G++){if(P===G)continue;const Ae=n[G];(R===Ae||Z&&(typeof Ae=="object"&&Ae!==null)&&qt(R,Ae))&&(k.push({instanceLocation:i,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${P} and ${G}.`}),P=Number.MAX_SAFE_INTEGER,G=Number.MAX_SAFE_INTEGER)}}}else if(u==="number"){if(t==="4"?(xt!==void 0&&(ar===!0&&n<=xt||n<xt)&&k.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${n} is less than ${ar?"or equal to ":""} ${xt}.`}),It!==void 0&&(ir===!0&&n>=It||n>It)&&k.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${n} is greater than ${ir?"or equal to ":""} ${It}.`})):(xt!==void 0&&n<xt&&k.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${n} is less than ${xt}.`}),It!==void 0&&n>It&&k.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${n} is greater than ${It}.`}),ar!==void 0&&n<=ar&&k.push({instanceLocation:i,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${n} is less than ${ar}.`}),ir!==void 0&&n>=ir&&k.push({instanceLocation:i,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${n} is greater than or equal to ${ir}.`})),jr!==void 0){const q=n%jr;Math.abs(0-q)>=11920929e-14&&Math.abs(jr-q)>=11920929e-14&&k.push({instanceLocation:i,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${n} is not a multiple of ${jr}.`})}}else if(u==="string"){const q=Dr===void 0&&Ur===void 0?0:cg(n);Dr!==void 0&&q<Dr&&k.push({instanceLocation:i,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${q} < ${Dr}).`}),Ur!==void 0&&q>Ur&&k.push({instanceLocation:i,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${q} > ${Ur}).`}),pi!==void 0&&!new RegExp(pi,"u").test(n)&&k.push({instanceLocation:i,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),le!==void 0&&gl[le]&&!gl[le](n)&&k.push({instanceLocation:i,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${le}".`})}return{valid:k.length===0,errors:k}}class ug{constructor(e,t="2019-09",r=!0){m(this,"schema");m(this,"draft");m(this,"shortCircuit");m(this,"lookup");this.schema=e,this.draft=t,this.shortCircuit=r,this.lookup=gt(e)}validate(e){return ce(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,t){t&&(e={...e,$id:t}),gt(e,this.lookup)}}var dg={};fe(dg,{Validator:()=>ug,deepCompareStrict:()=>qt,toJsonSchema:()=>nu,validatesOnlyStrings:()=>tn});function nu(n){if(ut(n)){const e=ur(n,!0);if(gr(e)){const t=Ea(e,!0);return Xo(t)}else return Xo(n)}return Tt(n)?Ny(n):n}function tn(n){if(!n||typeof n!="object"||Object.keys(n).length===0||Array.isArray(n))return!1;if("type"in n)return typeof n.type=="string"?n.type==="string":Array.isArray(n.type)?n.type.every(e=>e==="string"):!1;if("enum"in n)return Array.isArray(n.enum)&&n.enum.length>0&&n.enum.every(e=>typeof e=="string");if("const"in n)return typeof n.const=="string";if("allOf"in n&&Array.isArray(n.allOf))return n.allOf.some(e=>tn(e));if("anyOf"in n&&Array.isArray(n.anyOf)||"oneOf"in n&&Array.isArray(n.oneOf)){const e="anyOf"in n?n.anyOf:n.oneOf;return e.length>0&&e.every(t=>tn(t))}if("not"in n)return!1;if("$ref"in n&&typeof n.$ref=="string"){const e=n.$ref,t=gt(n);return t[e]?tn(t[e]):!1}return!1}var hg={};fe(hg,{Graph:()=>ai});function fg(n,e){if(n!==void 0&&!mr(n))return n;if(ei(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function pg(n){return ei(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...nu(n.data.schema),title:n.data.name}}}var ai=class su{constructor(e){m(this,"nodes",{});m(this,"edges",[]);this.nodes=(e==null?void 0:e.nodes)??this.nodes,this.edges=(e==null?void 0:e.edges)??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=mr(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...pg(t)})),edges:this.edges.map(t=>{const r={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(r.data=t.data),typeof t.conditional<"u"&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const s=t??Te(),a={id:s,data:e,name:fg(t,e),metadata:r};return this.nodes[s]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const a={source:e.id,target:t.id,data:r,conditional:s};return this.edges.push(a),a}firstNode(){return _l(this)}lastNode(){return vl(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(c=>c.id).every(mr)&&(r="");const a=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,u])=>{this.nodes[a(c)]={...u,id:a(c)}});const i=e.edges.map(c=>({...c,source:a(c.source),target:a(c.target)}));this.edges=[...this.edges,...i];const o=e.firstNode(),l=e.lastNode();return[o?{id:a(o.id),data:o.data}:void 0,l?{id:a(l.id),data:l.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&_l(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&vl(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),t=new Map;Object.values(e).forEach(s=>{t.set(s,(t.get(s)||0)+1)});const r=s=>{const a=e[s];return mr(s)&&t.get(a)===1?a:s};return new su({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,a])=>[r(s),{...a,id:r(s)}])),edges:this.edges.map(s=>({...s,source:r(s.source),target:r(s.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},i=this.reid(),o=i.firstNode(),l=i.lastNode();return Em(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:l==null?void 0:l.id,withStyles:t,curveStyle:r,nodeColors:s,wrapLabelNWords:a})}async drawMermaidPng(e){const t=this.drawMermaid(e);return Sm(t,{backgroundColor:e==null?void 0:e.backgroundColor})}};function _l(n,e=[]){const t=new Set(n.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),r=[];for(const s of Object.values(n.nodes))!e.includes(s.id)&&!t.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function vl(n,e=[]){const t=new Set(n.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),r=[];for(const s of Object.values(n.nodes))!e.includes(s.id)&&!t.has(s.id)&&r.push(s);return r.length===1?r[0]:void 0}function mg(n){const e=new TextEncoder,t=new ReadableStream({async start(r){for await(const s of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return Je.fromReadableStream(t)}function wl(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}const yg=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function $a(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*bl(n,e){for(;;){const{value:t,done:r}=lt.runWithConfig(Ct(n),e.next.bind(e),!0);if(r)break;yield t}}async function*Ca(n,e){const t=e[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await lt.runWithConfig(Ct(n),t.next.bind(e),!0);if(s)break;yield r}}function ge(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var he=class extends Gt{constructor(){super(...arguments);m(this,"lc_runnable",!0);m(this,"name")}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}withRetry(e){return new ii({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Pt({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new uu({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(ne);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:t},(s,a)=>ne(a===0?e:r))}return Array.from({length:t},()=>ne(e))}async batch(e,t,r){var l;const s=this._getOptionsList(t??{},e.length),a=((l=s[0])==null?void 0:l.maxConcurrency)??(r==null?void 0:r.maxConcurrency),i=new Fc({maxConcurrency:a,onFailedAttempt:c=>{throw c}}),o=e.map((c,u)=>i.call(async()=>{try{return await this.invoke(c,s[u])}catch(d){if(r!=null&&r.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=ne(t),s=new Dt({generator:this._streamIterator(e,r),config:r});return await s.setup,Je.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=ne(e):t=ne({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const s=ne(r),a=await Le(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),ge(t,"input"),s.runId,s==null?void 0:s.runType,void 0,void 0,(s==null?void 0:s.runName)??this.getName()));delete s.runId;let o;try{const l=e.call(this,t,s,i);o=await bt(l,r==null?void 0:r.signal)}catch(l){throw await(i==null?void 0:i.handleChainError(l)),l}return await(i==null?void 0:i.handleChainEnd(ge(o,"output"))),o}async _batchWithConfig(e,t,r,s){var c;const a=this._getOptionsList(r??{},t.length),i=await Promise.all(a.map(Le)),o=await Promise.all(i.map(async(u,d)=>{const h=await(u==null?void 0:u.handleChainStart(this.toJSON(),ge(t[d],"input"),a[d].runId,a[d].runType,void 0,void 0,a[d].runName??this.getName()));return delete a[d].runId,h}));let l;try{const u=e.call(this,t,a,o,s);l=await bt(u,(c=a==null?void 0:a[0])==null?void 0:c.signal)}catch(u){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(u))),u}return await Promise.all(o.map(u=>u==null?void 0:u.handleChainEnd(ge(l,"output")))),l}_concatOutputChunks(e,t){return Zt(e,t)}async*_transformStreamWithConfig(e,t,r){let s,a=!0,i,o=!0;const l=ne(r),c=await Le(l),u=this;async function*d(){for await(const f of e){if(a)if(s===void 0)s=f;else try{s=u._concatOutputChunks(s,f)}catch{s=void 0,a=!1}yield f}}let h;try{const f=await Nc(t.bind(this),d(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},l.runId,l.runType,void 0,void 0,l.runName??this.getName()),r==null?void 0:r.signal,l);delete l.runId,h=f.setup;const p=h==null?void 0:h.handlers.find(Gp);let _=f.output;p!==void 0&&h!==void 0&&(_=p.tapOutputIterable(h.runId,_));const g=h==null?void 0:h.handlers.find(jc);g!==void 0&&h!==void 0&&(_=g.tapOutputIterable(h.runId,_));for await(const y of _)if(yield y,o)if(i===void 0)i=y;else try{i=this._concatOutputChunks(i,y)}catch{i=void 0,o=!1}}catch(f){throw await(h==null?void 0:h.handleChainError(f,void 0,void 0,void 0,{inputs:ge(s,"input")})),f}await(h==null?void 0:h.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:ge(s,"input")}))}getGraph(e){const t=new ai,r=t.addNode({name:`${this.getName()}Input`,schema:pl()}),s=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:pl()});return t.addEdge(r,s),t.addEdge(s,a),t}pipe(e){return new Un({first:this,last:Ge(e)})}pick(e){return this.pipe(new du(e))}assign(e){return this.pipe(new oi(new nr({steps:e})))}async*transform(e,t){let r;for await(const s of e)r===void 0?r=s:r=this._concatOutputChunks(r,s);yield*this._streamIterator(r,ne(t))}async*streamLog(e,t,r){const s=new wa({...r,autoClose:!1,_schemaFormat:"original"}),a=ne(t);yield*this._streamLog(e,s,a)}async*_streamLog(e,t,r){const{callbacks:s}=r;if(s===void 0)r.callbacks=[t];else if(Array.isArray(s))r.callbacks=s.concat([t]);else{const l=s.copy();l.addHandler(t,!0),r.callbacks=l}const a=this.stream(e,r);async function i(){try{const l=await a;for await(const c of l){const u=new st({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(u)}}finally{await t.writer.close()}}const o=i();try{for await(const l of t)yield l}finally{await o}}streamEvents(e,t,r){let s;if(t.version==="v1")s=this._streamEventsV1(e,t,r);else if(t.version==="v2")s=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?mg(s):Je.fromAsyncGenerator(s)}async*_streamEventsV2(e,t,r){var p;const s=new Hp({...r,autoClose:!1}),a=ne(t),i=a.runId??Te();a.runId=i;const o=a.callbacks;if(o===void 0)a.callbacks=[s];else if(Array.isArray(o))a.callbacks=o.concat(s);else{const _=o.copy();_.addHandler(s,!0),a.callbacks=_}const l=new AbortController,c=this;async function u(){let _,g=null;try{t!=null&&t.signal?"any"in AbortSignal?_=AbortSignal.any([l.signal,t.signal]):(_=t.signal,g=()=>{l.abort()},t.signal.addEventListener("abort",g,{once:!0})):_=l.signal;const y=await c.stream(e,{...a,signal:_}),w=s.tapOutputIterable(i,y);for await(const v of w)if(l.signal.aborted)break}finally{await s.finish(),_&&g&&_.removeEventListener("abort",g)}}const d=u();let h=!1,f;try{for await(const _ of s){if(!h){_.data.input=e,h=!0,f=_.run_id,yield _;continue}_.run_id===f&&_.event.endsWith("_end")&&(p=_.data)!=null&&p.input&&delete _.data.input,yield _}}finally{l.abort(),await d}}async*_streamEventsV1(e,t,r){let s,a=!1;const i=ne(t),o=i.tags??[],l=i.metadata??{},c=i.runName??this.getName(),u=new wa({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new Kp({...r}),h=this._streamLog(e,u,i);for await(const p of h){if(s?s=s.concat(p):s=Qa.fromRunLogPatch(p),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const w={...s.state},v={run_id:w.id,event:`on_${w.type}_start`,name:c,tags:o,metadata:l,data:{input:e}};d.includeEvent(v,w.type)&&(yield v)}const _=p.ops.filter(w=>w.path.startsWith("/logs/")).map(w=>w.path.split("/")[2]),g=[...new Set(_)];for(const w of g){let v,E={};const b=s.state.logs[w];if(b.end_time===void 0?b.streamed_output.length>0?v="stream":v="start":v="end",v==="start")b.inputs!==void 0&&(E.input=b.inputs);else if(v==="end")b.inputs!==void 0&&(E.input=b.inputs),E.output=b.final_output;else if(v==="stream"){const x=b.streamed_output.length;if(x!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${x} instead. Encountered in: "${b.name}"`);E={chunk:b.streamed_output[0]},b.streamed_output=[]}yield{event:`on_${b.type}_${v}`,name:b.name,run_id:b.id,tags:b.tags,metadata:b.metadata,data:E}}const{state:y}=s;if(y.streamed_output.length>0){const w=y.streamed_output.length;if(w!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${w} instead. Encountered in: "${y.name}"`);const v={chunk:y.streamed_output[0]};y.streamed_output=[];const E={event:`on_${y.type}_stream`,run_id:y.id,tags:o,metadata:l,name:c,data:v};d.includeEvent(E,y.type)&&(yield E)}}const f=s==null?void 0:s.state;if(f!==void 0){const p={event:`on_${f.type}_end`,name:c,run_id:f.id,tags:o,metadata:l,data:{output:f.final_output}};d.includeEvent(p,f.type)&&(yield p)}}static isRunnable(e){return ei(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Pt({bound:this,config:{},configFactories:[s=>({callbacks:[new Bc({config:s,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return bg(this,e)}},Pt=class au extends he{constructor(t){super(t);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"bound");m(this,"config");m(this,"kwargs");m(this,"configFactories");this.bound=t.bound,this.kwargs=t.kwargs,this.config=t.config,this.configFactories=t.configFactories}static lc_name(){return"RunnableBinding"}getName(t){return this.bound.getName(t)}async _mergeConfig(...t){const r=ma(this.config,...t);return ma(r,...this.configFactories?await Promise.all(this.configFactories.map(async s=>await s(r))):[])}withConfig(t){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...t}})}withRetry(t){return new ii({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:t==null?void 0:t.stopAfterAttempt,...t})}async invoke(t,r){return this.bound.invoke(t,await this._mergeConfig(r,this.kwargs))}async batch(t,r,s){const a=Array.isArray(r)?await Promise.all(r.map(async i=>this._mergeConfig(ne(i),this.kwargs))):await this._mergeConfig(ne(r),this.kwargs);return this.bound.batch(t,a,s)}_concatOutputChunks(t,r){return this.bound._concatOutputChunks(t,r)}async*_streamIterator(t,r){yield*this.bound._streamIterator(t,await this._mergeConfig(ne(r),this.kwargs))}async stream(t,r){return this.bound.stream(t,await this._mergeConfig(ne(r),this.kwargs))}async*transform(t,r){yield*this.bound.transform(t,await this._mergeConfig(ne(r),this.kwargs))}streamEvents(t,r,s){const a=this,i=async function*(){yield*a.bound.streamEvents(t,{...await a._mergeConfig(ne(r),a.kwargs),version:r.version},s)};return Je.fromAsyncGenerator(i())}static isRunnableBinding(t){return t.bound&&he.isRunnable(t.bound)}withListeners({onStart:t,onEnd:r,onError:s}){return new au({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new Bc({config:a,onStart:t,onEnd:r,onError:s})]})]})}},gg=class iu extends he{constructor(t){super(t);m(this,"lc_serializable",!0);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"bound");this.bound=t.bound}static lc_name(){return"RunnableEach"}async invoke(t,r){return this._callWithConfig(this._invoke.bind(this),t,r)}async _invoke(t,r,s){return this.bound.batch(t,ue(r,{callbacks:s==null?void 0:s.getChild()}))}withListeners({onStart:t,onEnd:r,onError:s}){return new iu({bound:this.bound.withListeners({onStart:t,onEnd:r,onError:s})})}},ii=class extends Pt{constructor(e){super(e);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"maxAttemptNumber",3);m(this,"onFailedAttempt",()=>{});this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}static lc_name(){return"RunnableRetry"}_patchConfigForRetry(e,t,r){const s=e>1?`retry:attempt:${e}`:void 0;return ue(t,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,t,r){return ln(s=>super.invoke(e,this._patchConfigForRetry(s,t,r)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,s){const a={};try{await ln(async i=>{const o=e.map((h,f)=>f).filter(h=>a[h.toString()]===void 0||a[h.toString()]instanceof Error),l=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),u=await super.batch(l,c,{...s,returnExceptions:!0});let d;for(let h=0;h<u.length;h+=1){const f=u[h],p=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=l[h]),a[p.toString()]=f}if(d)throw d;return u},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((s==null?void 0:s.returnExceptions)!==!0)throw i}return Object.keys(a).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>a[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Un=class hr extends he{constructor(t){super(t);m(this,"first");m(this,"middle",[]);m(this,"last");m(this,"omitSequenceTags",!1);m(this,"lc_serializable",!0);m(this,"lc_namespace",["langchain_core","runnables"]);this.first=t.first,this.middle=t.middle??this.middle,this.last=t.last,this.name=t.name,this.omitSequenceTags=t.omitSequenceTags??this.omitSequenceTags}static lc_name(){return"RunnableSequence"}get steps(){return[this.first,...this.middle,this.last]}async invoke(t,r){var c;const s=ne(r),a=await Le(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),ge(t,"input"),s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;let o=t,l;try{const u=[this.first,...this.middle];for(let d=0;d<u.length;d+=1){const f=u[d].invoke(o,ue(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${d+1}`)}));o=await bt(f,r==null?void 0:r.signal)}if((c=r==null?void 0:r.signal)!=null&&c.aborted)throw dn(r.signal);l=await this.last.invoke(o,ue(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await(i==null?void 0:i.handleChainError(u)),u}return await(i==null?void 0:i.handleChainEnd(ge(l,"output"))),l}async batch(t,r,s){var c;const a=this._getOptionsList(r??{},t.length),i=await Promise.all(a.map(Le)),o=await Promise.all(i.map(async(u,d)=>{const h=await(u==null?void 0:u.handleChainStart(this.toJSON(),ge(t[d],"input"),a[d].runId,void 0,void 0,void 0,a[d].runName));return delete a[d].runId,h}));let l=t;try{for(let u=0;u<this.steps.length;u+=1){const h=this.steps[u].batch(l,o.map((f,p)=>{const _=f==null?void 0:f.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return ue(a[p],{callbacks:_})}),s);l=await bt(h,(c=a[0])==null?void 0:c.signal)}}catch(u){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(u))),u}return await Promise.all(o.map(u=>u==null?void 0:u.handleChainEnd(ge(l,"output")))),l}_concatOutputChunks(t,r){return this.last._concatOutputChunks(t,r)}async*_streamIterator(t,r){var h;const s=await Le(r),{runId:a,...i}=r??{},o=await(s==null?void 0:s.handleChainStart(this.toJSON(),ge(t,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName)),l=[this.first,...this.middle,this.last];let c=!0,u;async function*d(){yield t}try{let f=l[0].transform(d(),ue(i,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let p=1;p<l.length;p+=1)f=await l[p].transform(f,ue(i,{callbacks:o==null?void 0:o.getChild(this.omitSequenceTags?void 0:`seq:step:${p+1}`)}));for await(const p of f)if((h=r==null?void 0:r.signal)==null||h.throwIfAborted(),yield p,c)if(u===void 0)u=p;else try{u=this._concatOutputChunks(u,p)}catch{u=void 0,c=!1}}catch(f){throw await(o==null?void 0:o.handleChainError(f)),f}await(o==null?void 0:o.handleChainEnd(ge(u,"output")))}getGraph(t){const r=new ai;let s=null;return this.steps.forEach((a,i)=>{const o=a.getGraph(t);i!==0&&o.trimFirstNode(),i!==this.steps.length-1&&o.trimLastNode(),r.extend(o);const l=o.firstNode();if(!l)throw new Error(`Runnable ${a} has no first node`);s&&r.addEdge(s,l),s=o.lastNode()}),r}pipe(t){return hr.isRunnableSequence(t)?new hr({first:this.first,middle:this.middle.concat([this.last,t.first,...t.middle]),last:t.last,name:this.name??t.name}):new hr({first:this.first,middle:[...this.middle,this.last],last:Ge(t),name:this.name})}static isRunnableSequence(t){return Array.isArray(t.middle)&&he.isRunnable(t)}static from([t,...r],s){let a={};return typeof s=="string"?a.name=s:s!==void 0&&(a=s),new hr({...a,first:Ge(t),middle:r.slice(0,-1).map(Ge),last:Ge(r[r.length-1])})}},nr=class ou extends he{constructor(t){super(t);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"steps");this.steps={};for(const[r,s]of Object.entries(t.steps))this.steps[r]=Ge(s)}static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}static from(t){return new ou({steps:t})}async invoke(t,r){const s=ne(r),a=await Le(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:t},s.runId,void 0,void 0,void 0,s==null?void 0:s.runName));delete s.runId;const o={};try{const l=Object.entries(this.steps).map(async([c,u])=>{o[c]=await u.invoke(t,ue(s,{callbacks:i==null?void 0:i.getChild(`map:key:${c}`)}))});await bt(Promise.all(l),r==null?void 0:r.signal)}catch(l){throw await(i==null?void 0:i.handleChainError(l)),l}return await(i==null?void 0:i.handleChainEnd(o)),o}async*_transform(t,r,s){const a={...this.steps},i=Xa(t,Object.keys(a).length),o=new Map(Object.entries(a).map(([l,c],u)=>{const d=c.transform(i[u],ue(s,{callbacks:r==null?void 0:r.getChild(`map:key:${l}`)}));return[l,d.next().then(h=>({key:l,gen:d,result:h}))]}));for(;o.size;){const l=Promise.race(o.values()),{key:c,result:u,gen:d}=await bt(l,s==null?void 0:s.signal);o.delete(c),u.done||(yield{[c]:u.value},o.set(c,d.next().then(h=>({key:c,gen:d,result:h}))))}}transform(t,r){return this._transformStreamWithConfig(t,this._transform.bind(this),r)}async stream(t,r){async function*s(){yield t}const a=ne(r),i=new Dt({generator:this.transform(s(),a),config:a});return await i.setup,Je.fromAsyncGenerator(i)}},_g=class lu extends he{constructor(t){super(t);m(this,"lc_serializable",!1);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"func");if(!Ya(t.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=t.func}async invoke(t,r){const[s]=this._getOptionsList(r??{},1),a=await Le(s),i=this.func(ue(s,{callbacks:a}),t);return bt(i,s==null?void 0:s.signal)}async*_streamIterator(t,r){var i,o;const[s]=this._getOptionsList(r??{},1),a=await this.invoke(t,r);if($a(a)){for await(const l of a)(i=s==null?void 0:s.signal)==null||i.throwIfAborted(),yield l;return}if(yg(a)){for(;;){(o=s==null?void 0:s.signal)==null||o.throwIfAborted();const l=a.next();if(l.done)break;yield l.value}return}yield a}static from(t){return new lu({func:t})}};function vg(n){if(Ya(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Ze=class cu extends he{constructor(t){if(Ya(t.func))return _g.from(t.func);super(t);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"func");vg(t.func),this.func=t.func}static lc_name(){return"RunnableLambda"}static from(t){return new cu({func:t})}async _invoke(t,r,s){return new Promise((a,i)=>{const o=ue(r,{callbacks:s==null?void 0:s.getChild(),recursionLimit:((r==null?void 0:r.recursionLimit)??ta)-1});lt.runWithConfig(Ct(o),async()=>{var l,c;try{let u=await this.func(t,{...o});if(u&&he.isRunnable(u)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");u=await u.invoke(t,{...o,recursionLimit:(o.recursionLimit??ta)-1})}else if($a(u)){let d;for await(const h of Ca(o,u))if((l=r==null?void 0:r.signal)==null||l.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}u=d}else if(wl(u)){let d;for(const h of bl(o,u))if((c=r==null?void 0:r.signal)==null||c.throwIfAborted(),d===void 0)d=h;else try{d=this._concatOutputChunks(d,h)}catch{d=h}u=d}a(u)}catch(u){i(u)}})})}async invoke(t,r){return this._callWithConfig(this._invoke.bind(this),t,r)}async*_transform(t,r,s){var l,c;let a;for await(const u of t)if(a===void 0)a=u;else try{a=this._concatOutputChunks(a,u)}catch{a=u}const i=ue(s,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((s==null?void 0:s.recursionLimit)??ta)-1}),o=await new Promise((u,d)=>{lt.runWithConfig(Ct(i),async()=>{try{const h=await this.func(a,{...i,config:i});u(h)}catch(h){d(h)}})});if(o&&he.isRunnable(o)){if((s==null?void 0:s.recursionLimit)===0)throw new Error("Recursion limit reached.");const u=await o.stream(a,i);for await(const d of u)yield d}else if($a(o))for await(const u of Ca(i,o))(l=s==null?void 0:s.signal)==null||l.throwIfAborted(),yield u;else if(wl(o))for(const u of bl(i,o))(c=s==null?void 0:s.signal)==null||c.throwIfAborted(),yield u;else yield o}transform(t,r){return this._transformStreamWithConfig(t,this._transform.bind(this),r)}async stream(t,r){async function*s(){yield t}const a=ne(r),i=new Dt({generator:this.transform(s(),a),config:a});return await i.setup,Je.fromAsyncGenerator(i)}},wg=class extends nr{},uu=class extends he{constructor(e){super(e);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"runnable");m(this,"fallbacks");this.runnable=e.runnable,this.fallbacks=e.fallbacks}static lc_name(){return"RunnableWithFallbacks"}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=ne(t),s=await Le(r),{runId:a,...i}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),ge(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName)),l=ue(i,{callbacks:o==null?void 0:o.getChild()});return await lt.runWithConfig(l,async()=>{var d;let u;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{const f=await h.invoke(e,l);return await(o==null?void 0:o.handleChainEnd(ge(f,"output"))),f}catch(f){u===void 0&&(u=f)}}throw u===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(u)),u)})}async*_streamIterator(e,t){var d;const r=ne(t),s=await Le(r),{runId:a,...i}=r,o=await(s==null?void 0:s.handleChainStart(this.toJSON(),ge(e,"input"),a,void 0,void 0,void 0,i==null?void 0:i.runName));let l,c;for(const h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();const f=ue(i,{callbacks:o==null?void 0:o.getChild()});try{const p=await h.stream(e,f);c=Ca(f,p);break}catch(p){l===void 0&&(l=p)}}if(c===void 0){const h=l??new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let u;try{for await(const h of c){yield h;try{u=u===void 0?u:this._concatOutputChunks(u,h)}catch{u=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(ge(u,"output")))}async batch(e,t,r){var l;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(t??{},e.length),a=await Promise.all(s.map(c=>Le(c))),i=await Promise.all(a.map(async(c,u)=>{const d=await(c==null?void 0:c.handleChainStart(this.toJSON(),ge(e[u],"input"),s[u].runId,void 0,void 0,void 0,s[u].runName));return delete s[u].runId,d}));let o;for(const c of this.runnables()){(l=s[0].signal)==null||l.throwIfAborted();try{const u=await c.batch(e,i.map((d,h)=>ue(s[h],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(i.map((d,h)=>d==null?void 0:d.handleChainEnd(ge(u[h],"output")))),u}catch(u){o===void 0&&(o=u)}}throw o?(await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Ge(n){if(typeof n=="function")return new Ze({func:n});if(he.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=Ge(r);return new nr({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var oi=class extends he{constructor(e){e instanceof nr&&(e={mapper:e});super(e);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"mapper");this.mapper=e.mapper}static lc_name(){return"RunnableAssign"}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const s=this.mapper.getStepsKeys(),[a,i]=Xa(e),o=this.mapper.transform(i,ue(r,{callbacks:t==null?void 0:t.getChild()})),l=o.next();for await(const c of a){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const u=Object.fromEntries(Object.entries(c).filter(([d])=>!s.includes(d)));Object.keys(u).length>0&&(yield u)}yield(await l).value;for await(const c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=ne(t),a=new Dt({generator:this.transform(r(),s),config:s});return await a.setup,Je.fromAsyncGenerator(a)}},du=class extends he{constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e});super(e);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"keys");this.keys=e.keys}static lc_name(){return"RunnablePick"}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const s=ne(t),a=new Dt({generator:this.transform(r(),s),config:s});return await a.setup,Je.fromAsyncGenerator(a)}},ka=class extends Pt{constructor(e){const t=Un.from([Ze.from(async r=>{let s;if(Pl(r))try{s=await mm(this.schema,r.args)}catch{throw new Hu("Received tool input did not match expected schema",JSON.stringify(r.args))}else s=r;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}});m(this,"name");m(this,"description");m(this,"schema");this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function bg(n,e){const t=e.name??n.getName(),r=e.description??ym(e.schema);return gm(e.schema)?new ka({name:t,description:r,schema:Kc({input:en()}).transform(s=>s.input),bound:n}):new ka({name:t,description:r,schema:e.schema,bound:n})}var Nr=class extends he{constructor(e){super(e);m(this,"lc_serializable",!0);m(this,"lc_namespace",["langchain_core","prompts",this._getPromptType()]);m(this,"inputVariables");m(this,"outputParser");m(this,"partialVariables");m(this,"metadata");m(this,"tags");const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}get lc_attributes(){return{partialVariables:void 0}}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[a,i]of Object.entries(t))typeof i=="string"?r[a]=i:r[a]=await i();return{...r,...e}}async invoke(e,t){const r={...this.metadata,...t==null?void 0:t.metadata},s=[...this.tags??[],...(t==null?void 0:t.tags)??[]];return this._callWithConfig(a=>this.formatPromptValue(a),e,{...t,tags:s,metadata:r,runType:"prompt"})}},Eg={};fe(Eg,{BasePromptValue:()=>Fn,ChatPromptValue:()=>fu,ImagePromptValue:()=>pu,StringPromptValue:()=>hu});var Fn=class extends Gt{},hu=class extends Fn{constructor(e){super({value:e});m(this,"lc_namespace",["langchain_core","prompt_values"]);m(this,"lc_serializable",!0);m(this,"value");this.value=e}static lc_name(){return"StringPromptValue"}toString(){return this.value}toChatMessages(){return[new nt(this.value)]}},fu=class extends Fn{constructor(e){Array.isArray(e)&&(e={messages:e});super(e);m(this,"lc_namespace",["langchain_core","prompt_values"]);m(this,"lc_serializable",!0);m(this,"messages");this.messages=e.messages}static lc_name(){return"ChatPromptValue"}toString(){return Va(this.messages)}toChatMessages(){return this.messages}},pu=class extends Fn{constructor(e){"imageUrl"in e||(e={imageUrl:e});super(e);m(this,"lc_namespace",["langchain_core","prompt_values"]);m(this,"lc_serializable",!0);m(this,"imageUrl");m(this,"value");this.imageUrl=e.imageUrl}static lc_name(){return"ImagePromptValue"}toString(){return this.imageUrl.url}toChatMessages(){return[new nt({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},Ar=class extends Nr{async formatPromptValue(n){const e=await this.format(n);return new hu(e)}};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var Sg=Object.prototype.toString,sr=Array.isArray||function(e){return Sg.call(e)==="[object Array]"};function li(n){return typeof n=="function"}function Tg(n){return sr(n)?"array":typeof n}function oa(n){return n.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function El(n,e){return n!=null&&typeof n=="object"&&e in n}function xg(n,e){return n!=null&&typeof n!="object"&&n.hasOwnProperty&&n.hasOwnProperty(e)}var Ig=RegExp.prototype.test;function Ag(n,e){return Ig.call(n,e)}var Rg=/\S/;function $g(n){return!Ag(Rg,n)}var Cg={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function kg(n){return String(n).replace(/[&<>"'`=\/]/g,function(t){return Cg[t]})}var Og=/\s*/,Pg=/\s+/,Sl=/\s*=/,Ng=/\s*\}/,Lg=/#|\^|\/|>|\{|&|=|!/;function Mg(n,e){if(!n)return[];var t=!1,r=[],s=[],a=[],i=!1,o=!1,l="",c=0;function u(){if(i&&!o)for(;a.length;)delete s[a.pop()];else a=[];i=!1,o=!1}var d,h,f;function p(I){if(typeof I=="string"&&(I=I.split(Pg,2)),!sr(I)||I.length!==2)throw new Error("Invalid tags: "+I);d=new RegExp(oa(I[0])+"\\s*"),h=new RegExp("\\s*"+oa(I[1])),f=new RegExp("\\s*"+oa("}"+I[1]))}p(e||Oe.tags);for(var _=new Lr(n),g,y,w,v,E,b;!_.eos();){if(g=_.pos,w=_.scanUntil(d),w)for(var x=0,N=w.length;x<N;++x)v=w.charAt(x),$g(v)?(a.push(s.length),l+=v):(o=!0,t=!0,l+=" "),s.push(["text",v,g,g+1]),g+=1,v===`
`&&(u(),l="",c=0,t=!1);if(!_.scan(d))break;if(i=!0,y=_.scan(Lg)||"name",_.scan(Og),y==="="?(w=_.scanUntil(Sl),_.scan(Sl),_.scanUntil(h)):y==="{"?(w=_.scanUntil(f),_.scan(Ng),_.scanUntil(h),y="&"):w=_.scanUntil(h),!_.scan(h))throw new Error("Unclosed tag at "+_.pos);if(y==">"?E=[y,w,g,_.pos,l,c,t]:E=[y,w,g,_.pos],c++,s.push(E),y==="#"||y==="^")r.push(E);else if(y==="/"){if(b=r.pop(),!b)throw new Error('Unopened section "'+w+'" at '+g);if(b[1]!==w)throw new Error('Unclosed section "'+b[1]+'" at '+g)}else y==="name"||y==="{"||y==="&"?o=!0:y==="="&&p(w)}if(u(),b=r.pop(),b)throw new Error('Unclosed section "'+b[1]+'" at '+_.pos);return Dg(jg(s))}function jg(n){for(var e=[],t,r,s=0,a=n.length;s<a;++s)t=n[s],t&&(t[0]==="text"&&r&&r[0]==="text"?(r[1]+=t[1],r[3]=t[3]):(e.push(t),r=t));return e}function Dg(n){for(var e=[],t=e,r=[],s,a,i=0,o=n.length;i<o;++i)switch(s=n[i],s[0]){case"#":case"^":t.push(s),r.push(s),t=s[4]=[];break;case"/":a=r.pop(),a[5]=s[2],t=r.length>0?r[r.length-1][4]:e;break;default:t.push(s)}return e}function Lr(n){this.string=n,this.tail=n,this.pos=0}Lr.prototype.eos=function(){return this.tail===""};Lr.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};Lr.prototype.scanUntil=function(e){var t=this.tail.search(e),r;switch(t){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=r.length,r};function Xt(n,e){this.view=n,this.cache={".":this.view},this.parent=e}Xt.prototype.push=function(e){return new Xt(e,this)};Xt.prototype.lookup=function(e){var t=this.cache,r;if(t.hasOwnProperty(e))r=t[e];else{for(var s=this,a,i,o,l=!1;s;){if(e.indexOf(".")>0)for(a=s.view,i=e.split("."),o=0;a!=null&&o<i.length;)o===i.length-1&&(l=El(a,i[o])||xg(a,i[o])),a=a[i[o++]];else a=s.view[e],l=El(s.view,e);if(l){r=a;break}s=s.parent}t[e]=r}return li(r)&&(r=r.call(this.view)),r};function Ie(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}Ie.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};Ie.prototype.parse=function(e,t){var r=this.templateCache,s=e+":"+(t||Oe.tags).join(":"),a=typeof r<"u",i=a?r.get(s):void 0;return i==null&&(i=Mg(e,t),a&&r.set(s,i)),i};Ie.prototype.render=function(e,t,r,s){var a=this.getConfigTags(s),i=this.parse(e,a),o=t instanceof Xt?t:new Xt(t,void 0);return this.renderTokens(i,o,r,e,s)};Ie.prototype.renderTokens=function(e,t,r,s,a){for(var i="",o,l,c,u=0,d=e.length;u<d;++u)c=void 0,o=e[u],l=o[0],l==="#"?c=this.renderSection(o,t,r,s,a):l==="^"?c=this.renderInverted(o,t,r,s,a):l===">"?c=this.renderPartial(o,t,r,a):l==="&"?c=this.unescapedValue(o,t):l==="name"?c=this.escapedValue(o,t,a):l==="text"&&(c=this.rawValue(o)),c!==void 0&&(i+=c);return i};Ie.prototype.renderSection=function(e,t,r,s,a){var i=this,o="",l=t.lookup(e[1]);function c(h){return i.render(h,t,r,a)}if(l){if(sr(l))for(var u=0,d=l.length;u<d;++u)o+=this.renderTokens(e[4],t.push(l[u]),r,s,a);else if(typeof l=="object"||typeof l=="string"||typeof l=="number")o+=this.renderTokens(e[4],t.push(l),r,s,a);else if(li(l)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");l=l.call(t.view,s.slice(e[3],e[5]),c),l!=null&&(o+=l)}else o+=this.renderTokens(e[4],t,r,s,a);return o}};Ie.prototype.renderInverted=function(e,t,r,s,a){var i=t.lookup(e[1]);if(!i||sr(i)&&i.length===0)return this.renderTokens(e[4],t,r,s,a)};Ie.prototype.indentPartial=function(e,t,r){for(var s=t.replace(/[^ \t]/g,""),a=e.split(`
`),i=0;i<a.length;i++)a[i].length&&(i>0||!r)&&(a[i]=s+a[i]);return a.join(`
`)};Ie.prototype.renderPartial=function(e,t,r,s){if(r){var a=this.getConfigTags(s),i=li(r)?r(e[1]):r[e[1]];if(i!=null){var o=e[6],l=e[5],c=e[4],u=i;l==0&&c&&(u=this.indentPartial(i,c,o));var d=this.parse(u,a);return this.renderTokens(d,t,r,u,s)}}};Ie.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(r!=null)return r};Ie.prototype.escapedValue=function(e,t,r){var s=this.getConfigEscape(r)||Oe.escape,a=t.lookup(e[1]);if(a!=null)return typeof a=="number"&&s===Oe.escape?String(a):s(a)};Ie.prototype.rawValue=function(e){return e[1]};Ie.prototype.getConfigTags=function(e){return sr(e)?e:e&&typeof e=="object"?e.tags:void 0};Ie.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!sr(e))return e.escape};var Oe={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(n){Rr.templateCache=n},get templateCache(){return Rr.templateCache}},Rr=new Ie;Oe.clearCache=function(){return Rr.clearCache()};Oe.parse=function(e,t){return Rr.parse(e,t)};Oe.render=function(e,t,r,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+Tg(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Rr.render(e,t,r,s)};Oe.escape=kg;Oe.Scanner=Lr;Oe.Context=Xt;Oe.Writer=Ie;function mu(){Oe.escape=n=>n}const $r=n=>{const e=n.split(""),t=[],r=(a,i)=>{for(let o=i;o<e.length;o+=1)if(a.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")t.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")t.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const a=r("}",s);if(a<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(s+1,a).join("")}),s=a+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const a=r("{}",s),i=(a<0?e.slice(s):e.slice(s,a)).join("");t.push({type:"literal",text:i}),s=a<0?e.length:a}}return t},yu=(n,e=[])=>{const t=[];for(const r of n)if(r[0]==="name"){const s=r[1].includes(".")?r[1].split(".")[0]:r[1];t.push({type:"variable",name:s})}else if(["#","&","^",">"].includes(r[0])){if(t.push({type:"variable",name:r[1]}),r[0]==="#"&&r.length>4&&Array.isArray(r[4])){const s=[...e,r[1]],a=yu(r[4],s);t.push(...a)}}else t.push({type:"literal",text:r[1]});return t},En=n=>{mu();const e=Oe.parse(n);return yu(e)},gu=(n,e)=>$r(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e){const s=typeof e[r.name]=="string"?e[r.name]:JSON.stringify(e[r.name]);return t+s}throw new Error(`(f-string) Missing value for input ${r.name}`)}return t+r.text},""),_u=(n,e)=>(mu(),Oe.render(n,e)),Sn={"f-string":gu,mustache:_u},vu={"f-string":$r,mustache:En},He=(n,e,t)=>{try{return Sn[e](n,t)}catch(r){throw za(r,"INVALID_PROMPT_INPUT")}},Tn=(n,e)=>vu[e](n),Mr=(n,e,t)=>{if(!(e in Sn)){const r=Object.keys(Sn);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=t.reduce((s,a)=>(s[a]="foo",s),{});Array.isArray(n)?n.forEach(s=>{if(s.type==="text"&&"text"in s&&typeof s.text=="string")He(s.text,e,r);else if(s.type==="image_url"){if(typeof s.image_url=="string")He(s.image_url,e,r);else if(typeof s.image_url=="object"&&s.image_url!==null&&"url"in s.image_url&&typeof s.image_url.url=="string"){const a=s.image_url.url;He(a,e,r)}}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):He(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};var it=class fr extends Ar{constructor(t){super(t);m(this,"template");m(this,"templateFormat","f-string");m(this,"validateTemplate",!0);m(this,"additionalContentFields");if(t.templateFormat==="mustache"&&t.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,t),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Mr(this.template,this.templateFormat,r)}}static lc_name(){return"PromptTemplate"}_getPromptType(){return"prompt"}async format(t){const r=await this.mergePartialAndUserVariables(t);return He(this.template,this.templateFormat,r)}static fromExamples(t,r,s,a=`

`,i=""){const o=[i,...t,r].join(a);return new fr({inputVariables:s,template:o})}static fromTemplate(t,r){const{templateFormat:s="f-string",...a}=r??{},i=new Set;return Tn(t,s).forEach(o=>{o.type==="variable"&&i.add(o.name)}),new fr({inputVariables:[...i],templateFormat:s,template:t,...a})}async partial(t){const r=this.inputVariables.filter(i=>!(i in t)),s={...this.partialVariables??{},...t},a={...this,inputVariables:r,partialVariables:s};return new fr(a)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(t){if(!t.template)throw new Error("Prompt template must have a template");return new fr({inputVariables:t.input_variables,template:t.template,templateFormat:t.template_format})}},rn=class wu extends Nr{constructor(t){super(t);m(this,"lc_namespace",["langchain_core","prompts","image"]);m(this,"template");m(this,"templateFormat","f-string");m(this,"validateTemplate",!0);m(this,"additionalContentFields");if(this.template=t.template,this.templateFormat=t.templateFormat??this.templateFormat,this.validateTemplate=t.validateTemplate??this.validateTemplate,this.additionalContentFields=t.additionalContentFields,this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Mr([{type:"image_url",image_url:this.template}],this.templateFormat,r)}}static lc_name(){return"ImagePromptTemplate"}_getPromptType(){return"prompt"}async partial(t){const r=this.inputVariables.filter(i=>!(i in t)),s={...this.partialVariables??{},...t},a={...this,inputVariables:r,partialVariables:s};return new wu(a)}async format(t){const r={};for(const[o,l]of Object.entries(this.template))typeof l=="string"?r[o]=He(l,this.templateFormat,t):r[o]=l;const s=t.url||r.url,a=t.detail||r.detail;if(!s)throw new Error("Must provide either an image URL.");if(typeof s!="string")throw new Error("url must be a string.");const i={url:s};return a&&(i.detail=a),i}async formatPromptValue(t){const r=await this.format(t);return new pu(r)}},Oa=class extends he{constructor(e){const t=e.templateFormat??"f-string",r=Pa(e.template,t);super({inputVariables:r,...e});m(this,"lc_namespace",["langchain_core","prompts","dict"]);m(this,"lc_serializable",!0);m(this,"template");m(this,"templateFormat");m(this,"inputVariables");this.template=e.template,this.templateFormat=t,this.inputVariables=r}static lc_name(){return"DictPromptTemplate"}async format(e){return Na(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}};function Pa(n,e){const t=[];for(const r of Object.values(n))if(typeof r=="string")Tn(r,e).forEach(s=>{s.type==="variable"&&t.push(s.name)});else if(Array.isArray(r))for(const s of r)typeof s=="string"?Tn(s,e).forEach(a=>{a.type==="variable"&&t.push(a.name)}):typeof s=="object"&&t.push(...Pa(s,e));else typeof r=="object"&&r!==null&&t.push(...Pa(r,e));return Array.from(new Set(t))}function Na(n,e,t){const r={};for(const[s,a]of Object.entries(n))if(typeof a=="string")r[s]=He(a,t,e);else if(Array.isArray(a)){const i=[];for(const o of a)typeof o=="string"?i.push(He(o,t,e)):typeof o=="object"&&i.push(Na(o,e,t));r[s]=i}else typeof a=="object"&&a!==null?r[s]=Na(a,e,t):r[s]=a;return r}const xn=(n,e)=>{const t=[...new Set(e==null?void 0:e.map(s=>{if(typeof s=="string")return s;const a=new s({});if(!("getType"in a)||typeof a.getType!="function")throw new Error("Invalid type provided.");return a.getType()}))],r=n.getType();return t.some(s=>s===r)};function Ug(n,e){return Array.isArray(n)?Tl(n,e):Ze.from(t=>Tl(t,n))}function Tl(n,e={}){const{includeNames:t,excludeNames:r,includeTypes:s,excludeTypes:a,includeIds:i,excludeIds:o}=e,l=[];for(const c of n)if(!(r&&c.name&&r.includes(c.name))){{if(a&&xn(c,a))continue;if(o&&c.id&&o.includes(c.id))continue}s||i||t?(t&&c.name&&t.some(u=>u===c.name)||s&&xn(c,s)||i&&c.id&&i.some(u=>u===c.id))&&l.push(c):l.push(c)}return l}function Fg(n){return Array.isArray(n)?xl(n):Ze.from(xl)}function xl(n){if(!n.length)return[];const e=[];for(const t of n){const r=t,s=e.pop();if(!s)e.push(r);else if(r.getType()==="tool"||r.getType()!==s.getType())e.push(s,r);else{const a=ca(s),i=ca(r),o=a.concat(i);typeof a.content=="string"&&typeof i.content=="string"&&(o.content=`${a.content}
${i.content}`),e.push(Vg(o))}}return e}function Bg(n,e){if(Array.isArray(n)){const t=n;if(!e)throw new Error("Options parameter is required when providing messages.");return Il(t,e)}else{const t=n;return Ze.from(r=>Il(r,t)).withConfig({runName:"trim_messages"})}}async function Il(n,e){const{maxTokens:t,tokenCounter:r,strategy:s="last",allowPartial:a=!1,endOn:i,startOn:o,includeSystem:l=!1,textSplitter:c}=e;if(o&&s==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(l&&s==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let u;"getNumTokens"in r?u=async h=>(await Promise.all(h.map(p=>r.getNumTokens(p.content)))).reduce((p,_)=>p+_,0):u=async h=>r(h);let d=Eu;if(c&&("splitText"in c?d=c.splitText:d=async h=>c(h)),s==="first")return bu(n,{maxTokens:t,tokenCounter:u,textSplitter:d,partialStrategy:a?"first":void 0,endOn:i});if(s==="last")return zg(n,{maxTokens:t,tokenCounter:u,textSplitter:d,allowPartial:a,includeSystem:l,startOn:o,endOn:i});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function bu(n,e){const{maxTokens:t,tokenCounter:r,textSplitter:s,partialStrategy:a,endOn:i}=e;let o=[...n],l=0;for(let c=0;c<o.length;c+=1){const u=c>0?o.slice(0,-c):o;if(await r(u)<=t){l=o.length-c;break}}if(l<o.length&&a){let c=!1;if(Array.isArray(o[l].content)){const u=o[l];if(typeof u.content=="string")throw new Error("Expected content to be an array.");const d=u.content.length,h=a==="last"?[...u.content].reverse():u.content;for(let f=1;f<=d;f+=1){const p=a==="first"?h.slice(0,f):h.slice(-f),_=Object.fromEntries(Object.entries(u).filter(([w])=>w!=="type"&&!w.startsWith("lc_"))),g=ci(u.getType(),{..._,content:p}),y=[...o.slice(0,l),g];if(await r(y)<=t)o=y,l+=1,c=!0;else break}c&&a==="last"&&(u.content=[...h].reverse())}if(!c){const u=o[l];let d;if(Array.isArray(u.content)&&u.content.some(h=>typeof h=="string"||h.type==="text")){const h=u.content.find(f=>f.type==="text"&&f.text);d=h==null?void 0:h.text}else typeof u.content=="string"&&(d=u.content);if(d){const h=await s(d),f=h.length;a==="last"&&h.reverse();for(let p=0;p<f-1;p+=1)if(h.pop(),u.content=h.join(""),await r([...o.slice(0,l),u])<=t){a==="last"&&(u.content=[...h].reverse().join("")),o=[...o.slice(0,l),u],l+=1;break}}}}if(i){const c=Array.isArray(i)?i:[i];for(;l>0&&!xn(o[l-1],c);)l-=1}return o.slice(0,l)}async function zg(n,e){var u;const{allowPartial:t=!1,includeSystem:r=!1,endOn:s,startOn:a,...i}=e;let o=n.map(d=>{const h=Object.fromEntries(Object.entries(d).filter(([f])=>f!=="type"&&!f.startsWith("lc_")));return ci(d.getType(),h,ql(d))});if(s){const d=Array.isArray(s)?s:[s];for(;o.length>0&&!xn(o[o.length-1],d);)o=o.slice(0,-1)}const l=r&&((u=o[0])==null?void 0:u.getType())==="system";let c=l?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return c=await bu(c,{...i,partialStrategy:t?"last":void 0,endOn:a}),l?[c[0],...c.slice(1).reverse()]:c.reverse()}const Al={human:{message:nt,messageChunk:kn},ai:{message:wt,messageChunk:er},system:{message:ot,messageChunk:Ht},developer:{message:ot,messageChunk:Ht},tool:{message:Qt,messageChunk:An},function:{message:$n,messageChunk:Cn},generic:{message:Mt,messageChunk:Rn},remove:{message:an,messageChunk:an}};function ci(n,e,t){var a;let r,s;switch(n){case"human":t?r=new kn(e):s=new nt(e);break;case"ai":if(t){let i={...e};"tool_calls"in i&&(i={...i,tool_call_chunks:(a=i.tool_calls)==null?void 0:a.map(o=>({...o,type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))}),r=new er(i)}else s=new wt(e);break;case"system":t?r=new Ht(e):s=new ot(e);break;case"developer":t?r=new Ht({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}}):s=new ot({...e,additional_kwargs:{...e.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if("tool_call_id"in e)t?r=new An(e):s=new Qt(e);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(t)r=new Cn(e);else{if(!e.name)throw new Error("FunctionMessage must have a 'name' field");s=new $n(e)}break;case"generic":if("role"in e)t?r=new Rn(e):s=new Mt(e);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${n}`)}if(t&&r)return r;if(s)return s;throw new Error(`Unrecognized message type ${n}`)}function Vg(n){const e=n.getType();let t;const r=Object.fromEntries(Object.entries(n).filter(([s])=>!["type","tool_call_chunks"].includes(s)&&!s.startsWith("lc_")));if(e in Al&&(t=ci(e,r)),!t)throw new Error(`Unrecognized message chunk class ${e}. Supported classes are ${Object.keys(Al)}`);return t}function Eu(n){const e=n.split(`
`);return Promise.resolve([...e.slice(0,-1).map(t=>`${t}
`),e[e.length-1]])}const qg=["tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result"],Gg=["image","video","audio","text-plain","file"],Hg=["text","reasoning",...qg,...Gg];var Zg={};fe(Zg,{AIMessage:()=>wt,AIMessageChunk:()=>er,BaseMessage:()=>De,BaseMessageChunk:()=>Lt,ChatMessage:()=>Mt,ChatMessageChunk:()=>Rn,FunctionMessage:()=>$n,FunctionMessageChunk:()=>Cn,HumanMessage:()=>nt,HumanMessageChunk:()=>kn,KNOWN_BLOCK_TYPES:()=>Hg,RemoveMessage:()=>an,SystemMessage:()=>ot,SystemMessageChunk:()=>Ht,ToolMessage:()=>Qt,ToolMessageChunk:()=>An,_isMessageFieldWithRole:()=>Vl,_mergeDicts:()=>be,_mergeLists:()=>Cr,_mergeObj:()=>zl,_mergeStatus:()=>Bl,coerceMessageLikeToMessage:()=>on,convertToChunk:()=>ca,convertToOpenAIImageBlock:()=>Wu,convertToProviderContentBlock:()=>Yu,defaultTextSplitter:()=>Eu,defaultToolCallParser:()=>Fa,filterMessages:()=>Ug,getBufferString:()=>Va,iife:()=>Ld,isAIMessage:()=>xd,isAIMessageChunk:()=>Id,isBase64ContentBlock:()=>Ml,isBaseMessage:()=>pt,isBaseMessageChunk:()=>ql,isChatMessage:()=>Ad,isChatMessageChunk:()=>Rd,isDataContentBlock:()=>vt,isDirectToolOutput:()=>Gl,isFunctionMessage:()=>$d,isFunctionMessageChunk:()=>Cd,isHumanMessage:()=>kd,isHumanMessageChunk:()=>Od,isIDContentBlock:()=>jl,isMessage:()=>Fl,isOpenAIToolCallArray:()=>pd,isPlainTextContentBlock:()=>Ju,isSystemMessage:()=>Pd,isSystemMessageChunk:()=>Nd,isToolMessage:()=>Hl,isToolMessageChunk:()=>Zl,isURLContentBlock:()=>Ll,mapChatMessagesToStoredMessages:()=>Fd,mapStoredMessageToChatMessage:()=>Ql,mapStoredMessagesToChatMessages:()=>Ud,mergeContent:()=>Nt,mergeMessageRuns:()=>Fg,mergeResponseMetadata:()=>Wl,mergeUsageMetadata:()=>Yl,parseBase64DataUrl:()=>la,parseMimeType:()=>Ku,trimMessages:()=>Bg});var Bn=class extends he{constructor(){super(...arguments);m(this,"lc_namespace",["langchain_core","prompts","chat"]);m(this,"lc_serializable",!0)}async invoke(e,t){return this._callWithConfig(r=>this.formatMessages(r),e,{...t,runType:"prompt"})}},La=class extends Bn{constructor(e){typeof e=="string"&&(e={variableName:e});super(e);m(this,"variableName");m(this,"optional");this.variableName=e.variableName,this.optional=e.optional??!1}static lc_name(){return"MessagesPlaceholder"}get inputVariables(){return[this.variableName]}async formatMessages(e){const t=e[this.variableName];if(this.optional&&!t)return[];if(!t){const s=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw s.name="InputFormatError",s}let r;try{Array.isArray(t)?r=t.map(on):r=[on(t)]}catch(s){const a=typeof t=="string"?t:JSON.stringify(t,null,2),i=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${a}`,`Additional message: ${s.message}`].join(`

`));throw i.name="InputFormatError",i.lc_error_code=s.lc_error_code,i}return r}},Su=class extends Bn{constructor(e){"prompt"in e||(e={prompt:e});super(e);m(this,"prompt");this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},ui=class extends Nr{constructor(n){super(n)}async format(n){return(await this.formatPromptValue(n)).toString()}async formatPromptValue(n){const e=await this.formatMessages(n);return new fu(e)}},Tu=class extends Su{constructor(e,t){"prompt"in e||(e={prompt:e,role:t});super(e);m(this,"role");this.role=e.role}static lc_name(){return"ChatMessagePromptTemplate"}async format(e){return new Mt(await this.prompt.format(e),this.role)}static fromTemplate(e,t,r){return new this(it.fromTemplate(e,{templateFormat:r==null?void 0:r.templateFormat}),t)}};function Jg(n){return n===null||typeof n!="object"||Array.isArray(n)?!1:Object.keys(n).length===1&&"text"in n&&typeof n.text=="string"}function Wg(n){return n===null||typeof n!="object"||Array.isArray(n)?!1:"image_url"in n&&(typeof n.image_url=="string"||typeof n.image_url=="object"&&n.image_url!==null&&"url"in n.image_url&&typeof n.image_url.url=="string")}var di=class extends Bn{constructor(e,t){"prompt"in e||(e={prompt:e});super(e);m(this,"lc_namespace",["langchain_core","prompts","chat"]);m(this,"lc_serializable",!0);m(this,"inputVariables",[]);m(this,"additionalOptions",{});m(this,"prompt");m(this,"messageClass");m(this,"chatMessageClass");if(this.prompt=e.prompt,Array.isArray(this.prompt)){let r=[];this.prompt.forEach(s=>{"inputVariables"in s&&(r=r.concat(s.inputVariables))}),this.inputVariables=r}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}createMessage(e){const t=this.constructor;if(t._messageClass()){const r=t._messageClass();return new r({content:e})}else if(t.chatMessageClass){const r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(it.fromTemplate(e,t));const r=[];for(const s of e)if(typeof s=="string")r.push(it.fromTemplate(s,t));else if(s!==null)if(Jg(s)){let a="";typeof s.text=="string"&&(a=s.text??"");const i={...t,additionalContentFields:s};r.push(it.fromTemplate(a,i))}else if(Wg(s)){let a=s.image_url??"",i,o=[];if(typeof a=="string"){let l;(t==null?void 0:t.templateFormat)==="mustache"?l=En(a):l=$r(a);const c=l.flatMap(u=>u.type==="variable"?[u.name]:[]);if(((c==null?void 0:c.length)??0)>0){if(c.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${c}
From: ${a}`);o=[c[0]]}else o=[];a={url:a},i=new rn({template:a,inputVariables:o,templateFormat:t==null?void 0:t.templateFormat,additionalContentFields:s})}else if(typeof a=="object"){if("url"in a){let l;(t==null?void 0:t.templateFormat)==="mustache"?l=En(a.url):l=$r(a.url),o=l.flatMap(c=>c.type==="variable"?[c.name]:[])}else o=[];i=new rn({template:a,inputVariables:o,templateFormat:t==null?void 0:t.templateFormat,additionalContentFields:s})}else throw new Error("Invalid image template");r.push(i)}else typeof s=="object"&&r.push(new Oa({template:s,templateFormat:t==null?void 0:t.templateFormat}));return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof Ar){const t=await this.prompt.format(e);return this.createMessage(t)}else{const t=[];for(const r of this.prompt){let s={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(const a of r.inputVariables)s||(s={[a]:e[a]}),s={...s,[a]:e[a]};if(r instanceof Ar){const a=await r.format(s);let i;"additionalContentFields"in r&&(i=r.additionalContentFields),a!==""&&t.push({...i,type:"text",text:a})}else if(r instanceof rn){const a=await r.format(s);let i;"additionalContentFields"in r&&(i=r.additionalContentFields),t.push({...i,type:"image_url",image_url:a})}else if(r instanceof Oa){const a=await r.format(s);let i;"additionalContentFields"in r&&(i=r.additionalContentFields),t.push({...i,...a})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},hi=class extends di{static _messageClass(){return nt}static lc_name(){return"HumanMessagePromptTemplate"}},xu=class extends di{static _messageClass(){return wt}static lc_name(){return"AIMessagePromptTemplate"}},Iu=class extends di{static _messageClass(){return ot}static lc_name(){return"SystemMessagePromptTemplate"}};function Kg(n){return typeof n.formatMessages=="function"}function Yg(n,e){if(Kg(n)||pt(n))return n;if(Array.isArray(n)&&n[0]==="placeholder"){const s=n[1];if((e==null?void 0:e.templateFormat)==="mustache"&&typeof s=="string"&&s.slice(0,2)==="{{"&&s.slice(-2)==="}}"){const a=s.slice(2,-2);return new La({variableName:a,optional:!0})}else if(typeof s=="string"&&s[0]==="{"&&s[s.length-1]==="}"){const a=s.slice(1,-1);return new La({variableName:a,optional:!0})}throw new Error(`Invalid placeholder template for format ${(e==null?void 0:e.templateFormat)??'"f-string"'}: "${n[1]}". Expected a variable name surrounded by ${(e==null?void 0:e.templateFormat)==="mustache"?"double":"single"} curly braces.`)}const t=on(n);let r;if(typeof t.content=="string"?r=t.content:r=t.content.map(s=>"text"in s?{...s,text:s.text}:"image_url"in s?{...s,image_url:s.image_url}:s),t._getType()==="human")return hi.fromTemplate(r,e);if(t._getType()==="ai")return xu.fromTemplate(r,e);if(t._getType()==="system")return Iu.fromTemplate(r,e);if(Mt.isInstance(t))return Tu.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function Xg(n){return n.constructor.lc_name()==="MessagesPlaceholder"}var fi=class nn extends ui{constructor(t){super(t);m(this,"promptMessages");m(this,"validateTemplate",!0);m(this,"templateFormat","f-string");if(t.templateFormat==="mustache"&&t.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,t),this.validateTemplate){const r=new Set;for(const l of this.promptMessages)if(!(l instanceof De))for(const c of l.inputVariables)r.add(c);const s=this.inputVariables,a=new Set(this.partialVariables?s.concat(Object.keys(this.partialVariables)):s),i=new Set([...a].filter(l=>!r.has(l)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are not used in any of the prompt messages.`);const o=new Set([...r].filter(l=>!a.has(l)));if(o.size>0)throw new Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}_getPromptType(){return"chat"}async _parseImagePrompts(t,r){if(typeof t.content=="string")return t;const s=await Promise.all(t.content.map(async a=>{if(a.type!=="image_url")return a;let i="";typeof a.image_url=="string"?i=a.image_url:typeof a.image_url=="object"&&a.image_url!==null&&"url"in a.image_url&&typeof a.image_url.url=="string"&&(i=a.image_url.url);const l=await it.fromTemplate(i,{templateFormat:this.templateFormat}).format(r);return typeof a.image_url=="object"&&a.image_url!==null&&"url"in a.image_url?a.image_url.url=l:a.image_url=l,a}));return t.content=s,t}async formatMessages(t){const r=await this.mergePartialAndUserVariables(t);let s=[];for(const a of this.promptMessages)if(a instanceof De)s.push(await this._parseImagePrompts(a,r));else{let i;this.templateFormat==="mustache"?i={...r}:i=a.inputVariables.reduce((l,c)=>{if(!(c in r)&&!(Xg(a)&&a.optional))throw za(new Error(`Missing value for input variable \`${c.toString()}\``),"INVALID_PROMPT_INPUT");return l[c]=r[c],l},{});const o=await a.formatMessages(i);s=s.concat(o)}return s}async partial(t){const r=this.inputVariables.filter(i=>!(i in t)),s={...this.partialVariables??{},...t},a={...this,inputVariables:r,partialVariables:s};return new nn(a)}static fromTemplate(t,r){const s=it.fromTemplate(t,r),a=new hi({prompt:s});return this.fromMessages([a])}static fromMessages(t,r){const s=t.reduce((o,l)=>o.concat(l instanceof nn?l.promptMessages:[Yg(l,r)]),[]),a=t.reduce((o,l)=>l instanceof nn?Object.assign(o,l.partialVariables):o,Object.create(null)),i=new Set;for(const o of s)if(!(o instanceof De))for(const l of o.inputVariables)l in a||i.add(l);return new this({...r,inputVariables:[...i],promptMessages:s,partialVariables:a,templateFormat:r==null?void 0:r.templateFormat})}},Qg=class Ma extends Ar{constructor(t){super(t);m(this,"lc_serializable",!1);m(this,"examples");m(this,"exampleSelector");m(this,"examplePrompt");m(this,"suffix","");m(this,"exampleSeparator",`

`);m(this,"prefix","");m(this,"templateFormat","f-string");m(this,"validateTemplate",!0);if(Object.assign(this,t),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Mr(this.prefix+this.suffix,this.templateFormat,r)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(t){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(t);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(t){const r=this.inputVariables.filter(i=>!(i in t)),s={...this.partialVariables??{},...t},a={...this,inputVariables:r,partialVariables:s};return new Ma(a)}async format(t){const r=await this.mergePartialAndUserVariables(t),s=await this.getExamples(r),a=await Promise.all(s.map(o=>this.examplePrompt.format(o))),i=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return He(i,this.templateFormat,r)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(t){const{example_prompt:r}=t;if(!r)throw new Error("Missing example prompt");const s=await it.deserialize(r);let a;if(Array.isArray(t.examples))a=t.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new Ma({inputVariables:t.input_variables,examplePrompt:s,examples:a,exampleSeparator:t.example_separator,prefix:t.prefix,suffix:t.suffix,templateFormat:t.template_format})}},e_=class Au extends ui{constructor(t){super(t);m(this,"lc_serializable",!0);m(this,"examples");m(this,"exampleSelector");m(this,"examplePrompt");m(this,"suffix","");m(this,"exampleSeparator",`

`);m(this,"prefix","");m(this,"templateFormat","f-string");m(this,"validateTemplate",!0);if(this.examples=t.examples,this.examplePrompt=t.examplePrompt,this.exampleSeparator=t.exampleSeparator??`

`,this.exampleSelector=t.exampleSelector,this.prefix=t.prefix??"",this.suffix=t.suffix??"",this.templateFormat=t.templateFormat??"f-string",this.validateTemplate=t.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let r=this.inputVariables;this.partialVariables&&(r=r.concat(Object.keys(this.partialVariables))),Mr(this.prefix+this.suffix,this.templateFormat,r)}}_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}async getExamples(t){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(t);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(t){const r=await this.mergePartialAndUserVariables(t);let s=await this.getExamples(r);s=s.map(i=>{const o={};return this.examplePrompt.inputVariables.forEach(l=>{o[l]=i[l]}),o});const a=[];for(const i of s){const o=await this.examplePrompt.formatMessages(i);a.push(...o)}return a}async format(t){const r=await this.mergePartialAndUserVariables(t),s=await this.getExamples(r),i=(await Promise.all(s.map(l=>this.examplePrompt.formatMessages(l)))).flat().map(l=>l.content),o=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return He(o,this.templateFormat,r)}async partial(t){const r=this.inputVariables.filter(i=>!(i in t)),s={...this.partialVariables??{},...t},a={...this,inputVariables:r,partialVariables:s};return new Au(a)}},t_=class sn extends Nr{constructor(t){super({...t,inputVariables:[]});m(this,"pipelinePrompts");m(this,"finalPrompt");this.pipelinePrompts=t.pipelinePrompts,this.finalPrompt=t.finalPrompt,this.inputVariables=this.computeInputValues()}static lc_name(){return"PipelinePromptTemplate"}computeInputValues(){const t=this.pipelinePrompts.map(s=>s.name),r=this.pipelinePrompts.map(s=>s.prompt.inputVariables.filter(a=>!t.includes(a))).flat();return[...new Set(r)]}static extractRequiredInputValues(t,r){return r.reduce((s,a)=>(s[a]=t[a],s),{})}async formatPipelinePrompts(t){const r=await this.mergePartialAndUserVariables(t);for(const{name:s,prompt:a}of this.pipelinePrompts){const i=sn.extractRequiredInputValues(r,a.inputVariables);a instanceof fi?r[s]=await a.formatMessages(i):r[s]=await a.format(i)}return sn.extractRequiredInputValues(r,this.finalPrompt.inputVariables)}async formatPromptValue(t){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(t))}async format(t){return this.finalPrompt.format(await this.formatPipelinePrompts(t))}async partial(t){const r={...this};return r.inputVariables=this.inputVariables.filter(s=>!(s in t)),r.partialVariables={...this.partialVariables??{},...t},new sn(r)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function Rl(n){return typeof n=="object"&&n!=null&&"withStructuredOutput"in n&&typeof n.withStructuredOutput=="function"}function r_(n){return typeof n=="object"&&n!=null&&"lc_id"in n&&Array.isArray(n.lc_id)&&n.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var n_=class Ru extends fi{constructor(t){super(t);m(this,"schema");m(this,"method");m(this,"lc_namespace",["langchain_core","prompts","structured"]);this.schema=t.schema,this.method=t.method}get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}pipe(t){if(Rl(t))return super.pipe(t.withStructuredOutput(this.schema));if(r_(t)&&Rl(t.bound))return super.pipe(new Pt({bound:t.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:t.kwargs??{},config:t.config,configFactories:t.configFactories}));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(t,r,s){return Ru.fromMessages(t,{schema:r,method:s})}},s_={};fe(s_,{AIMessagePromptTemplate:()=>xu,BaseChatPromptTemplate:()=>ui,BaseMessagePromptTemplate:()=>Bn,BaseMessageStringPromptTemplate:()=>Su,BasePromptTemplate:()=>Nr,BaseStringPromptTemplate:()=>Ar,ChatMessagePromptTemplate:()=>Tu,ChatPromptTemplate:()=>fi,DEFAULT_FORMATTER_MAPPING:()=>Sn,DEFAULT_PARSER_MAPPING:()=>vu,DictPromptTemplate:()=>Oa,FewShotChatMessagePromptTemplate:()=>e_,FewShotPromptTemplate:()=>Qg,HumanMessagePromptTemplate:()=>hi,ImagePromptTemplate:()=>rn,MessagesPlaceholder:()=>La,PipelinePromptTemplate:()=>t_,PromptTemplate:()=>it,StructuredPrompt:()=>n_,SystemMessagePromptTemplate:()=>Iu,checkValidTemplate:()=>Mr,interpolateFString:()=>gu,interpolateMustache:()=>_u,parseFString:()=>$r,parseMustache:()=>En,parseTemplate:()=>Tn,renderTemplate:()=>He});var $u=class extends he{constructor(e){super(e);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"func");e&&(this.func=e.func)}static lc_name(){return"RunnablePassthrough"}async invoke(e,t){const r=ne(t);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,t){const r=ne(t);let s,a=!0;for await(const i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,a)if(s===void 0)s=i;else try{s=Zt(s,i)}catch{s=void 0,a=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new oi(new nr({steps:e}))}},a_=class extends he{constructor(e){super(e);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"runnables");this.runnables=e.runnables}static lc_name(){return"RouterRunnable"}async invoke(e,t){const{key:r,input:s}=e,a=this.runnables[r];if(a===void 0)throw new Error(`No runnable associated with key "${r}".`);return a.invoke(s,ne(t))}async batch(e,t,r){var h;const s=e.map(f=>f.key),a=e.map(f=>f.input);if(s.find(f=>this.runnables[f]===void 0)!==void 0)throw new Error("One or more keys do not have a corresponding runnable.");const o=s.map(f=>this.runnables[f]),l=this._getOptionsList(t??{},e.length),c=((h=l[0])==null?void 0:h.maxConcurrency)??(r==null?void 0:r.maxConcurrency),u=c&&c>0?c:e.length,d=[];for(let f=0;f<a.length;f+=u){const p=a.slice(f,f+u).map((g,y)=>o[y].invoke(g,l[y])),_=await Promise.all(p);d.push(_)}return d.flat()}async stream(e,t){const{key:r,input:s}=e,a=this.runnables[r];if(a===void 0)throw new Error(`No runnable associated with key "${r}".`);return a.stream(s,t)}},i_=class extends he{constructor(e){super(e);m(this,"lc_namespace",["langchain_core","runnables"]);m(this,"lc_serializable",!0);m(this,"default");m(this,"branches");this.branches=e.branches,this.default=e.default}static lc_name(){return"RunnableBranch"}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");const r=e.slice(0,-1).map(([a,i])=>[Ge(a),Ge(i)]),s=Ge(e[e.length-1]);return new this({branches:r,default:s})}async _invoke(e,t,r){let s;for(let a=0;a<this.branches.length;a+=1){const[i,o]=this.branches[a];if(await i.invoke(e,ue(t,{callbacks:r==null?void 0:r.getChild(`condition:${a+1}`)}))){s=await o.invoke(e,ue(t,{callbacks:r==null?void 0:r.getChild(`branch:${a+1}`)}));break}}return s||(s=await this.default.invoke(e,ue(t,{callbacks:r==null?void 0:r.getChild("branch:default")}))),s}async invoke(e,t={}){return this._callWithConfig(this._invoke,e,t)}async*_streamIterator(e,t){const r=await Le(t),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),ge(e,"input"),t==null?void 0:t.runId,void 0,void 0,void 0,t==null?void 0:t.runName));let a,i=!0,o;try{for(let l=0;l<this.branches.length;l+=1){const[c,u]=this.branches[l];if(await c.invoke(e,ue(t,{callbacks:s==null?void 0:s.getChild(`condition:${l+1}`)}))){o=await u.stream(e,ue(t,{callbacks:s==null?void 0:s.getChild(`branch:${l+1}`)}));for await(const h of o)if(yield h,i)if(a===void 0)a=h;else try{a=Zt(a,h)}catch{a=void 0,i=!1}break}}if(o===void 0){o=await this.default.stream(e,ue(t,{callbacks:s==null?void 0:s.getChild("branch:default")}));for await(const l of o)if(yield l,i)if(a===void 0)a=l;else try{a=Zt(a,l)}catch{a=void 0,i=!1}}}catch(l){throw await(s==null?void 0:s.handleChainError(l)),l}await(s==null?void 0:s.handleChainEnd(a??{}))}},o_=class extends Pt{constructor(e){let t=Ze.from((i,o)=>this._enterHistory(i,o??{})).withConfig({runName:"loadHistory"});const r=e.historyMessagesKey??e.inputMessagesKey;r&&(t=$u.assign({[r]:t}).withConfig({runName:"insertHistory"}));const s=t.pipe(e.runnable.withListeners({onEnd:(i,o)=>this._exitHistory(i,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),a=e.config??{};super({...e,config:a,bound:s});m(this,"runnable");m(this,"inputMessagesKey");m(this,"outputMessagesKey");m(this,"historyMessagesKey");m(this,"getMessageHistory");this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if(typeof e=="object"&&!Array.isArray(e)&&!pt(e)){let r;this.inputMessagesKey?r=this.inputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="input",Array.isArray(e[r])&&Array.isArray(e[r][0])?t=e[r][0]:t=e[r]}else t=e;if(typeof t=="string")return[new nt(t)];if(Array.isArray(t))return t;if(pt(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(!Array.isArray(e)&&!pt(e)&&typeof e!="string"){let r;this.outputMessagesKey!==void 0?r=this.outputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="output",e.generations!==void 0?t=e.generations[0][0].message:t=e[r]}else t=e;if(typeof t=="string")return[new wt(t)];if(Array.isArray(t))return t;if(pt(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){var a;const s=await((a=t==null?void 0:t.configurable)==null?void 0:a.messageHistory).getMessages();return this.historyMessagesKey===void 0?s.concat(this._getInputMessages(e)):s}async _exitHistory(e,t){var l;const r=(l=t.configurable)==null?void 0:l.messageHistory;let s;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?s=e.inputs[0]:s=e.inputs;let a=this._getInputMessages(s);if(this.historyMessagesKey===void 0){const c=await r.getMessages();a=a.slice(c.length)}const i=e.outputs;if(!i)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const o=this._getOutputMessages(i);await r.addMessages([...a,...o])}async _mergeConfig(...e){const t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){const s={[this.inputMessagesKey??"input"]:"foo"},a={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(s)}, ${JSON.stringify(a)})`)}const{sessionId:r}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(r),t}},l_={};fe(l_,{RouterRunnable:()=>a_,Runnable:()=>he,RunnableAssign:()=>oi,RunnableBinding:()=>Pt,RunnableBranch:()=>i_,RunnableEach:()=>gg,RunnableLambda:()=>Ze,RunnableMap:()=>nr,RunnableParallel:()=>wg,RunnablePassthrough:()=>$u,RunnablePick:()=>du,RunnableRetry:()=>ii,RunnableSequence:()=>Un,RunnableToolLike:()=>ka,RunnableWithFallbacks:()=>uu,RunnableWithMessageHistory:()=>o_,_coerceToRunnable:()=>Ge,ensureConfig:()=>ne,getCallbackManagerForConfig:()=>Le,mergeConfigs:()=>ma,patchConfig:()=>ue,pickRunnableConfigKeys:()=>Ct});const $l={columns:12,rowCount:12345,sampledRows:500,warnings:[]},c_=Kc({title:en(),description:en(),chartType:en()}),u_=()=>it.fromTemplate(`You are a data analyst. Dataset profile: 
{dataset}
Generate ONE chart plan as JSON with keys "title", "description", "chartType" (bar/line/pie).`),d_=n=>({columns:n.columns,rowCount:n.rowCount,sampledRows:n.sampledRows,warnings:n.warnings}),Cl=n=>({title:"Dataset Overview",description:`Profile snapshot${n.columns} columns${n.rowCount} rows`,chartType:"bar",aggregation:"count",groupByColumn:"auto",valueColumn:void 0,defaultTopN:8,defaultHideOthers:!0}),h_=(n,e,t)=>Ze.from(async({instructions:r})=>{if(!n.columns.length||n.rows.length===0)return n.debug&&console.warn("[LangChain Plan] Missing dataset/columns, fallback plan used."),Cl(e);try{const s=n.rows.slice(0,200),{plans:a,warnings:i,telemetry:o}=await Lu(n.columns,s,n.settings);o&&(t==null||t(o)),i.length&&n.addProgress&&n.addProgress(`[LangChain Plan] Warnings: ${i.map(c=>c.message).join(" / ")}`);const l=a[0];if(l)return l}catch(s){n.debug&&console.error("[LangChain Plan] generateAnalysisPlans failed, fallback plan used.",s,r)}return Cl(e)}),f_=async n=>{if(!n.datasetId)return n.debug&&console.warn("[LangChain Plan] datasetId missing, using fallback profile."),n.fallbackProfile??$l;try{const e=await Nu.profileDataset(n.datasetId,n.sampleSize);return d_(e)}catch(e){return n.debug&&console.warn("[LangChain Plan] profileDataset failed, fallback to stub.",e),n.fallbackProfile??$l}},p_=n=>{if(!n||n.length===0)return;let e=0,t=0,r=0,s=!1,a=!1,i=!1;n.forEach(l=>{typeof l.promptTokens=="number"&&(e+=l.promptTokens,s=!0),typeof l.completionTokens=="number"&&(t+=l.completionTokens,a=!0),typeof l.totalTokens=="number"&&(r+=l.totalTokens,i=!0)});const o={};return s&&(o.promptTokens=e),a&&(o.completionTokens=t),i&&(o.totalTokens=r),Object.keys(o).length>0?o:void 0},m_=n=>{if(!n||n.length===0)return;let e=0;return n.forEach(t=>{const r=Mu(t);typeof r=="number"&&(e+=r)}),e>0?Number(e.toFixed(6)):void 0},b_=async n=>{const e=typeof performance<"u"?performance.now():Date.now(),t=await f_(n),r=u_();let s;const a=h_(n,t,E=>{s=E}),o=await Un.from([Ze.from(async()=>({profile:t,promptText:await r.format({dataset:JSON.stringify(t,null,2)})})),Ze.from(async({profile:E,promptText:b})=>({plan:await a.invoke({instructions:b}),profile:E})),Ze.from(async({plan:E,profile:b})=>(c_.parse({title:E.title??"Untitled plan",description:E.description??"Generated via LangChain PoC",chartType:E.chartType??"bar"}),{plan:E,profile:b}))]).invoke(),l=typeof performance<"u"?performance.now():Date.now(),c=Math.max(0,l-e),u=p_(s),d=m_(s),h=`langchain-${Date.now().toString(36)}`,f=`${h}-execute`,p=o.plan.title??"LangChain plan",_={id:f,label:p,intent:"analysis",status:"ready"},g={planId:h,goal:p,contextSummary:"Generated via LangChain Runnable",progress:`Plan ready (latency ${c.toFixed(0)} ms)`,nextSteps:[_],steps:[_],currentStepId:f,blockedBy:null,observationIds:[],confidence:.55,updatedAt:new Date().toISOString(),stateTag:"context_ready"},y=`obs-langchain-${Date.now().toString(36)}`,w=new Date().toISOString(),v={id:y,actionId:"langchain_plan",responseType:"plan_creation",status:"success",timestamp:w,outputs:{summary:`LangChain plan: ${p}`,chartType:o.plan.chartType,groupByColumn:o.plan.groupByColumn,valueColumn:o.plan.valueColumn,latencyMs:Math.round(c)}};return{source:"langchain",planId:h,stepId:f,summary:p,plan:o.plan,planState:g,observation:v,telemetry:{latencyMs:c,startedAt:e,finishedAt:l,provider:n.settings.provider,tokenUsage:u,estimatedCostUsd:d},profile:o.profile,usageLog:s??[]}};export{b_ as generateLangChainPlanEnvelope};
