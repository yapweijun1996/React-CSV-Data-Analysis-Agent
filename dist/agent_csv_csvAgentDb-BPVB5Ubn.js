import{c as ee,m as te,p as ne}from"./agent_csv_dataWorker-wxHr7y60.js";const _=(e,t)=>t.some(n=>e instanceof n);let V,$;function re(){return V||(V=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function oe(){return $||($=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const P=new WeakMap,O=new WeakMap,E=new WeakMap;function ae(e){const t=new Promise((n,r)=>{const o=()=>{e.removeEventListener("success",s),e.removeEventListener("error",a)},s=()=>{n(g(e.result)),o()},a=()=>{r(e.error),o()};e.addEventListener("success",s),e.addEventListener("error",a)});return E.set(t,e),t}function se(e){if(P.has(e))return;const t=new Promise((n,r)=>{const o=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",a),e.removeEventListener("abort",a)},s=()=>{n(),o()},a=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",s),e.addEventListener("error",a),e.addEventListener("abort",a)});P.set(e,t)}let v={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return P.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return g(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function W(e){v=e(v)}function ce(e){return oe().includes(e)?function(...t){return e.apply(T(this),t),g(this.request)}:function(...t){return g(e.apply(T(this),t))}}function ie(e){return typeof e=="function"?ce(e):(e instanceof IDBTransaction&&se(e),_(e,re())?new Proxy(e,v):e)}function g(e){if(e instanceof IDBRequest)return ae(e);if(O.has(e))return O.get(e);const t=ie(e);return t!==e&&(O.set(e,t),E.set(t,e)),t}const T=e=>E.get(e);function de(e,t,{blocked:n,upgrade:r,blocking:o,terminated:s}={}){const a=indexedDB.open(e,t),i=g(a);return r&&a.addEventListener("upgradeneeded",c=>{r(g(a.result),c.oldVersion,c.newVersion,g(a.transaction),c)}),n&&a.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),i.then(c=>{s&&c.addEventListener("close",()=>s()),o&&c.addEventListener("versionchange",d=>o(d.oldVersion,d.newVersion,d))}).catch(()=>{}),i}const ue=["get","getKey","getAll","getAllKeys","count"],le=["put","add","delete","clear"],R=new Map;function q(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(R.get(t))return R.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=le.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(o||ue.includes(n)))return;const s=async function(a,...i){const c=this.transaction(a,o?"readwrite":"readonly");let d=c.store;return r&&(d=d.index(i.shift())),(await Promise.all([d[n](...i),o&&c.done]))[0]};return R.set(t,s),s}W(e=>({...e,get:(t,n,r)=>q(t,n)||e.get(t,n,r),has:(t,n)=>!!q(t,n)||e.has(t,n)}));const we=["continue","continuePrimaryKey","advance"],F={},M=new WeakMap,N=new WeakMap,fe={get(e,t){if(!we.includes(t))return e[t];let n=F[t];return n||(n=F[t]=function(...r){M.set(this,N.get(this)[t](...r))}),n}};async function*he(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,fe);for(N.set(n,t),E.set(n,T(t));t;)yield n,t=await(M.get(n)||t.continue()),M.delete(n)}function H(e,t){return t===Symbol.asyncIterator&&_(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&_(e,[IDBIndex,IDBObjectStore])}W(e=>({...e,get(t,n,r){return H(t,n)?he:e.get(t,n,r)},has(t,n){return H(t,n)||e.has(t,n)}}));const K="csv_agent_db",ye=4,I="provenance",h="clean_rows",w="columns",l="views",y="preparation_log",m="memory_snapshots",S="dataset_runtime_config",me=32;let b=null;const j=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,z=async()=>{await new Promise((e,t)=>{const n=indexedDB.deleteDatabase(K);n.onsuccess=()=>e(),n.onerror=()=>t(n.error),n.onblocked=()=>console.warn("IndexedDB delete blocked. Close other tabs to proceed.")}),b=null},Se=(e,t)=>{if(!e.objectStoreNames.contains(t)){if(t===h){e.createObjectStore(t,{keyPath:"chunkId"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(t===w){e.createObjectStore(t,{keyPath:"datasetId"});return}if(t===l){e.createObjectStore(t,{keyPath:"id"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(t===I){e.createObjectStore(t,{keyPath:"datasetId"});return}if(t===y){e.createObjectStore(t,{keyPath:"id"}).createIndex("by_dataset","datasetId",{unique:!1});return}if(t===m){const n=e.createObjectStore(t,{keyPath:"id"});n.createIndex("by_dataset","datasetId",{unique:!1}),n.createIndex("by_view","viewId",{unique:!1});return}if(t===S){e.createObjectStore(t,{keyPath:"datasetId"});return}throw new Error(`Unsupported store name: ${t}`)}},U=async e=>{try{return await e()}catch(t){if(t instanceof DOMException&&t.name==="VersionError")return console.warn("IndexedDB version mismatch detected. Resetting csv_agent_db...",t),await z(),e();throw t}},be=[I,h,w,l,y,m,S],u=async(e=[])=>{const t=Array.from(new Set([...be,...e])),n=(a,i)=>de(K,a,{upgrade(c){i.forEach(d=>Se(c,d))}});if(!b)return b=U(()=>n(ye,t)),b;const r=await b;if(t.filter(a=>!r.objectStoreNames.contains(a)).length===0)return r;r.close();const s=r.version+1;return b=U(()=>n(s,t)),b},ge=(e,t)=>{const n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n},Re=async e=>{const{datasetId:t,rows:n,columns:r,provenance:o,chunkSize:s=2e4}=e;if(!t)throw new Error("persistCleanDataset requires datasetId.");const a=async()=>{const c=(await u([h,w,l])).transaction([h,w,I],"readwrite"),d=c.objectStore(h),f=c.objectStore(w),D=c.objectStore(I),A=ge(n,s),k=new Date().toISOString();try{let C=await d.index("by_dataset").openCursor(t);for(;C;)await C.delete(),C=await C.continue();for(let x=0;x<A.length;x+=1){const p=A[x],Z={chunkId:`${t}-chunk-${x}`,datasetId:t,rowCount:p.length,startRow:x*s,endRow:x*s+p.length-1,rows:p,createdAt:k};await d.put(Z)}const J={datasetId:t,columnCount:r.length,columns:r,rowCount:n.length,updatedAt:k};await f.put(J);const Q={datasetId:t,fileName:o.fileName,bytes:o.bytes,checksum:o.checksum,cleanedAt:o.cleanedAt};return await D.put(Q),await c.done,await X(t,{rowCountHint:n.length}),{chunkCount:A.length,rowCount:n.length}}catch(L){try{c.abort()}catch{}throw await c.done.catch(()=>{}),L}};try{return await a()}catch(i){if(i instanceof DOMException&&i.name==="NotFoundError")return console.warn("IndexedDB store missing detected. Resetting and retrying persist...",i),await z(),a();throw i}},_e=async e=>{const{datasetId:t,title:n,kind:r,queryHash:o,explainer:s,dataRef:a}=e,c=(await u([l])).transaction(l,"readwrite"),d=c.objectStore(l),f=`${t}-view-${j()}`,D={id:f,datasetId:t,title:n,kind:r,queryHash:o,explainer:s,dataRef:a,createdAt:new Date().toISOString()};return await d.put(D),await c.done,f},Pe=async e=>{const t=await u([l]);try{const n=t.transaction(l,"readonly"),s=await n.objectStore(l).index("by_dataset").getAll(e);return await n.done,s}catch(n){return console.warn(`Failed to read card results for ${e}`,n),[]}},ve=async e=>{const n=(await u()).transaction(I,"readonly"),o=await n.objectStore(I).get(e);return await n.done,o??void 0},G=async e=>{const n=(await u([w])).transaction(w,"readonly"),o=await n.objectStore(w).get(e);return await n.done,o??null},Te=async e=>{const t=await G(e);return(t==null?void 0:t.columns)??null},B=async(e,t)=>{const r=(await u([h])).transaction(h,"readonly"),s=r.objectStore(h).index("by_dataset");let a=!1;const i=()=>{a=!0};let c=await s.openCursor(e);for(;c&&!a;){const d=c.value;if(await t(d,i),a)break;c=await c.continue()}await r.done},De=async e=>{let t=0;return await B(e,n=>{const r=typeof n.rowCount=="number"?n.rowCount:n.rows.length;t+=r}),t};async function xe(e){const n=(await u([S])).transaction(S,"readonly"),o=await n.objectStore(S).get(e);return await n.done,o??null}async function Y(e){const n=(await u([S])).transaction(S,"readwrite");await n.objectStore(S).put(e),await n.done}async function X(e,t){const n=await xe(e);if(n)return n;const r=ee(e,{rowCountHint:t==null?void 0:t.rowCountHint,preferredMode:t==null?void 0:t.preferredMode});return await Y(r),r}async function Me(e,t,n){const r=await X(e,{rowCountHint:n==null?void 0:n.rowCountHint}),o=te(r,t);return await Y(o),o}const Ie=async(e,t)=>{const n=[];return await B(e,(r,o)=>{for(const s of r.rows)if(n.push(s),n.length>=t){o();break}}),n},je=async e=>{const t=[];return await B(e,n=>{t.push(...n.rows)}),t},Ce=(e,t)=>{const n=new Date().toISOString();return t.map((r,o)=>({...r,datasetId:e,id:r.id??`${e}-prep-${j()}`,stepOrder:typeof r.stepOrder=="number"?r.stepOrder:o,scope:r.scope??"dataset",columnName:r.columnName??null,source:r.source??"ai_plan",tags:r.tags??[],createdAt:r.createdAt??n}))},Be=async(e,t=[])=>{if(!e)throw new Error("replacePreparationLog requires datasetId.");const r=(await u([y])).transaction(y,"readwrite"),o=r.objectStore(y);let a=await o.index("by_dataset").openCursor(e);for(;a;)await a.delete(),a=await a.continue();if(t.length>0){const i=Ce(e,t).sort((c,d)=>c.stepOrder-d.stepOrder||new Date(c.createdAt).getTime()-new Date(d.createdAt).getTime());for(const c of i)await o.put(c)}await r.done},ke=async e=>{if(!e)return[];const t=await u([y]);try{const n=t.transaction(y,"readonly"),s=await n.objectStore(y).index("by_dataset").getAll(e);return await n.done,s.sort((a,i)=>a.stepOrder-i.stepOrder||new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime())}catch(n){return console.warn(`Failed to read preparation log for ${e}`,n),[]}},Ee=async(e,t,n=me)=>{const r=await e.index("by_dataset").getAll(t);if(r.length<=n)return;const o=r.sort((i,c)=>{const d=(c.qualityScore??0)-(i.qualityScore??0);return d!==0?d:new Date(c.createdAt).getTime()-new Date(i.createdAt).getTime()}).slice(0,n),s=new Set(o.map(i=>i.id)),a=r.filter(i=>!s.has(i.id));for(const i of a)await e.delete(i.id)},Le=async e=>{var s,a;if(!e.datasetId)throw new Error("saveMemorySnapshot requires datasetId.");const n=(await u([m])).transaction(m,"readwrite"),r=n.objectStore(m),o={...e,id:e.id??e.viewId??e.cardId??`${e.datasetId}-memo-${j()}`,createdAt:e.createdAt??new Date().toISOString(),plan:e.plan??null,viewId:e.viewId??null,cardId:e.cardId??null,summary:e.summary??"",title:e.title??"Untitled View",sampleRows:e.sampleRows??[],tags:e.tags??[],chartType:e.chartType??((s=e.plan)==null?void 0:s.chartType),queryHash:e.queryHash??null,rowCount:typeof e.rowCount=="number"?e.rowCount:((a=e.sampleRows)==null?void 0:a.length)??0,sampled:e.sampled??!1,expiresAt:e.expiresAt??null};return await r.put(o),await Ee(r,o.datasetId),await n.done,o.id},Ve=async(e,t)=>{if(!e)return[];const n=await u([m]);try{const r=n.transaction(m,"readonly"),a=await r.objectStore(m).index("by_dataset").getAll(e);await r.done;const i=a.filter(d=>t!=null&&t.minScore?(d.qualityScore??0)>=t.minScore:!0).filter(d=>{var f;return t!=null&&t.tag?(f=d.tags)==null?void 0:f.includes(t.tag):!0}).sort((d,f)=>{const D=(f.qualityScore??0)-(d.qualityScore??0);return D!==0?D:new Date(f.createdAt).getTime()-new Date(d.createdAt).getTime()}),c=(t==null?void 0:t.limit)??i.length;return i.slice(0,c)}catch(r){return console.warn(`Failed to read memory snapshots for ${e}`,r),[]}},Ae=2e3,pe=async e=>{try{const[t,n]=await Promise.all([Ie(e,Ae),De(e)]);if(n===0||t.length===0)return console.warn(`CSV Agent: unable to rebuild column metadata for ${e} because the dataset has no cached rows.`),null;const r=ne(t),o={datasetId:e,columnCount:r.length,columns:r,rowCount:n,updatedAt:new Date().toISOString()},a=(await u([w])).transaction(w,"readwrite");return await a.objectStore(w).put(o),await a.done,console.info(`CSV Agent: rebuilt missing column metadata for dataset ${e}.`),o}catch(t){return console.error(`CSV Agent: failed to rebuild column metadata for dataset ${e}.`,t),null}},$e=async e=>{const t=await G(e);return t||pe(e)},qe=async e=>{const n=(await u([l])).transaction(l,"readwrite");let s=await n.objectStore(l).index("by_dataset").openCursor(e);for(;s;)await s.delete(),s=await s.continue();await n.done};export{qe as clearCardResults,$e as ensureColumnStoreRecord,X as ensureDatasetRuntimeConfig,Re as persistCleanDataset,je as readAllRows,Pe as readCardResults,Te as readColumnProfiles,G as readColumnStoreRecord,xe as readDatasetRuntimeConfig,Ve as readMemorySnapshots,ke as readPreparationLog,ve as readProvenance,Ie as readSampledRows,Be as replacePreparationLog,_e as saveCardResult,Le as saveMemorySnapshot,Me as updateDatasetRuntimeConfig};
