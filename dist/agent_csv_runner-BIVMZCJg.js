const x="0.1.0",$="context_ready",U=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`session-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,v=(e,t)=>{const n=new Date().toISOString(),a={sessionId:U(),planId:null,stateTag:$,phase:"observe",awaitingUser:!1,awaitPrompt:null,awaitPromptId:null,pendingUserReply:null,pendingPlan:null,pendingVerification:null,steps:[],currentStepId:null,blockedBy:null,observations:[],viewIds:[],warnings:[],loopBudget:{maxActs:3,actsUsed:0,exceeded:!1},updatedAt:n};return{...a,...t,steps:a.steps,observations:a.observations,viewIds:a.viewIds,warnings:a.warnings,loopBudget:a.loopBudget,phase:a.phase}},k=["ready","in_progress","done"],T=e=>e?["context_ready","awaiting_clarification","needs_clarification"].includes(e)?!0:/^\d{5,}-\d+$/.test(e)||/^ts[0-9a-z]{2,}-[0-9a-z_-]+$/i.test(e):!1,D=e=>{if(!Array.isArray(e))return[];const t=new Set,n=[];return e.forEach(a=>{const s=typeof(a==null?void 0:a.id)=="string"?a.id.trim():"",o=typeof(a==null?void 0:a.label)=="string"?a.label.trim():"",i=typeof(a==null?void 0:a.intent)=="string"?a.intent.trim():"conversation";if(s.length<3||o.length<3||t.has(s))return;const u=k.includes(a.status)?a.status:"ready";n.push({id:s,label:o,intent:i,status:u}),t.add(s)}),n},O=(e,t)=>{var o;if(!t)return e;const n=D(t.steps??t.nextSteps),a=typeof t.currentStepId=="string"&&t.currentStepId.trim().length>=3?t.currentStepId.trim():((o=n[0])==null?void 0:o.id)??e.currentStepId,s=typeof t.planId=="string"&&t.planId.trim().length>=3?t.planId.trim():e.planId;return{...e,planId:s,steps:n,currentStepId:a,blockedBy:t.blockedBy??e.blockedBy,stateTag:t.stateTag&&T(t.stateTag)?t.stateTag:e.stateTag,updatedAt:new Date().toISOString(),awaitPrompt:e.awaitPrompt,awaitPromptId:e.awaitPromptId,pendingUserReply:e.pendingUserReply,phase:e.phase,loopBudget:e.loopBudget}},I=e=>e?T(e):!1,B=["text_response","await_user","dom_action","execute_js_code","proceed_to_analysis","filter_spreadsheet","clarification_request"],R=(e,t)=>{if(!Array.isArray(t)||t.length===0)return{ok:!0,nextState:e,acceptedActions:[]};if(e.awaitingUser)return g("awaiting_user","Graph is waiting for user input; no actions can run.",e);if(t.length>2)return g("turn_budget_exceeded","Each turn may include at most 2 actions.",e);const n=t[0];if(n.responseType!=="plan_state_update")return g("first_action_plan_required","First action must be plan_state_update.",e);if(!I(n.stateTag))return g("invalid_state_tag","plan_state_update is missing a valid stateTag.",e);if(!n.planState)return g("missing_plan_state","plan_state_update is missing planState payload.",e);const a=t[1];if(a){if(a.responseType==="plan_state_update")return g("atomic_type_invalid","Second action must be atomic, not plan_state_update.",e);if(!B.includes(a.responseType))return g("atomic_type_invalid",`Atomic action ${a.responseType} is not permitted in this turn.`,e);if(!I(a.stateTag))return g("invalid_state_tag","Atomic action is missing a valid stateTag.",e)}return{ok:!0,nextState:A(e,n,a),acceptedActions:t}},A=(e,t,n)=>{var o,i,u,p,r,h;let a=O(e,t.planState);return a={...a,stateTag:t.stateTag??a.stateTag,updatedAt:new Date().toISOString()},!!((o=t.meta)!=null&&o.awaitUser)||((i=t.planState)==null?void 0:i.blockedBy)==="awaiting_user_choice"||!!((u=n==null?void 0:n.meta)!=null&&u.awaitUser)||(n==null?void 0:n.responseType)==="await_user"?a={...a,awaitingUser:!0,blockedBy:((p=t.planState)==null?void 0:p.blockedBy)??(n==null?void 0:n.reason)??"awaiting_user_choice",awaitPrompt:(n==null?void 0:n.awaitUserPayload)??a.awaitPrompt,awaitPromptId:((r=n==null?void 0:n.awaitUserPayload)==null?void 0:r.promptId)??a.awaitPromptId}:a={...a,awaitingUser:!1,blockedBy:((h=t.planState)==null?void 0:h.blockedBy)??null,awaitPrompt:null,awaitPromptId:null},a},g=(e,t,n)=>({ok:!1,violations:[{code:e,message:t}],nextState:n}),C=e=>v(),E=({state:e})=>{const t={...e,warnings:e.warnings??[]},n=e.observations.some(s=>s.kind==="profile_dataset"),a=[];return n||a.push({type:"execute_js_code",responseType:"execute_js_code",stepId:e.currentStepId??"diagnose-profile",stateTag:e.stateTag??"context_ready",timestamp:new Date().toISOString(),reason:"需要列画像来制定计划。",meta:{toolCall:{kind:"profile_dataset"}},toolCall:{kind:"profile_dataset"}}),{state:t,actions:a,label:"diagnose"}},S="你想先做哪項？",M=[{id:"clean_month",label:"清洗/标准化 InvoiceMonth"},{id:"top_payees",label:"Top 收款方（总额/笔数/客单）"},{id:"outlier",label:"异常大额清单"},{id:"by_type",label:"按 PayeeType 分解"}],N=()=>`prompt-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,G=({state:e})=>{if(e.pendingUserReply)return{state:e,actions:[],label:"ask_user"};if(e.awaitingUser&&e.awaitPrompt){const o={type:"await_user",responseType:"await_user",stepId:e.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Still waiting for your selection before continuing.",text:e.awaitPrompt.question,meta:{awaitUser:!0,haltAfter:!0,promptId:e.awaitPrompt.promptId},awaitUserPayload:e.awaitPrompt};return{state:e,actions:[o],halted:!0,label:"ask_user"}}const t=N(),n={promptId:t,question:S,options:M,allowFreeText:!0,placeholder:"或输入：Top10 by amount desc"},a={type:"await_user",responseType:"await_user",stepId:e.currentStepId??"ask-user-choice",stateTag:"awaiting_clarification",timestamp:new Date().toISOString(),reason:"Need user choice before continuing the analysis plan.",text:S,meta:{awaitUser:!0,haltAfter:!0,promptId:t},awaitUserPayload:n},s=e.steps.length>0?e.steps:[{id:"ask-user-choice",intent:"clarification",label:"Await user choice before planning",status:"waiting_user"}];return{state:{...e,awaitingUser:!0,blockedBy:"awaiting_user_choice",stateTag:"awaiting_clarification",steps:s,awaitPrompt:n,awaitPromptId:t,pendingPlan:null,pendingVerification:null,updatedAt:new Date().toISOString()},actions:[a],halted:!0,label:"ask_user"}},L={clean_month:{toolCall:{kind:"normalize_invoice_month",params:{column:"InvoiceMonth"}},stepId:"normalize-invoice-month",stepLabel:"标准化 InvoiceMonth 字段",stepIntent:"data_cleaning",planGoal:"标准化发票月份字段，确保后续聚合一致。",planProgress:"已进入 InvoiceMonth 字段标准化阶段。",reason:"根据你的选择，先统一 InvoiceMonth 字段格式。",text:"正在本地标准化 InvoiceMonth 字段（YYYY-MM），完成后我会告知影响行数。"},outlier:{toolCall:{kind:"detect_outliers",params:{valueColumn:"Amount",multiplier:3}},stepId:"detect-amount-outliers",stepLabel:"侦测金额异常值",stepIntent:"data_validation",planGoal:"识别金额异常交易记录，提供可疑清单。",planProgress:"已开始金额异常检测（以 Amount 字段计算阈值）。",reason:"根据你的选择，先扫描金额异常值。",text:"正在比较 Amount 分布，找出超过阈值的可疑记录，稍后回报。"}},j=e=>e?L[e]:void 0,V=e=>{if(!e||typeof e!="object")return!1;const t=e;return t.source==="langchain"&&typeof t.planId=="string"&&typeof t.stepId=="string"},q=()=>`plan-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,f=20,z=e=>({type:"execute_js_code",responseType:"execute_js_code",stepId:e.stepId,stateTag:`ts${Date.now().toString(36)}-tool`,timestamp:new Date().toISOString(),reason:e.reason,text:e.text,meta:{toolCall:e.toolCall},toolCall:e.toolCall}),Y=(e,t)=>{const n=[...e,t];return n.length>f?n.slice(n.length-f):n},F=e=>{if(!e)return null;const t=e.langChainPlan;return V(t)?t:null},K=(e,t)=>{const n={type:"plan_state_update",responseType:"plan_state_update",stepId:t.stepId,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`LangChain 计划完成：${t.summary}`,planState:t.planState,meta:{source:"langchain",telemetry:t.telemetry}},a={id:t.stepId,summary:t.summary,plan:t.plan,createdAt:new Date().toISOString()},s={id:`langchain-plan-${Date.now().toString(36)}`,kind:"langchain_plan",payload:{summary:t.summary,telemetry:t.telemetry},at:new Date().toISOString()};return{state:{...e,planId:t.planId,steps:t.planState.steps??e.steps,currentStepId:t.planState.currentStepId??t.stepId,pendingPlan:a,pendingUserReply:null,phase:"plan",observations:Y(e.observations,s)},actions:[n],label:"plan"}},H=({state:e,payload:t})=>{var c;const n={...e,phase:"plan",updatedAt:new Date().toISOString()},a=e.pendingUserReply;if(!a)return{state:n,actions:[],label:"plan"};const s=F(t),o=a.optionId?j(a.optionId):void 0;if(!o){if(!s)throw new Error("LangChain plan payload missing; cannot construct plan node actions.");return K(n,s)}const i=a.freeText||((c=a.options.find(w=>w.id===a.optionId))==null?void 0:c.label)||a.optionId||a.question,u=e.planId??q(),p=o.stepId,r={id:p,intent:o.stepIntent,label:o.stepLabel,status:"in_progress"},d=[{type:"plan_state_update",responseType:"plan_state_update",stepId:p,stateTag:`ts${Date.now().toString(36)}-plan`,timestamp:new Date().toISOString(),reason:`根据你的选择更新计划：${i}`,planState:{planId:u,goal:(o==null?void 0:o.planGoal)??"完成你刚刚点选的分析任务",contextSummary:a.question,progress:(o==null?void 0:o.planProgress)??`收到你的选择「${i}」，准备执行。`,nextSteps:[r],steps:[r],currentStepId:p,blockedBy:null,observationIds:[],confidence:.62,updatedAt:new Date().toISOString(),stateTag:`ts${Date.now().toString(36)}-planstate`}}];return d.push(z({toolCall:o.toolCall,stepId:o.stepId,reason:o.reason,text:o.text})),{state:{...n,planId:u,steps:[r],currentStepId:p,pendingPlan:null,pendingUserReply:null},actions:d,label:"plan"}},Q=({state:e})=>{const t=e.pendingPlan;if(!t||!t.plan)return{state:{...e,phase:"act"},actions:[],label:"act"};const n={type:"plan_creation",responseType:"plan_creation",stepId:t.id,stateTag:`ts${Date.now().toString(36)}-act`,timestamp:new Date().toISOString(),reason:`根据选择「${t.summary}」创建分析计划`,plan:t.plan},a=Math.min(e.loopBudget.maxActs,e.loopBudget.actsUsed+1),s={...e.loopBudget,actsUsed:a,exceeded:a>=e.loopBudget.maxActs};return{state:{...e,phase:"act",pendingPlan:null,pendingVerification:{id:t.id,description:t.summary,meta:null,summary:t.summary,payload:null,createdAt:new Date().toISOString()},loopBudget:s},actions:[n],label:"act"}},X=({state:e})=>{var p;const t=e.pendingVerification;if(!t)return{state:{...e,phase:"verify"},actions:[],label:"verify"};const n=t.meta,a=[];t.summary?a.push(t.summary):n&&(n.source&&a.push(`数据源：${n.source==="sample"?"采样":"全量"}`),typeof n.rows=="number"&&a.push(`记录数：${n.rows}`),typeof n.processedRows=="number"&&typeof n.totalRows=="number"&&a.push(`处理行：${n.processedRows}/${n.totalRows}`),(p=n.warnings)!=null&&p.length&&a.push(`警告 ${n.warnings.length} 条`),n.summary&&a.push(n.summary));const o=(()=>{const r=t.payload;if(!r||typeof r!="object")return null;switch(typeof r.kind=="string"?r.kind:null){case"profile_dataset":{const d=r.columns,c=r.rowCount,w=r.sampledRows;return`列画像：${d??"?"} 列 · ${c??"?"} 行（采样 ${w??"?"}）`}case"normalize_invoice_month":{const d=r.column??"InvoiceMonth",c=r.normalizedCount,w=r.skippedCount;return`标准化 ${d}：成功 ${c??0}，跳过 ${w??0}`}case"detect_outliers":{const d=r.column??"value",c=r.count,w=r.threshold;return`异常检测 ${d}：找到 ${c??0} 条（阈值 ${w??"?"}）`}case"aggregate_plan":{const d=r.planTitle??t.description,c=r.rows;return`聚合视图「${d}」产生 ${c??0} 行结果。`}default:return null}})();o&&a.push(o);const i=e.loopBudget.exceeded||e.loopBudget.actsUsed>=e.loopBudget.maxActs,u={type:"text_response",responseType:"text_response",stepId:t.id,stateTag:`ts${Date.now().toString(36)}-verify`,timestamp:new Date().toISOString(),reason:"确认最新的聚合结果，并说明数据来源。",text:n?`已完成「${t.description}」。
${a.join(" · ")}${i?`
⚠️ 已达到自动执行次数上限，如需继续请确认。`:""}`:`已完成「${t.description}」的初步执行，准备生成可视化或进一步说明。${i?`
⚠️ 已达到自动执行次数上限，如需继续请确认。`:""}`};return{state:{...e,phase:"verify",pendingVerification:null,loopBudget:{...e.loopBudget,exceeded:i},blockedBy:i?"loop_budget_exceeded":e.blockedBy},actions:[u],label:"verify"}},W=({state:e})=>{const t={type:"text_response",responseType:"text_response",stepId:e.currentStepId??"adjust-next-step",stateTag:`ts${Date.now().toString(36)}-adjust`,timestamp:new Date().toISOString(),reason:"提出下一步建议以延伸分析。",text:"下一步可继续筛选特定供应商或启用异常侦测。随时告诉我想要深入的角度。"};return{state:e,actions:[t],label:"adjust"}},J=[E,G,H,Q,X,W],Z=e=>{let t=e.state;const n=[];for(const a of J){const s=a({state:t,payload:e.payload});if(t=s.state,s.actions.length>0&&n.push(...s.actions),s.halted)return{state:t,actions:n,halted:!0,label:s.label}}return{state:t,actions:n,halted:!1,label:"complete"}},_=self;let l=C();const b=20,m=e=>{_.postMessage(e)},y=()=>Date.now(),P=()=>{m({type:"graph/ready",version:x,timestamp:y()})},ee=e=>{switch(e.type){case"graph/init":P();return;case"graph/ping":m({type:"graph/pong",nonce:e.nonce,timestamp:y()});return;case"graph/shutdown":m({type:"graph/log",level:"info",message:e.reason?`Graph runtime shutting down: ${e.reason}`:"Graph runtime shutting down by request.",timestamp:y()}),_.close();return;case"graph/applyActions":te(e.actions??[]);return;case"graph/runPipeline":ne(e.payload??{});return;case"graph/userReply":ae(e.optionId??null,e.freeText??null);return;case"graph/tool_result":se(e.verification);return;default:m({type:"graph/log",level:"warn",message:`Unhandled client event ${e.type}`,timestamp:y()})}},te=e=>{var a,s,o,i;const t=y(),n=R(l,e);n.ok&&n.nextState&&(l=n.nextState),m({type:"graph/validation",ok:n.ok,timestamp:t,code:(s=(a=n.violations)==null?void 0:a[0])==null?void 0:s.code,reason:(i=(o=n.violations)==null?void 0:o[0])==null?void 0:i.message,state:n.nextState})},ne=e=>{const t=Z({state:l,payload:e});l=t.state,m({type:"graph/pipeline",node:t.label,actions:t.actions,state:l,timestamp:y()})},ae=(e,t)=>{const n=l.awaitPrompt;l={...l,awaitingUser:!1,blockedBy:null,awaitPrompt:null,awaitPromptId:null,pendingUserReply:{optionId:e??null,freeText:t??null,promptId:(n==null?void 0:n.promptId)??null,question:(n==null?void 0:n.question)??"User follow-up",options:(n==null?void 0:n.options)??[],at:new Date().toISOString()},stateTag:"context_ready",updatedAt:new Date().toISOString()};const a=e||t?`User replied with ${e??""} ${t??""}`.trim():"User reply received.";m({type:"graph/log",level:"info",message:a,timestamp:y()})},se=e=>{var i;const t=`verify-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`,n=new Date().toISOString(),a={id:t,kind:typeof((i=e.payload)==null?void 0:i.kind)=="string"?e.payload.kind:"tool_result",payload:{description:e.description,summary:e.summary??null,meta:e.meta??null,...e.payload??{}},at:n},s=[...l.observations,a],o=s.length>b?s.slice(s.length-b):s;l={...l,pendingVerification:{id:t,description:e.description,meta:e.meta?{...e.meta,summary:e.summary??void 0}:null,summary:e.summary??null,payload:e.payload??null,createdAt:n},observations:o}};_.addEventListener("message",e=>{const t=e.data;if(!t||typeof t!="object"||typeof t.type!="string"){m({type:"graph/log",level:"warn",message:"Ignored message without graph type.",timestamp:y()});return}ee(t)});P();
